{"config":{"lang":["ja"],"separator":"[\\s\\-\uff0c\u3002]+","pipeline":["stemmer"]},"docs":[{"location":"","title":"\u624b\u6478\u624b Elasticsearch7 \u6280\u672f\u4e0e\u5b9e\u6218\u6559\u7a0b","text":"<p>Started at Oct. 2020 By Jacob Xi </p> <p></p>"},{"location":"#_1","title":"\u5185\u5bb9\u7b80\u4ecb","text":"<p>\u672c\u4e66\u662f\u672c\u4eba\u7684\u201c\u624b\u6478\u624b\u6218\u672f\u6559\u7a0b\u201d\u7cfb\u5217\u7684\u7b2c\u4e8c\u672c\uff0c\u5386\u7ecf\u56db\u4e2a\u6708\u7684\u65f6\u95f4\uff0c\u7ec8\u4e8e\u8ddf\u968f\u7740\u4e0a\u6d77\u706b\u7bad\u822c\ud83d\ude80\u4e0a\u6da8\u7684\u697c\u5e02\u57282021\u6625\u8282\u4e4b\u524d\u987a\u5229\u5b8c\u5de5\uff0c\u611f\u8c22\u5bb6\u4eba\uff0c\u670b\u53cb\uff0c\u540c\u4e8b\u4eec\u7684\u652f\u6301\u4e0e\u7406\u89e3\uff0c\u4e5f\u611f\u8c22\u6240\u5728team\u540c\u4e8b\u4eec\u7684\u5e2e\u52a9\u4e0e\u6307\u5bfc\u3002</p> <p>\u624b\u6478\u624b Jenkins \u6218\u672f\u6559\u7a0b (\u5927\u5e08\u7248\uff09</p> <p>\u672c\u4e66\u7740\u91cd\u4ecb\u7ecd\u4e86 ElasticSearch7, EFK &amp; ElasticStack Monitoring Kubernetes, Logstash, Kibana \u4ee5\u53ca X-PACK \u5728\u5b9e\u9645\u751f\u4ea7\u5de5\u4f5c\u4e2d\u7684\u5404\u79cd\u7528\u6cd5\u4e0e\u6d41\u6c34\u7ebf\u7684\u5f00\u53d1\uff0c\u8fd0\u7ef4\uff0c\u4ee5\u53ca\u4e0e\u5404\u4e2a\u5e38\u7528\u751f\u4ea7\u5de5\u5177\u7684\u6574\u5408\u3002\u5e76\u4e14\u7b80\u5355\u4ecb\u7ecd\u4e86 Elastic \u8ba4\u8bc1\u8003\u8bd5\u7684\u8003\u8bc1\u4ecb\u7ecd\u4e0e\u6d41\u7a0b\u3002</p> <p>\u672c\u4e66\u517119\u7ae0\uff0c\u4e3b\u8981\u5185\u5bb9\u5305\u62ec\uff1a</p> <ul> <li>Elasticsearch, Kibana, logstash\u7684\u5b89\u88c5\u4ee5\u53caDocker\u4e2d\u8fd0\u884cES, Kibana, Cerebo\u96c6\u7fa4</li> <li>Elasticsearch \u7684\u67e5\u8be2\u8bed\u53e5 (Bulk\uff0c\u5012\u6392\uff0c\u5206\u6790\u5668\uff0cMapping, Index Template&amp;Dynamic Template\uff0cAggregation)</li> <li>Elasticsearch \u6df1\u5165\u641c\u7d22 \uff08\u8bcd\u9879\uff0c\u5168\u6587\uff0c\u7ed3\u6784\u5316\u7b97\u5206\uff0c Query&amp;Filtering \u591a\u5b57\u7b26\u4e32\uff0c\u5355\u5b57\u7b26\u4e32\uff0c\u4e2d\u6587\uff0cSearch Template &amp; Index Alias\uff0cFunction Score Query\uff0c Term &amp; Phrase Suggester\uff0c\u2f83\u52a8\u8865\u5168\uff0c\u8de8\u96c6\u7fa4\u641c\u7d22\uff09</li> <li>\u5206\u5e03\u5f0f\u7279\u6027\u53ca\u5206\u5e03\u5f0f\u641c\u7d22\u7684\u673a\u5236 (\u96c6\u7fa4\u5206\u5e03\u5f0f\u6a21\u578b\uff0c\u5206\u2f5a\u4e0e\u96c6\u7fa4\u7684\u6545\u969c\u8f6c\u79fb\uff0c\u2f42\u6863\u5206\u5e03\u5f0f\u5b58\u50a8\uff0c\u5206\u2f5a\u751f\u547d\u5468\u671f\uff0c\u6392\u5e8f\u53caDoc Values&amp;Fielddata\uff0c\u5206\u9875\u4e0e\u904d\u5386\uff0c\u5904\u7406\u5e76\u53d1)</li> <li>\u6df1\u5165\u805a\u5408\u5206\u6790\uff08Bucket &amp; Metric \u805a\u5408\u5206\u6790\uff0c Pipeline \u805a\u5408\u5206\u6790\uff0c\u805a\u5408\u4f5c\u2f64\u8303\u56f4\u53ca\u6392\u5e8f\u7cbe\u51c6\u5ea6\u95ee\u9898\uff09</li> <li>\u6570\u636e\u5efa\u6a21 (\u5bf9\u8c61\u53ca Nested \u5bf9\u8c61\uff0c\u6587\u6863\u7684\u7236\u5b50\u5173\u7cfb\uff0cUpdate By Query &amp; Reindex API\uff0cngest Pipeline \u4e0e Painless Script\uff09</li> <li>\u6570\u636e\u4fdd\u62a4\uff0c\u6c34\u5e73\u6269\u5c55Elasticsearch\u96c6\u7fa4\uff0c\u751f\u4ea7\u73af\u5883\u4e2d\u7684\u96c6\u7fa4\u8fd0\u7ef4\uff0c\u7d22\u5f15\u751f\u547d\u5468\u671f\u7ba1\u7406</li> <li>Kubernets \u5b89\u88c5 EFK \u96c6\u7fa4\uff0c Elastic Stack \u6784\u5efa Kubernetes \u5168\u6808\u76d1\u63a7</li> <li>\u751f\u4ea7\u73af\u5883\u4e2d\u7684\u96c6\u7fa4\u8fd0\u7ef4\uff0c\u7d22\u5f15\u751f\u547d\u5468\u671f\u7ba1\u7406</li> <li>\u7528Logstash\u548cBeats\u6784\u5efa\u6570\u636e\u7ba1\u9053\uff0c\u7528Kibana\u8fdb\u884c\u6570\u636e\u53ef\u89c6\u5316\u5206\u6790\uff0c \u63a2\u7d22X-Pack\u5957\u4ef6</li> </ul>"},{"location":"#salut-cest-moi","title":"Salut! C'est Moi","text":"<p>The man is not old as long as he is seeking something, A man is not old until regrets take the place of dreams.</p> <p>Hello, this is me, Jacob. Currently, I'm working as DevOps and Cloud Engineer in SAP, and I'm the certified AWS Solution Architect and Certified Azure Administrator, Kubernetes Specialist, Jenkins CI/CD and ElasticStack enthusiast. </p> <p>I was working as Backend Engineer in New York City and achieved my CS master degree in SIT, America. Believe it or not, I'll keep writing, more and more books will come out at such dramatic and unprecedented 2021. </p> <p>If you have anything want to talk to me directly, you can reach out for via email xichao2015@outlook.com\u3002</p> <p>Salute, c'est moi, Jacob. Actuellement, je travaille en tant qu'ing\u00e9nieur DevOps et Cloud dans SAP, et je suis architecte de solution AWS certifi\u00e9 et administrateur Azure certifi\u00e9, sp\u00e9cialiste Kubernetes et passionn\u00e9 de CI/CD.</p> <p>Je travaillais en tant qu'ing\u00e9nieur backend \u00e0 New York et j'ai obtenu mon master CS \u00e0 SIT, en Am\u00e9rique. Croyez-le ou non, je continuerai \u00e0 \u00e9crire, de plus en plus de livres sortiront cette ann\u00e9e.</p>"},{"location":"#_2","title":"\u76ee\u5f55\u5927\u7eb2","text":"<ul> <li>\u7b2c\u4e00\u7ae0 Elasticsearch \u6982\u8ff0<ul> <li>\u7b2c\u4e00\u8282 ElasticSearch \u6982\u8ff0</li> </ul> </li> <li>\u7b2c\u4e8c\u7ae0 Elasticsearch \u5b89\u88c5\u624b\u518c<ul> <li>\u7b2c\u4e00\u8282 Elasticsearch\u7684\u5b89\u88c5\u4e0e\u7b80\u5355\u914d\u7f6e</li> <li>\u7b2c\u4e8c\u8282 Kibana\u7684\u5b89\u88c5\u4e0e\u754c\u9762\u5feb\u901f\u9884\u89c8</li> <li>\u7b2c\u4e09\u8282 \u5728Docker\u5bb9\u5668\u4e2d\u8fd0\u884cElasticsearch Kibana\u548cCerebro</li> <li>\u7b2c\u56db\u8282 Logstash\u5b89\u88c5\u4e0e\u5bfc\u5165\u6570\u636e</li> </ul> </li> <li>\u7b2c\u4e09\u7ae0 Elasticsearch \u5165\u95e8\u67e5\u8be2<ul> <li>\u7b2c\u4e00\u8282 ElasticSearch \u57fa\u672c\u6982\u5ff5</li> <li>\u7b2c\u4e8c\u8282 \u6587\u6863\u7684\u57fa\u672cCRUD\u4e0e\u6279\u91cf\u64cd\u4f5c &amp; \u8bfb\u53d6\uff06Bulk API</li> <li>\u7b2c\u4e09\u8282 \u5012\u6392\u7d22\u5f15</li> <li>\u7b2c\u56db\u8282 \u4f7f\u7528\u5206\u6790\u5668\u8fdb\u884c\u5206\u8bcd</li> <li>\u7b2c\u4e94\u8282 ElasticSearch Search\u8bed\u53e5</li> <li>\u7b2c\u516d\u8282 ElasticSearch Mapping \u4ecb\u7ecd</li> <li>\u7b2c\u4e03\u8282 Index Template\u548cDynamic Template</li> <li>\u7b2c\u516b\u8282 Elasticsearch Aggregations\u805a\u5408\u5206\u6790\u7b80\u4ecb</li> <li>\u7b2c\u4e5d\u8282 Elasticsearch \u5165\u95e8\u603b\u7ed3 &amp; \u6d4b\u8bd5</li> </ul> </li> <li>\u7b2c\u56db\u7ae0 Elasticsearch \u6df1\u5165\u641c\u7d22<ul> <li>\u7b2c\u4e00\u8282 \u57fa\u4e8e\u8bcd\u9879\u548c\u57fa\u4e8e\u5168\u6587\u7684\u641c\u7d22</li> <li>\u7b2c\u4e8c\u8282 \u7ed3\u6784\u5316\u641c\u7d22\u4ee5\u53ca\u641c\u7d22\u7684\u76f8\u5173\u6027\u7b97\u5206</li> <li>\u7b2c\u4e09\u8282 Query &amp; Filtering\u4e0e\u591a\u5b57\u7b26\u4e32\u591a\u5b57\u6bb5\u67e5\u8be2</li> <li>\u7b2c\u56db\u8282 \u5355\u5b57\u7b26\u4e32\u591a\u5b57\u6bb5\u67e5\u8be2</li> <li>\u7b2c\u4e94\u8282 \u591a\u8bed\u8a00\u53ca\u4e2d\u6587\u5206\u8bcd\u4e0e\u68c0\u7d22</li> <li>\u7b2c\u516d\u8282 Space Jam\uff0c\u4e00\u6b21\u5168\u6587\u641c\u7d22\u7684\u5b9e\u4f8b</li> <li>\u7b2c\u4e03\u8282 \u4f7f\u7528 Search Template \u548c Index Alias</li> <li>\u7b2c\u516b\u8282 \u7efc\u5408\u6392\u5e8f:Function Score Query \u4f18\u5316\u7b97\u5206</li> <li>\u7b2c\u4e5d\u8282 Term &amp; Phrase Suggester</li> <li>\u7b2c\u5341\u8282 \u2f83\u52a8\u8865\u5168\u4e0e\u57fa\u4e8e\u4e0a\u4e0b\u6587\u7684\u63d0\u793a</li> <li>\u7b2c\u5341\u4e00\u8282 \u8de8\u96c6\u7fa4\u641c\u7d22</li> </ul> </li> <li>\u7b2c\u4e94\u7ae0 \u5206\u5e03\u5f0f\u7279\u6027\u53ca\u5206\u5e03\u5f0f\u641c\u7d22\u7684\u673a\u5236<ul> <li>\u7b2c\u4e00\u8282 \u96c6\u7fa4\u5206\u5e03\u5f0f\u6a21\u578b\u53ca\u9009\u4e3b\u4e0e\u8111\u88c2\u95ee\u9898</li> <li>\u7b2c\u4e8c\u8282 \u5206\u2f5a\u4e0e\u96c6\u7fa4\u7684\u6545\u969c\u8f6c\u79fb</li> <li>\u7b2c\u4e09\u8282 \u2f42\u6863\u5206\u5e03\u5f0f\u5b58\u50a8</li> <li>\u7b2c\u56db\u8282 \u5206\u2f5a\u53ca\u5176\u751f\u547d\u5468\u671f</li> <li>\u7b2c\u4e94\u8282 \u5256\u6790\u5206\u5e03\u5f0f\u67e5\u8be2\u53ca\u76f8\u5173\u6027\u7b97\u5206</li> <li>\u7b2c\u516d\u8282 \u6392\u5e8f\u53caDoc Values&amp;Fielddata</li> <li>\u7b2c\u4e03\u8282 \u5206\u9875\u4e0e\u904d\u5386 \u2013 From\uff0cSize\uff0cSearch After &amp; Scroll API</li> <li>\u7b2c\u516b\u8282 \u5904\u7406\u5e76\u53d1\u8bfb\u5199\u64cd\u4f5c</li> </ul> </li> <li>\u7b2c\u516d\u7ae0 \u6df1\u5165\u805a\u5408\u5206\u6790<ul> <li>\u7b2c\u4e00\u8282 Bucket &amp; Metric \u805a\u5408\u5206\u6790\u53ca\u5d4c\u5957\u805a\u5408 </li> <li>\u7b2c\u4e8c\u8282 Pipeline \u805a\u5408\u5206\u6790</li> <li>\u7b2c\u4e09\u8282 \u805a\u5408\u7684\u4f5c\u2f64\u7528\u8303\u56f4\u53ca\u6392\u5e8f</li> <li>\u7b2c\u56db\u8282 \u805a\u5408\u7684\u7cbe\u51c6\u5ea6\u95ee\u9898</li> </ul> </li> <li>\u7b2c\u4e03\u7ae0 \u6570\u636e\u5efa\u6a21<ul> <li>\u7b2c\u4e00\u8282 \u5bf9\u8c61\u53ca Nested \u5bf9\u8c61</li> <li>\u7b2c\u4e8c\u8282 \u6587\u6863\u7684\u7236\u5b50\u5173\u7cfb</li> <li>\u7b2c\u4e09\u8282 Update By Query &amp; Reindex API</li> <li>\u7b2c\u56db\u8282 Ingest Pipeline \u4e0e Painless Script</li> <li>\u7b2c\u4e94\u8282 Elasticsearch \u6570\u636e\u5efa\u6a21\u5b9e\u4f8b</li> <li>\u7b2c\u516d\u8282 Elasticsearch \u6570\u636e\u5efa\u6a21\u6700\u4f73\u5b9e\u8df5</li> <li>\u7b2c\u4e03\u8282 \u7b2c\u4e8c\u90e8\u5206\u603b\u7ed3\u56de\u987e</li> </ul> </li> <li>\u7b2c\u516b\u7ae0 \u6570\u636e\u4fdd\u62a4<ul> <li>\u7b2c\u4e00\u8282 \u96c6\u7fa4\u8eab\u4efd\u8ba4\u8bc1\u4e0e\u7528\u6237\u9274\u6743</li> <li>\u7b2c\u4e8c\u8282 \u96c6\u7fa4\u5185\u90e8\u95f4\u7684\u5b89\u5168\u901a\u4fe1</li> <li>\u7b2c\u4e09\u8282 \u96c6\u7fa4\u4e0e\u5916\u90e8\u95f4\u7684\u5b89\u5168\u901a\u4fe1</li> </ul> </li> <li>\u7b2c\u4e5d\u7ae0 \u6c34\u5e73\u6269\u5c55Elasticsearch\u96c6\u7fa4<ul> <li>\u7b2c\u4e00\u8282 \u5e38\u89c1\u7684\u96c6\u7fa4\u90e8\u7f72\u65b9\u5f0f</li> <li>\u7b2c\u4e8c\u8282 Hot &amp; Warm \u67b6\u6784\u4e0e Shard Filtering</li> <li>\u7b2c\u4e09\u8282 \u5206\u7247\u8bbe\u5b9a\u53ca\u7ba1\u7406</li> <li>\u7b2c\u56db\u8282 \u5982\u4f55\u5bf9\u96c6\u7fa4\u8fdb\u884c\u5bb9\u91cf\u89c4\u5212</li> <li>\u7b2c\u4e94\u8282\u3001\u4e91\u4e0a\u7ba1\u7406 Elasticsearch \u7684\u4e00\u4e9b\u65b9\u6cd5</li> </ul> </li> <li>\u7b2c\u5341\u7ae0 \u4f7f\u7528 Kubernets \u5b89\u88c5 EFK \u96c6\u7fa4<ul> <li>\u7b2c\u4e00\u8282 kubernetes \u65e5\u5fd7\u67b6\u6784 </li> <li>\u7b2c\u4e8c\u8282 \u5728 K8S \u4e0a\u642d\u5efa EFK \u65e5\u5fd7\u6536\u96c6\u7cfb\u7edf</li> <li>\u7b2c\u4e09\u8282 \u5728 Kubernetes \u5b89\u88c5 EFK \u65e5\u5fd7\u6536\u96c6\u7cfb\u7edf[\u66f4\u65b0]</li> <li>\u7b2c\u56db\u8282 kibana \u65e5\u5fd7\u5206\u6790</li> <li>\u7b2c\u4e94\u8282 \u57fa\u4e8eEKF\u65e5\u5fd7\u7684\u62a5\u8b66</li> <li>\u7b2c\u516d\u8282 \u4f7f\u7528Operator\u5feb\u901f\u90e8\u7f72Elasticsearch\u96c6\u7fa4</li> <li>\u7b2c\u4e03\u8282 \u4f7f\u7528 EFKLK \u642d\u5efa Kubernetes \u65e5\u5fd7\u6536\u96c6\u5de5\u5177\u6808 (Kafka/Logstash)</li> </ul> </li> <li>\u7b2c\u5341\u4e00\u7ae0 \u4f7f\u7528 Elastic Stack \u6784\u5efa Kubernetes \u5168\u6808\u76d1\u63a7<ul> <li>\u7b2c\u4e00\u8282 ElasticSearch \u7684\u96c6\u7fa4\u5b89\u88c5 </li> <li>\u7b2c\u4e8c\u8282 \u4f7f\u7528 Elastic Stack \u2014 Metricbeat \u76d1\u63a7\u5b89\u88c5</li> <li>\u7b2c\u4e09\u8282 \u4f7f\u7528 Elastic Stack - Filebeat \u65e5\u5fd7\u6570\u636e\u6536\u96c6\u5b89\u88c5</li> <li>\u7b2c\u56db\u8282 \u4f7f\u7528 Elastic Stack \u2014 Elastic APM \u5e94\u7528\u6027\u80fd\u76d1\u63a7\u7684\u5de5\u5177\u5b89\u88c5</li> </ul> </li> <li>\u7b2c\u5341\u4e8c\u7ae0 \u751f\u4ea7\u73af\u5883\u4e2d\u7684\u96c6\u7fa4\u8fd0\u7ef4<ul> <li>\u7b2c\u4e00\u8282 \u751f\u4ea7\u73af\u5883\u5e38\u7528\u914d\u7f6e\u548c\u4e0a\u7ebf\u6e05\u5355</li> <li>\u7b2c\u4e8c\u8282 \u76d1\u63a7Elasticsearch\u96c6\u7fa4</li> <li>\u7b2c\u4e09\u8282 \u8bca\u65ad\u96c6\u7fa4\u7684\u6f5c\u5728\u95ee\u9898</li> <li>\u7b2c\u56db\u8282 \u89e3\u51b3\u96c6\u7fa4 Yellow \u4e0e Red \u7684\u95ee\u9898</li> <li>\u7b2c\u4e94\u8282 \u96c6\u7fa4\u5199\u6027\u80fd\u4f18\u5316</li> <li>\u7b2c\u516d\u8282 \u96c6\u7fa4\u538b\u529b\u6d4b\u8bd5</li> <li>\u7b2c\u4e03\u8282 \u6bb5\u5408\u5e76\u4f18\u5316\u53ca\u6ce8\u610f\u4e8b\u9879</li> <li>\u7b2c\u516b\u8282 \u7f13\u5b58\u53ca\u4f7f\u7528 Circuit Breaker \u9650\u5236\u5185\u5b58\u4f7f\u7528</li> <li>\u7b2c\u4e5d\u8282 \u4e00\u4e9b\u8fd0\u7ef4\u76f8\u5173\u7684\u5efa\u8bae</li> </ul> </li> <li>\u7b2c\u5341\u4e09\u7ae0 \u7d22\u5f15\u751f\u547d\u5468\u671f\u7ba1\u7406<ul> <li>\u7b2c\u4e00\u8282 \u4f7f\u7528 Shrink \u4e0e Rollover API \u7ba1\u7406\u7d22\u5f15 </li> <li>\u7b2c\u4e8c\u8282 \u7d22\u5f15\u5168\u751f\u547d\u5468\u671f\u7ba1\u7406\u53ca\u5de5\u5177\u4ecb\u7ecd</li> </ul> </li> <li>\u7b2c\u5341\u56db\u7ae0 \u7528Logstash\u548cBeats\u6784\u5efa\u6570\u636e\u7ba1\u9053<ul> <li>\u7b2c\u4e00\u8282 Logstash \u5165\u95e8\u53ca\u67b6\u6784\u4ecb\u7ecd</li> <li>\u7b2c\u4e8c\u8282 \u5229\u7528 JDBC \u63d2\u4ef6\u5bfc\u5165\u6570\u636e\u5230 Elasticsearch</li> <li>\u7b2c\u4e09\u8282 Beats \u4ecb\u7ecd</li> </ul> </li> <li>\u7b2c\u5341\u4e94\u7ae0 \u7528Kibana\u8fdb\u884c\u6570\u636e\u53ef\u89c6\u5316\u5206\u6790<ul> <li>\u7b2c\u4e00\u8282 \u4f7f\u7528 Index Pattern \u914d\u7f6e\u6570\u636e</li> <li>\u7b2c\u4e8c\u8282 Kibana \u4f7f\u7528\u7684\u6280\u5de7</li> </ul> </li> <li>\u7b2c\u5341\u516d\u7ae0 \u63a2\u7d22X-Pack\u5957\u4ef6 <ul> <li>\u7b2c\u4e00\u8282 \u7528Monitoring\u548cAlerting\u76d1\u63a7Elasticsearch\u96c6\u7fa4</li> <li>\u7b2c\u4e8c\u8282 \u7528 APM \u8fdb\u884c\u7a0b\u5e8f\u6027\u80fd\u76d1\u63a7</li> <li>\u7b2c\u4e09\u8282 \u7528\u673a\u5668\u5b66\u4e60\u5b9e\u73b0\u5f02\u5e38\u68c0\u6d4b</li> <li>\u7b2c\u56db\u8282 \u7528 Elastic Stack \u8fdb\u884c\u65e5\u5fd7\u7ba1\u7406</li> <li>\u7b2c\u4e94\u8282 \u7528 Canvas \u8fdb\u884c\u6570\u636e\u7684\u5b9e\u65f6\u5c55\u793a</li> </ul> </li> <li>\u7b2c\u5341\u4e03\u7ae0 ELK \u5b9e\u6218 Workshop<ul> <li>\u7b2c\u4e00\u8282 \u7535\u5f71\u641c\u7d22\u670d\u52a1</li> <li>\u7b2c\u4e8c\u8282 Stackoverflow\u7528\u6237\u8c03\u67e5\u95ee\u5377\u5206\u6790</li> </ul> </li> <li> <p>\u7b2c\u5341\u516b\u7ae0 Elastic\u8ba4\u8bc1, \u5f00\u53d1\u4e0e\u5907\u4efd </p> <ul> <li>\u7b2c\u4e00\u8282 Elastic \u8ba4\u8bc1\u8003\u8bd5</li> <li>\u7b2c\u4e8c\u8282 \u96c6\u7fa4 Backup &amp; Restore </li> <li>\u7b2c\u4e09\u8282 \u57fa\u4e8e Java \u548c Elasticsearch \u5f00\u53d1\u5e94\u7528</li> <li>\u7b2c\u56db\u8282 3\u79cd Elasticsearch \u6570\u636e\u79bb\u7ebf\u8fc1\u79fb\u65b9\u6848</li> </ul> </li> <li> <p>ElasticSearch URI \u5e38\u7528\u8bed\u53e5\u603b\u7ed3\u7bc7</p> </li> <li>Elasticsearch \u6df1\u5165\u641c\u7d22\u603b\u7ed3</li> <li>ElasticSearch \u5206\u5e03\u5f0f\u641c\u7d22</li> <li>ElasticSearch \u6df1\u5165\u805a\u5408\u5206\u6790</li> <li>ElasticSearch  \u6570\u636e\u5efa\u6a21</li> <li>ElasticSearch Operation and Management</li> <li>ElasticSearch \u9762\u8bd5</li> <li>\u671f\u672b\u8003\u8bd5</li> </ul>"},{"location":"#to-be-continue","title":"To be continue","text":"<p>\u672c\u4eba\u5c06\u5e26\u6765\u624b\u6478\u624b\u6218\u672f\u6559\u7a0b\u66f4\u591a\u7684\u5185\u5bb9\u548c\u6587\u7ae0\uff0c \u63a5\u4e0b\u6765\u7684\u5c06\u5728Datatase, Redis, Golang, Chef, Azure900, Azure103, AWS Solution Arcitect, AWS Big Data Speciality, Istio, Python\u5e26\u6765\u66f4\u591a\u66f4\u5168\u9762\u7684\u7535\u5b50\u4e66\uff0c\u656c\u8bf7\u671f\u5f85\u3002</p> <p></p>"},{"location":"chap1/1Es_intro/","title":"\u7b2c\u4e00\u8282 ElasticSearch \u6982\u8ff0","text":""},{"location":"chap1/1Es_intro/#1","title":"1\u3001\u672c\u4e66\u5185\u5bb9\u4e0e\u7ed3\u6784","text":""},{"location":"chap1/1Es_intro/#1-1-elasticsearch","title":"1-1 Elasticsearch\u5165\u95e8\u4e0e\u6df1\u5165","text":"<ul> <li>\u73af\u5883\u642d\u5efa\uff0f\u641c\u7d22\u4e0e\u805a\u5408\uff0f\u67b6\u6784\u539f\u7406\uff0f\u6570\u636e\u5efa\u6a21 </li> </ul>"},{"location":"chap1/1Es_intro/#1-2-elasticsearch","title":"1-2 Elasticsearch\u96c6\u7fa4\u7ba1\u7406","text":"<ul> <li>\u6c34\u5e73\u6269\u5c55\u53ca\u80dc\u80fd\u4f18\u5316\uff0f\u6700\u4f73\u5b9e\u8df5 </li> </ul>"},{"location":"chap1/1Es_intro/#1-3-elk","title":"1-3 ELK\u8fdb\u884c\u5927\u6570\u636e\u5206\u6790","text":"<ul> <li>\u53ef\u89c6\u5316\u5206\u6790\uff0f\u65f6\u5e8f\u578b\u6570\u636e\uff0f\u5f02\u5e38\u68c0\u6d4b </li> </ul>"},{"location":"chap1/1Es_intro/#1-4","title":"1-4 \u9879\u76ee\u5b9e\u6218\u548c\u77e5\u8bc6\u70b9\u56de\u987e","text":"<ul> <li>\u7535\u5f71\u641c\u7d22\uff0f\u95ee\u5377\u5206\u6790\uff0fElastic\u8ba4\u8bc1 </li> </ul>"},{"location":"chap1/1Es_intro/#2elasticsearch","title":"2\u3001Elasticsearch\u7b80\u4ecb\u53ca\u5176\u53d1\u5c55\u5386\u53f2","text":"<ul> <li>\u4ea7\u54c1\u7279\u6027\u53ca\u53d1\u5c55\u5386\u53f2</li> <li>\u516c\u53f8\u613f\u666f\u4e0e\u5546\u4e1a\u6a21\u578b</li> </ul>"},{"location":"chap1/1Es_intro/#2-1","title":"2-1 \u4ece\u5f00\u6e90\u5230\u4e0a\u5e02","text":"<ul> <li>Elastic Inc\u4e00\u5f00\u6e90\u8f6f\u4ef6\uff0f\u4e0a\u5e02\u516c\u53f8 </li> <li>\u5f53\u524d\u5e02\u503c\u8d85\u8fc750\u4ebf\u7f8e\u91d1\uff0c\u5f00\u76d8\u5f53\u5929\u6da8\u5e45\u8fbe94% </li> <li>Elasticsearch\u8f6f\u4ef6\u4e0b\u8f7d\u91cf\uff0c\u8d853.5\u4ebf\u6b21 </li> <li>10\u4e07\uff0b\u7684\u793e\u533a\u6210\u5458 </li> <li>7200\uff0b\u8ba2\u9605\u7528\u6237\uff0c\u5206\u5e03\u5728100\uff0b\u56fd\u5bb6 </li> <li>\u4e91\u670d\u52a1\u4e00Elastic, Amazon\uff0c\u963f\u91cc\u5df4\u5df4\uff0c\u817e\u8baf </li> </ul>"},{"location":"chap1/1Es_intro/#2-2-elasticsearch","title":"2-2 Elasticsearch \u5ba2\u6237","text":""},{"location":"chap1/1Es_intro/#2-3-elasticsearch","title":"2-3 Elasticsearch\u7b80\u4ecb","text":"<ul> <li>Elasticsearch\u4e00\u5f00\u6e90\u5206\u5e03\u5f0f\u641c\u7d22\u5206\u6790\u5f15\u64ce <ul> <li>\u8fd1\u5b9e\u65f6\uff08Near Real Time) </li> <li>\u5206\u5e03\u5f0f\u5b58\u50a8\uff0f\u641c\u7d22\uff0f\u5206\u6790\u5f15\u64ce </li> </ul> </li> <li>Solr (Apache\u5f00\u6e90\u9879\u76ee\uff09 </li> <li>Splunk\uff08\u5546\u4e1a\u4e0a\u5e02\u516c\u53f8\uff09 </li> </ul> <p>https://db-engines.com/en/ranking</p>"},{"location":"chap1/1Es_intro/#2-4-lucene","title":"2-4 \u8d77\u6e90 - Lucene","text":"<ul> <li>\u57fa\u4e8eJava\u8bed\u8a00\u5f00\u53d1\u7684\u641c\u7d22\u5f15\u5bb6\u5e93\u7c7b </li> <li>\u521b\u5efa\u4e8e1999\u5e742005\u5e74\u6210\u4e3aApache\u9876\u7ea7\u5f00\u6e90\u9879\u76ee </li> <li>\u5177\u6709\u9ad8\u6027\u80fd\u6613\u6269\u5c55\u7684\u4f18\u70b9</li> <li>Lucene\u7684\u5c40\u9650\u6027 <ul> <li>\u53ea\u80fd\u57fa\u4e8eJava\u8bed\u8a00\u5f00\u53d1 </li> <li>\u7c7b\u5e93\u7684\u63a5\u53e3\u5b66\u4e60\u66f2\u7ebf\u9661\u5ced </li> <li>\u539f\u751f\u5e76\u4e0d\u652f\u6301\u6c34\u5e73\u6269\u5c55 </li> </ul> </li> </ul>"},{"location":"chap1/1Es_intro/#2-5-elasticsearch","title":"2-5 Elasticsearch\u7684\u8bde\u751f","text":"<ul> <li>2004\u5e74Shay Banon\u57fa\u4e8eLucene\u5f00\u53d1\u4e86Compass </li> <li>2010\u5e74Shay Banon\u91cd\u5199\u4e86Compass\uff0c\u53d6\u540dElasticsearch <ul> <li>\u652f\u6301\u5206\u5e03\u5f0f\uff0c\u53ef\u6c34\u5e73\u6269\u5c55 </li> <li>\u964d\u4f4e\u5168\u6587\u68c0\u7d22\u7684\u5b66\u4e60\u66f2\u7ebf\uff0c\u53ef\u4ee5\u88ab\u4efb\u4f55\u7f16\u7a0b\u8bed\u8a00\u8c03\u7528 </li> </ul> </li> </ul>"},{"location":"chap1/1Es_intro/#2-6-elasticsearch","title":"2-6 Elasticsearch\u7684\u5206\u5e03\u5f0f\u67b6\u6784","text":"<ul> <li>\u96c6\u7fa4\u89c4\u6a21\u53ef\u4ee5\u4ece\u5355\u4e2a\u6269\u5c55\u81f3\u6570\u767e\u4e2a\u8282\u70b9 </li> <li>\u9ad8\u53ef\u7528\uff06\u6c34\u5e73\u6269\u5c55 <ul> <li>\u670d\u52a1\u548c\u6570\u636e\u4e24\u4e2a\u7eac\u5ea6 </li> </ul> </li> <li>\u652f\u6301\u4e0d\u540c\u7684\u8282\u70b9\u7c7b\u578b <ul> <li>\u652f\u6301Hot&amp;Warm\u67b6\u6784 </li> </ul> </li> </ul>"},{"location":"chap1/1Es_intro/#2-7","title":"2-7 \u652f\u6301\u591a\u79cd\u65b9\u5f0f\u96c6\u6210\u63a5\u5165","text":"<ul> <li> <p>\u591a\u79cd\u7f16\u7a0b\u8bed\u8a00\u7684\u7c7b\u5e93\uff08https://www.elastic.co/guide/en/elasticsearch/client/index.html) </p> <ul> <li>Java/NET/Python/Ruby/PHP/Grooy\uff0fPerl </li> </ul> </li> <li> <p>RESTful API vs Transport API </p> <ul> <li>9200 vs 9300\uff08\u5efa\u8bae\u4f7f\u7528RESTful API) </li> </ul> </li> <li>JDBC &amp; ODBC </li> </ul>"},{"location":"chap1/1Es_intro/#2-8-5x","title":"2-8 \u65b0\u7279\u6027 5.X","text":"<ul> <li>Lucene 6.X \u6027\u80fd\u63d0\u5347\u9ed8\u8ba4\u6253\u5206\u673a\u5236\u4eceTF-IDF\u6539\u4e3aBM 25 </li> <li>\u652f\u6301Ingest\u8282\u70b9/Painless Scripting/Completion suggested \u652f\u6301\uff0f\u539f\u751f\u7684Java REST\u5ba2\u6237\u7aef </li> <li>Type\u6807\u8bb0\u6210deprecated, \u652f\u6301\u4e86Keyword\u7684\u7c7b\u578b </li> <li>\u6027\u80fd\u4f18\u5316 <ul> <li>\u5185\u90e8\u5f15\u64ce\u79fb\u9664\u4e86\u907f\u514d\u540c\u4e00\u6587\u6863\u5e76\u53d1\u66f4\u65b0\u7684\u7ade\u4e89\u9501,\u5e26\u676515\uff05\u4e0020\uff05\u7684\u6027\u80fd\u63d0\u5347 </li> <li>Instant aggregation\u652f\u6301\u5206\u7247\u4e0a\uff0c\u805a\u5408\u7684\u7f13\u5b58 </li> <li>\u65b0\u589e\u4e86Profile API </li> </ul> </li> </ul>"},{"location":"chap1/1Es_intro/#2-9-6x","title":"2-9 \u65b0\u7279\u60276.x","text":"<ul> <li>Lucene 7.x </li> <li>\u65b0\u529f\u80fd <ul> <li>\u8de8\u96c6\u7fa4\u590d\u5236(OCR) </li> <li>\u7d22\u5f15\u751f\u547d\u5468\u671f\u7ba1\u7406</li> <li>SQL\u7684\u652f\u6301</li> </ul> </li> <li>\u66f4\u53cb\u597d\u7684\u7684\u5347\u7ea7\u53ca\u6570\u636e\u8fc1\u79fb <ul> <li>\u5728\u4e3b\u8981\u7248\u672c\u4e4b\u95f4\u7684\u8fc1\u79fb\u66f4\u4e3a\u7b80\u5316\u4f53\u9a8c\u5347\u7ea7 </li> <li>\u5168\u65b0\u7684\u57fa\u4e8e\u64cd\u4f5c\u7684\u6570\u636e\u590d\u5236\u6846\u67b6\u53ef\u52a0\u51b3\u759a\u590d\u6570\u636e </li> </ul> </li> <li>\u6027\u80fd\u4f18\u5316<ul> <li>\u6709\u6548\u5b58\u50a8\u7a00\u758f\u5b87\u6bb5\u7684\u65b0\u65b9\u6cd5\u964d\u4f4e\u4e86\u5b58\u50a8\u6210\u672c </li> <li>\u5728\u7d22\u5f15\u65f6\u8fdb\u884c\u6392\u5e8f\uff0c\u53ef\u52a0\u5feb\u6392\u5e8f\u7684\u67e5\u8be2\u6027\u80fd </li> </ul> </li> </ul>"},{"location":"chap1/1Es_intro/#2-10-7x","title":"2-10 \u65b0\u7279\u6027 7.x","text":"<ul> <li>Lucene 8.0 </li> <li>\u91cd\u5927\u6539\u8fdb - \u6b63\u5f0f\u5e9f\u9664\u5355\u4e2a\u7d22\u5f15\u4e0b\u591aType\u7684\u652f\u6301 </li> <li>7.1\u5f00\u59cbSecurity \u529f\u80fd\u514d\u8d39\u4f7f\u7528 </li> <li>ECK Elastic Operator on Kubernetes </li> <li>\u65b0\u529f\u80fd <ul> <li>New Custer coordination </li> <li>Feature - Complete High level REST Client </li> <li>Script Score Query </li> </ul> </li> <li>\u6027\u80fd\u4f18\u5316 <ul> <li>\u9ed8\u8ba4\u7684Primary Shard\u6570\u4ece5\u6539\u4e3a1,\u907f\u514dOver Sharding</li> <li>\u6027\u80fd\u4f18\u5316\u66f4\u51b3\u7684Top K </li> </ul> </li> </ul>"},{"location":"chap1/1Es_intro/#2-11","title":"2-11 \u672c\u8282\u56de\u987e","text":"<ul> <li>Elastcsearch\u662f\u6b3e\u57fa\u4e8eLunece\u7684\u5f00\u6e90\u5206\u5e03\u5f0f\u641c\u7d22\u5206\u6790\u5f15\u64ce <ul> <li>\u67e5\u8be2\u6027\u80fd\u597d(Near Real Time) </li> <li>\u5206\u5e03\u5f0f\u8bbe\u8ba1\uff0c\u975e\u5e38\u65b9\u4fbf\u7684\u652f\u6301\u6c34\u5e73\u6269\u5c55 </li> <li>\u652f\u6301\u591a\u79cd\u8bed\u8a00\u7684\u96c6\u6210 </li> </ul> </li> <li>\u8d85\u8fc72.5\u4ebf\u7684\u4e0b\u8f7d\u91cf\uff0cElasticsearch\u4e0d\u4ec5\u6709\u770b\u826f\u597d\u7684\u5f00\u53d1\u8005\u793e\u533a, \u66f4\u6709\u7740\u5546\u4e1a\u5206\u53f8\u652f\u6491 <ul> <li>\u5927\u91cf\u7684\u4e92\u8054\u7f51\u516c\u53f8\u4f7f\u7528 </li> </ul> </li> </ul>"},{"location":"chap1/1Es_intro/#3elk-stack","title":"3\u3001ELK Stack\u5bb6\u65cf\u6210\u5458\u53ca\u5176\u5e94\u7528\u573a\u666f","text":""},{"location":"chap1/1Es_intro/#3-1","title":"3-1 \u672c\u8282\u77e5\u8bc6\u70b9","text":"<ul> <li>Elastic Stack\u7684\u4ea7\u54c1\u751f\u6001\u5708 </li> <li>\u6838\u5fc3\u4ea7\u54c1ELKB\u7684\u7b80\u4ecb </li> <li>Elastic Stack\u7684\u4f7f\u7528\u573a\u666f\u4e0e\u7528\u4f8b </li> <li>Elastic\u516c\u53f8\u7684\u5f00\u6e90\u7b56\u7565\u4e0e\u5546\u4e1a\u6a21\u5f0f </li> <li>Elastic Stack\u6570\u636e\u63a5\u5165\u7684\u65b9\u6cd5\u53ca\u901a\u7528\u7684\u7cfb\u7edf\u67b6\u6784 </li> </ul>"},{"location":"chap1/1Es_intro/#3-2-elastic-stack","title":"3-2 Elastic Stack \u751f\u6001\u5708","text":""},{"location":"chap1/1Es_intro/#3-3-log-stash","title":"3-3 Log stash:\u6570\u636e\u5904\u7406\u7ba1\u9053","text":"<ul> <li>\u5f00\u6e90\u7684\u670d\u52a1\u5668\u7aef\u6570\u636e\u5904\u7406\u7ba1\u9053\uff0c\u652f\u6301\u4ece\u4e0d\u540c\u6765\u6e90\u91c7\u96c6\u6570\u636e\uff0c \u8f6c\u6362\u6570\u636e\u5e76\u5c06\u6570\u636e\u53d1\u9001\u5230\u4e0d\u540c\u7684\u5b58\u50a8\u5e93\u4e2d </li> <li>Loqstash\u8bde\u751f\u4e8e2009\u5e74\uff0c\u6700\u521d\u7528\u6765\u505a\u65e5\u5fd7\u7684\u91c7\u96c6\u4e0e\u5904\u7406 </li> <li>2013\u5e74\u88abElasticsearch\u6536\u8d2d </li> </ul>"},{"location":"chap1/1Es_intro/#3-4-logstash","title":"3-4 Logstash\u7279\u6027","text":"<ul> <li>\u5b9e\u65f6\u89e3\u6790\u548c\u8f6c\u6362\u6570\u636e <ul> <li>\u4eceIP\u5730\u5740\u7834\u8bd1\u51fa\u5730\u7406\u5750\u6807 </li> <li>\u5c06PII\u6570\u636e\u533f\u540d\u5316\uff0c\u5b8c\u5168\u6392\u9664\u654f\u611f\u5b57\u6bb5 </li> </ul> </li> <li>\u53ef\u6269\u5c55 <ul> <li>200\u591a\u4e2a\u63d2\u4ef6\uff08\u65e5\u5fd7/\u6570\u636e\u5e93/Arcsigh/Netflow) </li> </ul> </li> <li>\u53ef\u9760\u6027\u5b89\u5168\u6027 <ul> <li>Logstash\u4f1a\u901a\u8fc7\u6301\u4e45\u5316\u961f\u5217\u6765\u4fdd\u8bc1\u81f3\u5c11\u5c06\u8fd0\u884c\u4e2d\u7684\u4e8b\u4ef6\u9001\u8fbe\u4e00\u6b21 </li> <li>\u6570\u636e\u4f20\u8f93\u52a0\u5bc6 </li> </ul> </li> <li>\u76d1\u63a7 </li> </ul>"},{"location":"chap1/1Es_intro/#3-5-kibana","title":"3-5 Kibana:\u53ef\u89c6\u5316\u5206\u6790\u5229\u5668","text":"<ul> <li>Kibana\u540d\u5b57\u7684\u542b\u4e49\uff1dKiwifruit+Banana </li> <li>\u6570\u636e\u53ef\u89c6\u5316\u5de5\u5177\uff0c\u5e2e\u52a9\u7528\u6237\u89e3\u5f00\u5bf9\u6570\u636e\u7684\u4efb\u4f55\u7591\u95ee </li> <li>\u57fa\u4e8eLogstash\u7684\u5de5\u5177\uff0c2013\u5e74\u52a0\u5165Elastic\u516c\u53f8 </li> </ul> <p>Kibana\u7279\u6027</p> <p></p>"},{"location":"chap1/1Es_intro/#3-6-elastic","title":"3-6 Elastic\u7684\u53d1\u5c55","text":"<ul> <li>2015\u5e743\u6708\u6536\u8d2dElastic Cloud\u63d0\u4f9bCloud\u670d\u52a1 </li> <li>2015\u5e743\u6708\u6536\u8d2dPacketBeat</li> <li>2016\u5e749\u6708\u6536\u8d2d PreAlert - Machine Leanning \u5f02\u5e38\u68c0\u6d4b </li> <li>2017\u5e746\u6708\u6536\u8d2dOpbeat\u8fdb\u519bAPM </li> <li>2017\u5e7411\u6708\u6536\u8d2dSaaS\u5382\u5546Swifttype\u63d0\u4f9b\u7f51\u7ad9\u548cApp\u641c\u7d22 </li> <li>2013\u5e74X-Pack\u5f00\u6e90 </li> </ul>"},{"location":"chap1/1Es_intro/#3-7-beats-","title":"3-7  BEATS - \u8f7b\u91cf\u7684\u6570\u636e\u91c7\u96c6\u5668","text":"<p>https://www.elastic.co/cn/beats/</p> <p></p> <p>beats\u662f\u8f7b\u91cf\u7ea7\u7684\u6570\u636eshipper\uff0c\u4f7f\u7528go\u8bed\u8a00\u5f00\u53d1\uff0c\u4e3b\u8981\u7528\u6765\u505a\u6570\u636e\u91c7\u96c6\uff0c\u6570\u636e\u7684enrichment\u76f8\u5173\u7684\u529f\u80fd\u6bd4\u8f83\u5c11\uff0c\u66f4\u591a\u7684\u662f\u4ee5agent\u7684\u65b9\u5f0f\u542f\u52a8\u5728\u6570\u636e\u6e90\u7684\u673a\u5668\u4e0a\u3002</p> <ul> <li>beats\u53ef\u4ee5\u548ces\u8fde\u63a5\u4e5f\u53ef\u4ee5\u548clogstash\u8fde\u63a5\u3002</li> <li>logstash\u6bd4\u8f83\u91cd\uff0c\u66f4\u52a0\u591a\u7684\u7528\u6765\u521b\u5efa\u6570\u636e\u7ba1\u9053\uff0c\u5177\u6709\u5f88\u5f3a\u7684\u6570\u636e\u4e8c\u6b21\u52a0\u5de5\u7684\u80fd\u529b\u3002</li> </ul>"},{"location":"chap1/1Es_intro/#3-8-x-pack","title":"3-8 X-Pack\uff1a\u5546\u4e1a\u5316\u5957\u4ef6","text":"<ul> <li>6.3 \u4e4b\u524d\u7684\u7248\u672cX-Pack\u4ee5\u63d2\u4ef6\u65b9\u5f0f\u5b89\u88c5 </li> <li>X-Pack\u5f00\u6e90\u4e4b\u540eElasticsearch&amp;Kibana\u652f\u6301oss\u7248\u548cBasic\u4e24\u79cd\u7248\u672c <ul> <li>\u90e8\u5206X-Pack\u529f\u80fd\u652f\u6301\u514d\u8d39\u4f7f\u7528\uff0c6.8\u548c 7.1\u5f00\u59cb\uff0cSecurity\u529f\u80fd\u514d\u8d39 </li> </ul> </li> <li>OSS\uff0c Basic\u9ec4\u91d1\u7ea7\u767d\u91d1\u7ea7 </li> </ul>"},{"location":"chap1/1Es_intro/#3-9-elk","title":"3-9 ELK\u5ba2\u6237\u53ca\u5e94\u7528\u573a\u666f","text":"<ul> <li>\u5e94\u7528\u573a\u666f <ul> <li>\u7f51\u7ad9\u641c\u7d22\uff0f\u5782\u76f4\u641c\u7d22\uff0f\u4ee3\u7801\u641c\u7d22 </li> </ul> </li> <li>\u65e5\u5fd7\u7ba1\u7406\u4e0e\u5206\u6790\uff0f\u5b89\u5168\u6307\u6807\u76d1\u63a7 \uff0f\u5e94\u7528\u6027\u80fd\u76d1\u63a7\uff0fWEB\u6293\u53d6\u8206\u60c5\u5206\u6790</li> </ul> <p>https://www.elastic.co/customers/</p> <p>\u65e5\u5fd7\u7684\u91cd\u8981\u6027</p> <ul> <li>\u4e3a\u4ec0\u4e48\u91cd\u8981 <ul> <li>\u8fd0\u7ef4\uff1a\u533b\u751f\u7ed9\u75c5\u4eba\u770b\u75c5\u3002\u65e5\u5fd7\u5c31\u662f\u75c5\u4eba\u5bf9\u81ea\u5df1\u7684\u9648\u8ff0 </li> <li>\u6076\u610f\u653b\u51fb\u6076\u610f\u6ce8\u518c\u5237\u5355\u6076\u610f\u5bc6\u7801\u731cII </li> </ul> </li> <li>\u6311\u6218<ul> <li>\u5173\u6ce8\u70b9\u5f88\u591a\u4efb\u4f3a\u4e00\u4e2a\u70b9\u90fd\u6709\u53ef\u80fd\u5f15\u8d77\u95ee\u9898 </li> <li>\u65e5\u5fd7\u5206\u6563\u5728\u5f88\u591a\u673a\u5668\u51fa\u4e86\u95ee\u9898\u65f6\u624d\u53d1\u73b0\u65e5\u5fd7\u88ab\u5220\u4e86 </li> <li>\u5f88\u591a\u8fd0\u7ef4\u4eba\u5458\u662f\u6d88\u9632\u5458\u54ea\u91cc\u6709\u95ee\u9898\u53bb\u54ea\u91cc </li> </ul> </li> </ul> <p>\u65e5\u5fd7\u7ba1\u7406</p> <p></p>"},{"location":"chap1/1Es_intro/#3-10-elastichsearch","title":"3-10 Elastichsearch\u4e0e\u6570\u636e\u5e93\u7684\u96c6\u6210","text":"<ul> <li>\u5355\u72ec\u4f7f\u7528Elasticsearch\u5b58\u50a8 </li> <li>\u4ee5\u4e0b\u60c5\u51b5\u53ef\u8003\u8651\u4e0e\u6570\u636e\u5e93\u96c6\u6210 <ul> <li>\u4e0e\u73b0\u6709\u7cfb\u7edf\u7684\u96c6\u6210 </li> <li>\u9700\u8003\u8651\u4e8b\u52a1\u6027 </li> <li>\u6570\u636e\u66f4\u65b0\u9891\u7e41 </li> </ul> </li> </ul>"},{"location":"chap1/1Es_intro/#3-11","title":"3-11 \u6307\u6807\u5206\u6790/\u65e5\u5fd7\u5206\u6790","text":""},{"location":"chap1/1Es_intro/#3-12-arcsight","title":"3-12 \u5b89\u5168\u5206\u6790\uff1a\u96c6\u6210ArcSight","text":""},{"location":"chap1/1Es_intro/#3-13","title":"3-13 \u672c\u8282\u56de\u987e","text":"<ul> <li>Elastic Stack\u56f4\u7ed5\u7740 ELKB\u6784\u5efa\u51fa\u4e00\u5957\u751f\u6001\u7cfb\u7edf\u9002\u5408\u5927\u91cf\u7684\u5e94\u7528\u573a\u666f <ul> <li>Elastic\u516c\u53f8\u901a\u8fc7\u5e76\u8d2d\u5411\u7528\u6237\u63d0\u4f9bML,APM\u7f51\u7ad9\u641c\u7d22\u7b49\u670d\u52a1 </li> <li>Elasticsesrch\u4ece6.3\u5f00\u59cb\u5f00\u6e90\u4e86\u6240\u6709\u7684\u4ee3\u7801\u5305\u62ecX-Pack </li> </ul> </li> <li>X-Pack\u7684\u4e09\u79cd\u8ba2\u9605\u6a21\u5f0f\u6a21\u5f0f\uff08\u57fa\u7840\u7248\u514d\u8d39\uff09 </li> <li>\u5177\u4f53\u7684\u67b6\u6784\u9700\u8981\u7ed3\u5408\u4e1a\u52a1\u573a\u666f\u548c\u9700\u6c42\u5177\u4f53\u60c5\u51b5\u5177\u4f53\u5206\u6790 <ul> <li>\u641c\u7d22\u7c7b\u96c6\u6210\u6570\u636e\u5e93\u540c\u6b65\u6570\u636e\uff0f\u72ec\u7acb\u4f5c\u4e3a\u6570\u636e\u5b58\u50a8\u4f7f\u7528\uff08\u4e0d\u63a8\u8350\uff09 </li> <li>\u65e5\u5fd7\u578b- Logstash\u548cBeats\u6ee1\u8db3\u4e0d\u540c\u7684\u6570\u636e\u6e90\uff0cKafka\u4f5c\u4e3a\u6d88\u606f\u961f\u5217 </li> </ul> </li> </ul>"},{"location":"chap10/16EFK_log_adv/","title":"\u7b2c\u4e09\u8282 \u5728 Kubernetes \u5b89\u88c5 EFK \u65e5\u5fd7\u6536\u96c6\u7cfb\u7edf[\u66f4\u65b0]","text":"<p>Install and practice code reference</p>"},{"location":"chap10/16EFK_log_adv/#1-elasticsearch","title":"1\u3001\u521b\u5efa Elasticsearch \u96c6\u7fa4","text":"<p><code>elasticsearch-storageclass.yaml</code></p> <pre><code>apiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\n  name: es-data-db\nprovisioner: docker.io/hostpath\n</code></pre> <pre><code>$ kubectl apply -f elasticsearch-storageclass.yaml \nstorageclass.storage.k8s.io/es-data-db created\n\n$ kubectl get sc\nNAME                 PROVISIONER          AGE\nes-data-db           docker.io/hostpath   4s\nhostpath (default)   docker.io/hostpath   49d\n</code></pre> <pre><code>kubectl label node docker-desktop es=log \n</code></pre> <p><code>elasticsearch-statefulset.yaml</code></p> <pre><code>apiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: es\n  namespace: logging\nspec:\n  serviceName: elasticsearch\n  replicas: 1\n  selector:\n    matchLabels:\n      app: elasticsearch\n  template:\n    metadata:\n      labels: \n        app: elasticsearch\n    spec:\n      nodeSelector:\n        es: log    # apply first \n      initContainers:\n      - name: increase-vm-max-map\n        image: busybox\n        command: [\"sysctl\", \"-w\", \"vm.max_map_count=262144\"]\n        securityContext:\n          privileged: true\n      - name: increase-fd-ulimit\n        image: busybox\n        command: [\"sh\", \"-c\", \"ulimit -n 65536\"]\n        securityContext:\n          privileged: true\n      containers:\n      - name: elasticsearch\n        image: docker.elastic.co/elasticsearch/elasticsearch:7.6.2\n        ports:\n        - name: rest\n          containerPort: 9200\n        - name: inter\n          containerPort: 9300\n        resources:\n          limits:\n            cpu: 1000m\n          requests:\n            cpu: 1000m\n        volumeMounts:\n        - name: data\n          mountPath: /usr/share/elasticsearch/data\n        env:\n        - name: cluster.name\n          value: k8s-logs\n        - name: node.name\n          valueFrom:\n            fieldRef:\n              fieldPath: metadata.name\n        - name: cluster.initial_master_nodes\n          value: \"es-0,es-1,es-2\"  # changed on my cluster\n        - name: discovery.zen.minimum_master_nodes\n          value: \"2\"               # changed on my cluster\n        - name: discovery.seed_hosts\n          value: \"elasticsearch\"\n        - name: ES_JAVA_OPTS\n          value: \"-Xms512m -Xmx512m\"\n        - name: network.host\n          value: \"0.0.0.0\"\n  volumeClaimTemplates:\n  - metadata:\n      name: data\n      labels:\n        app: elasticsearch\n    spec:\n      accessModes: [ \"ReadWriteOnce\" ]\n      storageClassName: es-data-db \n      resources:\n        requests:\n          storage: 2Gi\n</code></pre> <pre><code>$ kubectl get pod -n logging \nNAME   READY   STATUS    RESTARTS   AGE\nes-0   1/1     Running   0          27m\n</code></pre>"},{"location":"chap10/16EFK_log_adv/#2-kibana","title":"2\u3001\u521b\u5efa Kibana \u670d\u52a1","text":"<pre><code>$ kubectl create -f kibana.yaml\nservice/kibana created\ndeployment.apps/kibana created\n\n$ kubectl get pod -n logging \nNAME                      READY   STATUS    RESTARTS   AGE\nes-0                      1/1     Running   0          28m\nkibana-5c565c47dd-wfgrx   1/1     Running   0          10s\n\n$ kubectl get svc -n logging \nNAME            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE\nelasticsearch   ClusterIP   None             &lt;none&gt;        9200/TCP,9300/TCP   3s\nkibana          NodePort    10.102.159.162   &lt;none&gt;        5601:31385/TCP      2m55s\n</code></pre>"},{"location":"chap10/16EFK_log_adv/#3-fluentd-updated-config","title":"3\u3001\u90e8\u7f72 Fluentd (Updated Config)","text":""},{"location":"chap10/16EFK_log_adv/#3-1","title":"3-1 \u914d\u7f6e","text":"<p>\u4e00\u822c\u6765\u8bf4\u6211\u4eec\u662f\u901a\u8fc7\u4e00\u4e2a\u914d\u7f6e\u6587\u4ef6\u6765\u544a\u8bc9 Fluentd \u5982\u4f55\u91c7\u96c6\u3001\u5904\u7406\u6570\u636e\u7684\uff0c\u4e0b\u9762\u7b80\u5355\u548c\u5927\u5bb6\u4ecb\u7ecd\u4e0b Fluentd \u7684\u914d\u7f6e\u65b9\u6cd5\u3002</p> <p>\u65e5\u5fd7\u6e90\u914d\u7f6e</p> <p>\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u4e3a\u4e86\u6536\u96c6 <code>Kubernetes</code> \u8282\u70b9\u4e0a\u7684\u6240\u6709\u5bb9\u5668\u65e5\u5fd7\uff0c\u5c31\u9700\u8981\u505a\u5982\u4e0b\u7684\u65e5\u5fd7\u6e90\u914d\u7f6e\uff1a</p> <pre><code>&lt;source&gt;\n  @id fluentd-containers.log\n  @type tail                             # Fluentd \u5185\u7f6e\u7684\u8f93\u5165\u65b9\u5f0f\uff0c\u5176\u539f\u7406\u662f\u4e0d\u505c\u5730\u4ece\u6e90\u6587\u4ef6\u4e2d\u83b7\u53d6\u65b0\u7684\u65e5\u5fd7\u3002\n  path /var/log/containers/*.log         # \u6302\u8f7d\u7684\u670d\u52a1\u5668Docker\u5bb9\u5668\u65e5\u5fd7\u5730\u5740\n  pos_file /var/log/es-containers.log.pos\n  tag raw.kubernetes.*                   # \u8bbe\u7f6e\u65e5\u5fd7\u6807\u7b7e\n  read_from_head true\n  &lt;parse&gt;                                # \u591a\u884c\u683c\u5f0f\u5316\u6210JSON\n    @type multi_format                   # \u4f7f\u7528 multi-format-parser \u89e3\u6790\u5668\u63d2\u4ef6\n    &lt;pattern&gt;\n      format json                        # JSON \u89e3\u6790\u5668\n      time_key time                      # \u6307\u5b9a\u4e8b\u4ef6\u65f6\u95f4\u7684\u65f6\u95f4\u5b57\u6bb5\n      time_format %Y-%m-%dT%H:%M:%S.%NZ  # \u65f6\u95f4\u683c\u5f0f\n    &lt;/pattern&gt;\n    &lt;pattern&gt;\n      format /^(?&lt;time&gt;.+) (?&lt;stream&gt;stdout|stderr) [^ ]* (?&lt;log&gt;.*)$/\n      time_format %Y-%m-%dT%H:%M:%S.%N%:z\n    &lt;/pattern&gt;\n  &lt;/parse&gt;\n&lt;/source&gt;\n</code></pre> <p>\u4e0a\u9762\u914d\u7f6e\u90e8\u5206\u53c2\u6570\u8bf4\u660e\u5982\u4e0b\uff1a</p> <ul> <li><code>id</code>\uff1a\u8868\u793a\u5f15\u7528\u8be5\u65e5\u5fd7\u6e90\u7684\u552f\u4e00\u6807\u8bc6\u7b26\uff0c\u8be5\u6807\u8bc6\u53ef\u7528\u4e8e\u8fdb\u4e00\u6b65\u8fc7\u6ee4\u548c\u8def\u7531\u7ed3\u6784\u5316\u65e5\u5fd7\u6570\u636e</li> <li><code>type</code>\uff1a<code>Fluentd</code>\u5185\u7f6e\u7684\u6307\u4ee4\uff0c<code>tail</code> \u8868\u793a <code>Fluentd</code> \u4ece\u4e0a\u6b21\u8bfb\u53d6\u7684\u4f4d\u7f6e\u901a\u8fc7 <code>tail</code>\u4e0d\u65ad\u83b7\u53d6\u6570\u636e\uff0c\u53e6\u5916\u4e00\u4e2a\u662f <code>http</code> \u8868\u793a\u901a\u8fc7\u4e00\u4e2a <code>GET</code> \u8bf7\u6c42\u6765\u6536\u96c6\u6570\u636e\u3002</li> <li><code>path</code>\uff1a<code>tail</code>\u7c7b\u578b\u4e0b\u7684\u7279\u5b9a\u53c2\u6570\uff0c\u544a\u8bc9<code>Fluentd</code>\u91c7\u96c6 <code>/var/log/containers</code> \u76ee\u5f55\u4e0b\u7684\u6240\u6709\u65e5\u5fd7\uff0c\u8fd9\u662f <code>docker</code> \u5728 <code>Kubernetes</code> \u8282\u70b9\u4e0a\u7528\u6765\u5b58\u50a8\u8fd0\u884c\u5bb9\u5668 <code>stdout</code> \u8f93\u51fa\u65e5\u5fd7\u6570\u636e\u7684\u76ee\u5f55\u3002</li> <li><code>pos_file</code>\uff1a\u68c0\u67e5\u70b9\uff0c\u5982\u679c <code>Fluentd</code> \u7a0b\u5e8f\u91cd\u65b0\u542f\u52a8\u4e86\uff0c\u5b83\u5c06\u4f7f\u7528\u6b64\u6587\u4ef6\u4e2d\u7684\u4f4d\u7f6e\u6765\u6062\u590d\u65e5\u5fd7\u6570\u636e\u6536\u96c6\u3002</li> <li><code>tag</code>\uff1a\u7528\u6765\u5c06\u65e5\u5fd7\u6e90\u4e0e\u76ee\u6807\u6216\u8005\u8fc7\u6ee4\u5668\u5339\u914d\u7684\u81ea\u5b9a\u4e49\u5b57\u7b26\u4e32\uff0c<code>Fluentd</code> \u5339\u914d\u6e90/\u76ee\u6807\u6807\u7b7e\u6765\u8def\u7531\u65e5\u5fd7\u6570\u636e\u3002</li> </ul> <p>\u8def\u7531\u914d\u7f6e</p> <p>\u4e0a\u9762\u662f\u65e5\u5fd7\u6e90\u7684\u914d\u7f6e\uff0c\u63a5\u4e0b\u6765\u770b\u770b\u5982\u4f55\u5c06\u65e5\u5fd7\u6570\u636e\u53d1\u9001\u5230 Elasticsearch\uff1a</p> <pre><code>&lt;match **&gt;\n\n@id elasticsearch\n\n@type elasticsearch\n\n@log_level info\n\ninclude_tag_key true\n\ntype_name fluentd\n\nhost \"#{ENV['OUTPUT_HOST']}\"\n\nport \"#{ENV['OUTPUT_PORT']}\"\n\nlogstash_format true\n\n&lt;buffer&gt;\n\n@type file\n\npath /var/log/fluentd-buffers/kubernetes.system.buffer\n\nflush_mode interval\n\nretry_type exponential_backoff\n\nflush_thread_count 2\n\nflush_interval 5s\n\nretry_forever\n\nretry_max_interval 30\n\nchunk_limit_size \"#{ENV['OUTPUT_BUFFER_CHUNK_LIMIT']}\"\n\nqueue_limit_length \"#{ENV['OUTPUT_BUFFER_QUEUE_LIMIT']}\"\n\noverflow_action block\n\n&lt;/buffer&gt;\n</code></pre> <ul> <li><code>match</code>\uff1a\u6807\u8bc6\u4e00\u4e2a\u76ee\u6807\u6807\u7b7e\uff0c\u540e\u9762\u662f\u4e00\u4e2a\u5339\u914d\u65e5\u5fd7\u6e90\u7684\u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u6211\u4eec\u8fd9\u91cc\u60f3\u8981\u6355\u83b7\u6240\u6709\u7684\u65e5\u5fd7\u5e76\u5c06\u5b83\u4eec\u53d1\u9001\u7ed9 <code>Elasticsearch</code>\uff0c\u6240\u4ee5\u9700\u8981\u914d\u7f6e\u6210<code>**</code>\u3002</li> <li><code>id</code>\uff1a\u76ee\u6807\u7684\u4e00\u4e2a\u552f\u4e00\u6807\u8bc6\u7b26\u3002</li> <li><code>type</code>\uff1a\u652f\u6301\u7684\u8f93\u51fa\u63d2\u4ef6\u6807\u8bc6\u7b26\uff0c\u6211\u4eec\u8fd9\u91cc\u8981\u8f93\u51fa\u5230 <code>Elasticsearch</code>\uff0c\u6240\u4ee5\u914d\u7f6e\u6210 <code>elasticsearch</code>\uff0c\u8fd9\u662f <code>Fluentd</code> \u7684\u4e00\u4e2a\u5185\u7f6e\u63d2\u4ef6\u3002</li> <li><code>log_level</code>\uff1a\u6307\u5b9a\u8981\u6355\u83b7\u7684\u65e5\u5fd7\u7ea7\u522b\uff0c\u6211\u4eec\u8fd9\u91cc\u914d\u7f6e\u6210 <code>info</code>\uff0c\u8868\u793a\u4efb\u4f55\u8be5\u7ea7\u522b\u6216\u8005\u8be5\u7ea7\u522b\u4ee5\u4e0a\uff08<code>INFO\u3001WARNING\u3001ERROR</code>\uff09\u7684\u65e5\u5fd7\u90fd\u5c06\u88ab\u8def\u7531\u5230 <code>Elsasticsearch</code>\u3002</li> <li><code>host/port</code>\uff1a\u5b9a\u4e49 <code>Elasticsearch</code> \u7684\u5730\u5740\uff0c\u4e5f\u53ef\u4ee5\u914d\u7f6e\u8ba4\u8bc1\u4fe1\u606f\uff0c\u6211\u4eec\u7684 <code>Elasticsearch</code> \u4e0d\u9700\u8981\u8ba4\u8bc1\uff0c\u6240\u4ee5\u8fd9\u91cc\u76f4\u63a5\u6307\u5b9a host \u548c port \u5373\u53ef\u3002</li> <li><code>logstash_format</code>\uff1a<code>Elasticsearch</code>\u670d\u52a1\u5bf9\u65e5\u5fd7\u6570\u636e\u6784\u5efa\u53cd\u5411\u7d22\u5f15\u8fdb\u884c\u641c\u7d22\uff0c\u5c06 <code>logstash_format</code> \u8bbe\u7f6e\u4e3a <code>true</code>\uff0c<code>Fluentd</code> \u5c06\u4f1a\u4ee5 <code>logstash</code> \u683c\u5f0f\u6765\u8f6c\u53d1\u7ed3\u6784\u5316\u7684\u65e5\u5fd7\u6570\u636e\u3002</li> <li><code>Buffer</code>\uff1a <code>Fluentd</code> \u5141\u8bb8\u5728\u76ee\u6807\u4e0d\u53ef\u7528\u65f6\u8fdb\u884c\u7f13\u5b58\uff0c\u6bd4\u5982\uff0c\u5982\u679c\u7f51\u7edc\u51fa\u73b0\u6545\u969c\u6216\u8005 <code>Elasticsearch</code> \u4e0d\u53ef\u7528\u7684\u65f6\u5019\u3002\u7f13\u51b2\u533a\u914d\u7f6e\u4e5f\u6709\u52a9\u4e8e\u964d\u4f4e\u78c1\u76d8\u7684 <code>IO</code>\u3002</li> </ul> <p>\u8fc7\u6ee4</p> <p>\u7531\u4e8e <code>Kubernetes</code> \u96c6\u7fa4\u4e2d\u5e94\u7528\u592a\u591a\uff0c\u4e5f\u8fd8\u6709\u5f88\u591a\u5386\u53f2\u6570\u636e\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u53ea\u5c06\u67d0\u4e9b\u5e94\u7528\u7684\u65e5\u5fd7\u8fdb\u884c\u6536\u96c6\uff0c\u6bd4\u5982\u6211\u4eec\u53ea\u91c7\u96c6\u5177\u6709 <code>logging=true</code> \u8fd9\u4e2a<code>Label</code> \u6807\u7b7e\u7684 <code>Pod</code> \u65e5\u5fd7\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u9700\u8981\u4f7f\u7528 <code>filter</code>\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># \u5220\u9664\u65e0\u7528\u7684\u5c5e\u6027\n&lt;filter kubernetes.**&gt;\n  @type record_transformer\n  remove_keys $.docker.container_id,$.kubernetes.container_image_id,$.kubernetes.pod_id,$.kubernetes.namespace_id,$.kubernetes.master_url,$.kubernetes.labels.pod-template-hash\n&lt;/filter&gt;\n# \u53ea\u4fdd\u7559\u5177\u6709logging=true\u6807\u7b7e\u7684Pod\u65e5\u5fd7\n&lt;filter kubernetes.**&gt;\n  @id filter_log\n  @type grep\n  &lt;regexp&gt;\n    key $.kubernetes.labels.logging\n    pattern ^true$\n  &lt;/regexp&gt;\n&lt;/filter&gt;\n</code></pre>"},{"location":"chap10/16EFK_log_adv/#3-2","title":"3-2 \u5b89\u88c5","text":"<p>\u8981\u6536\u96c6 <code>Kubernetes</code> \u96c6\u7fa4\u7684\u65e5\u5fd7\uff0c\u76f4\u63a5\u7528 <code>DasemonSet</code> \u63a7\u5236\u5668\u6765\u90e8\u7f72 <code>Fluentd</code> \u5e94\u7528\uff0c\u8fd9\u6837\uff0c\u5b83\u5c31\u53ef\u4ee5\u4ece <code>Kubernetes</code> \u8282\u70b9\u4e0a\u91c7\u96c6\u65e5\u5fd7\uff0c\u786e\u4fdd\u5728\u96c6\u7fa4\u4e2d\u7684\u6bcf\u4e2a\u8282\u70b9\u4e0a\u59cb\u7ec8\u8fd0\u884c\u4e00\u4e2a Fluentd \u5bb9\u5668\u3002\u5f53\u7136\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 Helm \u6765\u8fdb\u884c\u4e00\u952e\u5b89\u88c5\uff0c\u4e3a\u4e86\u80fd\u591f\u4e86\u89e3\u66f4\u591a\u5b9e\u73b0\u7ec6\u8282\uff0c\u6211\u4eec\u8fd9\u91cc\u8fd8\u662f\u91c7\u7528\u624b\u52a8\u65b9\u6cd5\u6765\u8fdb\u884c\u5b89\u88c5\u3002</p> <p>\u9996\u5148\uff0c\u6211\u4eec\u901a\u8fc7 <code>ConfigMap</code> \u5bf9\u8c61\u6765\u6307\u5b9a <code>Fluentd</code> \u914d\u7f6e\u6587\u4ef6\uff0c\u65b0\u5efa <code>fluentd-configmap.yaml</code> \u6587\u4ef6\uff0c\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>kind: ConfigMap\napiVersion: v1\nmetadata:\n  name: fluentd-config\n  namespace: logging\ndata:\n  system.conf: |-\n    &lt;system&gt;\n      root_dir /tmp/fluentd-buffers/\n    &lt;/system&gt;\n  containers.input.conf: |-\n    &lt;source&gt;\n      @id fluentd-containers.log\n      @type tail                              # Fluentd \u5185\u7f6e\u7684\u8f93\u5165\u65b9\u5f0f\uff0c\u5176\u539f\u7406\u662f\u4e0d\u505c\u5730\u4ece\u6e90\u6587\u4ef6\u4e2d\u83b7\u53d6\u65b0\u7684\u65e5\u5fd7\u3002\n      path /var/log/containers/*.log          # \u6302\u8f7d\u7684\u670d\u52a1\u5668Docker\u5bb9\u5668\u65e5\u5fd7\u5730\u5740\n      pos_file /var/log/es-containers.log.pos\n      tag raw.kubernetes.*                    # \u8bbe\u7f6e\u65e5\u5fd7\u6807\u7b7e\n      read_from_head true\n      &lt;parse&gt;                                 # \u591a\u884c\u683c\u5f0f\u5316\u6210JSON\n        @type multi_format                    # \u4f7f\u7528 multi-format-parser \u89e3\u6790\u5668\u63d2\u4ef6\n        &lt;pattern&gt;\n          format json                         # JSON\u89e3\u6790\u5668\n          time_key time                       # \u6307\u5b9a\u4e8b\u4ef6\u65f6\u95f4\u7684\u65f6\u95f4\u5b57\u6bb5\n          time_format %Y-%m-%dT%H:%M:%S.%NZ   # \u65f6\u95f4\u683c\u5f0f\n        &lt;/pattern&gt;\n        &lt;pattern&gt;\n          format /^(?&lt;time&gt;.+) (?&lt;stream&gt;stdout|stderr) [^ ]* (?&lt;log&gt;.*)$/\n          time_format %Y-%m-%dT%H:%M:%S.%N%:z\n        &lt;/pattern&gt;\n      &lt;/parse&gt;\n    &lt;/source&gt;\n    # \u5728\u65e5\u5fd7\u8f93\u51fa\u4e2d\u68c0\u6d4b\u5f02\u5e38\uff0c\u5e76\u5c06\u5176\u4f5c\u4e3a\u4e00\u6761\u65e5\u5fd7\u8f6c\u53d1 \n    # https://github.com/GoogleCloudPlatform/fluent-plugin-detect-exceptions\n    &lt;match raw.kubernetes.**&gt;           # \u5339\u914dtag\u4e3araw.kubernetes.**\u65e5\u5fd7\u4fe1\u606f\n      @id raw.kubernetes\n      @type detect_exceptions           # \u4f7f\u7528detect-exceptions\u63d2\u4ef6\u5904\u7406\u5f02\u5e38\u6808\u4fe1\u606f\n      remove_tag_prefix raw             # \u79fb\u9664 raw \u524d\u7f00\n      message log                       \n      stream stream                     \n      multiline_flush_interval 5\n      max_bytes 500000\n      max_lines 1000\n    &lt;/match&gt;\n\n    &lt;filter **&gt;  # \u62fc\u63a5\u65e5\u5fd7\n      @id filter_concat\n      @type concat                # Fluentd Filter \u63d2\u4ef6\uff0c\u7528\u4e8e\u8fde\u63a5\u591a\u4e2a\u4e8b\u4ef6\u4e2d\u5206\u9694\u7684\u591a\u884c\u65e5\u5fd7\u3002\n      key message\n      multiline_end_regexp /\\n$/  # \u4ee5\u6362\u884c\u7b26\u201c\\n\u201d\u62fc\u63a5\n      separator \"\"\n    &lt;/filter&gt; \n\n    # \u6dfb\u52a0 Kubernetes metadata \u6570\u636e\n    &lt;filter kubernetes.**&gt;\n      @id filter_kubernetes_metadata\n      @type kubernetes_metadata\n    &lt;/filter&gt;\n\n    # \u4fee\u590d ES \u4e2d\u7684 JSON \u5b57\u6bb5\n    # \u63d2\u4ef6\u5730\u5740\uff1ahttps://github.com/repeatedly/fluent-plugin-multi-format-parser\n    &lt;filter kubernetes.**&gt;\n      @id filter_parser\n      @type parser                # multi-format-parser\u591a\u683c\u5f0f\u89e3\u6790\u5668\u63d2\u4ef6\n      key_name log                # \u5728\u8981\u89e3\u6790\u7684\u8bb0\u5f55\u4e2d\u6307\u5b9a\u5b57\u6bb5\u540d\u79f0\u3002\n      reserve_data true           # \u5728\u89e3\u6790\u7ed3\u679c\u4e2d\u4fdd\u7559\u539f\u59cb\u952e\u503c\u5bf9\u3002\n      remove_key_name_field true  # key_name \u89e3\u6790\u6210\u529f\u540e\u5220\u9664\u5b57\u6bb5\u3002\n      &lt;parse&gt;\n        @type multi_format\n        &lt;pattern&gt;\n          format json\n        &lt;/pattern&gt;\n        &lt;pattern&gt;\n          format none\n        &lt;/pattern&gt;\n      &lt;/parse&gt;\n    &lt;/filter&gt;\n\n    # \u5220\u9664\u4e00\u4e9b\u591a\u4f59\u7684\u5c5e\u6027\n    &lt;filter kubernetes.**&gt;\n      @type record_transformer\n      remove_keys $.docker.container_id,$.kubernetes.container_image_id,$.kubernetes.pod_id,$.kubernetes.namespace_id,$.kubernetes.master_url,$.kubernetes.labels.pod-template-hash\n    &lt;/filter&gt;\n\n    # \u53ea\u4fdd\u7559\u5177\u6709logging=true\u6807\u7b7e\u7684Pod\u65e5\u5fd7\n    &lt;filter kubernetes.**&gt;\n      @id filter_log\n      @type grep\n      &lt;regexp&gt;\n        key $.kubernetes.labels.logging\n        pattern ^true$\n      &lt;/regexp&gt;\n    &lt;/filter&gt;\n\n  ###### \u76d1\u542c\u914d\u7f6e\uff0c\u4e00\u822c\u7528\u4e8e\u65e5\u5fd7\u805a\u5408\u7528 ######\n  forward.input.conf: |-\n    # \u76d1\u542c\u901a\u8fc7TCP\u53d1\u9001\u7684\u6d88\u606f\n    &lt;source&gt;\n      @id forward\n      @type forward\n    &lt;/source&gt;\n\n  output.conf: |-\n    &lt;match **&gt;\n      @id elasticsearch\n      @type elasticsearch\n      @log_level info\n      include_tag_key true\n      host elasticsearch\n      port 9200\n      logstash_format true\n      logstash_prefix k8s  # \u8bbe\u7f6e index \u524d\u7f00\u4e3a k8s\n      request_timeout    30s\n      &lt;buffer&gt;\n        @type file\n        path /var/log/fluentd-buffers/kubernetes.system.buffer\n        flush_mode interval\n        retry_type exponential_backoff\n        flush_thread_count 2\n        flush_interval 5s\n        retry_forever\n        retry_max_interval 30\n        chunk_limit_size 2M\n        queue_limit_length 8\n        overflow_action block\n      &lt;/buffer&gt;\n    &lt;/match&gt;\n</code></pre> <p>\u4e0a\u9762\u914d\u7f6e\u6587\u4ef6\u4e2d\u6211\u4eec\u53ea\u914d\u7f6e\u4e86 <code>docker`` \u5bb9\u5668\u65e5\u5fd7\u76ee\u5f55\uff0c\u6536\u96c6\u5230\u6570\u636e\u7ecf\u8fc7\u5904\u7406\u540e\u53d1\u9001\u5230 elasticsearch:9200</code> \u670d\u52a1\u3002</p> <p>\u7136\u540e\u65b0\u5efa\u4e00\u4e2a <code>fluentd-daemonset.yaml</code> \u7684\u6587\u4ef6\uff0c\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>$ docker info | grep Root\n Docker Root Dir: /var/lib/docker\n</code></pre> <pre><code>kubectl label node docker-desktop beta.kubernetes.io/fluentd-ds-ready=true\nnode/docker-desktop labeled\n</code></pre> <p>\u8fd9\u4e2a\u5730\u65b9\u975e\u5e38\u91cd\u8981\uff0c\u5f53\u7136\u5982\u679c\u4f60\u6ca1\u6709\u66f4\u6539 <code>docker</code> \u6839\u76ee\u5f55\u5219\u4f7f\u7528\u9ed8\u8ba4\u7684<code>/var/lib/docker/containers</code>\u76ee\u5f55\u5373\u53ef\u3002</p> <pre><code>apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: fluentd-es\n  namespace: logging\n  labels:\n    k8s-app: fluentd-es\n    kubernetes.io/cluster-service: \"true\"\n    addonmanager.kubernetes.io/mode: Reconcile\n---\nkind: ClusterRole\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: fluentd-es\n  labels:\n    k8s-app: fluentd-es\n    kubernetes.io/cluster-service: \"true\"\n    addonmanager.kubernetes.io/mode: Reconcile\nrules:\n- apiGroups:\n  - \"\"\n  resources:\n  - \"namespaces\"\n  - \"pods\"\n  verbs:\n  - \"get\"\n  - \"watch\"\n  - \"list\"\n---\nkind: ClusterRoleBinding\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: fluentd-es\n  labels:\n    k8s-app: fluentd-es\n    kubernetes.io/cluster-service: \"true\"\n    addonmanager.kubernetes.io/mode: Reconcile\nsubjects:\n- kind: ServiceAccount\n  name: fluentd-es\n  namespace: logging\n  apiGroup: \"\"\nroleRef:\n  kind: ClusterRole\n  name: fluentd-es\n  apiGroup: \"\"\n---\napiVersion: apps/v1\nkind: DaemonSet\nmetadata:\n  name: fluentd-es\n  namespace: logging\n  labels:\n    k8s-app: fluentd-es\n    kubernetes.io/cluster-service: \"true\"\n    addonmanager.kubernetes.io/mode: Reconcile\nspec:\n  selector:\n    matchLabels:\n      k8s-app: fluentd-es\n  template:\n    metadata:\n      labels:\n        k8s-app: fluentd-es\n        kubernetes.io/cluster-service: \"true\"\n      # \u6b64\u6ce8\u91ca\u786e\u4fdd\u5982\u679c\u8282\u70b9\u88ab\u9a71\u9010\uff0cfluentd\u4e0d\u4f1a\u88ab\u9a71\u9010\uff0c\u652f\u6301\u5173\u952e\u7684\u57fa\u4e8e pod \u6ce8\u91ca\u7684\u4f18\u5148\u7ea7\u65b9\u6848\u3002\n      annotations:\n        scheduler.alpha.kubernetes.io/critical-pod: ''\n    spec:\n      serviceAccountName: fluentd-es\n      containers:\n      - name: fluentd-es\n        image: quay.io/fluentd_elasticsearch/fluentd:v3.0.1\n        env:\n        - name: FLUENTD_ARGS\n          value: --no-supervisor -q\n        resources:\n          limits:\n            memory: 500Mi\n          requests:\n            cpu: 100m\n            memory: 200Mi\n        volumeMounts:\n        - name: varlog\n          mountPath: /var/log\n        - name: varlibdockercontainers\n          mountPath: /var/lib/docker/containers\n          readOnly: true\n        - name: config-volume\n          mountPath: /etc/fluent/config.d\n      nodeSelector:\n        beta.kubernetes.io/fluentd-ds-ready: \"true\"\n      tolerations:\n      - operator: Exists\n      terminationGracePeriodSeconds: 30\n      volumes:\n      - name: varlog\n        hostPath:\n          path: /var/log\n      - name: varlibdockercontainers\n        hostPath:\n          path: /var/lib/docker/containers\n      - name: config-volume\n        configMap:\n          name: fluentd-config\n</code></pre> <p>\u6211\u4eec\u5c06\u4e0a\u9762\u521b\u5efa\u7684 <code>fluentd-config</code> \u8fd9\u4e2a<code>ConfigMap</code> \u5bf9\u8c61\u901a\u8fc7 <code>volumes</code> \u6302\u8f7d\u5230\u4e86 <code>Fluentd</code> \u5bb9\u5668\u4e2d\uff0c\u53e6\u5916\u4e3a\u4e86\u80fd\u591f\u7075\u6d3b\u63a7\u5236\u54ea\u4e9b\u8282\u70b9\u7684\u65e5\u5fd7\u53ef\u4ee5\u88ab\u6536\u96c6\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u8fd8\u6dfb\u52a0\u4e86\u4e00\u4e2a <code>nodSelector</code> \u5c5e\u6027\uff1a</p> <pre><code>nodeSelector:\n  beta.kubernetes.io/fluentd-ds-ready: \"true\"\n</code></pre> <p>\u610f\u601d\u5c31\u662f\u8981\u60f3\u91c7\u96c6\u8282\u70b9\u7684\u65e5\u5fd7\uff0c\u90a3\u4e48\u6211\u4eec\u5c31\u9700\u8981\u7ed9\u8282\u70b9\u6253\u4e0a\u4e0a\u9762\u7684\u6807\u7b7e</p> <p>\u5206\u522b\u521b\u5efa\u4e0a\u9762\u7684 ConfigMap \u5bf9\u8c61\u548c DaemonSet\uff1a</p> <pre><code>$ kubectl apply -f fluentd-configmap.yaml \nconfigmap/fluentd-config created\n\n$ kubectl create -f fluentd-daemonset.yaml\nserviceaccount/fluentd-es created\nclusterrole.rbac.authorization.k8s.io/fluentd-es created\nclusterrolebinding.rbac.authorization.k8s.io/fluentd-es created\ndaemonset.apps/fluentd-es created\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u67e5\u770b\u5bf9\u5e94\u7684 Pods \u5217\u8868\uff0c\u68c0\u67e5\u662f\u5426\u90e8\u7f72\u6210\u529f\uff1a</p> <pre><code>$ kubectl get pods -n logging\nNAME                      READY   STATUS    RESTARTS   AGE\nes-0                      1/1     Running   0          59m\nfluentd-es-7cl8n          1/1     Running   0          5m6s\nkibana-5c565c47dd-wfgrx   1/1     Running   0          30m\n</code></pre> <p>Fluentd \u542f\u52a8\u6210\u529f\u540e\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u53ef\u4ee5\u53d1\u9001\u65e5\u5fd7\u5230 ES \u4e86\uff0c\u4f46\u662f\u6211\u4eec\u8fd9\u91cc\u662f\u8fc7\u6ee4\u4e86\u53ea\u91c7\u96c6\u5177\u6709 <code>logging=true</code> \u6807\u7b7e\u7684 Pod \u65e5\u5fd7\uff0c\u6240\u4ee5\u73b0\u5728\u8fd8\u6ca1\u6709\u4efb\u4f55\u6570\u636e\u4f1a\u88ab\u91c7\u96c6\u3002</p> <p>\u4e0b\u9762\u6211\u4eec\u90e8\u7f72\u4e00\u4e2a\u7b80\u5355\u7684\u6d4b\u8bd5\u5e94\u7528\uff0c \u65b0\u5efa counter.yaml \u6587\u4ef6\uff0c\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: counter\n  labels:\n    logging: \"true\"  # \u4e00\u5b9a\u8981\u5177\u6709\u8be5\u6807\u7b7e\u624d\u4f1a\u88ab\u91c7\u96c6\nspec:\n  containers:\n  - name: count\n    image: busybox\n    args: [/bin/sh, -c,\n            'i=0; while true; do echo \"$i: $(date)\"; i=$((i+1)); sleep 1; done']\n</code></pre> <p>\u8be5 Pod \u53ea\u662f\u7b80\u5355\u5c06\u65e5\u5fd7\u4fe1\u606f\u6253\u5370\u5230 <code>stdout</code>\uff0c\u6240\u4ee5\u6b63\u5e38\u6765\u8bf4 <code>Fluentd</code> \u4f1a\u6536\u96c6\u5230\u8fd9\u4e2a\u65e5\u5fd7\u6570\u636e\uff0c\u5728 Kibana \u4e2d\u4e5f\u5c31\u53ef\u4ee5\u627e\u5230\u5bf9\u5e94\u7684\u65e5\u5fd7\u6570\u636e\u4e86\uff0c\u4f7f\u7528 <code>kubectl</code> \u5de5\u5177\u521b\u5efa\u8be5<code>Pod</code>\uff1a</p> <pre><code>$ kubectl get pods | grep counter\ncounter                                     1/1     Running   0          24s\n</code></pre> <p>Pod \u521b\u5efa\u5e76\u8fd0\u884c\u540e\uff0c\u56de\u5230 <code>Kibana Dashboard</code> \u9875\u9762\uff0c\u70b9\u51fb\u5de6\u4fa7\u6700\u4e0b\u9762\u7684 <code>management</code> \u56fe\u6807\uff0c\u7136\u540e\u70b9\u51fb <code>Kibana</code> \u4e0b\u9762\u7684 <code>Index Patterns</code>\u5f00\u59cb\u5bfc\u5165\u7d22\u5f15\u6570\u636e\uff1a</p> <p></p> <p>\u5728\u8fd9\u91cc\u53ef\u4ee5\u914d\u7f6e\u6211\u4eec\u9700\u8981\u7684 <code>Elasticsearch</code> \u7d22\u5f15\uff0c\u524d\u9762 <code>Fluentd</code> \u914d\u7f6e\u6587\u4ef6\u4e2d\u6211\u4eec\u91c7\u96c6\u7684\u65e5\u5fd7\u4f7f\u7528\u7684\u662f <code>logstash</code> \u683c\u5f0f\uff0c\u5b9a\u4e49\u4e86\u4e00\u4e2a <code>k8s</code> \u7684\u524d\u7f00\uff0c\u6240\u4ee5\u8fd9\u91cc\u53ea\u9700\u8981\u5728\u6587\u672c\u6846\u4e2d\u8f93\u5165<code>k8s-*</code>\u5373\u53ef\u5339\u914d\u5230 <code>Elasticsearch</code> \u96c6\u7fa4\u4e2d\u91c7\u96c6\u7684 <code>Kubernetes</code> \u96c6\u7fa4\u65e5\u5fd7\u6570\u636e\uff0c\u7136\u540e\u70b9\u51fb\u4e0b\u4e00\u6b65\uff0c\u8fdb\u5165\u4ee5\u4e0b\u9875\u9762\uff1a</p> <p></p> <p>\u5728\u8be5\u9875\u9762\u4e2d\u914d\u7f6e\u4f7f\u7528\u54ea\u4e2a\u5b57\u6bb5\u6309\u65f6\u95f4\u8fc7\u6ee4\u65e5\u5fd7\u6570\u636e\uff0c\u5728\u4e0b\u62c9\u5217\u8868\u4e2d\uff0c\u9009\u62e9<code>@timestamp</code>\u5b57\u6bb5\uff0c\u7136\u540e\u70b9\u51fb<code>Create index pattern</code>\uff0c\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u70b9\u51fb\u5de6\u4fa7\u5bfc\u822a\u83dc\u5355\u4e2d\u7684<code>Discover</code>\uff0c\u7136\u540e\u5c31\u53ef\u4ee5\u770b\u5230\u4e00\u4e9b\u76f4\u65b9\u56fe\u548c\u6700\u8fd1\u91c7\u96c6\u5230\u7684\u65e5\u5fd7\u6570\u636e\u4e86\uff1a</p> <p></p> <p>\u73b0\u5728\u7684\u6570\u636e\u5c31\u662f\u4e0a\u9762 <code>Counter</code> \u5e94\u7528\u7684\u65e5\u5fd7\uff0c\u5982\u679c\u8fd8\u6709\u5176\u4ed6\u7684\u5e94\u7528\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u7b5b\u9009\u8fc7\u6ee4\uff1a</p> <p></p> <p>\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7\u5176\u4ed6\u5143\u6570\u636e\u6765\u8fc7\u6ee4\u65e5\u5fd7\u6570\u636e\uff0c\u6bd4\u5982\u60a8\u53ef\u4ee5\u5355\u51fb\u4efb\u4f55\u65e5\u5fd7\u6761\u76ee\u4ee5\u67e5\u770b\u5176\u4ed6\u5143\u6570\u636e\uff0c\u5982\u5bb9\u5668\u540d\u79f0\uff0cKubernetes \u8282\u70b9\uff0c\u547d\u540d\u7a7a\u95f4\u7b49\u3002</p>"},{"location":"chap10/17EFK_log_Ana/","title":"\u7b2c\u56db\u8282 kibana \u65e5\u5fd7\u5206\u6790","text":"<p>\u4e0a\u9762\u6211\u4eec\u5df2\u7ecf\u53ef\u4ee5\u5c06\u5e94\u7528\u65e5\u5fd7\u6536\u96c6\u8d77\u6765\u4e86\uff0c\u4e0b\u9762\u6211\u4eec\u6765\u4f7f\u7528\u4e00\u4e2a\u5e94\u7528\u6f14\u793a\u5982\u4f55\u5206\u6790\u91c7\u96c6\u7684\u65e5\u5fd7\u3002\u793a\u4f8b\u5e94\u7528\u4f1a\u8f93\u51fa\u5982\u4e0b\u6240\u793a\u7684 <code>JSON</code> \u683c\u5f0f\u7684\u65e5\u5fd7\u4fe1\u606f\uff1a</p> <pre><code>{\"LOGLEVEL\":\"WARNING\",\"serviceName\":\"msg-processor\",\"serviceEnvironment\":\"staging\",\"message\":\"WARNING client connection terminated unexpectedly.\"}\n{\"LOGLEVEL\":\"INFO\",\"serviceName\":\"msg-processor\",\"serviceEnvironment\":\"staging\",\"message\":\"\",\"eventsNumber\":5}\n{\"LOGLEVEL\":\"INFO\",\"serviceName\":\"msg-receiver-api\":\"msg-receiver-api\",\"serviceEnvironment\":\"staging\",\"volume\":14,\"message\":\"API received messages\"}\n{\"LOGLEVEL\":\"ERROR\",\"serviceName\":\"msg-receiver-api\",\"serviceEnvironment\":\"staging\",\"message\":\"ERROR Unable to upload files for processing\"}\n</code></pre> <p>\u56e0\u4e3a <code>JSON</code> \u683c\u5f0f\u7684\u65e5\u5fd7\u89e3\u6790\u975e\u5e38\u5bb9\u6613\uff0c\u5f53\u6211\u4eec\u5c06\u65e5\u5fd7\u7ed3\u6784\u5316\u4f20\u8f93\u5230 <code>ES</code> \u8fc7\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u7279\u5b9a\u7684\u5b57\u6bb5\u503c\u800c\u4e0d\u662f\u6587\u672c\u641c\u7d22\u65e5\u5fd7\u6570\u636e\uff0c\u5f53\u7136\u7eaf\u6587\u672c\u683c\u5f0f\u7684\u65e5\u5fd7\u6211\u4eec\u4e5f\u53ef\u4ee5\u8fdb\u884c\u7ed3\u6784\u5316\uff0c\u4f46\u662f\u8fd9\u6837\u6bcf\u4e2a\u5e94\u7528\u7684\u65e5\u5fd7\u683c\u5f0f\u4e0d\u7edf\u4e00\uff0c\u90fd\u9700\u8981\u5355\u72ec\u8fdb\u884c\u7ed3\u6784\u5316\uff0c\u975e\u5e38\u9ebb\u70e6\uff0c\u6240\u4ee5\u5efa\u8bae\u5c06\u65e5\u5fd7\u683c\u5f0f\u7edf\u4e00\u6210 <code>JSON</code> \u683c\u5f0f\u8f93\u51fa\u3002</p> <p>\u6211\u4eec\u8fd9\u91cc\u7684\u793a\u4f8b\u5e94\u7528\u4f1a\u5b9a\u671f\u8f93\u51fa\u4e0d\u540c\u7c7b\u578b\u7684\u65e5\u5fd7\u6d88\u606f\uff0c\u5305\u542b\u4e0d\u540c\u65e5\u5fd7\u7ea7\u522b\uff08<code>INFO/WARN/ERROR</code>\uff09\u7684\u65e5\u5fd7\uff0c\u4e00\u884c <code>JSON</code> \u65e5\u5fd7\u5c31\u662f\u6211\u4eec\u6536\u96c6\u7684\u4e00\u6761\u65e5\u5fd7\u6d88\u606f\uff0c\u8be5\u6d88\u606f\u901a\u8fc7 <code>fluentd</code> \u8fdb\u884c\u91c7\u96c6\u53d1\u9001\u5230 <code>Elasticsearch</code>\u3002\u8fd9\u91cc\u6211\u4eec\u4f1a\u4f7f\u7528\u5230 <code>fluentd</code> \u91cc\u9762\u7684\u81ea\u52a8 <code>JSON</code> \u89e3\u6790\u63d2\u4ef6\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c<code>fluentd</code> \u4f1a\u5c06\u6bcf\u4e2a\u65e5\u5fd7\u6587\u4ef6\u7684\u4e00\u884c\u4f5c\u4e3a\u540d\u4e3a <code>log</code> \u7684\u5b57\u6bb5\u8fdb\u884c\u53d1\u9001\uff0c\u5e76\u81ea\u52a8\u6dfb\u52a0\u5176\u4ed6\u5b57\u6bb5\uff0c\u6bd4\u5982 <code>tag</code> \u6807\u8bc6\u5bb9\u5668\uff0c<code>stream</code> \u6807\u8bc6 <code>stdout</code> \u6216\u8005 <code>stderr</code>\u3002</p> <p>\u7531\u4e8e\u5728 fluentd \u914d\u7f6e\u4e2d\u6211\u4eec\u6dfb\u52a0\u4e86\u5982\u4e0b\u6240\u793a\u7684\u8fc7\u6ee4\u5668\uff1a</p> <pre><code>&lt;filter kubernetes.**&gt;\n  @id filter_parser\n  @type parser                # multi-format-parser\u591a\u683c\u5f0f\u89e3\u6790\u5668\u63d2\u4ef6\n  key_name log                # \u5728\u8981\u89e3\u6790\u7684\u8bb0\u5f55\u4e2d\u6307\u5b9a\u5b57\u6bb5\u540d\u79f0\n  reserve_data true           # \u5728\u89e3\u6790\u7ed3\u679c\u4e2d\u4fdd\u7559\u539f\u59cb\u952e\u503c\u5bf9\n  remove_key_name_field true  # key_name \u89e3\u6790\u6210\u529f\u540e\u5220\u9664\u5b57\u6bb5\u3002\n  &lt;parse&gt;\n    @type multi_format\n    &lt;pattern&gt;\n      format json\n    &lt;/pattern&gt;\n    &lt;pattern&gt;\n      format none\n    &lt;/pattern&gt;\n  &lt;/parse&gt;\n&lt;/filter&gt;\n</code></pre> <p>\u8be5\u8fc7\u6ee4\u5668\u4f7f\u7528 <code>json</code> \u548c <code>none</code> \u4e24\u4e2a\u63d2\u4ef6\u5c06 <code>JSON</code> \u6570\u636e\u8fdb\u884c\u7ed3\u6784\u5316\uff0c\u8fd9\u6837\u5c31\u4f1a\u628a <code>JSON</code> \u65e5\u5fd7\u91cc\u9762\u7684\u5c5e\u6027\u89e3\u6790\u6210\u4e00\u4e2a\u4e00\u4e2a\u7684\u5b57\u6bb5\uff0c\u89e3\u6790\u751f\u6548\u8fc7\u540e\u8bb0\u5f97\u5237\u65b0 <code>Kibana</code> \u7684\u7d22\u5f15\u5b57\u6bb5\uff0c\u5426\u5219\u4f1a\u8bc6\u522b\u4e0d\u4e86\u8fd9\u4e9b\u5b57\u6bb5\uff0c\u901a\u8fc7 <code>\u7ba1\u7406</code> -&gt; <code>Index Pattern</code> \u70b9\u51fb\u5237\u65b0\u5b57\u6bb5\u5217\u8868\u5373\u53ef\u3002</p> <p>\u4e0b\u9762\u6211\u4eec\u5c06\u793a\u4f8b\u5e94\u7528\u90e8\u7f72\u5230 Kubernetes \u96c6\u7fa4\u4e2d\uff1a(<code>dummylogs.yaml</code>)</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: dummylogs\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: dummylogs\n  template:\n    metadata:\n      labels:\n        app: dummylogs\n        logging: \"true\"  # \u8981\u91c7\u96c6\u65e5\u5fd7\u9700\u8981\u52a0\u4e0a\u8be5\u6807\u7b7e\n    spec:\n      containers:\n      - name: dummy\n        image: cnych/dummylogs:latest\n        args:\n        - msg-processor\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: dummylogs2\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: dummylogs2\n  template:\n    metadata:\n      labels:\n        app: dummylogs2\n        logging: \"true\"  # \u8981\u91c7\u96c6\u65e5\u5fd7\u9700\u8981\u52a0\u4e0a\u8be5\u6807\u7b7e\n    spec:\n      containers:\n      - name: dummy\n        image: cnych/dummylogs:latest\n        args:\n        - msg-receiver-api\n</code></pre> <p>\u76f4\u63a5\u90e8\u7f72\u4e0a\u9762\u7684\u5e94\u7528\u5373\u53ef\uff1a</p> <pre><code>$ kubectl get pods -l logging=true\nNAME                         READY   STATUS    RESTARTS   AGE\ndummylogs-56987f84-fn24f     1/1     Running   0          2m10s\ndummylogs-56987f84-nnwfq     1/1     Running   0          2m10s\ndummylogs-56987f84-q44lf     1/1     Running   0          2m10s\ndummylogs2-97864cdcd-6rlwk   1/1     Running   0          2m10s\ndummylogs2-97864cdcd-rd4d5   1/1     Running   0          2m10s\ndummylogs2-97864cdcd-tbwfq   1/1     Running   0          2m10s\n</code></pre> <p>\u90e8\u7f72\u5b8c\u6210\u540e <code>dummylogs</code> \u548c <code>dummylogs2</code> \u4e24\u4e2a\u5e94\u7528\u5c31\u4f1a\u5f00\u59cb\u8f93\u51fa\u4e0d\u540c\u7ea7\u522b\u7684\u65e5\u5fd7\u4fe1\u606f\u4e86\uff0c\u8bb0\u5f97\u8981\u7ed9\u5e94\u7528\u6240\u5728\u7684\u8282\u70b9\u6253\u4e0a <code>beta.kubernetes.io/fluentd-ds-ready=true</code> \u7684\u6807\u7b7e\uff0c\u5426\u5219 <code>fluentd</code> \u4e0d\u4f1a\u5728\u5bf9\u5e94\u7684\u8282\u70b9\u4e0a\u8fd0\u884c\u4e5f\u5c31\u4e0d\u4f1a\u6536\u96c6\u65e5\u5fd7\u4e86\u3002\u6b63\u5e38\u60c5\u51b5\u4e0b\u65e5\u5fd7\u5c31\u5df2\u7ecf\u53ef\u4ee5\u88ab\u91c7\u96c6\u5230 <code>Elasticsearch</code> \u5f53\u4e2d\u4e86\uff0c\u6211\u4eec\u53ef\u4ee5\u524d\u5f80 <code>Kibana</code> \u7684 <code>Dashboard</code>\u9875\u9762\u67e5\u770b:</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u53ef\u7528\u7684\u5b57\u6bb5\u4e2d\u5df2\u7ecf\u5305\u542b\u6211\u4eec\u5e94\u7528\u4e2d\u7684\u4e00\u4e9b\u5b57\u6bb5\u4e86\u3002\u627e\u5230 <code>serviceName</code> \u5b57\u6bb5\u70b9\u51fb\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u5df2\u7ecf\u91c7\u96c6\u4e86\u54ea\u4e9b\u670d\u52a1\u7684\u6d88\u606f\uff1a</p> <p></p> <p>\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u6536\u5230\u4e86\u6765\u81ea <code>msg-processor</code> \u548c <code>msg-receiver-api</code> \u7684\u65e5\u5fd7\u4fe1\u606f\uff0c\u5728\u6700\u8fd115\u5206\u949f\u4e4b\u5185\uff0c<code>api</code> \u670d\u52a1\u4ea7\u751f\u7684\u65e5\u5fd7\u66f4\u591a\uff0c\u70b9\u51fb\u540e\u9762\u7684\u52a0\u53f7\u5c31\u53ef\u4ee5\u53ea\u8fc7\u6ee4\u8be5\u670d\u52a1\u7684\u65e5\u5fd7\u6570\u636e\uff1a</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5c55\u793a\u7684\u65e5\u5fd7\u6570\u636e\u7684\u5c5e\u6027\u6bd4\u8f83\u591a\uff0c\u6709\u65f6\u5019\u53ef\u80fd\u4e0d\u5229\u4e8e\u6211\u4eec\u67e5\u770b\u65e5\u5fd7\uff0c\u6b64\u65f6\u6211\u4eec\u53ef\u4ee5\u7b5b\u9009\u60f3\u8981\u5c55\u793a\u7684\u5b57\u6bb5:</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u9700\u6c42\u9009\u62e9\u8981\u663e\u793a\u7684\u5b57\u6bb5\uff0c\u73b0\u5728\u67e5\u770b\u6d88\u606f\u7684\u65f6\u5019\u5c31\u6839\u636e\u6e05\u695a\u4e86\uff1a</p> <p></p> <p>\u6bd4\u5982\u4e3a\u4e86\u80fd\u591f\u66f4\u52a0\u6e05\u6670\u7684\u5c55\u793a\u6211\u4eec\u91c7\u96c6\u7684\u65e5\u5fd7\u6570\u636e\uff0c\u8fd8\u53ef\u4ee5\u5c06 <code>eventsNumber</code> \u548c <code>serviceName</code> \u5b57\u6bb5\u9009\u4e2d\u6dfb\u52a0\uff1a</p> <p>\u7136\u540e\u540c\u6837\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u9700\u6c42\u6765\u7b5b\u9009\u9700\u8981\u67e5\u770b\u7684\u65e5\u5fd7\u6570\u636e\uff1a</p> <p></p> <p>\u7136\u540e\u540c\u6837\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u9700\u6c42\u6765\u7b5b\u9009\u9700\u8981\u67e5\u770b\u7684\u65e5\u5fd7\u6570\u636e\uff1a</p> <p></p> <p>\u5982\u679c\u4f60\u7684 <code>Elasticsearch</code> \u7684\u67e5\u8be2\u8bed\u53e5\u6bd4\u8f83\u719f\u6089\u7684\u8bdd\uff0c\u4f7f\u7528\u67e5\u8be2\u8bed\u53e5\u80fd\u5b9e\u73b0\u7684\u7b5b\u9009\u529f\u80fd\u66f4\u52a0\u5f3a\u5927\uff0c\u6bd4\u5982\u6211\u4eec\u8981\u67e5\u8be2 <code>mgs-processor</code> \u548c <code>msg-receiver-api</code> \u4e24\u4e2a\u670d\u52a1\u7684\u65e5\u5fd7\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u6240\u793a\u7684\u67e5\u8be2\u8bed\u53e5\uff1a</p> <pre><code>serviceName:msg-processor OR serviceName:msg-receiver-api\n</code></pre> <p></p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u521b\u5efa\u4e00\u4e2a\u56fe\u8868\u6765\u5c55\u793a\u5df2\u7ecf\u5904\u7406\u4e86\u591a\u5c11 <code>msg-processor</code> \u670d\u52a1\u7684\u65e5\u5fd7\u4fe1\u606f\u3002\u5728 <code>Kibana</code> \u4e2d\u5207\u6362\u5230 <code>Visualize</code> \u9875\u9762\uff0c\u70b9\u51fb <code>Create new visualization</code> \u6309\u94ae\u9009\u62e9 <code>Area</code>\uff0c\u9009\u62e9 <code>k8s-*</code>\u7684\u7d22\u5f15\uff0c\u9996\u5148\u914d\u7f6e <code>Y</code> \u8f74\u7684\u6570\u636e\uff0c\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528 <code>eventsNumber</code> \u5b57\u6bb5\u7684 <code>Sum</code> \u51fd\u6570\u8fdb\u884c\u805a\u5408\uff1a</p> <p><code>Custom label</code>:  processed events</p> <p></p> <p>Bucket</p> <p></p> <p>\u914d\u7f6e\u5b8c\u6210\u540e\u70b9\u51fb\u53f3\u4e0a\u89d2\u7684 Apply Changes \u6309\u94ae\u5219\u5c31\u4f1a\u5728\u53f3\u4fa7\u5c55\u793a\u51fa\u5bf9\u5e94\u7684\u56fe\u8868\u4fe1\u606f\uff1a</p> <p></p> <p>\u8fd9\u4e2a\u56fe\u8868\u5c55\u793a\u7684\u5c31\u662f\u6700\u8fd1<code>15</code>\u5206\u949f\u5185\u88ab\u5904\u7406\u7684\u4e8b\u4ef6\u603b\u6570\uff0c\u5f53\u7136\u6211\u4eec\u4e5f\u53ef\u4ee5\u81ea\u5df1\u9009\u62e9\u65f6\u95f4\u8303\u56f4\u3002\u6211\u4eec\u8fd8\u53ef\u4ee5\u5c06 <code>msg-receiver-api</code> \u4e8b\u4ef6\u7684\u6570\u91cf\u548c\u5df2\u5904\u7406\u7684\u6d88\u606f\u603b\u6570\u8fdb\u884c\u5173\u8054\uff0c\u5728\u8be5\u56fe\u8868\u4e0a\u6dfb\u52a0\u53e6\u5916\u4e00\u5c42\u6570\u636e\uff0c\u5728<code>Y</code>\u8f74\u4e0a\u6dfb\u52a0\u4e00\u4e2a\u65b0\u6307\u6807\uff0c\u9009\u62e9 <code>Add metrics</code> \u548c <code>Y-axis</code>\uff0c\u7136\u540e\u540c\u6837\u9009\u62e9 <code>sum</code> \u805a\u5408\u5668\uff0c\u4f7f\u7528 <code>volume</code> \u5b57\u6bb5\uff1a</p> <p><code>Custom label</code>:  API Calls</p> <p></p> <p></p> <p>\u70b9\u51fb <code>Apply Changes</code> \u6309\u94ae\u5c31\u53ef\u4ee5\u540c\u65f6\u663e\u793a\u4e24\u4e2a\u670d\u52a1\u4e8b\u4ef6\u7684\u6570\u636e\u4e86\u3002\u6700\u540e\u70b9\u51fb\u9876\u90e8\u7684 <code>save</code> \u6765\u4fdd\u5b58\u8be5\u56fe\u8868\uff0c\u5e76\u4e3a\u5176\u6dfb\u52a0\u4e00\u4e2a\u540d\u79f0 (API events and Processed message)\u3002</p> <p></p> <p>\u5728\u5b9e\u9645\u7684\u5e94\u7528\u4e2d\uff0c\u6211\u4eec\u53ef\u80fd\u5bf9\u5e94\u7528\u7684\u9519\u8bef\u65e5\u5fd7\u66f4\u52a0\u5173\u5fc3\uff0c\u9700\u8981\u4e86\u89e3\u5e94\u7528\u7684\u8fd0\u884c\u60c5\u51b5\uff0c\u6240\u4ee5\u5bf9\u4e8e\u9519\u8bef\u6216\u8005\u8b66\u544a\u7ea7\u522b\u7684\u65e5\u5fd7\u8fdb\u884c\u7edf\u8ba1\u4e5f\u662f\u975e\u5e38\u6709\u5fc5\u8981\u7684\u3002\u73b0\u5728\u6211\u4eec\u56de\u5230 <code>Discover</code>\u9875\u9762\uff0c\u8f93\u5165 <code>LOGLEVEL:ERROR OR LOGLEVEL:WARNING</code> \u67e5\u8be2\u8bed\u53e5\u6765\u8fc7\u6ee4\u6240\u6709\u7684\u9519\u8bef\u548c\u544a\u8b66\u65e5\u5fd7\uff1a</p> <p></p> <p>\u9519\u8bef\u65e5\u5fd7\u76f8\u5bf9\u8f83\u5c11\uff0c\u5b9e\u9645\u4e0a\u6211\u4eec\u8fd9\u91cc\u7684\u793a\u4f8b\u5e94\u7528\u4f1a\u6bcf 15-20 \u5206\u949f\u5de6\u53f3\u5c31\u4f1a\u629b\u51fa4\u4e2a\u9519\u8bef\u4fe1\u606f\uff0c\u5176\u4f59\u90fd\u662f\u8b66\u544a\u4fe1\u606f\u3002\u540c\u6837\u73b0\u5728\u6211\u4eec\u8fd8\u662f\u7528\u53ef\u89c6\u5316\u7684\u56fe\u8868\u6765\u5c55\u793a\u4e0b\u9519\u8bef\u65e5\u5fd7\u7684\u60c5\u51b5\u3002</p> <p>\u540c\u6837\u5207\u6362\u5230 <code>Visualize</code> \u9875\u9762\uff0c\u70b9\u51fb <code>Create visualization</code>\uff0c\u9009\u62e9 <code>Vertical Bar</code>\uff0c\u7136\u540e\u9009\u4e2d <code>k8s-*</code> \u7684 <code>Index Pattern</code>\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u5ffd\u7565 <code>Y</code> \u8f74\uff0c\u4f7f\u7528\u9ed8\u8ba4\u7684 <code>Count</code> \u8bbe\u7f6e\u6765\u663e\u793a\u6d88\u606f\u6570\u91cf\u3002\u9996\u5148\u70b9\u51fb<code>Buckets</code> \u4e0b\u9762\u7684 <code>X-axis</code>\uff0c\u7136\u540e\u540c\u6837\u9009\u62e9 <code>Date histogram</code>\uff0c\u7136\u540e\u70b9\u51fb\u4e0b\u65b9\u7684 <code>Add</code>\uff0c\u6dfb\u52a0 <code>Sub-Bueckt</code>\uff0c\u9009\u62e9 <code>Split series:</code></p> <p></p> <p>\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u6307\u5b9a\u7684\u5b57\u6bb5\u6765\u5206\u5272\u6761\u5f62\u56fe\uff0c\u9009\u62e9 <code>Terms</code> \u4f5c\u4e3a\u5b50\u805a\u5408\u65b9\u5f0f\uff0c\u7136\u540e\u9009\u62e9 <code>serviceName.keyword</code> \u5b57\u6bb5\uff0c\u6700\u540e\u70b9\u51fb <code>apply</code> \u751f\u6210\u56fe\u8868\uff1a</p> <p></p> <p>\u73b0\u5728\u4e0a\u9762\u7684\u56fe\u8868\u4ee5\u4e0d\u540c\u7684\u989c\u8272\u6765\u663e\u793a\u6bcf\u4e2a\u670d\u52a1\u6d88\u606f\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5728\u641c\u7d22\u6846\u4e2d\u8f93\u5165\u8981\u67e5\u627e\u7684\u5185\u5bb9\uff0c\u56e0\u4e3a\u73b0\u5728\u7684\u56fe\u8868\u662f\u6bcf\u4e2a\u670d\u52a1\u7684\u6240\u6709\u6d88\u606f\u8ba1\u6570\uff0c\u5305\u62ec\u6b63\u5e38\u548c\u9519\u8bef\u7684\u65e5\u5fd7\uff0c\u6211\u4eec\u8981\u8fc7\u6ee4\u544a\u8b66\u548c\u9519\u8bef\u7684\u65e5\u5fd7\uff0c\u540c\u6837\u8f93\u5165 <code>LOGLEVEL:ERROR OR LOGLEVEL:WARNING</code> \u67e5\u8be2\u8bed\u53e5\u8fdb\u884c\u641c\u7d22\u5373\u53ef\uff1a</p> <p></p> <p>\u4ece\u56fe\u8868\u4e0a\u53ef\u4ee5\u770b\u51fa\u6765 <code>msg-processor</code> \u670d\u52a1\u95ee\u9898\u8f83\u591a\uff0c\u53ea\u6709\u5c11\u91cf\u7684\u662f <code>msg-receiver-api</code> \u670d\u52a1\u7684\uff0c\u5f53\u7136\u6211\u4eec\u4e5f\u53ef\u4ee5\u53ea\u67e5\u770b <code>ERROR</code> \u7ea7\u522b\u7684\u65e5\u5fd7\u7edf\u8ba1\u4fe1\u606f\uff1a</p> <p></p> <p>\u4ece\u56fe\u8868\u4e0a\u53ef\u4ee5\u770b\u51fa\u6765\u57fa\u672c\u4e0a\u51fa\u73b0\u9519\u8bef\u65e5\u5fd7\u7684\u60c5\u51b5\u4e0b\u4e24\u4e2a\u670d\u52a1\u90fd\u4f1a\u51fa\u73b0\uff0c\u6240\u4ee5\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u53ef\u4ee5\u731c\u6d4b\u4e24\u4e2a\u670d\u52a1\u7684\u9519\u8bef\u662f\u975e\u5e38\u76f8\u5173\u7684\u4e86\uff0c\u8fd9\u5bf9\u4e8e\u6211\u4eec\u53bb\u6392\u67e5\u9519\u8bef\u975e\u5e38\u6709\u5e2e\u52a9\u3002\u6700\u540e\u4e5f\u5c06\u8be5\u56fe\u8868\u8fdb\u884c\u4fdd\u5b58(Service Error)\u3002</p> <p></p> <p>\u6700\u540e\u6211\u4eec\u4e5f\u53ef\u4ee5\u5c06\u4e0a\u9762\u7684\u4e24\u4e2a\u56fe\u8868\u6dfb\u52a0\u5230 dashboard \u4e2d\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u5728\u4e00\u4e2a\u9875\u9762\u4e0a\u7ec4\u5408\u5404\u79cd\u53ef\u89c6\u5316\u56fe\u8868\u3002\u5207\u6362\u5230 dashboard \u9875\u9762\uff0c\u7136\u540e\u70b9\u51fb Create New Dashboard \u6309\u94ae\uff1a</p> <p></p> <p>\u9009\u62e9 <code>Add an existing</code> \u94fe\u63a5\uff1a</p> <p>\u7136\u540e\u9009\u62e9\u4e0a\u9762\u6211\u4eec\u521b\u5efa\u7684\u4e24\u4e2a\u56fe\u8868\uff0c\u6dfb\u52a0\u5b8c\u6210\u540e\u540c\u6837\u4fdd\u5b58\u8be5 <code>dashboard</code> \u5373\u53ef\uff1a</p> <p></p> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u5b8c\u6210\u4e86\u901a\u8fc7 <code>Fluentd</code> \u6536\u96c6\u65e5\u5fd7\u5230 <code>Elasticsearch</code>\uff0c\u5e76\u901a\u8fc7 <code>Kibana</code> \u5bf9\u65e5\u5fd7\u8fdb\u884c\u4e86\u5206\u6790\u53ef\u89c6\u5316\u64cd\u4f5c\u3002</p>"},{"location":"chap10/18EFK_log_alert/","title":"\u7b2c\u4e94\u8282 \u57fa\u4e8eEKF\u65e5\u5fd7\u7684\u62a5\u8b66","text":"<p>\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u6211\u4eec\u5f80\u5f80\u90fd\u4f1a\u4f7f\u7528 Promethus \u5bf9\u5e94\u7528\u7684\u5404\u9879\u6307\u6807\u8fdb\u884c\u76d1\u63a7\uff0c\u4f46\u662f\u5f80\u5f80\u5e94\u7528\u7684\u65e5\u5fd7\u4e2d\u4e5f\u4f1a\u4ea7\u751f\u4e00\u4e9b\u9519\u8bef\u65e5\u5fd7\uff0c\u8fd9\u4e9b\u4fe1\u606f\u5e76\u4e0d\u662f\u90fd\u80fd\u591f\u901a\u8fc7 metrics \u63d0\u4f9b\u6570\u636e\u7684\uff0c\u6240\u4ee5\u4e3a\u4e86\u907f\u514d\u51fa\u73b0\u592a\u591a\u7684\u9519\u8bef\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u5bf9\u9519\u8bef\u65e5\u5fd7\u8fdb\u884c\u76d1\u63a7\u62a5\u8b66\u3002\u5728 <code>Elasticsearch</code> \u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528 <code>elastalert</code> \u7ec4\u4ef6\u6765\u5b8c\u6210\u8fd9\u4e2a\u5de5\u4f5c\u3002</p> <p><code>elastalert</code> \u662f <code>yelp</code> \u4f7f\u7528<code>python</code> \u5f00\u53d1\u7684 <code>elasticsearch</code> \u544a\u8b66\u5de5\u5177\u3002<code>elastalert</code> \u4f9d\u7167\u4e00\u5b9a\u9891\u7387\u67e5\u8be2 <code>ES</code>\uff0c\u5c06\u67e5\u8be2\u7ed3\u679c\u5bf9\u6bd4\u544a\u8b66\u9608\u503c\uff0c\u8d85\u8fc7\u9608\u503c\u5373\u8fdb\u884c\u544a\u8b66\u3002\u544a\u8b66\u65b9\u5f0f\u5305\u62ec\u4f46\u4e0d\u5c40\u9650\u4e8e\u90ae\u7bb1\u3001\u5fae\u4fe1\u3001\u9489\u9489\u7b49\u3002</p> <p>\u6211\u4eec\u8fd9\u91cc\u5c06 <code>elastalert</code> \u90e8\u7f72\u5230 <code>Kubernetes</code> \u96c6\u7fa4\u4e2d\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a(<code>elastalert.yaml</code>)</p> <p>\u6211\u4eec\u8fd9\u91cc\u5c06 <code>elastalert</code> \u90e8\u7f72\u5230 <code>Kubernetes</code> \u96c6\u7fa4\u4e2d\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a(<code>elastalert.yaml</code>)</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: elastalert-config\n  namespace: logging\n  labels:\n    app: elastalert\ndata:\n  elastalert_config: |-\n    ---\n    rules_folder: /opt/rules       # \u6307\u5b9a\u89c4\u5219\u7684\u76ee\u5f55\n    scan_subdirectories: false\n    run_every:                     # \u591a\u4e45\u4ece ES \u4e2d\u67e5\u8be2\u4e00\u6b21\n      minutes: 1\n    buffer_time:\n      minutes: 15\n    es_host: elasticsearch\n    es_port: 9200\n    writeback_index: elastalert\n    use_ssl: False\n    verify_certs: True\n    alert_time_limit:             # \u5931\u8d25\u91cd\u8bd5\u9650\u5236\n      minutes: 2880\n---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: elastalert-rules\n  namespace: logging\n  labels:\n    app: elastalert\ndata:\n  rule_config.yaml: |-\n    name: dummylogs error     # \u89c4\u5219\u540d\u5b57\uff0c\u552f\u4e00\u503c\n    es_host: elasticsearch\n    es_port: 9200\n\n    type: any                 # \u62a5\u8b66\u7c7b\u578b\n    index: k8s-*              # es\u7d22\u5f15\n\n    filter:                   # \u8fc7\u6ee4\n    - query:\n        query_string:\n          query: \"LOGLEVEL:ERROR\"  # \u62a5\u8b66\u6761\u4ef6\n\n    alert:                    # \u62a5\u8b66\u7c7b\u578b\n    - \"email\"\n    smtp_host: smtp.qq.com\n    smtp_port: 587\n    smtp_auth_file: /opt/auth/smtp_auth_file.yaml\n    email_reply_to: ...@qq.com\n    from_addr: ...@qq.com\n    email:                  # \u63a5\u53d7\u90ae\u7bb1\n    - \"...@163.com\"\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: elastalert\n  namespace: logging\n  labels:\n    app: elastalert\nspec:\n  selector:\n    matchLabels:\n      app: elastalert\n  template:\n    metadata:\n      labels:\n        app: elastalert\n    spec:\n      containers:\n      - name: elastalert\n        image: jertel/elastalert-docker:0.2.4\n        imagePullPolicy: IfNotPresent\n        volumeMounts:\n        - name: config\n          mountPath: /opt/config\n        - name: rules\n          mountPath: /opt/rules\n        - name: auth\n          mountPath: /opt/auth\n        resources:\n          limits:\n            cpu: 50m\n            memory: 256Mi\n          requests:\n            cpu: 50m\n            memory: 256Mi\n      volumes:\n      - name: auth\n        secret:\n          secretName: smtp-auth\n      - name: rules\n        configMap:\n          name: elastalert-rules\n      - name: config\n        configMap:\n          name: elastalert-config\n          items:\n          - key: elastalert_config\n            path: elastalert_config.yaml\n</code></pre> <p>\u4f7f\u7528\u90ae\u4ef6\u8fdb\u884c\u62a5\u8b66\u7684\u65f6\u5019\uff0c\u9700\u8981\u6307\u5b9a\u4e00\u4e2a <code>smtp_auth_file</code> \u7684\u6587\u4ef6\uff0c\u6587\u4ef6\u4e2d\u5305\u542b\u7528\u6237\u540d\u548c\u5bc6\u7801\uff1a(<code>smtp_auth_file.yaml</code>)</p> <pre><code>user: \"xxxxx@qq.com\"       # \u53d1\u9001\u7684\u90ae\u7bb1\u5730\u5740\npassword: \"ewwghfhdvjwnbjea\"   # \u4e0d\u662fqq\u90ae\u7bb1\u7684\u767b\u5f55\u5bc6\u7801\uff0c\u662f\u6388\u6743\u7801\n</code></pre> <p>\u7136\u540e\u4f7f\u7528\u4e0a\u9762\u7684\u6587\u4ef6\u521b\u5efa\u4e00\u4e2a\u5bf9\u5e94\u7684 Secret \u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl create secret generic smtp-auth --from-file=smtp_auth_file.yaml -n logging\n</code></pre> <p>\u7136\u540e\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684 elastalert \u5e94\u7528\uff1a</p> <pre><code>$ kubectl apply -f elastalert.yaml\n$ kubectl get pods -n logging -l app=elastalert\nNAME                          READY   STATUS    RESTARTS   AGE\nelastalert-64ccfbffcf-gd6xz   1/1     Running   0          102s\n$ kubectl logs -f elastalert-64ccfbffcf-gd6xz -n logging\nElastic Version: 7.6.2\nReading Elastic 6 index mappings:\nReading index mapping 'es_mappings/6/silence.json'\nReading index mapping 'es_mappings/6/elastalert_status.json'\nReading index mapping 'es_mappings/6/elastalert.json'\nReading index mapping 'es_mappings/6/past_elastalert.json'\nReading index mapping 'es_mappings/6/elastalert_error.json'\nDeleting index elastalert_status.\nNew index elastalert created\nDone!\n</code></pre> <p>\u770b\u5230\u4e0a\u9762\u7684\u65e5\u5fd7\u4fe1\u606f\u5c31\u8bc1\u660e <code>elastalert</code> \u5e94\u7528\u90e8\u7f72\u6210\u529f\u4e86\u3002\u5728 <code>Elasticsearch</code> \u4e2d\u4e5f\u53ef\u4ee5\u770b\u5230\u51e0\u4e2a\u76f8\u5173\u7684 Index \uff1a</p> <p></p> <p>\u7531\u4e8e\u6211\u4eec\u7684\u793a\u4f8b\u5e94\u7528\u4f1a\u9694\u4e00\u6bb5\u65f6\u95f4\u5c31\u4ea7\u751f <code>ERROR</code>\u7ea7\u522b\u7684\u9519\u8bef\u65e5\u5fd7\uff0c\u6240\u4ee5\u6b63\u5e38\u60c5\u51b5\u4e0b\u6211\u4eec\u5c31\u53ef\u4ee5\u6536\u5230\u5982\u4e0b\u6240\u793a\u7684\u90ae\u4ef6\u4fe1\u606f\u4e86\uff1a</p> <p></p> <p>\u9664\u6b64\u4e4b\u5916\u6211\u4eec\u4e5f\u53ef\u4ee5\u914d\u7f6e\u5c06\u62a5\u8b66\u4fe1\u606f\u53d1\u5f80 \u4f01\u4e1a\u5fae\u4fe1 \u6216\u8005 \u9489\u9489\uff0c\u8fd8\u53ef\u4ee5\u5b89\u88c5\u4e00\u4e2a elastalert \u7684 Kibana \u63d2\u4ef6\uff0c\u7528\u4e8e\u5728 Kibana \u9875\u9762\u4e0a\u8fdb\u884c\u53ef\u89c6\u5316\u64cd\u4f5c\u3002</p> <p>\u5173\u4e8e elastalert \u66f4\u591a\u7684\u64cd\u4f5c\u548c\u4f7f\u7528\u8bf4\u660e\uff0c\u5927\u5bb6\u53ef\u4ee5\u67e5\u770b\u5b98\u65b9\u6587\u6863\u4e86\u89e3\u66f4\u591a\uff1ahttps://elastalert.readthedocs.io/en/latest/\u3002</p>"},{"location":"chap10/19Fluentd/","title":"\u7b2c\u516b\u8282 \u65e5\u5fd7\u6536\u96c6\u5de5\u5177 Fluentd \u4f7f\u7528\u6559\u7a0b","text":"<p>Fluentd \u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u6570\u636e\u6536\u96c6\u5668\uff0c\u81f4\u529b\u4e8e\u4e3a\u7528\u6237\u642d\u5efa\u7edf\u4e00\u7684\u65e5\u5fd7\u6536\u96c6\u5c42\uff0c\u5b83\u53ef\u4ee5\u8ba9\u4f60\u7edf\u4e00\u65e5\u5fd7\u7684\u6536\u96c6\u548c\u6d88\u8d39\uff0c\u4ee5\u4fbf\u66f4\u597d\u5730\u4f7f\u7528\u548c\u7406\u89e3\u65e5\u5fd7\uff0c\u7edf\u4e00\u7684\u65e5\u5fd7\u8bb0\u5f55\u5c42\u53ef\u8ba9\u4f60\u548c\u4f60\u7684\u56e2\u961f\u66f4\u597d\u5730\u5229\u7528\u6570\u636e\u5e76\u66f4\u5feb\u5730\u8fed\u4ee3\u4f60\u7684\u5e94\u7528\u3002</p> <p></p>"},{"location":"chap10/19Fluentd/#_1","title":"\u5b89\u88c5","text":"<p>Fluentd \u6709\u591a\u79cd\u5b89\u88c5\u65b9\u5f0f\uff0c\u6bd4\u5982\u53ef\u4ee5\u901a\u8fc7 Docker \u6216\u8005\u624b\u52a8\u8fdb\u884c\u5b89\u88c5\uff0c\u5728\u624b\u52a8\u5b89\u88c5 Fluentd \u4e4b\u524d\uff0c\u8bf7\u786e\u4fdd\u4f60\u7684\u73af\u5883\u5df2\u6b63\u786e\u8bbe\u7f6e\uff0c\u4ee5\u907f\u514d\u4ee5\u540e\u51fa\u73b0\u4efb\u4f55\u4e0d\u4e00\u81f4\u3002</p>"},{"location":"chap10/19Fluentd/#_2","title":"\u73af\u5883\u914d\u7f6e","text":"<p>\u8bf7\u9075\u5faa\u4ee5\u4e0b\u5efa\u8bae\uff1a</p> <ul> <li>\u8bbe\u7f6e NTP</li> <li>\u589e\u52a0\u6587\u4ef6\u63cf\u8ff0\u7b26\u7684\u6700\u5927\u6570\u91cf</li> <li>\u4f18\u5316\u7f51\u7edc\u5185\u6838\u53c2\u6570</li> </ul>"},{"location":"chap10/19Fluentd/#ntp","title":"\u8bbe\u7f6e NTP","text":"<p>\u5f3a\u70c8\u5efa\u8bae\u4f60\u5728\u8282\u70b9\u4e0a\u8bbe\u7f6e NTP \u5b88\u62a4\u8fdb\u7a0b\uff08\u4f8b\u5982 chrony\u3001ntpd \u7b49\uff09\u4ee5\u83b7\u5f97\u51c6\u786e\u7684\u5f53\u524d\u65f6\u95f4\u6233\uff0c\u8fd9\u5bf9\u4e8e\u6240\u6709\u751f\u4ea7\u670d\u52a1\u81f3\u5173\u91cd\u8981\u3002</p> <p>\u589e\u52a0\u6587\u4ef6\u63cf\u8ff0\u7b26\u7684\u6700\u5927\u6570\u91cf</p> <p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>ulimit -n</code> \u547d\u4ee4\u67e5\u770b\u73b0\u6709\u914d\u7f6e\uff1a</p> <pre><code>$ ulimit -n\n\n65535\n</code></pre> <p>\u5982\u679c\u4f60\u7684\u63a7\u5236\u53f0\u663e\u793a 1024\uff0c\u90a3\u662f\u4e0d\u591f\u7684\u3002\u8bf7\u5c06\u4ee5\u4e0b\u51e0\u884c\u6dfb\u52a0\u5230 <code>/etc/security/limits.conf</code> \u6587\u4ef6\u5e76\u91cd\u542f\u673a\u5668\uff1a</p> <pre><code>root soft nofile 65536\n\nroot hard nofile 65536\n\n* soft nofile 65536\n\n* hard nofile 65536\n</code></pre> <p>\u4f7f\u7528 sysctl -p \u547d\u4ee4\u6216\u91cd\u65b0\u542f\u52a8\u8282\u70b9\u4f7f\u66f4\u6539\u751f\u6548\u3002</p>"},{"location":"chap10/19Fluentd/#td-agent","title":"<code>td-agent</code> \u5305","text":"<p>\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528 td-agent deb \u5305\u8fdb\u884c\u5b89\u88c5\uff0c\u8fd9\u662f\u7531 Treasure Data, Inc \u548c Calyptia, Inc \u7ef4\u62a4\u7684\u7a33\u5b9a Fluentd \u5206\u53d1\u5305\u3002</p> <p>Fluentd \u662f\u7528 Ruby \u7f16\u5199\u7684\uff0c\u5177\u6709\u7075\u6d3b\u6027\uff0c\u5bf9\u6027\u80fd\u654f\u611f\u7684\u90e8\u5206\u7528 C \u8bed\u8a00\u7f16\u5199\u3002\u4f46\u662f\uff0c\u4e00\u4e9b\u7528\u6237\u53ef\u80fd\u96be\u4ee5\u5b89\u88c5\u548c\u64cd\u4f5c Ruby \u5b88\u62a4\u7a0b\u5e8f\u3002\u6240\u4ee5 Treasure Data, Inc \u4e13\u95e8\u63d0\u4f9b\u4e86\u4e00\u4e2a Fluentd \u7684\u7a33\u5b9a\u53d1\u884c\u7248\uff0c\u79f0\u4e3a td-agent\u3002</p> <p>\u6211\u8fd9\u91cc\u662f Ubuntu Focal \u7684\u7248\u672c\uff0c\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u8fdb\u884c\u4e00\u952e\u5b89\u88c5\uff1a</p> <pre><code>curl -fsSL https://toolbelt.treasuredata.com/sh/install-ubuntu-focal-td-agent4.sh | sh\n</code></pre> <p>\u4e0a\u9762\u7684\u811a\u672c\u4f1a\u81ea\u52a8\u914d\u7f6e systemd \u7684\u542f\u52a8\u811a\u672c\uff0c\u811a\u672c\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>$ cat /lib/systemd/system/td-agent.service;\n\n[Unit]\n\nDescription=td-agent: Fluentd based data collector for Treasure Data\n\nDocumentation=https://docs.treasuredata.com/display/public/PD/About+Treasure+Data%%27s+Server-Side+Agent\n\nAfter=network-online.target\n\nWants=network-online.target\n\n\n\n[Service]\n\nUser=td-agent\n\nGroup=td-agent\n\nLimitNOFILE=65536\n\nEnvironment=LD_PRELOAD=/opt/td-agent/lib/libjemalloc.so\n\nEnvironment=GEM_HOME=/opt/td-agent/lib/ruby/gems/2.7.0/\n\nEnvironment=GEM_PATH=/opt/td-agent/lib/ruby/gems/2.7.0/\n\nEnvironment=FLUENT_CONF=/etc/td-agent/td-agent.conf\n\nEnvironment=FLUENT_PLUGIN=/etc/td-agent/plugin\n\nEnvironment=FLUENT_SOCKET=/var/run/td-agent/td-agent.sock\n\nEnvironment=TD_AGENT_LOG_FILE=/var/log/td-agent/td-agent.log\n\nEnvironment=TD_AGENT_OPTIONS=\n\nEnvironmentFile=-/etc/default/td-agent\n\nPIDFile=/var/run/td-agent/td-agent.pid\n\nRuntimeDirectory=td-agent\n\nType=forking\n\n# XXX: Fix fluentd executables path\n\nExecStart=/opt/td-agent/bin/fluentd --log $TD_AGENT_LOG_FILE --daemon /var/run/td-agent/td-agent.pid $TD_AGENT_OPTIONS\n\nExecStop=/bin/kill -TERM ${MAINPID}\n\nExecReload=/bin/kill -HUP ${MAINPID}\n\nRestart=always\n\nTimeoutStopSec=120\n\n\n\n[Install]\n\nWantedBy=multi-user.target\n</code></pre> <p>\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 systemctl \u6765\u7ba1\u7406 td-agent \u670d\u52a1\uff1a</p> <pre><code>$ sudo systemctl start td-agent\n\n$ sudo systemctl status td-agent\n\n\u25cf td-agent.service - td-agent: Fluentd based data collector for Treasure Data\n\nLoaded: loaded (/lib/systemd/system/td-agent.service; enabled; vendor preset: enabled)\n\nActive: active (running) since Sat 2022-06-11 11:00:04 CST; 4min 6s ago\n\nDocs: https://docs.treasuredata.com/display/public/PD/About+Treasure+Data%27s+Server-Side+Agent\n\nProcess: 3664 ExecStart=/opt/td-agent/bin/fluentd --log $TD_AGENT_LOG_FILE --daemon /var/run/td-agent/td-agent.pid $TD_AGE&gt;\n\nMain PID: 3677 (fluentd)\n\nTasks: 9 (limit: 19106)\n\nMemory: 99.0M\n\nCGroup: /system.slice/td-agent.service\n\n\u251c\u25003677 /opt/td-agent/bin/ruby /opt/td-agent/bin/fluentd --log /var/log/td-agent/td-agent.log --daemon /var/run/td&gt;\n\n\u2514\u25003680 /opt/td-agent/bin/ruby -Eascii-8bit:ascii-8bit /opt/td-agent/bin/fluentd --log /var/log/td-agent/td-agent.&gt;\n\n\n\nJun 11 11:00:03 ydzsio systemd[1]: Starting td-agent: Fluentd based data collector for Treasure Data...\n\nJun 11 11:00:04 ydzsio systemd[1]: Started td-agent: Fluentd based data collector for Treasure Data.\n\nlines 1-14/14 (END)\n</code></pre> <p>td-agent \u542f\u52a8\u540e\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u53d1\u9001\u4e00\u6761\u65e5\u5fd7\uff1a</p> <pre><code>$ curl -X POST -d 'json={\"json\":\"message\"}' http://localhost:8888/debug.test\n</code></pre> <p>\u53d1\u9001\u540e\u67e5\u770b td-agent \u7684\u65e5\u5fd7\uff0c\u6b63\u5e38\u4f1a\u6536\u5230\u5982\u4e0b\u6240\u793a\u7684\u65e5\u5fd7\u4fe1\u606f\uff1a</p> <pre><code>$ tail -n 1 /var/log/td-agent/td-agent.log\n\n2022-06-11 11:09:02.377608475 +0800 debug.test: {\"json\":\"message\"}\n</code></pre>"},{"location":"chap10/19Fluentd/#docker","title":"Docker \u65b9\u5f0f","text":"<p>\u5f53\u7136\u66f4\u591a\u7684\u65f6\u5019\u4f7f\u7528 Docker \u65b9\u5f0f\u4f7f\u7528 Fluentd \u4f1a\u66f4\u65b9\u4fbf\uff0c\u8fd9\u91cc\u6211\u4eec\u521b\u5efa\u4e00\u4e9b\u7b80\u5355\u7684\u6587\u4ef6\u6765\u8fdb\u884c\u6d4b\u8bd5\uff1a</p> <pre><code>\n$ mkdir fluentd\n\n$ cd fluentd\n\n# \u521b\u5efa\u7528\u4e8e\u4fdd\u5b58 fluentd \u7684\u914d\u7f6e\u6587\u4ef6 etc \u76ee\u5f55\u548c\u4fdd\u5b58\u65e5\u5fd7\u7684 logs \u76ee\u5f55\n\n$ mkdir -p etc logs\n\n# \u6dfb\u52a0\u4e00\u4e2a\u7b80\u5355\u7684\u914d\u7f6e\u6587\u4ef6\n\n$ cat etc/fluentd_basic.conf\n\n\n\n&lt;source&gt;\n\n@type http\n\nport 8888\n\nbind 0.0.0.0\n\n&lt;/source&gt;\n\n&lt;match test.basic&gt;\n\n@type stdout\n\n&lt;/match&gt;\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u521b\u5efa\u4e86\u4e00\u4e2a fluentd \u76ee\u5f55\u7528\u4e8e\u6d4b\u8bd5\uff0c\u5176\u4e2d etc \u76ee\u5f55\u7528\u4e8e\u4fdd\u7559\u914d\u7f6e\u6587\u4ef6\u3001logs \u76ee\u5f55\u4fdd\u5b58\u65e5\u5fd7\uff0c\u9996\u5148\u6dfb\u52a0\u4e86\u4e00\u4e2a\u6700\u57fa\u672c\u7684\u914d\u7f6e\u6587\u4ef6 <code>etc/fluentd_basic.conf</code>\uff0c\u5176\u4e2d\uff1a</p> <ul> <li>source \u90e8\u5206\u4f7f\u7528\u4e86 http \u7c7b\u578b\u7684\u8f93\u5165\u63d2\u4ef6\uff0c\u5728 8888 \u7aef\u53e3\u542f\u52a8\u4e00\u4e2a\u670d\u52a1\u7528\u4e8e\u63a5\u6536\u65e5\u5fd7</li> <li>match \u90e8\u5206\u5b9a\u4e49\u4e86\u65e5\u5fd7\u5339\u914d <code>test.basic</code> \u6807\u7b7e\uff0c\u5c31\u5c06\u65e5\u5fd7\u8f93\u51fa\u5230 stdout</li> </ul> <p>\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u8fdb\u884c Fluentd \u7684\u542f\u52a8\uff1a</p> <pre><code>$ docker run -p 8888:8888 --rm -v $(pwd)/etc:/fluentd/etc -v $(pwd)/logs:/fluentd/logs fluent/fluentd:v1.14-1 -c /fluentd/etc/fluentd_basic.conf -v\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u5c06 etc \u76ee\u5f55\u548c logs \u76ee\u5f55\u6302\u8f7d\u5230\u5bb9\u5668\u4e2d\uff0c</p> <ul> <li>\u7136\u540e\u901a\u8fc7 <code>-c</code> \u53c2\u6570\u6307\u5b9a <code>Fluentd</code> \u7684\u914d\u7f6e\u6587\u4ef6\uff0c</li> <li>\u6700\u540e\u4e00\u4e2a <code>-v</code> \u53c2\u6570\u662f\u7528\u4e8e\u8bbe\u7f6e <code>Fluentd</code> \u5f00\u542f <code>verbose</code> \u6a21\u5f0f\uff0c\u4fbf\u4e8e\u67e5\u770b Fluentd \u7684\u65e5\u5fd7\u65b9\u4fbf\u8c03\u8bd5\uff0c\u6b63\u5e38\u4f1a\u770b\u5230\u5982\u4e0b\u6240\u793a\u7684\u8f93\u51fa\u4fe1\u606f\uff1a</li> </ul> <pre><code>2022-06-11 07:23:48 +0000 [info]: fluent/log.rb:330:info: parsing config file is succeeded path=\"/fluentd/etc/fluentd_basic.conf\"\n\n2022-06-11 07:23:48 +0000 [info]: fluent/log.rb:330:info: gem 'fluentd' version '1.14.3'\n\n2022-06-11 07:23:48 +0000 [debug]: fluent/log.rb:309:debug: No fluent logger for internal event\n\n2022-06-11 07:23:48 +0000 [info]: fluent/log.rb:330:info: using configuration file: &lt;ROOT&gt;\n\n&lt;source&gt;\n\n@type http\n\nport 8888\n\nbind \"0.0.0.0\"\n\n&lt;/source&gt;\n\n&lt;match test.basic&gt;\n\n@type stdout\n\n&lt;/match&gt;\n\n&lt;/ROOT&gt;\n\n2022-06-11 07:23:48 +0000 [info]: fluent/log.rb:330:info: starting fluentd-1.14.3 pid=7 ruby=\"2.7.5\"\n\n2022-06-11 07:23:48 +0000 [info]: fluent/log.rb:330:info: spawn command to main: cmdline=[\"/usr/bin/ruby\", \"-Eascii-8bit:ascii-8bit\", \"/usr/bin/fluentd\", \"-c\", \"/fluentd/etc/fluentd_basic.conf\", \"-v\", \"--plugin\", \"/fluentd/plugins\", \"--under-supervisor\"]\n\n2022-06-11 07:23:49 +0000 [info]: fluent/log.rb:330:info: adding match pattern=\"test.basic\" type=\"stdout\"\n\n2022-06-11 07:23:49 +0000 [info]: fluent/log.rb:330:info: adding source type=\"http\"\n\n2022-06-11 07:23:49 +0000 [debug]: #0 fluent/log.rb:309:debug: No fluent logger for internal event\n\n2022-06-11 07:23:49 +0000 [info]: #0 fluent/log.rb:330:info: starting fluentd worker pid=16 ppid=7 worker=0\n\n2022-06-11 07:23:49 +0000 [debug]: #0 fluent/log.rb:309:debug: listening http bind=\"0.0.0.0\" port=8888\n\n2022-06-11 07:23:49 +0000 [info]: #0 fluent/log.rb:330:info: fluentd worker is now running worker=0\n</code></pre> <p>\u542f\u52a8\u540e\u6211\u4eec\u540c\u6837\u53ef\u4ee5\u53d1\u9001\u4e00\u6761\u65e5\u5fd7\u5230 Fluentd \u6765\u9a8c\u8bc1\u6211\u4eec\u7684\u914d\u7f6e\uff1a</p> <pre><code>$ curl -X POST -d 'json={\"action\":\"login\",\"user\":100}' http://localhost:8888/test.logs\n</code></pre> <p>\u53d1\u9001\u540e\u6b63\u5e38\u4f1a\u5728 Fluentd \u4e2d\u67e5\u770b\u5230\u5982\u4e0b\u6240\u793a\u7684\u4e00\u6761\u4fe1\u606f\uff1a</p> <pre><code>2022-06-11 07:34:29.925695338 +0000 test.logs: {\"action\":\"login\",\"user\":100}\n</code></pre>"},{"location":"chap10/19Fluentd/#_3","title":"\u4e8b\u4ef6\u751f\u547d\u5468\u671f","text":"<p>Fluentd \u662f\u4e00\u4e2a\u65e5\u5fd7\u6536\u96c6\u7cfb\u7edf\uff0c\u4e00\u6761\u65e5\u5fd7\u6d88\u606f\u5728 Fluentd \u4e2d\u88ab\u770b\u6210\u4e00\u4e2a Event \u4e8b\u4ef6\uff0cFluentd \u7684\u4e8b\u4ef6\u4e3b\u8981\u7531\u4e0b\u9762\u4e09\u90e8\u5206\u7ec4\u6210\uff1a</p> <ul> <li>\u6807\u7b7e tag\uff1a\u7528\u4e8e\u63cf\u8ff0\u4e8b\u4ef6\u6765\u6e90\uff0c\u53ef\u7528\u4e8e\u540e\u9762\u7684\u4e8b\u4ef6\u8def\u7531</li> <li>\u65f6\u95f4 time\uff1a\u4e8b\u4ef6\u53d1\u751f\u7684\u65f6\u95f4\uff0c\u65f6\u95f4\u683c\u5f0f\u4e3a Unix \u65f6\u95f4\u6233</li> <li>\u8bb0\u5f55 record\uff1a\u4e8b\u4ef6\u5185\u5bb9\u672c\u8eab\uff0cJSON \u683c\u5f0f</li> </ul> <p>\u6240\u6709\u7684\u8f93\u5165\u63d2\u4ef6\u90fd\u9700\u8981\u89e3\u6790\u539f\u59cb\u65e5\u5fd7\uff0c\u751f\u6210\u6ee1\u8db3\u4e0a\u9762\u7ed3\u6784\u7684\u4e8b\u4ef6\u5b57\u6bb5\uff0c\u6bd4\u5982\u4e00\u6761 Apache \u7684\u8bbf\u95ee\u65e5\u5fd7\uff1a</p> <pre><code>192.168.0.1 - - [28/Feb/2013:12:00:00 +0900] \"GET / HTTP/1.1\" 200 777\n</code></pre> <p>\u5728\u901a\u8fc7 <code>in_tail</code> \u8f93\u5165\u63d2\u4ef6\u5904\u7406\u540e\uff0c\u4f1a\u5f97\u5230\u5982\u4e0b\u6240\u793a\u7684\u8f93\u51fa\u7ed3\u679c\uff1a</p> <pre><code>tag: apache.access # \u901a\u8fc7\u914d\u7f6e\u6587\u4ef6\u6307\u5b9a\n\ntime: 1362020400 # 28/Feb/2013:12:00:00 +0900\n\nrecord: {\"user\": \"-\", \"method\": \"GET\", \"code\": 200, \"size\": 777, \"host\": \"192.168.0.1\", \"path\": \"/\"}\n</code></pre> <p>\u5f53 Fluentd \u6536\u5230\u4e00\u6761\u4e8b\u4ef6\u540e\u4f1a\u7ecf\u8fc7\u4e00\u7cfb\u5217\u7684\u5904\u7406\u6d41\u7a0b\uff1a</p> <ul> <li>\u4fee\u6539\u4e8b\u4ef6\u7684\u76f8\u5173\u5b57\u6bb5</li> <li>\u8fc7\u6ee4\u6389\u4e00\u4e9b\u4e0d\u9700\u8981\u7684\u4e8b\u4ef6</li> <li>\u8def\u7531\u4e8b\u4ef6\u8f93\u51fa\u5230\u4e0d\u540c\u7684\u5730\u65b9</li> </ul>"},{"location":"chap10/19Fluentd/#filter","title":"\u8fc7\u6ee4\u5668 Filter","text":"<p>Filter \u7528\u4e8e\u5b9a\u4e49\u4e00\u4e2a\u4e8b\u4ef6\u662f\u8be5\u88ab\u63a5\u53d7\u6216\u662f\u88ab\u8fc7\u6ee4\u6389\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u914d\u7f6e\u6587\u4ef6\u65b0\u589e\u8fc7\u6ee4\u5668\u3002</p> <pre><code>$ cat etc/fluentd_filter.conf\n\n\n\n&lt;source&gt;\n\n@type http\n\nport 8888\n\nbind 0.0.0.0\n\n&lt;/source&gt;\n\n\n\n&lt;filter test.logs&gt;\n\n@type grep\n\n&lt;exclude&gt;\n\nkey action\n\npattern ^logout$\n\n&lt;/exclude&gt;\n\n&lt;/filter&gt;\n\n\n\n&lt;match test.logs&gt;\n\n@type stdout\n\n&lt;/match&gt;\n</code></pre> <p>\u5728\u8be5\u914d\u7f6e\u6587\u4ef6\u4e2d\u6211\u4eec\u65b0\u589e\u4e86\u4e00\u4e2a filter \u6a21\u5757\uff0c\u4f7f\u7528 grep \u63d2\u4ef6\uff0cexclude \u90e8\u5206\u8868\u793a\u8981\u8fc7\u6ee4\u6389\u7684\u65e5\u5fd7\u914d\u7f6e\uff0c\u8fd9\u91cc\u6211\u4eec\u914d\u7f6e\u7684\u662f action \u8fd9\u4e2a key \u5339\u914d <code>^logout$</code> \u7684\u65f6\u5019\u8fdb\u884c\u8fc7\u6ee4\uff0c\u5c31\u662f\u76f4\u63a5\u8fc7\u6ee4\u6389 `logout \u65e5\u5fd7\u4e8b\u4ef6\u3002</p> <p>\u4f7f\u7528\u65b0\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u91cd\u65b0\u542f\u52a8 fluentd\uff1a</p> <pre><code>$ docker run -p 8888:8888 --rm -v $(pwd)/etc:/fluentd/etc -v $(pwd)/logs:/fluentd/logs fluent/fluentd:v1.14-1 -c /fluentd/etc/fluentd_filter.conf -v\n</code></pre> <p>\u7136\u540e\u91cd\u65b0\u5411 Fluentd \u63d0\u4ea4\u4e24\u6761\u65e5\u5fd7\u6570\u636e\uff1a</p> <pre><code>$ curl -X POST -d 'json={\"action\":\"login\",\"user\":2}' http://localhost:8888/test.logs\n\n$ curl -X POST -d 'json={\"action\":\"logout\",\"user\":2}' http://localhost:8888/test.logs\n</code></pre> <p>\u6b63\u5e38\u8fd9\u4e2a\u65f6\u5019 Fluentd \u53ea\u4f1a\u6536\u5230\u7b2c\u4e00\u6761\u65e5\u5fd7\u6570\u636e\uff0clogout \u8fd9\u6761\u4e8b\u4ef6\u88ab\u8fc7\u6ee4\u6389\u4e86\uff1a</p> <pre><code>2022-06-11 07:52:45.555576216 +0000 test.logs: {\"action\":\"login\",\"user\":2}\n</code></pre> <p>\u6807\u8bc6\u7b26 Labels</p> <p>Fluentd \u7684\u5904\u7406\u6d41\u7a0b\u662f\u6839\u636e\u6211\u4eec\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u5b9a\u4e49\u4ece\u4e0a\u5230\u4e0b\u4f9d\u6b21\u6267\u884c\u7684\u3002\u4f46\u662f\u5047\u5982\u6211\u4eec\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u5b9a\u4e49\u4e86\u591a\u4e2a\u8f93\u5165\u6e90\uff0c\u4e0d\u540c\u7684\u8f93\u5165\u6e90\u9700\u8981\u4f7f\u7528\u4e0d\u540c\u7684 Filters \u8fc7\u6ee4\u5668\u7684\u65f6\u5019\uff0c\u90a3\u4e48\u8fd8\u6309\u7167\u987a\u5e8f\u6267\u884c\u7684\u65b9\u5f0f\u8bdd\uff0c\u914d\u7f6e\u6587\u4ef6\u5c31\u4f1a\u53d8\u5f97\u975e\u5e38\u590d\u6742\u3002\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0cFluentd \u4e2d\u63d0\u4f9b\u4e86\u4e00\u79cd\u6807\u8bc6\u7b26 Labels \u7684\u65b9\u5f0f\uff0c\u53ef\u4ee5\u4e3a\u4e0d\u540c\u7684\u8f93\u5165\u6e90\u6307\u5b9a\u4e0d\u540c\u7684\u5904\u7406\u6d41\u7a0b\u3002</p> <p>\u5982\u4e0b\u6240\u793a\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u914d\u7f6e\u6587\u4ef6 <code>fluentd_labels.conf</code>\uff1a</p> <pre><code>&lt;source&gt;\n\n@type http\n\nport 8888\n\nbind 0.0.0.0\n\n@label @TEST\n\n&lt;/source&gt;\n\n\n\n&lt;filter test.logs&gt;\n\n@type grep\n\n&lt;exclude&gt;\n\nkey action\n\npattern ^login$\n\n&lt;/exclude&gt;\n\n&lt;/filter&gt;\n\n\n\n&lt;label @TEST&gt;\n\n&lt;filter test.logs&gt;\n\n@type grep\n\n&lt;exclude&gt;\n\nkey action\n\npattern ^logout$\n\n&lt;/exclude&gt;\n\n&lt;/filter&gt;\n\n\n&lt;match test.logs&gt;\n\n@type stdout\n\n&lt;/match&gt;\n\n\n&lt;/label&gt;\n</code></pre> <p>\u9996\u5148\u6211\u4eec\u5728\u8f93\u5165\u6e90\u4e2d\u7ed9\u65e5\u5fd7\u6e90\u5b9a\u4e49\u4e86\u4e00\u4e2a\u6807\u7b7e <code>@label @TEST</code>\uff0c\u7136\u540e\u5148\u5b9a\u4e49\u4e86\u4e00\u4e2a filter \u8fc7\u6ee4\u6389 login \u4e8b\u4ef6\uff0c\u7136\u540e\u5728\u4e00\u4e2a <code>label</code> \u6a21\u5757\u91cc\u9762\u8fc7\u6ee4\u4e86 logout \u4e8b\u4ef6\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u4f7f\u7528\u8be5\u914d\u7f6e\u91cd\u65b0\u542f\u52a8 Fluentd\uff1a</p> <pre><code>$ docker run -p 8888:8888 --rm -v $(pwd)/etc:/fluentd/etc -v $(pwd)/logs:/fluentd/logs fluent/fluentd:v1.14-1 -c /fluentd/etc/fluentd_labels.conf -v\n</code></pre> <p>\u7136\u540e\u91cd\u65b0\u5411 Fluentd \u63d0\u4ea4\u4e24\u6761\u65e5\u5fd7\u6570\u636e\uff1a</p> <pre><code>$ curl -X POST -d 'json={\"action\":\"login\",\"user\":2}' http://localhost:8888/test.logs\n\n$ curl -X POST -d 'json={\"action\":\"logout\",\"user\":2}' http://localhost:8888/test.logs\n</code></pre> <p>\u6b63\u5e38 Fluentd \u4e2d\u4f1a\u8f93\u51fa\u4e00\u6761\u65e5\u5fd7\u8bb0\u5f55\uff1a</p> <pre><code>2022-06-11 08:06:41.977559894 +0000 test.logs: {\"action\":\"login\",\"user\":2}\n</code></pre> <p>\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u4e3a\u8f93\u5165\u65e5\u5fd7\u8bbe\u7f6e\u4e86 <code>@TEST</code> \u7684\u6807\u7b7e\uff0c\u56e0\u6b64\u8df3\u8fc7\u4e2d\u95f4\u8bbe\u7f6e\u7684\u4e00\u4e9b\u8fc7\u6ee4\u5668\uff0c\u53ea\u8fd0\u884c\u4e86 <code>&lt;label @TEST&gt;...&lt;/lable&gt;</code> \u6807\u7b7e\u5757\u91cc\u7684\u8fc7\u6ee4\u5668\uff0c\u5982\u679c\u6807\u7b7e\u5757\u91cc\u9762\u6ca1\u6709\u5b9a\u4e49\u8fc7\u6ee4\u5668\u5219\u5c31\u4e0d\u4f1a\u8fc7\u6ee4\u65e5\u5fd7\u4e86\u3002</p>"},{"location":"chap10/19Fluentd/#_4","title":"\u914d\u7f6e\u6587\u4ef6","text":"<p>\u63a5\u4e0b\u6765\u6211\u4eec\u518d\u6765\u8be6\u7ec6\u4ecb\u7ecd\u4e0b Fluentd \u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u53ef\u4ee5\u4f7f\u7528\u6307\u4ee4\u5305\u62ec\uff1a</p> <ul> <li><code>source</code> \u6307\u4ee4\u786e\u5b9a\u8f93\u5165\u6e90</li> <li><code>match</code> \u6307\u4ee4\u786e\u5b9a\u8f93\u51fa\u76ee\u7684\u5730</li> <li><code>filter</code> \u6307\u4ee4\u786e\u5b9a\u4e8b\u4ef6\u5904\u7406\u7ba1\u9053</li> <li><code>system</code> \u6307\u4ee4\u8bbe\u7f6e\u7cfb\u7edf\u8303\u56f4\u7684\u914d\u7f6e</li> <li><code>label</code> \u6307\u4ee4\u5bf9\u5185\u90e8\u8def\u7531\u7684\u8f93\u51fa\u548c\u8fc7\u6ee4\u5668\u8fdb\u884c\u5206\u7ec4</li> <li><code>@include</code> \u6307\u4ee4\u5305\u542b\u5176\u4ed6\u6587\u4ef6</li> </ul>"},{"location":"chap10/19Fluentd/#source","title":"source","text":"<p>\u901a\u8fc7\u4f7f\u7528 <code>source</code> \u6307\u4ee4\u9009\u62e9\u548c\u914d\u7f6e\u6240\u9700\u7684\u8f93\u5165\u63d2\u4ef6\u6765\u542f\u7528 Fluentd \u8f93\u5165\u6e90\uff0cFluentd \u6807\u51c6\u8f93\u5165\u63d2\u4ef6\u5305\u62ec http \u548c forward\u3002</p> <p>http \u63d0\u4f9b\u4e86\u4e00\u4e2a HTTP \u7aef\u70b9\u6765\u63a5\u53d7\u4f20\u5165\u7684 HTTP \u6d88\u606f\uff0c\u800c forward \u63d0\u4f9b\u4e86\u4e00\u4e2a TCP \u7aef\u70b9\u6765\u63a5\u53d7 TCP \u6570\u636e\u5305\u3002\u5f53\u7136\uff0c\u4e5f\u53ef\u4ee5\u540c\u65f6\u662f\u4e24\u8005\u3002\u4f8b\u5982\uff1a</p> <pre><code># \u572824224\u7aef\u53e3\u63a5\u53d7TCP\u4e8b\u4ef6\n\n&lt;source&gt;\n\n@type forward\n\nport 24224\n\n&lt;/source&gt;\n\n\n\n# http://&lt;ip&gt;:9880/myapp.access?json={\"event\":\"data\"}\n\n&lt;source&gt;\n\n@type http\n\nport 9880\n\n&lt;/source&gt;\n</code></pre> <p>\u8f93\u5165\u6e90\u53ef\u4ee5\u4e00\u6b21\u6307\u5b9a\u591a\u4e2a\uff0c<code>@type</code> \u53c2\u6570\u7528\u6765\u6307\u5b9a\u8f93\u5165\u63d2\u4ef6\uff0c\u8f93\u5165\u63d2\u4ef6\u6269\u5c55\u4e86 Fluentd\uff0c\u4ee5\u68c0\u7d22\u548c\u63d0\u53d6\u6765\u81ea\u5916\u90e8\u7684\u65e5\u5fd7\u4e8b\u4ef6\uff0c\u4e00\u4e2a\u8f93\u5165\u63d2\u4ef6\u901a\u5e38\u521b\u5efa\u4e00\u4e2a\u7ebf\u7a0b\u3001\u5957\u63a5\u5b57\u548c\u4e00\u4e2a\u76d1\u542c\u5957\u63a5\u5b57\uff0c\u5b83\u4e5f\u53ef\u4ee5\u88ab\u5199\u6210\u5b9a\u671f\u4ece\u6570\u636e\u6e90\u4e2d\u63d0\u53d6\u6570\u636e\u3002Fluentd \u652f\u6301\u975e\u5e38\u591a\u79cd\u8f93\u5165\u63d2\u4ef6\uff0c\u5305\u62ec\uff1a</p> <ul> <li><code>in_tail</code></li> <li><code>in_forward</code></li> <li><code>in_udp</code></li> <li><code>in_tcp</code></li> <li><code>in_unix</code></li> <li><code>in_http</code></li> <li><code>in_syslog</code></li> <li><code>in_exec</code></li> <li><code>in_sample</code></li> <li><code>in_windows_eventlog</code></li> </ul> <p>tail \u63d2\u4ef6\u5e94\u8be5\u662f\u5e73\u65f6\u6211\u4eec\u4f7f\u7528\u5f97\u6700\u591a\u7684\u8f93\u5165\u63d2\u4ef6\u4e86\uff0c<code>in_tail</code> \u8f93\u5165\u63d2\u4ef6\u5141\u8bb8 Fluentd \u4ece\u6587\u672c\u6587\u4ef6\u7684\u5c3e\u90e8\u8bfb\u53d6\u4e8b\u4ef6\uff0c\u5176\u884c\u4e3a\u7c7b\u4f3c\u4e8e <code>tail -F</code> \u547d\u4ee4\uff0c\u6bd4\u5982\u4e0b\u9762\u7684\u914d\u7f6e\u5c31\u5b9a\u4e49\u4e86\u8f93\u5165\u63d2\u4ef6\u4e3a tail\uff0c\u5176\u4e2d\u7684 path \u5c5e\u6027\u6307\u5b9a\u4e86\u65e5\u5fd7\u7684\u6e90\u8def\u5f84\uff1a</p> <pre><code>&lt;source&gt;\n\n@type tail\n\npath /var/log/httpd-access.log\n\npos_file /var/log/td-agent/httpd-access.log.pos\n\ntag apache.access\n\n&lt;parse&gt;\n\n@type apache2\n\n&lt;/parse&gt;\n\n&lt;/source&gt;\n</code></pre> <p>\u5f53 Fluentd \u7b2c\u4e00\u6b21\u88ab\u914d\u7f6e\u4e3a <code>in_tail</code> \u65f6\uff0c\u5b83\u5c06\u4ece\u8be5\u65e5\u5fd7\u7684\u5c3e\u90e8\u5f00\u59cb\u8bfb\u53d6\uff0c\u800c\u4e0d\u662f\u4ece\u5f00\u59cb\uff0c\u4e00\u65e6\u65e5\u5fd7\u88ab\u8f6e\u8f6c\uff0cFluentd \u5c31\u4f1a\u4ece\u5934\u5f00\u59cb\u8bfb\u53d6\u65b0\u6587\u4ef6\uff0c\u5b83\u4fdd\u6301\u7740\u5bf9\u5f53\u524d inode \u53f7\u7684\u8ddf\u8e2a\u3002</p> <p>\u5982\u679c Fluentd \u91cd\u65b0\u542f\u52a8\uff0c\u5b83\u4f1a\u4ece\u91cd\u65b0\u542f\u52a8\u524d\u7684\u6700\u540e\u4e00\u4e2a\u4f4d\u7f6e\u7ee7\u7eed\u8bfb\u53d6\uff0c\u8fd9\u4e2a\u4f4d\u7f6e\u8bb0\u5f55\u5728 `pos_file`` \u53c2\u6570\u6307\u5b9a\u7684\u4f4d\u7f6e\u6587\u4ef6\u4e2d\u3002</p>"},{"location":"chap10/19Fluentd/#match","title":"match","text":"<p>match \u7528\u6765\u6307\u5b9a\u65e5\u5fd7\u7684\u8f93\u51fa\u76ee\u7684\u5730\uff0c\u4f8b\u5982\uff1a</p> <pre><code># \u5c06\u6ee1\u8db3 myapp.acccess \u6807\u7b7e\u7684\u4e8b\u4ef6\u5168\u90e8\u8f93\u51fa\u5230\n\n# /var/log/fluent/access.%Y-%m-%d\n\n&lt;match myapp.access&gt;\n\n@type file\n\npath /var/log/fluent/access\n\n&lt;/match&gt;\n</code></pre> <p>\u540c\u6837\u8f93\u51fa\u4e5f\u53ef\u4ee5\u4e00\u6b21\u6307\u5b9a\u591a\u4e2a\uff0c<code>@type</code> \u53c2\u6570\u6307\u5b9a\u4f7f\u7528\u54ea\u4e00\u4e2a\u8f93\u51fa\u63d2\u4ef6\u3002 </p> <p>Fluentd \u8f93\u51fa\u63d2\u4ef6\u5177\u6709\u4e09\u79cd\u7f13\u51b2\u548c\u5237\u65b0\u6a21\u5f0f\uff1a</p> <ul> <li>\u975e\u7f13\u51b2\u6a21\u5f0f\u4e0d\u5bf9\u6570\u636e\u8fdb\u884c\u7f13\u51b2\uff0c\u800c\u662f\u7acb\u5373\u8f93\u51fa\u7ed3\u679c</li> <li>\u540c\u6b65\u7f13\u51b2\u6a21\u5f0f \u6709\u4e00\u4e2a\u6682\u5b58\u7684 staged \u7684\u7f13\u51b2\u5757 chunks\uff08\u4e00\u4e2a chunk \u662f\u4e00\u4e2a\u4e8b\u4ef6\u7684\u96c6\u5408\uff09\u548c\u4e00\u4e2a chunk \u961f\u5217\uff0c\u5176\u884c\u4e3a\u53ef\u4ee5\u7531 <code>&lt;buffer&gt;</code>  \u90e8\u5206\u63a7\u5236</li> <li>\u5f02\u6b65\u7f13\u51b2\u6a21\u5f0f\u4e5f\u6709\u6682\u5b58\u548c\u961f\u5217\uff0c\u4f46\u8f93\u51fa\u63d2\u4ef6\u4e0d\u4f1a\u5728\u65b9\u6cd5\u4e2d\u540c\u6b65\u63d0\u4ea4\u5199\u5757\uff0c\u800c\u662f\u7a0d\u540e\u63d0\u4ea4</li> </ul> <p></p> <p>\u8f93\u51fa\u63d2\u4ef6\u53ef\u4ee5\u652f\u6301\u6240\u6709\u7684\u6a21\u5f0f\uff0c\u4f46\u53ef\u80fd\u53ea\u652f\u6301\u5176\u4e2d\u4e00\u79cd\u6a21\u5f0f\uff0c\u5982\u679c\u914d\u7f6e\u4e2d\u6ca1\u6709 <code>&lt;buffer&gt;</code> \u90e8\u5206\uff0cFluentd \u4f1a\u81ea\u52a8\u9009\u62e9\u5408\u9002\u7684\u6a21\u5f0f\u3002\u540c\u6837 Fluentd \u652f\u6301\u591a\u79cd\u8f93\u51fa\u63d2\u4ef6, \u6bd4\u5982:</p> <ul> <li><code>out_copy</code></li> <li><code>out_null</code></li> <li><code>out_roundrobin</code></li> <li><code>out_stdout</code></li> <li><code>out_exec_filter</code></li> <li><code>out_forward</code></li> <li><code>out_mongo / out_mongo_replset</code></li> <li><code>out_exec</code></li> <li><code>out_file</code></li> <li><code>out_s3</code></li> <li><code>out_webhdfs</code></li> <li>......</li> </ul> <p>\u6bd4\u5982\u6211\u4eec\u4f7f\u7528 <code>out_file</code> \u4f5c\u4e3a\u8f93\u51fa\u76ee\u7684\u5730\u63d2\u4ef6\uff0c<code>out_file</code> \u8f93\u51fa\u63d2\u4ef6\u5c06\u4e8b\u4ef6\u5199\u5165\u6587\u4ef6\u3002\u5f53\u6ee1\u8db3 <code>timekey</code> \u6761\u4ef6\u65f6\uff0c\u5c06\u521b\u5efa\u8be5\u6587\u4ef6\uff0c\u8981\u6539\u53d8\u8f93\u51fa\u9891\u7387\uff0c\u9700\u8981\u4fee\u6539 timekey \u7684\u503c\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>&lt;match pattern&gt;\n\n@type file\n\npath /var/log/fluent/myapp\n\ncompress gzip\n\n&lt;buffer&gt;\n\ntimekey 1d\n\ntimekey_use_utc true\n\ntimekey_wait 10m\n\n&lt;/buffer&gt;\n\n&lt;/match&gt;\n</code></pre>"},{"location":"chap10/19Fluentd/#filter_1","title":"filter","text":"<p>\u4f7f\u7528 filter \u53ef\u4ee5\u6307\u5b9a\u4e8b\u4ef6\u7684\u5904\u7406\u6d41\u7a0b\uff0c\u591a\u4e2a filter \u53ef\u4ee5\u4e32\u8054\u8d77\u6765\u4f7f\u7528\uff1a</p> <pre><code>Input -&gt; filter 1 -&gt; ... -&gt; filter N -&gt; Output\n</code></pre> <p>\u6bd4\u5982\u6211\u4eec\u6dfb\u52a0\u4e00\u4e2a\u6807\u51c6\u7684 <code>record_transformer</code> \u8fc7\u6ee4\u5668\u6765\u5339\u914d\u4e8b\u4ef6\u3002</p> <pre><code># http://this.host:9880/myapp.access?json={\"event\":\"data\"}\n\n&lt;source&gt;\n\n@type http\n\nport 9880\n\n&lt;/source&gt;\n\n\n\n&lt;filter myapp.access&gt;\n\n@type record_transformer\n\n&lt;record&gt;\n\nhost_param \"#{Socket.gethostname}\"\n\n&lt;/record&gt;\n\n&lt;/filter&gt;\n\n\n\n&lt;match myapp.access&gt;\n\n@type file\n\npath /var/log/fluent/access\n\n&lt;/match&gt;\n</code></pre> <p></p> <p>\u63a5\u6536\u5230\u7684\u4e8b\u4ef6 <code>{\"event\":\"data\"}</code> \u9996\u5148\u8fdb\u5165 <code>record_transformer</code> \u8fc7\u6ee4\u5668\uff0c\u8be5\u8fc7\u6ee4\u5668\u5c06 <code>host_param</code> \u5b57\u6bb5\u6dfb\u52a0\u5230\u4e8b\u4ef6\u4e2d\uff0c\u7136\u540e\u8fc7\u6ee4\u540e\u7684\u4e8b\u4ef6\u53d8\u4e3a <code>{\"event\":\"data\",\"host_param\":\"webserver1\"}</code> \u8fdb\u5165 <code>file</code> \u6587\u4ef6\u8f93\u51fa\u63d2\u4ef6\u3002</p>"},{"location":"chap10/19Fluentd/#system","title":"system","text":"<p>\u7cfb\u7edf\u8303\u56f4\u7684\u914d\u7f6e\u7531 system \u6307\u4ee4\u8bbe\u7f6e\uff0c\u5b83\u4eec\u4e2d\u7684\u5927\u591a\u6570\u4e5f\u53ef\u4ee5\u901a\u8fc7\u547d\u4ee4\u884c\u9009\u9879\u83b7\u5f97\u3002\u4f8b\u5982\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u914d\u7f6e\uff1a</p> <ul> <li><code>log_level</code></li> <li><code>suppress_repeated_stacktrace</code></li> <li><code>emit_error_log_interval</code></li> <li><code>suppress_config_dump</code></li> <li><code>without_source</code></li> <li><code>process_name</code> (\u4ec5\u5728 system \u6307\u4ee4\u4e2d\u53ef\u7528\uff0c\u6ca1\u6709 fluentd \u9009\u9879)</li> </ul> <p>\u4f8b\u5982\u4e0b\u9762\u7684\u914d\u7f6e\uff1a</p> <pre><code>&lt;system&gt;\n\n# \u7b49\u540c\u4e8e -qq \u9009\u9879\n\nlog_level error\n\n# \u7b49\u540c\u4e8e --without-source \u9009\u9879\n\nwithout_source\n\n# ...\n\n&lt;/system&gt;\n</code></pre> <p>\u6b64\u5916\u5982\u679c\u8bbe\u7f6e\u4e86 <code>process_name</code> \u53c2\u6570\uff0c\u5219 <code>fluentd supervisor</code> \u548c\u5de5\u4f5c\u8fdb\u7a0b\u540d\u79f0\u5c06\u66f4\u6539\u3002</p> <pre><code>&lt;system&gt;\n\nprocess_name fluentd1\n\n&lt;/system&gt;\n</code></pre> <p>\u4f7f\u7528\u6b64\u914d\u7f6e\uff0cps \u547d\u4ee4\u663e\u793a\u4ee5\u4e0b\u7ed3\u679c\uff1a</p> <pre><code>% ps aux | grep fluentd1\n\nfoo 45673 0.4 0.2 2523252 38620 s001 S+ 7:04AM 0:00.44 worker:fluentd1\n\nfoo 45647 0.0 0.1 2481260 23700 s001 S+ 7:04AM 0:00.40 supervisor:fluentd1\n</code></pre>"},{"location":"chap10/19Fluentd/#label","title":"label","text":"<p><code>label</code> \u6307\u4ee4\u53ef\u4ee5\u5bf9\u5185\u90e8\u8def\u7531\u7684\u8fc7\u6ee4\u5668\u548c\u8f93\u51fa\u8fdb\u884c\u5206\u7ec4\uff0c<code>label</code> \u964d\u4f4e\u4e86 <code>tag</code> \u5904\u7406\u7684\u590d\u6742\u6027\u3002 label \u53c2\u6570\u662f\u5185\u7f6e\u63d2\u4ef6\u53c2\u6570\uff0c\u56e0\u6b64\u9700\u8981 <code>@</code> \u524d\u7f00\u3002\u4f8b\u5982\u4e0b\u9762\u7684\u914d\u7f6e\u793a\u4f8b\uff1a</p> <pre><code>&lt;source&gt;\n\n@type forward\n\n&lt;/source&gt;\n\n\n\n&lt;source&gt;\n\n@type tail\n\n@label @SYSTEM\n\n&lt;/source&gt;\n\n\n\n&lt;filter access.**&gt;\n\n@type record_transformer\n\n&lt;record&gt;\n\n# ...\n\n&lt;/record&gt;\n\n&lt;/filter&gt;\n\n\n\n&lt;match **&gt;\n\n@type elasticsearch\n\n# ...\n\n&lt;/match&gt;\n\n\n\n&lt;label @SYSTEM&gt;\n\n&lt;filter var.log.middleware.**&gt;\n\n@type grep\n\n# ...\n\n&lt;/filter&gt;\n\n&lt;match **&gt;\n\n@type s3\n\n# ...\n\n&lt;/match&gt;\n\n&lt;/label&gt;\n</code></pre> <p></p> <p>\u5728\u8be5\u914d\u7f6e\u4e2d\uff0cforward \u4e8b\u4ef6\u88ab\u8def\u7531\u5230<code>record_transformer</code> \u8fc7\u6ee4\u5668\uff0c\u7136\u540e\u8f93\u51fa\u5230 elasticsearch\uff0c\u800c <code>in_tail</code> \u4e8b\u4ef6\u88ab\u8def\u7531\u5230 <code>@SYSTEM</code> \u6807\u7b7e\u5185\u7684 <code>grep</code> \u8fc7\u6ee4\u5668\uff0c\u7136\u540e\u8f93\u51fa\u5230 s3\u3002</p> <p>label \u53c2\u6570\u5bf9\u4e8e\u6ca1\u6709 tag \u524d\u7f00\u7684\u4e8b\u4ef6\u6d41\u5206\u79bb\u5f88\u6709\u7528\u3002</p> <p><code>@ERROR</code> \u6807\u7b7e\u662f\u4e00\u4e2a\u5185\u7f6e\u6807\u7b7e\uff0c\u7528\u4e8e\u63d2\u4ef6\u7684 <code>emit_error_event API</code> \u53d1\u51fa\u7684\u9519\u8bef\u8bb0\u5f55\u3002\u5982\u679c\u8bbe\u7f6e\u4e86 <code>&lt;label @ERROR&gt;</code>\uff0c\u5219\u5728\u53d1\u51fa\u76f8\u5173\u9519\u8bef\u65f6\u5c06\u4e8b\u4ef6\u8def\u7531\u5230\u6b64\u6807\u7b7e\uff0c\u4f8b\u5982\u7f13\u51b2\u533a\u5df2\u6ee1\u6216\u8bb0\u5f55\u65e0\u6548\u3002</p> <p><code>@ROOT</code> \u6807\u7b7e\u4e5f\u662f\u4e00\u4e2a\u5185\u7f6e\u6807\u7b7e\uff0c\u7528\u4e8e\u901a\u8fc7\u63d2\u4ef6\u7684 <code>event_emitter_router</code> API \u83b7\u53d6\u6839\u8def\u7531\u5668\u3002\u4ece v1.14.0 \u5f00\u59cb\u5f15\u5165\u6b64\u6807\u7b7e\uff0c\u4ee5\u5c06\u6807\u7b7e\u5206\u914d\u56de\u9ed8\u8ba4\u8def\u7531\uff0c\u4f8b\u5982\uff0c\u7531 concat \u8fc7\u6ee4\u5668\u5904\u7406\u7684\u8d85\u65f6\u4e8b\u4ef6\u8bb0\u5f55\u53ef\u4ee5\u53d1\u9001\u5230\u9ed8\u8ba4\u8def\u7531\u3002</p>"},{"location":"chap10/19Fluentd/#include","title":"<code>@include</code>","text":"<p>\u4f7f\u7528 <code>@include</code> \u6307\u4ee4\u53ef\u4ee5\u5bfc\u5165\u5355\u72ec\u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u6307\u4ee4\uff0c\u4f8b\u5982\uff1a</p> <pre><code># \u5305\u542b ./config.d \u76ee\u5f55\u4e2d\u7684\u6240\u6709\u914d\u7f6e\u6587\u4ef6\n\n@include config.d/*.conf\n</code></pre> <p><code>@include</code> \u6307\u4ee4\u652f\u6301\u5e38\u89c4\u6587\u4ef6\u8def\u5f84\u3001glob \u6a21\u5f0f\u548c http URL \u7ea6\u5b9a\uff1a</p> <pre><code># \u7edd\u5bf9\u8def\u5f84\n\n@include /path/to/config.conf\n\n\n\n# \u5982\u679c\u4f7f\u7528\u76f8\u5bf9\u8def\u5f84\uff0c\u6307\u4ee4\u5c06\u4f7f\u7528\u6b64\u914d\u7f6e\u6587\u4ef6\u7684\u76ee\u5f55\u540d\u6765\u6269\u5c55\u8def\u5f84\n\n@include extra.conf\n\n\n\n# glob \u5339\u914d\u6a21\u5f0f\n\n@include config.d/*.conf\n\n\n\n# http\n\n@include http://example.com/fluent.conf\n</code></pre>"},{"location":"chap10/19Fluentd/#parse","title":"parse","text":"<p>\u4e00\u4e9b Fluentd \u63d2\u4ef6\u652f\u6301 <code>&lt;parse&gt;</code> \u6307\u4ee4\u6765\u6307\u5b9a\u5982\u4f55\u89e3\u6790\u539f\u59cb\u65e5\u5fd7\u6570\u636e\u3002<code>&lt;parse&gt;</code> \u6307\u4ee4\u53ef\u4ee5\u5728 <code>&lt;source&gt;</code>\u3001<code>&lt;match&gt;</code> \u6216<code>&lt;filter&gt;</code> \u4e0b\u914d\u7f6e\uff0c\u4f8b\u5982\uff1a</p> <pre><code>\n&lt;source&gt;\n\n@type tail\n\npath /path/to/input/file\n\n&lt;parse&gt;\n\n@type nginx\n\nkeep_time_key true\n\n&lt;/parse&gt;\n\n&lt;/source&gt;\n</code></pre> <p><code>&lt;parse&gt;</code> \u4e2d\u901a\u8fc7 <code>@type</code> \u53c2\u6570\u6765\u6307\u5b9a\u89e3\u6790\u5668\u63d2\u4ef6\u7684\u7c7b\u578b\u3002<code>Fluentd</code> \u5185\u7f6e\u4e86\u4e00\u4e9b\u6709\u7528\u7684\u89e3\u6790\u5668\u63d2\u4ef6\uff0c\u5305\u62ec\uff1a</p> <ul> <li>regexp</li> <li>apache2</li> <li><code>apache_error</code></li> <li>nginx</li> <li>syslog</li> <li>csv</li> <li>tsv</li> <li>ltsv</li> <li>json</li> <li>multiline</li> <li>none</li> </ul> <p>\u8fd8\u6709\u4e00\u4e9b\u7b2c\u4e09\u65b9\u7684\u89e3\u6790\u5668\u63d2\u4ef6\uff1a</p> <ul> <li>grok\uff1a\u5982\u679c\u4f60\u719f\u6089 grok \u6a21\u5f0f\uff0c\u5219 grok-parser \u63d2\u4ef6\u5f88\u6709\u7528</li> <li>multi-format-parser\uff1a\u5982\u679c\u4f60\u9700\u8981\u5728\u4e00\u4e2a\u6570\u636e\u6d41\u4e2d\u89e3\u6790\u591a\u79cd\u683c\u5f0f\uff0c\u90a3\u4e48\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e2a\u89e3\u6790\u5668</li> <li>protobuf\uff1aprotocol buffers</li> <li>avro\uff1aApache Avro</li> </ul> <p>\u6bd4\u5982\u6211\u4eec\u7684\u65e5\u5fd7\u4e8b\u4ef6\u4e2d\u6709\u5305\u542b\u591a\u884c\u65e5\u5fd7\u7684\u6570\u636e\uff0c\u90a3\u4e48\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528 multiline \u8fd9\u4e2a\u89e3\u6790\u5668\u6765\u89e3\u51b3\uff0c\u8be5\u63d2\u4ef6\u53ef\u4ee5\u7528\u6765\u89e3\u6790\u591a\u884c\u65e5\u5fd7\u3002\u8fd9\u4e2a\u63d2\u4ef6\u662f\u6b63\u5219\u8868\u8fbe\u5f0f\u89e3\u6790\u5668\u7684\u591a\u884c\u7248\u672c\u3002</p> <p>\u591a\u884c\u89e3\u6790\u5668\u4f7f\u7528 <code>formatN</code> \u548c <code>format_firstline</code> \u53c2\u6570\u89e3\u6790\u65e5\u5fd7\uff0c<code>format_firstline</code> \u7528\u4e8e\u68c0\u6d4b\u591a\u884c\u65e5\u5fd7\u7684\u8d77\u59cb\u884c\u3002formatN\uff0c\u5176\u4e2d N \u7684\u8303\u56f4\u662f <code>[1..20]</code>\uff0c\u662f\u591a\u884c\u65e5\u5fd7\u7684 Regexp \u683c\u5f0f\u5217\u8868\u3002</p> <p>\u4e0e\u5176\u4ed6\u89e3\u6790\u5668\u63d2\u4ef6\u4e0d\u540c\uff0c\u6b64\u63d2\u4ef6\u9700\u8981\u8f93\u5165\u63d2\u4ef6\u4e2d\u7684\u7279\u6b8a\u4ee3\u7801\uff0c\u4f8b\u5982\u5904\u7406 <code>format_firstline</code>\u3002\u76ee\u524d\uff0c<code>in_tail</code> \u63d2\u4ef6\u9002\u7528\u4e8e\u591a\u884c\uff0c\u4f46\u5176\u4ed6\u8f93\u5165\u63d2\u4ef6\u4e0d\u9002\u7528\u4e8e\u5b83\u3002</p> <p>\u6bd4\u5982\u6709\u4e00\u6761\u5982\u4e0b\u6240\u793a\u7684\u8f93\u5165\u65e5\u5fd7\uff1a</p> <pre><code>\nStarted GET \"/users/123/\" for 127.0.0.1 at 2013-06-14 12:00:11 +0900\n\nProcessing by UsersController#show as HTML\n\nParameters: {\"user_id\"=&gt;\"123\"}\n\nRendered users/show.html.erb within layouts/application (0.3ms)\n\nCompleted 200 OK in 4ms (Views: 3.2ms | ActiveRecord: 0.0ms)\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u6dfb\u52a0\u5982\u4e0b\u6240\u793a\u7684\u914d\u7f6e\u6765\u8fdb\u884c\u89e3\u6790\uff1a</p> <pre><code>&lt;parse&gt;\n\n@type multiline\n\nformat_firstline /^Started/\n\nformat1 /Started (?&lt;method&gt;[^ ]+) \"(?&lt;path&gt;[^\"]+)\" for (?&lt;host&gt;[^ ]+) at (?&lt;time&gt;[^ ]+ [^ ]+ [^ ]+)\\n/\n\nformat2 /Processing by (?&lt;controller&gt;[^\\u0023]+)\\u0023(?&lt;controller_method&gt;[^ ]+) as (?&lt;format&gt;[^ ]+?)\\n/\n\nformat3 /( Parameters: (?&lt;parameters&gt;[^ ]+)\\n)?/\n\nformat4 / Rendered (?&lt;template&gt;[^ ]+) within (?&lt;layout&gt;.+) \\([\\d\\.]+ms\\)\\n/\n\nformat5 /Completed (?&lt;code&gt;[^ ]+) [^ ]+ in (?&lt;runtime&gt;[\\d\\.]+)ms \\(Views: (?&lt;view_runtime&gt;[\\d\\.]+)ms \\| ActiveRecord: (?&lt;ar_runtime&gt;[\\d\\.]+)ms\\)/\n\n&lt;/parse&gt;\n</code></pre> <p>\u5176\u4e2d\u7684 <code>format_firstline /^Started/</code> \u7528\u6765\u6307\u5b9a\u7b2c\u4e00\u884c\u65e5\u5fd7\u7684\u5339\u914d\u89c4\u5219\uff0c<code>formatN</code> \u6307\u5b9a\u540e\u9762\u51e0\u884c\u7684\u5339\u914d\u89c4\u5219\uff0c\u6700\u540e\u53ef\u4ee5\u89e3\u6790\u6210\u5982\u4e0b\u6240\u793a\u7684\u7ed3\u679c\uff1a</p> <pre><code>\ntime:\n\n1371178811 (2013-06-14 12:00:11 +0900)\n\n\n\nrecord:\n\n{\n\n\"method\" :\"GET\",\n\n\"path\" :\"/users/123/\",\n\n\"host\" :\"127.0.0.1\",\n\n\"controller\" :\"UsersController\",\n\n\"controller_method\":\"show\",\n\n\"format\" :\"HTML\",\n\n\"parameters\" :\"{ \\\"user_id\\\":\\\"123\\\"}\",\n\n...\n\n}\n</code></pre> <p>\u540c\u6837\u6709\u5982\u4e0b\u6240\u793a\u7684 JAVA \u65e5\u5fd7\u4e8b\u4ef6\uff1a</p> <pre><code>\n2013-3-03 14:27:33 [main] INFO Main - Start\n\n2013-3-03 14:27:33 [main] ERROR Main - Exception\n\njavax.management.RuntimeErrorException: null\n\nat Main.main(Main.java:16) ~[bin/:na]\n\n2013-3-03 14:27:33 [main] INFO Main - End\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u914d\u7f6e\u6765\u89e3\u6790\uff1a</p> <pre><code>&lt;parse&gt;\n\n@type multiline\n\nformat_firstline /\\d{4}-\\d{1,2}-\\d{1,2}/\n\nformat1 /^(?&lt;time&gt;\\d{4}-\\d{1,2}-\\d{1,2} \\d{1,2}:\\d{1,2}:\\d{1,2}) \\[(?&lt;thread&gt;.*)\\] (?&lt;level&gt;[^\\s]+)(?&lt;message&gt;.*)/\n\n&lt;/parse&gt;\n</code></pre> <p>\u8fd9\u6837\u5c31\u53ef\u4ee5\u89e3\u6790\u6210\u5982\u4e0b\u6240\u793a\u7684\u7ed3\u679c\u4e86\uff1a</p> <pre><code>time:\n\n2013-03-03 14:27:33 +0900\n\nrecord:\n\n{\n\n\"thread\" :\"main\",\n\n\"level\" :\"INFO\",\n\n\"message\":\" Main - Start\"\n\n}\n\n\n\ntime:\n\n2013-03-03 14:27:33 +0900\n\nrecord:\n\n{\n\n\"thread\" :\"main\",\n\n\"level\" :\"ERROR\",\n\n\"message\":\" Main - Exception\\njavax.management.RuntimeErrorException: null\\n at Main.main(Main.java:16) ~[bin/:na]\"\n\n}\n\n\n\ntime:\n\n2013-03-03 14:27:33 +0900\n\nrecord:\n\n{\n\n\"thread\" :\"main\",\n\n\"level\" :\"INFO\",\n\n\"message\":\" Main - End\"\n\n}\n</code></pre>"},{"location":"chap10/19Fluentd/#_5","title":"\u6a21\u5f0f\u5339\u914d","text":"<p>\u5982\u4e0a\u6240\u8ff0\uff0cFluentd \u5141\u8bb8\u4f60\u6839\u636e\u4e8b\u4ef6\u7684 tag \u6765\u8def\u7531\u4e8b\u4ef6\uff0c\u6211\u4eec\u53ef\u4ee5\u660e\u786e\u6307\u5b9a\u9700\u8981\u5904\u7406\u7684 tag\uff0c\u6bd4\u5982 <code>&lt;filter app.log&gt;</code> \u6765\u6307\u5b9a\u53ea\u5904\u7406 <code>tag</code> \u4e3a <code>app.log</code> \u7684\u4e8b\u4ef6\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u5728 <code>filter</code> \u548c <code>match</code> \u4e2d\u901a\u8fc7\u901a\u914d\u7b26\uff0c\u6765\u5904\u7406\u540c\u4e00\u7c7b <code>tag</code> \u7684\u4e8b\u4ef6\u3002</p> <p>tag \u901a\u5e38\u662f\u4e00\u4e2a\u5b57\u7b26\u4e32\uff0c\u7531 <code>.</code> \u5206\u9694\uff0c\u6bd4\u5982 <code>myapp.access</code>\uff1a</p> <ul> <li><code>*</code>: \u5339\u914d\u6ee1\u8db3\u4e00\u4e2a tag \u90e8\u5206\u7684\u4e8b\u4ef6, \u6bd4\u5982: <code>a.*</code> \u5c06\u5339\u914d a.b \u8fd9\u6837\u7684 tag, \u4f46\u662f\u4e0d\u4f1a\u5904\u7406 a \u6216\u8005 a.b.c \u8fd9\u7c7b tag</li> <li><code>**</code>: \u5339\u914d\u6ee1\u8db3 0 \u4e2a\u6216\u591a\u4e2a tag \u90e8\u5206\u7684\u4e8b\u4ef6\uff0c\u6bd4\u5982 <code>a.**</code> \u5c06\u5339\u914d a\u3001a.b\u3001a.b.c \u8fd9\u4e09\u79cd tag</li> <li><code>{X, Y, Z}</code>: \u5339\u914d\u6ee1\u8db3 X\u3001Y \u6216\u8005 Z \u7684 tag\uff0c\u6bd4\u5982<code>{a, b}</code> \u5c06\u5339\u914d a \u6216\u8005 b\uff0c\u4f46\u662f\u4e0d\u4f1a\u5339\u914d c\uff0c\u8fd9\u79cd\u683c\u5f0f\u4e5f\u53ef\u4ee5\u548c\u901a\u914d\u7b26\u7ec4\u5408\u4f7f\u7528,\u6bd4\u5982 <code>a.{b.c}.*</code> \u6216 <code>a.{b.c}.**</code></li> <li><code>#{...}</code> \u4f1a\u628a\u82b1\u62ec\u53f7\u5185\u7684\u5b57\u7b26\u4e32\u5f53\u505a\u662f ruby \u7684\u8868\u8fbe\u5f0f\u5904\u7406\u3002\u6bd4\u5982</li> </ul> <pre><code>&lt;match \"app.#{ENV['FLUENTD_TAG']}\"&gt;\n\n@type stdout\n\n&lt;/match&gt;\n</code></pre> <p>\u5982\u679c\u8bbe\u7f6e\u4e86\u73af\u5883\u53d8\u91cf <code>FLUENTD_TAG</code> \u4e3a dev\uff0c\u90a3\u4e0a\u9762\u7b49\u4ef7\u4e8e <code>app.dev</code>\u3002</p> <p>\u5f53\u6307\u5b9a\u4e86\u591a\u4e2a\u6a21\u5f0f\u65f6\uff08\u4f7f\u7528\u4e00\u4e2a\u6216\u591a\u4e2a\u7a7a\u683c\u5206\u5f00\uff09\uff0c\u53ea\u8981\u6ee1\u8db3\u5176\u4e2d\u4efb\u610f\u4e00\u4e2a\u5c31\u884c\u3002\u6bd4\u5982: <code>&lt;match a b&gt;</code> \u5339\u914d a \u548c b\uff0c<code>&lt;match a.** b.*&gt;</code> \u5339\u914d <code>a, a.b, a.b.c, b.d</code> \u7b49</p> <p>\u5f53\u6709\u591a\u4e2a match\uff0c\u9700\u8981\u6ce8\u610f\u4e00\u4e0b\u5b83\u4eec\u7684\u987a\u5e8f\uff0c\u5982\u4e0b\u9762\u7684\u4f8b\u5b50\uff0c\u7b2c\u4e8c\u4e2a match \u6c38\u8fdc\u4e5f\u4e0d\u4f1a\u751f\u6548\uff1a</p> <pre><code># ** \u5339\u914d\u6240\u6709\u7684 tags. Bad :(\n\n&lt;match **&gt;\n\n@type blackhole_plugin\n\n&lt;/match&gt;\n\n\n\n&lt;match myapp.access&gt;\n\n@type file\n\npath /var/log/fluent/access\n\n&lt;/match&gt;\n</code></pre> <p>\u6b63\u786e\u7684\u5199\u6cd5\u5e94\u8be5\u662f\u5c06\u786e\u5b9a\u7684 tag \u5c3d\u91cf\u5199\u5728\u524d\u9762\uff0c\u6a21\u7cca\u5339\u914d\u7684\u5199\u5728\u540e\u9762\u3002</p> <pre><code>&lt;match myapp.access&gt;\n\n@type file\n\npath /var/log/fluent/access\n\n&lt;/match&gt;\n\n\n\n# Capture all unmatched tags. Good :)\n\n&lt;match **&gt;\n\n@type blackhole_plugin\n\n&lt;/match&gt;\n</code></pre> <p>\u53e6\u5916\u9700\u8981\u6ce8\u610f\u987a\u5e8f\u7684\u662f filter \u548c match\uff0c\u5982\u679c\u5c06 filter \u653e\u5728 match \u4e4b\u540e\uff0c\u90a3\u4e48\u5b83\u4e5f\u6c38\u8fdc\u4e0d\u4f1a\u751f\u6548\u3002</p> <p>\u5173\u4e8e Fluentd \u7684\u66f4\u591a\u4f7f\u7528\u914d\u7f6e\u53ef\u4ee5\u53c2\u8003\u5b98\u65b9\u6587\u6863\u4e86\u89e3\u66f4\u591a\u4fe1\u606f https://docs.fluentd.org \u3002</p>"},{"location":"chap10/1log_architecture/","title":"\u7b2c\u4e00\u8282 kubernetes \u65e5\u5fd7\u67b6\u6784","text":""},{"location":"chap10/1log_architecture/#1","title":"1\u3001\u4ecb\u7ecd","text":"<p>\u5e94\u7528\u7a0b\u5e8f\u548c\u7cfb\u7edf\u65e5\u5fd7\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u4e86\u89e3\u96c6\u7fa4\u5185\u90e8\u7684\u8fd0\u884c\u60c5\u51b5\uff0c\u65e5\u5fd7\u5bf9\u4e8e\u6211\u4eec\u8c03\u8bd5\u95ee\u9898\u548c\u76d1\u89c6\u96c6\u7fa4\u60c5\u51b5\u4e5f\u662f\u975e\u5e38\u6709\u7528\u7684\u3002 \u800c\u4e14\u5927\u90e8\u5206\u7684\u5e94\u7528\u90fd\u4f1a\u6709\u65e5\u5fd7\u8bb0\u5f55\uff0c\u5bf9\u4e8e\u4f20\u7edf\u7684\u5e94\u7528\u5927\u90e8\u5206\u90fd\u4f1a\u5199\u5165\u5230\u672c\u5730\u7684\u65e5\u5fd7\u6587\u4ef6\u4e4b\u4e2d\u3002</p> <p>\u5bf9\u4e8e\u5bb9\u5668\u5316\u5e94\u7528\u7a0b\u5e8f\u6765\u8bf4\u5219\u66f4\u7b80\u5355\uff0c\u53ea\u9700\u8981\u5c06\u65e5\u5fd7\u4fe1\u606f\u5199\u5165\u5230 <code>stdout</code> \u548c <code>stderr</code> \u5373\u53ef\uff0c\u5bb9\u5668\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u5c31\u4f1a\u628a\u8fd9\u4e9b\u65e5\u5fd7\u8f93\u51fa\u5230\u5bbf\u4e3b\u673a\u4e0a\u7684\u4e00\u4e2a <code>JSON</code> \u6587\u4ef6\u4e4b\u4e2d\uff0c\u540c\u6837\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7 <code>docker logs</code> \u6216\u8005 <code>kubectl logs</code> \u6765\u67e5\u770b\u5230\u5bf9\u5e94\u7684\u65e5\u5fd7\u4fe1\u606f\u3002</p> <p>stderr\u4e0estdout\u7684\u533a\u522b: </p> <p>stdout\uff08\u6807\u51c6\u8f93\u51fa\uff09\uff0c\u8f93\u51fa\u65b9\u5f0f\u662f\u884c\u7f13\u51b2\u3002\u8f93\u51fa\u7684\u5b57\u7b26\u4f1a\u5148\u5b58\u653e\u5728\u7f13\u51b2\u533a\uff0c\u7b49\u6309\u4e0b\u56de\u8f66\u952e\u65f6\u624d\u8fdb\u884c\u5b9e\u9645\u7684I/O\u64cd\u4f5c\u3002</p> <p>stderr\uff08\u6807\u51c6\u51fa\u9519\uff09\uff0c\u662f\u4e0d\u5e26\u7f13\u51b2\u7684\uff0c\u8fd9\u4f7f\u5f97\u51fa\u9519\u4fe1\u606f\u53ef\u4ee5\u76f4\u63a5\u5c3d\u5feb\u5730\u663e\u793a\u51fa\u6765\u3002</p> <p>\u4f46\u662f\uff0c\u901a\u5e38\u6765\u8bf4\u5bb9\u5668\u5f15\u64ce\u6216\u8fd0\u884c\u65f6\u63d0\u4f9b\u7684\u529f\u80fd\u4e0d\u8db3\u4ee5\u8bb0\u5f55\u5b8c\u6574\u7684\u65e5\u5fd7\u4fe1\u606f\uff0c\u6bd4\u5982\uff0c\u5982\u679c\u5bb9\u5668\u5d29\u6e83\u4e86\u3001Pod \u88ab\u9a71\u9010\u4e86\u6216\u8005\u8282\u70b9\u6302\u6389\u4e86\uff0c\u6211\u4eec\u4ecd\u7136\u4e5f\u5e0c\u671b\u8bbf\u95ee\u5e94\u7528\u7a0b\u5e8f\u7684\u65e5\u5fd7\u3002</p> <p>\u6240\u4ee5\uff0c\u65e5\u5fd7\u5e94\u8be5\u72ec\u7acb\u4e8e\u8282\u70b9\u3001Pod \u6216\u5bb9\u5668\u7684\u751f\u547d\u5468\u671f\uff0c\u8fd9\u79cd\u8bbe\u8ba1\u65b9\u5f0f\u88ab\u79f0\u4e3a <code>cluster-level-logging</code>\uff0c\u5373\u5b8c\u5168\u72ec\u7acb\u4e8e <code>Kubernetes</code> \u7cfb\u7edf\uff0c\u9700\u8981\u81ea\u5df1\u63d0\u4f9b\u5355\u72ec\u7684\u65e5\u5fd7\u540e\u7aef\u5b58\u50a8\u3001\u5206\u6790\u548c\u67e5\u8be2\u5de5\u5177\u3002</p>"},{"location":"chap10/1log_architecture/#2kubernetes","title":"2\u3001Kubernetes \u4e2d\u7684\u57fa\u672c\u65e5\u5fd7","text":"<p>\u4e0b\u9762\u8fd9\u4e2a\u793a\u4f8b\u662f Kubernetes \u4e2d\u7684\u4e00\u4e2a\u57fa\u672c\u65e5\u5fd7\u8bb0\u5f55\u7684\u793a\u4f8b\uff0c\u76f4\u63a5\u5c06\u6570\u636e\u8f93\u51fa\u5230\u6807\u51c6\u8f93\u51fa\u6d41\uff0c\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: counter\nspec:\n  containers:\n  - name: count\n    image: busybox\n    args: [/bin/sh, -c,\n            'i=0; while true; do echo \"$i: $(date)\"; i=$((i+1)); sleep 1; done']\n</code></pre> <p>\u5c06\u4e0a\u9762\u6587\u4ef6\u4fdd\u5b58\u4e3a <code>counter-pod.yaml</code>\uff0c\u8be5 <code>Pod</code> \u6bcf\u79d2\u8f93\u51fa\u4e00\u4e9b\u6587\u672c\u4fe1\u606f\uff0c\u521b\u5efa\u8fd9\u4e2a <code>Pod</code>\uff1a</p> <pre><code>$ kubectl create -f counter-pod.yaml\npod \"counter\" created\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>kubectl logs</code> \u547d\u4ee4\u67e5\u770b\u65e5\u5fd7\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl logs counter\n0: Thu Dec 27 15:47:04 UTC 2018\n1: Thu Dec 27 15:47:05 UTC 2018\n2: Thu Dec 27 15:47:06 UTC 2018\n3: Thu Dec 27 15:47:07 UTC 2018\n......\n</code></pre>"},{"location":"chap10/1log_architecture/#3kubernetes","title":"3\u3001Kubernetes \u65e5\u5fd7\u6536\u96c6","text":"<p>Kubernetes \u96c6\u7fa4\u672c\u8eab\u4e0d\u63d0\u4f9b\u65e5\u5fd7\u6536\u96c6\u7684\u89e3\u51b3\u65b9\u6848\uff0c\u4e00\u822c\u6765\u8bf4\u6709\u4e3b\u8981\u76843\u79cd\u65b9\u6848\u6765\u505a\u65e5\u5fd7\u6536\u96c6\uff1a</p> <ul> <li>\u5728\u8282\u70b9\u4e0a\u8fd0\u884c\u4e00\u4e2a <code>agent</code> \u6765\u6536\u96c6\u65e5\u5fd7   =&gt; DameonSet\u65b9\u5f0f</li> <li>\u5728 <code>Pod</code> \u4e2d\u5305\u542b\u4e00\u4e2a <code>sidecar</code> \u5bb9\u5668\u6765\u6536\u96c6\u5e94\u7528\u65e5\u5fd7 </li> <li>\u76f4\u63a5\u5728\u5e94\u7528\u7a0b\u5e8f\u4e2d\u5c06\u65e5\u5fd7\u4fe1\u606f\u63a8\u9001\u5230\u91c7\u96c6\u540e\u7aef</li> </ul>"},{"location":"chap10/1log_architecture/#3-1","title":"3-1\u8282\u70b9\u65e5\u5fd7\u91c7\u96c6\u4ee3\u7406","text":"<p>\u901a\u8fc7\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u4e00\u4e2a\u65e5\u5fd7\u6536\u96c6\u7684 <code>agent</code> \u6765\u91c7\u96c6\u65e5\u5fd7\u6570\u636e\uff0c\u65e5\u5fd7\u91c7\u96c6 <code>agent</code> \u662f\u4e00\u79cd\u4e13\u7528\u5de5\u5177\uff0c\u7528\u4e8e\u5c06\u65e5\u5fd7\u6570\u636e\u63a8\u9001\u5230\u7edf\u4e00\u7684\u540e\u7aef\u3002</p>"},{"location":"chap10/1log_architecture/#agent","title":"\u4e00\u822c\u6765\u8bf4\uff0c\u8fd9\u79cd <code>agent</code> \u7528\u4e00\u4e2a\u5bb9\u5668\u6765\u8fd0\u884c\uff0c\u53ef\u4ee5\u8bbf\u95ee\u8be5\u8282\u70b9\u4e0a\u6240\u6709\u5e94\u7528\u7a0b\u5e8f\u5bb9\u5668\u7684\u65e5\u5fd7\u6587\u4ef6\u6240\u5728\u76ee\u5f55\u3002","text":""},{"location":"chap10/1log_architecture/#agent-daemonset","title":"\u7531\u4e8e\u8fd9\u79cd <code>agent</code> \u5fc5\u987b\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\uff0c\u6240\u4ee5\u76f4\u63a5\u4f7f\u7528 <code>DaemonSet</code> \u63a7\u5236\u5668\u8fd0\u884c\u8be5\u5e94\u7528\u7a0b\u5e8f\u5373\u53ef\u3002","text":"<p>\u5728\u8282\u70b9\u4e0a\u8fd0\u884c\u4e00\u4e2a\u65e5\u5fd7\u6536\u96c6\u7684 <code>agent</code> \u8fd9\u79cd\u65b9\u5f0f\u662f\u6700\u5e38\u89c1\u7684\u4e00\u76f4\u65b9\u6cd5\uff0c\u56e0\u4e3a\u5b83\u53ea\u9700\u8981\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u4e00\u4e2a\u4ee3\u7406\u7a0b\u5e8f\uff0c\u5e76\u4e0d\u9700\u8981\u5bf9\u8282\u70b9\u4e0a\u8fd0\u884c\u7684\u5e94\u7528\u7a0b\u5e8f\u8fdb\u884c\u66f4\u6539\uff0c\u5bf9\u5e94\u7528\u7a0b\u5e8f\u6ca1\u6709\u4efb\u4f55\u4fb5\u5165\u6027\uff0c\u4f46\u662f\u8fd9\u79cd\u65b9\u6cd5\u4e5f\u4ec5\u4ec5\u9002\u7528\u4e8e\u6536\u96c6\u8f93\u51fa\u5230 <code>stdout</code> \u548c <code>stderr</code> \u7684\u5e94\u7528\u7a0b\u5e8f\u65e5\u5fd7\u3002</p>"},{"location":"chap10/1log_architecture/#3-2-sidecar","title":"3-2 \u4ee5 sidecar \u5bb9\u5668\u6536\u96c6\u65e5\u5fd7","text":"<p>\u6211\u4eec\u770b\u4e0a\u9762\u7684\u56fe\u53ef\u4ee5\u770b\u5230\u6709\u4e00\u4e2a\u660e\u663e\u7684\u95ee\u9898\u5c31\u662f\u6211\u4eec\u91c7\u96c6\u7684\u65e5\u5fd7\u90fd\u662f\u901a\u8fc7\u8f93\u51fa\u5230\u5bb9\u5668\u7684 <code>stdout</code> \u548c <code>stderr</code> \u91cc\u9762\u7684\u4fe1\u606f\uff0c\u8fd9\u4e9b\u4fe1\u606f\u4f1a\u5728\u672c\u5730\u7684\u5bb9\u5668\u5bf9\u5e94\u76ee\u5f55\u4e2d\u4fdd\u7559\u6210 <code>JSON</code> \u65e5\u5fd7\u6587\u4ef6\uff0c\u6240\u4ee5\u76f4\u63a5\u5728\u8282\u70b9\u4e0a\u8fd0\u884c\u4e00\u4e2a <code>agent</code> \u5c31\u53ef\u4ee5\u91c7\u96c6\u5230\u65e5\u5fd7\u3002</p> <p>\u4f46\u662f\u5982\u679c\u6211\u4eec\u7684\u5e94\u7528\u7a0b\u5e8f\u7684\u65e5\u5fd7\u662f\u8f93\u51fa\u5230\u5bb9\u5668\u4e2d\u7684\u67d0\u4e2a\u65e5\u5fd7\u6587\u4ef6\u7684\u8bdd\u5462\uff1f\u8fd9\u79cd\u65e5\u5fd7\u6570\u636e\u663e\u7136\u53ea\u901a\u8fc7\u4e0a\u9762\u7684\u65b9\u6848\u662f\u91c7\u96c6\u4e0d\u5230\u7684\u4e86\u3002</p> <p>\u7528 sidecar \u5bb9\u5668\u91cd\u65b0\u8f93\u51fa\u65e5\u5fd7</p> <p></p> <p>\u5bf9\u4e8e\u4e0a\u9762\u8fd9\u79cd\u60c5\u51b5\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u5728 <code>Pod</code> \u4e2d\u542f\u52a8\u53e6\u5916\u4e00\u4e2a <code>sidecar</code> \u5bb9\u5668\uff0c\u76f4\u63a5\u5c06\u5e94\u7528\u7a0b\u5e8f\u7684\u65e5\u5fd7\u901a\u8fc7\u8fd9\u4e2a\u5bb9\u5668\u91cd\u65b0\u8f93\u51fa\u5230 <code>stdout</code>\uff0c\u8fd9\u6837\u662f\u4e0d\u662f\u901a\u8fc7\u4e0a\u9762\u7684\u8282\u70b9\u65e5\u5fd7\u6536\u96c6\u65b9\u6848\u53c8\u53ef\u4ee5\u5b8c\u6210\u4e86\u3002</p> <p>\u7531\u4e8e\u8fd9\u4e2a <code>sidecar</code> \u5bb9\u5668\u7684\u4e3b\u8981\u903b\u8f91\u5c31\u662f\u5c06\u5e94\u7528\u7a0b\u5e8f\u4e2d\u7684\u65e5\u5fd7\u8fdb\u884c\u91cd\u5b9a\u5411\u6253\u5370\uff0c\u6240\u4ee5\u80cc\u540e\u7684\u903b\u8f91\u975e\u5e38\u7b80\u5355\uff0c\u5f00\u9500\u5f88\u5c0f\uff0c\u800c\u4e14\u7531\u4e8e\u8f93\u51fa\u5230\u4e86 <code>stdout</code> \u6216\u8005 <code>stderr</code>\uff0c\u6240\u4ee5\u6211\u4eec\u4e5f\u53ef\u4ee5\u4f7f\u7528 <code>kubectl logs</code> \u6765\u67e5\u770b\u65e5\u5fd7\u4e86\u3002</p> <p>\u4e0b\u9762\u7684\u793a\u4f8b\u662f\u5728 Pod \u4e2d\u5c06\u65e5\u5fd7\u8bb0\u5f55\u5728\u4e86\u5bb9\u5668\u7684\u4e24\u4e2a\u672c\u5730\u6587\u4ef6\u4e4b\u4e2d\uff1a</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: counter\nspec:\n  containers:\n  - name: count\n    image: busybox\n    args:\n    - /bin/sh\n    - -c\n    - &gt;\n      i=0;\n      while true;\n      do\n        echo \"$i: $(date)\" &gt;&gt; /var/log/1.log;\n        echo \"$(date) INFO $i\" &gt;&gt; /var/log/2.log;\n        i=$((i+1));\n        sleep 1;\n      done\n    volumeMounts:\n    - name: varlog\n      mountPath: /var/log\n  volumes:\n  - name: varlog\n    emptyDir: {}\n</code></pre> <p>\u7531\u4e8e <code>Pod</code> \u4e2d\u5bb9\u5668\u7684\u7279\u6027\uff0c\u6211\u4eec\u53ef\u4ee5\u5229\u7528\u53e6\u5916\u4e00\u4e2a <code>sideca</code>r \u5bb9\u5668\u53bb\u83b7\u53d6\u5230\u53e6\u5916\u5bb9\u5668\u4e2d\u7684\u65e5\u5fd7\u6587\u4ef6\uff0c\u7136\u540e\u5c06\u65e5\u5fd7\u91cd\u5b9a\u5411\u5230\u81ea\u5df1\u7684 <code>stdout</code> \u6d41\u4e2d\uff0c\u53ef\u4ee5\u5c06\u4e0a\u9762\u7684 <code>YAML</code> \u6587\u4ef6\u505a\u5982\u4e0b\u4fee\u6539\uff1a\uff08<code>two-files-counter-pod-streaming-sidecar.yaml</code>\uff09</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: counter\nspec:\n  containers:\n  - name: count\n    image: busybox\n    args:\n    - /bin/sh\n    - -c\n    - &gt;\n      i=0;\n      while true;\n      do\n        echo \"$i: $(date)\" &gt;&gt; /var/log/1.log;\n        echo \"$(date) INFO $i\" &gt;&gt; /var/log/2.log;\n        i=$((i+1));\n        sleep 1;\n      done\n    volumeMounts:\n    - name: varlog\n      mountPath: /var/log\n  - name: count-log-1\n    image: busybox\n    args: [/bin/sh, -c, 'tail -n+1 -f /var/log/1.log']\n    volumeMounts:\n    - name: varlog\n      mountPath: /var/log\n  - name: count-log-2\n    image: busybox\n    args: [/bin/sh, -c, 'tail -n+1 -f /var/log/2.log']\n    volumeMounts:\n    - name: varlog\n      mountPath: /var/log\n  volumes:\n  - name: varlog\n    emptyDir: {}\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684 Pod\uff1a</p> <pre><code>$ kubectl create -f two-files-counter-pod-streaming-sidecar.yaml\npod \"counter\" created\n</code></pre> <p>\u8fd0\u884c\u6210\u529f\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u67e5\u770b\u65e5\u5fd7\u7684\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl logs counter count-log-1\n0: Mon Jan  1 00:00:00 UTC 2001\n1: Mon Jan  1 00:00:01 UTC 2001\n2: Mon Jan  1 00:00:02 UTC 2001\n...\n$ kubectl logs counter count-log-2\nMon Jan  1 00:00:00 UTC 2001 INFO 0\nMon Jan  1 00:00:01 UTC 2001 INFO 1\nMon Jan  1 00:00:02 UTC 2001 INFO 2\n...\n</code></pre> <p>\u8fd9\u6837\u524d\u9762\u8282\u70b9\u4e0a\u7684\u65e5\u5fd7\u91c7\u96c6 <code>agent</code> \u5c31\u53ef\u4ee5\u81ea\u52a8\u83b7\u53d6\u8fd9\u4e9b\u65e5\u5fd7\u4fe1\u606f\uff0c\u800c\u4e0d\u9700\u8981\u5176\u4ed6\u914d\u7f6e\u3002</p> <p>\u8fd9\u79cd\u65b9\u6cd5\u867d\u7136\u53ef\u4ee5\u89e3\u51b3\u4e0a\u9762\u7684\u95ee\u9898\uff0c\u4f46\u662f\u4e5f\u6709\u4e00\u4e2a\u660e\u663e\u7684\u7f3a\u9677\uff0c\u5c31\u662f\u65e5\u5fd7\u4e0d\u4ec5\u4f1a\u5728\u539f\u5bb9\u5668\u6587\u4ef6\u4e2d\u4fdd\u7559\u4e0b\u6765\uff0c\u8fd8\u4f1a\u901a\u8fc7 <code>stdout</code> \u8f93\u51fa\u540e\u5360\u7528\u78c1\u76d8\u7a7a\u95f4\uff0c\u8fd9\u6837\u65e0\u5f62\u4e2d\u5c31\u589e\u52a0\u4e86\u4e00\u500d\u78c1\u76d8\u7a7a\u95f4\u3002</p>"},{"location":"chap10/1log_architecture/#3-3-sidecar-agent","title":"3-3 \u4f7f\u7528 sidecar \u8fd0\u884c\u65e5\u5fd7\u91c7\u96c6 agent","text":"<p>\u5982\u679c\u4f60\u89c9\u5f97\u5728\u8282\u70b9\u4e0a\u8fd0\u884c\u4e00\u4e2a\u65e5\u5fd7\u91c7\u96c6\u7684\u4ee3\u7406\u4e0d\u591f\u7075\u6d3b\u7684\u8bdd\uff0c\u90a3\u4e48\u4f60\u4e5f\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u5355\u72ec\u7684\u65e5\u5fd7\u91c7\u96c6\u4ee3\u7406\u7a0b\u5e8f\u7684 <code>sidecar</code> \u5bb9\u5668\uff0c\u4e0d\u8fc7\u9700\u8981\u5355\u72ec\u914d\u7f6e\u548c\u5e94\u7528\u7a0b\u5e8f\u4e00\u8d77\u8fd0\u884c\u3002</p> <p>\u4e0d\u8fc7\u8fd9\u6837\u867d\u7136\u66f4\u52a0\u7075\u6d3b\uff0c\u4f46\u662f\u5728 <code>sidecar</code> \u5bb9\u5668\u4e2d\u8fd0\u884c\u65e5\u5fd7\u91c7\u96c6\u4ee3\u7406\u7a0b\u5e8f\u4f1a\u5bfc\u81f4\u5927\u91cf\u8d44\u6e90\u6d88\u8017\uff0c\u56e0\u4e3a\u4f60\u6709\u591a\u5c11\u4e2a\u8981\u91c7\u96c6\u7684 <code>Pod</code>\uff0c\u5c31\u9700\u8981\u8fd0\u884c\u591a\u5c11\u4e2a\u91c7\u96c6\u4ee3\u7406\u7a0b\u5e8f\uff0c\u53e6\u5916\u8fd8\u65e0\u6cd5\u4f7f\u7528 <code>kubectl logs</code> \u547d\u4ee4\u6765\u8bbf\u95ee\u8fd9\u4e9b\u65e5\u5fd7\uff0c\u56e0\u4e3a\u5b83\u4eec\u4e0d\u53d7 kubelet \u63a7\u5236\u3002</p> <p>\u4e3e\u4e2a\u4f8b\u5b50\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u7684<code>Stackdriver</code>\uff0c\u5b83\u4f7f\u7528<code>fluentd</code>\u4f5c\u4e3a\u8bb0\u5f55\u5242\u3002\u4ee5\u4e0b\u662f\u4e24\u4e2a\u53ef\u7528\u4e8e\u5b9e\u73b0\u6b64\u65b9\u6cd5\u7684\u914d\u7f6e\u6587\u4ef6\u3002\u7b2c\u4e00\u4e2a\u6587\u4ef6\u5305\u542b\u914d\u7f6e\u6d41\u5229\u7684<code>ConfigMap</code>\u3002</p> <p>\u4e0b\u9762\u662f <code>Kubernetes</code> \u5b98\u65b9\u7684\u4e00\u4e2a <code>fluentd</code> \u7684\u914d\u7f6e\u6587\u4ef6\u793a\u4f8b\uff0c\u4f7f\u7528 <code>ConfigMap</code> \u5bf9\u8c61\u6765\u4fdd\u5b58\uff1a</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: fluentd-config\ndata:\n  fluentd.conf: |\n    &lt;source&gt;\n      type tail\n      format none\n      path /var/log/1.log\n      pos_file /var/log/1.log.pos\n      tag count.format1\n    &lt;/source&gt;\n\n    &lt;source&gt;\n      type tail\n      format none\n      path /var/log/2.log\n      pos_file /var/log/2.log.pos\n      tag count.format2\n    &lt;/source&gt;\n\n    &lt;match **&gt;\n      type google_cloud\n    &lt;/match&gt;\n</code></pre> <p>\u4e0a\u9762\u7684\u914d\u7f6e\u6587\u4ef6\u662f\u914d\u7f6e\u6536\u96c6\u539f\u6587\u4ef6 <code>/var/log/1.log</code> \u548c <code>/var/log/2.log</code> \u7684\u65e5\u5fd7\u6570\u636e\uff0c\u7136\u540e\u901a\u8fc7 <code>google_cloud</code> \u8fd9\u4e2a\u63d2\u4ef6\u5c06\u6570\u636e\u63a8\u9001\u5230 <code>Stackdriver</code> \u540e\u7aef\u53bb\u3002</p> <p>\u4e0b\u9762\u662f\u6211\u4eec\u4f7f\u7528\u4e0a\u9762\u7684\u914d\u7f6e\u6587\u4ef6\u5728\u5e94\u7528\u7a0b\u5e8f\u4e2d\u8fd0\u884c\u4e00\u4e2a <code>fluentd</code> \u7684\u5bb9\u5668\u6765\u8bfb\u53d6\u65e5\u5fd7\u6570\u636e\uff1a</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: counter\nspec:\n  containers:\n  - name: count\n    image: busybox\n    args:\n    - /bin/sh\n    - -c\n    - &gt;\n      i=0;\n      while true;\n      do\n        echo \"$i: $(date)\" &gt;&gt; /var/log/1.log;\n        echo \"$(date) INFO $i\" &gt;&gt; /var/log/2.log;\n        i=$((i+1));\n        sleep 1;\n      done\n    volumeMounts:\n    - name: varlog\n      mountPath: /var/log\n  - name: count-agent\n    image: k8s.gcr.io/fluentd-gcp:1.30\n    env:\n    - name: FLUENTD_ARGS\n      value: -c /etc/fluentd-config/fluentd.conf\n    volumeMounts:\n    - name: varlog\n      mountPath: /var/log\n    - name: config-volume\n      mountPath: /etc/fluentd-config\n  volumes:\n  - name: varlog\n    emptyDir: {}\n  - name: config-volume\n    configMap:\n      name: fluentd-config\n</code></pre> <p>\u4e0a\u9762\u7684 <code>Pod</code> \u521b\u5efa\u5b8c\u6210\u540e\uff0c\u5bb9\u5668 <code>count-agent</code> \u5c31\u4f1a\u5c06 <code>count</code> \u5bb9\u5668\u4e2d\u7684\u65e5\u5fd7\u8fdb\u884c\u6536\u96c6\u7136\u540e\u4e0a\u4f20\u3002\u5f53\u7136\uff0c\u8fd9\u53ea\u662f\u4e00\u4e2a\u7b80\u5355\u7684\u793a\u4f8b\uff0c\u6211\u4eec\u4e5f\u5b8c\u5168\u53ef\u4ee5\u4f7f\u7528\u5176\u4ed6\u7684\u4efb\u4f55\u65e5\u5fd7\u91c7\u96c6\u5de5\u5177\u6765\u66ff\u6362 <code>fluentd</code>\uff0c\u6bd4\u5982 <code>logstash</code>\u3001<code>fluent-bit</code> \u7b49\u7b49\u3002</p>"},{"location":"chap10/1log_architecture/#3-4","title":"3-4 \u76f4\u63a5\u4ece\u5e94\u7528\u7a0b\u5e8f\u6536\u96c6\u65e5\u5fd7","text":"<p>\u9664\u4e86\u4e0a\u9762\u7684\u51e0\u79cd\u65b9\u6848\u4e4b\u5916\uff0c\u6211\u4eec\u4e5f\u5b8c\u5168\u53ef\u4ee5\u901a\u8fc7\u76f4\u63a5\u5728\u5e94\u7528\u7a0b\u5e8f\u4e2d\u53bb\u663e\u793a\u7684\u5c06\u65e5\u5fd7\u63a8\u9001\u5230\u65e5\u5fd7\u540e\u7aef\uff0c\u4f46\u662f\u8fd9\u79cd\u65b9\u5f0f\u9700\u8981\u4ee3\u7801\u5c42\u9762\u7684\u5b9e\u73b0\uff0c\u4e5f\u8d85\u51fa\u4e86 Kubernetes \u672c\u8eab\u7684\u8303\u56f4\u3002</p>"},{"location":"chap10/2EFK_log/","title":"\u7b2c\u4e8c\u8282 \u5728 K8S \u4e0a\u642d\u5efa EFK \u65e5\u5fd7\u6536\u96c6\u7cfb\u7edf","text":"<p>Nowadays, Kubernetes \u4e2d\u6bd4\u8f83\u6d41\u884c\u7684\u65e5\u5fd7\u6536\u96c6\u89e3\u51b3\u65b9\u6848\u662f <code>Elasticsearch</code>\u3001<code>Fluentd</code> \u548c <code>Kibana</code>\uff08EFK\uff09 \u6280\u672f\u6808\uff0c\u4e5f\u662f\u5b98\u65b9\u73b0\u5728\u6bd4\u8f83\u63a8\u8350\u7684\u4e00\u79cd\u65b9\u6848\u3002</p> <p><code>Elasticsearch</code> \u662f\u4e00\u4e2a\u5b9e\u65f6\u7684\u3001\u5206\u5e03\u5f0f\u7684\u53ef\u6269\u5c55\u7684\u641c\u7d22\u5f15\u64ce\uff0c\u5141\u8bb8\u8fdb\u884c\u5168\u6587\u3001\u7ed3\u6784\u5316\u641c\u7d22\uff0c\u5b83\u901a\u5e38\u7528\u4e8e\u7d22\u5f15\u548c\u641c\u7d22\u5927\u91cf\u65e5\u5fd7\u6570\u636e\uff0c\u4e5f\u53ef\u7528\u4e8e\u641c\u7d22\u8bb8\u591a\u4e0d\u540c\u7c7b\u578b\u7684\u6587\u6863\u3002</p> <p><code>Elasticsearch</code> \u901a\u5e38\u4e0e <code>Kibana</code> \u4e00\u8d77\u90e8\u7f72\uff0c<code>Kibana</code> \u662f <code>Elasticsearch</code> \u7684\u4e00\u4e2a\u529f\u80fd\u5f3a\u5927\u7684\u6570\u636e\u53ef\u89c6\u5316 <code>Dashboard</code>\uff0c<code>Kibana</code> \u5141\u8bb8\u4f60\u901a\u8fc7 <code>web</code> \u754c\u9762\u6765\u6d4f\u89c8 <code>Elasticsearch</code> \u65e5\u5fd7\u6570\u636e\u3002</p> <p><code>Fluentd</code>\u662f\u4e00\u4e2a\u6d41\u884c\u7684\u5f00\u6e90\u6570\u636e\u6536\u96c6\u5668\uff0c\u6211\u4eec\u5c06\u5728 <code>Kubernetes</code> \u96c6\u7fa4\u8282\u70b9\u4e0a\u5b89\u88c5 <code>Fluentd</code>\uff0c\u901a\u8fc7\u83b7\u53d6\u5bb9\u5668\u65e5\u5fd7\u6587\u4ef6\u3001\u8fc7\u6ee4\u548c\u8f6c\u6362\u65e5\u5fd7\u6570\u636e\uff0c\u7136\u540e\u5c06\u6570\u636e\u4f20\u9012\u5230 <code>Elasticsearch</code> \u96c6\u7fa4\uff0c\u5728\u8be5\u96c6\u7fa4\u4e2d\u5bf9\u5176\u8fdb\u884c\u7d22\u5f15\u548c\u5b58\u50a8\u3002</p>"},{"location":"chap10/2EFK_log/#1-elasticsearch","title":"1\u3001\u521b\u5efa Elasticsearch \u96c6\u7fa4","text":"<p>\u5728\u521b\u5efa <code>Elasticsearch</code> \u96c6\u7fa4\u4e4b\u524d\uff0c\u6211\u4eec\u5148\u521b\u5efa\u4e00\u4e2a\u547d\u540d\u7a7a\u95f4\uff0c\u6211\u4eec\u5c06\u5728\u5176\u4e2d\u5b89\u88c5\u6240\u6709\u65e5\u5fd7\u76f8\u5173\u7684\u8d44\u6e90\u5bf9\u8c61\u3002</p> <p>\u65b0\u5efa\u4e00\u4e2a <code>kube-logging.yaml</code> \u6587\u4ef6\uff1a</p> <pre><code>apiVersion: v1\nkind: Namespace\nmetadata:\n  name: logging\n</code></pre> <p>\u7136\u540e\u901a\u8fc7 <code>kubectl</code> \u521b\u5efa\u8be5\u8d44\u6e90\u6e05\u5355\uff0c\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a <code>logging</code> \u7684 <code>namespace</code>\uff1a</p> <pre><code>$ kubectl create -f kube-logging.yaml\nnamespace/logging created\n$ kubectl get ns\nNAME           STATUS    AGE\ndefault        Active    244d\nistio-system   Active    100d\nkube-ops       Active    179d\nkube-public    Active    244d\nkube-system    Active    244d\nlogging        Active    4h\nmonitoring     Active    35d\n</code></pre> <p>\u73b0\u5728\u521b\u5efa\u4e86\u4e00\u4e2a\u547d\u540d\u7a7a\u95f4\u6765\u5b58\u653e\u6211\u4eec\u7684\u65e5\u5fd7\u76f8\u5173\u8d44\u6e90\uff0c\u63a5\u4e0b\u6765\u53ef\u4ee5\u90e8\u7f72 <code>EFK</code> \u76f8\u5173\u7ec4\u4ef6\uff0c\u9996\u5148\u5f00\u59cb\u90e8\u7f72\u4e00\u4e2a3\u8282\u70b9\u7684 <code>Elasticsearch</code> \u96c6\u7fa4\u3002</p> <p>\u8fd9\u91cc\u6211\u4eec\u4f7f\u75283\u4e2a <code>Elasticsearch Pod</code> \u6765\u907f\u514d\u9ad8\u53ef\u7528\u4e0b\u591a\u8282\u70b9\u96c6\u7fa4\u4e2d\u51fa\u73b0\u7684\u201c\u8111\u88c2\u201d\u95ee\u9898\uff0c\u5f53\u4e00\u4e2a\u6216\u591a\u4e2a\u8282\u70b9\u65e0\u6cd5\u4e0e\u5176\u4ed6\u8282\u70b9\u901a\u4fe1\u65f6\u4f1a\u4ea7\u751f\u201c\u8111\u88c2\u201d\uff0c\u53ef\u80fd\u4f1a\u51fa\u73b0\u51e0\u4e2a\u4e3b\u8282\u70b9\u3002</p> <p>Elasticsearch \u96c6\u7fa4\u8111\u88c2\u95ee\u9898</p>"},{"location":"chap10/2EFK_log/#1-1","title":"1-1 \u4e00\u4e2a\u5173\u952e\u70b9\u662f\u60a8\u5e94\u8be5\u8bbe\u5728\u53c2\u6570\u4e0a","text":"<pre><code>discover.zen.minimum_master_nodes=N/2+1\n</code></pre> <p>\u5176\u4e2d <code>N</code> \u662f <code>Elasticsearch</code> \u96c6\u7fa4\u4e2d\u7b26\u5408\u4e3b\u8282\u70b9\u7684\u8282\u70b9\u6570\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc<code>3</code>\u4e2a\u8282\u70b9\uff0c\u610f\u5473\u7740<code>N</code>\u5e94\u8be5\u8bbe\u7f6e\u4e3a<code>2</code>\u3002 \u8fd9\u6837\uff0c\u5982\u679c\u4e00\u4e2a\u8282\u70b9\u6682\u65f6\u4e0e\u96c6\u7fa4\u65ad\u5f00\u8fde\u63a5\uff0c\u5219\u53e6\u5916\u4e24\u4e2a\u8282\u70b9\u53ef\u4ee5\u9009\u62e9\u4e00\u4e2a\u65b0\u7684\u4e3b\u8282\u70b9\uff0c\u5e76\u4e14\u96c6\u7fa4\u53ef\u4ee5\u5728\u6700\u540e\u4e00\u4e2a\u8282\u70b9\u5c1d\u8bd5\u91cd\u65b0\u52a0\u5165\u65f6\u7ee7\u7eed\u8fd0\u884c\uff0c\u5728\u6269\u5c55 <code>Elasticsearch</code> \u96c6\u7fa4\u65f6\uff0c\u4e00\u5b9a\u8981\u8bb0\u4f4f\u8fd9\u4e2a\u53c2\u6570\u3002</p> <p>\u9996\u5148\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a <code>elasticsearch</code> \u7684\u65e0\u5934\u670d\u52a1\uff0c\u65b0\u5efa\u6587\u4ef6 <code>elasticsearch-svc.yaml</code>\uff0c\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>kind: Service\napiVersion: v1\nmetadata:\n  name: elasticsearch\n  namespace: kube-logging\n  labels:\n    app: elasticsearch\nspec:\n  selector:\n    app: elasticsearch\n  clusterIP: None\n  ports:\n    - port: 9200\n      name: rest\n    - port: 9300\n      name: inter-node\n</code></pre> <ul> <li>\u5b9a\u4e49\u4e86\u4e00\u4e2a\u540d\u4e3a <code>elasticsearch</code> \u7684 <code>Service</code>\uff0c\u6307\u5b9a\u6807\u7b7e<code>app=elasticsearch</code></li> <li>\u6211\u4eec\u5c06 <code>Elasticsearch StatefulSet</code> \u4e0e\u6b64\u670d\u52a1\u5173\u8054\u65f6\uff0c\u670d\u52a1\u5c06\u8fd4\u56de\u5e26\u6709\u6807\u7b7e <code>app=elasticsearch</code>\u7684 <code>Elasticsearch Pods</code> \u7684 <code>DNS</code> \u8bb0\u5f55\uff0c</li> <li>\u7136\u540e\u8bbe\u7f6e<code>clusterIP=None</code>\uff0c\u5c06\u8be5\u670d\u52a1\u8bbe\u7f6e\u6210\u65e0\u5934\u670d\u52a1\u3002</li> <li>\u6700\u540e\uff0c\u6211\u4eec\u5206\u522b\u5b9a\u4e49\u7aef\u53e3<code>9200</code>\u3001<code>9300</code>\uff0c\u5206\u522b\u7528\u4e8e\u4e0e <code>REST API</code> \u4ea4\u4e92\uff0c\u4ee5\u53ca\u7528\u4e8e\u8282\u70b9\u95f4\u901a\u4fe1\u3002</li> <li>9200: \u4e0e<code>REST API</code>\u4ea4\u4e92</li> <li>9300: \u8282\u70b9\u95f4\u901a\u4fe1</li> </ul> <p>\u4f7f\u7528 <code>kubectl</code> \u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u670d\u52a1\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl create -f elasticsearch-svc.yaml\nservice/elasticsearch created\n$ kubectl get services -n=logging\nOutput\nNAME            TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)             AGE\nelasticsearch   ClusterIP   None         &lt;none&gt;        9200/TCP,9300/TCP   26s\n</code></pre>"},{"location":"chap10/2EFK_log/#1-2","title":"1-2 \u65e0\u5934\u670d\u52a1","text":"<pre><code>.elasticsearch.logging.svc.cluster.local\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u5df2\u7ecf\u4e3a <code>Pod</code> \u8bbe\u7f6e\u4e86\u65e0\u5934\u670d\u52a1\u548c\u4e00\u4e2a\u7a33\u5b9a\u7684\u57df\u540d <code>.elasticsearch.logging.svc.cluster.local</code>\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u901a\u8fc7 <code>StatefulSet</code> \u6765\u521b\u5efa\u5177\u4f53\u7684 <code>Elasticsearch</code> \u7684 Pod \u5e94\u7528\u3002</p> <p><code>Kubernetes StatefulSet</code> \u5141\u8bb8\u6211\u4eec\u4e3a <code>Pod</code> \u5206\u914d\u4e00\u4e2a\u7a33\u5b9a\u7684\u6807\u8bc6\u548c\u6301\u4e45\u5316\u5b58\u50a8\uff0c<code>Elasticsearch</code> \u9700\u8981\u7a33\u5b9a\u7684\u5b58\u50a8\u6765\u4fdd\u8bc1 <code>Pod</code> \u5728\u91cd\u65b0\u8c03\u5ea6\u6216\u8005\u91cd\u542f\u540e\u7684\u6570\u636e\u4f9d\u7136\u4e0d\u53d8\uff0c\u6240\u4ee5\u9700\u8981\u4f7f\u7528 <code>StatefulSet</code> \u6765\u7ba1\u7406 <code>Pod</code>\u3002</p> <p>Why StatefulSet Pod</p> <p>\u65b0\u5efa\u540d\u4e3a <code>elasticsearch-statefulset.yaml</code> \u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0c\u9996\u5148\u7c98\u8d34\u4e0b\u9762\u5185\u5bb9\uff1a</p> <pre><code>apiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: es-cluster\n  namespace: logging\nspec:\n  serviceName: elasticsearch\n  replicas: 3\n  selector:\n    matchLabels:\n      app: elasticsearch\n  template:\n    metadata:\n      labels:\n        app: elasticsearch\n</code></pre> <p>\u8be5\u5185\u5bb9\u4e2d\uff0c\u6211\u4eec\u5b9a\u4e49\u4e86\u4e00\u4e2a\u540d\u4e3a <code>es-cluster</code> \u7684 <code>StatefulSet</code> \u5bf9\u8c61\uff0c\u7136\u540e\u5b9a\u4e49 <code>serviceName=elasticsearch</code> \u548c\u524d\u9762\u521b\u5efa\u7684 <code>Service</code> \u76f8\u5173\u8054\uff0c\u8fd9\u53ef\u4ee5\u786e\u4fdd\u4f7f\u7528\u4ee5\u4e0b <code>DNS</code> \u5730\u5740\u8bbf\u95ee <code>StatefulSet</code> \u4e2d\u7684\u6bcf\u4e00\u4e2a <code>Pod\uff1aes-cluster-[0,1,2].elasticsearch.logging.svc.cluster.local</code>\uff0c\u5176\u4e2d<code>[0,1,2]</code>\u5bf9\u5e94\u4e8e\u5df2\u5206\u914d\u7684 <code>Pod</code> \u5e8f\u53f7\u3002</p> <p>\u7136\u540e\u6307\u5b9a<code>3</code>\u4e2a\u526f\u672c\uff0c\u5c06 <code>matchLabels</code> \u8bbe\u7f6e\u4e3a <code>app=elasticsearch</code>\uff0c\u6240\u4ee5 <code>Pod</code> \u7684\u6a21\u677f\u90e8\u5206<code>.spec.template.metadata.lables</code> \u4e5f\u5fc5\u987b\u5305\u542b <code>app=elasticsearch</code> \u6807\u7b7e\u3002</p> <p>\u7136\u540e\u5b9a\u4e49 <code>Pod</code> \u6a21\u677f\u90e8\u5206\u5185\u5bb9\uff1a</p> <pre><code>...\n  spec:\n    containers:\n    - name: elasticsearch\n      image: docker.elastic.co/elasticsearch/elasticsearch-oss:6.4.3\n      resources:\n        limits:\n          cpu: 1000m\n        requests:\n          cpu: 100m\n      ports:\n      - containerPort: 9200\n        name: rest\n        protocol: TCP\n      - containerPort: 9300\n        name: inter-node\n        protocol: TCP\n      volumeMounts:\n      - name: data\n        mountPath: /usr/share/elasticsearch/data\n      env:\n      - name: cluster.name\n        value: k8s-logs\n      - name: node.name\n        valueFrom:\n          fieldRef:\n            fieldPath: metadata.name\n      - name: discovery.zen.ping.unicast.hosts\n        value: \"es-cluster-0.elasticsearch,es-cluster-1.elasticsearch,es-cluster-2.elasticsearch\"\n      - name: discovery.zen.minimum_master_nodes\n        value: \"2\"\n      - name: ES_JAVA_OPTS\n        value: \"-Xms512m -Xmx512m\"\n</code></pre> <ol> <li>\u8be5\u90e8\u5206\u662f\u5b9a\u4e49 <code>StatefulSet</code> \u4e2d\u7684 <code>Pod</code>\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u4e00\u4e2a<code>-oss</code>\u540e\u7f00\u7684\u955c\u50cf\uff0c\u8be5\u955c\u50cf\u662f <code>Elasticsearch</code> \u7684\u5f00\u6e90\u7248\u672c\uff0c\u5982\u679c\u4f60\u60f3\u4f7f\u7528\u5305\u542b<code>X-Pack</code>\u4e4b\u7c7b\u7684\u7248\u672c\uff0c\u53ef\u4ee5\u53bb\u6389\u8be5\u540e\u7f00\u3002</li> <li>\u7136\u540e\u66b4\u9732\u4e86<code>9200</code>\u548c<code>9300</code>\u4e24\u4e2a\u7aef\u53e3\uff0c\u6ce8\u610f\u540d\u79f0\u8981\u548c\u4e0a\u9762\u5b9a\u4e49\u7684 <code>Service</code> \u4fdd\u6301\u4e00\u81f4\u3002\u7136\u540e\u901a\u8fc7 <code>volumeMount</code> \u58f0\u660e\u4e86\u6570\u636e\u6301\u4e45\u5316\u76ee\u5f55\uff0c\u4e0b\u9762\u6211\u4eec\u518d\u6765\u5b9a\u4e49 <code>VolumeClaims</code>\u3002\u6700\u540e\u5c31\u662f\u6211\u4eec\u5728\u5bb9\u5668\u4e2d\u8bbe\u7f6e\u7684\u4e00\u4e9b\u73af\u5883\u53d8\u91cf\u4e86\uff1a</li> <li><code>cluster.name</code>\uff1a<code>Elasticsearch</code> \u96c6\u7fa4\u7684\u540d\u79f0\uff0c\u6211\u4eec\u8fd9\u91cc\u547d\u540d\u6210 <code>k8s-logs</code>\u3002</li> <li><code>node.name</code>\uff1a\u8282\u70b9\u7684\u540d\u79f0\uff0c\u901a\u8fc7<code>metadata.name</code>\u6765\u83b7\u53d6\u3002\u8fd9\u5c06\u89e3\u6790\u4e3a <code>es-cluster-[0,1,2]</code>\uff0c\u53d6\u51b3\u4e8e\u8282\u70b9\u7684\u6307\u5b9a\u987a\u5e8f\u3002</li> <li><code>discovery.zen.ping.unicast.hosts</code>\uff1a\u6b64\u5b57\u6bb5\u7528\u4e8e\u8bbe\u7f6e\u5728 <code>Elasticsearch</code> \u96c6\u7fa4\u4e2d\u8282\u70b9\u76f8\u4e92\u8fde\u63a5\u7684\u53d1\u73b0\u65b9\u6cd5\u3002\u6211\u4eec\u4f7f\u7528 <code>unicastdiscovery</code> \u65b9\u5f0f\uff0c\u5b83\u4e3a\u6211\u4eec\u7684\u96c6\u7fa4\u6307\u5b9a\u4e86\u4e00\u4e2a\u9759\u6001\u4e3b\u673a\u5217\u8868\u3002\u7531\u4e8e\u6211\u4eec\u4e4b\u524d\u914d\u7f6e\u7684\u65e0\u5934\u670d\u52a1\uff0c\u6211\u4eec\u7684 <code>Pod</code> \u5177\u6709\u552f\u4e00\u7684 <code>DNS</code> \u57df <code>es-cluster-[0,1,2].elasticsearch.logging.svc.cluster.local</code>\uff0c\u56e0\u6b64\u6211\u4eec\u76f8\u5e94\u5730\u8bbe\u7f6e\u6b64\u53d8\u91cf\u3002\u7531\u4e8e\u90fd\u5728\u540c\u4e00\u4e2a <code>namespace</code> \u4e0b\u9762\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u5c06\u5176\u7f29\u77ed\u4e3a<code>es-cluster-[0,1,2].elasticsearch</code>\u3002\u8981\u4e86\u89e3\u6709\u5173 <code>Elasticsearch</code> \u53d1\u73b0\u7684\u66f4\u591a\u4fe1\u606f\uff0c\u8bf7\u53c2\u9605 <code>Elasticsearch</code> \u5b98\u65b9\u6587\u6863\uff1ahttps://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery.html\u3002</li> <li><code>discovery.zen.minimum_master_nodes</code>\uff1a\u6211\u4eec\u5c06\u5176\u8bbe\u7f6e\u4e3a<code>(N/2) + 1</code>\uff0c<code>N</code>\u662f\u6211\u4eec\u7684\u7fa4\u96c6\u4e2d\u7b26\u5408\u4e3b\u8282\u70b9\u7684\u8282\u70b9\u7684\u6570\u91cf\u3002\u6211\u4eec\u6709<code>3</code>\u4e2a <code>Elasticsearch</code> \u8282\u70b9\uff0c\u56e0\u6b64\u6211\u4eec\u5c06\u6b64\u503c\u8bbe\u7f6e\u4e3a<code>2</code>\uff08\u5411\u4e0b\u820d\u5165\u5230\u6700\u63a5\u8fd1\u7684\u6574\u6570\uff09</li> <li><code>ES_JAVA_OPTS</code>\uff1a\u8fd9\u91cc\u6211\u4eec\u8bbe\u7f6e\u4e3a<code>-Xms512m -Xmx512m</code>\uff0c\u544a\u8bc9<code>JVM</code>\u4f7f\u7528<code>512 MB</code>\u7684\u6700\u5c0f\u548c\u6700\u5927\u5806\u3002\u60a8\u5e94\u8be5\u6839\u636e\u7fa4\u96c6\u7684\u8d44\u6e90\u53ef\u7528\u6027\u548c\u9700\u6c42\u8c03\u6574\u8fd9\u4e9b\u53c2\u6570\u3002\u8981\u4e86\u89e3\u66f4\u591a\u4fe1\u606f\uff0c\u8bf7\u53c2\u9605\u8bbe\u7f6e\u5806\u5927\u5c0f\u7684\u76f8\u5173\u6587\u6863\uff1ahttps://www.elastic.co/guide/en/elasticsearch/reference/current/heap-size.html\u3002</li> </ol> <p>\u63a5\u4e0b\u6765\u6dfb\u52a0\u5173\u4e8e <code>initContainer</code> \u7684\u5185\u5bb9\uff1a</p> <p>Why Init Container</p> <pre><code>...\n    initContainers:\n    - name: fix-permissions\n      image: busybox\n      command: [\"sh\", \"-c\", \"chown -R 1000:1000 /usr/share/elasticsearch/data\"]\n      securityContext:\n        privileged: true\n      volumeMounts:\n      - name: data\n        mountPath: /usr/share/elasticsearch/data\n    - name: increase-vm-max-map\n      image: busybox\n      command: [\"sysctl\", \"-w\", \"vm.max_map_count=262144\"]\n      securityContext:\n        privileged: true\n    - name: increase-fd-ulimit\n      image: busybox\n      command: [\"sh\", \"-c\", \"ulimit -n 65536\"]\n      securityContext:\n        privileged: true\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u5b9a\u4e49\u4e86\u51e0\u4e2a\u5728\u4e3b\u5e94\u7528\u7a0b\u5e8f\u4e4b\u524d\u8fd0\u884c\u7684 <code>Init \u5bb9\u5668</code>\uff0c\u8fd9\u4e9b\u521d\u59cb\u5bb9\u5668\u6309\u7167\u5b9a\u4e49\u7684\u987a\u5e8f\u4f9d\u6b21\u6267\u884c\uff0c\u6267\u884c\u5b8c\u6210\u540e\u624d\u4f1a\u542f\u52a8\u4e3b\u5e94\u7528\u5bb9\u5668\u3002</p> <ul> <li>\u7b2c\u4e00\u4e2a\u540d\u4e3a <code>fix-permissions</code> \u7684\u5bb9\u5668\u7528\u6765\u8fd0\u884c <code>chown</code> \u547d\u4ee4\uff0c\u5c06 <code>Elasticsearch</code> \u6570\u636e\u76ee\u5f55\u7684\u7528\u6237\u548c\u7ec4\u66f4\u6539\u4e3a<code>1000:1000</code>\uff08<code>Elasticsearch</code> \u7528\u6237\u7684 <code>UID</code>\uff09\u3002\u56e0\u4e3a\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c<code>Kubernetes</code> \u7528 <code>root</code> \u7528\u6237\u6302\u8f7d\u6570\u636e\u76ee\u5f55\uff0c\u8fd9\u4f1a\u4f7f\u5f97 <code>Elasticsearch</code> \u65e0\u6cd5\u65b9\u6cd5\u8be5\u6570\u636e\u76ee\u5f55\uff0c\u53ef\u4ee5\u53c2\u8003 <code>Elasticsearch</code> \u751f\u4ea7\u4e2d\u7684\u4e00\u4e9b\u9ed8\u8ba4\u6ce8\u610f\u4e8b\u9879\u76f8\u5173\u6587\u6863\u8bf4\u660e\uff1anotes for production use and defaults</li> <li>\u7b2c\u4e8c\u4e2a\u540d\u4e3a <code>increase-vm-max-map</code> \u7684\u5bb9\u5668\u7528\u6765\u589e\u52a0\u64cd\u4f5c\u7cfb\u7edf\u5bf9 <code>mmap</code> \u8ba1\u6570\u7684\u9650\u5236\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u8be5\u503c\u53ef\u80fd\u592a\u4f4e\uff0c\u5bfc\u81f4\u5185\u5b58\u4e0d\u8db3\u7684\u9519\u8bef\uff0c\u8981\u4e86\u89e3\u66f4\u591a\u5173\u4e8e\u8be5\u8bbe\u7f6e\u7684\u4fe1\u606f\uff0c\u53ef\u4ee5\u67e5\u770b <code>Elasticsearch</code> \u5b98\u65b9\u6587\u6863\u8bf4\u660e: cm max map count</li> <li>\u6700\u540e\u4e00\u4e2a\u521d\u59cb\u5316\u5bb9\u5668\u662f\u7528\u6765\u6267\u884c <code>ulimit</code> \u547d\u4ee4\u589e\u52a0\u6253\u5f00\u6587\u4ef6\u63cf\u8ff0\u7b26\u7684\u6700\u5927\u6570\u91cf\u7684\u3002</li> <li>\u6b64\u5916 <code>Elastisearch Notes for Production Use</code> \u6587\u6863\u8fd8\u63d0\u5230\u4e86\u7531\u4e8e\u6027\u80fd\u539f\u56e0\u6700\u597d\u7981\u7528 <code>swap</code>\uff0c\u5f53\u7136\u5bf9\u4e8e <code>Kubernetes</code> \u96c6\u7fa4\u800c\u8a00\uff0c\u6700\u597d\u4e5f\u662f\u7981\u7528 <code>swap</code> \u5206\u533a\u7684\u3002</li> </ul> <p>\u73b0\u5728\u6211\u4eec\u5df2\u7ecf\u5b9a\u4e49\u4e86\u4e3b\u5e94\u7528\u5bb9\u5668\u548c\u5b83\u4e4b\u524d\u8fd0\u884c\u7684 <code>Init Containers</code> \u6765\u8c03\u6574\u4e00\u4e9b\u5fc5\u8981\u7684\u7cfb\u7edf\u53c2\u6570\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u53ef\u4ee5\u6dfb\u52a0\u6570\u636e\u76ee\u5f55\u7684\u6301\u4e45\u5316\u76f8\u5173\u7684\u914d\u7f6e\uff0c\u5728 <code>StatefulSet</code> \u4e2d\uff0c\u4f7f\u7528 <code>volumeClaimTemplates</code> \u6765\u5b9a\u4e49 <code>volume</code> \u6a21\u677f\u5373\u53ef\uff1a</p> <p>\u73b0\u5728\u6211\u4eec\u5df2\u7ecf\u5b9a\u4e49\u4e86\u4e3b\u5e94\u7528\u5bb9\u5668\u548c\u5b83\u4e4b\u524d\u8fd0\u884c\u7684 <code>Init Containers</code> \u6765\u8c03\u6574\u4e00\u4e9b\u5fc5\u8981\u7684\u7cfb\u7edf\u53c2\u6570\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u53ef\u4ee5\u6dfb\u52a0\u6570\u636e\u76ee\u5f55\u7684\u6301\u4e45\u5316\u76f8\u5173\u7684\u914d\u7f6e\uff0c\u5728 <code>StatefulSet</code> \u4e2d\uff0c\u4f7f\u7528 <code>volumeClaimTemplates</code> \u6765\u5b9a\u4e49 <code>volume</code> \u6a21\u677f\u5373\u53ef\uff1a</p> <pre><code>...\n  volumeClaimTemplates:\n  - metadata:\n      name: data\n      labels:\n        app: elasticsearch\n    spec:\n      accessModes: [ \"ReadWriteOnce\" ]\n      storageClassName: es-data-db\n      resources:\n        requests:\n          storage: 50Gi\n</code></pre> <ul> <li>\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528 <code>volumeClaimTemplates</code> \u6765\u5b9a\u4e49\u6301\u4e45\u5316\u6a21\u677f\uff0c<code>Kubernetes</code> \u4f1a\u4f7f\u7528\u5b83\u4e3a <code>Pod</code>\u521b\u5efa <code>PersistentVolume</code>\uff0c</li> <li>\u8bbe\u7f6e\u8bbf\u95ee\u6a21\u5f0f\u4e3a <code>ReadWriteOnce</code>\uff0c\u8fd9\u610f\u5473\u7740\u5b83\u53ea\u80fd\u88ab <code>mount</code> \u5230\u5355\u4e2a\u8282\u70b9\u4e0a\u8fdb\u884c\u8bfb\u5199\uff0c</li> <li>\u7136\u540e\u6700\u91cd\u8981\u7684\u662f\u4f7f\u7528\u4e86\u4e00\u4e2a\u540d\u4e3a <code>es-data-db</code> \u7684 <code>StorageClass</code> \u5bf9\u8c61\uff0c</li> <li>\u6240\u4ee5\u6211\u4eec\u9700\u8981\u63d0\u524d\u521b\u5efa\u8be5\u5bf9\u8c61\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u7684 <code>NFS</code> \u4f5c\u4e3a\u5b58\u50a8\u540e\u7aef\uff0c\u6240\u4ee5\u9700\u8981\u5b89\u88c5\u4e00\u4e2a\u5bf9\u5e94\u7684 <code>provisioner</code> \u9a71\u52a8\uff0c\u524d\u9762\u5173\u4e8e <code>Storage</code> \u7684\u8bfe\u7a0b\u4e2d\u5df2\u7ecf\u548c\u5927\u5bb6\u4ecb\u7ecd\u8fc7\u65b9\u6cd5\uff0cNFS</li> <li>\u65b0\u5efa\u4e00\u4e2a <code>elasticsearch-storageclass.yaml</code> \u7684\u6587\u4ef6\uff0c\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\uff1a</li> </ul> <p>elasticsearch-storageclass.yaml</p> <pre><code>apiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\n  name: es-data-db\nprovisioner: fuseim.pri/ifs  # \u8be5\u503c\u9700\u8981\u548c provisioner \u914d\u7f6e\u7684\u4fdd\u6301\u4e00\u81f4\n</code></pre> <p>\u6700\u540e\uff0c\u6211\u4eec\u6307\u5b9a\u4e86\u6bcf\u4e2a <code>PersistentVolume</code> \u7684\u5927\u5c0f\u4e3a <code>50GB</code>\uff0c\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u5b9e\u9645\u9700\u8981\u8fdb\u884c\u8c03\u6574\u8be5\u503c\u3002\u6700\u540e\uff0c\u5b8c\u6574\u7684 <code>Elasticsearch StatefulSet</code> \u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: es-cluster\n  namespace: logging\nspec:\n  serviceName: elasticsearch\n  replicas: 3\n  selector:\n    matchLabels:\n      app: elasticsearch\n  template:\n    metadata:\n      labels:\n        app: elasticsearch\n    spec:\n      containers:\n      - name: elasticsearch\n        image: docker.elastic.co/elasticsearch/elasticsearch-oss:6.4.3\n        resources:\n            limits:\n              cpu: 1000m\n            requests:\n              cpu: 100m\n        ports:\n        - containerPort: 9200\n          name: rest\n          protocol: TCP\n        - containerPort: 9300\n          name: inter-node\n          protocol: TCP\n        volumeMounts:\n        - name: data\n          mountPath: /usr/share/elasticsearch/data\n        env:\n          - name: cluster.name\n            value: k8s-logs\n          - name: node.name\n            valueFrom:\n              fieldRef:\n                fieldPath: metadata.name\n          - name: discovery.zen.ping.unicast.hosts\n            value: \"es-cluster-0.elasticsearch,es-cluster-1.elasticsearch,es-cluster-2.elasticsearch\"\n          - name: discovery.zen.minimum_master_nodes\n            value: \"2\"\n          - name: ES_JAVA_OPTS\n            value: \"-Xms512m -Xmx512m\"\n      initContainers:\n      - name: fix-permissions\n        image: busybox\n        command: [\"sh\", \"-c\", \"chown -R 1000:1000 /usr/share/elasticsearch/data\"]\n        securityContext:\n          privileged: true\n        volumeMounts:\n        - name: data\n          mountPath: /usr/share/elasticsearch/data\n      - name: increase-vm-max-map\n        image: busybox\n        command: [\"sysctl\", \"-w\", \"vm.max_map_count=262144\"]\n        securityContext:\n          privileged: true\n      - name: increase-fd-ulimit\n        image: busybox\n        command: [\"sh\", \"-c\", \"ulimit -n 65536\"]\n        securityContext:\n          privileged: true\n  volumeClaimTemplates:\n  - metadata:\n      name: data\n      labels:\n        app: elasticsearch\n    spec:\n      accessModes: [ \"ReadWriteOnce\" ]\n      storageClassName: es-data-db\n      resources:\n        requests:\n          storage: 100Gi\n</code></pre> <p>\u73b0\u5728\u76f4\u63a5\u4f7f\u7528 <code>kubectl</code> \u5de5\u5177\u90e8\u7f72\u5373\u53ef\uff1a</p> <pre><code>$ kubectl create -f elasticsearch-storageclass.yaml\nstorageclass.storage.k8s.io \"es-data-db\" created\n$ kubectl create -f elasticsearch-statefulset.yaml\nstatefulset.apps/es-cluster created\n</code></pre> <p>\u6dfb\u52a0\u6210\u529f\u540e\uff0c\u53ef\u4ee5\u770b\u5230 <code>logging</code> \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u7684\u6240\u6709\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <p>sts: <code>StateSet</code></p> <pre><code>$ kubectl get sts -n logging\nNAME         DESIRED   CURRENT   AGE\nes-cluster   3         3         20h\n\n$ kubectl get pods -n logging\nNAME                      READY     STATUS    RESTARTS   AGE\nes-cluster-0              1/1       Running   0          20h\nes-cluster-1              1/1       Running   0          20h\nes-cluster-2              1/1       Running   0          20h\n\n$ kubectl get svc -n logging\nNAME            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE\nelasticsearch   ClusterIP   None             &lt;none&gt;        9200/TCP,9300/TCP   20h\n</code></pre> <p><code>Pods</code> \u90e8\u7f72\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8bf7\u6c42\u4e00\u4e2a <code>REST API</code> \u6765\u68c0\u67e5 <code>Elasticsearch</code> \u96c6\u7fa4\u662f\u5426\u6b63\u5e38\u8fd0\u884c\u3002\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u5c06\u672c\u5730\u7aef\u53e3<code>9200</code>\u8f6c\u53d1\u5230 <code>Elasticsearch</code> \u8282\u70b9\uff08\u5982<code>es-cluster-0</code>\uff09\u5bf9\u5e94\u7684\u7aef\u53e3\uff1a</p> <pre><code>$ kubectl port-forward es-cluster-0 9200:9200 --namespace=logging\nForwarding from 127.0.0.1:9200 -&gt; 9200\nForwarding from [::1]:9200 -&gt; 9200\n</code></pre> <p>Forward a local port to a port on the pod</p> <pre><code>$ curl http://localhost:9200/_cluster/state?pretty\n</code></pre> <p>\u6b63\u5e38\u6765\u8bf4\uff0c\u5e94\u8be5\u4f1a\u770b\u5230\u7c7b\u4f3c\u4e8e\u5982\u4e0b\u7684\u4fe1\u606f\uff1a</p> <pre><code>{\n  \"cluster_name\" : \"k8s-logs\",\n  \"compressed_size_in_bytes\" : 348,\n  \"cluster_uuid\" : \"QD06dK7CQgids-GQZooNVw\",\n  \"version\" : 3,\n  \"state_uuid\" : \"mjNIWXAzQVuxNNOQ7xR-qg\",\n  \"master_node\" : \"IdM5B7cUQWqFgIHXBp0JDg\",\n  \"blocks\" : { },\n  \"nodes\" : {\n    \"u7DoTpMmSCixOoictzHItA\" : {\n      \"name\" : \"es-cluster-1\",\n      \"ephemeral_id\" : \"ZlBflnXKRMC4RvEACHIVdg\",\n      \"transport_address\" : \"10.244.4.191:9300\",\n      \"attributes\" : { }\n    },\n    \"IdM5B7cUQWqFgIHXBp0JDg\" : {\n      \"name\" : \"es-cluster-0\",\n      \"ephemeral_id\" : \"JTk1FDdFQuWbSFAtBxdxAQ\",\n      \"transport_address\" : \"10.244.2.215:9300\",\n      \"attributes\" : { }\n    },\n    \"R8E7xcSUSbGbgrhAdyAKmQ\" : {\n      \"name\" : \"es-cluster-2\",\n      \"ephemeral_id\" : \"9wv6ke71Qqy9vk2LgJTqaA\",\n      \"transport_address\" : \"10.244.40.4:9300\",\n      \"attributes\" : { }\n    }\n  },\n...\n\n</code></pre> <p>\u770b\u5230\u4e0a\u9762\u7684\u4fe1\u606f\u5c31\u8868\u660e\u6211\u4eec\u540d\u4e3a <code>k8s-logs</code> \u7684 <code>Elasticsearch</code> \u96c6\u7fa4\u6210\u529f\u521b\u5efa\u4e86<code>3</code>\u4e2a\u8282\u70b9\uff1a<code>es-cluster-0</code>\uff0c<code>es-cluster-1</code>\uff0c\u548c<code>es-cluster-2</code>\uff0c\u5f53\u524d\u4e3b\u8282\u70b9\u662f <code>es-cluster-0</code>\u3002</p>"},{"location":"chap10/2EFK_log/#2-kibana","title":"2\u3001\u521b\u5efa Kibana \u670d\u52a1","text":"<p><code>Elasticsearch</code> \u96c6\u7fa4\u542f\u52a8\u6210\u529f\u4e86\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u53ef\u4ee5\u6765\u90e8\u7f72 <code>Kibana</code> \u670d\u52a1\uff0c\u65b0\u5efa\u4e00\u4e2a\u540d\u4e3a <code>kibana.yaml</code> \u7684\u6587\u4ef6\uff0c\u5bf9\u5e94\u7684\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: kibana\n  namespace: logging\n  labels:\n    app: kibana\nspec:\n  ports:\n  - port: 5601\n  type: NodePort\n  selector:\n    app: kibana\n\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: kibana\n  namespace: logging\n  labels:\n    app: kibana\nspec:\n  selector:\n    matchLabels:\n      app: kibana\n  template:\n    metadata:\n      labels:\n        app: kibana\n    spec:\n      containers:\n      - name: kibana\n        image: docker.elastic.co/kibana/kibana-oss:6.4.3\n        resources:\n          limits:\n            cpu: 1000m\n          requests:\n            cpu: 100m\n        env:\n          - name: ELASTICSEARCH_URL\n            value: http://elasticsearch:9200\n        ports:\n        - containerPort: 5601\n</code></pre> <p>\u4e0a\u9762\u6211\u4eec\u5b9a\u4e49\u4e86\u4e24\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff0c\u4e00\u4e2a <code>Service</code> \u548c <code>Deployment</code>\uff0c\u4e3a\u4e86\u6d4b\u8bd5\u65b9\u4fbf\uff0c\u6211\u4eec\u5c06 <code>Service</code> \u8bbe\u7f6e\u4e3a\u4e86 <code>NodePort</code> \u7c7b\u578b\uff0c<code>Kibana Pod</code> \u4e2d\u914d\u7f6e\u90fd\u6bd4\u8f83\u7b80\u5355\uff0c</p> <p>\u552f\u4e00\u9700\u8981\u6ce8\u610f\u7684\u662f\u6211\u4eec\u4f7f\u7528 <code>ELASTICSEARCH_URL</code> \u8fd9\u4e2a\u73af\u5883\u53d8\u91cf\u6765\u8bbe\u7f6e<code>Elasticsearch</code> \u96c6\u7fa4\u7684\u7aef\u70b9\u548c\u7aef\u53e3\uff0c\u76f4\u63a5\u4f7f\u7528 <code>Kubernetes DNS</code> \u5373\u53ef\uff0c\u6b64\u7aef\u70b9\u5bf9\u5e94\u670d\u52a1\u540d\u79f0\u4e3a <code>elasticsearch</code>\uff0c\u7531\u4e8e\u662f\u4e00\u4e2a <code>headless service</code>\uff0c\u6240\u4ee5\u8be5\u57df\u5c06\u89e3\u6790\u4e3a<code>3</code>\u4e2a <code>Elasticsearch Pod</code> \u7684 <code>IP</code> \u5730\u5740\u5217\u8868\u3002</p> <pre><code>- name: ELASTICSEARCH_URL\n  value: http://elasticsearch:9200\n</code></pre> <p>\u914d\u7f6e\u5b8c\u6210\u540e\uff0c\u76f4\u63a5\u4f7f\u7528 <code>kubectl</code> \u5de5\u5177\u521b\u5efa\uff1a</p> <pre><code>$ kubectl create -f kibana.yaml\nservice/kibana created\ndeployment.apps/kibana created\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u53ef\u4ee5\u67e5\u770b <code>Kibana Pod</code> \u7684\u8fd0\u884c\u72b6\u6001\uff1a</p> <pre><code>$ kubectl get pods --namespace=logging\nNAME                      READY     STATUS    RESTARTS   AGE\nes-cluster-0              1/1       Running   0          20h\nes-cluster-1              1/1       Running   0          20h\nes-cluster-2              1/1       Running   0          20h\nkibana-7558d4dc4d-5mqdz   1/1       Running   0          20h\n$ kubectl get svc --namespace=logging\nNAME            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE\nelasticsearch   ClusterIP   None             &lt;none&gt;        9200/TCP,9300/TCP   20h\nkibana          NodePort    10.105.208.253   &lt;none&gt;        5601:31816/TCP      20h\n</code></pre> <p>\u5982\u679c <code>Pod</code> \u5df2\u7ecf\u662f <code>Running</code> \u72b6\u6001\u4e86\uff0c\u8bc1\u660e\u5e94\u7528\u5df2\u7ecf\u90e8\u7f72\u6210\u529f\u4e86\uff0c\u7136\u540e\u53ef\u4ee5\u901a\u8fc7 <code>NodePort</code> \u6765\u8bbf\u95ee <code>Kibana</code> \u8fd9\u4e2a\u670d\u52a1\uff0c\u5728\u6d4f\u89c8\u5668\u4e2d\u6253\u5f00<code>http://&lt;\u4efb\u610f\u8282\u70b9IP&gt;:31816</code>\u5373\u53ef\uff0c\u5982\u679c\u770b\u5230\u5982\u4e0b\u6b22\u8fce\u754c\u9762\u8bc1\u660e <code>Kibana</code> \u5df2\u7ecf\u6210\u529f\u90e8\u7f72\u5230\u4e86 <code>Kubernetes</code>\u96c6\u7fa4\u4e4b\u4e2d\u3002</p> <p></p>"},{"location":"chap10/2EFK_log/#3-fluentd","title":"3\u3001\u90e8\u7f72 Fluentd","text":"<p><code>Fluentd</code> \u662f\u4e00\u4e2a\u9ad8\u6548\u7684\u65e5\u5fd7\u805a\u5408\u5668\uff0c\u662f\u7528 <code>Ruby</code> \u7f16\u5199\u7684\uff0c\u5e76\u4e14\u53ef\u4ee5\u5f88\u597d\u5730\u6269\u5c55\u3002\u5bf9\u4e8e\u5927\u90e8\u5206\u4f01\u4e1a\u6765\u8bf4\uff0c<code>Fluentd</code> \u8db3\u591f\u9ad8\u6548\u5e76\u4e14\u6d88\u8017\u7684\u8d44\u6e90\u76f8\u5bf9\u8f83\u5c11\uff0c\u53e6\u5916\u4e00\u4e2a\u5de5\u5177<code>Fluent-bit</code>\u66f4\u8f7b\u91cf\u7ea7\uff0c\u5360\u7528\u8d44\u6e90\u66f4\u5c11\uff0c\u4f46\u662f\u63d2\u4ef6\u76f8\u5bf9 <code>Fluentd</code> \u6765\u8bf4\u4e0d\u591f\u4e30\u5bcc\uff0c\u6240\u4ee5\u6574\u4f53\u6765\u8bf4\uff0c<code>Fluentd</code> \u66f4\u52a0\u6210\u719f\uff0c\u4f7f\u7528\u66f4\u52a0\u5e7f\u6cdb\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u4e5f\u540c\u6837\u4f7f\u7528 <code>Fluentd</code> \u6765\u4f5c\u4e3a\u65e5\u5fd7\u6536\u96c6\u5de5\u5177\u3002</p>"},{"location":"chap10/2EFK_log/#3-1","title":"3-1 \u5de5\u4f5c\u539f\u7406","text":"<p><code>Fluentd</code> \u901a\u8fc7\u4e00\u7ec4\u7ed9\u5b9a\u7684\u6570\u636e\u6e90\u6293\u53d6\u65e5\u5fd7\u6570\u636e\uff0c\u5904\u7406\u540e\uff08\u8f6c\u6362\u6210\u7ed3\u6784\u5316\u7684\u6570\u636e\u683c\u5f0f\uff09\u5c06\u5b83\u4eec\u8f6c\u53d1\u7ed9\u5176\u4ed6\u670d\u52a1\uff0c\u6bd4\u5982 <code>Elasticsearch</code>\u3001<code>\u5bf9\u8c61\u5b58\u50a8</code>\u7b49\u7b49\u3002<code>Fluentd</code> \u652f\u6301\u8d85\u8fc7300\u4e2a\u65e5\u5fd7\u5b58\u50a8\u548c\u5206\u6790\u670d\u52a1\uff0c\u6240\u4ee5\u5728\u8fd9\u65b9\u9762\u662f\u975e\u5e38\u7075\u6d3b\u7684\u3002\u4e3b\u8981\u8fd0\u884c\u6b65\u9aa4\u5982\u4e0b\uff1a</p> <ul> <li>\u9996\u5148 <code>Fluentd</code> \u4ece\u591a\u4e2a\u65e5\u5fd7\u6e90\u83b7\u53d6\u6570\u636e</li> <li>\u7ed3\u6784\u5316\u5e76\u4e14\u6807\u8bb0\u8fd9\u4e9b\u6570\u636e</li> <li>\u7136\u540e\u6839\u636e\u5339\u914d\u7684\u6807\u7b7e\u5c06\u6570\u636e\u53d1\u9001\u5230\u591a\u4e2a\u76ee\u6807\u670d\u52a1\u53bb</li> </ul> <p></p>"},{"location":"chap10/2EFK_log/#3-2","title":"3-2 \u914d\u7f6e","text":"<p>\u4e00\u822c\u6765\u8bf4\u6211\u4eec\u662f\u901a\u8fc7\u4e00\u4e2a\u914d\u7f6e\u6587\u4ef6\u6765\u544a\u8bc9 Fluentd \u5982\u4f55\u91c7\u96c6\u3001\u5904\u7406\u6570\u636e\u7684\uff0c\u4e0b\u9762\u7b80\u5355\u548c\u5927\u5bb6\u4ecb\u7ecd\u4e0b Fluentd \u7684\u914d\u7f6e\u65b9\u6cd5</p>"},{"location":"chap10/2EFK_log/#_1","title":"\u65e5\u5fd7\u6e90\u914d\u7f6e","text":"<p>\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u4e3a\u4e86\u6536\u96c6 <code>Kubernetes</code> \u8282\u70b9\u4e0a\u7684\u6240\u6709\u5bb9\u5668\u65e5\u5fd7\uff0c\u5c31\u9700\u8981\u505a\u5982\u4e0b\u7684\u65e5\u5fd7\u6e90\u914d\u7f6e\uff1a</p> <pre><code>&lt;source&gt;\n\n@id fluentd-containers.log\n\n@type tail\n\npath /var/log/containers/*.log\n\npos_file /var/log/fluentd-containers.log.pos\n\ntime_format %Y-%m-%dT%H:%M:%S.%NZ\n\ntag raw.kubernetes.*\n\nformat json\n\nread_from_head true\n\n&lt;/source&gt;\n</code></pre> <p>\u4e0a\u9762\u914d\u7f6e\u90e8\u5206\u53c2\u6570\u8bf4\u660e\u5982\u4e0b\uff1a</p> <ul> <li>id\uff1a\u8868\u793a\u5f15\u7528\u8be5\u65e5\u5fd7\u6e90\u7684\u552f\u4e00\u6807\u8bc6\u7b26\uff0c\u8be5\u6807\u8bc6\u53ef\u7528\u4e8e\u8fdb\u4e00\u6b65\u8fc7\u6ee4\u548c\u8def\u7531\u7ed3\u6784\u5316\u65e5\u5fd7\u6570\u636e</li> <li>type\uff1a<code>Fluentd</code> \u5185\u7f6e\u7684\u6307\u4ee4\uff0c</li> <li><code>tail</code>\u8868\u793a <code>Fluentd</code> \u4ece\u4e0a\u6b21\u8bfb\u53d6\u7684\u4f4d\u7f6e\u901a\u8fc7 <code>tail</code> \u4e0d\u65ad\u83b7\u53d6\u6570\u636e\uff0c</li> <li>\u53e6\u5916\u4e00\u4e2a\u662f<code>http</code>\u8868\u793a\u901a\u8fc7\u4e00\u4e2a <code>GET</code> \u8bf7\u6c42\u6765\u6536\u96c6\u6570\u636e\u3002</li> <li>path\uff1a<code>tail</code>\u7c7b\u578b\u4e0b\u7684\u7279\u5b9a\u53c2\u6570\uff0c\u544a\u8bc9 <code>Fluentd</code> \u91c7\u96c6<code>/var/log/containers</code>\u76ee\u5f55\u4e0b\u7684\u6240\u6709\u65e5\u5fd7\uff0c\u8fd9\u662f <code>docker</code> \u5728 <code>Kubernetes</code> \u8282\u70b9\u4e0a\u7528\u6765\u5b58\u50a8\u8fd0\u884c\u5bb9\u5668 <code>stdout</code> \u8f93\u51fa\u65e5\u5fd7\u6570\u636e\u7684\u76ee\u5f55\u3002</li> <li>pos_file\uff1a\u68c0\u67e5\u70b9\uff0c\u5982\u679c <code>Fluentd</code> \u7a0b\u5e8f\u91cd\u65b0\u542f\u52a8\u4e86\uff0c\u5b83\u5c06\u4f7f\u7528\u6b64\u6587\u4ef6\u4e2d\u7684\u4f4d\u7f6e\u6765\u6062\u590d\u65e5\u5fd7\u6570\u636e\u6536\u96c6\u3002</li> <li>tag\uff1a\u7528\u6765\u5c06\u65e5\u5fd7\u6e90\u4e0e\u76ee\u6807\u6216\u8005\u8fc7\u6ee4\u5668\u5339\u914d\u7684\u81ea\u5b9a\u4e49\u5b57\u7b26\u4e32\uff0c<code>Fluentd</code> \u5339\u914d\u6e90/\u76ee\u6807\u6807\u7b7e\u6765\u8def\u7531\u65e5\u5fd7\u6570\u636e\u3002</li> </ul>"},{"location":"chap10/2EFK_log/#_2","title":"\u8def\u7531\u914d\u7f6e","text":"<p>\u4e0a\u9762\u662f\u65e5\u5fd7\u6e90\u7684\u914d\u7f6e\uff0c\u63a5\u4e0b\u6765\u770b\u770b\u5982\u4f55\u5c06\u65e5\u5fd7\u6570\u636e\u53d1\u9001\u5230 <code>Elasticsearch</code>\uff1a</p> <pre><code>&lt;match **&gt;\n\n@id elasticsearch\n\n@type elasticsearch\n\n@log_level info\n\ninclude_tag_key true\n\ntype_name fluentd\n\nhost \"#{ENV['OUTPUT_HOST']}\"\n\nport \"#{ENV['OUTPUT_PORT']}\"\n\nlogstash_format true\n\n&lt;buffer&gt;\n\n@type file\n\npath /var/log/fluentd-buffers/kubernetes.system.buffer\n\nflush_mode interval\n\nretry_type exponential_backoff\n\nflush_thread_count 2\n\nflush_interval 5s\n\nretry_forever\n\nretry_max_interval 30\n\nchunk_limit_size \"#{ENV['OUTPUT_BUFFER_CHUNK_LIMIT']}\"\n\nqueue_limit_length \"#{ENV['OUTPUT_BUFFER_QUEUE_LIMIT']}\"\n\noverflow_action block\n\n&lt;/buffer&gt;\n</code></pre> <ul> <li><code>match</code>\uff1a\u6807\u8bc6\u4e00\u4e2a\u76ee\u6807\u6807\u7b7e\uff0c\u540e\u9762\u662f\u4e00\u4e2a\u5339\u914d\u65e5\u5fd7\u6e90\u7684\u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u6211\u4eec\u8fd9\u91cc\u60f3\u8981\u6355\u83b7\u6240\u6709\u7684\u65e5\u5fd7\u5e76\u5c06\u5b83\u4eec\u53d1\u9001\u7ed9 <code>Elasticsearch</code>\uff0c\u6240\u4ee5\u9700\u8981\u914d\u7f6e\u6210<code>**</code>\u3002</li> <li><code>id</code>\uff1a\u76ee\u6807\u7684\u4e00\u4e2a\u552f\u4e00\u6807\u8bc6\u7b26\u3002</li> <li><code>type</code>\uff1a\u652f\u6301\u7684\u8f93\u51fa\u63d2\u4ef6\u6807\u8bc6\u7b26\uff0c\u6211\u4eec\u8fd9\u91cc\u8981\u8f93\u51fa\u5230 <code>Elasticsearch</code>\uff0c\u6240\u4ee5\u914d\u7f6e\u6210 <code>elasticsearch</code>\uff0c\u8fd9\u662f <code>Fluentd</code> \u7684\u4e00\u4e2a\u5185\u7f6e\u63d2\u4ef6\u3002</li> <li><code>log_level</code>\uff1a\u6307\u5b9a\u8981\u6355\u83b7\u7684\u65e5\u5fd7\u7ea7\u522b\uff0c\u6211\u4eec\u8fd9\u91cc\u914d\u7f6e\u6210<code>info</code>\uff0c\u8868\u793a\u4efb\u4f55\u8be5\u7ea7\u522b\u6216\u8005\u8be5\u7ea7\u522b\u4ee5\u4e0a\uff08<code>INFO</code>\u3001<code>WARNING</code>\u3001<code>ERROR</code>\uff09\u7684\u65e5\u5fd7\u90fd\u5c06\u88ab\u8def\u7531\u5230 <code>Elsasticsearch</code>\u3002</li> <li><code>host/port</code>\uff1a\u5b9a\u4e49 <code>Elasticsearch</code> \u7684\u5730\u5740\uff0c\u4e5f\u53ef\u4ee5\u914d\u7f6e\u8ba4\u8bc1\u4fe1\u606f\uff0c\u6211\u4eec\u7684 <code>Elasticsearch</code> \u4e0d\u9700\u8981\u8ba4\u8bc1\uff0c\u6240\u4ee5\u8fd9\u91cc\u76f4\u63a5\u6307\u5b9a <code>host</code> \u548c <code>port</code> \u5373\u53ef\u3002</li> <li><code>logstash_format</code>\uff1a<code>Elasticsearch</code> \u670d\u52a1\u5bf9\u65e5\u5fd7\u6570\u636e\u6784\u5efa\u53cd\u5411\u7d22\u5f15\u8fdb\u884c\u641c\u7d22\uff0c\u5c06 <code>logstash_format</code> \u8bbe\u7f6e\u4e3a<code>true</code>\uff0c<code>Fluentd</code> \u5c06\u4f1a\u4ee5 <code>logstash</code> \u683c\u5f0f\u6765\u8f6c\u53d1\u7ed3\u6784\u5316\u7684\u65e5\u5fd7\u6570\u636e\u3002</li> <li><code>Buffer</code>\uff1a <code>Fluentd</code> \u5141\u8bb8\u5728\u76ee\u6807\u4e0d\u53ef\u7528\u65f6\u8fdb\u884c\u7f13\u5b58\uff0c\u6bd4\u5982\uff0c\u5982\u679c\u7f51\u7edc\u51fa\u73b0\u6545\u969c\u6216\u8005 <code>Elasticsearch</code> \u4e0d\u53ef\u7528\u7684\u65f6\u5019\u3002\u7f13\u51b2\u533a\u914d\u7f6e\u4e5f\u6709\u52a9\u4e8e\u964d\u4f4e\u78c1\u76d8\u7684 <code>IO</code>\u3002</li> </ul>"},{"location":"chap10/2EFK_log/#3-3","title":"3-3 \u5b89\u88c5","text":"<p>\u8981\u6536\u96c6 <code>Kubernetes</code> \u96c6\u7fa4\u7684\u65e5\u5fd7\uff0c\u76f4\u63a5\u7528 <code>DasemonSet</code> \u63a7\u5236\u5668\u6765\u90e8\u7f72 <code>Fluentd</code> \u5e94\u7528\uff0c\u8fd9\u6837\uff0c\u5b83\u5c31\u53ef\u4ee5\u4ece <code>Kubernetes</code> \u8282\u70b9\u4e0a\u91c7\u96c6\u65e5\u5fd7\uff0c\u786e\u4fdd\u5728\u96c6\u7fa4\u4e2d\u7684\u6bcf\u4e2a\u8282\u70b9\u4e0a\u59cb\u7ec8\u8fd0\u884c\u4e00\u4e2a <code>Fluentd</code> \u5bb9\u5668\u3002\u5f53\u7136\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 <code>Helm</code> \u6765\u8fdb\u884c\u4e00\u952e\u5b89\u88c5\uff0c\u4e3a\u4e86\u80fd\u591f\u4e86\u89e3\u66f4\u591a\u5b9e\u73b0\u7ec6\u8282\uff0c\u6211\u4eec\u8fd9\u91cc\u8fd8\u662f\u91c7\u7528\u624b\u52a8\u65b9\u6cd5\u6765\u8fdb\u884c\u5b89\u88c5\u3002</p> <p>\u9996\u5148\uff0c\u6211\u4eec\u901a\u8fc7 <code>ConfigMap</code> \u5bf9\u8c61\u6765\u6307\u5b9a <code>Fluentd</code> \u914d\u7f6e\u6587\u4ef6\uff0c\u65b0\u5efa <code>fluentd-configmap.yaml</code> \u6587\u4ef6\uff0c\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>kind: ConfigMap\napiVersion: v1\nmetadata:\n  name: fluentd-config\n  namespace: logging\n  labels:\n    addonmanager.kubernetes.io/mode: Reconcile\ndata:\n  system.conf: |-\n    &lt;system&gt;\n      root_dir /tmp/fluentd-buffers/\n    &lt;/system&gt;\n  containers.input.conf: |-\n    &lt;source&gt;\n      @id fluentd-containers.log\n      @type tail\n      path /var/log/containers/*.log\n      pos_file /var/log/es-containers.log.pos\n      time_format %Y-%m-%dT%H:%M:%S.%NZ\n      localtime\n      tag raw.kubernetes.*\n      format json\n      read_from_head true\n    &lt;/source&gt;\n    # Detect exceptions in the log output and forward them as one log entry.\n    &lt;match raw.kubernetes.**&gt;\n      @id raw.kubernetes\n      @type detect_exceptions\n      remove_tag_prefix raw\n      message log\n      stream stream\n      multiline_flush_interval 5\n      max_bytes 500000\n      max_lines 1000\n    &lt;/match&gt;\n  system.input.conf: |-\n    # Logs from systemd-journal for interesting services.\n    &lt;source&gt;\n      @id journald-docker\n      @type systemd\n      filters [{ \"_SYSTEMD_UNIT\": \"docker.service\" }]\n      &lt;storage&gt;\n        @type local\n        persistent true\n      &lt;/storage&gt;\n      read_from_head true\n      tag docker\n    &lt;/source&gt;\n    &lt;source&gt;\n      @id journald-kubelet\n      @type systemd\n      filters [{ \"_SYSTEMD_UNIT\": \"kubelet.service\" }]\n      &lt;storage&gt;\n        @type local\n        persistent true\n      &lt;/storage&gt;\n      read_from_head true\n      tag kubelet\n    &lt;/source&gt;\n  forward.input.conf: |-\n    # Takes the messages sent over TCP\n    &lt;source&gt;\n      @type forward\n    &lt;/source&gt;\n  output.conf: |-\n    # Enriches records with Kubernetes metadata\n    &lt;filter kubernetes.**&gt;\n      @type kubernetes_metadata\n    &lt;/filter&gt;\n    &lt;match **&gt;\n      @id elasticsearch\n      @type elasticsearch\n      @log_level info\n      include_tag_key true\n      host elasticsearch\n      port 9200\n      logstash_format true\n      request_timeout    30s\n      &lt;buffer&gt;\n        @type file\n        path /var/log/fluentd-buffers/kubernetes.system.buffer\n        flush_mode interval\n        retry_type exponential_backoff\n        flush_thread_count 2\n        flush_interval 5s\n        retry_forever\n        retry_max_interval 30\n        chunk_limit_size 2M\n        queue_limit_length 8\n        overflow_action block\n      &lt;/buffer&gt;\n    &lt;/match&gt;\n</code></pre> <p>\u4e0a\u9762\u914d\u7f6e\u6587\u4ef6\u4e2d\u6211\u4eec\u914d\u7f6e\u4e86 <code>docker</code> \u5bb9\u5668\u65e5\u5fd7\u76ee\u5f55\u4ee5\u53ca <code>docker</code>\u3001<code>kubelet</code> \u5e94\u7528\u7684\u65e5\u5fd7\u7684\u6536\u96c6\uff0c\u6536\u96c6\u5230\u6570\u636e\u7ecf\u8fc7\u5904\u7406\u540e\u53d1\u9001\u5230 <code>elasticsearch:9200</code> \u670d\u52a1\u3002</p> <p>\u7136\u540e\u65b0\u5efa\u4e00\u4e2a <code>fluentd-daemonset.yaml</code> \u7684\u6587\u4ef6\uff0c\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: fluentd-es\n  namespace: logging\n  labels:\n    k8s-app: fluentd-es\n    kubernetes.io/cluster-service: \"true\"\n    addonmanager.kubernetes.io/mode: Reconcile\n---\nkind: ClusterRole\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: fluentd-es\n  labels:\n    k8s-app: fluentd-es\n    kubernetes.io/cluster-service: \"true\"\n    addonmanager.kubernetes.io/mode: Reconcile\nrules:\n- apiGroups:\n  - \"\"\n  resources:\n  - \"namespaces\"\n  - \"pods\"\n  verbs:\n  - \"get\"\n  - \"watch\"\n  - \"list\"\n---\nkind: ClusterRoleBinding\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: fluentd-es\n  labels:\n    k8s-app: fluentd-es\n    kubernetes.io/cluster-service: \"true\"\n    addonmanager.kubernetes.io/mode: Reconcile\nsubjects:\n- kind: ServiceAccount\n  name: fluentd-es\n  namespace: logging\n  apiGroup: \"\"\nroleRef:\n  kind: ClusterRole\n  name: fluentd-es\n  apiGroup: \"\"\n---\napiVersion: apps/v1\nkind: DaemonSet\nmetadata:\n  name: fluentd-es\n  namespace: logging\n  labels:\n    k8s-app: fluentd-es\n    version: v2.0.4\n    kubernetes.io/cluster-service: \"true\"\n    addonmanager.kubernetes.io/mode: Reconcile\nspec:\n  selector:\n    matchLabels:\n      k8s-app: fluentd-es\n      version: v2.0.4\n  template:\n    metadata:\n      labels:\n        k8s-app: fluentd-es\n        kubernetes.io/cluster-service: \"true\"\n        version: v2.0.4\n      # This annotation ensures that fluentd does not get evicted if the node\n      # supports critical pod annotation based priority scheme.\n      # Note that this does not guarantee admission on the nodes (#40573).\n      annotations:\n        scheduler.alpha.kubernetes.io/critical-pod: ''\n    spec:\n      priorityClassName: system-node-critical\n      serviceAccountName: fluentd-es\n      containers:\n      - name: fluentd-es\n        image: cnych/fluentd-elasticsearch:v2.0.4\n        env:\n        - name: FLUENTD_ARGS\n          value: --no-supervisor -q\n        resources:\n          limits:\n            memory: 500Mi\n          requests:\n            cpu: 100m\n            memory: 200Mi\n        volumeMounts:\n        - name: varlog\n          mountPath: /var/log\n        - name: varlibdockercontainers\n          mountPath: /data/docker/containers\n          readOnly: true\n        - name: config-volume\n          mountPath: /etc/fluent/config.d\n      nodeSelector:\n        beta.kubernetes.io/fluentd-ds-ready: \"true\"\n      tolerations:\n      - key: node-role.kubernetes.io/master\n        operator: Exists\n        effect: NoSchedule\n      terminationGracePeriodSeconds: 30\n      volumes:\n      - name: varlog\n        hostPath:\n          path: /var/log\n      - name: varlibdockercontainers\n        hostPath:\n          path: /data/docker/containers\n      - name: config-volume\n        configMap:\n          name: fluentd-config\n</code></pre> <p>\u6211\u4eec\u5c06\u4e0a\u9762\u521b\u5efa\u7684 <code>fluentd-config</code> \u8fd9\u4e2a <code>ConfigMap</code> \u5bf9\u8c61\u901a\u8fc7 <code>volumes</code> \u6302\u8f7d\u5230\u4e86 <code>Fluentd</code> \u5bb9\u5668\u4e2d\uff0c\u53e6\u5916\u4e3a\u4e86\u80fd\u591f\u7075\u6d3b\u63a7\u5236\u54ea\u4e9b\u8282\u70b9\u7684\u65e5\u5fd7\u53ef\u4ee5\u88ab\u6536\u96c6\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u8fd8\u6dfb\u52a0\u4e86\u4e00\u4e2a <code>nodSelector</code> \u5c5e\u6027\uff1a</p> <pre><code>nodeSelector:\n  beta.kubernetes.io/fluentd-ds-ready: \"true\"\n</code></pre> <p>\u610f\u601d\u5c31\u662f\u8981\u60f3\u91c7\u96c6\u8282\u70b9\u7684\u65e5\u5fd7\uff0c\u90a3\u4e48\u6211\u4eec\u5c31\u9700\u8981\u7ed9\u8282\u70b9\u6253\u4e0a\u4e0a\u9762\u7684\u6807\u7b7e\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc3\u4e2a\u8282\u70b9\u90fd\u6253\u4e0a\u4e86\u8be5\u6807\u7b7e\uff1a</p> <pre><code>$ kubectl get nodes --show-labels\nNAME      STATUS    ROLES     AGE       VERSION   LABELS\nmaster    Ready     master    245d      v1.10.0   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/fluentd-ds-ready=true,beta.kubernetes.io/os=linux,kubernetes.io/hostname=master,node-role.kubernetes.io/master=\nnode02    Ready     &lt;none&gt;    165d      v1.10.0   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/fluentd-ds-ready=true,beta.kubernetes.io/os=linux,com=youdianzhishi,course=k8s,kubernetes.io/hostname=node02\nnode03    Ready     &lt;none&gt;    225d      v1.10.0   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/fluentd-ds-ready=true,beta.kubernetes.io/os=linux,jnlp=haimaxy,kubernetes.io/hostname=node03\n</code></pre> <p>\u53e6\u5916\u7531\u4e8e\u6211\u4eec\u7684\u96c6\u7fa4\u4f7f\u7528\u7684\u662f <code>kubeadm</code> \u642d\u5efa\u7684\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b <code>master</code> \u8282\u70b9\u6709\u6c61\u70b9\uff0c\u6240\u4ee5\u8981\u60f3\u4e5f\u6536\u96c6 <code>master</code> \u8282\u70b9\u7684\u65e5\u5fd7\uff0c\u5219\u9700\u8981\u6dfb\u52a0\u4e0a\u5bb9\u5fcd\uff1a</p> <pre><code>tolerations:\n- key: node-role.kubernetes.io/master\n  operator: Exists\n  effect: NoSchedule\n</code></pre> <p>\u53e6\u5916\u9700\u8981\u6ce8\u610f\u7684\u5730\u65b9\u662f\uff0c\u6211\u8fd9\u91cc\u7684\u6d4b\u8bd5\u73af\u5883\u66f4\u6539\u4e86 <code>docker</code> \u7684\u6839\u76ee\u5f55\uff1a</p> <pre><code>$ docker info\n...\nDocker Root Dir: /data/docker\n...\n</code></pre> <p>\u6240\u4ee5\u4e0a\u9762\u8981\u83b7\u53d6 <code>docker</code> \u7684\u5bb9\u5668\u76ee\u5f55\u9700\u8981\u66f4\u6539\u6210<code>/data/docker/containers</code>\uff0c\u8fd9\u4e2a\u5730\u65b9\u975e\u5e38\u91cd\u8981\uff0c\u5f53\u7136\u5982\u679c\u4f60\u6ca1\u6709\u66f4\u6539 <code>docker</code> \u6839\u76ee\u5f55\u5219\u4f7f\u7528\u9ed8\u8ba4\u7684 <code>/var/lib/docker/containers</code> \u76ee\u5f55\u5373\u53ef\u3002</p> <p>\u5206\u522b\u521b\u5efa\u4e0a\u9762\u7684 <code>ConfigMap</code> \u5bf9\u8c61\u548c <code>DaemonSet</code>\uff1a</p> <pre><code>$ kubectl create -f fluentd-configmap.yaml\nconfigmap \"fluentd-config\" created\n$ kubectl create -f fluentd-daemonset.yaml\nserviceaccount \"fluentd-es\" created\nclusterrole.rbac.authorization.k8s.io \"fluentd-es\" created\nclusterrolebinding.rbac.authorization.k8s.io \"fluentd-es\" created\ndaemonset.apps \"fluentd-es\" created\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u67e5\u770b\u5bf9\u5e94\u7684 Pods \u5217\u8868\uff0c\u68c0\u67e5\u662f\u5426\u90e8\u7f72\u6210\u529f\uff1a</p> <pre><code>$ kubectl get pods -n logging\nNAME                      READY     STATUS    RESTARTS   AGE\nes-cluster-0              1/1       Running   0          1d\nes-cluster-1              1/1       Running   0          1d\nes-cluster-2              1/1       Running   0          1d\nfluentd-es-2z9jg          1/1       Running   1          35s\nfluentd-es-6dfdd          1/1       Running   0          35s\nfluentd-es-bfkg7          1/1       Running   0          35s\nkibana-7558d4dc4d-5mqdz   1/1       Running   0          1d\n</code></pre> <p><code>Fluentd</code> \u542f\u52a8\u6210\u529f\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u524d\u5f80 <code>Kibana</code> \u7684 <code>Dashboard</code> \u9875\u9762\u4e2d\uff0c\u70b9\u51fb\u5de6\u4fa7\u7684<code>Discover</code>\uff0c\u53ef\u4ee5\u770b\u5230\u5982\u4e0b\u914d\u7f6e\u9875\u9762\uff1a</p> <p></p> <p>\u5728\u8fd9\u91cc\u53ef\u4ee5\u914d\u7f6e\u6211\u4eec\u9700\u8981\u7684 <code>Elasticsearch</code> \u7d22\u5f15\uff0c\u524d\u9762 <code>Fluentd</code> \u914d\u7f6e\u6587\u4ef6\u4e2d\u6211\u4eec\u91c7\u96c6\u7684\u65e5\u5fd7\u4f7f\u7528\u7684\u662f <code>logstash</code> \u683c\u5f0f\uff0c\u8fd9\u91cc\u53ea\u9700\u8981\u5728\u6587\u672c\u6846\u4e2d\u8f93\u5165<code>logstash-*</code>\u5373\u53ef\u5339\u914d\u5230 <code>Elasticsearch</code> \u96c6\u7fa4\u4e2d\u7684\u6240\u6709\u65e5\u5fd7\u6570\u636e\uff0c\u7136\u540e\u70b9\u51fb\u4e0b\u4e00\u6b65\uff0c\u8fdb\u5165\u4ee5\u4e0b\u9875\u9762\uff1a</p> <p></p> <p>\u5728\u8be5\u9875\u9762\u4e2d\u914d\u7f6e\u4f7f\u7528\u54ea\u4e2a\u5b57\u6bb5\u6309\u65f6\u95f4\u8fc7\u6ee4\u65e5\u5fd7\u6570\u636e\uff0c\u5728\u4e0b\u62c9\u5217\u8868\u4e2d\uff0c\u9009\u62e9<code>@timestamp</code>\u5b57\u6bb5\uff0c\u7136\u540e\u70b9\u51fb<code>Create index pattern</code>\uff0c\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u70b9\u51fb\u5de6\u4fa7\u5bfc\u822a\u83dc\u5355\u4e2d\u7684<code>Discover</code>\uff0c\u7136\u540e\u5c31\u53ef\u4ee5\u770b\u5230\u4e00\u4e9b\u76f4\u65b9\u56fe\u548c\u6700\u8fd1\u91c7\u96c6\u5230\u7684\u65e5\u5fd7\u6570\u636e\u4e86\uff1a</p> <p></p>"},{"location":"chap10/2EFK_log/#3-4","title":"3-4 \u6d4b\u8bd5","text":"<p>\u73b0\u5728\u6211\u4eec\u6765\u5c06\u4e0a\u4e00\u8282\u8bfe\u7684\u8ba1\u6570\u5668\u5e94\u7528\u90e8\u7f72\u5230\u96c6\u7fa4\u4e2d\uff0c\u5e76\u5728 <code>Kibana</code> \u4e2d\u6765\u67e5\u627e\u8be5\u65e5\u5fd7\u6570\u636e\u3002</p> <p>\u65b0\u5efa <code>counter.yaml</code> \u6587\u4ef6\uff0c\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: counter\nspec:\n  containers:\n  - name: count\n    image: busybox\n    args: [/bin/sh, -c,\n            'i=0; while true; do echo \"$i: $(date)\"; i=$((i+1)); sleep 1; done']\n</code></pre> <p>\u8be5 <code>Pod</code> \u53ea\u662f\u7b80\u5355\u5c06\u65e5\u5fd7\u4fe1\u606f\u6253\u5370\u5230 <code>stdout</code>\uff0c\u6240\u4ee5\u6b63\u5e38\u6765\u8bf4 <code>Fluentd</code> \u4f1a\u6536\u96c6\u5230\u8fd9\u4e2a\u65e5\u5fd7\u6570\u636e\uff0c\u5728 <code>Kibana</code> \u4e2d\u4e5f\u5c31\u53ef\u4ee5\u627e\u5230\u5bf9\u5e94\u7684\u65e5\u5fd7\u6570\u636e\u4e86\uff0c\u4f7f\u7528 <code>kubectl</code> \u5de5\u5177\u521b\u5efa\u8be5 <code>Pod</code>\uff1a</p> <pre><code>$ kubectl create -f counter.yaml\n</code></pre> <p><code>Pod</code> \u521b\u5efa\u5e76\u8fd0\u884c\u540e\uff0c\u56de\u5230 <code>Kibana Dashboard</code> \u9875\u9762\uff0c\u5728\u4e0a\u9762\u7684<code>Discover</code>\u9875\u9762\u641c\u7d22\u680f\u4e2d\u8f93\u5165<code>kubernetes.pod_name:counter</code>\uff0c\u5c31\u53ef\u4ee5\u8fc7\u6ee4 <code>Pod</code> \u540d\u4e3a <code>counter</code> \u7684\u65e5\u5fd7\u6570\u636e\uff1a</p> <p></p> <p>\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7\u5176\u4ed6\u5143\u6570\u636e\u6765\u8fc7\u6ee4\u65e5\u5fd7\u6570\u636e\uff0c\u6bd4\u5982 \u60a8\u53ef\u4ee5\u5355\u51fb\u4efb\u4f55\u65e5\u5fd7\u6761\u76ee\u4ee5\u67e5\u770b\u5176\u4ed6\u5143\u6570\u636e\uff0c\u5982\u5bb9\u5668\u540d\u79f0\uff0cKubernetes \u8282\u70b9\uff0c\u547d\u540d\u7a7a\u95f4\u7b49\u3002</p> <p>\u5230\u8fd9\u91cc\uff0c\u6211\u4eec\u5c31\u5728 <code>Kubernetes</code> \u96c6\u7fa4\u4e0a\u6210\u529f\u90e8\u7f72\u4e86 <code>EFK</code> \uff0c\u8981\u4e86\u89e3\u5982\u4f55\u4f7f\u7528 <code>Kibana</code> \u8fdb\u884c\u65e5\u5fd7\u6570\u636e\u5206\u6790\uff0c\u53ef\u4ee5\u53c2\u8003 <code>Kibana</code> \u7528\u6237\u6307\u5357\u6587\u6863\uff1ahttps://www.elastic.co/guide/en/kibana/current/index.html</p> <p>\u5f53\u7136\u5bf9\u4e8e\u5728\u751f\u4ea7\u73af\u5883\u4e0a\u4f7f\u7528 <code>Elaticsearch</code> \u6216\u8005 <code>Fluentd</code>\uff0c\u8fd8\u9700\u8981\u7ed3\u5408\u5b9e\u9645\u7684\u73af\u5883\u505a\u4e00\u7cfb\u5217\u7684\u4f18\u5316\u5de5\u4f5c\uff0c\u672c\u6587\u4e2d\u6d89\u53ca\u5230\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u90fd\u53ef\u4ee5\u5728https://github.com/cnych/kubernetes-learning/tree/master/efkdemo\u627e\u5230\u3002</p> <p>https://www.digitalocean.com/community/tutorials/how-to-set-up-an-elasticsearch-fluentd-and-kibana-efk-logging-stack-on-kubernetes</p>"},{"location":"chap10/3ECK_operator/","title":"\u7b2c\u516d\u8282 \u4f7f\u7528Operator\u5feb\u901f\u90e8\u7f72Elasticsearch\u96c6\u7fa4","text":"<p>\u968f\u7740 <code>kubernetes</code> \u7684\u5feb\u901f\u53d1\u5c55\uff0c\u5f88\u591a\u5e94\u7528\u90fd\u5728\u5f80 <code>kubernetes</code> \u4e0a\u9762\u8fc1\u79fb\uff0c\u73b0\u9636\u6bb5\u5bf9\u4e8e\u65e0\u72b6\u6001\u5e94\u7528\u7684\u8fc1\u79fb\u662f\u975e\u5e38\u5bb9\u6613\u505a\u5230\u7684\uff0c\u4f46\u662f\u5bf9\u4e8e\u6709\u72b6\u6001\u5e94\u7528\u7684\u8fc1\u79fb\u8fd8\u662f\u6709\u4e00\u5b9a\u95e8\u69db\u7684\uff0c\u4e3b\u8981\u662f\u6709\u72b6\u6001\u5e94\u7528\u7684\u8fd0\u884c\u65b9\u5f0f\u5404\u6709\u4e0d\u540c\uff0c\u6bd4\u5982 <code>MySQL</code>\u3001<code>MongoDB</code>\u3001<code>Redis</code> \u8fd9\u4e9b\u5e94\u7528\u8fd0\u884c\u7684\u65b9\u5f0f\u65b9\u6cd5\u90fd\u4e0d\u592a\u76f8\u540c\uff0c\u7279\u522b\u662f\u5bf9\u4e8e\u7ebf\u4e0a\u73af\u5883\u9700\u8981\u9ad8\u53ef\u7528\u7684\u96c6\u7fa4\u6a21\u5f0f\u7684\u65f6\u5019\uff0c\u5219\u5dee\u522b\u5c31\u66f4\u5927\u4e86\uff0c\u8fd9\u5c31\u5bfc\u81f4\u4e86\u6709\u72b6\u6001\u5e94\u7528\u5411 <code>Kubernetes</code> \u7684\u8fc1\u79fb\u5fc5\u7136\u8fdb\u5ea6\u4f1a\u5f88\u6162\u3002</p> <p>\u73b0\u5728\u6bd4\u8f83\u597d\u7684\u89e3\u51b3\u65b9\u6848\u5c31\u662f\u9488\u5bf9\u6709\u72b6\u6001\u5e94\u7528\u5f00\u53d1\u5bf9\u5e94\u7684 <code>Operator</code> \u5e94\u7528\uff0c\u6bd4\u5982 <code>prometheus-operator</code>\u3001<code>etcd-operator</code> \u7b49\u7b49\uff0c\u5173\u4e8e <code>Operator</code> \u7684\u5f00\u53d1\uff0c\u53ef\u4ee5\u67e5\u770b\u524d\u9762\u7684\u4e00\u7bc7\u5165\u95e8\u6587\u7ae0\uff1a<code>Kubernetes Operator</code> \u5feb\u901f\u5165\u95e8\u6559\u7a0b\u4ee5\u4e86\u89e3\u66f4\u591a\u4fe1\u606f\u3002</p> <p>\u540c\u6837\u7684\uff0c\u5bf9\u4e8e <code>Elasticsearch</code> \u5e94\u7528\uff0c\u73b0\u5728\u5b98\u65b9\u4e5f\u63a8\u51fa\u4e86\u57fa\u4e8e <code>Kubernetes Operator</code>\u7684\u5e94\u7528\uff1a<code>Elastic Cloud on Kubernetes (ECK)</code>\uff0c\u7528\u6237\u53ef\u4f7f\u7528\u8be5\u4ea7\u54c1\u5728 Kubernetes \u4e0a\u914d\u7f6e\u3001\u7ba1\u7406\u548c\u8fd0\u884c <code>Elasticsearch</code> \u96c6\u7fa4\u3002</p>"},{"location":"chap10/3ECK_operator/#elastic-cloud-on-kubernetes","title":"Elastic Cloud on Kubernetes","text":"<p><code>Elastic Cloud on Kubernetes(ECK)</code> \u662f\u4e00\u4e2a <code>Elasticsearch Operator</code>\uff0c\u4f46\u8fdc\u4e0d\u6b62\u4e8e\u6b64\u3002 <code>ECK</code> \u4f7f\u7528 <code>Kubernetes Operator</code> \u6a21\u5f0f\u6784\u5efa\u800c\u6210\uff0c\u9700\u8981\u5b89\u88c5\u5728\u60a8\u7684 <code>Kubernetes</code> \u96c6\u7fa4\u5185\uff0c\u5176\u529f\u80fd\u7edd\u4e0d\u4ec5\u9650\u4e8e\u7b80\u5316 <code>Kubernetes</code> \u4e0a <code>Elasticsearch</code> \u548c <code>Kibana</code> \u7684\u90e8\u7f72\u5de5\u4f5c\u8fd9\u4e00\u9879\u4efb\u52a1\u3002ECK \u4e13\u6ce8\u4e8e\u7b80\u5316\u6240\u6709\u540e\u671f\u8fd0\u884c\u5de5\u4f5c\uff0c\u4f8b\u5982\uff1a</p> <ul> <li>\u7ba1\u7406\u548c\u76d1\u6d4b\u591a\u4e2a\u96c6\u7fa4</li> <li>\u8f7b\u677e\u5347\u7ea7\u81f3\u65b0\u7684\u7248\u672c</li> <li>\u6269\u5927\u6216\u7f29\u5c0f\u96c6\u7fa4\u5bb9\u91cf</li> <li>\u66f4\u6539\u96c6\u7fa4\u914d\u7f6e</li> <li>\u52a8\u6001\u8c03\u6574\u672c\u5730\u5b58\u50a8\u7684\u89c4\u6a21\uff08\u5305\u62ec <code>Elastic Local Volume</code>\uff08\u4e00\u6b3e\u672c\u5730\u5b58\u50a8\u9a71\u52a8\u5668\uff09\uff09</li> <li>\u5907\u4efd</li> </ul> <p><code>ECK</code> \u4e0d\u4ec5\u80fd\u81ea\u52a8\u5b8c\u6210\u6240\u6709\u8fd0\u884c\u548c\u96c6\u7fa4\u7ba1\u7406\u4efb\u52a1\uff0c\u8fd8\u4e13\u6ce8\u4e8e\u7b80\u5316\u5728 <code>Kubernetes</code> \u4e0a\u4f7f\u7528 <code>Elasticsearch</code> \u7684\u5b8c\u6574\u4f53\u9a8c\u3002<code>ECK</code>\u7684\u613f\u666f\u662f\u4e3a <code>Kubernetes</code> \u4e0a\u7684 <code>Elastic</code> \u4ea7\u54c1\u548c\u89e3\u51b3\u65b9\u6848\u63d0\u4f9b <code>SaaS</code> \u822c\u7684\u4f53\u9a8c\u3002</p> <p>\u5728 <code>ECK</code> \u4e0a\u542f\u52a8\u7684\u6240\u6709 <code>Elasticsearch</code> \u96c6\u7fa4\u90fd\u9ed8\u8ba4\u53d7\u5230\u4fdd\u62a4\uff0c\u8fd9\u610f\u5473\u7740\u5728\u6700\u521d\u521b\u5efa\u7684\u90a3\u4e00\u523b\u4fbf\u5df2\u542f\u7528\u52a0\u5bc6\u5e76\u53d7\u5230\u9ed8\u8ba4\u5f3a\u5bc6\u7801\u7684\u4fdd\u62a4\u3002</p> <p>\u4ece <code>6.8</code> \u548c <code>7.1</code> \u7248\u672c\u5f00\u59cb\uff0c<code>Elasticsearch</code> \u6838\u5fc3\u5b89\u5168\u529f\u80fd\uff08TLS \u52a0\u5bc6\u3001\u57fa\u4e8e\u89d2\u8272\u7684\u8bbf\u95ee\u63a7\u5236\uff0c\u4ee5\u53ca\u6587\u4ef6\u548c\u539f\u751f\u8eab\u4efd\u9a8c\u8bc1\uff09\u4f1a\u514d\u8d39\u63d0\u4f9b\u3002</p> <p>\u901a\u8fc7 <code>ECK</code> \u90e8\u7f72\u7684\u6240\u6709\u96c6\u7fa4\u90fd\u5305\u62ec\u5f3a\u5927\u7684\u57fa\u7840\uff08\u514d\u8d39\uff09\u7ea7\u529f\u80fd\uff0c\u4f8b\u5982\u53ef\u5b9e\u73b0\u5bc6\u96c6\u5b58\u50a8\u7684\u51bb\u7ed3\u7d22\u5f15\u3001<code>Kibana Spaces</code>\u3001<code>Canvas</code>\u3001<code>Elastic Maps</code>\uff0c\u7b49\u7b49\u3002\u60a8\u751a\u81f3\u53ef\u4ee5\u4f7f\u7528 <code>Elastic Logs</code> \u548c <code>Elastic Infrastructure</code> \u5e94\u7528\u76d1\u6d4b <code>Kubernetes</code> \u65e5\u5fd7\u548c\u57fa\u7840\u8bbe\u65bd\u3002\u60a8\u53ef\u4ee5\u83b7\u5f97\u5728 <code>Kubernetes</code> \u4e0a\u4f7f\u7528 <code>Elastic Stack</code> \u5b8c\u6574\u529f\u80fd\u7684\u4f53\u9a8c\u3002</p> <p><code>ECK</code> \u5185\u6784\u5efa\u4e86 <code>Elastic Local Volume</code>\uff0c\u8fd9\u662f\u4e00\u4e2a\u9002\u7528\u4e8e <code>Kubernetes</code> \u7684\u96c6\u6210\u5f0f\u5b58\u50a8\u9a71\u52a8\u5668\u3002<code>ECK</code> \u4e2d\u8fd8\u878d\u5165\u4e86\u5f88\u591a\u6700\u4f73\u5b9e\u8df5\uff0c\u4f8b\u5982\u5728\u7f29\u5c0f\u89c4\u6a21\u4e4b\u524d\u5bf9\u8282\u70b9\u8fdb\u884c <code>drain</code> \u64cd\u4f5c\uff0c\u5728\u6269\u5927\u89c4\u6a21\u7684\u65f6\u5019\u5bf9\u5206\u7247\u8fdb\u884c\u518d\u5e73\u8861\uff0c\u7b49\u7b49\u3002\u4ece\u786e\u4fdd\u5728\u914d\u7f6e\u53d8\u52a8\u8fc7\u7a0b\u4e2d\u4e0d\u4f1a\u4e22\u5931\u6570\u636e\uff0c\u5230\u786e\u4fdd\u5728\u89c4\u6a21\u8c03\u6574\u8fc7\u7a0b\u4e2d\u5b9e\u73b0\u96f6\u4e2d\u65ad\u3002</p>"},{"location":"chap10/3ECK_operator/#eck","title":"\u5b89\u88c5 ECK","text":"<p>\u5f53\u7136\u524d\u63d0\u662f\u4f60\u8981\u6709\u4e00\u4e2a\u5df2\u7ecf\u53ef\u8fd0\u884c\u7684 <code>kubernetes</code> \u96c6\u7fa4\uff081.11\u7248\u672c\u4ee5\u4e0a\uff09\uff0c\u6700\u597d\u786e\u4fdd\u4f60\u7684\u6bcf\u4e2a\u8282\u70b9\u4e0a\u81f3\u5c11\u67094GB\u5185\u5b58\u53ef\u4ee5\u4f7f\u7528\uff0c\u56e0\u4e3a\u6211\u4eec\u77e5\u9053 <code>Elasticsearch</code> \u662f\u6bd4\u8f83\u6d88\u8017\u8d44\u6e90\u7684\u3002</p> <p>\u9996\u5148\u5728\u96c6\u7fa4\u4e2d\u5b89\u88c5 <code>ECK</code> \u5bf9\u5e94\u7684 <code>Operator</code> \u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f https://download.elastic.co/downloads/eck/0.8.1/all-in-one.yaml\ncustomresourcedefinition.apiextensions.k8s.io/apmservers.apm.k8s.elastic.co created\ncustomresourcedefinition.apiextensions.k8s.io/clusterlicenses.elasticsearch.k8s.elastic.co created\ncustomresourcedefinition.apiextensions.k8s.io/elasticsearches.elasticsearch.k8s.elastic.co created\ncustomresourcedefinition.apiextensions.k8s.io/enterpriselicenses.elasticsearch.k8s.elastic.co created\ncustomresourcedefinition.apiextensions.k8s.io/remoteclusters.elasticsearch.k8s.elastic.co created\ncustomresourcedefinition.apiextensions.k8s.io/trustrelationships.elasticsearch.k8s.elastic.co created\ncustomresourcedefinition.apiextensions.k8s.io/users.elasticsearch.k8s.elastic.co created\ncustomresourcedefinition.apiextensions.k8s.io/kibanas.kibana.k8s.elastic.co created\nclusterrole.rbac.authorization.k8s.io/elastic-operator created\nclusterrolebinding.rbac.authorization.k8s.io/elastic-operator created\nnamespace/elastic-system created\nstatefulset.apps/elastic-operator created\nsecret/webhook-server-secret created\nserviceaccount/elastic-operator created\n</code></pre> <p>\u5b89\u88c5\u6210\u529f\u540e\uff0c\u4f1a\u81ea\u52a8\u521b\u5efa\u4e00\u4e2a <code>elastic-system</code> \u7684 <code>namespace</code> \u4ee5\u53ca\u4e00\u4e2a <code>operator</code> \u7684 <code>Pod</code>\uff1a</p> <pre><code>$ kubectl get ns\nNAME             STATUS   AGE\nelastic-system   Active   40s\n</code></pre> <pre><code>$ kubectl get pods -n elastic-system\nNAME                 READY   STATUS    RESTARTS   AGE\nelastic-operator-0   1/1     Running   1          2m\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u4f1a\u5b89\u88c5\u4e0a\u82e5\u5e72\u4e2a <code>CRD</code>\u5bf9\u8c61\uff0c\u5f53\u7136\u8fd9\u4e9b <code>CRD</code> \u8d44\u6e90\u7684\u63a7\u5236\u5668\u5c31\u5728\u4e0a\u9762\u7684 <code>elastic-operator-0</code> \u8fd9\u4e2a <code>Pod</code> \u4e2d\uff1a</p> <pre><code>$ kubectl get crd  | grep elastic\napmservers.apm.k8s.elastic.co                     2019-07-03T06:52:56Z\nclusterlicenses.elasticsearch.k8s.elastic.co      2019-07-03T06:53:00Z\nelasticsearches.elasticsearch.k8s.elastic.co      2019-07-03T06:53:00Z\nenterpriselicenses.elasticsearch.k8s.elastic.co   2019-07-03T06:53:00Z\nkibanas.kibana.k8s.elastic.co                     2019-07-03T06:53:00Z\nremoteclusters.elasticsearch.k8s.elastic.co       2019-07-03T06:53:00Z\ntrustrelationships.elasticsearch.k8s.elastic.co   2019-07-03T06:53:00Z\nusers.elasticsearch.k8s.elastic.co                2019-07-03T06:53:00Z\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u5229\u7528 <code>CRD</code> \u5bf9\u8c61\u6765\u521b\u5efa\u4e00\u4e2a\u975e\u5e38\u7b80\u5355\u7684\u5355\u4e2a <code>Elasticsearch</code> \u96c6\u7fa4\uff1a(<code>elastic.yaml</code>)</p> <pre><code>apiVersion: elasticsearch.k8s.elastic.co/v1alpha1\nkind: Elasticsearch\nmetadata:\n  name: elastic\n  namespace: elastic-system\nspec:\n  version: 7.2.0\n  nodes:\n  - nodeCount: 1\n    config:\n      node.master: true\n      node.data: true\n      node.ingest: true\n</code></pre> <p>\u58f0\u660e\u4e86\u8981\u521b\u5efa\u4e00\u4e2a <code>7.2.0</code> \u7248\u672c\u7684\u5355\u8282\u70b9\u7684 <code>Elasticsearch</code> \u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl create -f elastic.yaml\n</code></pre> <p>\u4f46\u662f\u6267\u884c\u4e0a\u9762\u7684\u547d\u4ee4\u4f1a\u51fa\u73b0\u8d85\u65f6\u7684\u60c5\u51b5\uff1a<code>Error from server (Timeout): error when creating \"STDIN\": Timeout: request did not complete within requested timeout 30s</code>\uff0c\u521b\u5efa\u4e0d\u6210\u529f\u3002\u8fd9\u4e3b\u8981\u662f\u56e0\u4e3a <code>ECK</code> \u6dfb\u52a0\u4e86\u4e00\u4e2a <code>validation webhook</code> \u7684 <code>Admission</code>\uff0c\u6211\u4eec\u53ef\u4ee5\u4e34\u65f6\u5c06\u8fd9\u4e2a\u5bf9\u8c61\u5220\u9664\uff1a</p> <pre><code># Hi, get backup firstly\n$ kubectl get ValidatingWebhookConfiguration -o yaml &gt; ValidatingWebhookConfiguration.yaml\n# Delete ValdiationWebhook\n$ kubectl delete ValidatingWebhookConfiguration validating-webhook-configuration\n</code></pre> <p>\u7136\u540e\u91cd\u65b0\u6267\u884c\u4e0a\u9762\u7684\u521b\u5efa\u547d\u4ee4\u5373\u53ef\u6210\u529f\u3002\u521b\u5efa\u6210\u529f\u540e\u9700\u8981\u7b49\u4e00\u5c0f\u4f1a\u513f\u5f85\u955c\u50cf\u62c9\u53d6\u6210\u529f\uff0c\u7136\u540e\u5c31\u53ef\u4ee5\u770b\u5230\u4e00\u4e2a\u524d\u7f00\u4e3a<code>elastic</code>\u7684 <code>Pod</code> \u8fd0\u884c\u6210\u529f\uff1a</p> <p>Image still pulling problem</p> <pre><code>$ kubectl get pods -n elastic-system\nNAME                    READY   STATUS     RESTARTS   AGE\nelastic-es-7rkw2xzdbw   0/1     Init:0/4   0          54s\nelastic-operator-0      1/1     Running    1          5m\n</code></pre> <pre><code>$ docker pull elasticsearch:7.2.0\n</code></pre> <p>\u7136\u540e\u91cd\u65b0\u6267\u884c\u4e0a\u9762\u7684\u521b\u5efa\u547d\u4ee4\u5373\u53ef\u6210\u529f\u3002\u521b\u5efa\u6210\u529f\u540e\u9700\u8981\u7b49\u4e00\u5c0f\u4f1a\u513f\u5f85\u955c\u50cf\u62c9\u53d6\u6210\u529f\uff0c\u7136\u540e\u5c31\u53ef\u4ee5\u770b\u5230\u4e00\u4e2a\u524d\u7f00\u4e3a<code>elastic</code>\u7684 <code>Pod</code> \u8fd0\u884c\u6210\u529f\uff1a</p> <pre><code>$ get pods -n elastic-system\nNAME                             READY   STATUS    RESTARTS   AGE\nelastic-es-h4xns977f5            1/1     Running   0          3h10m\nelastic-operator-0               1/1     Running   1          15h\n</code></pre> <p>\u540c\u6837\u53ef\u4ee5\u67e5\u770b\u81ea\u5b9a\u4e49\u7684<code>Elasticsearch</code>\u8fd9\u4e2a <code>CRD</code> \u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl get elasticsearch -n elastic-system\nNAME      HEALTH   NODES   VERSION   PHASE         AGE\nelastic   green    1       7.2.0     Operational   16h\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u96c6\u7fa4\u7684\u76f8\u5173\u4fe1\u606f\u3002</p> <p>\u540c\u6837\uff0c\u4e5f\u53ef\u4ee5\u7528 <code>CRD</code> \u5bf9\u8c61 <code>Kibana</code> \u6765\u90e8\u7f72 <code>kibana</code> \u5e94\u7528\uff1a(<code>kibana.yaml</code>)</p> <pre><code>apiVersion: kibana.k8s.elastic.co/v1alpha1\nkind: Kibana\nmetadata:\n  name: kibana\n  namespace: elastic-system\nspec:\n  version: 7.2.0\n  nodeCount: 1\n  elasticsearchRef:\n    name: elastic\n</code></pre> <p>\u6ce8\u610f\u5c5e\u6027<code>spec.elasticsearchRef.name</code>\u7684\u503c\u4e3a\u4e0a\u9762\u6211\u4eec\u521b\u5efa\u7684 <code>Elasticsearch</code> \u5bf9\u8c61\u7684 <code>name\uff1aelastic</code>\u3002\u76f4\u63a5\u6dfb\u52a0\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a</p> <p><code>docker pull docker.elastic.co/kibana/kibana:7.2.0</code></p> <pre><code>$ kubectl create -f kibana.yaml\n$ kubectl get pods -n elastic-system\nNAME                             READY   STATUS    RESTARTS   AGE\nelastic-es-h4xns977f5            1/1     Running   0          3h15m\nelastic-operator-0               1/1     Running   1          15h\nkibana-kibana-79479c64bc-zpdr7   1/1     Running   0          162m\n$ kubectl get svc -n elastic-system\nNAME                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE\nelastic-es                ClusterIP   10.103.72.176    &lt;none&gt;        9200/TCP   22h\nelastic-es-discovery      ClusterIP   None             &lt;none&gt;        9300/TCP   22h\nelastic-webhook-service   ClusterIP   10.110.255.150   &lt;none&gt;        443/TCP    22h\nkibana-kibana             ClusterIP   10.101.233.229   &lt;none&gt;        5601/TCP   6h21m\n</code></pre> <pre><code>$ kubectl get svc -n elastic-system\nNAME                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE\nelastic-es                ClusterIP   10.103.72.176    &lt;none&gt;        9200/TCP   22h\nelastic-es-discovery      ClusterIP   None             &lt;none&gt;        9300/TCP   22h\nelastic-webhook-service   ClusterIP   10.110.255.150   &lt;none&gt;        443/TCP    22h\nkibana-kibana             ClusterIP   10.101.233.229   &lt;none&gt;        5601/TCP   6h25m\n</code></pre> <p>\u6700\u540e\u6211\u4eec\u53ef\u4ee5\u53bb\u8bbf\u95ee kibana \u6765\u9a8c\u8bc1\u6211\u4eec\u7684\u96c6\u7fa4\uff0c\u6bd4\u5982\u6211\u4eec\u53ef\u4ee5\u518d\u6dfb\u52a0\u4e00\u4e2a Ingress \u5bf9\u8c61\uff1a(ingress.yaml)</p> <pre><code>apiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  name: kibana\n  namespace: elastic-system\n  annotations:\n    kubernetes.io/ingress.class: nginx\nspec:\n  rules:\n  - host: kibana.jacob-test.com\n    http:\n      paths:\n      - backend:\n          serviceName: kibana-kibana\n          servicePort: 5601\n        path: /\n\n</code></pre> <p>\u521b\u5efa\u4e0a\u9762\u7684 Ingress \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl create -f ingress.yaml\ningress.extensions/kibana created\n\n$ kubectl get ingress -n elastic-system\nNAME     HOSTS                   ADDRESS   PORTS   AGE\nkibana   kibana.jacob-test.com             80      7s\n</code></pre> <p>\u5c06\u4e0a\u9762\u7684\u57df\u540d\u505a\u597d DNS \u89e3\u6790\u6216\u8005 hosts \u6620\u5c04\u3002</p> <p>\u7136\u540e\u6211\u4eec\u9700\u8981\u83b7\u53d6\u8bbf\u95ee <code>kibana</code> \u7684\u7528\u6237\u540d\u548c\u5bc6\u7801\uff0c\u7528\u6237\u540d\u9ed8\u8ba4\u662f<code>elastic</code>\uff0c\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u65b9\u5f0f\u83b7\u53d6\u8bbf\u95ee\u5bc6\u7801\uff1a</p> <pre><code>$ PASSWORD=$(kubectl get secret elastic-elastic-user -n elastic-system -o=jsonpath='{.data.elastic}' | base64 --decode)\n$ echo $PASSWORD\n...\u8fd9\u662f\u8bbf\u95ee\u5bc6\u7801..\nvz8flb8z8m92dfk5z4j472pp\n</code></pre> <p>\u63a5\u4e0b\u6765\u5728\u6d4f\u89c8\u5668\u4e2d\u6253\u5f00\u4e0a\u9762\u7684<code>kibana.jacob-test.com</code>\u5730\u5740\uff0c\u6b63\u5e38\u5c31\u4f1a\u8df3\u8f6c\u5230\u767b\u5f55\u9875\u9762\u4e86\uff1a</p> <p></p> <p>\u4f7f\u7528\u4e0a\u9762\u7684\u7528\u6237\u540d\u548c\u5bc6\u7801\u767b\u5f55\u5373\u53ef\u8fdb\u5165 <code>kibana dashboard</code> \u9875\u9762\uff1a</p> <p></p>"},{"location":"chap10/3ECK_operator/#_1","title":"\u66f4\u65b0\u96c6\u7fa4","text":"<p>\u4e0a\u9762\u6211\u4eec\u90e8\u7f72\u7684 <code>Elasticsearch</code> \u96c6\u7fa4\u662f\u4e00\u4e2a\u5355\u8282\u70b9\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u4fee\u6539 <code>Elasticsearch</code> \u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u6765\u4fee\u6539\u96c6\u7fa4\u914d\u7f6e\u3002ECK \u4f1a\u786e\u4fdd\u6211\u4eec\u5728\u73b0\u6709\u96c6\u7fa4\u4e0a\u8fdb\u884c\u4fee\u6539\u4e0d\u4f1a\u4e2d\u65ad\u5e94\u7528\u3002</p> <p>\u6bd4\u5982\uff0c\u6211\u4eec\u5c06\u96c6\u7fa4\u5347\u7ea7\u52302\u4e2a\u8282\u70b9\uff0c\u53ea\u9700\u8981\u8bbe\u7f6e<code>spec.nodes[0].nodeCount=2</code>\u5373\u53ef\uff1a</p> <pre><code>apiVersion: elasticsearch.k8s.elastic.co/v1alpha1\nkind: Elasticsearch\nmetadata:\n  name: elastic\n  namespace: elastic-system\nspec:\n  version: 7.2.0\n  nodes:\n  - nodeCount: 2\n    config:\n      node.master: true\n      node.data: true\n      node.ingest: true\n</code></pre> <p>\u76f4\u63a5\u66f4\u65b0\u96c6\u7fa4\u4fe1\u606f\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f elastic.yaml\n$ kubectl get pods -n elastic-system\nNAME                             READY   STATUS    RESTARTS   AGE\nelastic-es-7pz8pv5ztj            1/1     Running   0          7m56s\nelastic-es-h4xns977f5            1/1     Running   0          3h36m\nelastic-operator-0               1/1     Running   1          15h\nkibana-kibana-79479c64bc-zpdr7   1/1     Running   0          3h3m\n$ kubectl get elasticsearch -n elastic-system\nNAME      HEALTH   NODES   VERSION   PHASE         AGE\nelastic   green    2       7.2.0     Operational   3h37m\n</code></pre>"},{"location":"chap10/3ECK_operator/#_2","title":"\u6301\u4e45\u5316","text":"<p>\u4e0a\u9762\u6211\u4eec\u90e8\u7f72\u7684\u96c6\u7fa4\u9ed8\u8ba4\u662f\u4f7f\u7528\u7684<code>emptyDir volume</code>\uff0c\u6211\u4eec\u77e5\u9053<code>emptyDir</code>\u548c <code>Pod</code> \u7684\u751f\u547d\u5468\u671f\u662f\u4e00\u81f4\u7684\uff0cPod \u91cd\u5efa\u540e\u6570\u636e\u80af\u5b9a\u5c31\u6ca1\u6709\u4e86\uff0c\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u80af\u5b9a\u662f\u4e0d\u884c\u7684\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u5728\u96c6\u7fa4\u4e2d\u4f7f\u7528 <code>PV/PVC</code> \u6765\u8fdb\u884c\u6301\u4e45\u5316\uff0c\u540c\u6837\uff0c\u5728\u4e0a\u9762\u7684 <code>Elasticsearch</code> \u8d44\u6e90\u5bf9\u8c61\u4e2d\u6dfb\u52a0\u5b58\u50a8\u76f8\u5173\u6570\u636e\uff1a</p> <pre><code>apiVersion: elasticsearch.k8s.elastic.co/v1alpha1\nkind: Elasticsearch\nmetadata:\n  name: elastic\n  namespace: elastic-system\nspec:\n  version: 7.2.0\n  nodes:\n  - nodeCount: 2\n    config:\n      node.master: true\n      node.data: true\n      node.ingest: true\n    volumeClaimTemplates:\n    - metadata:\n        name: data\n      spec:\n        accessModes:\n        - ReadWriteOnce\n        resources:\n          requests:\n            storage: 10Gi\n        #storageClassName: standard # \u53ef\u4ee5\u6307\u5b9a\u53ef\u7528\u7684storage class\n</code></pre> <p>\u4e3a\u4e86\u80fd\u591f\u83b7\u5f97\u78c1\u76d8\u7684\u6700\u4f73\u6027\u80fd\uff0c<code>ECK</code> \u652f\u6301\u6bcf\u4e2a\u8282\u70b9\u4f7f\u7528 <code>local volume</code>\uff0c\u5173\u4e8e\u5728 <code>ECK</code> \u4e2d\u4f7f\u7528 <code>local volume</code> \u7684\u65b9\u6cd5\u53ef\u4ee5\u67e5\u770b\u4e0b\u9762\u51e0\u7bc7\u8d44\u6599\uff1a</p> <ul> <li>persistent volumes storage classes</li> <li>elastic local volume dynamic provisioner to setup dynamic local volumes based on LVM.</li> <li>kubernetes-sigs local volume static provisioner to setup static local volumes.</li> </ul> <p>\u5173\u4e8e\u5b9a\u5236 <code>Elasticsearch</code> \u8d44\u6e90\u5bf9\u8c61\u7684\u4e00\u4e9b\u65b9\u6cd5\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u53bb\u67e5\u770b ECK \u7684 git \u4ed3\u5e93\u4e2d\u7684\u4ecb\u7ecd\u5373\u53ef\uff0c\u5f53\u7136\u6211\u4eec\u4e5f\u53ef\u4ee5\u76f4\u63a5\u5728\u96c6\u7fa4\u4e2d\u901a\u8fc7describe\u547d\u4ee4\u53bb\u83b7\u53d6<code>Elastisearch CRD</code>\u7684\u8d44\u6e90\u58f0\u660e\uff1a</p> <pre><code>$ kubectl describe crd elasticsearch\n</code></pre>"},{"location":"chap10/7EFKLK_log_aggregator/","title":"\u7b2c\u4e03\u8282 \u4f7f\u7528 EFKLK \u642d\u5efa Kubernetes \u65e5\u5fd7\u6536\u96c6\u5de5\u5177\u6808 (Kafka/Logstash)","text":"<p>Elasticsearch \u662f\u4e00\u4e2a\u5b9e\u65f6\u7684\u3001\u5206\u5e03\u5f0f\u7684\u53ef\u6269\u5c55\u7684\u641c\u7d22\u5f15\u64ce\uff0c\u5141\u8bb8\u8fdb\u884c\u5168\u6587\u3001\u7ed3\u6784\u5316\u641c\u7d22\uff0c\u5b83\u901a\u5e38\u7528\u4e8e\u7d22\u5f15\u548c\u641c\u7d22\u5927\u91cf\u65e5\u5fd7\u6570\u636e\uff0c\u4e5f\u53ef\u7528\u4e8e\u641c\u7d22\u8bb8\u591a\u4e0d\u540c\u7c7b\u578b\u7684\u6587\u6863\u3002</p> <p>Elasticsearch \u901a\u5e38\u4e0e Kibana \u4e00\u8d77\u90e8\u7f72\uff0cKibana \u662f Elasticsearch \u7684\u4e00\u4e2a\u529f\u80fd\u5f3a\u5927\u7684\u6570\u636e\u53ef\u89c6\u5316 Dashboard\uff0cKibana \u5141\u8bb8\u4f60\u901a\u8fc7 web \u754c\u9762\u6765\u6d4f\u89c8 Elasticsearch \u65e5\u5fd7\u6570\u636e\u3002</p> <p>Fluentd\u662f\u4e00\u4e2a\u6d41\u884c\u7684\u5f00\u6e90\u6570\u636e\u6536\u96c6\u5668\uff0c\u6211\u4eec\u5c06\u5728 Kubernetes \u96c6\u7fa4\u8282\u70b9\u4e0a\u5b89\u88c5 Fluentd\uff0c\u901a\u8fc7\u83b7\u53d6\u5bb9\u5668\u65e5\u5fd7\u6587\u4ef6\u3001\u8fc7\u6ee4\u548c\u8f6c\u6362\u65e5\u5fd7\u6570\u636e\uff0c\u7136\u540e\u5c06\u6570\u636e\u4f20\u9012\u5230 Elasticsearch \u96c6\u7fa4\uff0c\u5728\u8be5\u96c6\u7fa4\u4e2d\u5bf9\u5176\u8fdb\u884c\u7d22\u5f15\u548c\u5b58\u50a8\u3002</p> <p>\u6211\u4eec\u5148\u6765\u914d\u7f6e\u542f\u52a8\u4e00\u4e2a\u53ef\u6269\u5c55\u7684 Elasticsearch \u96c6\u7fa4\uff0c\u7136\u540e\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u521b\u5efa\u4e00\u4e2a Kibana \u5e94\u7528\uff0c\u6700\u540e\u901a\u8fc7 DaemonSet \u6765\u8fd0\u884c Fluentd\uff0c\u4ee5\u4fbf\u5b83\u5728\u6bcf\u4e2a Kubernetes \u5de5\u4f5c\u8282\u70b9\u4e0a\u90fd\u53ef\u4ee5\u8fd0\u884c\u4e00\u4e2a Pod\u3002</p> <p>\u5982\u679c\u4f60\u4e86\u89e3 EFK \u7684\u57fa\u672c\u539f\u7406\uff0c\u53ea\u662f\u4e3a\u4e86\u6d4b\u8bd5\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 Kubernetes \u5b98\u65b9\u63d0\u4f9b\u7684 addon \u63d2\u4ef6\u7684\u8d44\u6e90\u6e05\u5355\uff0c\u5730\u5740\uff1ahttps://github.com/kubernetes/kubernetes/blob/master/cluster/addons/fluentd-elasticsearch/\uff0c\u76f4\u63a5\u5b89\u88c5\u5373\u53ef\u3002</p>"},{"location":"chap10/7EFKLK_log_aggregator/#1-elasticsearch","title":"1\u3001\u5b89\u88c5 Elasticsearch \u96c6\u7fa4","text":"<p>\u5728\u521b\u5efa Elasticsearch \u96c6\u7fa4\u4e4b\u524d\uff0c\u6211\u4eec\u5148\u521b\u5efa\u4e00\u4e2a\u547d\u540d\u7a7a\u95f4\uff0c\u6211\u4eec\u5c06\u5728\u5176\u4e2d\u5b89\u88c5\u6240\u6709\u65e5\u5fd7\u76f8\u5173\u7684\u8d44\u6e90\u5bf9\u8c61\u3002</p> <pre><code>kubectl create ns logging\n</code></pre>"},{"location":"chap10/7EFKLK_log_aggregator/#1-1","title":"1-1 \u73af\u5883\u51c6\u5907","text":"<p>ElasticSearch \u5b89\u88c5\u6709\u6700\u4f4e\u5b89\u88c5\u8981\u6c42\uff0c\u5982\u679c\u5b89\u88c5\u540e Pod \u65e0\u6cd5\u6b63\u5e38\u542f\u52a8\uff0c\u8bf7\u68c0\u67e5\u662f\u5426\u7b26\u5408\u6700\u4f4e\u8981\u6c42\u7684\u914d\u7f6e\uff0c\u8981\u6c42\u5982\u4e0b\uff1a</p> <p></p> <p>\u8fd9\u91cc\u6211\u4eec\u8981\u5b89\u88c5\u7684 ES \u96c6\u7fa4\u73af\u5883\u4fe1\u606f\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <p>\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528\u4e00\u4e2a NFS \u7c7b\u578b\u7684 StorageClass \u6765\u505a\u6301\u4e45\u5316\u5b58\u50a8\uff0c\u5f53\u7136\u5982\u679c\u4f60\u662f\u7ebf\u4e0a\u73af\u5883\u5efa\u8bae\u4f7f\u7528 Local PV \u6216\u8005 Ceph RBD \u4e4b\u7c7b\u7684\u5b58\u50a8\u6765\u6301\u4e45\u5316 Elasticsearch \u7684\u6570\u636e\u3002</p> <p>\u6b64\u5916\u7531\u4e8e ElasticSearch 7.x \u7248\u672c\u9ed8\u8ba4\u5b89\u88c5\u4e86 X-Pack \u63d2\u4ef6\uff0c\u5e76\u4e14\u90e8\u5206\u529f\u80fd\u514d\u8d39\uff0c\u9700\u8981\u6211\u4eec\u914d\u7f6e\u4e00\u4e9b\u5b89\u5168\u8bc1\u4e66\u6587\u4ef6\u3002</p> <p>1\u3001\u751f\u6210\u8bc1\u4e66\u6587\u4ef6</p> <pre><code># \u8fd0\u884c\u5bb9\u5668\u751f\u6210\u8bc1\u4e66\n$ docker run --name elastic-certs -i -w /app elasticsearch:7.12.0 /bin/sh -c  \\\n  \"elasticsearch-certutil ca --out /app/elastic-stack-ca.p12 --pass '' &amp;&amp; \\\n    elasticsearch-certutil cert --name security-master --dns \\\n    security-master --ca /app/elastic-stack-ca.p12 --pass '' --ca-pass '' --out /app/elastic-certificates.p12\"\n\n\n# \u4ece\u5bb9\u5668\u4e2d\u5c06\u751f\u6210\u7684\u8bc1\u4e66\u62f7\u8d1d\u51fa\u6765\n$ docker cp elastic-certs:/app/elastic-certificates.p12 .\n\n\n# \u5220\u9664\u5bb9\u5668\n$ docker rm -f elastic-certs\n\n\n# \u5c06 pcks12 \u4e2d\u7684\u4fe1\u606f\u5206\u79bb\u51fa\u6765\uff0c\u5199\u5165\u6587\u4ef6\n$ openssl pkcs12 -nodes -passin pass:'' -in elastic-certificates.p12 -out elastic-certificate.pem\n</code></pre> <p>2\u3001\u6dfb\u52a0\u8bc1\u4e66\u5230 Kubernetes</p> <pre><code># \u6dfb\u52a0\u8bc1\u4e66\n$ kubectl create secret -n logging generic elastic-certs --from-file=elastic-certificates.p12\n\n\n# \u8bbe\u7f6e\u96c6\u7fa4\u7528\u6237\u540d\u5bc6\u7801\n$ kubectl create secret -n logging generic elastic-auth --from-literal=username=elastic --from-literal=password=jxi321\n</code></pre>"},{"location":"chap10/7EFKLK_log_aggregator/#1-2-helm-es","title":"1-2 Helm \u5b89\u88c5 ES \u96c6\u7fa4","text":"<p>\u9996\u5148\u6dfb\u52a0 ELastic \u7684 Helm \u4ed3\u5e93\uff1a</p> <pre><code>helm repo add elastic https://helm.elastic.co\nhelm repo update\n</code></pre> <p>ElaticSearch \u5b89\u88c5\u9700\u8981\u5b89\u88c5\u4e09\u6b21\uff0c\u5206\u522b\u5b89\u88c5 Master\u3001Data\u3001Client \u8282\u70b9\uff0c</p> <ul> <li>Master \u8282\u70b9\u8d1f\u8d23\u96c6\u7fa4\u95f4\u7684\u7ba1\u7406\u5de5\u4f5c\uff1b</li> <li>Data \u8282\u70b9\u8d1f\u8d23\u5b58\u50a8\u6570\u636e\uff1b</li> <li>Client \u8282\u70b9\u8d1f\u8d23\u4ee3\u7406 ElasticSearch Cluster \u96c6\u7fa4\uff0c\u8d1f\u8f7d\u5747\u8861\u3002</li> </ul> <p>\u9996\u5148\u4f7f\u7528 <code>helm pull</code>\u62c9\u53d6 Chart \u5e76\u89e3\u538b\uff1a</p> <pre><code>helm pull elastic/elasticsearch --untar --version 7.12.0\ncd elasticsearch\n</code></pre>"},{"location":"chap10/7EFKLK_log_aggregator/#1-2-1-master","title":"1-2-1 Master \u8282\u70b9\u5b89\u88c5\u914d\u7f6e","text":"<p>\u5728 Chart \u76ee\u5f55\u4e0b\u9762\u521b\u5efa\u7528\u4e8e Master \u8282\u70b9\u5b89\u88c5\u914d\u7f6e\u7684 values \u6587\u4ef6\uff1a</p> <p><code>values-master.yaml</code></p> <pre><code># values-master.yaml\n## \u8bbe\u7f6e\u96c6\u7fa4\u540d\u79f0\nclusterName: \"elasticsearch\"\n## \u8bbe\u7f6e\u8282\u70b9\u540d\u79f0\nnodeGroup: \"master\"\n\n## \u8bbe\u7f6e\u89d2\u8272\nroles:\n  master: \"true\"\n  ingest: \"false\"\n  data: \"false\"\n\n# ============\u955c\u50cf\u914d\u7f6e============\n## \u6307\u5b9a\u955c\u50cf\u4e0e\u955c\u50cf\u7248\u672c\nimage: \"elasticsearch\"\nimageTag: \"7.12.0\"\n## \u526f\u672c\u6570\nreplicas: 3\n\n# ============\u8d44\u6e90\u914d\u7f6e============\n## JVM \u914d\u7f6e\u53c2\u6570\nesJavaOpts: \"-Xmx1g -Xms1g\"\n## \u90e8\u7f72\u8d44\u6e90\u914d\u7f6e(\u751f\u6210\u73af\u5883\u4e00\u5b9a\u8981\u8bbe\u7f6e\u5927\u4e9b)\nresources:\n  requests:\n    cpu: \"2000m\"\n    memory: \"2Gi\"\n  limits:\n    cpu: \"2000m\"\n    memory: \"2Gi\"\n## \u6570\u636e\u6301\u4e45\u5377\u914d\u7f6e\npersistence:\n  enabled: true\n## \u5b58\u50a8\u6570\u636e\u5927\u5c0f\u914d\u7f6e\nvolumeClaimTemplate:\n  storageClassName: nfs-storage\n  accessModes: [\"ReadWriteOnce\"]\n  resources:\n    requests:\n      storage: 5Gi\n\n# ============\u5b89\u5168\u914d\u7f6e============\n## \u8bbe\u7f6e\u534f\u8bae\uff0c\u53ef\u914d\u7f6e\u4e3a http\u3001https\nprotocol: http\n## \u8bc1\u4e66\u6302\u8f7d\u914d\u7f6e\uff0c\u8fd9\u91cc\u6211\u4eec\u6302\u5165\u4e0a\u9762\u521b\u5efa\u7684\u8bc1\u4e66\nsecretMounts:\n  - name: elastic-certs\n    secretName: elastic-certs\n    path: /usr/share/elasticsearch/config/certs\n\n## \u5141\u8bb8\u60a8\u5728/usr/share/elasticsearch/config/\u4e2d\u6dfb\u52a0\u4efb\u4f55\u81ea\u5b9a\u4e49\u914d\u7f6e\u6587\u4ef6,\u4f8b\u5982 elasticsearch.yml\n## ElasticSearch 7.x \u9ed8\u8ba4\u5b89\u88c5\u4e86 x-pack \u63d2\u4ef6\uff0c\u90e8\u5206\u529f\u80fd\u514d\u8d39\uff0c\u8fd9\u91cc\u6211\u4eec\u914d\u7f6e\u4e0b\n## \u4e0b\u9762\u6ce8\u6389\u7684\u90e8\u5206\u4e3a\u914d\u7f6e https \u8bc1\u4e66\uff0c\u914d\u7f6e\u6b64\u90e8\u5206\u8fd8\u9700\u8981\u914d\u7f6e helm \u53c2\u6570 protocol \u503c\u6539\u4e3a https\nesConfig:\n  elasticsearch.yml: |\n    xpack.security.enabled: true\n    xpack.security.transport.ssl.enabled: true\n    xpack.security.transport.ssl.verification_mode: certificate\n    xpack.security.transport.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12\n    xpack.security.transport.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12\n    # xpack.security.http.ssl.enabled: true\n    # xpack.security.http.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12\n    # xpack.security.http.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12\n## \u73af\u5883\u53d8\u91cf\u914d\u7f6e\uff0c\u8fd9\u91cc\u5f15\u5165\u4e0a\u9762\u8bbe\u7f6e\u7684\u7528\u6237\u540d\u3001\u5bc6\u7801 secret \u6587\u4ef6\nextraEnvs:\n  - name: ELASTIC_USERNAME\n    valueFrom:\n      secretKeyRef:\n        name: elastic-auth\n        key: username\n  - name: ELASTIC_PASSWORD\n    valueFrom:\n      secretKeyRef:\n        name: elastic-auth\n        key: password\n\n# ============\u8c03\u5ea6\u914d\u7f6e============\n## \u8bbe\u7f6e\u8c03\u5ea6\u7b56\u7565\n## - hard\uff1a\u53ea\u6709\u5f53\u6709\u8db3\u591f\u7684\u8282\u70b9\u65f6 Pod \u624d\u4f1a\u88ab\u8c03\u5ea6\uff0c\u5e76\u4e14\u5b83\u4eec\u6c38\u8fdc\u4e0d\u4f1a\u51fa\u73b0\u5728\u540c\u4e00\u4e2a\u8282\u70b9\u4e0a\n## - soft\uff1a\u5c3d\u6700\u5927\u52aa\u529b\u8c03\u5ea6\nantiAffinity: \"soft\"\ntolerations:\n  - operator: \"Exists\" ##\u5bb9\u5fcd\u5168\u90e8\u6c61\u70b9\n</code></pre>"},{"location":"chap10/7EFKLK_log_aggregator/#1-2-2-data","title":"1-2-2 Data \u8282\u70b9","text":"<p>\u7136\u540e\u521b\u5efa\u7528\u4e8e Data \u8282\u70b9\u5b89\u88c5\u7684 values \u6587\u4ef6\uff1a</p> <pre><code># values-data.yaml\n# ============\u8bbe\u7f6e\u96c6\u7fa4\u540d\u79f0============\n## \u8bbe\u7f6e\u96c6\u7fa4\u540d\u79f0\nclusterName: \"elasticsearch\"\n## \u8bbe\u7f6e\u8282\u70b9\u540d\u79f0\nnodeGroup: \"data\"\n## \u8bbe\u7f6e\u89d2\u8272\nroles:\n  master: \"false\"\n  ingest: \"true\"\n  data: \"true\"\n\n# ============\u955c\u50cf\u914d\u7f6e============\n## \u6307\u5b9a\u955c\u50cf\u4e0e\u955c\u50cf\u7248\u672c\nimage: \"elasticsearch\"\nimageTag: \"7.12.0\"\n## \u526f\u672c\u6570(\u5efa\u8bae\u8bbe\u7f6e\u4e3a3\uff0c\u6211\u8fd9\u91cc\u8d44\u6e90\u4e0d\u8db3\u53ea\u7528\u4e861\u4e2a\u526f\u672c)\nreplicas: 1\n\n# ============\u8d44\u6e90\u914d\u7f6e============\n## JVM \u914d\u7f6e\u53c2\u6570\nesJavaOpts: \"-Xmx1g -Xms1g\"\n## \u90e8\u7f72\u8d44\u6e90\u914d\u7f6e(\u751f\u6210\u73af\u5883\u4e00\u5b9a\u8981\u8bbe\u7f6e\u5927\u4e9b)\nresources:\n  requests:\n    cpu: \"1000m\"\n    memory: \"2Gi\"\n  limits:\n    cpu: \"1000m\"\n    memory: \"2Gi\"\n## \u6570\u636e\u6301\u4e45\u5377\u914d\u7f6e\npersistence:\n  enabled: true\n## \u5b58\u50a8\u6570\u636e\u5927\u5c0f\u914d\u7f6e\nvolumeClaimTemplate:\n  storageClassName: nfs-storage\n  accessModes: [\"ReadWriteOnce\"]\n  resources:\n    requests:\n      storage: 10Gi\n\n# ============\u5b89\u5168\u914d\u7f6e============\n## \u8bbe\u7f6e\u534f\u8bae\uff0c\u53ef\u914d\u7f6e\u4e3a http\u3001https\nprotocol: http\n## \u8bc1\u4e66\u6302\u8f7d\u914d\u7f6e\uff0c\u8fd9\u91cc\u6211\u4eec\u6302\u5165\u4e0a\u9762\u521b\u5efa\u7684\u8bc1\u4e66\nsecretMounts:\n  - name: elastic-certs\n    secretName: elastic-certs\n    path: /usr/share/elasticsearch/config/certs\n## \u5141\u8bb8\u60a8\u5728/usr/share/elasticsearch/config/\u4e2d\u6dfb\u52a0\u4efb\u4f55\u81ea\u5b9a\u4e49\u914d\u7f6e\u6587\u4ef6,\u4f8b\u5982 elasticsearch.yml\n## ElasticSearch 7.x \u9ed8\u8ba4\u5b89\u88c5\u4e86 x-pack \u63d2\u4ef6\uff0c\u90e8\u5206\u529f\u80fd\u514d\u8d39\uff0c\u8fd9\u91cc\u6211\u4eec\u914d\u7f6e\u4e0b\n## \u4e0b\u9762\u6ce8\u6389\u7684\u90e8\u5206\u4e3a\u914d\u7f6e https \u8bc1\u4e66\uff0c\u914d\u7f6e\u6b64\u90e8\u5206\u8fd8\u9700\u8981\u914d\u7f6e helm \u53c2\u6570 protocol \u503c\u6539\u4e3a https\nesConfig:\n  elasticsearch.yml: |\n    xpack.security.enabled: true\n    xpack.security.transport.ssl.enabled: true\n    xpack.security.transport.ssl.verification_mode: certificate\n    xpack.security.transport.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12\n    xpack.security.transport.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12\n    # xpack.security.http.ssl.enabled: true\n    # xpack.security.http.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12\n    # xpack.security.http.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12\n## \u73af\u5883\u53d8\u91cf\u914d\u7f6e\uff0c\u8fd9\u91cc\u5f15\u5165\u4e0a\u9762\u8bbe\u7f6e\u7684\u7528\u6237\u540d\u3001\u5bc6\u7801 secret \u6587\u4ef6\nextraEnvs:\n  - name: ELASTIC_USERNAME\n    valueFrom:\n      secretKeyRef:\n        name: elastic-auth\n        key: username\n  - name: ELASTIC_PASSWORD\n    valueFrom:\n      secretKeyRef:\n        name: elastic-auth\n        key: password\n\n# ============\u8c03\u5ea6\u914d\u7f6e============\n## \u8bbe\u7f6e\u8c03\u5ea6\u7b56\u7565\n## - hard\uff1a\u53ea\u6709\u5f53\u6709\u8db3\u591f\u7684\u8282\u70b9\u65f6 Pod \u624d\u4f1a\u88ab\u8c03\u5ea6\uff0c\u5e76\u4e14\u5b83\u4eec\u6c38\u8fdc\u4e0d\u4f1a\u51fa\u73b0\u5728\u540c\u4e00\u4e2a\u8282\u70b9\u4e0a\n## - soft\uff1a\u5c3d\u6700\u5927\u52aa\u529b\u8c03\u5ea6\nantiAffinity: \"soft\"\n## \u5bb9\u5fcd\u914d\u7f6e\ntolerations:\n  - operator: \"Exists\" ##\u5bb9\u5fcd\u5168\u90e8\u6c61\u70b9 \n</code></pre>"},{"location":"chap10/7EFKLK_log_aggregator/#1-2-3-client","title":"1-2-3 Client \u8282\u70b9","text":"<p>\u6700\u540e\u4e00\u4e2a\u662f\u7528\u4e8e\u521b\u5efa Client \u8282\u70b9\u7684 values \u6587\u4ef6\uff1a</p> <pre><code># values-client.yaml\n# ============\u8bbe\u7f6e\u96c6\u7fa4\u540d\u79f0============\n## \u8bbe\u7f6e\u96c6\u7fa4\u540d\u79f0\nclusterName: \"elasticsearch\"\n## \u8bbe\u7f6e\u8282\u70b9\u540d\u79f0\nnodeGroup: \"client\"\n## \u8bbe\u7f6e\u89d2\u8272\nroles:\n  master: \"false\"\n  ingest: \"false\"\n  data: \"false\"\n\n# ============\u955c\u50cf\u914d\u7f6e============\n## \u6307\u5b9a\u955c\u50cf\u4e0e\u955c\u50cf\u7248\u672c\nimage: \"elasticsearch\"\nimageTag: \"7.12.0\"\n## \u526f\u672c\u6570\nreplicas: 1\n\n# ============\u8d44\u6e90\u914d\u7f6e============\n## JVM \u914d\u7f6e\u53c2\u6570\nesJavaOpts: \"-Xmx1g -Xms1g\"\n## \u90e8\u7f72\u8d44\u6e90\u914d\u7f6e(\u751f\u6210\u73af\u5883\u4e00\u5b9a\u8981\u8bbe\u7f6e\u5927\u4e9b)\nresources:\n  requests:\n    cpu: \"1000m\"\n    memory: \"2Gi\"\n  limits:\n    cpu: \"1000m\"\n    memory: \"2Gi\"\n## \u6570\u636e\u6301\u4e45\u5377\u914d\u7f6e\npersistence:\n  enabled: false\n\n# ============\u5b89\u5168\u914d\u7f6e============\n## \u8bbe\u7f6e\u534f\u8bae\uff0c\u53ef\u914d\u7f6e\u4e3a http\u3001https\nprotocol: http\n## \u8bc1\u4e66\u6302\u8f7d\u914d\u7f6e\uff0c\u8fd9\u91cc\u6211\u4eec\u6302\u5165\u4e0a\u9762\u521b\u5efa\u7684\u8bc1\u4e66\nsecretMounts:\n  - name: elastic-certs\n    secretName: elastic-certs\n    path: /usr/share/elasticsearch/config/certs\n## \u5141\u8bb8\u60a8\u5728/usr/share/elasticsearch/config/\u4e2d\u6dfb\u52a0\u4efb\u4f55\u81ea\u5b9a\u4e49\u914d\u7f6e\u6587\u4ef6,\u4f8b\u5982 elasticsearch.yml\n## ElasticSearch 7.x \u9ed8\u8ba4\u5b89\u88c5\u4e86 x-pack \u63d2\u4ef6\uff0c\u90e8\u5206\u529f\u80fd\u514d\u8d39\uff0c\u8fd9\u91cc\u6211\u4eec\u914d\u7f6e\u4e0b\n## \u4e0b\u9762\u6ce8\u6389\u7684\u90e8\u5206\u4e3a\u914d\u7f6e https \u8bc1\u4e66\uff0c\u914d\u7f6e\u6b64\u90e8\u5206\u8fd8\u9700\u8981\u914d\u7f6e helm \u53c2\u6570 protocol \u503c\u6539\u4e3a https\nesConfig:\n  elasticsearch.yml: |\n    xpack.security.enabled: true\n    xpack.security.transport.ssl.enabled: true\n    xpack.security.transport.ssl.verification_mode: certificate\n    xpack.security.transport.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12\n    xpack.security.transport.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12\n    # xpack.security.http.ssl.enabled: true\n    # xpack.security.http.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12\n    # xpack.security.http.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12\n## \u73af\u5883\u53d8\u91cf\u914d\u7f6e\uff0c\u8fd9\u91cc\u5f15\u5165\u4e0a\u9762\u8bbe\u7f6e\u7684\u7528\u6237\u540d\u3001\u5bc6\u7801 secret \u6587\u4ef6\nextraEnvs:\n  - name: ELASTIC_USERNAME\n    valueFrom:\n      secretKeyRef:\n        name: elastic-auth\n        key: username\n  - name: ELASTIC_PASSWORD\n    valueFrom:\n      secretKeyRef:\n        name: elastic-auth\n        key: password\n\n# ============Service \u914d\u7f6e============\nservice:\n  type: NodePort\n  nodePort: \"30200\"\n</code></pre> <p>\u73b0\u5728\u7528\u4e0a\u9762\u7684 values \u6587\u4ef6\u6765\u5b89\u88c5\uff1a</p> <pre><code># \u5b89\u88c5 master \u8282\u70b9\n\nhelm install es-master -f values-master.yaml --namespace logging .\n# \u5b89\u88c5 data \u8282\u70b9\n\nhelm install es-data -f values-data.yaml --namespace logging .\n\n# \u5b89\u88c5 client \u8282\u70b9\nhelm install es-client -f values-client.yaml --namespace logging .\n</code></pre>"},{"location":"chap10/7EFKLK_log_aggregator/#1-3-kibana","title":"1-3 \u5b89\u88c5 Kibana","text":"<p>Elasticsearch \u96c6\u7fa4\u5b89\u88c5\u5b8c\u6210\u540e\u63a5\u4e0b\u6765\u914d\u7f6e\u5b89\u88c5 Kibana</p> <p>\u4f7f\u7528 <code>helm pull</code> \u547d\u4ee4\u62c9\u53d6 Kibana Chart \u5305\u5e76\u89e3\u538b\uff1a</p> <pre><code>helm pull elastic/kibana --untar --version 7.12.0\ncd kibana\n</code></pre> <p>\u521b\u5efa\u7528\u4e8e\u5b89\u88c5 Kibana \u7684 values \u6587\u4ef6\uff1a</p> <p><code>values-prod.yaml</code></p> <pre><code># values-prod.yaml\n## \u6307\u5b9a\u955c\u50cf\u4e0e\u955c\u50cf\u7248\u672c\nimage: \"kibana\"\nimageTag: \"7.12.0\"\n\n## \u914d\u7f6e ElasticSearch \u5730\u5740\nelasticsearchHosts: \"http://elasticsearch-client:9200\"\n\n# ============\u73af\u5883\u53d8\u91cf\u914d\u7f6e============\n## \u73af\u5883\u53d8\u91cf\u914d\u7f6e\uff0c\u8fd9\u91cc\u5f15\u5165\u4e0a\u9762\u8bbe\u7f6e\u7684\u7528\u6237\u540d\u3001\u5bc6\u7801 secret \u6587\u4ef6\nextraEnvs:\n  - name: \"ELASTICSEARCH_USERNAME\"\n    valueFrom:\n      secretKeyRef:\n        name: elastic-auth\n        key: username\n  - name: \"ELASTICSEARCH_PASSWORD\"\n    valueFrom:\n      secretKeyRef:\n        name: elastic-auth\n        key: password\n\n# ============\u8d44\u6e90\u914d\u7f6e============\nresources:\n  requests:\n    cpu: \"500m\"\n    memory: \"1Gi\"\n  limits:\n    cpu: \"500m\"\n    memory: \"1Gi\"\n\n# ============\u914d\u7f6e Kibana \u53c2\u6570============\n## kibana \u914d\u7f6e\u4e2d\u6dfb\u52a0\u8bed\u8a00\u914d\u7f6e\uff0c\u8bbe\u7f6e kibana \u4e3a\u4e2d\u6587\nkibanaConfig:\n  kibana.yml: |\n    i18n.locale: \"zh-CN\"\n\n# ============Service \u914d\u7f6e============\nservice:\n  type: NodePort\n  nodePort: \"30601\"\n</code></pre> <p>\u4f7f\u7528\u4e0a\u9762\u7684\u914d\u7f6e\u76f4\u63a5\u5b89\u88c5\u5373\u53ef\uff1a</p> <pre><code>helm install kibana -f values-prod.yaml --namespace logging .\n</code></pre> <p>\u4e0b\u9762\u662f\u5b89\u88c5\u5b8c\u6210\u540e\u7684 ES \u96c6\u7fa4\u548c Kibana \u8d44\u6e90\uff1a</p> <pre><code>[root@node2 ~]# kubectl get pods -n logging\nNAME                            READY   STATUS              RESTARTS   AGE\nelasticsearch-client-0          1/1     Running             0          13m\nelasticsearch-data-0            1/1     Running             0          17m\nelasticsearch-master-0          1/1     Running             0          14m\nelasticsearch-master-1          1/1     Running             0          16m\nelasticsearch-master-2          1/1     Running             0          18m\nkibana-kibana-66f97964b-pmqlq   1/1     Running             0          31s\n[root@node2 ~]# kubectl get svc -n logging\nNAME                            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                         AGE\nelasticsearch-client            NodePort    10.102.35.207   &lt;none&gt;        9200:30200/TCP,9300:30078/TCP   33m\nelasticsearch-client-headless   ClusterIP   None            &lt;none&gt;        9200/TCP,9300/TCP               33m\nelasticsearch-data              ClusterIP   10.97.179.233   &lt;none&gt;        9200/TCP,9300/TCP               37m\nelasticsearch-data-headless     ClusterIP   None            &lt;none&gt;        9200/TCP,9300/TCP               37m\nelasticsearch-master            ClusterIP   10.97.35.120    &lt;none&gt;        9200/TCP,9300/TCP               46m\nelasticsearch-master-headless   ClusterIP   None            &lt;none&gt;        9200/TCP,9300/TCP               46m\nkibana-kibana                   NodePort    10.106.97.8     &lt;none&gt;        5601:30601/TCP                  35s\n</code></pre> <p>\u4e0a\u9762\u6211\u4eec\u5b89\u88c5 Kibana \u7684\u65f6\u5019\u6307\u5b9a\u4e86 30601 \u7684 NodePort \u7aef\u53e3\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u4ece\u4efb\u610f\u8282\u70b9 http://IP:30601 \u6765\u8bbf\u95ee Kibana\u3002</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4f1a\u8df3\u8f6c\u5230\u767b\u5f55\u9875\u9762\uff0c\u8ba9\u6211\u4eec\u8f93\u51fa\u7528\u6237\u540d\u3001\u5bc6\u7801\uff0c\u8fd9\u91cc\u6211\u4eec\u8f93\u5165\u4e0a\u9762\u914d\u7f6e\u7684\u7528\u6237\u540d elastic\u3001\u5bc6\u7801 jx321 \u8fdb\u884c\u767b\u5f55\u3002\u767b\u5f55\u6210\u529f\u540e\u8fdb\u5165\u5982\u4e0b\u6240\u793a\u7684 Kibana \u4e3b\u9875\uff1a</p> <p></p>"},{"location":"chap10/7EFKLK_log_aggregator/#2-fluentd","title":"2\u3001\u90e8\u7f72 Fluentd","text":"<p>Fluentd \u662f\u4e00\u4e2a\u9ad8\u6548\u7684\u65e5\u5fd7\u805a\u5408\u5668\uff0c\u662f\u7528 Ruby \u7f16\u5199\u7684\uff0c\u5e76\u4e14\u53ef\u4ee5\u5f88\u597d\u5730\u6269\u5c55\u3002\u5bf9\u4e8e\u5927\u90e8\u5206\u4f01\u4e1a\u6765\u8bf4\uff0cFluentd \u8db3\u591f\u9ad8\u6548\u5e76\u4e14\u6d88\u8017\u7684\u8d44\u6e90\u76f8\u5bf9\u8f83\u5c11\uff0c\u53e6\u5916\u4e00\u4e2a\u5de5\u5177Fluent-bit\u66f4\u8f7b\u91cf\u7ea7\uff0c\u5360\u7528\u8d44\u6e90\u66f4\u5c11\uff0c\u4f46\u662f\u63d2\u4ef6\u76f8\u5bf9 Fluentd \u6765\u8bf4\u4e0d\u591f\u4e30\u5bcc\uff0c\u6240\u4ee5\u6574\u4f53\u6765\u8bf4\uff0cFluentd \u66f4\u52a0\u6210\u719f\uff0c\u4f7f\u7528\u66f4\u52a0\u5e7f\u6cdb\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u4e5f\u540c\u6837\u4f7f\u7528 Fluentd \u6765\u4f5c\u4e3a\u65e5\u5fd7\u6536\u96c6\u5de5\u5177\u3002</p>"},{"location":"chap10/7EFKLK_log_aggregator/#2-1","title":"2-1 \u5de5\u4f5c\u539f\u7406","text":"<p>Fluentd \u901a\u8fc7\u4e00\u7ec4\u7ed9\u5b9a\u7684\u6570\u636e\u6e90\u6293\u53d6\u65e5\u5fd7\u6570\u636e\uff0c\u5904\u7406\u540e\uff08\u8f6c\u6362\u6210\u7ed3\u6784\u5316\u7684\u6570\u636e\u683c\u5f0f\uff09\u5c06\u5b83\u4eec\u8f6c\u53d1\u7ed9\u5176\u4ed6\u670d\u52a1\uff0c\u6bd4\u5982 Elasticsearch\u3001\u5bf9\u8c61\u5b58\u50a8\u7b49\u7b49\u3002Fluentd \u652f\u6301\u8d85\u8fc7 300 \u4e2a\u65e5\u5fd7\u5b58\u50a8\u548c\u5206\u6790\u670d\u52a1\uff0c\u6240\u4ee5\u5728\u8fd9\u65b9\u9762\u662f\u975e\u5e38\u7075\u6d3b\u7684\u3002\u4e3b\u8981\u8fd0\u884c\u6b65\u9aa4\u5982\u4e0b\uff1a</p> <ul> <li>\u9996\u5148 Fluentd \u4ece\u591a\u4e2a\u65e5\u5fd7\u6e90\u83b7\u53d6\u6570\u636e</li> <li>\u7ed3\u6784\u5316\u5e76\u4e14\u6807\u8bb0\u8fd9\u4e9b\u6570\u636e</li> <li>\u7136\u540e\u6839\u636e\u5339\u914d\u7684\u6807\u7b7e\u5c06\u6570\u636e\u53d1\u9001\u5230\u591a\u4e2a\u76ee\u6807\u670d\u52a1\u53bb</li> </ul> <p></p>"},{"location":"chap10/7EFKLK_log_aggregator/#2-2","title":"2-2 \u914d\u7f6e","text":"<p>\u4e00\u822c\u6765\u8bf4\u6211\u4eec\u662f\u901a\u8fc7\u4e00\u4e2a\u914d\u7f6e\u6587\u4ef6\u6765\u544a\u8bc9 Fluentd \u5982\u4f55\u91c7\u96c6\u3001\u5904\u7406\u6570\u636e\u7684\uff0c\u4e0b\u9762\u7b80\u5355\u548c\u5927\u5bb6\u4ecb\u7ecd\u4e0b Fluentd \u7684\u914d\u7f6e\u65b9\u6cd5\u3002</p>"},{"location":"chap10/7EFKLK_log_aggregator/#2-2-1","title":"2-2-1 \u65e5\u5fd7\u6e90\u914d\u7f6e","text":"<pre><code>\n&lt;source&gt;\n  @id fluentd-containers.log\n  @type tail                             # Fluentd \u5185\u7f6e\u7684\u8f93\u5165\u65b9\u5f0f\uff0c\u5176\u539f\u7406\u662f\u4e0d\u505c\u5730\u4ece\u6e90\u6587\u4ef6\u4e2d\u83b7\u53d6\u65b0\u7684\u65e5\u5fd7\u3002\n  path /var/log/containers/*.log         # \u6302\u8f7d\u7684\u670d\u52a1\u5668Docker\u5bb9\u5668\u65e5\u5fd7\u5730\u5740\n  pos_file /var/log/es-containers.log.pos\n  tag raw.kubernetes.*                   # \u8bbe\u7f6e\u65e5\u5fd7\u6807\u7b7e\n  read_from_head true\n  &lt;parse&gt;                                # \u591a\u884c\u683c\u5f0f\u5316\u6210JSON\n    @type multi_format                   # \u4f7f\u7528 multi-format-parser \u89e3\u6790\u5668\u63d2\u4ef6\n    &lt;pattern&gt;\n      format json                        # JSON \u89e3\u6790\u5668\n      time_key time                      # \u6307\u5b9a\u4e8b\u4ef6\u65f6\u95f4\u7684\u65f6\u95f4\u5b57\u6bb5\n      time_format %Y-%m-%dT%H:%M:%S.%NZ  # \u65f6\u95f4\u683c\u5f0f\n    &lt;/pattern&gt;\n    &lt;pattern&gt;\n      format /^(?&lt;time&gt;.+) (?&lt;stream&gt;stdout|stderr) [^ ]* (?&lt;log&gt;.*)$/\n      time_format %Y-%m-%dT%H:%M:%S.%N%:z\n    &lt;/pattern&gt;\n  &lt;/parse&gt;\n&lt;/source&gt;\n</code></pre> <p>\u4e0a\u9762\u914d\u7f6e\u90e8\u5206\u53c2\u6570\u8bf4\u660e\u5982\u4e0b\uff1a</p> <ul> <li><code>id</code>\uff1a\u8868\u793a\u5f15\u7528\u8be5\u65e5\u5fd7\u6e90\u7684\u552f\u4e00\u6807\u8bc6\u7b26\uff0c\u8be5\u6807\u8bc6\u53ef\u7528\u4e8e\u8fdb\u4e00\u6b65\u8fc7\u6ee4\u548c\u8def\u7531\u7ed3\u6784\u5316\u65e5\u5fd7\u6570\u636e</li> <li><code>**type</code>\uff1aFluentd \u5185\u7f6e\u7684\u6307\u4ee4\uff0ctail \u8868\u793a Fluentd \u4ece\u4e0a\u6b21\u8bfb\u53d6\u7684\u4f4d\u7f6e\u901a\u8fc7 tail \u4e0d\u65ad\u83b7\u53d6\u6570\u636e\uff0c\u53e6\u5916\u4e00\u4e2a\u662f http \u8868\u793a\u901a\u8fc7\u4e00\u4e2a GET \u8bf7\u6c42\u6765\u6536\u96c6\u6570\u636e**\u3002</li> <li><code>path</code>\uff1atail \u7c7b\u578b\u4e0b\u7684\u7279\u5b9a\u53c2\u6570\uff0c\u544a\u8bc9 Fluentd \u91c7\u96c6 <code>/var/log/containers</code> \u76ee\u5f55\u4e0b\u7684\u6240\u6709\u65e5\u5fd7\uff0c\u8fd9\u662f docker \u5728 Kubernetes \u8282\u70b9\u4e0a\u7528\u6765\u5b58\u50a8\u8fd0\u884c\u5bb9\u5668 stdout \u8f93\u51fa\u65e5\u5fd7\u6570\u636e\u7684\u76ee\u5f55\u3002</li> <li><code>pos_file</code>\uff1a\u68c0\u67e5\u70b9\uff0c\u5982\u679c Fluentd \u7a0b\u5e8f\u91cd\u65b0\u542f\u52a8\u4e86\uff0c\u5b83\u5c06\u4f7f\u7528\u6b64\u6587\u4ef6\u4e2d\u7684\u4f4d\u7f6e\u6765\u6062\u590d\u65e5\u5fd7\u6570\u636e\u6536\u96c6\u3002</li> <li><code>tag</code>\uff1a\u7528\u6765\u5c06\u65e5\u5fd7\u6e90\u4e0e\u76ee\u6807\u6216\u8005\u8fc7\u6ee4\u5668\u5339\u914d\u7684\u81ea\u5b9a\u4e49\u5b57\u7b26\u4e32\uff0cFluentd \u5339\u914d\u6e90/\u76ee\u6807\u6807\u7b7e\u6765\u8def\u7531\u65e5\u5fd7\u6570\u636e\u3002</li> </ul>"},{"location":"chap10/7EFKLK_log_aggregator/#2-2-2","title":"2-2-2 \u8def\u7531\u914d\u7f6e","text":"<p>\u4e0a\u9762\u662f\u65e5\u5fd7\u6e90\u7684\u914d\u7f6e\uff0c\u63a5\u4e0b\u6765\u770b\u770b\u5982\u4f55\u5c06\u65e5\u5fd7\u6570\u636e\u53d1\u9001\u5230 Elasticsearch\uff1a</p> <pre><code>&lt;match **&gt;\n  @id elasticsearch\n  @type elasticsearch\n  @log_level info\n  include_tag_key true\n  type_name fluentd\n  host \"#{ENV['OUTPUT_HOST']}\"\n  port \"#{ENV['OUTPUT_PORT']}\"\n  logstash_format true\n  &lt;buffer&gt;\n    @type file\n    path /var/log/fluentd-buffers/kubernetes.system.buffer\n    flush_mode interval\n    retry_type exponential_backoff\n    flush_thread_count 2\n    flush_interval 5s\n    retry_forever\n    retry_max_interval 30\n    chunk_limit_size \"#{ENV['OUTPUT_BUFFER_CHUNK_LIMIT']}\"\n    queue_limit_length \"#{ENV['OUTPUT_BUFFER_QUEUE_LIMIT']}\"\n    overflow_action block\n  &lt;/buffer&gt;\n&lt;/match&gt;\n</code></pre> <ul> <li>match\uff1a\u6807\u8bc6\u4e00\u4e2a\u76ee\u6807\u6807\u7b7e\uff0c\u540e\u9762\u662f\u4e00\u4e2a\u5339\u914d\u65e5\u5fd7\u6e90\u7684\u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u6211\u4eec\u8fd9\u91cc\u60f3\u8981\u6355\u83b7\u6240\u6709\u7684\u65e5\u5fd7\u5e76\u5c06\u5b83\u4eec\u53d1\u9001\u7ed9 Elasticsearch\uff0c\u6240\u4ee5\u9700\u8981\u914d\u7f6e\u6210<code>**</code>\u3002</li> <li>id\uff1a\u76ee\u6807\u7684\u4e00\u4e2a\u552f\u4e00\u6807\u8bc6\u7b26\u3002</li> <li>type\uff1a\u652f\u6301\u7684\u8f93\u51fa\u63d2\u4ef6\u6807\u8bc6\u7b26\uff0c\u6211\u4eec\u8fd9\u91cc\u8981\u8f93\u51fa\u5230 Elasticsearch\uff0c\u6240\u4ee5\u914d\u7f6e\u6210 elasticsearch\uff0c\u8fd9\u662f Fluentd \u7684\u4e00\u4e2a\u5185\u7f6e\u63d2\u4ef6\u3002</li> <li><code>log_level</code>\uff1a\u6307\u5b9a\u8981\u6355\u83b7\u7684\u65e5\u5fd7\u7ea7\u522b\uff0c\u6211\u4eec\u8fd9\u91cc\u914d\u7f6e\u6210 info\uff0c\u8868\u793a\u4efb\u4f55\u8be5\u7ea7\u522b\u6216\u8005\u8be5\u7ea7\u522b\u4ee5\u4e0a\uff08INFO\u3001WARNING\u3001ERROR\uff09\u7684\u65e5\u5fd7\u90fd\u5c06\u88ab\u8def\u7531\u5230 Elsasticsearch\u3002</li> <li><code>host/port</code>\uff1a\u5b9a\u4e49 Elasticsearch \u7684\u5730\u5740\uff0c\u4e5f\u53ef\u4ee5\u914d\u7f6e\u8ba4\u8bc1\u4fe1\u606f\uff0c\u6211\u4eec\u7684 Elasticsearch \u4e0d\u9700\u8981\u8ba4\u8bc1\uff0c\u6240\u4ee5\u8fd9\u91cc\u76f4\u63a5\u6307\u5b9a host \u548c port \u5373\u53ef\u3002</li> <li><code>logstash_format</code>\uff1aElasticsearch \u670d\u52a1\u5bf9\u65e5\u5fd7\u6570\u636e\u6784\u5efa\u53cd\u5411\u7d22\u5f15\u8fdb\u884c\u641c\u7d22\uff0c\u5c06 <code>logstash_format</code> \u8bbe\u7f6e\u4e3a true\uff0cFluentd \u5c06\u4f1a\u4ee5 logstash \u683c\u5f0f\u6765\u8f6c\u53d1\u7ed3\u6784\u5316\u7684\u65e5\u5fd7\u6570\u636e\u3002</li> <li>Buffer\uff1aFluentd \u5141\u8bb8\u5728\u76ee\u6807\u4e0d\u53ef\u7528\u65f6\u8fdb\u884c\u7f13\u5b58\uff0c\u6bd4\u5982\uff0c\u5982\u679c\u7f51\u7edc\u51fa\u73b0\u6545\u969c\u6216\u8005 Elasticsearch \u4e0d\u53ef\u7528\u7684\u65f6\u5019\u3002\u7f13\u51b2\u533a\u914d\u7f6e\u4e5f\u6709\u52a9\u4e8e\u964d\u4f4e\u78c1\u76d8\u7684 IO\u3002</li> </ul>"},{"location":"chap10/7EFKLK_log_aggregator/#2-2-3","title":"2-2-3 \u8fc7\u6ee4","text":"<p>\u7531\u4e8e Kubernetes \u96c6\u7fa4\u4e2d\u5e94\u7528\u592a\u591a\uff0c\u4e5f\u8fd8\u6709\u5f88\u591a\u5386\u53f2\u6570\u636e\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u53ea\u5c06\u67d0\u4e9b\u5e94\u7528\u7684\u65e5\u5fd7\u8fdb\u884c\u6536\u96c6\uff0c\u6bd4\u5982\u6211\u4eec\u53ea\u91c7\u96c6\u5177\u6709 <code>logging=true</code> \u8fd9\u4e2a Label \u6807\u7b7e\u7684 Pod \u65e5\u5fd7\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u9700\u8981\u4f7f\u7528 filter\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># \u5220\u9664\u65e0\u7528\u7684\u5c5e\u6027\n&lt;filter kubernetes.**&gt;\n  @type record_transformer\n  remove_keys $.docker.container_id,$.kubernetes.container_image_id,$.kubernetes.pod_id,$.kubernetes.namespace_id,$.kubernetes.master_url,$.kubernetes.labels.pod-template-hash\n&lt;/filter&gt;\n\n# \u53ea\u4fdd\u7559\u5177\u6709logging=true\u6807\u7b7e\u7684Pod\u65e5\u5fd7\n&lt;filter kubernetes.**&gt;\n  @id filter_log\n  @type grep\n  &lt;regexp&gt;\n    key $.kubernetes.labels.logging\n    pattern ^true$\n  &lt;/regexp&gt;\n&lt;/filter&gt;\n</code></pre>"},{"location":"chap10/7EFKLK_log_aggregator/#2-4","title":"2-4 \u5b89\u88c5","text":"<p>\u8981\u6536\u96c6 Kubernetes \u96c6\u7fa4\u7684\u65e5\u5fd7\uff0c\u76f4\u63a5\u7528 DasemonSet \u63a7\u5236\u5668\u6765\u90e8\u7f72 Fluentd \u5e94\u7528\uff0c\u8fd9\u6837\uff0c\u5b83\u5c31\u53ef\u4ee5\u4ece Kubernetes \u8282\u70b9\u4e0a\u91c7\u96c6\u65e5\u5fd7\uff0c\u786e\u4fdd\u5728\u96c6\u7fa4\u4e2d\u7684\u6bcf\u4e2a\u8282\u70b9\u4e0a\u59cb\u7ec8\u8fd0\u884c\u4e00\u4e2a Fluentd \u5bb9\u5668\u3002</p> <p>\u5f53\u7136\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 Helm \u6765\u8fdb\u884c\u4e00\u952e\u5b89\u88c5\uff0c\u4e3a\u4e86\u80fd\u591f\u4e86\u89e3\u66f4\u591a\u5b9e\u73b0\u7ec6\u8282\uff0c\u6211\u4eec\u8fd9\u91cc\u8fd8\u662f\u91c7\u7528\u624b\u52a8\u65b9\u6cd5\u6765\u8fdb\u884c\u5b89\u88c5\u3002</p> <p>\u9996\u5148\uff0c\u6211\u4eec\u901a\u8fc7 ConfigMap \u5bf9\u8c61\u6765\u6307\u5b9a Fluentd \u914d\u7f6e\u6587\u4ef6\uff0c\u65b0\u5efa <code>fluentd-configmap.yaml</code> \u6587\u4ef6\uff0c\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>kind: ConfigMap\napiVersion: v1\nmetadata:\n  name: fluentd-conf\n  namespace: logging\ndata:\n  # \u5bb9\u5668\u65e5\u5fd7\n  containers.input.conf: |-\n    &lt;source&gt;\n      @id fluentd-containers.log\n      @type tail                              # Fluentd \u5185\u7f6e\u7684\u8f93\u5165\u65b9\u5f0f\uff0c\u5176\u539f\u7406\u662f\u4e0d\u505c\u5730\u4ece\u6e90\u6587\u4ef6\u4e2d\u83b7\u53d6\u65b0\u7684\u65e5\u5fd7\n      path /var/log/containers/*.log          # Docker \u5bb9\u5668\u65e5\u5fd7\u8def\u5f84\n      pos_file /var/log/es-containers.log.pos  # \u8bb0\u5f55\u8bfb\u53d6\u7684\u4f4d\u7f6e\n      tag raw.kubernetes.*                    # \u8bbe\u7f6e\u65e5\u5fd7\u6807\u7b7e\n      read_from_head true                     # \u4ece\u5934\u8bfb\u53d6\n      &lt;parse&gt;                                 # \u591a\u884c\u683c\u5f0f\u5316\u6210JSON\n        # \u53ef\u4ee5\u4f7f\u7528\u6211\u4eec\u4ecb\u7ecd\u8fc7\u7684 multiline \u63d2\u4ef6\u5b9e\u73b0\u591a\u884c\u65e5\u5fd7\n        @type multi_format                    # \u4f7f\u7528 multi-format-parser \u89e3\u6790\u5668\u63d2\u4ef6\n        &lt;pattern&gt;\n          format json                         # JSON\u89e3\u6790\u5668\n          time_key time                       # \u6307\u5b9a\u4e8b\u4ef6\u65f6\u95f4\u7684\u65f6\u95f4\u5b57\u6bb5\n          time_format %Y-%m-%dT%H:%M:%S.%NZ   # \u65f6\u95f4\u683c\u5f0f\n        &lt;/pattern&gt;\n        &lt;pattern&gt;\n          format /^(?&lt;time&gt;.+) (?&lt;stream&gt;stdout|stderr) [^ ]* (?&lt;log&gt;.*)$/\n          time_format %Y-%m-%dT%H:%M:%S.%N%:z\n        &lt;/pattern&gt;\n      &lt;/parse&gt;\n    &lt;/source&gt;\n\n    # \u5728\u65e5\u5fd7\u8f93\u51fa\u4e2d\u68c0\u6d4b\u5f02\u5e38(\u591a\u884c\u65e5\u5fd7)\uff0c\u5e76\u5c06\u5176\u4f5c\u4e3a\u4e00\u6761\u65e5\u5fd7\u8f6c\u53d1\n    # https://github.com/GoogleCloudPlatform/fluent-plugin-detect-exceptions\n    &lt;match raw.kubernetes.**&gt;           # \u5339\u914dtag\u4e3araw.kubernetes.**\u65e5\u5fd7\u4fe1\u606f\n      @id raw.kubernetes\n      @type detect_exceptions           # \u4f7f\u7528detect-exceptions\u63d2\u4ef6\u5904\u7406\u5f02\u5e38\u6808\u4fe1\u606f\n      remove_tag_prefix raw             # \u79fb\u9664 raw \u524d\u7f00\n      message log\n      multiline_flush_interval 5\n    &lt;/match&gt;\n\n    &lt;filter **&gt;  # \u62fc\u63a5\u65e5\u5fd7\n      @id filter_concat\n      @type concat                # Fluentd Filter \u63d2\u4ef6\uff0c\u7528\u4e8e\u8fde\u63a5\u591a\u4e2a\u65e5\u5fd7\u4e2d\u5206\u9694\u7684\u591a\u884c\u65e5\u5fd7\n      key message\n      multiline_end_regexp /\\n$/  # \u4ee5\u6362\u884c\u7b26\u201c\\n\u201d\u62fc\u63a5\n      separator \"\"\n    &lt;/filter&gt;\n\n    # \u6dfb\u52a0 Kubernetes metadata \u6570\u636e\n    &lt;filter kubernetes.**&gt;\n      @id filter_kubernetes_metadata\n      @type kubernetes_metadata\n    &lt;/filter&gt;\n\n    # \u4fee\u590d ES \u4e2d\u7684 JSON \u5b57\u6bb5\n    # \u63d2\u4ef6\u5730\u5740\uff1ahttps://github.com/repeatedly/fluent-plugin-multi-format-parser\n    &lt;filter kubernetes.**&gt;\n      @id filter_parser\n      @type parser                # multi-format-parser\u591a\u683c\u5f0f\u89e3\u6790\u5668\u63d2\u4ef6\n      key_name log                # \u5728\u8981\u89e3\u6790\u7684\u65e5\u5fd7\u4e2d\u6307\u5b9a\u5b57\u6bb5\u540d\u79f0\n      reserve_data true           # \u5728\u89e3\u6790\u7ed3\u679c\u4e2d\u4fdd\u7559\u539f\u59cb\u952e\u503c\u5bf9\n      remove_key_name_field true  # key_name \u89e3\u6790\u6210\u529f\u540e\u5220\u9664\u5b57\u6bb5\n      &lt;parse&gt;\n        @type multi_format\n        &lt;pattern&gt;\n          format json\n        &lt;/pattern&gt;\n        &lt;pattern&gt;\n          format none\n        &lt;/pattern&gt;\n      &lt;/parse&gt;\n    &lt;/filter&gt;\n\n    # \u5220\u9664\u4e00\u4e9b\u591a\u4f59\u7684\u5c5e\u6027\n    &lt;filter kubernetes.**&gt;\n      @type record_transformer\n      remove_keys $.docker.container_id,$.kubernetes.container_image_id,$.kubernetes.pod_id,$.kubernetes.namespace_id,$.kubernetes.master_url,$.kubernetes.labels.pod-template-hash\n    &lt;/filter&gt;\n\n    # \u53ea\u4fdd\u7559\u5177\u6709logging=true\u6807\u7b7e\u7684Pod\u65e5\u5fd7\n    &lt;filter kubernetes.**&gt;\n      @id filter_log\n      @type grep\n      &lt;regexp&gt;\n        key $.kubernetes.labels.logging\n        pattern ^true$\n      &lt;/regexp&gt;\n    &lt;/filter&gt;\n\n  ###### \u76d1\u542c\u914d\u7f6e\uff0c\u4e00\u822c\u7528\u4e8e\u65e5\u5fd7\u805a\u5408\u7528 ######\n  forward.input.conf: |-\n    # \u76d1\u542c\u901a\u8fc7TCP\u53d1\u9001\u7684\u6d88\u606f\n    &lt;source&gt;\n      @id forward\n      @type forward\n    &lt;/source&gt;\n\n  output.conf: |-\n    &lt;match **&gt;\n      @id elasticsearch\n      @type elasticsearch\n      @log_level info\n      include_tag_key true\n      host elasticsearch-client\n      port 9200\n      user elastic # FLUENT_ELASTICSEARCH_USER | FLUENT_ELASTICSEARCH_PASSWORD\n      password ydzsio321\n      logstash_format true\n      logstash_prefix k8s\n      request_timeout 30s\n      &lt;buffer&gt;\n        @type file\n        path /var/log/fluentd-buffers/kubernetes.system.buffer\n        flush_mode interval\n        retry_type exponential_backoff\n        flush_thread_count 2\n        flush_interval 5s\n        retry_forever\n        retry_max_interval 30\n        chunk_limit_size 2M\n        queue_limit_length 8\n        overflow_action block\n      &lt;/buffer&gt;\n    &lt;/match&gt;\n</code></pre> <p>\u4e0a\u9762\u914d\u7f6e\u6587\u4ef6\u4e2d\u6211\u4eec\u53ea\u914d\u7f6e\u4e86 docker \u5bb9\u5668\u65e5\u5fd7\u76ee\u5f55\uff0c\u6536\u96c6\u5230\u6570\u636e\u7ecf\u8fc7\u5904\u7406\u540e\u53d1\u9001\u5230 <code>elasticsearch-client:9200</code> \u670d\u52a1\u3002</p> <ul> <li>\u5bb9\u5668\u65e5\u5fd7</li> <li>\u5728\u65e5\u5fd7\u8f93\u51fa\u4e2d\u68c0\u6d4b\u5f02\u5e38(\u591a\u884c\u65e5\u5fd7)\uff0c\u5e76\u5c06\u5176\u4f5c\u4e3a\u4e00\u6761\u65e5\u5fd7\u8f6c\u53d1 https://github.com/GoogleCloudPlatform/fluent-plugin-detect-exceptions<ul> <li>\u5339\u914dtag\u4e3a<code>raw.kubernetes.**</code>\u65e5\u5fd7\u4fe1\u606f</li> <li>\u4f7f\u7528detect-exceptions\u63d2\u4ef6\u5904\u7406\u5f02\u5e38\u6808\u4fe1\u606f</li> <li>\u79fb\u9664 raw \u524d\u7f00</li> </ul> </li> <li>\u62fc\u63a5\u65e5\u5fd7<ul> <li>Fluentd Filter \u63d2\u4ef6\uff0c\u7528\u4e8e\u8fde\u63a5\u591a\u4e2a\u65e5\u5fd7\u4e2d\u5206\u9694\u7684\u591a\u884c\u65e5\u5fd7</li> <li>\u4ee5\u6362\u884c\u7b26<code>\u201c\\n\u201d</code>\u62fc\u63a5</li> </ul> </li> <li>\u6dfb\u52a0 Kubernetes metadata \u6570\u636e</li> <li>\u4fee\u590d ES \u4e2d\u7684 JSON \u5b57\u6bb5 \u63d2\u4ef6\u5730\u5740\uff1ahttps://github.com/repeatedly/fluent-plugin-multi-format-parser<ul> <li><code>multi-format-parser</code>\u591a\u683c\u5f0f\u89e3\u6790\u5668\u63d2\u4ef6</li> <li>\u5728\u8981\u89e3\u6790\u7684\u65e5\u5fd7\u4e2d\u6307\u5b9a\u5b57\u6bb5\u540d\u79f0</li> <li>\u5728\u89e3\u6790\u7ed3\u679c\u4e2d\u4fdd\u7559\u539f\u59cb\u952e\u503c\u5bf9</li> <li><code>key_name\u00b7</code>\u89e3\u6790\u6210\u529f\u540e\u5220\u9664\u5b57\u6bb5</li> </ul> </li> <li>\u5220\u9664\u4e00\u4e9b\u591a\u4f59\u7684\u5c5e\u6027</li> <li>\u53ea\u4fdd\u7559\u5177\u6709<code>logging=true</code>\u6807\u7b7e\u7684Pod\u65e5\u5fd7</li> <li>\u76d1\u542c\u914d\u7f6e\uff0c\u4e00\u822c\u7528\u4e8e\u65e5\u5fd7\u805a\u5408\u7528</li> </ul> <p>\u7136\u540e\u65b0\u5efa\u4e00\u4e2a <code>fluentd-daemonset.yaml</code> \u7684\u6587\u4ef6\uff0c\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: fluentd-es\n  namespace: logging\n  labels:\n    k8s-app: fluentd-es\n    kubernetes.io/cluster-service: \"true\"\n    addonmanager.kubernetes.io/mode: Reconcile\n---\nkind: ClusterRole\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: fluentd-es\n  labels:\n    k8s-app: fluentd-es\n    kubernetes.io/cluster-service: \"true\"\n    addonmanager.kubernetes.io/mode: Reconcile\nrules:\n  - apiGroups:\n      - \"\"\n    resources:\n      - \"namespaces\"\n      - \"pods\"\n    verbs:\n      - \"get\"\n      - \"watch\"\n      - \"list\"\n---\nkind: ClusterRoleBinding\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: fluentd-es\n  labels:\n    k8s-app: fluentd-es\n    kubernetes.io/cluster-service: \"true\"\n    addonmanager.kubernetes.io/mode: Reconcile\nsubjects:\n  - kind: ServiceAccount\n    name: fluentd-es\n    namespace: logging\n    apiGroup: \"\"\nroleRef:\n  kind: ClusterRole\n  name: fluentd-es\n  apiGroup: \"\"\n---\napiVersion: apps/v1\nkind: DaemonSet\nmetadata:\n  name: fluentd\n  namespace: logging\n  labels:\n    app: fluentd\n    kubernetes.io/cluster-service: \"true\"\nspec:\n  selector:\n    matchLabels:\n      app: fluentd\n  template:\n    metadata:\n      labels:\n        app: fluentd\n        kubernetes.io/cluster-service: \"true\"\n    spec:\n      tolerations:\n        - key: node-role.kubernetes.io/master\n          effect: NoSchedule\n      serviceAccountName: fluentd-es\n      containers:\n        - name: fluentd\n          image: quay.io/fluentd_elasticsearch/fluentd:v3.2.0\n          volumeMounts:\n            - name: fluentconfig\n              mountPath: /etc/fluent/config.d\n            - name: varlog\n              mountPath: /var/log\n            - name: varlibdockercontainers\n              mountPath: /var/lib/docker/containers\n              readOnly: true\n      terminationGracePeriodSeconds: 30\n      volumes:\n        - name: fluentconfig\n          configMap:\n            name: fluentd-conf\n        - name: varlog\n          hostPath:\n            path: /var/log\n        - name: varlibdockercontainers\n          hostPath:\n            path: /var/lib/docker/containers\n</code></pre> <p>\u6211\u4eec\u5c06\u4e0a\u9762\u521b\u5efa\u7684 <code>fluentd-config</code> \u8fd9\u4e2a <code>ConfigMap</code> \u5bf9\u8c61\u901a\u8fc7 <code>volumes</code> \u6302\u8f7d\u5230\u4e86 <code>Fluentd</code> \u5bb9\u5668\u4e2d\uff0c\u53e6\u5916\u4e3a\u4e86\u80fd\u591f\u7075\u6d3b\u63a7\u5236\u54ea\u4e9b\u8282\u70b9\u7684\u65e5\u5fd7\u53ef\u4ee5\u88ab\u6536\u96c6\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u8fd8\u6dfb\u52a0\u4e86\u4e00\u4e2a <code>nodSelector</code> \u5c5e\u6027\uff1a</p> <pre><code>nodeSelector:\n  beta.kubernetes.io/fluentd-ds-ready: \"true\"\n</code></pre> <p>\u610f\u601d\u5c31\u662f\u8981\u60f3\u91c7\u96c6\u8282\u70b9\u7684\u65e5\u5fd7\uff0c\u90a3\u4e48\u6211\u4eec\u5c31\u9700\u8981\u7ed9\u8282\u70b9\u6253\u4e0a\u4e0a\u9762\u7684\u6807\u7b7e\u3002</p> <p>!!! info \"\u63d0\u793a\" \u5982\u679c\u4f60\u9700\u8981\u5728\u5176\u4ed6\u8282\u70b9\u4e0a\u91c7\u96c6\u65e5\u5fd7\uff0c\u5219\u9700\u8981\u7ed9\u5bf9\u5e94\u8282\u70b9\u6253\u4e0a\u6807\u7b7e\uff0c\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\uff1a</p> <p><code>kubectl label nodes node\u540d beta.kubernetes.io/fluentd-ds-ready=true</code>\u3002</p> <p>\u53e6\u5916\u7531\u4e8e\u6211\u4eec\u7684\u96c6\u7fa4\u4f7f\u7528\u7684\u662f kubeadm \u642d\u5efa\u7684\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b master \u8282\u70b9\u6709\u6c61\u70b9\uff0c\u6240\u4ee5\u5982\u679c\u8981\u60f3\u4e5f\u6536\u96c6 master \u8282\u70b9\u7684\u65e5\u5fd7\uff0c\u5219\u9700\u8981\u6dfb\u52a0\u4e0a\u5bb9\u5fcd\uff1a</p> <pre><code>tolerations:\n  - operator: Exists\n</code></pre> <p>\u53e6\u5916\u9700\u8981\u6ce8\u610f\u7684\u5730\u65b9\u662f\uff0c\u5982\u679c\u66f4\u6539\u4e86 docker \u7684\u6839\u76ee\u5f55\uff0c\u5219\u5728 volumes \u548c volumeMount \u91cc\u9762\u90fd\u9700\u8981\u66f4\u6539\uff0c\u4fdd\u6301\u4e00\u81f4\u3002</p> <p>\u5206\u522b\u521b\u5efa\u4e0a\u9762\u7684 ConfigMap \u5bf9\u8c61\u548c DaemonSet\uff1a</p> <pre><code>$ kubectl create -f fluentd-configmap.yaml\nconfigmap \"fluentd-conf\" created\n$ kubectl create -f fluentd-daemonset.yaml\nserviceaccount \"fluentd-es\" created\nclusterrole.rbac.authorization.k8s.io \"fluentd-es\" created\nclusterrolebinding.rbac.authorization.k8s.io \"fluentd-es\" created\ndaemonset.apps \"fluentd\" created\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u67e5\u770b\u5bf9\u5e94\u7684 Pods \u5217\u8868\uff0c\u68c0\u67e5\u662f\u5426\u90e8\u7f72\u6210\u529f\uff1a</p> <pre><code>$ kubectl get pods -n logging\nNAME                            READY   STATUS    RESTARTS   AGE\nelasticsearch-client-0          1/1     Running   0          64m\nelasticsearch-data-0            1/1     Running   0          65m\nelasticsearch-master-0          1/1     Running   0          73m\nfluentd-5rqbq                   1/1     Running   0          60m\nfluentd-l6mgf                   1/1     Running   0          60m\nfluentd-xmfpg                   1/1     Running   0          60m\nkibana-kibana-66f97964b-mdspc   1/1     Running   0          63m\n</code></pre> <p>Fluentd \u542f\u52a8\u6210\u529f\u540e\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u53ef\u4ee5\u53d1\u9001\u65e5\u5fd7\u5230 ES \u4e86\uff0c\u4f46\u662f\u6211\u4eec\u8fd9\u91cc\u662f\u8fc7\u6ee4\u4e86\u53ea\u91c7\u96c6\u5177\u6709 <code>logging=true</code> \u6807\u7b7e\u7684 Pod \u65e5\u5fd7\uff0c\u6240\u4ee5\u73b0\u5728\u8fd8\u6ca1\u6709\u4efb\u4f55\u6570\u636e\u4f1a\u88ab\u91c7\u96c6\u3002</p> <p>\u4e0b\u9762\u6211\u4eec\u90e8\u7f72\u4e00\u4e2a\u7b80\u5355\u7684\u6d4b\u8bd5\u5e94\u7528\uff0c \u65b0\u5efa counter.yaml \u6587\u4ef6\uff0c\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>\napiVersion: v1\nkind: Pod\nmetadata:\n  name: counter\n  labels:\n    logging: \"true\" # \u4e00\u5b9a\u8981\u5177\u6709\u8be5\u6807\u7b7e\u624d\u4f1a\u88ab\u91c7\u96c6\nspec:\n  containers:\n    - name: count\n      image: busybox\n      args:\n        [\n          /bin/sh,\n          -c,\n          'i=0; while true; do echo \"$i: $(date)\"; i=$((i+1)); sleep 1; done',\n        ]\n</code></pre> <p>\u8be5 Pod \u53ea\u662f\u7b80\u5355\u5c06\u65e5\u5fd7\u4fe1\u606f\u6253\u5370\u5230 stdout\uff0c\u6240\u4ee5\u6b63\u5e38\u6765\u8bf4 Fluentd \u4f1a\u6536\u96c6\u5230\u8fd9\u4e2a\u65e5\u5fd7\u6570\u636e\uff0c\u5728 Kibana \u4e2d\u4e5f\u5c31\u53ef\u4ee5\u627e\u5230\u5bf9\u5e94\u7684\u65e5\u5fd7\u6570\u636e\u4e86\uff0c\u4f7f\u7528 kubectl \u5de5\u5177\u521b\u5efa\u8be5 Pod\uff1a</p> <pre><code>$ kubectl create -f counter.yaml\n$ kubectl get pods\nNAME                             READY   STATUS    RESTARTS   AGE\ncounter                          1/1     Running   0          9h\n</code></pre> <p>Pod \u521b\u5efa\u5e76\u8fd0\u884c\u540e\uff0c\u56de\u5230 Kibana Dashboard \u9875\u9762\uff0c\u70b9\u51fb\u5de6\u4fa7\u6700\u4e0b\u9762\u7684 <code>Management -&gt; Stack Management</code>\uff0c\u8fdb\u5165\u7ba1\u7406\u9875\u9762\uff0c\u70b9\u51fb\u5de6\u4fa7 Kibana \u4e0b\u9762\u7684 \u7d22\u5f15\u6a21\u5f0f\uff0c\u70b9\u51fb \u521b\u5efa\u7d22\u5f15\u6a21\u5f0f \u5f00\u59cb\u5bfc\u5165\u7d22\u5f15\u6570\u636e\uff1a</p> <p></p> <p>\u5728\u8fd9\u91cc\u53ef\u4ee5\u914d\u7f6e\u6211\u4eec\u9700\u8981\u7684 Elasticsearch \u7d22\u5f15\uff0c\u524d\u9762 Fluentd \u914d\u7f6e\u6587\u4ef6\u4e2d\u6211\u4eec\u91c7\u96c6\u7684\u65e5\u5fd7\u4f7f\u7528\u7684\u662f logstash \u683c\u5f0f\uff0c\u5b9a\u4e49\u4e86\u4e00\u4e2a k8s \u7684\u524d\u7f00\uff0c\u6240\u4ee5\u8fd9\u91cc\u53ea\u9700\u8981\u5728\u6587\u672c\u6846\u4e2d\u8f93\u5165 <code>k8s-*</code> \u5373\u53ef\u5339\u914d\u5230 Elasticsearch \u96c6\u7fa4\u4e2d\u91c7\u96c6\u7684 Kubernetes \u96c6\u7fa4\u65e5\u5fd7\u6570\u636e\uff0c\u7136\u540e\u70b9\u51fb\u4e0b\u4e00\u6b65\uff0c\u8fdb\u5165\u4ee5\u4e0b\u9875\u9762\uff1a</p> <p></p> <p>\u5728\u8be5\u9875\u9762\u4e2d\u914d\u7f6e\u4f7f\u7528\u54ea\u4e2a\u5b57\u6bb5\u6309\u65f6\u95f4\u8fc7\u6ee4\u65e5\u5fd7\u6570\u636e\uff0c\u5728\u4e0b\u62c9\u5217\u8868\u4e2d\uff0c\u9009\u62e9<code>@timestamp</code>\u5b57\u6bb5\uff0c\u7136\u540e\u70b9\u51fb \u521b\u5efa\u7d22\u5f15\u6a21\u5f0f\uff0c\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u70b9\u51fb\u5de6\u4fa7\u5bfc\u822a\u83dc\u5355\u4e2d\u7684 Discover\uff0c\u7136\u540e\u5c31\u53ef\u4ee5\u770b\u5230\u4e00\u4e9b\u76f4\u65b9\u56fe\u548c\u6700\u8fd1\u91c7\u96c6\u5230\u7684\u65e5\u5fd7\u6570\u636e\u4e86\uff1a</p> <p></p> <p>\u73b0\u5728\u7684\u6570\u636e\u5c31\u662f\u4e0a\u9762 Counter \u5e94\u7528\u7684\u65e5\u5fd7\uff0c\u5982\u679c\u8fd8\u6709\u5176\u4ed6\u7684\u5e94\u7528\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u7b5b\u9009\u8fc7\u6ee4\uff1a</p> <p></p> <p>\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7\u5176\u4ed6\u5143\u6570\u636e\u6765\u8fc7\u6ee4\u65e5\u5fd7\u6570\u636e\uff0c\u6bd4\u5982\u60a8\u53ef\u4ee5\u5355\u51fb\u4efb\u4f55\u65e5\u5fd7\u6761\u76ee\u4ee5\u67e5\u770b\u5176\u4ed6\u5143\u6570\u636e\uff0c\u5982\u5bb9\u5668\u540d\u79f0\uff0cKubernetes \u8282\u70b9\uff0c\u547d\u540d\u7a7a\u95f4\u7b49\u3002</p>"},{"location":"chap10/7EFKLK_log_aggregator/#3-kafka","title":"3\u3001\u5b89\u88c5 Kafka","text":"<p>\u5bf9\u4e8e\u5927\u89c4\u6a21\u96c6\u7fa4\u6765\u8bf4\uff0c\u65e5\u5fd7\u6570\u636e\u91cf\u662f\u975e\u5e38\u5de8\u5927\u7684\uff0c\u5982\u679c\u76f4\u63a5\u901a\u8fc7 Fluentd \u5c06\u65e5\u5fd7\u6253\u5165 Elasticsearch\uff0c\u5bf9 ES \u6765\u8bf4\u538b\u529b\u662f\u975e\u5e38\u5de8\u5927\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u4e2d\u95f4\u52a0\u4e00\u5c42\u6d88\u606f\u4e2d\u95f4\u4ef6\u6765\u7f13\u89e3 ES \u7684\u538b\u529b</p> <ul> <li>\u4e00\u822c\u60c5\u51b5\u4e0b\u6211\u4eec\u4f1a\u4f7f\u7528 Kafka\uff0c\u7136\u540e\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 <code>kafka-connect-elasticsearch</code> \u8fd9\u6837\u7684\u5de5\u5177\u5c06\u6570\u636e\u76f4\u63a5\u6253\u5165 ES\uff0c\u4e5f\u53ef\u4ee5\u5728\u52a0\u4e00\u5c42 Logstash \u53bb\u6d88\u8d39 Kafka \u7684\u6570\u636e</li> <li>\u7136\u540e\u901a\u8fc7 Logstash \u628a\u6570\u636e\u5b58\u5165 ES\uff0c\u8fd9\u91cc\u6211\u4eec\u6765\u4f7f\u7528 Logstash \u8fd9\u79cd\u6a21\u5f0f\u6765\u5bf9\u65e5\u5fd7\u6536\u96c6\u8fdb\u884c\u4f18\u5316\u3002</li> </ul> <p>\u9996\u5148\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u5b89\u88c5 Kafka\uff0c\u540c\u6837\u8fd9\u91cc\u4f7f\u7528 Helm \u8fdb\u884c\u5b89\u88c5\uff1a</p> <pre><code>helm repo add bitnami https://charts.bitnami.com/bitnami\nhelm repo update\n</code></pre> <p>\u9996\u5148\u4f7f\u7528 helm pull \u62c9\u53d6 Chart \u5e76\u89e3\u538b\uff1a</p> <pre><code>helm pull bitnami/kafka --untar --version 12.17.5\ncd kafka\n</code></pre> <p>\u8fd9\u91cc\u9762\u6211\u4eec\u6307\u5b9a\u4f7f\u7528\u4e00\u4e2a <code>StorageClass</code> \u6765\u63d0\u4f9b\u6301\u4e45\u5316\u5b58\u50a8\uff0c\u5728 Chart \u76ee\u5f55\u4e0b\u9762\u521b\u5efa\u7528\u4e8e\u5b89\u88c5\u7684 values \u6587\u4ef6\uff1a</p> <p><code>values-prod.yaml</code></p> <pre><code># values-prod.yaml\n## Persistence parameters\n##\npersistence:\n  enabled: true\n  storageClass: \"nfs-storage\"\n  accessModes:\n    - ReadWriteOnce\n  size: 5Gi\n  ## Mount point for persistence\n  mountPath: /bitnami/kafka\n\n# \u914d\u7f6ezk volumes\nzookeeper:\n  enabled: true\n  persistence:\n    enabled: true\n    storageClass: \"nfs-storage\"\n    accessModes:\n      - ReadWriteOnce\n    size: 8Gi\n</code></pre> <p>\u76f4\u63a5\u4f7f\u7528\u4e0a\u9762\u7684 values \u6587\u4ef6\u5b89\u88c5 kafka\uff1a</p> <pre><code>$ helm install kafka -f values-prod.yaml --namespace logging .\nRelease \"kafka\" does not exist. Installing it now.\nNAME: kafka\nLAST DEPLOYED: Tue Apr 27 18:46:01 2021\nNAMESPACE: logging\nSTATUS: deployed\nREVISION: 1\nTEST SUITE: None\nNOTES:\n** Please be patient while the chart is being deployed **\n\nKafka can be accessed by consumers via port 9092 on the following DNS name from within your cluster:\n\n    kafka.logging.svc.cluster.local\n\nEach Kafka broker can be accessed by producers via port 9092 on the following DNS name(s) from within your cluster:\n\n    kafka-0.kafka-headless.logging.svc.cluster.local:9092\n\nTo create a pod that you can use as a Kafka client run the following commands:\n\n    kubectl run kafka-client --restart='Never' --image docker.io/bitnami/kafka:2.8.0-debian-10-r0 --namespace logging --command -- sleep infinity\n    kubectl exec --tty -i kafka-client --namespace logging -- bash\n\n    PRODUCER:\n        kafka-console-producer.sh \\\n\n            --broker-list kafka-0.kafka-headless.logging.svc.cluster.local:9092 \\\n            --topic test\n\n    CONSUMER:\n        kafka-console-consumer.sh \\\n\n            --bootstrap-server kafka.logging.svc.cluster.local:9092 \\\n            --topic test \\\n            --from-beginning\n</code></pre> <p>\u5b89\u88c5\u5b8c\u6210\u540e\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0a\u9762\u7684\u63d0\u793a\u6765\u68c0\u67e5 Kafka \u662f\u5426\u6b63\u5e38\u8fd0\u884c\uff1a</p> <pre><code>$ kubectl get pods -n logging -l app.kubernetes.io/instance=kafka\nkafka-0             1/1     Running   0          7m58s\nkafka-zookeeper-0   1/1     Running   0          7m58s\n</code></pre> <p>\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u521b\u5efa\u4e00\u4e2a Kafka \u7684\u6d4b\u8bd5\u5ba2\u6237\u7aef Pod\uff1a</p> <pre><code>$ kubectl run kafka-client --restart='Never' --image docker.io/bitnami/kafka:2.8.0-debian-10-r0 --namespace logging --command -- sleep infinity\npod/kafka-client created\n</code></pre> <p>\u7136\u540e\u542f\u52a8\u4e00\u4e2a\u7ec8\u7aef\u8fdb\u5165\u5bb9\u5668\u5185\u90e8\u751f\u4ea7\u6d88\u606f\uff1a</p> <pre><code># \u751f\u4ea7\u8005\n$ kubectl exec --tty -i kafka-client --namespace logging -- bash\nI have no name!@kafka-client:/$ kafka-console-producer.sh --broker-list kafka-0.kafka-headless.logging.svc.cluster.local:9092 --topic test\n&gt;hello kafka on k8s\n&gt;\n</code></pre> <p>\u542f\u52a8\u53e6\u5916\u4e00\u4e2a\u7ec8\u7aef\u8fdb\u5165\u5bb9\u5668\u5185\u90e8\u6d88\u8d39\u6d88\u606f\uff1a</p> <pre><code># \u6d88\u8d39\u8005\n$ kubectl exec --tty -i kafka-client --namespace logging -- bash\nI have no name!@kafka-client:/$ kafka-console-consumer.sh --bootstrap-server kafka.logging.svc.cluster.local:9092 --topic test --from-beginning\nhello kafka on k8s\n</code></pre> <p>\u5982\u679c\u5728\u6d88\u8d39\u7aef\u770b\u5230\u4e86\u751f\u4ea7\u7684\u6d88\u606f\u6570\u636e\u8bc1\u660e\u6211\u4eec\u7684 Kafka \u5df2\u7ecf\u8fd0\u884c\u6210\u529f\u4e86\u3002</p>"},{"location":"chap10/7EFKLK_log_aggregator/#4fluentd-kafka","title":"4\u3001Fluentd \u914d\u7f6e Kafka","text":"<p>\u73b0\u5728\u6709\u4e86 Kafka\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5c06 Fluentd \u7684\u65e5\u5fd7\u6570\u636e\u8f93\u51fa\u5230 Kafka \u4e86\uff0c\u53ea\u9700\u8981\u5c06 Fluentd \u914d\u7f6e\u4e2d\u7684 <code>&lt;match&gt;</code>\u66f4\u6539\u4e3a\u4f7f\u7528 Kafka \u63d2\u4ef6\u5373\u53ef\uff0c\u4f46\u662f\u5728 Fluentd \u4e2d\u8f93\u51fa\u5230 Kafka\uff0c\u9700\u8981\u4f7f\u7528\u5230 <code>fluent-plugin-kafka</code> \u63d2\u4ef6</p> <p>\u6240\u4ee5\u9700\u8981\u6211\u4eec\u81ea\u5b9a\u4e49\u4e0b Docker \u955c\u50cf\uff0c\u6700\u7b80\u5355\u7684\u505a\u6cd5\u5c31\u662f\u5728\u4e0a\u9762 Fluentd \u955c\u50cf\u7684\u57fa\u7840\u4e0a\u65b0\u589e kafka \u63d2\u4ef6\u5373\u53ef\uff0cDockerfile \u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>FROM quay.io/fluentd_elasticsearch/fluentd:v3.2.0\nRUN echo \"source 'https://mirrors.tuna.tsinghua.edu.cn/rubygems/'\" &gt; Gemfile &amp;&amp; gem install bundler\nRUN gem install fluent-plugin-kafka -v 0.16.1 --no-document\n</code></pre> <p>\u4f7f\u7528\u4e0a\u9762\u7684 <code>Dockerfile</code> \u6587\u4ef6\u6784\u5efa\u4e00\u4e2a Docker \u955c\u50cf\u5373\u53ef\uff0c\u6211\u8fd9\u91cc\u6784\u5efa\u8fc7\u540e\u7684\u955c\u50cf\u540d\u4e3a <code>cnych/fluentd-kafka:v0.16.1</code>\u3002</p> <p>\u63a5\u4e0b\u6765\u66ff\u6362 Fluentd \u7684 Configmap \u5bf9\u8c61\u4e2d\u7684 <code>&lt;match&gt;</code> \u90e8\u5206\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <p><code>fluentd-configmap.yaml</code></p> <pre><code># fluentd-configmap.yaml\nkind: ConfigMap\napiVersion: v1\nmetadata:\n  name: fluentd-conf\n  namespace: logging\ndata:\n  ......\n  output.conf: |-\n    &lt;match **&gt;\n      @id kafka\n      @type kafka2\n      @log_level info\n      # list of seed brokers\n      brokers kafka-0.kafka-headless.logging.svc.cluster.local:9092\n      use_event_time true\n      # topic settings\n      topic_key k8slog\n      default_topic messages  # \u6ce8\u610f\uff0ckafka\u4e2d\u6d88\u8d39\u4f7f\u7528\u7684\u662f\u8fd9\u4e2atopic\n      # buffer settings\n      &lt;buffer k8slog&gt;\n        @type file\n        path /var/log/td-agent/buffer/td\n        flush_interval 3s\n      &lt;/buffer&gt;\n      # data type settings\n      &lt;format&gt;\n        @type json\n      &lt;/format&gt;\n      # producer settings\n      required_acks -1\n      compression_codec gzip\n    &lt;/match&gt;\n</code></pre> <p>\u7136\u540e\u66ff\u6362\u8fd0\u884c\u7684 Fluentd \u955c\u50cf\uff1a</p> <pre><code># fluentd-daemonset.yaml\nimage: cnych/fluentd-kafka:v0.16.1\n</code></pre> <p>\u76f4\u63a5\u66f4\u65b0 Fluentd \u7684 Configmap \u4e0e DaemonSet \u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>kubectl apply -f fluentd-configmap.yaml\nkubectl apply -f fluentd-daemonset.yaml\n</code></pre> <p>\u66f4\u65b0\u6210\u529f\u540e\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0a\u9762\u7684\u6d4b\u8bd5 Kafka \u5ba2\u6237\u7aef\u6765\u9a8c\u8bc1\u662f\u5426\u6709\u65e5\u5fd7\u6570\u636e\uff1a</p> <pre><code>$ kubectl exec --tty -i kafka-client --namespace logging -- bash\nI have no name!@kafka-client:/$ kafka-console-consumer.sh --bootstrap-server kafka.logging.svc.cluster.local:9092 --topic messages --from-beginning\n{\"stream\":\"stdout\",\"docker\":{},\"kubernetes\":{\"container_name\":\"count\",\"namespace_name\":\"default\",\"pod_name\":\"counter\",\"container_image\":\"busybox:latest\",\"host\":\"node1\",\"labels\":{\"logging\":\"true\"}},\"message\":\"43883: Tue Apr 27 12:16:30 UTC 2021\\n\"}\n......\n</code></pre>"},{"location":"chap10/7EFKLK_log_aggregator/#5-logstash","title":"5\u3001\u5b89\u88c5 Logstash","text":"<p>\u867d\u7136\u6570\u636e\u4ece Kafka \u5230 Elasticsearch \u7684\u65b9\u5f0f\u591a\u79cd\u591a\u6837\uff0c\u6211\u4eec\u8fd9\u91cc\u8fd8\u662f\u91c7\u7528\u66f4\u52a0\u6d41\u884c\u7684 Logstash \u65b9\u6848\uff0c\u4e0a\u9762\u6211\u4eec\u5df2\u7ecf\u5c06\u65e5\u5fd7\u4ece Fluentd \u91c7\u96c6\u8f93\u51fa\u5230 Kafka \u4e2d\u53bb\u4e86\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u4f7f\u7528 Logstash \u6765\u8fde\u63a5 Kafka \u4e0e Elasticsearch \u95f4\u7684\u65e5\u5fd7\u6570\u636e\u3002</p> <p>\u9996\u5148\u4f7f\u7528 <code>helm pull</code> \u62c9\u53d6 Chart \u5e76\u89e3\u538b\uff1a</p> <pre><code>helm pull elastic/logstash --untar --version 7.12.0\ncd logstash\n</code></pre> <p>\u540c\u6837\u5728 Chart \u6839\u76ee\u5f55\u4e0b\u9762\u521b\u5efa\u7528\u4e8e\u5b89\u88c5\u7684 Values \u6587\u4ef6\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <p><code>values-prod.yaml</code></p> <pre><code># values-prod.yaml\nfullnameOverride: logstash\n\npersistence:\n  enabled: true\n\nlogstashConfig:\n  logstash.yml: |\n    http.host: 0.0.0.0\n    # \u5982\u679c\u542f\u7528\u4e86xpack\uff0c\u9700\u8981\u505a\u5982\u4e0b\u914d\u7f6e\n    xpack.monitoring.enabled: true\n    xpack.monitoring.elasticsearch.hosts: [\"http://elasticsearch-client:9200\"]\n    xpack.monitoring.elasticsearch.username: \"elastic\"\n    xpack.monitoring.elasticsearch.password: \"jxi321\"\n\n# \u8981\u6ce8\u610f\u4e0b\u683c\u5f0f\nlogstashPipeline:\n  logstash.conf: |\n    input { kafka { bootstrap_servers =&gt; \"kafka-0.kafka-headless.logging.svc.cluster.local:9092\" codec =&gt; json consumer_threads =&gt; 3 topics =&gt; [\"messages\"] } }\n    filter {}  # \u8fc7\u6ee4\u914d\u7f6e\uff08\u6bd4\u5982\u53ef\u4ee5\u5220\u9664key\u3001\u6dfb\u52a0geoip\u7b49\u7b49\uff09\n    output { elasticsearch { hosts =&gt; [ \"elasticsearch-client:9200\" ] user =&gt; \"elastic\" password =&gt; \"ydzsio321\" index =&gt; \"logstash-k8s-%{+YYYY.MM.dd}\" } stdout { codec =&gt; rubydebug } }\n\nvolumeClaimTemplate:\n  accessModes: [\"ReadWriteOnce\"]\n  storageClassName: nfs-storage\n  resources:\n    requests:\n      storage: 1Gi\n</code></pre> <p>\u5176\u4e2d\u6700\u91cd\u8981\u7684\u5c31\u662f\u901a\u8fc7 <code>logstashPipeline</code> \u914d\u7f6e <code>logstash</code> \u6570\u636e\u6d41\u7684\u5904\u7406\u914d\u7f6e\uff0c\u901a\u8fc7 <code>inpu</code>t \u6307\u5b9a\u65e5\u5fd7\u6e90 kafka \u7684\u914d\u7f6e\uff0c\u901a\u8fc7 <code>output</code> \u8f93\u51fa\u5230 <code>Elasticsearch</code>\uff0c\u540c\u6837\u76f4\u63a5\u4f7f\u7528\u4e0a\u9762\u7684 <code>Values</code> \u6587\u4ef6\u5b89\u88c5 logstash \u5373\u53ef\uff1a</p> <pre><code>$ helm upgrade --install logstash -f values-prod.yaml --namespace logging .\nRelease \"logstash\" does not exist. Installing it now.\nNAME: logstash\nLAST DEPLOYED: Tue Apr 27 20:22:45 2021\nNAMESPACE: logging\nSTATUS: deployed\nREVISION: 1\nTEST SUITE: None\nNOTES:\n1. Watch all cluster members come up.\n  $ kubectl get pods --namespace=logging -l app=logstash -w\n</code></pre> <p>\u5b89\u88c5\u542f\u52a8\u5b8c\u6210\u540e\u53ef\u4ee5\u67e5\u770b logstash \u7684\u65e5\u5fd7\uff1a</p> <pre><code>$ logstash kubectl get pods --namespace=logging -l app=logstash\nNAME         READY   STATUS    RESTARTS   AGE\nlogstash-0   1/1     Running   0          2m8s\n$ kubectl logs -f logstash-0 -n logging\n......\n{\n\"docker\" =&gt; {},\n\"stream\" =&gt; \"stdout\",\n\"message\" =&gt; \"46921: Tue Apr 27 13:07:15 UTC 2021\\n\",\n\"kubernetes\" =&gt; {\n            \"host\" =&gt; \"node1\",\n          \"labels\" =&gt; {\n    \"logging\" =&gt; \"true\"\n},\n        \"pod_name\" =&gt; \"counter\",\n\"container_image\" =&gt; \"busybox:latest\",\n  \"container_name\" =&gt; \"count\",\n  \"namespace_name\" =&gt; \"default\"\n},\n\"@timestamp\" =&gt; 2021-04-27T13:07:15.761Z,\n\"@version\" =&gt; \"1\"\n}\n</code></pre> <p>\u7531\u4e8e\u6211\u4eec\u542f\u7528\u4e86 debug \u65e5\u5fd7\u8c03\u8bd5\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u5728 logstash \u7684\u65e5\u5fd7\u4e2d\u770b\u5230\u6211\u4eec\u91c7\u96c6\u7684\u65e5\u5fd7\u6d88\u606f\uff0c\u5230\u8fd9\u91cc\u8bc1\u660e\u6211\u4eec\u7684\u65e5\u5fd7\u6570\u636e\u5c31\u83b7\u53d6\u6210\u529f\u4e86\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u767b\u5f55\u5230 Kibana \u53ef\u4ee5\u770b\u5230\u6709\u5982\u4e0b\u6240\u793a\u7684\u7d22\u5f15\u6570\u636e\u4e86\uff1a</p> <p></p> <p>\u7136\u540e\u540c\u6837\u521b\u5efa\u7d22\u5f15\u6a21\u5f0f\uff0c\u5339\u914d\u4e0a\u9762\u7684\u7d22\u5f15\u5373\u53ef\uff1a</p> <p></p> <p>\u521b\u5efa\u5b8c\u6210\u540e\u5c31\u53ef\u4ee5\u524d\u5f80\u53d1\u73b0\u9875\u9762\u8fc7\u6ee4\u65e5\u5fd7\u6570\u636e\u4e86\uff1a</p> <p></p> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u5b9e\u73b0\u4e86\u4e00\u4e2a\u4f7f\u7528 <code>Fluentd+Kafka+Logstash+Elasticsearch+Kibana</code> \u7684 Kubernetes \u65e5\u5fd7\u6536\u96c6\u5de5\u5177\u6808\uff0c\u8fd9\u91cc\u6211\u4eec\u5b8c\u6574\u7684 Pod \u4fe1\u606f\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>$ kubectl get pods -n logging\nNAME                            READY   STATUS    RESTARTS   AGE\nelasticsearch-client-0          1/1     Running   0          128m\nelasticsearch-data-0            1/1     Running   0          128m\nelasticsearch-master-0          1/1     Running   0          128m\nfluentd-6k52h                   1/1     Running   0          61m\nfluentd-cw72c                   1/1     Running   0          61m\nfluentd-dn4hs                   1/1     Running   0          61m\nkafka-0                         1/1     Running   3          134m\nkafka-client                    1/1     Running   0          125m\nkafka-zookeeper-0               1/1     Running   0          134m\nkibana-kibana-66f97964b-qqjgg   1/1     Running   0          128m\nlogstash-0                      1/1     Running   0          13m\n</code></pre> <p>\u5f53\u7136\u5728\u5b9e\u9645\u7684\u5de5\u4f5c\u9879\u76ee\u4e2d\u8fd8\u9700\u8981\u6211\u4eec\u6839\u636e\u5b9e\u9645\u7684\u4e1a\u52a1\u573a\u666f\u6765\u8fdb\u884c\u53c2\u6570\u6027\u80fd\u8c03\u4f18\u4ee5\u53ca\u9ad8\u53ef\u7528\u7b49\u8bbe\u7f6e\uff0c\u4ee5\u8fbe\u5230\u7cfb\u7edf\u7684\u6700\u4f18\u6027\u80fd\u3002</p>"},{"location":"chap11/20Elastic_Stack_Monitoring1/","title":"\u7b2c\u4e00\u8282 ElasticSearch \u7684\u96c6\u7fa4\u5b89\u88c5","text":"<p>\u6211\u4eec\u5c06\u5b66\u4e60\u5982\u4f55\u4f7f\u7528 Elastic \u6280\u672f\u6808\u6765\u4e3a Kubernetes \u6784\u5efa\u76d1\u63a7\u73af\u5883\u3002\u53ef\u89c2\u6d4b\u6027\u7684\u76ee\u6807\u662f\u4e3a\u751f\u4ea7\u73af\u5883\u63d0\u4f9b\u8fd0\u7ef4\u5de5\u5177\u6765\u68c0\u6d4b\u670d\u52a1\u4e0d\u53ef\u7528\u7684\u60c5\u51b5\uff08\u6bd4\u5982\u670d\u52a1\u5b95\u673a\u3001\u9519\u8bef\u6216\u8005\u54cd\u5e94\u53d8\u6162\u7b49\uff09\uff0c\u5e76\u4e14\u4fdd\u7559\u4e00\u4e9b\u53ef\u4ee5\u6392\u67e5\u7684\u4fe1\u606f\uff0c\u4ee5\u5e2e\u52a9\u6211\u4eec\u5b9a\u4f4d\u95ee\u9898\u3002\u603b\u7684\u6765\u8bf4\u4e3b\u8981\u5305\u62ec3\u4e2a\u65b9\u9762\uff1a</p> <ul> <li>\u76d1\u63a7\u6307\u6807\u63d0\u4f9b\u7cfb\u7edf\u5404\u4e2a\u7ec4\u4ef6\u7684\u65f6\u95f4\u5e8f\u5217\u6570\u636e\uff0c\u6bd4\u5982 CPU\u3001\u5185\u5b58\u3001\u78c1\u76d8\u3001\u7f51\u7edc\u7b49\u4fe1\u606f\uff0c\u901a\u5e38\u53ef\u4ee5\u7528\u6765\u663e\u793a\u7cfb\u7edf\u7684\u6574\u4f53\u72b6\u51b5\u4ee5\u53ca\u68c0\u6d4b\u67d0\u4e2a\u65f6\u95f4\u7684\u5f02\u5e38\u884c\u4e3a</li> <li>\u65e5\u5fd7\u4e3a\u8fd0\u7ef4\u4eba\u5458\u63d0\u4f9b\u4e86\u4e00\u4e2a\u6570\u636e\u6765\u5206\u6790\u7cfb\u7edf\u7684\u4e00\u4e9b\u9519\u8bef\u884c\u4e3a\uff0c\u901a\u5e38\u5c06\u7cfb\u7edf\u3001\u670d\u52a1\u548c\u5e94\u7528\u7684\u65e5\u5fd7\u96c6\u4e2d\u6536\u96c6\u5728\u540c\u4e00\u4e2a\u6570\u636e\u5e93\u4e2d</li> <li>\u8ffd\u8e2a\u6216\u8005 APM\uff08\u5e94\u7528\u6027\u80fd\u76d1\u63a7Application Performance Monitoring\uff09 \u63d0\u4f9b\u4e86\u4e00\u4e2a\u66f4\u52a0\u8be6\u7ec6\u7684\u5e94\u7528\u89c6\u56fe\uff0c\u53ef\u4ee5\u5c06\u670d\u52a1\u6267\u884c\u7684\u6bcf\u4e00\u4e2a\u8bf7\u6c42\u548c\u6b65\u9aa4\u90fd\u8bb0\u5f55\u4e0b\u6765\uff08\u6bd4\u5982 HTTP \u8c03\u7528\u3001\u6570\u636e\u5e93\u67e5\u8be2\u7b49\uff09\uff0c\u901a\u8fc7\u8ffd\u8e2a\u8fd9\u4e9b\u6570\u636e\uff0c\u6211\u4eec\u53ef\u4ee5\u68c0\u6d4b\u5230\u670d\u52a1\u7684\u6027\u80fd\uff0c\u5e76\u76f8\u5e94\u5730\u6539\u8fdb\u6216\u4fee\u590d\u6211\u4eec\u7684\u7cfb\u7edf</li> </ul> <p></p> <p>\u672c\u6587\u6211\u4eec\u5c31\u5c06\u5728 <code>Kubernetes</code> \u96c6\u7fa4\u4e2d\u4f7f\u7528\u7531 <code>ElasticSearch</code>\u3001<code>Kibana</code>\u3001<code>Filebeat</code>\u3001<code>Metricbeat</code> \u548c <code>APM-Server</code> \u7ec4\u6210\u7684 <code>Elastic</code> \u6280\u672f\u6808\u6765\u76d1\u63a7\u7cfb\u7edf\u73af\u5883\u3002\u4e3a\u4e86\u66f4\u597d\u5730\u53bb\u4e86\u89e3\u8fd9\u4e9b\u7ec4\u4ef6\u7684\u914d\u7f6e\uff0c\u6211\u4eec\u8fd9\u91cc\u5c06\u91c7\u7528\u624b\u5199\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u7684\u65b9\u5f0f\u6765\u5b89\u88c5\u8fd9\u4e9b\u7ec4\u4ef6\uff0c\u5f53\u7136\u6211\u4eec\u4e5f\u53ef\u4ee5\u4f7f\u7528 Helm \u7b49\u5176\u4ed6\u5de5\u5177\u6765\u5feb\u901f\u5b89\u88c5\u914d\u7f6e\u3002</p> <p></p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u5b66\u4e60\u4e0b\u5982\u4f55\u4f7f\u7528 Elastic \u6280\u672f\u6784\u5efa Kubernetes \u76d1\u63a7\u6808\u3002\u6211\u4eec\u8fd9\u91cc\u7684\u8bd5\u9a8c\u73af\u5883\u662f <code>Kubernetes v1.16.6</code> \u7248\u672c\u7684\u96c6\u7fa4\uff0c\u4e3a\u65b9\u4fbf\u7ba1\u7406\uff0c\u6211\u4eec\u5c06\u6240\u6709\u7684\u8d44\u6e90\u5bf9\u8c61\u90fd\u90e8\u7f72\u5728\u4e00\u4e2a\u540d\u4e3a <code>elastic</code> \u7684\u547d\u540d\u7a7a\u95f4\u4e2d\uff1a</p> <pre><code>$ kubectl create ns elastic\nnamespace/elastic created\n</code></pre> <pre><code>$ kubectl get sc\nNAME                 PROVISIONER          AGE\nhostpath (default)   docker.io/hostpath   31d\n</code></pre>"},{"location":"chap11/20Elastic_Stack_Monitoring1/#1","title":"1. \u793a\u4f8b\u5e94\u7528","text":"<p>\u8fd9\u91cc\u6211\u4eec\u5148\u90e8\u7f72\u4e00\u4e2a\u4f7f\u7528 <code>SpringBoot</code> \u548c <code>MongoDB</code> \u5f00\u53d1\u7684\u793a\u4f8b\u5e94\u7528\u3002\u9996\u5148\u90e8\u7f72\u4e00\u4e2a <code>MongoDB</code> \u5e94\u7528\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a</p> <p><code>mongo.yml</code></p> <pre><code>---\napiVersion: v1\nkind: Service\nmetadata:\n  name: mongo\n  namespace: elastic\n  labels:\n    app: mongo\nspec:\n  ports:\n  - port: 27017\n    protocol: TCP\n  selector:\n    app: mongo\n---\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  namespace: elastic\n  name: mongo\n  labels:\n    app: mongo\nspec:\n  serviceName: \"mongo\"\n  selector:\n    matchLabels:\n      app: mongo\n  template:\n    metadata:\n      labels:\n        app: mongo\n    spec:\n      containers:\n      - name: mongo\n        image: mongo\n        ports:\n        - containerPort: 27017\n        volumeMounts:\n        - name: data\n          mountPath: /data/db\n  volumeClaimTemplates:\n  - metadata:\n      name: data\n    spec:\n      accessModes: [ \"ReadWriteOnce\" ]\n      storageClassName: hostpath  # \u4f7f\u7528\u652f\u6301 RWO \u7684 StorageClass\n      resources:\n        requests:\n          storage: 1Gi\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528\u4e86\u4e00\u4e2a\u540d\u4e3a <code>docker-desktop</code>: <code>hostpath</code>\u7684 <code>StorageClass</code> \u5bf9\u8c61\u6765\u81ea\u52a8\u521b\u5efa <code>PV</code>\uff0c\u53ef\u4ee5\u66ff\u6362\u6210\u81ea\u5df1\u96c6\u7fa4\u4e2d\u652f\u6301 <code>RWO</code> \u7684 <code>StorageClass</code> \u5bf9\u8c61\u5373\u53ef\u3002\u76f4\u63a5\u4f7f\u7528\u4e0a\u9762\u7684\u8d44\u6e90\u6e05\u5355\u521b\u5efa\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f mongo.yml\nservice/mongo created\nstatefulset.apps/mongo created\n\n$ kubectl get pods -n elastic -l app=mongo\nNAME      READY   STATUS    RESTARTS   AGE\nmongo-0   1/1     Running   0          3m44s\n</code></pre> <p>\u76f4\u5230 <code>Pod</code> \u53d8\u6210 <code>Running</code> \u72b6\u6001\u8bc1\u660e <code>mongodb</code> \u90e8\u7f72\u6210\u529f\u4e86\u3002\u63a5\u4e0b\u6765\u90e8\u7f72 <code>SpringBoot</code> \u7684 <code>API</code> \u5e94\u7528\uff0c\u8fd9\u91cc\u6211\u4eec\u901a\u8fc7 <code>NodePort</code> \u7c7b\u578b\u7684 <code>Service</code> \u670d\u52a1\u6765\u66b4\u9732\u8be5\u670d\u52a1\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a</p> <p><code>spring-boot-simple.yml</code></p> <pre><code>---\napiVersion: v1\nkind: Service\nmetadata:\n  namespace: elastic\n  name: spring-boot-simple\n  labels:\n    app: spring-boot-simple\nspec:\n  type: NodePort\n  ports:\n  - port: 8080\n    protocol: TCP\n  selector:\n    app: spring-boot-simple\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  namespace: elastic\n  name: spring-boot-simple\n  labels:\n    app: spring-boot-simple\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: spring-boot-simple\n  template:\n    metadata:\n      labels:\n        app: spring-boot-simple\n    spec:\n      containers:\n      - image: cnych/spring-boot-simple:0.0.1-SNAPSHOT\n        name: spring-boot-simple\n        env:\n        - name: SPRING_DATA_MONGODB_HOST  # \u6307\u5b9aMONGODB\u5730\u5740\n          value: mongo\n        ports:\n        - containerPort: 8080\n</code></pre> <p>\u540c\u6837\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u5e94\u7528\u7684\u5e94\u7528\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f spring-boot-simple.yaml\nservice/spring-boot-simple created\ndeployment.apps/spring-boot-simple created\n\n$ kubectl get pods -n elastic -l app=spring-boot-simple\nNAME                                  READY   STATUS    RESTARTS   AGE\nspring-boot-simple-6c4f87bf79-bbb7w   1/1     Running   0          3m40s\n\n$ kubectl get svc -n elastic -l app=spring-boot-simple\nNAME                 TYPE       CLUSTER-IP    EXTERNAL-IP   PORT(S)          AGE\nspring-boot-simple   NodePort   10.111.2.65   &lt;none&gt;        8080:30024/TCP   5m54s\n</code></pre> <p>\u5f53\u5e94\u7528\u90e8\u7f72\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7\u5730\u5740 <code>http://&lt;nodeip&gt;:30024</code> \u8bbf\u95ee\u5e94\u7528\uff0c\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\u8fdb\u884c\u7b80\u5355\u6d4b\u8bd5\uff1a</p> <pre><code>$ curl -X GET  http://127.0.0.1:30024/\nGreetings from Spring Boot!\n</code></pre> <p>\u53d1\u9001\u4e00\u4e2a POST \u8bf7\u6c42\uff1a</p> <pre><code>$ curl -X POST http://127.0.0.1:30024/message -d 'hello world'\n{\"id\":\"5f03e4da217e8e0001591daa\",\"message\":\"hello+world=\",\"postedAt\":\"2020-07-07T02:58:34.568+0000\"}\n</code></pre> <p>\u83b7\u53d6\u6240\u4ee5\u6d88\u606f\u6570\u636e\uff1a</p> <pre><code>$ curl -X GET http://127.0.0.1:30024/message\n[{\"id\":\"5f03e4da217e8e0001591daa\",\"message\":\"hello+world=\",\"postedAt\":\"2020-07-07T02:58:34.568+0000\"}]\n</code></pre>"},{"location":"chap11/20Elastic_Stack_Monitoring1/#2-elasticsearch","title":"2. ElasticSearch \u96c6\u7fa4","text":"<p>\u8981\u5efa\u7acb\u4e00\u4e2a Elastic \u6280\u672f\u7684\u76d1\u63a7\u6808\uff0c\u5f53\u7136\u9996\u5148\u6211\u4eec\u9700\u8981\u90e8\u7f72 <code>ElasticSearch</code>\uff0c\u5b83\u662f\u7528\u6765\u5b58\u50a8\u6240\u6709\u7684\u6307\u6807\u3001\u65e5\u5fd7\u548c\u8ffd\u8e2a\u7684\u6570\u636e\u5e93\uff0c\u8fd9\u91cc\u6211\u4eec\u901a\u8fc73\u4e2a\u4e0d\u540c\u89d2\u8272\u7684\u53ef\u6269\u5c55\u7684\u8282\u70b9\u7ec4\u6210\u4e00\u4e2a\u96c6\u7fa4\u3002</p>"},{"location":"chap11/20Elastic_Stack_Monitoring1/#2-1-elasticsearch","title":"2-1 \u5b89\u88c5 ElasticSearch \u4e3b\u8282\u70b9","text":"<p>\u8bbe\u7f6e\u96c6\u7fa4\u7684\u7b2c\u4e00\u4e2a\u8282\u70b9\u4e3a <code>Maste</code>r \u4e3b\u8282\u70b9\uff0c\u6765\u8d1f\u8d23\u63a7\u5236\u6574\u4e2a\u96c6\u7fa4\u3002\u9996\u5148\u521b\u5efa\u4e00\u4e2a <code>ConfigMap</code> \u5bf9\u8c61\uff0c\u7528\u6765\u63cf\u8ff0\u96c6\u7fa4\u7684\u4e00\u4e9b\u914d\u7f6e\u4fe1\u606f\uff0c\u4ee5\u65b9\u4fbf\u5c06 <code>ElasticSearch</code> \u7684\u4e3b\u8282\u70b9\u914d\u7f6e\u5230\u96c6\u7fa4\u4e2d\u5e76\u5f00\u542f\u5b89\u5168\u8ba4\u8bc1\u529f\u80fd\u3002\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a</p> <p><code>elasticsearch-master.configmap.yaml</code></p> <pre><code>---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  namespace: elastic\n  name: elasticsearch-master-config\n  labels:\n    app: elasticsearch\n    role: master\ndata:\n  elasticsearch.yml: |-\n    cluster.name: ${CLUSTER_NAME}\n    node.name: ${NODE_NAME}\n    discovery.seed_hosts: ${NODE_LIST}\n    cluster.initial_master_nodes: ${MASTER_NODES}\n\n    network.host: 0.0.0.0\n\n    node:\n      master: true\n      data: false\n      ingest: false\n\n    xpack.security.enabled: true\n    xpack.monitoring.collection.enabled: true\n---\n</code></pre> <p>\u7136\u540e\u521b\u5efa\u4e00\u4e2a <code>Service</code> \u5bf9\u8c61\uff0c\u5728 <code>Master</code> \u8282\u70b9\u4e0b\uff0c\u6211\u4eec\u53ea\u9700\u8981\u901a\u8fc7\u7528\u4e8e\u96c6\u7fa4\u901a\u4fe1\u7684 <code>9300</code> \u7aef\u53e3\u8fdb\u884c\u901a\u4fe1\u3002\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a</p> <p><code>elasticsearch-master.service.yaml</code></p> <pre><code>---\napiVersion: v1\nkind: Service\nmetadata:\n  namespace: elastic\n  name: elasticsearch-master\n  labels:\n    app: elasticsearch\n    role: master\nspec:\n  ports:\n  - port: 9300\n    name: transport\n  selector:\n    app: elasticsearch\n    role: master\n---\n</code></pre> <p>\u6700\u540e\u4f7f\u7528\u4e00\u4e2a Deployment \u5bf9\u8c61\u6765\u5b9a\u4e49 Master \u8282\u70b9\u5e94\u7528\uff0c\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a</p> <p><code>elasticsearch-master.deployment.yaml</code></p> <pre><code># elasticsearch-master.deployment.yaml\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  namespace: elastic\n  name: elasticsearch-master\n  labels:\n    app: elasticsearch\n    role: master\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: elasticsearch\n      role: master\n  template:\n    metadata:\n      labels:\n        app: elasticsearch\n        role: master\n    spec:\n      containers:\n      - name: elasticsearch-master\n        image: docker.elastic.co/elasticsearch/elasticsearch:7.8.0\n        env:\n        - name: CLUSTER_NAME\n          value: elasticsearch\n        - name: NODE_NAME\n          value: elasticsearch-master\n        - name: NODE_LIST\n          value: elasticsearch-master,elasticsearch-data,elasticsearch-client\n        - name: MASTER_NODES\n          value: elasticsearch-master\n        - name: \"ES_JAVA_OPTS\"\n          value: \"-Xms512m -Xmx512m\"\n        ports:\n        - containerPort: 9300\n          name: transport\n        volumeMounts:\n        - name: config\n          mountPath: /usr/share/elasticsearch/config/elasticsearch.yml\n          readOnly: true\n          subPath: elasticsearch.yml\n        - name: storage\n          mountPath: /data\n      volumes:\n      - name: config\n        configMap:\n          name: elasticsearch-master-config\n      - name: \"storage\"\n        emptyDir:\n          medium: \"\"\n---\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u76843\u4e2a\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>kubectl apply  -f elasticsearch-master.configmap.yaml\nkubectl apply  -f elasticsearch-master.service.yaml\nkubectl apply  -f elasticsearch-master.deployment.yaml\n\n$  kubectl get pods -n elastic -l app=elasticsearch\nNAME                                    READY   STATUS    RESTARTS   AGE\nelasticsearch-master-6f666cbbd-2xncp    1/1     Running   0          2d3h\n</code></pre> <p>\u76f4\u5230 Pod \u53d8\u6210 Running \u72b6\u6001\u5c31\u8868\u660e master \u8282\u70b9\u5b89\u88c5\u6210\u529f\u3002</p>"},{"location":"chap11/20Elastic_Stack_Monitoring1/#2-2-elasticsearch","title":"2-2 \u5b89\u88c5 ElasticSearch \u6570\u636e\u8282\u70b9","text":"<p>\u73b0\u5728\u6211\u4eec\u9700\u8981\u5b89\u88c5\u7684\u662f\u96c6\u7fa4\u7684\u6570\u636e\u8282\u70b9\uff0c\u5b83\u4e3b\u8981\u6765\u8d1f\u8d23\u96c6\u7fa4\u7684\u6570\u636e\u6258\u7ba1\u548c\u6267\u884c\u67e5\u8be2\u3002</p> <p>\u548c <code>master</code> \u8282\u70b9\u4e00\u6837\uff0c\u6211\u4eec\u4f7f\u7528\u4e00\u4e2a <code>ConfigMap</code>\u5bf9\u8c61\u6765\u914d\u7f6e\u6211\u4eec\u7684\u6570\u636e\u8282\u70b9\uff1a</p> <p><code>elasticsearch-data.configmap.yaml</code></p> <pre><code>---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  namespace: elastic\n  name: elasticsearch-data-config\n  labels:\n    app: elasticsearch\n    role: data\ndata:\n  elasticsearch.yml: |-\n    cluster.name: ${CLUSTER_NAME}\n    node.name: ${NODE_NAME}\n    discovery.seed_hosts: ${NODE_LIST}\n    cluster.initial_master_nodes: ${MASTER_NODES}\n\n    network.host: 0.0.0.0\n\n    node:\n      master: false\n      data: true\n      ingest: false\n\n    xpack.security.enabled: true\n    xpack.monitoring.collection.enabled: true\n---\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u548c\u4e0a\u9762\u7684 master \u914d\u7f6e\u975e\u5e38\u7c7b\u4f3c\uff0c\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f\u5c5e\u6027 <code>node.data=true</code>\u3002</p> <p>\u540c\u6837\u53ea\u9700\u8981\u901a\u8fc7 <code>9300</code> \u7aef\u53e3\u548c\u5176\u4ed6\u8282\u70b9\u8fdb\u884c\u901a\u4fe1\uff1a</p> <p><code>elasticsearch-data.service.yaml</code></p> <pre><code>---\napiVersion: v1\nkind: Service\nmetadata:\n  namespace: elastic\n  name: elasticsearch-data\n  labels:\n    app: elasticsearch\n    role: data\nspec:\n  ports:\n  - port: 9300\n    name: transport\n  selector:\n    app: elasticsearch\n    role: data\n---\n</code></pre> <p>\u6700\u540e\u521b\u5efa\u4e00\u4e2a <code>StatefulSet</code> \u7684\u63a7\u5236\u5668\uff0c\u56e0\u4e3a\u53ef\u80fd\u4f1a\u6709\u591a\u4e2a\u6570\u636e\u8282\u70b9\uff0c\u6bcf\u4e00\u4e2a\u8282\u70b9\u7684\u6570\u636e\u4e0d\u662f\u4e00\u6837\u7684\uff0c\u9700\u8981\u5355\u72ec\u5b58\u50a8\uff0c\u6240\u4ee5\u4e5f\u4f7f\u7528\u4e86\u4e00\u4e2a <code>volumeClaimTemplates</code> \u6765\u5206\u522b\u521b\u5efa\u5b58\u50a8\u5377\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a</p> <p><code>elasticsearch-data.statefulset.yaml</code></p> <pre><code>---\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  namespace: elastic\n  name: elasticsearch-data\n  labels:\n    app: elasticsearch\n    role: data\nspec:\n  serviceName: \"elasticsearch-data\"\n  selector:\n    matchLabels:\n      app: elasticsearch\n      role: data\n  template:\n    metadata:\n      labels:\n        app: elasticsearch\n        role: data\n    spec:\n      containers:\n      - name: elasticsearch-data\n        image: docker.elastic.co/elasticsearch/elasticsearch:7.8.0\n        env:\n        - name: CLUSTER_NAME\n          value: elasticsearch\n        - name: NODE_NAME\n          value: elasticsearch-data\n        - name: NODE_LIST\n          value: elasticsearch-master,elasticsearch-data,elasticsearch-client\n        - name: MASTER_NODES\n          value: elasticsearch-master\n        - name: \"ES_JAVA_OPTS\"\n          value: \"-Xms1024m -Xmx1024m\"\n        ports:\n        - containerPort: 9300\n          name: transport\n        volumeMounts:\n        - name: config\n          mountPath: /usr/share/elasticsearch/config/elasticsearch.yml\n          readOnly: true\n          subPath: elasticsearch.yml\n        - name: elasticsearch-data-persistent-storage\n          mountPath: /data/db\n      volumes:\n      - name: config\n        configMap:\n          name: elasticsearch-data-config\n  volumeClaimTemplates:\n  - metadata:\n      name: elasticsearch-data-persistent-storage\n    spec:\n      accessModes: [ \"ReadWriteOnce\" ]\n      storageClassName: hostpath\n      resources:\n        requests:\n          storage: 1Gi\n---\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>kubectl apply -f elasticsearch-data.configmap.yaml\nkubectl apply -f elasticsearch-data.service.yaml\nkubectl apply  -f elasticsearch-data.statefulset.yaml\n</code></pre> <p>\u76f4\u5230 Pod \u53d8\u6210 Running \u72b6\u6001\u8bc1\u660e\u8282\u70b9\u542f\u52a8\u6210\u529f\uff1a</p> <pre><code>$  kubectl get pods -n elastic -l app=elasticsearch\nNAME                                    READY   STATUS    RESTARTS   AGE\nelasticsearch-data-0                    1/1     Running   0          2d\nelasticsearch-master-6f666cbbd-2xncp    1/1     Running   0          2d3h\n</code></pre>"},{"location":"chap11/20Elastic_Stack_Monitoring1/#2-3-elasticsearch","title":"2-3 \u5b89\u88c5 ElasticSearch \u5ba2\u6237\u7aef\u8282\u70b9","text":"<p>\u6700\u540e\u6765\u5b89\u88c5\u914d\u7f6e ElasticSearch \u7684\u5ba2\u6237\u7aef\u8282\u70b9\uff0c\u8be5\u8282\u70b9\u4e3b\u8981\u8d1f\u8d23\u66b4\u9732\u4e00\u4e2a HTTP \u63a5\u53e3\u5c06\u67e5\u8be2\u6570\u636e\u4f20\u9012\u7ed9\u6570\u636e\u8282\u70b9\u83b7\u53d6\u6570\u636e\u3002</p> <p>\u540c\u6837\u4f7f\u7528\u4e00\u4e2a ConfigMap \u5bf9\u8c61\u6765\u914d\u7f6e\u8be5\u8282\u70b9\uff1a</p> <p><code>elasticsearch-client.configmap.yaml</code></p> <pre><code>---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  namespace: elastic\n  name: elasticsearch-client-config\n  labels:\n    app: elasticsearch\n    role: client\ndata:\n  elasticsearch.yml: |-\n    cluster.name: ${CLUSTER_NAME}\n    node.name: ${NODE_NAME}\n    discovery.seed_hosts: ${NODE_LIST}\n    cluster.initial_master_nodes: ${MASTER_NODES}\n\n    network.host: 0.0.0.0\n\n    node:\n      master: false\n      data: false\n      ingest: true\n\n    xpack.security.enabled: true\n    xpack.monitoring.collection.enabled: true\n---\n</code></pre> <p>\u5ba2\u6237\u7aef\u8282\u70b9\u9700\u8981\u66b4\u9732\u4e24\u4e2a\u7aef\u53e3\uff0c<code>9300</code>\u7aef\u53e3\u7528\u4e8e\u4e0e\u96c6\u7fa4\u7684\u5176\u4ed6\u8282\u70b9\u8fdb\u884c\u901a\u4fe1\uff0c<code>9200</code>\u7aef\u53e3\u7528\u4e8e <code>HTTP API</code>\u3002\u5bf9\u5e94\u7684 <code>Service</code> \u5bf9\u8c61\u5982\u4e0b\u6240\u793a\uff1a</p> <p><code>elasticsearch-client.service.yaml</code></p> <pre><code>---\napiVersion: v1\nkind: Service\nmetadata:\n  namespace: elastic\n  name: elasticsearch-client\n  labels:\n    app: elasticsearch\n    role: client\nspec:\n  ports:\n  - port: 9200\n    name: client\n  - port: 9300\n    name: transport\n  selector:\n    app: elasticsearch\n    role: client\n---\n</code></pre> <p>\u4f7f\u7528\u4e00\u4e2a Deployment \u5bf9\u8c61\u6765\u63cf\u8ff0\u5ba2\u6237\u7aef\u8282\u70b9\uff1a</p> <p><code>elasticsearch-client.deployment.yaml</code></p> <pre><code>---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  namespace: elastic\n  name: elasticsearch-client\n  labels:\n    app: elasticsearch\n    role: client\nspec:\n  selector:\n    matchLabels:\n      app: elasticsearch\n      role: client\n  template:\n    metadata:\n      labels:\n        app: elasticsearch\n        role: client\n    spec:\n      containers:\n      - name: elasticsearch-client\n        image: docker.elastic.co/elasticsearch/elasticsearch:7.8.0\n        env:\n        - name: CLUSTER_NAME\n          value: elasticsearch\n        - name: NODE_NAME\n          value: elasticsearch-client\n        - name: NODE_LIST\n          value: elasticsearch-master,elasticsearch-data,elasticsearch-client\n        - name: MASTER_NODES\n          value: elasticsearch-master\n        - name: \"ES_JAVA_OPTS\"\n          value: \"-Xms256m -Xmx256m\"\n        ports:\n        - containerPort: 9200\n          name: client\n        - containerPort: 9300\n          name: transport\n        volumeMounts:\n        - name: config\n          mountPath: /usr/share/elasticsearch/config/elasticsearch.yml\n          readOnly: true\n          subPath: elasticsearch.yml\n        - name: storage\n          mountPath: /data\n      volumes:\n      - name: config\n        configMap:\n          name: elasticsearch-client-config\n      - name: \"storage\"\n        emptyDir:\n          medium: \"\"\n---\n</code></pre> <p>\u540c\u6837\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u6765\u90e8\u7f72 client \u8282\u70b9\uff1a</p> <pre><code>kubectl apply  -f elasticsearch-client.configmap.yaml\nkubectl apply  -f elasticsearch-client.service.yaml\nkubectl apply  -f elasticsearch-client.deployment.yaml\n</code></pre> <p>\u76f4\u5230\u6240\u6709\u7684\u8282\u70b9\u90fd\u90e8\u7f72\u6210\u529f\u540e\u8bc1\u660e\u96c6\u7fa4\u5b89\u88c5\u6210\u529f\uff1a</p> <pre><code>$  kubectl get pods -n elastic -l app=elasticsearch\nNAME                                    READY   STATUS    RESTARTS   AGE\nelasticsearch-client-788bffcc98-k8s6h   1/1     Running   0          2d\nelasticsearch-data-0                    1/1     Running   0          2d\nelasticsearch-master-6f666cbbd-2xncp    1/1     Running   0          2d3h\n</code></pre> <p>\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u6240\u793a\u7684\u547d\u4ee4\u6765\u67e5\u770b\u96c6\u7fa4\u7684\u72b6\u6001\u53d8\u5316\uff1a</p> <pre><code>$ kubectl logs -f -n elastic \\\n&gt;   $(kubectl get pods -n elastic | grep elasticsearch-master | sed -n 1p | awk '{print $1}') \\\n&gt;   | grep \"Cluster health status changed from\"\n{\"type\": \"server\", \"timestamp\": \"2020-07-07T06:21:26,580Z\", \"level\": \"INFO\", \"component\": \"o.e.c.r.a.AllocationService\", \"cluster.name\": \"elasticsearch\", \"node.name\": \"elasticsearch-master\", \"message\": \"Cluster health status changed from [YELLOW] to [GREEN] (reason: [shards started [[.monitoring-es-7-2020.07.07][0]]]).\", \"cluster.uuid\": \"9M92bFTATjytwhDV33KRLA\", \"node.id\": \"_Ih4rde0QViBkkoCXOkH-w\"  }\n</code></pre>"},{"location":"chap11/20Elastic_Stack_Monitoring1/#2-4","title":"2-4 \u751f\u6210\u5bc6\u7801","text":"<p>\u6211\u4eec\u542f\u7528\u4e86 <code>xpack</code> \u5b89\u5168\u6a21\u5757\u6765\u4fdd\u62a4\u6211\u4eec\u7684\u96c6\u7fa4\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u4e00\u4e2a\u521d\u59cb\u5316\u7684\u5bc6\u7801\u3002\u6211\u4eec\u53ef\u4ee5\u6267\u884c\u5982\u4e0b\u6240\u793a\u7684\u547d\u4ee4\uff0c\u5728\u5ba2\u6237\u7aef\u8282\u70b9\u5bb9\u5668\u5185\u8fd0\u884c <code>bin/elasticsearch-setup-passwords</code> \u547d\u4ee4\u6765\u751f\u6210\u9ed8\u8ba4\u7684\u7528\u6237\u540d\u548c\u5bc6\u7801\uff1a</p> <pre><code>$ kubectl exec $(kubectl get pods -n elastic | grep elasticsearch-client | sed -n 1p | awk '{print\n $1}') \\\n&gt;     -n elastic \\\n&gt;     -- bin/elasticsearch-setup-passwords auto -b\nChanged password for user apm_system\nPASSWORD apm_system = rsp9mVwMDVC86cCt7Pfs\n\nChanged password for user kibana_system\nPASSWORD kibana_system = dRgI7bBbhO1aJETJKPrX\n\nChanged password for user kibana\nPASSWORD kibana = dRgI7bBbhO1aJETJKPrX\n\nChanged password for user logstash_system\nPASSWORD logstash_system = S3f5ztMGTKMSsMqeEL3T\n\nChanged password for user beats_system\nPASSWORD beats_system = Y15AQ5Rh4N0Wj9cFWAh1\n\nChanged password for user remote_monitoring_user\nPASSWORD remote_monitoring_user = pcvZhxfhrAncUmyBSdqz\n\nChanged password for user elastic\nPASSWORD elastic = fhuoUCY5pXAtnYUi5d5d\n</code></pre> <p>\u6ce8\u610f\u9700\u8981\u5c06 <code>elastic</code> \u7528\u6237\u540d\u548c\u5bc6\u7801\u4e5f\u6dfb\u52a0\u5230 <code>Kubernetes</code> \u7684 <code>Secret</code> \u5bf9\u8c61\u4e2d\uff1a</p> <pre><code>kubectl create secret generic elasticsearch-pw-elastic \\\n    -n elastic \\\n    --from-literal password=fhuoUCY5pXAtnYUi5d5d\nsecret/elasticsearch-pw-elastic created\n</code></pre>"},{"location":"chap11/20Elastic_Stack_Monitoring1/#3-kibana","title":"3. Kibana","text":"<p><code>ElasticSearch</code> \u96c6\u7fa4\u5b89\u88c5\u5b8c\u6210\u540e\uff0c\u63a5\u7740\u6211\u4eec\u53ef\u4ee5\u6765\u90e8\u7f72 <code>Kibana</code>\uff0c\u8fd9\u662f <code>ElasticSearch</code> \u7684\u6570\u636e\u53ef\u89c6\u5316\u5de5\u5177\uff0c\u5b83\u63d0\u4f9b\u4e86\u7ba1\u7406 <code>ElasticSearch</code> \u96c6\u7fa4\u548c\u53ef\u89c6\u5316\u6570\u636e\u7684\u5404\u79cd\u529f\u80fd\u3002</p> <p>\u540c\u6837\u9996\u5148\u6211\u4eec\u4f7f\u7528 <code>ConfigMap</code> \u5bf9\u8c61\u6765\u63d0\u4f9b\u4e00\u4e2a\u6587\u4ef6\u6587\u4ef6\uff0c\u5176\u4e2d\u5305\u62ec\u5bf9 <code>ElasticSearch</code> \u7684\u8bbf\u95ee\uff08\u4e3b\u673a\u3001\u7528\u6237\u540d\u548c\u5bc6\u7801\uff09\uff0c\u8fd9\u4e9b\u90fd\u662f\u901a\u8fc7\u73af\u5883\u53d8\u91cf\u914d\u7f6e\u7684\u3002\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a</p> <p><code>kibana.configmap.yaml</code></p> <pre><code>---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  namespace: elastic\n  name: kibana-config\n  labels:\n    app: kibana\ndata:\n  kibana.yml: |-\n    server.host: 0.0.0.0\n\n    elasticsearch:\n      hosts: ${ELASTICSEARCH_HOSTS}\n      username: ${ELASTICSEARCH_USER}\n      password: ${ELASTICSEARCH_PASSWORD}\n---\n</code></pre> <p>\u7136\u540e\u901a\u8fc7\u4e00\u4e2a <code>ClusterIP</code> \u7c7b\u578b\u7684\u670d\u52a1\u6765\u66b4\u9732 <code>Kibana</code> \u670d\u52a1\uff1a</p> <p><code>kibana.service.yaml</code></p> <pre><code>---\napiVersion: v1\nkind: Service\nmetadata:\n  namespace: elastic\n  name: kibana\n  labels:\n    app: kibana\nspec:\n  type: ClusterIP\n  ports:\n  - port: 5601\n    name: webinterface\n  selector:\n    app: kibana\n---\n</code></pre> <p>\u6700\u540e\u901a\u8fc7 <code>Deployment</code>\u6765\u90e8\u7f72 <code>Kibana</code> \u670d\u52a1\uff0c\u7531\u4e8e\u9700\u8981\u901a\u8fc7\u73af\u5883\u53d8\u91cf\u63d0\u4f9b\u5bc6\u7801\uff0c\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528\u4e0a\u9762\u521b\u5efa\u7684 <code>Secret</code> \u5bf9\u8c61\u6765\u5f15\u7528\uff1a</p> <pre><code>---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  namespace: elastic\n  name: kibana\n  labels:\n    app: kibana\nspec:\n  selector:\n    matchLabels:\n      app: kibana\n  template:\n    metadata:\n      labels:\n        app: kibana\n    spec:\n      containers:\n      - name: kibana\n        image: docker.elastic.co/kibana/kibana:7.8.0\n        ports:\n        - containerPort: 5601\n          name: webinterface\n        env:\n        - name: ELASTICSEARCH_HOSTS\n          value: \"http://elasticsearch-client.elastic.svc.cluster.local:9200\"\n        - name: ELASTICSEARCH_USER\n          value: \"elastic\"\n        - name: ELASTICSEARCH_PASSWORD\n          valueFrom:\n            secretKeyRef:\n              name: elasticsearch-pw-elastic\n              key: password\n        volumeMounts:\n        - name: config\n          mountPath: /usr/share/kibana/config/kibana.yml\n          readOnly: true\n          subPath: kibana.yml\n      volumes:\n      - name: config\n        configMap:\n          name: kibana-config\n---\n</code></pre> <p>\u540c\u6837\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u6e05\u5355\u5373\u53ef\u90e8\u7f72\uff1a</p> <pre><code>kubectl apply  -f kibana.configmap.yaml\nkubectl apply  -f kibana.service.yaml\nkubectl apply  -f kibana.deployment.yaml\n</code></pre> <pre><code>$ kubectl get svc kibana -n elastic\nNAME     TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE\nkibana   ClusterIP   10.106.225.109   &lt;none&gt;        5601/TCP   2d\n</code></pre> <pre><code>$  kubectl get pods -n elastic \nNAME                                    READY   STATUS    RESTARTS   AGE\nelasticsearch-client-788bffcc98-k8s6h   1/1     Running   0          35m\nelasticsearch-data-0                    1/1     Running   0          37m\nelasticsearch-master-6f666cbbd-2xncp    1/1     Running   0          3h34m\nkibana-6b9947fccb-x85tz                 1/1     Running   0          22m\nmongo-0                                 1/1     Running   0          4h13m\nspring-boot-simple-6c4f87bf79-bbb7w     1/1     Running   0          4h5m\n</code></pre> <pre><code>$ kubectl get svc -n elastic\nNAME                   TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE\nelasticsearch-client   ClusterIP   10.101.156.167   &lt;none&gt;        9200/TCP,9300/TCP   36m\nelasticsearch-data     ClusterIP   10.97.89.186     &lt;none&gt;        9300/TCP            45m\nelasticsearch-master   ClusterIP   10.97.118.198    &lt;none&gt;        9300/TCP            3h51m\nkibana                 ClusterIP   10.106.225.109   &lt;none&gt;        5601/TCP            20m\nmongo                  ClusterIP   10.107.101.7     &lt;none&gt;        27017/TCP           4h13m\nspring-boot-simple     NodePort    10.111.2.65      &lt;none&gt;        8080:30024/TCP      4h5m\n</code></pre> <p>\u90e8\u7f72\u6210\u529f\u540e\uff0c\u53ef\u4ee5\u901a\u8fc7\u67e5\u770b Pod \u7684\u65e5\u5fd7\u6765\u4e86\u89e3 Kibana \u7684\u72b6\u6001\uff1a</p> <pre><code>$ kubectl logs -f -n elastic $(kubectl get pods -n elastic | grep kibana | sed -n 1p | awk '{print\n $1}') \\\n&gt;      | grep \"Status changed from yellow to green\"\n{\"type\":\"log\",\"@timestamp\":\"2020-07-07T06:55:07Z\",\"tags\":[\"status\",\"plugin:elasticsearch@7.8.0\",\"info\"],\"pid\":6,\"state\":\"green\",\"me\nssage\":\"Status changed from yellow to green - Ready\",\"prevState\":\"yellow\",\"prevMsg\":\"Waiting for Elasticsearch\"}\n</code></pre> <p>\u5f53\u72b6\u6001\u53d8\u6210 <code>green</code> \u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7 <code>port-forward</code> \u7684\u65b9\u5f0f\u8bbf\u95ee\u7aef\u53e3 <code>5601</code> \u53bb\u6d4f\u89c8\u5668\u4e2d\u8bbf\u95ee Kibana \u670d\u52a1\u4e86\uff1a</p> <pre><code>kubectl port-forward svc/kibana -n elastic 5601:5601\nelastic\nfhuoUCY5pXAtnYUi5d5d\n</code></pre> <p>\u5982\u4e0b\u56fe\u6240\u793a\uff0c\u4f7f\u7528\u4e0a\u9762\u6211\u4eec\u521b\u5efa\u7684 <code>Secret</code> \u5bf9\u8c61\u7684 <code>elastic</code> \u7528\u6237\u548c\u751f\u6210\u7684\u5bc6\u7801\u5373\u53ef\u767b\u5f55\uff1a</p> <p></p> <p>\u767b\u5f55\u6210\u529f\u540e\u4f1a\u81ea\u52a8\u8df3\u8f6c\u5230 Kibana \u9996\u9875\uff1a</p> <p></p> <p>\u540c\u6837\u4e5f\u53ef\u4ee5\u81ea\u5df1\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u8d85\u7ea7\u7528\u6237\uff0c<code>Management \u2192 Stack Management \u2192 Create User</code>\uff1a</p> <p></p> <p>\u4f7f\u7528\u65b0\u7684\u7528\u6237\u540d\u548c\u5bc6\u7801\uff0c\u9009\u62e9 <code>superuser</code> \u8fd9\u4e2a\u89d2\u8272\u6765\u521b\u5efa\u65b0\u7684\u7528\u6237\uff1a</p> <ul> <li>admin</li> <li>admin12</li> </ul> <p></p> <p>\u521b\u5efa\u6210\u529f\u540e\u5c31\u53ef\u4ee5\u4f7f\u7528\u4e0a\u9762\u65b0\u5efa\u7684\u7528\u6237\u767b\u5f55 Kibana\uff0c\u6700\u540e\u8fd8\u53ef\u4ee5\u901a\u8fc7 <code>Management \u2192 Stack Monitoring</code> \u9875\u9762\u67e5\u770b\u6574\u4e2a\u96c6\u7fa4\u7684\u5065\u5eb7\u72b6\u6001\uff1a</p> <p></p> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u5b89\u88c5\u6210\u529f\u4e86 <code>ElasticSearch</code> \u4e0e <code>Kibana</code>\uff0c\u5b83\u4eec\u5c06\u4e3a\u6211\u4eec\u6765\u5b58\u50a8\u548c\u53ef\u89c6\u5316\u6211\u4eec\u7684\u5e94\u7528\u6570\u636e\uff08\u76d1\u63a7\u6307\u6807\u3001\u65e5\u5fd7\u548c\u8ffd\u8e2a\uff09\u670d\u52a1\u3002</p> <p>\u5728\u4e0b\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u4eec\u5c06\u6765\u5b66\u4e60\u5982\u4f55\u5b89\u88c5\u548c\u914d\u7f6e <code>Metricbea</code>t\uff0c\u901a\u8fc7 <code>Elastic Metribeat</code> \u6765\u6536\u96c6\u6307\u6807\u76d1\u63a7 <code>Kubernetes</code> \u96c6\u7fa4\u3002</p>"},{"location":"chap11/21Elastic_Stack_Monitoring2/","title":"\u7b2c\u4e8c\u8282 \u4f7f\u7528 Elastic Stack \u2014 Metricbeat \u76d1\u63a7\u5b89\u88c5","text":"<p>Metricbeat \u662f\u4e00\u4e2a\u670d\u52a1\u5668\u4e0a\u7684\u8f7b\u91cf\u7ea7\u91c7\u96c6\u5668\uff0c\u7528\u4e8e\u5b9a\u671f\u6536\u96c6\u4e3b\u673a\u548c\u670d\u52a1\u7684\u76d1\u63a7\u6307\u6807\u3002\u8fd9\u4e5f\u662f\u6211\u4eec\u6784\u5efa Kubernetes \u5168\u6808\u76d1\u63a7\u7684\u7b2c\u4e00\u4e2a\u90e8\u5206\u3002</p> <p>Metribeat \u9ed8\u8ba4\u91c7\u96c6\u7cfb\u7edf\u7684\u6307\u6807\uff0c\u4f46\u662f\u4e5f\u5305\u542b\u4e86\u5927\u91cf\u7684\u5176\u4ed6\u6a21\u5757\u6765\u91c7\u96c6\u6709\u5173\u670d\u52a1\u7684\u6307\u6807\uff0c\u6bd4\u5982 Nginx\u3001Kafka\u3001MySQL\u3001Redis \u7b49\u7b49\uff0c\u652f\u6301\u7684\u5b8c\u6574\u6a21\u5757\u53ef\u4ee5\u5728 Elastic \u5b98\u65b9\u7f51\u7ad9\u4e0a\u67e5\u770b\u5230 https://www.elastic.co/guide/en/beats/metricbeat/current/metricbeat-modules.html\u3002</p>"},{"location":"chap11/21Elastic_Stack_Monitoring2/#1kube-state-metrics","title":"1\u3001<code>kube-state-metrics</code>","text":"<p>\u9996\u5148\uff0c\u6211\u4eec\u9700\u8981\u5b89\u88c5 <code>kube-state-metrics</code>\uff0c\u8fd9\u4e2a\u7ec4\u4ef6\u662f\u4e00\u4e2a\u76d1\u542c <code>Kubernetes API</code> \u7684\u670d\u52a1\uff0c\u53ef\u4ee5\u66b4\u9732\u6bcf\u4e2a\u8d44\u6e90\u5bf9\u8c61\u72b6\u6001\u7684\u76f8\u5173\u6307\u6807\u6570\u636e\u3002</p> <p>\u8981\u5b89\u88c5 <code>kube-state-metric</code>s \u4e5f\u975e\u5e38\u7b80\u5355\uff0c\u5728\u5bf9\u5e94\u7684 <code>GitHub</code>\u4ed3\u5e93\u4e0b\u5c31\u6709\u5bf9\u5e94\u7684\u5b89\u88c5\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff1a</p> <pre><code>$ git clone https://github.com/kubernetes/kube-state-metrics.git\n\n$ cd kube-state-metrics\n# \u6267\u884c\u5b89\u88c5\u547d\u4ee4\n$ kubectl apply -f examples/standard/\nclusterrolebinding.rbac.authorization.k8s.io/kube-state-metrics configured\nclusterrole.rbac.authorization.k8s.io/kube-state-metrics configured\ndeployment.apps/kube-state-metrics configured\nserviceaccount/kube-state-metrics configured\nservice/kube-state-metrics configured\n</code></pre> <pre><code>kubectl get pods -n kube-system -l app.kubernetes.io/name=kube-state-metricsNAME                                  READY   STATUS    RESTARTS   AGE\nkube-state-metrics-6d7449fc78-ndgdd   1/1     Running   0          98s\n</code></pre> <p>\u5f53 Pod \u53d8\u6210 Running \u72b6\u6001\u540e\u8bc1\u660e\u5b89\u88c5\u6210\u529f\u3002</p>"},{"location":"chap11/21Elastic_Stack_Monitoring2/#2metricbeat","title":"2\u3001Metricbeat","text":"<p>\u7531\u4e8e\u6211\u4eec\u9700\u8981\u76d1\u63a7\u6240\u6709\u7684\u8282\u70b9\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u4f7f\u7528\u4e00\u4e2a <code>DaemonSet</code> \u63a7\u5236\u5668\u6765\u5b89\u88c5 <code>Metricbeat</code>\u3002</p> <p>\u9996\u5148\uff0c\u4f7f\u7528\u4e00\u4e2a <code>ConfigMap</code> \u6765\u914d\u7f6e <code>Metricbeat</code>\uff0c\u7136\u540e\u901a\u8fc7 <code>Volume</code> \u5c06\u8be5\u5bf9\u8c61\u6302\u8f7d\u5230\u5bb9\u5668\u4e2d\u7684 <code>/etc/metricbeat.yaml</code>\u4e2d\u53bb\u3002\u914d\u7f6e\u6587\u4ef6\u4e2d\u5305\u542b\u4e86 <code>ElasticSearch</code> \u7684\u5730\u5740\u3001\u7528\u6237\u540d\u548c\u5bc6\u7801\uff0c\u4ee5\u53ca <code>Kibana</code> \u914d\u7f6e\uff0c\u6211\u4eec\u8981\u542f\u7528\u7684\u6a21\u5757\u4e0e\u6293\u53d6\u9891\u7387\u7b49\u4fe1\u606f\u3002</p> <p><code>metricbeat.settings.configmap.yml</code></p> <pre><code>---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  namespace: elastic\n  name: metricbeat-config\n  labels:\n    app: metricbeat\ndata:\n  metricbeat.yml: |-\n\n    # \u6a21\u5757\u914d\u7f6e\n    metricbeat.modules:\n    - module: system\n      period: ${PERIOD}\n      metricsets: [\"cpu\", \"load\", \"memory\", \"network\", \"process\", \"process_summary\", \"core\", \"diskio\", \"socket\"]\n      processes: ['.*']\n      process.include_top_n:\n        by_cpu: 5      # \u6839\u636e CPU \u8ba1\u7b97\u7684\u524d5\u4e2a\u8fdb\u7a0b\n        by_memory: 5   # \u6839\u636e\u5185\u5b58\u8ba1\u7b97\u7684\u524d5\u4e2a\u8fdb\u7a0b\n\n    - module: system\n      period: ${PERIOD}\n      metricsets:  [\"filesystem\", \"fsstat\"]\n      processors:\n      - drop_event.when.regexp:\n          system.filesystem.mount_point: '^/(sys|cgroup|proc|dev|etc|host|lib)($|/)'\n\n    - module: docker\n      period: ${PERIOD}\n      hosts: [\"unix:///var/run/docker.sock\"]\n      metricsets: [\"container\", \"cpu\", \"diskio\", \"healthcheck\", \"info\", \"memory\", \"network\"]\n\n    - module: kubernetes  # \u6293\u53d6 kubelet \u76d1\u63a7\u6307\u6807\n      period: ${PERIOD}\n      node: ${NODE_NAME}\n      hosts: [\"https://${NODE_NAME}:10250\"]\n      metricsets: [\"node\", \"system\", \"pod\", \"container\", \"volume\"]\n      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n      ssl.verification_mode: \"none\"\n\n    - module: kubernetes  # \u6293\u53d6 kube-state-metrics \u6570\u636e\n      period: ${PERIOD}\n      node: ${NODE_NAME}\n      metricsets: [\"state_node\", \"state_deployment\", \"state_replicaset\", \"state_pod\", \"state_container\"]\n      hosts: [\"kube-state-metrics.kube-system.svc.cluster.local:8080\"]\n\n    # \u6839\u636e k8s deployment \u914d\u7f6e\u5177\u4f53\u7684\u670d\u52a1\u6a21\u5757\n    metricbeat.autodiscover:\n      providers:\n      - type: kubernetes\n        node: ${NODE_NAME}\n        templates:\n        - condition.equals:\n            kubernetes.labels.app: mongo\n          config:\n          - module: mongodb\n            period: ${PERIOD}\n            hosts: [\"mongo.elastic:27017\"]\n            metricsets: [\"dbstats\", \"status\", \"collstats\", \"metrics\", \"replstatus\"]\n\n    # ElasticSearch \u8fde\u63a5\u914d\u7f6e\n    output.elasticsearch:\n      hosts: ['${ELASTICSEARCH_HOST:elasticsearch}:${ELASTICSEARCH_PORT:9200}']\n      username: ${ELASTICSEARCH_USERNAME}\n      password: ${ELASTICSEARCH_PASSWORD}\n\n    # \u8fde\u63a5\u5230 Kibana\n    setup.kibana:\n      host: '${KIBANA_HOST:kibana}:${KIBANA_PORT:5601}'\n\n    # \u5bfc\u5165\u5df2\u7ecf\u5b58\u5728\u7684 Dashboard\n    setup.dashboards.enabled: true\n\n    # \u914d\u7f6e indice \u751f\u547d\u5468\u671f\n    setup.ilm:\n      policy_file: /etc/indice-lifecycle.json\n---\n</code></pre> <p><code>ElasticSearch</code> \u7684 <code>indice</code> \u751f\u547d\u5468\u671f\u8868\u793a\u4e00\u7ec4\u89c4\u5219\uff0c\u53ef\u4ee5\u6839\u636e<code>indice</code> \u7684\u5927\u5c0f\u6216\u8005\u65f6\u957f\u5e94\u7528\u5230\u4f60\u7684 <code>indice</code> \u4e0a\u3002\u6bd4\u5982\u53ef\u4ee5\u6bcf\u5929\u6216\u8005\u6bcf\u6b21\u8d85\u8fc7 <code>1GB</code> \u5927\u5c0f\u7684\u65f6\u5019\u5bf9 <code>indice</code> \u8fdb\u884c\u8f6e\u8f6c\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u6839\u636e\u89c4\u5219\u914d\u7f6e\u4e0d\u540c\u7684\u9636\u6bb5\u3002</p> <p>\u7531\u4e8e\u76d1\u63a7\u4f1a\u4ea7\u751f\u5927\u91cf\u7684\u6570\u636e\uff0c\u5f88\u6709\u53ef\u80fd\u4e00\u5929\u5c31\u8d85\u8fc7\u51e0\u5341G\u7684\u6570\u636e\uff0c\u6240\u4ee5\u4e3a\u4e86\u9632\u6b62\u5927\u91cf\u7684\u6570\u636e\u5b58\u50a8\uff0c\u6211\u4eec\u53ef\u4ee5\u5229\u7528 <code>indice</code> \u7684\u751f\u547d\u5468\u671f\u6765\u914d\u7f6e\u6570\u636e\u4fdd\u7559\uff0c\u8fd9\u4e2a\u5728 <code>Prometheus</code>\u4e2d\u4e5f\u6709\u7c7b\u4f3c\u7684\u64cd\u4f5c\u3002</p> <p>\u5982\u4e0b\u6240\u793a\u7684\u6587\u4ef6\u4e2d\uff0c\u6211\u4eec\u914d\u7f6e\u6210\u6bcf\u5929\u6216\u6bcf\u6b21\u8d85\u8fc7<code>1GB</code>\u7684\u65f6\u5019\u5c31\u5bf9 <code>indice</code>\u8fdb\u884c\u8f6e\u8f6c\uff0c\u5e76\u5220\u9664\u6240\u6709\u8d85\u8fc710\u5929\u7684 indice \u6587\u4ef6\uff0c\u6211\u4eec\u8fd9\u91cc\u53ea\u4fdd\u755910\u5929\u76d1\u63a7\u6570\u636e\u5b8c\u5168\u8db3\u591f\u4e86\u3002</p> <p><code>metricbeat.indice-lifecycle.configmap.yml</code></p> <pre><code>---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  namespace: elastic\n  name: metricbeat-indice-lifecycle\n  labels:\n    app: metricbeat\ndata:\n  indice-lifecycle.json: |-\n    {\n      \"policy\": {\n        \"phases\": {\n          \"hot\": {\n            \"actions\": {\n              \"rollover\": {\n                \"max_size\": \"1GB\" ,\n                \"max_age\": \"1d\"\n              }\n            }\n          },\n          \"delete\": {\n            \"min_age\": \"10d\",\n            \"actions\": {\n              \"delete\": {}\n            }\n          }\n        }\n      }\n    }\n---\n</code></pre> <p>\u63a5\u4e0b\u6765\u5c31\u53ef\u4ee5\u6765\u7f16\u5199 <code>Metricbeat</code> \u7684 <code>DaemonSet</code> \u8d44\u6e90\u5bf9\u8c61\u6e05\u5355\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <p><code>metricbeat.daemonset.yml</code></p> <pre><code>---\napiVersion: apps/v1\nkind: DaemonSet\nmetadata:\n  namespace: elastic\n  name: metricbeat\n  labels:\n    app: metricbeat\nspec:\n  selector:\n    matchLabels:\n      app: metricbeat\n  template:\n    metadata:\n      labels:\n        app: metricbeat\n    spec:\n      serviceAccountName: metricbeat\n      terminationGracePeriodSeconds: 30\n      hostNetwork: true\n      dnsPolicy: ClusterFirstWithHostNet\n      containers:\n      - name: metricbeat\n        image: docker.elastic.co/beats/metricbeat:7.8.0\n        args: [\n          \"-c\", \"/etc/metricbeat.yml\",\n          \"-e\", \"-system.hostfs=/hostfs\"\n        ]\n        env:\n        - name: ELASTICSEARCH_HOST\n          value: elasticsearch-client.elastic.svc.cluster.local\n        - name: ELASTICSEARCH_PORT\n          value: \"9200\"\n        - name: ELASTICSEARCH_USERNAME\n          value: elastic\n        - name: ELASTICSEARCH_PASSWORD\n          valueFrom:\n            secretKeyRef:\n              name: elasticsearch-pw-elastic\n              key: password\n        - name: KIBANA_HOST\n          value: kibana.elastic.svc.cluster.local\n        - name: KIBANA_PORT\n          value: \"5601\"\n        - name: NODE_NAME\n          valueFrom:\n            fieldRef:\n              fieldPath: spec.nodeName\n        - name: PERIOD\n          value: \"10s\"\n        securityContext:\n          runAsUser: 0\n        resources:\n          limits:\n            memory: 200Mi\n          requests:\n            cpu: 100m\n            memory: 100Mi\n        volumeMounts:\n        - name: config\n          mountPath: /etc/metricbeat.yml\n          readOnly: true\n          subPath: metricbeat.yml\n        - name: indice-lifecycle\n          mountPath: /etc/indice-lifecycle.json\n          readOnly: true\n          subPath: indice-lifecycle.json\n        - name: dockersock\n          mountPath: /var/run/docker.sock\n        - name: proc\n          mountPath: /hostfs/proc\n          readOnly: true\n        - name: cgroup\n          mountPath: /hostfs/sys/fs/cgroup\n          readOnly: true\n      volumes:\n      - name: proc\n        hostPath:\n          path: /proc\n      - name: cgroup\n        hostPath:\n          path: /sys/fs/cgroup\n      - name: dockersock\n        hostPath:\n          path: /var/run/docker.sock\n      - name: config\n        configMap:\n          defaultMode: 0600\n          name: metricbeat-config\n      - name: indice-lifecycle\n        configMap:\n          defaultMode: 0600\n          name: metricbeat-indice-lifecycle\n      - name: data\n        hostPath:\n          path: /var/lib/metricbeat-data\n          type: DirectoryOrCreate\n---\n</code></pre> <p>\u9700\u8981\u6ce8\u610f\u7684\u5c06\u4e0a\u9762\u7684\u4e24\u4e2a <code>ConfigMap</code> \u6302\u8f7d\u5230\u5bb9\u5668\u4e2d\u53bb\uff0c\u7531\u4e8e\u9700\u8981 <code>Metricbeat</code> \u83b7\u53d6\u5bbf\u4e3b\u673a\u7684\u76f8\u5173\u4fe1\u606f\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u4e5f\u6302\u8f7d\u4e86\u4e00\u4e9b\u5bbf\u4e3b\u673a\u7684\u6587\u4ef6\u5230\u5bb9\u5668\u4e2d\u53bb\uff0c\u6bd4\u5982 <code>proc</code> \u76ee\u5f55\uff0c<code>cgroup</code> \u76ee\u5f55\u4ee5\u53ca <code>dockersock</code> \u6587\u4ef6\u3002</p> <p>\u7531\u4e8e <code>Metricbeat</code> \u9700\u8981\u53bb\u83b7\u53d6 <code>Kubernetes</code> \u96c6\u7fa4\u7684\u8d44\u6e90\u5bf9\u8c61\u4fe1\u606f\uff0c\u6240\u4ee5\u540c\u6837\u9700\u8981\u5bf9\u5e94\u7684 <code>RBAC</code> \u6743\u9650\u58f0\u660e\uff0c\u7531\u4e8e\u662f\u5168\u5c40\u4f5c\u7528\u57df\u7684\uff0c\u6240\u4ee5\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528 <code>ClusterRole</code> \u8fdb\u884c\u58f0\u660e\uff1a</p> <p><code>metricbeat.permissions.yml</code></p> <pre><code>---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: ClusterRoleBinding\nmetadata:\n  name: metricbeat\nsubjects:\n- kind: ServiceAccount\n  name: metricbeat\n  namespace: elastic\nroleRef:\n  kind: ClusterRole\n  name: metricbeat\n  apiGroup: rbac.authorization.k8s.io\n---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: ClusterRole\nmetadata:\n  name: metricbeat\n  labels:\n    app: metricbeat\nrules:\n- apiGroups: [\"\"]\n  resources:\n  - nodes\n  - namespaces\n  - events\n  - pods\n  verbs: [\"get\", \"list\", \"watch\"]\n- apiGroups: [\"extensions\"]\n  resources:\n  - replicasets\n  verbs: [\"get\", \"list\", \"watch\"]\n- apiGroups: [\"apps\"]\n  resources:\n  - statefulsets\n  - deployments\n  - replicasets\n  verbs: [\"get\", \"list\", \"watch\"]\n- apiGroups:\n  - \"\"\n  resources:\n  - nodes/stats\n  verbs:\n  - get\n---\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  namespace: elastic\n  name: metricbeat\n  labels:\n    app: metricbeat\n---\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u51e0\u4e2a\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>kubectl apply  -f metricbeat.settings.configmap.yml\nkubectl apply  -f metricbeat.indice-lifecycle.configmap.yml\nkubectl apply  -f metricbeat.daemonset.yml\nkubectl apply  -f metricbeat.permissions.yml\n</code></pre> <pre><code>$ kubectl get pods -n elastic -l app=metricbeat\nNAME               READY   STATUS    RESTARTS   AGE\nmetricbeat-ppjgv   1/1     Running   0          113s\n</code></pre> <p>\u5f53 Metricbeat \u7684 Pod \u53d8\u6210 Running \u72b6\u6001\u540e\uff0c\u6b63\u5e38\u6211\u4eec\u5c31\u53ef\u4ee5\u5728 Kibana \u4e2d\u53bb\u67e5\u770b\u5bf9\u5e94\u7684\u76d1\u63a7\u4fe1\u606f\u4e86\u3002</p> <p>\u5728 <code>Kibana</code> \u5de6\u4fa7\u9875\u9762 <code>Observability \u2192 Metrics</code>\u8fdb\u5165\u6307\u6807\u76d1\u63a7\u9875\u9762\uff0c\u6b63\u5e38\u5c31\u53ef\u4ee5\u770b\u5230\u4e00\u4e9b\u76d1\u63a7\u6570\u636e\u4e86\uff1a</p> <p></p> <p>\u4e5f\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u9700\u6c42\u8fdb\u884c\u7b5b\u9009\uff0c\u6bd4\u5982\u6211\u4eec\u53ef\u4ee5\u6309\u7167 Kubernetes Namespace \u8fdb\u884c\u5206\u7ec4\u4f5c\u4e3a\u89c6\u56fe\u67e5\u770b\u76d1\u63a7\u4fe1\u606f\uff1a</p> <p></p> <p></p> <p>\u7531\u4e8e\u6211\u4eec\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u8bbe\u7f6e\u4e86\u5c5e\u6027 <code>setup.dashboards.enabled=true</code>\uff0c\u6240\u4ee5 <code>Kibana</code> \u4f1a\u5bfc\u5165\u9884\u5148\u5df2\u7ecf\u5b58\u5728\u7684\u4e00\u4e9b <code>Dashboard</code>\u3002\u6211\u4eec\u53ef\u4ee5\u5728\u5de6\u4fa7\u83dc\u5355\u8fdb\u5165 <code>Kibana \u2192 Dashboard</code> \u9875\u9762\uff0c\u6211\u4eec\u4f1a\u770b\u5230\u4e00\u4e2a\u5927\u7ea6\u6709 <code>50</code> \u4e2a <code>Metricbeat</code> \u7684 <code>Dashboard</code> \u5217\u8868\uff0c\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u9700\u8981\u7b5b\u9009 Dashboard\uff0c\u6bd4\u5982\u6211\u4eec\u8981\u67e5\u770b\u96c6\u7fa4\u8282\u70b9\u7684\u4fe1\u606f\uff0c\u53ef\u4ee5\u67e5\u770b <code>[Metricbeat Kubernetes] Overview ECS</code> \u8fd9\u4e2a Dashboard\uff1a</p> <p></p> <p></p> <p>\u6211\u4eec\u8fd8\u5355\u72ec\u542f\u7528\u4e86 mongodb \u6a21\u5757\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 [Metricbeat MongoDB] Overview ECS \u8fd9\u4e2a Dashboard \u6765\u67e5\u770b\u76d1\u63a7\u4fe1\u606f\uff1a</p> <p></p> <p></p> <p>\u6211\u4eec\u8fd8\u542f\u7528\u4e86 docker \u8fd9\u4e2a\u6a21\u5757\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528 [Metricbeat Docker] Overview ECS \u8fd9\u4e2a Dashboard \u6765\u67e5\u770b\u76d1\u63a7\u4fe1\u606f\uff1a</p> <p></p> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u5b8c\u6210\u4e86\u4f7f\u7528 Metricbeat \u6765\u76d1\u63a7 Kubernetes \u96c6\u7fa4\u4fe1\u606f\uff0c\u4e0b\u4e00\u7bc7\u6587\u7ae0\u6211\u4eec\u518d\u6765\u5b66\u4e60\u5982\u4f55\u4f7f\u7528 Filebeat \u6765\u6536\u96c6\u65e5\u5fd7\u4ee5\u76d1\u63a7 Kubernetes \u96c6\u7fa4\u3002</p>"},{"location":"chap11/22Elastic_Stack_Monitoring3/","title":"\u7b2c\u4e09\u8282 \u4f7f\u7528 Elastic Stack - Filebeat \u65e5\u5fd7\u6570\u636e\u6536\u96c6\u5b89\u88c5","text":"<p>\u5728\u672c\u8282\u4e2d\u6211\u4eec\u5c06\u8981\u5b89\u88c5\u914d\u7f6e Filebeat \u6765\u6536\u96c6 Kubernetes \u96c6\u7fa4\u4e2d\u7684\u65e5\u5fd7\u6570\u636e\uff0c\u7136\u540e\u53d1\u9001\u5230 ElasticSearch \u53bb\u4e2d\uff0cFilebeat \u662f\u4e00\u4e2a\u8f7b\u91cf\u7ea7\u7684\u65e5\u5fd7\u91c7\u96c6\u4ee3\u7406\uff0c\u8fd8\u53ef\u4ee5\u914d\u7f6e\u7279\u5b9a\u7684\u6a21\u5757\u6765\u89e3\u6790\u548c\u53ef\u89c6\u5316\u5e94\u7528\uff08\u6bd4\u5982\u6570\u636e\u5e93\u3001Nginx \u7b49\uff09\u7684\u65e5\u5fd7\u683c\u5f0f\u3002</p> <p>\u548c Metricbeat \u7c7b\u4f3c\uff0cFilebeat \u4e5f\u9700\u8981\u4e00\u4e2a\u914d\u7f6e\u6587\u4ef6\u6765\u8bbe\u7f6e\u548c ElasticSearch \u7684\u94fe\u63a5\u4fe1\u606f\u3001\u548c Kibana \u7684\u8fde\u63a5\u5df2\u7ecf\u65e5\u5fd7\u91c7\u96c6\u548c\u89e3\u6790\u7684\u65b9\u5f0f\u3002</p> <p>\u5982\u4e0b\u6240\u793a\u7684 ConfigMap \u8d44\u6e90\u5bf9\u8c61\u5c31\u662f\u6211\u4eec\u8fd9\u91cc\u7528\u4e8e\u65e5\u5fd7\u91c7\u96c6\u7684\u914d\u7f6e\u4fe1\u606f\uff08\u53ef\u4ee5\u4ece\u5b98\u65b9\u7f51\u7ad9\u4e0a\u83b7\u53d6\u5b8c\u6574\u7684\u53ef\u914d\u7f6e\u4fe1\u606f\uff09:</p> <p><code>filebeat.settings.configmap.yml</code></p> <pre><code>---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  namespace: elastic\n  name: filebeat-config\n  labels:\n    app: filebeat\ndata:\n  filebeat.yml: |-\n    filebeat.inputs:\n    - type: container\n      enabled: true\n      paths:\n      - /var/log/containers/*.log\n      processors:\n      - add_kubernetes_metadata:\n          in_cluster: true\n          host: ${NODE_NAME}\n          matchers:\n          - logs_path:\n              logs_path: \"/var/log/containers/\"\n\n    filebeat.autodiscover:\n      providers:\n        - type: kubernetes\n          templates:\n            - condition.equals:\n                kubernetes.labels.app: mongo\n              config:\n                - module: mongodb\n                  enabled: true\n                  log:\n                    input:\n                      type: docker\n                      containers.ids:\n                        - ${data.kubernetes.container.id}\n\n    processors:\n      - drop_event:\n          when.or:\n              - and:\n                  - regexp:\n                      message: '^\\d+\\.\\d+\\.\\d+\\.\\d+ '\n                  - equals:\n                      fileset.name: error\n              - and:\n                  - not:\n                      regexp:\n                          message: '^\\d+\\.\\d+\\.\\d+\\.\\d+ '\n                  - equals:\n                      fileset.name: access\n      - add_cloud_metadata:\n      - add_kubernetes_metadata:\n          matchers:\n          - logs_path:\n              logs_path: \"/var/log/containers/\"\n      - add_docker_metadata:\n\n    output.elasticsearch:\n      hosts: ['${ELASTICSEARCH_HOST:elasticsearch}:${ELASTICSEARCH_PORT:9200}']\n      username: ${ELASTICSEARCH_USERNAME}\n      password: ${ELASTICSEARCH_PASSWORD}\n\n    setup.kibana:\n      host: '${KIBANA_HOST:kibana}:${KIBANA_PORT:5601}'\n\n    setup.dashboards.enabled: true\n    setup.template.enabled: true\n\n    setup.ilm:\n      policy_file: /etc/indice-lifecycle.json\n---\n</code></pre> <p>\u6211\u4eec\u914d\u7f6e\u91c7\u96c6 <code>/var/log/containers/</code> \u4e0b\u9762\u7684\u6240\u6709\u65e5\u5fd7\u6570\u636e\uff0c\u5e76\u4e14\u4f7f\u7528 <code>inCluster</code> \u7684\u6a21\u5f0f\u8bbf\u95ee <code>Kubernetes</code> \u7684 <code>APIServer</code>\uff0c\u83b7\u53d6\u65e5\u5fd7\u6570\u636e\u7684 <code>Meta</code> \u4fe1\u606f\uff0c\u5c06\u65e5\u5fd7\u76f4\u63a5\u53d1\u9001\u5230 <code>Logstash</code>\uff0c\u8fd9\u91cc\u5c06\u4f7f\u7528 <code>logstash</code> \u8f93\u51fa\u63d2\u4ef6\u3002</p> <p><code>filebeat.indice-lifecycle.configmap.yml</code></p> <pre><code>---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  namespace: elastic\n  name: filebeat-indice-lifecycle\n  labels:\n    app: filebeat\ndata:\n  indice-lifecycle.json: |-\n    {\n      \"policy\": {\n        \"phases\": {\n          \"hot\": {\n            \"actions\": {\n              \"rollover\": {\n                \"max_size\": \"1GB\" ,\n                \"max_age\": \"1d\"\n              }\n            }\n          },\n          \"delete\": {\n            \"min_age\": \"30d\",\n            \"actions\": {\n              \"delete\": {}\n            }\n          }\n        }\n      }\n    }\n</code></pre> <p>\u540c\u6837\u4e3a\u4e86\u91c7\u96c6\u6bcf\u4e2a\u8282\u70b9\u4e0a\u7684\u65e5\u5fd7\u6570\u636e\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u4e00\u4e2a DaemonSet \u63a7\u5236\u5668\uff0c\u4f7f\u7528\u4e0a\u9762\u7684\u914d\u7f6e\u6765\u91c7\u96c6\u8282\u70b9\u7684\u65e5\u5fd7\u3002</p> <p><code>filebeat.daemonset.yml</code></p> <pre><code>---\napiVersion: apps/v1\nkind: DaemonSet\nmetadata:\n  namespace: elastic\n  name: filebeat\n  labels:\n    app: filebeat\nspec:\n  selector:\n    matchLabels:\n      app: filebeat\n  template:\n    metadata:\n      labels:\n        app: filebeat\n    spec:\n      serviceAccountName: filebeat\n      terminationGracePeriodSeconds: 30\n      containers:\n      - name: filebeat\n        image: docker.elastic.co/beats/filebeat:7.8.0\n        args: [\n          \"-c\", \"/etc/filebeat.yml\",\n          \"-e\",\n        ]\n        env:\n        - name: ELASTICSEARCH_HOST\n          value: elasticsearch-client.elastic.svc.cluster.local\n        - name: ELASTICSEARCH_PORT\n          value: \"9200\"\n        - name: ELASTICSEARCH_USERNAME\n          value: elastic\n        - name: ELASTICSEARCH_PASSWORD\n          valueFrom:\n            secretKeyRef:\n              name: elasticsearch-pw-elastic\n              key: password\n        - name: KIBANA_HOST\n          value: kibana.elastic.svc.cluster.local\n        - name: KIBANA_PORT\n          value: \"5601\"\n        - name: NODE_NAME\n          valueFrom:\n            fieldRef:\n              fieldPath: spec.nodeName\n        securityContext:\n          runAsUser: 0\n        resources:\n          limits:\n            memory: 200Mi\n          requests:\n            cpu: 100m\n            memory: 100Mi\n        volumeMounts:\n        - name: config\n          mountPath: /etc/filebeat.yml\n          readOnly: true\n          subPath: filebeat.yml\n        - name: filebeat-indice-lifecycle\n          mountPath: /etc/indice-lifecycle.json\n          readOnly: true\n          subPath: indice-lifecycle.json\n        - name: data\n          mountPath: /usr/share/filebeat/data\n        - name: varlog\n          mountPath: /var/log\n          readOnly: true\n        - name: varlibdockercontainers\n          mountPath: /var/lib/docker/containers\n          readOnly: true\n        - name: dockersock\n          mountPath: /var/run/docker.sock\n      volumes:\n      - name: config\n        configMap:\n          defaultMode: 0600\n          name: filebeat-config\n      - name: filebeat-indice-lifecycle\n        configMap:\n          defaultMode: 0600\n          name: filebeat-indice-lifecycle\n      - name: varlog\n        hostPath:\n          path: /var/log\n      - name: varlibdockercontainers\n        hostPath:\n          path: /var/lib/docker/containers\n      - name: dockersock\n        hostPath:\n          path: /var/run/docker.sock\n      - name: data\n        hostPath:\n          path: /var/lib/filebeat-data\n          type: DirectoryOrCreate\n---\n</code></pre> <p>\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u7684\u662f Kubeadm \u642d\u5efa\u7684\u96c6\u7fa4\uff0c\u9ed8\u8ba4 <code>Master</code>\u8282\u70b9\u662f\u6709\u6c61\u70b9\u7684\uff0c\u6240\u4ee5\u5982\u679c\u8fd8\u60f3\u91c7\u96c6 <code>Master</code> \u8282\u70b9\u7684\u65e5\u5fd7\uff0c\u8fd8\u5fc5\u987b\u52a0\u4e0a\u5bf9\u5e94\u7684\u5bb9\u5fcd\uff0c\u6211\u8fd9\u91cc\u4e0d\u91c7\u96c6\u5c31\u6ca1\u6709\u6dfb\u52a0\u5bb9\u5fcd\u4e86\u3002</p> <p>\u6b64\u5916\u7531\u4e8e\u9700\u8981\u83b7\u53d6\u65e5\u5fd7\u5728 <code>Kubernetes</code> \u96c6\u7fa4\u4e2d\u7684 <code>Meta</code> \u4fe1\u606f\uff0c\u6bd4\u5982 <code>Pod</code> \u540d\u79f0\u3001\u6240\u5728\u7684\u547d\u540d\u7a7a\u95f4\u7b49\uff0c\u6240\u4ee5 <code>Filebeat</code> \u9700\u8981\u8bbf\u95ee <code>APIServer</code>\uff0c\u81ea\u7136\u5c31\u9700\u8981\u5bf9\u5e94\u7684 <code>RBAC</code> \u6743\u9650\u4e86\uff0c\u6240\u4ee5\u8fd8\u9700\u8981\u8fdb\u884c\u6743\u9650\u58f0\u660e\uff1a</p> <p><code>filebeat.permission.yml</code></p> <pre><code># filebeat.permission.yml\n---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: ClusterRoleBinding\nmetadata:\n  name: filebeat\nsubjects:\n- kind: ServiceAccount\n  name: filebeat\n  namespace: elastic\nroleRef:\n  kind: ClusterRole\n  name: filebeat\n  apiGroup: rbac.authorization.k8s.io\n---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: ClusterRole\nmetadata:\n  name: filebeat\n  labels:\n    app: filebeat\nrules:\n- apiGroups: [\"\"]\n  resources:\n  - namespaces\n  - pods\n  verbs:\n  - get\n  - watch\n  - list\n---\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  namespace: elastic\n  name: filebeat\n  labels:\n    app: filebeat\n---\n</code></pre> <p>\u7136\u540e\u76f4\u63a5\u5b89\u88c5\u90e8\u7f72\u4e0a\u9762\u7684\u51e0\u4e2a\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>kubectl apply  -f filebeat.settings.configmap.yml\nkubectl apply  -f filebeat.indice-lifecycle.configmap.yml\nkubectl apply  -f filebeat.daemonset.yml\nkubectl apply  -f  filebeat.permission.yml\n</code></pre> <p>\u5f53\u6240\u6709\u7684 <code>Filebeat</code> \u548c <code>Logstash</code> \u7684 <code>Pod</code> \u90fd\u53d8\u6210 <code>Running</code> \u72b6\u6001\u540e\uff0c\u8bc1\u660e\u90e8\u7f72\u5b8c\u6210\u3002\u73b0\u5728\u6211\u4eec\u5c31\u53ef\u4ee5\u8fdb\u5165\u5230 Kibana \u9875\u9762\u4e2d\u53bb\u67e5\u770b\u65e5\u5fd7\u4e86\u3002\u5de6\u4fa7\u83dc\u5355 <code>Observability \u2192 Logs</code></p> <p></p> <p>\u6b64\u5916\u8fd8\u53ef\u4ee5\u4ece\u4e0a\u8282\u6211\u4eec\u63d0\u5230\u7684 <code>Metrics</code> \u9875\u9762\u8fdb\u5165\u67e5\u770b <code>Pod</code> \u7684\u65e5\u5fd7\uff1a</p> <p></p> <p>\u70b9\u51fb Kubernetes Pod logs \u83b7\u53d6\u9700\u8981\u67e5\u770b\u7684 Pod \u65e5\u5fd7\uff1a</p> <p></p> <p>\u4e5f\u53ef\u4ee5\u8fdb\u5165 <code>Kibana -&gt; Discovery</code> \u9875\u9762\u7b5b\u9009\u9700\u8981\u67e5\u770b\u7684\u65e5\u5fd7\u6570\u636e\uff1a</p> <p></p> <p>\u5982\u679c\u96c6\u7fa4\u4e2d\u8981\u91c7\u96c6\u7684\u65e5\u5fd7\u6570\u636e\u91cf\u592a\u5927\uff0c\u76f4\u63a5\u5c06\u6570\u636e\u53d1\u9001\u7ed9 ElasticSearch\uff0c\u5bf9 ES \u538b\u529b\u6bd4\u8f83\u5927\uff0c\u8fd9\u79cd\u60c5\u51b5\u4e00\u822c\u53ef\u4ee5\u52a0\u4e00\u4e2a\u7c7b\u4f3c\u4e8e Kafka \u8fd9\u6837\u7684\u4e2d\u95f4\u4ef6\u6765\u7f13\u51b2\u4e0b\uff0c\u6216\u8005\u901a\u8fc7 Logstash \u6765\u6536\u96c6 Filebeat \u7684\u65e5\u5fd7\u3002</p> <p>\u8fd9\u91cc\u6211\u4eec\u5c31\u5b8c\u6210\u4e86\u4f7f\u7528 Filebeat \u91c7\u96c6 Kubernetes \u96c6\u7fa4\u7684\u65e5\u5fd7\uff0c\u5728\u4e0b\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u4eec\u7ee7\u7eed\u5b66\u4e60\u5982\u4f55\u4f7f\u7528 Elastic APM \u6765\u8ffd\u8e2a Kubernetes \u96c6\u7fa4\u5e94\u7528\u3002</p>"},{"location":"chap11/23Elastic_Stack_Monitoring4/","title":"\u7b2c\u56db\u8282 \u4f7f\u7528 Elastic Stack \u2014 Elastic APM \u5e94\u7528\u6027\u80fd\u76d1\u63a7\u7684\u5de5\u5177\u5b89\u88c5","text":"<p>Elastic APM\uff08\u5e94\u7528\u6027\u80fd\u76d1\u63a7Application Performance Monitoring\uff09 \u662f Elastic Stack \u4e0a\u7528\u4e8e\u5e94\u7528\u6027\u80fd\u76d1\u63a7\u7684\u5de5\u5177\uff0c\u5b83\u5141\u8bb8\u6211\u4eec\u901a\u8fc7\u6536\u96c6\u4f20\u5165\u8bf7\u6c42\u3001\u6570\u636e\u5e93\u67e5\u8be2\u3001\u7f13\u5b58\u8c03\u7528\u7b49\u65b9\u5f0f\u6765\u5b9e\u65f6\u76d1\u63a7\u5e94\u7528\u6027\u80fd\u3002\u8fd9\u53ef\u4ee5\u8ba9\u6211\u4eec\u66f4\u52a0\u8f7b\u677e\u5feb\u901f\u5b9a\u4f4d\u6027\u80fd\u95ee\u9898\u3002</p> <p>Elastic APM \u662f\u517c\u5bb9 OpenTracing \u7684\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u5927\u91cf\u73b0\u6709\u7684\u5e93\u6765\u8ddf\u8e2a\u5e94\u7528\u7a0b\u5e8f\u6027\u80fd\u3002\u6bd4\u5982\u6211\u4eec\u53ef\u4ee5\u5728\u4e00\u4e2a\u5206\u5e03\u5f0f\u73af\u5883\uff08\u5fae\u670d\u52a1\u67b6\u6784\uff09\u4e2d\u8ddf\u8e2a\u4e00\u4e2a\u8bf7\u6c42\uff0c\u5e76\u8f7b\u677e\u627e\u5230\u53ef\u80fd\u6f5c\u5728\u7684\u6027\u80fd\u74f6\u9888\u3002</p> <p></p> <p>Elastic APM \u901a\u8fc7\u4e00\u4e2a\u540d\u4e3a <code>APM-Server</code> \u7684\u7ec4\u4ef6\u63d0\u4f9b\u670d\u52a1\uff0c\u7528\u4e8e\u6536\u96c6\u5e76\u5411 <code>ElasticSearch</code> \u4ee5\u53ca\u548c\u5e94\u7528\u4e00\u8d77\u8fd0\u884c\u7684 <code>agent</code> \u7a0b\u5e8f\u53d1\u9001\u8ffd\u8e2a\u6570\u636e\u3002</p> <p></p>"},{"location":"chap11/23Elastic_Stack_Monitoring4/#1-apm-server","title":"1\u3001\u5b89\u88c5 APM-Server","text":"<p>\u9996\u5148\u6211\u4eec\u9700\u8981\u5728 <code>Kubernetes</code> \u96c6\u7fa4\u4e0a\u5b89\u88c5 <code>APM-Server</code> \u6765\u6536\u96c6 <code>agent</code> \u7684\u8ffd\u8e2a\u6570\u636e\uff0c\u5e76\u8f6c\u53d1\u7ed9 <code>ElasticSearch</code>\uff0c\u8fd9\u91cc\u540c\u6837\u6211\u4eec\u4f7f\u7528\u4e00\u4e2a <code>ConfigMap</code> \u6765\u914d\u7f6e\uff1a</p> <p><code>apm.configmap.yml</code></p> <pre><code>---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  namespace: elastic\n  name: apm-server-config\n  labels:\n    app: apm-server\ndata:\n  apm-server.yml: |-\n    apm-server:\n      host: \"0.0.0.0:8200\"\n\n    output.elasticsearch:\n      hosts: ['${ELASTICSEARCH_HOST:elasticsearch}:${ELASTICSEARCH_PORT:9200}']\n      username: ${ELASTICSEARCH_USERNAME}\n      password: ${ELASTICSEARCH_PASSWORD}\n\n    setup.kibana:\n      host: '${KIBANA_HOST:kibana}:${KIBANA_PORT:5601}'\n---\n</code></pre> <p><code>APM-Server</code> \u9700\u8981\u66b4\u9732 <code>8200</code> \u7aef\u53e3\u6765\u8ba9 <code>agent</code> \u8f6c\u53d1\u4ed6\u4eec\u7684\u8ffd\u8e2a\u6570\u636e\uff0c\u65b0\u5efa\u4e00\u4e2a\u5bf9\u5e94\u7684 <code>Service</code> \u5bf9\u8c61\u5373\u53ef\uff1a</p> <p><code>apm.service.yml</code></p> <pre><code>---\napiVersion: v1\nkind: Service\nmetadata:\n  namespace: elastic\n  name: apm-server\n  labels:\n    app: apm-server\nspec:\n  ports:\n  - port: 8200\n    name: apm-server\n  selector:\n    app: apm-server\n---\n</code></pre> <p>\u7136\u540e\u4f7f\u7528\u4e00\u4e2a Deployment \u8d44\u6e90\u5bf9\u8c61\u7ba1\u7406\u5373\u53ef\uff1a</p> <p><code>apm.deployment.yml</code></p> <pre><code>---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  namespace: elastic\n  name: apm-server\n  labels:\n    app: apm-server\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: apm-server\n  template:\n    metadata:\n      labels:\n        app: apm-server\n    spec:\n      containers:\n      - name: apm-server\n        image: docker.elastic.co/apm/apm-server:7.8.0\n        env:\n        - name: ELASTICSEARCH_HOST\n          value: elasticsearch-client.elastic.svc.cluster.local\n        - name: ELASTICSEARCH_PORT\n          value: \"9200\"\n        - name: ELASTICSEARCH_USERNAME\n          value: elastic\n        - name: ELASTICSEARCH_PASSWORD\n          valueFrom:\n            secretKeyRef:\n              name: elasticsearch-pw-elastic\n              key: password\n        - name: KIBANA_HOST\n          value: kibana.elastic.svc.cluster.local\n        - name: KIBANA_PORT\n          value: \"5601\"\n        ports:\n        - containerPort: 8200\n          name: apm-server\n        volumeMounts:\n        - name: config\n          mountPath: /usr/share/apm-server/apm-server.yml\n          readOnly: true\n          subPath: apm-server.yml\n      volumes:\n      - name: config\n        configMap:\n          name: apm-server-config\n---\n</code></pre> <p>\u76f4\u63a5\u90e8\u7f72\u4e0a\u9762\u7684\u51e0\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>kubectl apply  -f apm.configmap.yml\nkubectl apply  -f apm.deployment.yml\nkubectl apply  -f apm.service.yml\n</code></pre> <p>\u5f53 Pod \u5904\u4e8e Running \u72b6\u6001\u8bc1\u660e\u8fd0\u884c\u6210\u529f\uff1a</p> <pre><code>$ kubectl get pods -n elastic -l app=apm-server\nNAME                          READY   STATUS    RESTARTS   AGE\napm-server-667bfc5cff-jsl8q   1/1     Running   0          3m56s\n</code></pre> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u53ef\u4ee5\u5728\u7b2c\u4e00\u8282\u4e2d\u90e8\u7f72\u7684 Spring-Boot \u5e94\u7528\u4e0a\u5b89\u88c5\u4e00\u4e2a agent \u5e94\u7528\u3002</p>"},{"location":"chap11/23Elastic_Stack_Monitoring4/#2-java-agent","title":"2\u3001\u914d\u7f6e Java Agent","text":"<p>\u63a5\u4e0b\u6765\u6211\u4eec\u5728\u793a\u4f8b\u5e94\u7528\u7a0b\u5e8f <code>spring-boot-simple</code> \u4e0a\u914d\u7f6e\u4e00\u4e2a Elastic APM Java agent\u3002</p> <p>\u9996\u5148\u6211\u4eec\u9700\u8981\u628a <code>elastic-apm-agent-1.8.0.jar</code> \u8fd9\u4e2a <code>ja</code>r \u5305\u7a0b\u5e8f\u5185\u7f6e\u5230\u5e94\u7528\u5bb9\u5668\u4e2d\u53bb\uff0c\u5728\u6784\u5efa\u955c\u50cf\u7684 <code>Dockerfile</code> \u6587\u4ef6\u4e2d\u6dfb\u52a0\u4e00\u884c\u5982\u4e0b\u6240\u793a\u7684\u547d\u4ee4\u76f4\u63a5\u4e0b\u8f7d\u8be5 JAR \u5305\u5373\u53ef\uff1a</p> <pre><code>RUN wget -O /apm-agent.jar https://search.maven.org/remotecontent?filepath=co/elastic/apm/elastic-apm-agent/1.8.0/elastic-apm-agent-1.8.0.jar\n</code></pre> <p>\u5b8c\u6574\u7684 <code>Dockerfile</code> \u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>FROM openjdk:8-jdk-alpine\n\nENV ELASTIC_APM_VERSION \"1.8.0\"\nRUN wget -O /apm-agent.jar https://search.maven.org/remotecontent?filepath=co/elastic/apm/elastic-apm-agent/$ELASTIC_APM_VERSION/elastic-apm-agent-$ELASTIC_APM_VERSION.jar\n\nCOPY target/spring-boot-simple.jar /app.jar\n\nCMD java -jar /app.jar\n</code></pre> <p>\u7136\u540e\u9700\u8981\u5728\u793a\u4f8b\u5e94\u7528\u4e2d\u6dfb\u52a0\u4e0a\u5982\u4e0b\u4f9d\u8d56\u5173\u7cfb\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u96c6\u6210 <code>open-tracing</code> \u7684\u4f9d\u8d56\u5e93\u6216\u8005\u4f7f\u7528 <code>Elastic APM API</code> \u624b\u52a8\u68c0\u6d4b\u3002</p> <pre><code>&lt;dependency&gt;\n    &lt;groupId&gt;co.elastic.apm&lt;/groupId&gt;\n    &lt;artifactId&gt;apm-agent-api&lt;/artifactId&gt;\n    &lt;version&gt;${elastic-apm.version}&lt;/version&gt;\n&lt;/dependency&gt;\n&lt;dependency&gt;\n    &lt;groupId&gt;co.elastic.apm&lt;/groupId&gt;\n    &lt;artifactId&gt;apm-opentracing&lt;/artifactId&gt;\n    &lt;version&gt;${elastic-apm.version}&lt;/version&gt;\n&lt;/dependency&gt;\n&lt;dependency&gt;\n    &lt;groupId&gt;io.opentracing.contrib&lt;/groupId&gt;\n    &lt;artifactId&gt;opentracing-spring-cloud-mongo-starter&lt;/artifactId&gt;\n    &lt;version&gt;${opentracing-spring-cloud.version}&lt;/version&gt;\n&lt;/dependency&gt;\n</code></pre> <p>\u7136\u540e\u9700\u8981\u4fee\u6539\u7b2c\u4e00\u7bc7\u6587\u7ae0\u4e2d\u4f7f\u7528<code>Deployment</code> \u90e8\u7f72\u7684 <code>Spring-Boot</code> \u5e94\u7528\uff0c\u9700\u8981\u5f00\u542f <code>Java agent</code>\u5e76\u4e14\u8981\u8fde\u63a5\u5230 <code>APM-Server</code>\u3002</p> <p><code>spring-boot-simple-apm.deployment.yml</code></p> <pre><code>---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  namespace: elastic\n  name: spring-boot-simple\n  labels:\n    app: spring-boot-simple\nspec:\n  selector:\n    matchLabels:\n      app: spring-boot-simple\n  template:\n    metadata:\n      labels:\n        app: spring-boot-simple\n    spec:\n      containers:\n      - image: gjeanmart/spring-boot-simple:0.0.1-SNAPSHOT\n        imagePullPolicy: Always\n        name: spring-boot-simple\n        command:\n          - \"java\"\n          - \"-javaagent:/apm-agent.jar\"\n          - \"-Delastic.apm.active=$(ELASTIC_APM_ACTIVE)\"\n          - \"-Delastic.apm.server_urls=$(ELASTIC_APM_SERVER)\"\n          - \"-Delastic.apm.service_name=spring-boot-simple\"\n          - \"-jar\"\n          - \"app.jar\"\n        env:\n          - name: SPRING_DATA_MONGODB_HOST\n            value: mongo\n          - name: ELASTIC_APM_ACTIVE\n            value: \"true\"\n          - name: ELASTIC_APM_SERVER\n            value: http://apm-server.elastic.svc.cluster.local:8200\n        ports:\n        - containerPort: 8080\n---\n</code></pre> <p><code>spring-boot-simple-apm.service.yml</code></p> <pre><code>---\napiVersion: v1\nkind: Service\nmetadata:\n  namespace: elastic\n  name: spring-boot-simple\n  labels:\n    app: spring-boot-simple\nspec:\n  type: NodePort\n  ports:\n  - port: 8080\n    protocol: TCP\n  selector:\n    app: spring-boot-simple\n</code></pre> <p>\u7136\u540e\u91cd\u65b0\u90e8\u7f72\u4e0a\u9762\u7684\u793a\u4f8b\u5e94\u7528\uff1a</p> <pre><code>$ kubectl get pods -n elastic -l app=spring-boot-simple\nNAME                                 READY   STATUS    RESTARTS   AGE\nspring-boot-simple-fb5564885-wshkl   1/1     Running   0          11s\n\n$ kubectl get svc -n elastic -l app=spring-boot-simple\nNAME                 TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE\nspring-boot-simple   NodePort   10.101.230.168   &lt;none&gt;        8080:32734/TCP   95s\n</code></pre> <p>\u5f53\u793a\u4f8b\u5e94\u7528\u91cd\u65b0\u90e8\u7f72\u5b8c\u6210\u540e\uff0c\u6267\u884c\u5982\u4e0b\u51e0\u4e2a\u8bf7\u6c42\uff1a</p> <p>get messages</p> <p>\u83b7\u53d6\u6240\u6709\u53d1\u5e03\u7684 messages \u6570\u636e\uff1a</p> <pre><code>$ curl -X GET http://localhost:32734/message\n[{\"id\":\"5f03e4da217e8e0001591daa\",\"message\":\"hello+world=\",\"postedAt\":\"2020-07-07T02:58:34.568+0000\"}]\n</code></pre> <p>get messages (\u6162\u8bf7\u6c42)</p> <p>\u4f7f\u7528 <code>sleep=&lt;ms&gt;</code> \u6765\u6a21\u62df\u6162\u8bf7\u6c42\uff1a</p> <pre><code>$ curl -X GET http://localhost:32734/message?sleep=3000\n[{\"id\":\"5f03e4da217e8e0001591daa\",\"message\":\"hello+world=\",\"postedAt\":\"2020-07-07T02:58:34.568+0000\"}]\n</code></pre> <p>get messages (error)</p> <p>\u4f7f\u7528 <code>error=true</code> \u6765\u89e6\u53d1\u4e00\u5f02\u5e38\uff1a</p> <pre><code> curl -X GET http://localhost:32734/message?error=true\n{\"timestamp\":\"2020-07-09T03:00:22.095+0000\",\"status\":500,\"error\":\"Internal Server Error\",\"message\":\"java.lang.Exception: Random error\",\"path\":\"/message\"}\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u53bb\u5230 Kibana \u9875\u9762\u4e2d\u8def\u7531\u5230 APM \u9875\u9762\uff0c\u6211\u4eec\u5e94\u8be5\u5c31\u53ef\u4ee5\u770b\u5230 spring-boot-simple \u5e94\u7528\u7684\u6570\u636e\u4e86\u3002</p> <p></p> <p>\u70b9\u51fb\u5e94\u7528\u5c31\u53ef\u4ee5\u67e5\u770b\u5230\u5f53\u524d\u5e94\u7528\u7684\u5404\u79cd\u6027\u80fd\u8ffd\u8e2a\u6570\u636e\uff1a</p> <p></p> <p>\u53ef\u4ee5\u67e5\u770b\u73b0\u5728\u7684\u9519\u8bef\u6570\u636e\uff1a</p> <p></p> <p>\u8fd8\u53ef\u4ee5\u67e5\u770b JVM \u7684\u76d1\u63a7\u6570\u636e\uff1a</p> <p></p> <p>\u9664\u6b64\u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u6dfb\u52a0\u62a5\u8b66\u4fe1\u606f\uff0c\u5c31\u53ef\u4ee5\u5728\u7b2c\u4e00\u65f6\u95f4\u638c\u63e1\u5e94\u7528\u7684\u6027\u80fd\u72b6\u51b5\u4e86\u3002</p>"},{"location":"chap12/1chap12_ES_prod/","title":"\u7b2c\u4e00\u8282 \u751f\u4ea7\u73af\u5883\u5e38\u7528\u914d\u7f6e\u548c\u4e0a\u7ebf\u6e05\u5355","text":""},{"location":"chap12/1chap12_ES_prod/#1development-vs-production-mode","title":"1\u3001Development vs. Production Mode","text":"<p>\u4ece ES 5 \u5f00\u59cb\uff0c\u652f\u6301 Development \u548c Production \u4e24\u79cd\u8fd0\u884c\u6a21\u5f0f</p> <ul> <li>\u5f00\u53d1\u6a21\u5f0f: localhost</li> <li>\u751f\u4ea7\u6a21\u5f0f: 192.168.1.32</li> </ul> <p></p>"},{"location":"chap12/1chap12_ES_prod/#2bootstrap-checks","title":"2\u3001Bootstrap Checks","text":"<ul> <li>\u4e00\u4e2a\u96c6\u7fa4\u5728 Production Mode \u65f6\uff0c\u542f\u52a8\u65f6\u5fc5\u987b\u901a\u8fc7\u6240\u6709 Bootstrap \u68c0\u6d4b\uff0c\u5426\u5219\u4f1a\u542f\u52a8\u5931\u8d25</li> <li>Bootstrap Checks \u53ef\u4ee5\u5206\u4e3a\u4e24\u7c7b:JVM &amp; Linux Checks\u3002Linux Checks \u53ea\u9488\u5bf9 Linux \u7cfb\u7edf</li> </ul> <p>https://www.elastic.co/guide/en/elasticsearch/reference/master/bootstrap-checks.html</p>"},{"location":"chap12/1chap12_ES_prod/#3jvm","title":"3\u3001JVM \u8bbe\u5b9a","text":"<ul> <li>\u4eceES6\u5f00\u59cb\uff0c\u53ea\u652f\u630164\u4f4d\u7684JVM<ul> <li>\u914d\u7f6e config / jvm.options</li> </ul> </li> <li>\u907f\u514d\u4fee\u6539\u9ed8\u8ba4\u914d\u7f6e<ul> <li>\u5c06 \u5185\u5b58 Xms \u548c Xmx \u8bbe\u7f6e\u6210\u4e00\u6837\uff0c\u907f\u514d heap resize \u65f6\u5f15\u53d1\u505c\u987f</li> <li>Xmx \u8bbe\u7f6e\u4e0d\u8981\u8d85\u8fc7\u7269\u7406\u5185\u5b58\u7684 50%;\u5355\u4e2a\u8282\u70b9\u4e0a\uff0c\u6700\u5927\u5185\u5b58\u5efa\u8bae\u4e0d\u8981\u8d85\u8fc7 32 G \u5185\u5b58<ul> <li>https://www.elastic.co/blog/a-heap-of-trouble</li> </ul> </li> <li>\u751f\u4ea7\u73af\u5883\uff0cJVM \u5fc5\u987b\u4f7f\u7528 Server \u6a21\u5f0f </li> <li>\u5173\u95ed JVM Swapping</li> </ul> </li> </ul>"},{"location":"chap12/1chap12_ES_prod/#4-api","title":"4\u3001\u96c6\u7fa4\u7684 API \u8bbe\u5b9a","text":"<ul> <li>\u9759\u6001\u8bbe\u7f6e\u548c\u52a8\u6001\u8bbe\u5b9a</li> </ul> <p>\u9759\u6001\u914d\u7f6e\u6587\u4ef6\u5c3d\u91cf\u7b80\u6d01:\u6309\u7167\u6587\u6863\u8bbe\u7f6e\u6240\u6709\u76f8 \u5173\u7cfb\u7edf\u53c2\u6570\u3002 <code>elasticsearch.yml</code> \u914d\u7f6e\u6587\u4ef6\u4e2d\u5c3d\u91cf\u53ea\u5199\u5fc5\u5907\u53c2\u6570</p> <ul> <li>\u5176\u4ed6\u7684\u8bbe\u7f6e\u9879\u53ef\u4ee5\u901a\u8fc7 API \u52a8\u6001\u8fdb\u884c\u8bbe\u5b9a\u3002 \u52a8\u6001\u8bbe\u5b9a\u5206 <code>transient</code> \u548c <code>persistent</code> \u4e24\u79cd\uff0c \u90fd\u4f1a\u8986\u76d6 <code>elasticsearch.yaml</code> \u4e2d\u7684\u8bbe\u7f6e<ul> <li>Transient \u5728\u96c6\u7fa4\u91cd\u542f\u540e\u4f1a\u4e22\u5931</li> <li>Persistent \u5728\u96c6\u7fa4\u4e2d\u91cd\u542f\u540e\u4e0d\u4f1a\u4e22\u5931</li> </ul> </li> </ul> <p></p> <p></p>"},{"location":"chap12/1chap12_ES_prod/#5","title":"5\u3001\u7cfb\u7edf\u8bbe\u7f6e","text":"<ul> <li>\u53c2\u7167\u6587\u6863 \u201cSetup Elasticsearch &gt; Important System Configuration\u201d<ul> <li>https://www.elastic.co/guide/en/elasticsearch/reference/7.1/system-config.html</li> <li>Disable Swapping \uff0c Increase file descriptor\uff0c\u865a\u62df\u5185\u5b58\uff0cnumber of thread</li> </ul> </li> </ul>"},{"location":"chap12/1chap12_ES_prod/#6","title":"6\u3001\u6700\u4f73\u5b9e\u8df5:\u7f51\u7edc","text":"<ul> <li>\u5355\u4e2a\u96c6\u7fa4\u4e0d\u8981\u8de8\u6570\u636e\u4e2d\u5fc3\u8fdb\u884c\u90e8\u7f72(\u4e0d\u8981\u4f7f\u7528 WAN)</li> <li>\u8282\u70b9\u4e4b\u95f4\u7684 hops \u8d8a\u5c11\u8d8a\u597d</li> <li>\u5982\u679c\u6709\u591a\u5757\u7f51\u5361\uff0c\u6700\u597d\u5c06 transport \u548c http \u7ed1\u5b9a\u5230\u4e0d\u540c\u7684\u7f51\u5361\uff0c\u5e76\u8bbe\u7f6e\u4e0d\u540c\u7684\u9632\u706b</li> <li>\u6309\u9700\u4e3a Coordinating Node \u6216 Ingest Node \u914d\u7f6e\u8d1f\u8f7d\u5747\u8861</li> </ul>"},{"location":"chap12/1chap12_ES_prod/#7","title":"7\u3001\u6700\u4f73\u5b9e\u8df5: \u5185\u5b58\u8bbe\u5b9a\u8ba1\u7b97\u5b9e\u4f8b","text":"<ul> <li>\u5185\u5b58\u5927\u5c0f\u8981\u6839\u636e Node \u9700\u8981\u5b58\u50a8\u7684\u6570\u636e\u6765\u8fdb\u884c\u4f30\u7b97<ul> <li>\u641c\u7d22\u7c7b\u7684\u6bd4\u4f8b\u5efa\u8bae: 1:16</li> <li>\u65e5\u5fd7\u7c7b: 1:48 - 1:96 \u4e4b\u95f4</li> </ul> </li> <li>\u603b\u6570\u636e\u91cf1T\uff0c\u8bbe\u7f6e\u4e00\u4e2a\u526f\u672c=2T\u603b\u6570\u636e\u91cf<ul> <li>\u5982\u679c\u641c\u7d22\u7c7b\u7684\u9879\u76ee\uff0c\u6bcf\u4e2a\u8282\u70b9 31 *16 = 496 G\uff0c\u52a0\u4e0a\u9884\u7559\u7a7a\u95f4\u3002\u6240\u4ee5\u6bcf\u4e2a\u8282\u70b9\u6700\u591a 400 G \u6570\u636e\uff0c\u81f3\u5c11\u9700\u8981 5 \u4e2a\u6570\u636e\u8282\u70b9 </li> <li>\u5982\u679c\u662f\u65e5\u5fd7\u7c7b\u9879\u76ee\uff0c\u6bcf\u4e2a\u8282\u70b9 31*50 = 1550 GB\uff0c2 \u4e2a\u6570\u636e\u8282\u70b9 \u5373\u53ef</li> </ul> </li> </ul>"},{"location":"chap12/1chap12_ES_prod/#8","title":"8\u3001\u6700\u4f73\u5b9e\u8df5:\u5b58\u50a8","text":"<ul> <li>\u63a8\u8350\u4f7f\u7528 SSD\uff0c\u4f7f\u7528\u672c\u5730\u5b58\u50a8(Local Disk)\u3002\u907f\u514d\u4f7f\u7528 SAN NFS / AWS / Azure filesystem</li> <li>\u53ef\u4ee5\u5728\u672c\u5730\u6307\u5b9a\u591a\u4e2a \u201cpath.data\u201d\uff0c\u4ee5\u652f\u6301\u4f7f\u7528\u591a\u5757\u78c1\u76d8</li> <li>ES \u672c\u8eab\u63d0\u4f9b\u4e86\u5f88\u597d\u7684 HA \u673a\u5236;\u65e0\u9700\u4f7f\u7528 RAID 1/5/10</li> <li>\u53ef\u4ee5\u5728 Warm \u8282\u70b9\u4e0a\u4f7f\u7528 Spinning Disk\uff0c\u4f46\u662f\u9700\u8981\u5173\u95ed Concurrent Merges<ul> <li><code>Index.merge.scheduler.max_thread_count: 1</code></li> </ul> </li> <li>Trim \u4f60\u7684 SSD<ul> <li>https://www.elastic.co/blog/is-your-elasticsearch-trimmed</li> </ul> </li> </ul>"},{"location":"chap12/1chap12_ES_prod/#9","title":"9\u3001\u6700\u4f73\u5b9e\u8df5:\u670d\u52a1\u5668\u786c\u4ef6","text":"<ul> <li>\u5efa\u8bae\u4f7f\u7528\u4e2d\u7b49\u914d\u7f6e\u7684\u673a\u5668\uff0c\u4e0d\u5efa\u8bae\u4f7f\u7528\u8fc7\u4e8e\u5f3a\u52b2\u7684\u786c\u4ef6\u914d\u7f6e<ul> <li>Medium machine over large machine</li> </ul> </li> <li>\u4e0d\u5efa\u8bae\u5728\u4e00\u53f0\u670d\u52a1\u5668\u4e0a\u8fd0\u884c\u591a\u4e2a\u8282\u70b9</li> </ul>"},{"location":"chap12/1chap12_ES_prod/#10throttles","title":"10\u3001\u96c6\u7fa4\u8bbe\u7f6e:Throttles \u9650\u6d41","text":"<p>\u4e3a Relocation \u548c Recovery \u8bbe\u7f6e\u9650\u6d41\uff0c\u907f\u514d\u8fc7\u591a\u4efb\u52a1\u5bf9\u96c6\u7fa4\u4ea7\u751f\u6027\u80fd\u5f71\u54cd</p> <ul> <li>Recovery<ul> <li>Cluster.routing.allocation.node_concurrent_recoveries: 2 </li> </ul> </li> <li>Relocation<ul> <li>Cluster.routing.allocation.cluster_concurrent_rebalance: 2</li> </ul> </li> </ul>"},{"location":"chap12/1chap12_ES_prod/#11-dynamic-indexes","title":"11\u3001\u96c6\u7fa4\u8bbe\u7f6e:\u5173\u95ed Dynamic Indexes","text":"<ul> <li>\u53ef\u4ee5\u8003\u8651\u5173\u95ed\u52a8\u6001\u7d22\u5f15\u521b\u5efa\u7684\u529f\u80fd</li> </ul> <ul> <li>\u6216\u8005\u901a\u8fc7\u6a21\u7248\u8bbe\u7f6e\u767d\u540d\u5355</li> </ul>"},{"location":"chap12/1chap12_ES_prod/#12","title":"12\u3001\u96c6\u7fa4\u5b89\u5168\u8bbe\u5b9a","text":"<ul> <li>\u4e3a Elasticsearch \u548c Kibana \u914d\u7f6e\u5b89\u5168\u529f\u80fd<ul> <li>\u6253\u5f00 Authentication &amp; Authorization</li> <li>\u5b9e\u73b0\u7d22\u5f15\u548c\u548c\u5b57\u6bb5\u7ea7\u7684\u5b89\u5168\u63a7\u5236</li> </ul> </li> <li>\u8282\u70b9\u95f4\u901a\u4fe1\u52a0\u5bc6</li> <li>Enable HTTPS</li> <li>Audit logs</li> </ul>"},{"location":"chap12/1chap12_ES_prod/#13","title":"13\u3001\u672c\u8282\u77e5\u8bc6\u70b9","text":"<ul> <li>Dev Mode v.s Production Mode</li> <li>Bootstrap Check</li> <li>Best Practices<ul> <li>Network / Hardware / JVM</li> </ul> </li> </ul>"},{"location":"chap12/2chap12_mon_es/","title":"\u7b2c\u4e8c\u8282 \u76d1\u63a7Elasticsearch\u96c6\u7fa4","text":""},{"location":"chap12/2chap12_mon_es/#1elastcsearch-statsapi","title":"1\u3001Elastcsearch Stats\u76f8\u5173\u7684API","text":"<p>Elasticsearch \u63d0\u4f9b7\u591a\u4e2a\u76d1\u63a7\u76f8\u5173\u7684API</p> <ul> <li>Node Stats: <code>_nodes/stats</code> </li> <li>Cluster Stats: <code>_cluster/stats</code></li> <li>Index Stats: <code>index_name/_stats</code> </li> </ul>"},{"location":"chap12/2chap12_mon_es/#2elasticsearch-task-api","title":"2\u3001Elasticsearch Task API","text":"<ul> <li> <p>\u67e5\u770bTask\u76f8\u5173\u7684API</p> <ul> <li>Pending Cluster Tasks API: <code>GET _cluster/pending_tasks</code></li> <li>Task Management API <code>GET _tasks</code>\uff08\u53ef\u4ee5\u7528\u6765Cancel\u4e00\u4e2aTask) </li> </ul> </li> <li> <p>\u76d1\u63a7Thread Pools </p> <ul> <li><code>GET _nodes/thread_pool</code> </li> <li><code>GET _nodes/stats/thread_pool</code> </li> <li><code>GET _cat/thread_pool?v</code> </li> <li><code>GET _nodes/hot_threads</code></li> </ul> </li> </ul>"},{"location":"chap12/2chap12_mon_es/#3the-index-query-slow-log","title":"3\u3001The Index &amp; Query Slow Log","text":"<ul> <li>\u652f\u6301\u5c06\u5206\u7247\u4e0a\uff0cSearch \u548c Fetch \u9636\u6bb5\u7684\u6162\u67e5\u8be2\u5199\u5165\u6587\u4ef6 </li> <li>\u652f\u6301\u4e3a Query \u548c Fetch \u5206\u522b\u5b9a\u4e49\u9608\u503c </li> <li>\u7d22\u5f15\u7ea7\u7684\u52a8\u6001\u8bbe\u7f6e\uff0c\u53ef\u4ee5\u6309\u9700\u8bbe\u7f6e\uff0c\u6216\u8005\u901a\u8fc7 Index Template \u7edf\u4e00\u8bbe\u5b9a </li> <li>Slow log\u6587\u4ef6\u901a\u8fc7<code>log4j2.properties</code>\u914d\u7f6e </li> </ul>"},{"location":"chap12/2chap12_mon_es/#3-1-stats","title":"3-1 stats","text":"<p>Node Stats\uff1a</p> <pre><code># Node Stats\uff1a\nGET _nodes/stats\n\n{\n  \"_nodes\" : {\n    \"total\" : 2,\n    \"successful\" : 2,\n    \"failed\" : 0\n  },\n  \"cluster_name\" : \"jx\",\n  \"nodes\" : {\n    \"y6Kvg6woTbCuDNQJjubBHw\" : {\n      \"timestamp\" : 1606292261685,\n      \"name\" : \"node2\",\n      \"transport_address\" : \"172.16.72.169:9301\",\n      \"host\" : \"172.16.72.169\",\n      \"ip\" : \"172.16.72.169:9301\",\n      \"roles\" : [\n        \"data\",\n        \"ingest\",\n        \"master\",\n        \"ml\",\n        \"remote_cluster_client\",\n        \"transform\"\n      ],\n      \"attributes\" : {\n        \"ml.machine_memory\" : \"3973804032\",\n        \"ml.max_open_jobs\" : \"20\",\n        \"xpack.installed\" : \"true\",\n        \"my_rack_id\" : \"rack1\",\n        \"transform.node\" : \"true\"\n      },\n...\n</code></pre> <p>Cluster Stats:</p> <pre><code>#Cluster Stats:\nGET _cluster/stats\n\n\"indices\" : {\n    \"count\" : 15,\n    \"shards\" : {\n      \"total\" : 28,\n      \"primaries\" : 16,\n      \"replication\" : 0.75,\n      \"index\" : {\n        \"shards\" : {\n          \"min\" : 1,\n          \"max\" : 2,\n          \"avg\" : 1.8666666666666667\n        },\n        \"primaries\" : {\n          \"min\" : 1,\n          \"max\" : 2,\n          \"avg\" : 1.0666666666666667\n        },\n        \"replication\" : {\n          \"min\" : 0.0,\n          \"max\" : 1.0,\n          \"avg\" : 0.8\n        }\n      }\n    },\n</code></pre> <p>Index Stats:</p> <pre><code>#Index Stats:\nGET kibana_sample_data_ecommerce/_stats\n</code></pre>"},{"location":"chap12/2chap12_mon_es/#3-1-tasks","title":"3-1 Tasks","text":"<p>Pending Cluster Tasks API</p> <pre><code>#Pending Cluster Tasks API:\nGET _cluster/pending_tasks\n\n{\n  \"tasks\" : [ ]\n}\n</code></pre> <p>\u67e5\u770b\u6240\u6709\u7684 tasks\uff0c\u4e5f\u652f\u6301 cancel task</p> <pre><code># \u67e5\u770b\u6240\u6709\u7684 tasks\uff0c\u4e5f\u652f\u6301 cancel task\nGET _tasks\n\n{\n  \"nodes\" : {\n    \"y6Kvg6woTbCuDNQJjubBHw\" : {\n      \"name\" : \"node2\",\n      \"transport_address\" : \"172.16.72.169:9301\",\n      \"host\" : \"172.16.72.169\",\n      \"ip\" : \"172.16.72.169:9301\",\n      \"roles\" : [\n        \"data\",\n        \"ingest\",\n        \"master\",\n        \"ml\",\n        \"remote_cluster_client\",\n        \"transform\"\n      ],\n      \"attributes\" : {\n        \"ml.machine_memory\" : \"3973804032\",\n        \"ml.max_open_jobs\" : \"20\",\n        \"xpack.installed\" : \"true\",\n        \"my_rack_id\" : \"rack1\",\n        \"transform.node\" : \"true\"\n      },\n ...\n</code></pre>"},{"location":"chap12/2chap12_mon_es/#3-3-thread_pool","title":"3-3 <code>thread_pool</code>","text":"<pre><code>GET _nodes/thread_pool\nGET _nodes/stats/thread_pool\n</code></pre> <pre><code>GET _cat/thread_pool?v\n\nnode_name name                active queue rejected\nnode2     analyze                  0     0        0\nnode2     ccr                      0     0        0\nnode2     fetch_shard_started      0     0        0\nnode2     fetch_shard_store        0     0        0\nnode2     flush                    0     0        0\nnode2     force_merge              0     0        0\nnode2     generic                  0     0        0\n...\n</code></pre> <pre><code>GET _nodes/hot_threads\n\n::: {node2}{y6Kvg6woTbCuDNQJjubBHw}{uhHvQ8l2RV2m_NATQOkMRA}{172.16.72.169}{172.16.72.169:9301}{dilmrt}{ml.machine_memory=3973804032, ml.max_open_jobs=20, xpack.installed=true, my_rack_id=rack1, transform.node=true}\n   Hot threads at 2020-11-25T08:35:08.208Z, interval=500ms, busiestThreads=3, ignoreIdleThreads=true:\n\n::: {node1}{V1WpUCM4QzKEF0CrRG2BYA}{g6rlxUB-RduMoha2VcRdvg}{172.16.72.169}{172.16.72.169:9300}{dilmrt}{ml.machine_memory=3973804032, xpack.installed=true, transform.node=true, ml.max_open_jobs=20, my_rack_id=rack1}\n   Hot threads at 2020-11-25T08:35:08.206Z, interval=500ms, busiestThreads=3, ignoreIdleThreads=true:\n</code></pre> <pre><code>GET _nodes/stats/thread_pool\n</code></pre>"},{"location":"chap12/2chap12_mon_es/#3-4-index-slowlogs","title":"3-4 Index Slowlogs","text":"<ul> <li>\u8bbe\u7f6e Index Slowlogs</li> <li>The first 1000 characters of the doc's source will be logged</li> </ul> <pre><code>PUT my_index\n\nPUT my_index/_settings\n{\n  \"index.indexing.slowlog\":{\n    \"threshold.index\":{\n      \"warn\":\"10s\",\n      \"info\": \"4s\",\n      \"debug\":\"2s\",\n      \"trace\":\"0s\"\n    },\n    \"level\":\"trace\",\n    \"source\":1000  \n  }\n}\n</code></pre>"},{"location":"chap12/2chap12_mon_es/#3-5","title":"3-5 \u8bbe\u7f6e\u67e5\u8be2","text":"<pre><code># \u8bbe\u7f6e\u67e5\u8be2\nDELETE my_index\n\n# \"0\" logs all queries\nPUT my_index/\n{\n  \"settings\": {\n    \"index.search.slowlog.threshold\": {\n      \"query.warn\": \"10s\",\n      \"query.info\": \"3s\",\n      \"query.debug\": \"2s\",\n      \"query.trace\": \"0s\",\n      \"fetch.warn\": \"1s\",\n      \"fetch.info\": \"600ms\",\n      \"fetch.debug\": \"400ms\",\n      \"fetch.trace\": \"0s\"\n    }\n  }\n}\n</code></pre> <pre><code>GET my_index\n\n{\n  \"my_index\" : {\n    \"aliases\" : { },\n    \"mappings\" : { },\n    \"settings\" : {\n      \"index\" : {\n        \"search\" : {\n          \"slowlog\" : {\n            \"threshold\" : {\n              \"fetch\" : {\n                \"warn\" : \"1s\",\n                \"trace\" : \"0s\",\n                \"debug\" : \"400ms\",\n                \"info\" : \"600ms\"\n              },\n              \"query\" : {\n                \"warn\" : \"10s\",\n                \"trace\" : \"0s\",\n                \"debug\" : \"2s\",\n                \"info\" : \"3s\"\n              }\n            }\n          }\n        },\n        \"number_of_shards\" : \"1\",\n        \"provided_name\" : \"my_index\",\n        \"creation_date\" : \"1606293512411\",\n        \"number_of_replicas\" : \"1\",\n        \"uuid\" : \"qq59K9bGQomixy36uXYHnA\",\n        \"version\" : {\n          \"created\" : \"7090299\"\n        }\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"chap12/3chap12_es_diag/","title":"\u7b2c\u4e09\u8282 \u8bca\u65ad\u96c6\u7fa4\u7684\u6f5c\u5728\u95ee\u9898","text":""},{"location":"chap12/3chap12_es_diag/#1","title":"1\u3001\u96c6\u7fa4\u8fd0\u7ef4\u6240\u9762\u4e34\u7684\u6311\u6218","text":"<ul> <li>\u7528\u6237\u96c6\u7fa4\u6570\u91cf\u591a\uff0c\u4e1a\u52a1\u573a\u666f\u5dee\u5f02\u5927</li> <li>\u4f7f\u7528\u4e0e\u914d\u7f6e\u4e0d\u5f53\uff0c\u4f18\u5316\u4e0d\u591f<ul> <li>\u5982\u4f55\u8ba9\u7528\u6237\u66f4\u52a0\u9ad8\u6548\u548c\u6b63\u786e\u7684\u4f7f\u7528 ES</li> <li>\u5982\u4f55\u8ba9\u7528\u6237\u66f4\u5168\u9762\u7684\u4e86\u89e3\u81ea\u5df1\u7684\u96c6\u7fa4\u7684\u4f7f\u7528\u72b6\u51b5</li> </ul> </li> <li>\u53d1\u73b0\u95ee\u9898\u6ede\u540e\uff0c\u9700\u8981\u9632\u60a3\u4e8e\u672a\u7136<ul> <li>\u9700\u8981\u201c\u6709\u8ff9\u53ef\u5faa\u201d\uff0c\u505a\u5230\u201c\u6709\u5219\u6539\u4e4b\uff0c\u65e0\u5219\u52a0\u52c9\u201d</li> <li>Elastic \u6709\u63d0\u4f9b Support Diagnostics Tool - https://github.com/elastic/support-diagnostics </li> </ul> </li> </ul>"},{"location":"chap12/3chap12_es_diag/#2","title":"2\u3001\u96c6\u7fa4\u7eff\u8272\uff0c\u662f\u5426\u610f\u5473\u7740\u8db3\u591f\u597d","text":"<ul> <li>\u7eff\u8272\u53ea\u662f\u5176\u4e2d\u4e00\u9879\u6307\u6807\u3002\u663e\u793a\u5206\u7247\u662f\u5426\u90fd\u5df2\u6b63\u5e38\u5206\u914d</li> <li>\u76d1\u63a7\u6307\u6807\u591a\u5e76\u4e14\u5206\u6563<ul> <li>\u6307\u6807\u7684\u542b\u4e49\u4e0d\u591f\u660e\u786e\u76f4\u89c2</li> </ul> </li> <li>\u95ee\u9898\u5206\u6790\u5b9a\u4f4d\u7684\u95e8\u69db\u8f83\u9ad8<ul> <li>\u9700\u8981\u5177\u5907\u4e13\u4e1a\u77e5\u8bc6</li> </ul> </li> </ul>"},{"location":"chap12/3chap12_es_diag/#3","title":"3\u3001\u4e3a\u4ec0\u4e48\u8981\u8bca\u65ad\u96c6\u7fa4\u7684\u6f5c\u5728\u95ee\u9898","text":"<ul> <li>\u9632\u60a3\u4e8e\u672a\u7136\uff0c\u907f\u514d\u96c6\u7fa4\u5954\u6e83<ul> <li>Master \u8282\u70b9 / \u6570\u636e\u8282\u70b9\u5f53\u673a \u2013 \u8d1f\u8f7d\u8fc7\u9ad8\uff0c\u5bfc\u81f4\u8282\u70b9\u5931\u8054</li> <li>\u526f\u672c\u4e22\u5931\uff0c\u5bfc\u81f4\u6570\u636e\u53ef\u9760\u6027\u53d7\u635f</li> <li>\u96c6\u7fa4\u538b\u529b\u8fc7\u5927\uff0c\u6570\u636e\u5199\u5165\u5931\u8d25</li> </ul> </li> <li>\u63d0\u5347\u96c6\u7fa4\u6027\u80fd<ul> <li>\u6570\u636e\u8282\u70b9\u8d1f\u8f7d\u4e0d\u5747\u8861(\u907f\u514d\u5355\u8282\u70b9\u74f6\u9888) / \u4f18\u5316\u5206\u7247\uff0csegment</li> <li>\u89c4\u8303\u64cd\u4f5c\u65b9\u5f0f(\u5229\u7528\u522b\u540d / \u907f\u514d Dynamic Mapping \u5f15\u53d1\u8fc7\u591a\u5b57\u6bb5\uff0c\u5bf9\u7d22\u5f15\u7684\u5408\u7406\u6027\u8fdb\u884c\u7ba1\u63a7) </li> </ul> </li> </ul>"},{"location":"chap12/3chap12_es_diag/#4ebay-diagnostic-tool","title":"4\u3001eBay Diagnostic Tool","text":"<ul> <li>\u96c6\u7fa4\u5065\u5eb7\u72b6\u6001\uff0c\u662f\u5426\u6709\u8282\u70b9\u4e22\u5931</li> <li>\u7d22\u5f15\u5408\u7406\u6027<ul> <li>\u7d22\u5f15\u603b\u6570\u4e0d\u80fd\u8fc7\u5927 </li> <li>\u526f\u672c\u5206\u7247\u5c3d\u91cf\u4e0d\u8981\u8bbe\u7f6e\u4e3a 0 </li> <li>\u4e3b\u5206\u7247\u5c3a\u5bf8\u68c0\u6d4b </li> <li>\u7d22\u5f15\u7684\u5b57\u6bb5\u603b\u6570(Dynamic Mapping \u5173\u95ed)</li> <li>\u7d22\u5f15\u662f\u5426\u5206\u914d\u4e0d\u5747\u8861 </li> <li>\u7d22\u5f15 segment \u5927\u5c0f\u8bca\u65ad\u5206\u6790</li> </ul> </li> <li>\u8d44\u6e90\u4f7f\u7528\u5408\u7406\u6027<ul> <li>CPU \u5185\u5b58\u548c \u78c1\u76d8\u7684\u4f7f\u7528\u72b6\u51b5\u5206\u6790 </li> <li>\u662f\u5426\u5b58\u5728\u8282\u70b9\u8d1f\u8f7d\u4e0d\u5e73\u8861 </li> <li>\u662f\u5426\u9700\u8981\u589e\u52a0\u8282\u70b9</li> </ul> </li> <li>\u4e1a\u52a1\u64cd\u4f5c\u5408\u7406\u6027<ul> <li>\u96c6\u7fa4\u72b6\u6001\u53d8\u66f4\u9891\u7387\uff0c\u662f\u5426\u5728\u4e1a\u52a1\u9ad8\u5cf0\u671f\u6709\u9891\u7e41\u64cd\u4f5c</li> <li>\u6162\u67e5\u8be2\u76d1\u63a7\u4e0e\u5206\u6790</li> </ul> </li> </ul> <p>\u96c6\u7fa4\u4e2d\u7d22\u5f15\u7684\u8bca\u65ad</p> <ul> <li>\u7d22\u5f15\u7684\u603b\u6570\u662f\u5426\u8fc7\u5927</li> <li>\u662f\u5426\u5b58\u5728\u5b57\u6bb5\u8fc7\u591a\u7684\u60c5\u51b5</li> <li>\u7d22\u5f15\u7684\u5206\u7247\u4e2a\u6570\u662f\u5426\u8bbe\u7f6e\u5408\u7406</li> <li>\u5355\u4e2a\u8282\u70b9\u7684\u5206\u7247\u6570\u662f\u5426\u8fc7\u591a</li> <li>\u6570\u636e\u8282\u70b9\u4e4b\u95f4\u7684\u8d1f\u8f7d\u504f\u5dee\u662f\u5426\u8fc7\u5927</li> <li>\u51b7\u70ed\u6570\u636e\u5206\u914d\u662f\u5426\u6b63\u786e(\u4f8b\u5982\uff0cCold \u8282\u70b9\u4e0a\u7684\u7d22\u5f15\u662f\u5426\u8bbe\u7f6e\u6210\u53ea\u8bfb)</li> </ul>"},{"location":"chap12/3chap12_es_diag/#5-eyou","title":"5\u3001\u963f\u91cc\u4e91 \u2013 EYOU \u667a\u80fd\u8fd0\u7ef4\u5de5\u5177","text":"<p>\u6bcf\u5929\u51cc\u6668\u5b9a\u65f6\u8bca\u65ad\uff0c\u4e5f\u53ef\u4ee5\u81ea\u4e3b\u8bca\u65ad\u3002\u6bcf\u6b21\u8bca\u65ad\u8017\u65f6 3 \u5206\u949f -</p> <p> https://help.aliyun.com/document_detail/90391.html</p> <p></p>"},{"location":"chap12/3chap12_es_diag/#5-1-shard","title":"5-1 \u8bca\u65ad Shard \u6570","text":""},{"location":"chap12/3chap12_es_diag/#5-2","title":"5-2 \u78c1\u76d8\u5bb9\u91cf\u4f30\u7b97","text":""},{"location":"chap12/3chap12_es_diag/#6","title":"6\u3001\u591a\u7ef4\u5ea6\u68c0\u6d4b\uff0c\u6784\u5efa\u81ea\u5df1\u7684\u8bca\u65ad\u5de5\u5177","text":""},{"location":"chap12/4chap12_es_red_yellow/","title":"\u7b2c\u56db\u8282 \u89e3\u51b3\u96c6\u7fa4 Yellow \u4e0e Red \u7684\u95ee\u9898","text":""},{"location":"chap12/4chap12_es_red_yellow/#1","title":"1\u3001\u96c6\u7fa4\u5065\u5eb7\u5ea6","text":"<p>\u5206\u7247\u5065\u5eb7</p> <ul> <li>\u7ea2:\u81f3\u5c11\u6709\u4e00\u4e2a\u4e3b\u5206\u7247\u6ca1\u6709\u5206\u914d </li> <li>\u9ec4:\u81f3\u5c11\u6709\u4e00\u4e2a\u526f\u672c\u6ca1\u6709\u5206\u914d </li> <li>\u7eff:\u4e3b\u526f\u672c\u5206\u7247\u5168\u90e8\u6b63\u5e38\u5206\u914d</li> </ul> <p>\u7d22\u5f15\u5065\u5eb7: \u6700\u5dee\u7684\u5206\u7247\u7684\u72b6\u6001</p> <p>\u96c6\u7fa4\u5065\u5eb7: \u6700\u5dee\u7684\u7d22\u5f15\u7684\u72b6\u6001</p> <p></p>"},{"location":"chap12/4chap12_es_red_yellow/#2health-api","title":"2\u3001Health \u76f8\u5173\u7684 API","text":"<ul> <li><code>GET _cluster/health</code>: \u96c6\u7fa4\u7684\u72b6\u6001(\u68c0\u67e5\u8282\u70b9\u6570\u91cf)</li> <li><code>GET _cluster/health?level=indices</code>: \u6240\u6709\u7d22\u5f15\u7684\u5065\u5eb7\u72b6\u6001 (\u67e5\u770b\u6709\u95ee\u9898\u7684\u7d22\u5f15)</li> <li><code>GET _cluster/health/my_index</code>: \u5355\u4e2a\u7d22\u5f15\u7684\u5065\u5eb7\u72b6\u6001(\u67e5\u770b\u5177\u4f53\u7684\u7d22\u5f15)</li> <li><code>GET _cluster/health?level=shards</code>: \u5206\u7247\u7ea7\u7684\u7d22\u5f15</li> <li><code>GET _cluster/allocation/explain</code>: \u8fd4\u56de\u7b2c\u4e00\u4e2a\u672a\u5206\u914d Shard \u7684\u539f\u56e0</li> </ul>"},{"location":"chap12/4chap12_es_red_yellow/#3-1-1","title":"3-1 \u6848\u4f8b 1","text":"<ul> <li>\u75c7\u72b6:\u96c6\u7fa4\u53d8\u7ea2</li> <li>\u5206\u6790:\u901a\u8fc7 Allocation Explain API \u53d1\u73b0\u521b\u5efa\u7d22\u5f15\u5931\u8d25\uff0c\u56e0\u4e3a\u65e0\u6cd5\u627e\u5230\u6807\u8bb0\u4e86\u76f8\u5e94 box type \u7684\u8282\u70b9</li> <li>\u89e3\u51b3:<ul> <li>\u5220\u9664\u7d22\u5f15\uff0c\u96c6\u7fa4\u53d8\u7eff\u3002</li> <li>\u91cd\u65b0\u521b\u5efa\u7d22\u5f15\uff0c\u5e76\u4e14\u6307\u5b9a\u6b63\u786e\u7684 routing box type\uff0c\u7d22\u5f15\u521b\u5efa\u6210\u529f\u3002</li> <li>\u96c6\u7fa4\u4fdd\u6301\u7eff\u8272\u72b6\u6001</li> </ul> </li> </ul>"},{"location":"chap12/4chap12_es_red_yellow/#3-2-2","title":"3-2 \u6848\u4f8b 2","text":"<ul> <li>\u75c7\u72b6:\u96c6\u7fa4\u53d8\u9ec4</li> <li>\u5206\u6790:\u901a\u8fc7 Allocation Explain API \u53d1\u73b0\u65e0\u6cd5\u5728\u76f8\u540c\u7684\u8282\u70b9\u4e0a\u521b\u5efa\u526f\u672c</li> <li>\u89e3\u51b3:\u5c06\u7d22\u5f15\u7684\u526f\u672c\u6570\u8bbe\u7f6e\u4e3a 0\uff0c\u6216\u8005\u901a\u8fc7\u589e\u52a0\u8282\u70b9\u89e3\u51b3</li> </ul>"},{"location":"chap12/4chap12_es_red_yellow/#3","title":"3\u3001\u5206\u7247\u6ca1\u6709\u88ab\u5206\u914d\u7684\u4e00\u4e9b\u539f\u56e0","text":"<ul> <li><code>INDEX_CREATE</code>: \u521b\u5efa\u7d22\u5f15\u5bfc\u81f4\u3002\u5728\u7d22\u5f15\u7684\u5168\u90e8\u5206\u7247\u5206\u914d\u5b8c\u6210\u4e4b\u524d\uff0c\u4f1a\u6709\u77ed\u6682\u7684 Red\uff0c\u4e0d\u4e00\u5b9a\u4ee3\u8868\u6709\u95ee\u9898</li> <li><code>INDEX_REOPEN</code>:Open \u4e00\u4e2a\u4e4b\u524d Close \u7684\u7d22\u5f15</li> <li><code>CLUSTER_RECOVER</code>:\u96c6\u7fa4\u91cd\u542f\u9636\u6bb5\uff0c\u4f1a\u6709\u8fd9\u4e2a\u95ee\u9898</li> <li><code>DANGLING_INDEX_IMPORTED</code>:\u4e00\u4e2a\u8282\u70b9\u79bb\u5f00\u96c6\u7fa4\u671f\u95f4\uff0c\u6709\u7d22\u5f15\u88ab\u5220\u9664\u3002\u8fd9\u4e2a\u8282\u70b9\u91cd\u65b0\u8fd4\u56de\u65f6\uff0c\u4f1a \u5bfc\u81f4 Dangling \u7684\u95ee\u9898: <ul> <li>\u89e3\u51b3\u95ee\u9898\uff1a \u5220\u9664\u6389\u7d22\u5f15</li> </ul> </li> </ul> <p>https://www.elastic.co/guide/en/elasticsearch/reference/7.1/cat-shards.html</p>"},{"location":"chap12/4chap12_es_red_yellow/#4","title":"4\u3001\u5e38\u89c1\u95ee\u9898\u4e0e\u89e3\u51b3\u65b9\u6cd5\u5e38\u89c1\u95ee\u9898\u4e0e\u89e3\u51b3\u65b9\u6cd5","text":"<ul> <li>\u96c6\u7fa4\u53d8\u7ea2\uff0c\u9700\u8981\u68c0\u67e5\u662f\u5426\u6709\u8282\u70b9\u79bb\u7ebf\u3002\u5982\u679c\u6709\uff0c\u901a\u5e38\u901a\u8fc7\u91cd\u542f\u79bb\u7ebf\u7684\u8282\u70b9\u53ef\u4ee5\u89e3\u51b3\u95ee\u9898</li> <li>\u7531\u4e8e\u914d\u7f6e\u5bfc\u81f4\u7684\u95ee\u9898\uff0c\u9700\u8981\u4fee\u590d\u76f8\u5173\u7684\u914d\u7f6e(\u4f8b\u5982\u9519\u8bef\u7684 <code>box_type</code>\uff0c\u9519\u8bef\u7684\u526f\u672c\u6570)<ul> <li>\u5982\u679c\u662f\u6d4b\u8bd5\u7684\u7d22\u5f15\uff0c\u53ef\u4ee5\u76f4\u63a5\u5220\u9664</li> </ul> </li> <li>\u56e0\u4e3a\u78c1\u76d8\u7a7a\u95f4\u9650\u5236\uff0c\u5206\u7247\u89c4\u5219(Shard Filtering)\u5f15\u53d1\u7684\uff0c\u9700\u8981\u8c03\u6574\u89c4\u5219\u6216\u8005\u589e\u52a0\u8282\u70b9</li> <li>\u5bf9\u4e8e\u8282\u70b9\u8fd4\u56de\u96c6\u7fa4\uff0c\u5bfc\u81f4\u7684 dangling \u53d8\u7ea2\uff0c\u53ef\u76f4\u63a5\u5220\u9664 dangling \u7d22\u5f15</li> </ul> <p>dangling\u51fa\u73b0\u7684\u60c5\u51b5\u662f\uff0c\u7528\u6237\u5220\u9664\u4e00\u4e2a\u7d22\u5f15a\uff0c\u5220\u9664\u7684\u65f6\u5019\u6070\u597dnodeA \u5173\u673a\u4e86\uff0c\u6216\u8005\u56e0\u4e3a\u4e00\u4e9b\u539f\u56e0\uff0c\u79bb\u5f00\u4e86\u96c6\u7fa4\u3002\u8fd9\u4e2a\u65f6\u5019\u7d22\u5f15a\u88ab\u5220\u9664\u4e86\u3002\u7136\u540eNodeA\u53c8\u56de\u6765\u4e86\uff0cNodeA\u91cc\u9762\u5e26\u6709\u7d22\u5f15a\u7684\u5206\u7247\uff0c\u8fd9\u6837\u7684\u573a\u666f\u4e0b\u4f1a\u5bfc\u81f4\u96c6\u7fa4\u53d8\u7ea2\u3002\u800c\u7d22\u5f15a\u672c\u6765\u5c31\u662f\u7528\u6237\u5e0c\u671bdelete\u7684\uff0c\u53ea\u662f\u6ca1delete\u5e72\u51c0\uff0c\u6240\u4ee5\u4e0d\u5b58\u5728\u4f60\u8bf4\u7684\u4e22\u6570\u636e\u7684\u60c5\u51b5\u3002</p>"},{"location":"chap12/4chap12_es_red_yellow/#5-red-yellow","title":"5\u3001\u96c6\u7fa4 Red &amp; Yellow \u95ee\u9898\u7684\u603b\u7ed3","text":"<ul> <li>Red &amp; Yellow \u662f\u96c6\u7fa4\u8fd0\u7ef4\u4e2d\u5e38\u89c1\u7684\u95ee\u9898</li> <li>\u9664\u4e86\u96c6\u7fa4\u6545\u969c\uff0c\u4e00\u4e9b\u521b\u5efa\uff0c\u589e\u52a0\u526f\u672c\u7b49\u64cd\u4f5c\uff0c \u90fd\u4f1a\u5bfc\u81f4\u96c6\u7fa4\u77ed\u6682\u7684 Red \u548c Yellow\uff0c\u6240\u4ee5 \u76d1\u63a7\u548c\u62a5\u8b66\u65f6\u9700\u8981\u8bbe\u7f6e\u4e00\u5b9a\u7684\u5ef6\u65f6</li> <li>\u901a\u8fc7\u68c0\u67e5\u8282\u70b9\u6570\uff0c\u4f7f\u7528 ES \u63d0\u4f9b\u7684\u76f8\u5173 API\uff0c \u627e\u5230\u771f\u6b63\u7684\u539f\u56e0</li> <li>\u53ef\u4ee5\u6307\u5b9a Move \u6216\u8005 Reallocate \u5206\u7247</li> </ul>"},{"location":"chap12/4chap12_es_red_yellow/#6","title":"6\u3001\u64cd\u4f5c\u5b9e\u9a8c","text":""},{"location":"chap12/4chap12_es_red_yellow/#6-1-hot-warm-cold","title":"6-1 \u542f\u52a8<code>hot-warm-cold</code>\u96c6\u7fa4","text":"<p><code>docker-compose.yaml</code></p> <pre><code>version: '2.2'\nservices:\n  cerebro:\n    image: lmenezes/cerebro:0.8.3\n    container_name: hwc_cerebro\n    ports:\n      - \"9000:9000\"\n    command:\n      - -Dhosts.0.host=http://elasticsearch:9200\n    networks:\n      - hw_hwc_es7net\n  kibana:\n    image: docker.elastic.co/kibana/kibana:7.9.1\n    container_name: hwc_kibana7\n    environment:\n      #- I18N_LOCALE=zh-CN\n      - XPACK_GRAPH_ENABLED=true\n      - TIMELION_ENABLED=true\n      - XPACK_MONITORING_COLLECTION_ENABLED=\"true\"\n    ports:\n      - \"5601:5601\"\n    networks:\n      - hw_hwc_es7net\n  elasticsearch:\n    image: docker.elastic.co/elasticsearch/elasticsearch:7.9.1\n    container_name: es7_hot\n    environment:\n      - cluster.name=es-hwc\n      - node.name=es7_hot\n      - node.attr.box_type=hot\n      - bootstrap.memory_lock=true\n      - \"ES_JAVA_OPTS=-Xms512m -Xmx512m\"\n      - discovery.seed_hosts=es7_hot,es7_warm,es7_cold\n      - cluster.initial_master_nodes=es7_hot,es7_warm,es7_cold\n    ulimits:\n      memlock:\n        soft: -1\n        hard: -1\n    volumes:\n      - hwc_es7data_hot:/usr/share/elasticsearch/data\n    ports:\n      - 9200:9200\n    networks:\n      - hw_hwc_es7net\n  elasticsearch2:\n    image: docker.elastic.co/elasticsearch/elasticsearch:7.9.1\n    container_name: es7_warm\n    environment:\n      - cluster.name=es-hwc\n      - node.name=es7_warm\n      - node.attr.box_type=warm\n      - bootstrap.memory_lock=true\n      - \"ES_JAVA_OPTS=-Xms512m -Xmx512m\"\n      - discovery.seed_hosts=es7_hot,es7_warm,es7_cold\n      - cluster.initial_master_nodes=es7_hot,es7_warm,es7_cold\n    ulimits:\n      memlock:\n        soft: -1\n        hard: -1\n    volumes:\n      - hwc_es7data_warm:/usr/share/elasticsearch/data\n    networks:\n      - hw_hwc_es7net\n  elasticsearch3:\n    image: docker.elastic.co/elasticsearch/elasticsearch:7.9.1\n    container_name: es7_cold\n    environment:\n      - cluster.name=es-hwc\n      - node.name=es7_cold\n      - node.attr.box_type=cold\n      - bootstrap.memory_lock=true\n      - \"ES_JAVA_OPTS=-Xms512m -Xmx512m\"\n      - discovery.seed_hosts=es7_hot,es7_warm,es7_cold\n      - cluster.initial_master_nodes=es7_hot,es7_warm,es7_cold\n    ulimits:\n      memlock:\n        soft: -1\n        hard: -1\n    volumes:\n      - hwc_es7data_cold:/usr/share/elasticsearch/data\n    networks:\n      - hw_hwc_es7net\n\n\nvolumes:\n  hwc_es7data_hot:\n    driver: local\n  hwc_es7data_warm:\n    driver: local\n  hwc_es7data_cold:\n    driver: local\n\nnetworks:\n  # hwc_es7net:\n  hw_hwc_es7net:\n    driver: bridge\n</code></pre> <pre><code>docker-compose up -d\n</code></pre> <pre><code>http://192.168.33.12:9200/_cat/nodes?v\n\nip         heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name\n172.19.0.6           27          95  54    1.88    3.85     2.20 dilmrt    -      es7_hot\n172.19.0.2           46          95  54    1.88    3.85     2.20 dilmrt    -      es7_cold\n172.19.0.4           45          95  54    1.88    3.85     2.20 dilmrt    *      es7_warm\n</code></pre> <pre><code>http://192.168.33.12:9200/_cat/shards?v\n\nindex                          shard prirep state   docs   store ip         node\n.kibana_task_manager_1         0     p      STARTED    6 102.6kb 172.19.0.2 es7_cold\n.kibana_task_manager_1         0     r      STARTED    6  83.5kb 172.19.0.4 es7_warm\nilm-history-2-000001           0     p      STARTED              172.19.0.6 es7_hot\nilm-history-2-000001           0     r      STARTED              172.19.0.4 es7_warm\n.kibana-event-log-7.9.1-000001 0     r      STARTED    1   5.4kb 172.19.0.2 es7_cold\n.kibana-event-log-7.9.1-000001 0     p      STARTED    1   5.4kb 172.19.0.6 es7_hot\n.kibana_1                      0     r      STARTED    8  10.4mb 172.19.0.2 es7_cold\n.kibana_1                      0     p      STARTED    8  10.4mb 172.19.0.6 es7_hot\n.apm-agent-configuration       0     p      STARTED    0    208b 172.19.0.6 es7_hot\n.apm-agent-configuration       0     r      STARTED    0    208b 172.19.0.4 es7_warm\n.apm-custom-link               0     r      STARTED    0    208b 172.19.0.2 es7_cold\n.apm-custom-link               0     p      STARTED    0    208b 172.19.0.4 es7_warm\n</code></pre>"},{"location":"chap12/4chap12_es_red_yellow/#6-2-1","title":"6-2 \u6848\u4f8b 1 \u75c7\u72b6:\u96c6\u7fa4\u53d8\u7ea2","text":"<pre><code>#\u6848\u4f8b1\nDELETE mytest\nPUT mytest\n{\n  \"settings\":{\n    \"number_of_shards\":3,\n    \"number_of_replicas\":0,\n    \"index.routing.allocation.require.box_type\":\"hott\"\n  }\n}\n</code></pre> <p><code>\"index.routing.allocation.require.box_type\":\"hott\"</code></p> <pre><code># \u68c0\u67e5\u96c6\u7fa4\u72b6\u6001\uff0c\u67e5\u770b\u662f\u5426\u6709\u8282\u70b9\u4e22\u5931\uff0c\u6709\u591a\u5c11\u5206\u7247\u65e0\u6cd5\u5206\u914d\nGET /_cluster/health/\n</code></pre> <p>Output:</p> <pre><code>{\n  \"cluster_name\" : \"es-hwc\",\n  \"status\" : \"red\",\n  \"timed_out\" : false,\n  \"number_of_nodes\" : 3,\n  \"number_of_data_nodes\" : 3,\n  \"active_primary_shards\" : 6,\n  \"active_shards\" : 12,\n  \"relocating_shards\" : 0,\n  \"initializing_shards\" : 0,\n  \"unassigned_shards\" : 3,\n  \"delayed_unassigned_shards\" : 0,\n  \"number_of_pending_tasks\" : 0,\n  \"number_of_in_flight_fetch\" : 0,\n  \"task_max_waiting_in_queue_millis\" : 0,\n  \"active_shards_percent_as_number\" : 80.0\n}\n</code></pre> <p>\u67e5\u770b\u7d22\u5f15\u7ea7\u522b,\u627e\u5230\u7ea2\u8272\u7684\u7d22\u5f15</p> <pre><code># \u67e5\u770b\u7d22\u5f15\u7ea7\u522b,\u627e\u5230\u7ea2\u8272\u7684\u7d22\u5f15\nGET /_cluster/health?level=indices\n\n{\n  \"cluster_name\" : \"es-hwc\",\n  \"status\" : \"red\",\n  \"timed_out\" : false,\n  \"number_of_nodes\" : 3,\n  \"number_of_data_nodes\" : 3,\n  \"active_primary_shards\" : 6,\n  \"active_shards\" : 12,\n  \"relocating_shards\" : 0,\n  \"initializing_shards\" : 0,\n  \"unassigned_shards\" : 3,\n  \"delayed_unassigned_shards\" : 0,\n  \"number_of_pending_tasks\" : 0,\n  \"number_of_in_flight_fetch\" : 0,\n  \"task_max_waiting_in_queue_millis\" : 0,\n  \"active_shards_percent_as_number\" : 80.0,\n  \"indices\" : {\n    \"mytest\" : {\n      \"status\" : \"red\",\n      \"number_of_shards\" : 3,\n      \"number_of_replicas\" : 0,\n      \"active_primary_shards\" : 0,\n      \"active_shards\" : 0,\n      \"relocating_shards\" : 0,\n      \"initializing_shards\" : 0,\n      \"unassigned_shards\" : 3\n    },\n...\n</code></pre> <p>\u67e5\u770b\u7d22\u5f15\u7684\u5206\u7247</p> <pre><code>#\u67e5\u770b\u7d22\u5f15\u7684\u5206\u7247\nGET _cluster/health?level=shards\n\n...\n\"indices\" : {\n    \"mytest\" : {\n      \"status\" : \"red\",\n      \"number_of_shards\" : 3,\n      \"number_of_replicas\" : 0,\n      \"active_primary_shards\" : 0,\n      \"active_shards\" : 0,\n      \"relocating_shards\" : 0,\n      \"initializing_shards\" : 0,\n      \"unassigned_shards\" : 3,\n      \"shards\" : {\n        \"0\" : {\n          \"status\" : \"red\",\n          \"primary_active\" : false,\n          \"active_shards\" : 0,\n          \"relocating_shards\" : 0,\n          \"initializing_shards\" : 0,\n          \"unassigned_shards\" : 1\n        },\n        \"1\" : {\n          \"status\" : \"red\",\n          \"primary_active\" : false,\n          \"active_shards\" : 0,\n          \"relocating_shards\" : 0,\n          \"initializing_shards\" : 0,\n          \"unassigned_shards\" : 1\n        },\n        \"2\" : {\n          \"status\" : \"red\",\n          \"primary_active\" : false,\n          \"active_shards\" : 0,\n          \"relocating_shards\" : 0,\n          \"initializing_shards\" : 0,\n          \"unassigned_shards\" : 1\n        }\n      }\n    },\n...\n</code></pre> <p>Explain \u53d8\u7ea2\u7684\u539f\u56e0</p> <pre><code># Explain \u53d8\u7ea2\u7684\u539f\u56e0\nGET /_cluster/allocation/explain\n</code></pre> <p>Output</p> <pre><code>\"node_allocation_decisions\" : [\n    {\n      \"node_id\" : \"XqZ-rFd8RiuZU2h-u8_s2Q\",\n      \"node_name\" : \"es7_cold\",\n      \"transport_address\" : \"172.19.0.2:9300\",\n      \"node_attributes\" : {\n        \"ml.machine_memory\" : \"3973804032\",\n        \"ml.max_open_jobs\" : \"20\",\n        \"box_type\" : \"cold\",\n        \"xpack.installed\" : \"true\",\n        \"transform.node\" : \"true\"\n      },\n      \"node_decision\" : \"no\",\n      \"weight_ranking\" : 1,\n      \"deciders\" : [\n        {\n          \"decider\" : \"filter\",\n          \"decision\" : \"NO\",\n          \"explanation\" : \"\"\"node does not match index setting [index.routing.allocation.require] filters [box_type:\"hott\"]\"\"\"\n        }\n      ]\n    },\n ...\n ```\n\n ```\nGET /_cat/shards/mytest\n</code></pre> <p>Output:</p> <pre><code>mytest 1 p UNASSIGNED    \nmytest 2 p UNASSIGNED    \nmytest 0 p UNASSIGNED  \n</code></pre> <pre><code>GET _cat/nodeattrs\n</code></pre> <p>Output:</p> <pre><code>es7_hot  172.19.0.6 172.19.0.6 ml.machine_memory 3973804032\nes7_hot  172.19.0.6 172.19.0.6 ml.max_open_jobs  20\nes7_hot  172.19.0.6 172.19.0.6 box_type          hot\nes7_hot  172.19.0.6 172.19.0.6 xpack.installed   true\nes7_hot  172.19.0.6 172.19.0.6 transform.node    true\nes7_cold 172.19.0.2 172.19.0.2 ml.machine_memory 3973804032\nes7_cold 172.19.0.2 172.19.0.2 ml.max_open_jobs  20\nes7_cold 172.19.0.2 172.19.0.2 box_type          cold\nes7_cold 172.19.0.2 172.19.0.2 xpack.installed   true\nes7_cold 172.19.0.2 172.19.0.2 transform.node    true\nes7_warm 172.19.0.4 172.19.0.4 ml.machine_memory 3973804032\nes7_warm 172.19.0.4 172.19.0.4 ml.max_open_jobs  20\nes7_warm 172.19.0.4 172.19.0.4 box_type          warm\nes7_warm 172.19.0.4 172.19.0.4 xpack.installed   true\nes7_warm 172.19.0.4 172.19.0.4 transform.node    true\n</code></pre> <pre><code>DELETE mytest\nGET /_cluster/health/\n</code></pre> <p>Output:</p> <pre><code>{\n  \"cluster_name\" : \"es-hwc\",\n  \"status\" : \"green\",\n  \"timed_out\" : false,\n  \"number_of_nodes\" : 3,\n  \"number_of_data_nodes\" : 3,\n  \"active_primary_shards\" : 6,\n  \"active_shards\" : 12,\n  \"relocating_shards\" : 0,\n  \"initializing_shards\" : 0,\n  \"unassigned_shards\" : 0,\n  \"delayed_unassigned_shards\" : 0,\n  \"number_of_pending_tasks\" : 0,\n  \"number_of_in_flight_fetch\" : 0,\n  \"task_max_waiting_in_queue_millis\" : 0,\n  \"active_shards_percent_as_number\" : 100.0\n}\n</code></pre> <pre><code>PUT mytest\n{\n  \"settings\":{\n    \"number_of_shards\":3,\n    \"number_of_replicas\":0,\n    \"index.routing.allocation.require.box_type\":\"hot\"\n  }\n}\n</code></pre> <pre><code>GET /_cluster/health/\n</code></pre> <pre><code>{\n  \"cluster_name\" : \"es-hwc\",\n  \"status\" : \"green\",\n ...\n</code></pre>"},{"location":"chap12/4chap12_es_red_yellow/#6-3-2-explain-hot-explain","title":"6-3 \u6848\u4f8b2, Explain \u770b hot \u4e0a\u7684 explain","text":"<pre><code>DELETE mytest\n\nPUT mytest\n{\n  \"settings\":{\n    \"number_of_shards\":2,\n    \"number_of_replicas\":1,\n    \"index.routing.allocation.require.box_type\":\"hot\"\n  }\n}\n</code></pre> <pre><code>GET _cluster/health\n\n{\n  \"cluster_name\" : \"es-hwc\",\n  \"status\" : \"yellow\",\n  \"timed_out\" : false,\n</code></pre> <pre><code>GET _cat/shards/mytest\n\nmytest 1 p STARTED    0 208b 172.19.0.6 es7_hot\nmytest 1 r UNASSIGNED                   \nmytest 0 p STARTED    0 208b 172.19.0.6 es7_hot\nmytest 0 r UNASSIGNED    \n</code></pre> <pre><code>GET /_cluster/allocation/explain\n\n\n...\n  \"node_allocation_decisions\" : [\n    {\n      \"node_id\" : \"XqZ-rFd8RiuZU2h-u8_s2Q\",\n      \"node_name\" : \"es7_cold\",\n      \"transport_address\" : \"172.19.0.2:9300\",\n      \"node_attributes\" : {\n        \"ml.machine_memory\" : \"3973804032\",\n        \"ml.max_open_jobs\" : \"20\",\n        \"box_type\" : \"cold\",\n        \"xpack.installed\" : \"true\",\n        \"transform.node\" : \"true\"\n      },\n      \"node_decision\" : \"no\",\n      \"weight_ranking\" : 1,\n      \"deciders\" : [\n        {\n          \"decider\" : \"filter\",\n          \"decision\" : \"NO\",\n          \"explanation\" : \"\"\"node does not match index setting [index.routing.allocation.require] filters [box_type:\"hot\"]\"\"\"\n        }\n      ]\n    },\n...\n</code></pre>"},{"location":"chap12/5chap12_es_cluster_perf/","title":"\u7b2c\u4e94\u8282 \u96c6\u7fa4\u5199\u6027\u80fd\u4f18\u5316","text":""},{"location":"chap12/5chap12_es_cluster_perf/#1","title":"1\u3001\u96c6\u7fa4\u5199\u6027\u80fd\u4f18\u5316","text":""},{"location":"chap12/5chap12_es_cluster_perf/#1-1","title":"1-1 \u63d0\u9ad8\u5199\u5165\u6027\u80fd\u7684\u65b9\u6cd5","text":"<ul> <li>\u5199\u6027\u80fd\u4f18\u5316\u7684\u76ee\u6807:\u589e\u5927\u5199\u541e\u5410\u91cf(Events Per Second)\uff0c\u8d8a\u9ad8\u8d8a\u597d</li> <li>\u5ba2\u6237\u7aef:\u591a\u7ebf\u7a0b\uff0c\u6279\u91cf\u5199<ul> <li>\u53ef\u4ee5\u901a\u8fc7\u6027\u80fd\u6d4b\u8bd5\uff0c\u786e\u5b9a\u6700\u4f73\u6587\u6863\u6570\u91cf</li> <li>\u591a\u7ebf\u7a0b:\u9700\u8981\u89c2\u5bdf\u662f\u5426\u6709 HTTP 429 \u8fd4\u56de\uff0c\u5b9e\u73b0 Retry \u4ee5\u53ca\u7ebf\u7a0b\u6570\u91cf\u7684\u81ea\u52a8\u8c03\u8282</li> </ul> </li> </ul> <p>The HTTP 429 Too Many Requests response status code indicates the user has sent too many requests in a given amount of time (\"rate limiting\").</p> <ul> <li>\u670d\u52a1\u5668\u7aef: \u5355\u4e2a\u6027\u80fd\u95ee\u9898\uff0c\u5f80\u5f80\u662f\u591a\u4e2a\u56e0\u7d20\u9020\u6210\u7684\u3002\u9700\u8981\u5148\u5206\u89e3\u95ee\u9898\uff0c\u5728\u5355\u4e2a\u8282\u70b9\u4e0a\u8fdb\u884c\u8c03\u6574\u5e76\u4e14\u7ed3\u5408\u6d4b\u8bd5\uff0c\u5c3d\u53ef\u80fd\u538b\u69a8\u786c\u4ef6\u8d44\u6e90\uff0c\u4ee5\u8fbe\u5230\u6700\u9ad8\u541e\u5410\u91cf<ul> <li>\u4f7f\u7528\u66f4\u597d\u7684\u786c\u4ef6\u3002\u89c2\u5bdf CPU / IO Block</li> <li>\u7ebf\u7a0b\u5207\u6362 / \u5806\u6808\u72b6\u51b5</li> </ul> </li> </ul>"},{"location":"chap12/5chap12_es_cluster_perf/#1-2","title":"1-2 \u670d\u52a1\u5668\u7aef\u4f18\u5316\u5199\u5165\u6027\u80fd\u7684\u4e00\u4e9b\u624b\u6bb5","text":"<ul> <li>\u964d\u4f4eIO\u64cd\u4f5c<ul> <li>\u4f7f\u7528 ES \u81ea\u52a8\u751f\u6210\u7684\u6587\u6863 Id </li> <li>\u4e00\u4e9b\u76f8\u5173\u7684 ES \u914d\u7f6e\uff0c\u5982 Refresh Interval</li> </ul> </li> <li>\u964d\u4f4e CPU \u548c\u5b58\u50a8\u5f00\u9500<ul> <li>\u51cf\u5c11\u4e0d\u5fc5\u8981\u5206\u8bcd </li> <li>\u907f\u514d\u4e0d\u9700\u8981\u7684 <code>doc_values</code></li> <li>\u6587\u6863\u7684\u5b57\u6bb5\u5c3d\u91cf\u4fdd\u8bc1\u76f8\u540c\u7684\u987a\u5e8f\uff0c\u53ef\u4ee5\u63d0\u9ad8\u6587\u6863\u7684\u538b\u7f29\u7387 </li> </ul> </li> <li>\u5c3d\u53ef\u80fd\u505a\u5230\u5199\u5165\u548c\u5206\u7247\u7684\u5747\u8861\u8d1f\u8f7d\uff0c\u5b9e\u73b0\u6c34\u5e73\u6269\u5c55<ul> <li>Shard Filtering </li> <li>Write Load Balancer</li> </ul> </li> <li>\u8c03\u6574 Bulk \u7ebf\u7a0b\u6c60\u548c\u961f\u5217</li> </ul>"},{"location":"chap12/5chap12_es_cluster_perf/#1-3","title":"1-3 \u4f18\u5316\u5199\u5165\u6027\u80fd","text":"<ul> <li>ES \u7684\u9ed8\u8ba4\u8bbe\u7f6e\uff0c\u5df2\u7ecf\u7efc\u5408\u8003\u8651\u4e86\u6570\u636e\u53ef\u9760\u6027\uff0c\u641c\u7d22\u7684\u5b9e\u65f6\u6027\u8d28\uff0c\u5199\u5165\u901f\u5ea6\uff0c\u4e00\u822c\u4e0d\u8981\u76f2\u76ee\u4fee\u6539</li> <li>\u4e00\u5207\u4f18\u5316\uff0c\u90fd\u8981\u57fa\u4e8e\u9ad8\u8d28\u91cf\u7684\u6570\u636e\u5efa\u6a21</li> </ul>"},{"location":"chap12/5chap12_es_cluster_perf/#1-4","title":"1-4 \u5173\u95ed\u65e0\u5173\u7684\u529f\u80fd","text":"<ul> <li>\u53ea\u9700\u8981\u805a\u5408\u4e0d\u9700\u8981\u641c\u7d22\uff0c Index \u8bbe\u7f6e\u6210 false</li> <li>\u4e0d\u9700\u8981\u7b97\u5206\uff0c Norms \u8bbe\u7f6e\u6210 false</li> <li>\u4e0d\u8981\u5bf9\u5b57\u7b26\u4e32\u4f7f\u7528\u9ed8\u8ba4\u7684 dynamic mapping\u3002\u5b57\u6bb5\u6570\u91cf\u8fc7\u591a\uff0c\u4f1a\u5bf9\u6027\u80fd\u4ea7\u751f\u6bd4\u8f83\u5927\u7684\u5f71\u54cd</li> <li><code>Index_options</code> \u63a7\u5236\u5728\u521b\u5efa\u5012\u6392\u7d22\u5f15\u65f6\uff0c\u54ea\u4e9b\u5185\u5bb9\u4f1a\u88ab\u6dfb\u52a0\u5230\u5012\u6392\u7d22\u5f15\u4e2d\u3002\u4f18\u5316\u8fd9\u4e9b\u8bbe\u7f6e\uff0c\u4e00\u5b9a\u7a0b\u5ea6\u53ef\u4ee5\u8282\u7ea6 CPU</li> <li>\u5173\u95ed <code>_source</code>\uff0c\u51cf\u5c11 IO \u64cd\u4f5c;(\u9002\u5408\u6307\u6807\u578b\u6570\u636e)</li> </ul>"},{"location":"chap12/5chap12_es_cluster_perf/#1-5","title":"1-5 \u9488\u5bf9\u6027\u80fd\u7684\u53d6\u820d","text":"<p>\u5982\u679c\u9700\u8981\u8ffd\u6c42\u6781\u81f4\u7684\u5199\u5165\u901f\u5ea6\uff0c\u53ef\u4ee5\u727a\u7272\u6570\u636e\u53ef\u9760\u6027\u53ca\u641c\u7d22\u5b9e\u65f6\u6027\u4ee5\u6362\u53d6\u6027\u80fd</p> <ul> <li>\u727a\u7272\u53ef\u9760\u6027:\u5c06\u526f\u672c\u5206\u7247\u8bbe\u7f6e\u4e3a 0\uff0c\u5199\u5165\u5b8c\u6bd5\u518d\u8c03\u6574\u56de\u53bb</li> <li>\u727a\u7272\u641c\u7d22\u5b9e\u65f6\u6027:\u589e\u52a0 Refresh Interval \u7684\u65f6\u95f4</li> <li>\u727a\u7272\u53ef\u9760\u6027:\u4fee\u6539 Translog \u7684\u914d\u7f6e</li> </ul>"},{"location":"chap12/5chap12_es_cluster_perf/#1-6","title":"1-6 \u6570\u636e\u5199\u5165\u7684\u8fc7\u7a0b","text":"<ul> <li>Refresh</li> </ul> <p>\u5c06\u6587\u6863\u5148\u4fdd\u5b58\u5728  Index buffer \u4e2d\uff0c \u4ee5 <code>refresh_interval</code> \u4e3a\u95f4\u9694\u65f6\u95f4\uff0c\u5b9a\u671f\u6e05\u7a7a buffer\uff0c\u751f\u6210 segment\uff0c\u501f\u52a9\u6587\u4ef6\u7cfb\u7edf\u7f13\u5b58\u7684\u7279\u6027\uff0c\u5148\u5c06 segment \u653e\u5728\u6587\u4ef6\u7cfb\u7edf\u7f13\u5b58\u4e2d\uff0c\u5e76\u5f00\u653e\u67e5\u8be2\uff0c\u4ee5\u63d0\u5347\u641c\u7d22\u7684\u5b9e\u65f6\u6027</p> <ul> <li>Translog</li> </ul> <p>Segment \u6ca1\u6709\u5199\u5165\u78c1\u76d8\uff0c\u5373\u4fbf\u53d1\u751f\u4e86\u5f53\u673a\uff0c\u91cd\u542f\u540e\uff0c\u6570\u636e\u4e5f\u80fd\u6062\u590d\uff0c\u9ed8\u8ba4\u914d\u7f6e\u662f\u6bcf\u6b21\u8bf7\u6c42\u90fd\u4f1a\u843d\u76d8</p> <ul> <li> <p>Flush</p> <ul> <li>\u5220\u9664\u65e7\u7684 translog \u6587\u4ef6</li> <li>\u751f\u6210 Segment \u5e76\u5199\u5165\u78c1\u76d8 </li> <li>\u66f4\u65b0 commit point \u5e76\u5199\u5165\u78c1\u76d8\u3002 ES \u81ea\u52a8\u5b8c\u6210\uff0c\u53ef\u4f18\u5316\u70b9\u4e0d\u591a</li> </ul> </li> </ul>"},{"location":"chap12/5chap12_es_cluster_perf/#1-7-refresh-interval","title":"1-7 Refresh Interval","text":"<ul> <li>\u964d\u4f4e Refresh \u7684\u9891\u7387<ul> <li>\u589e\u52a0 <code>refresh_interval</code> \u7684\u6570\u503c\u3002\u9ed8\u8ba4\u4e3a 1s \uff0c\u5982\u679c\u8bbe\u7f6e\u6210 -1 \uff0c\u4f1a\u7981\u6b62\u81ea\u52a8 refresh<ul> <li>\u907f\u514d\u8fc7\u4e8e\u9891\u7e41\u7684 refresh\uff0c\u800c\u751f\u6210\u8fc7\u591a\u7684 segment \u6587\u4ef6</li> <li>\u4f46\u662f\u4f1a\u964d\u4f4e\u641c\u7d22\u7684\u5b9e\u65f6\u6027</li> </ul> </li> </ul> </li> </ul> <p>\u8bbe\u7f6e\u6210<code>-1</code>\u53ef\u4ee5\u51cf\u5c11\u76f8\u5173\u7684\u64cd\u4f5c\uff0c\u63d0\u9ad8\u5199\u5165\u6027\u80fd\u3002\u4f46\u662f\u6587\u6863\u4f1a\u65e0\u6cd5\u88ab\u641c\u7d22\u3002\u56e0\u6b64\u8981\u8bb0\u5f97\u5728\u5bfc\u5165\u6570\u636e\u540e\u5c06\u8fd9\u4e2a\u6570\u503c\u8bbe\u7f6e\u6210\u6b63\u5e38\u503c\u3002</p> <ul> <li>\u589e\u5927\u9759\u6001\u914d\u7f6e\u53c2\u6570 <code>indices.memory.index_buffer_size</code><ul> <li>\u9ed8\u8ba4\u662f 10%\uff0c \u4f1a\u5bfc\u81f4\u81ea\u52a8\u89e6\u53d1 refresh</li> </ul> </li> </ul>"},{"location":"chap12/5chap12_es_cluster_perf/#1-8-translog","title":"1-8 Translog","text":"<ul> <li>\u964d\u4f4e\u5199\u78c1\u76d8\u7684\u9891\u7387\uff0c\u4f46\u662f\u4f1a\u964d\u4f4e\u5bb9\u707e\u80fd\u529b<ul> <li><code>Index.translog.durability</code>:\u9ed8\u8ba4\u662f request\uff0c\u6bcf\u4e2a\u8bf7\u6c42\u90fd\u843d\u76d8\u3002\u8bbe\u7f6e\u6210 async\uff0c\u5f02\u6b65\u5199\u5165</li> <li><code>Index.translog.sync_interval</code> \u8bbe\u7f6e\u4e3a 60s\uff0c\u6bcf\u5206\u949f\u6267\u884c\u4e00\u6b21</li> <li><code>Index.translog.flush_threshod_size</code>: \u9ed8\u8ba4 512 mb\uff0c\u53ef\u4ee5\u9002\u5f53\u8c03\u5927\u3002 \u5f53 translog \u8d85\u8fc7\u8be5\u503c\uff0c\u4f1a\u89e6\u53d1 flush</li> </ul> </li> </ul>"},{"location":"chap12/5chap12_es_cluster_perf/#1-9","title":"1-9 \u5206\u7247\u8bbe\u5b9a","text":"<ul> <li>\u526f\u672c\u5728\u5199\u5165\u65f6\u8bbe\u4e3a 0\uff0c\u5b8c\u6210\u540e\u518d\u589e\u52a0</li> </ul> <p>\u526f\u672c\u7684\u8bbe\u7f6e \u4f60\u901a\u901a\u8fc7 put index-name \u5373\u53ef\u4fee\u6539\u3002</p> <ul> <li>\u5408\u7406\u8bbe\u7f6e\u5206\u7247\u6570\uff0c\u786e\u4fdd\u5747\u5300\u5206\u914d\u5728\u6240\u6709\u6570\u636e\u8282\u70b9\u4e0a<ul> <li><code>Index.routing.allocation.total_share_per_node</code>: \u9650\u5b9a\u6bcf\u4e2a\u7d22\u5f15\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u53ef\u5206\u914d\u7684\u5206\u7247\u6570</li> <li>5 \u4e2a\u8282\u70b9\u7684\u96c6\u7fa4\u3002 \u7d22\u5f15\u6709 5 \u4e2a\u4e3b\u5206\u7247\uff0c1 \u4e2a\u526f\u672c\uff0c\u5e94\u8be5\u5982\u4f55\u8bbe\u7f6e?<ul> <li>(5+5)/5=2</li> <li>\u751f\u4ea7\u73af\u5883\u4e2d\u8981\u9002\u5f53\u8c03\u5927\u8fd9\u4e2a\u6570\u5b57\uff0c\u907f\u514d\u6709\u8282\u70b9\u4e0b\u7ebf\u65f6\uff0c\u5206\u7247\u65e0\u6cd5\u6b63\u5e38\u8fc1\u79fb</li> </ul> </li> </ul> </li> </ul>"},{"location":"chap12/5chap12_es_cluster_perf/#1-10-bulk","title":"1-10 Bulk\uff0c\u7ebf\u7a0b\u6c60\u548c\u961f\u5217\u5927\u5c0f","text":"<ul> <li>\u5ba2\u6237\u7aef<ul> <li>\u5355\u4e2a bulk \u8bf7\u6c42\u4f53\u7684\u6570\u636e\u91cf\u4e0d\u8981\u592a\u5927\uff0c\u5b98\u65b9\u5efa\u8bae\u5927\u7ea65-15mb</li> <li>\u5199\u5165\u7aef\u7684 bulk \u8bf7\u6c42\u8d85\u65f6\u9700\u8981\u8db3\u591f\u957f\uff0c\u5efa\u8bae60s \u4ee5\u4e0a</li> <li>\u5199\u5165\u7aef\u5c3d\u91cf\u5c06\u6570\u636e\u8f6e\u8be2\u6253\u5230\u4e0d\u540c\u8282\u70b9\u3002</li> </ul> </li> <li>\u670d\u52a1\u5668\u7aef<ul> <li>\u7d22\u5f15\u521b\u5efa\u5c5e\u4e8e\u8ba1\u7b97\u5bc6\u96c6\u578b\u4efb\u52a1\uff0c\u5e94\u8be5\u4f7f\u7528\u56fa\u5b9a\u5927\u5c0f\u7684\u7ebf\u7a0b\u6c60\u6765\u914d\u7f6e\u3002\u6765\u4e0d\u53ca\u5904\u7406\u7684\u653e\u5165\u961f\u5217\uff0c\u7ebf\u7a0b\u6570\u5e94\u8be5\u914d\u7f6e\u6210 CPU \u6838\u5fc3\u6570 +1 \uff0c\u907f\u514d\u8fc7\u591a\u7684\u4e0a\u4e0b\u6587\u5207\u6362</li> <li>\u961f\u5217\u5927\u5c0f\u53ef\u4ee5\u9002\u5f53\u589e\u52a0\uff0c\u4e0d\u8981\u8fc7\u5927\uff0c\u5426\u5219\u5360\u7528\u7684\u5185\u5b58\u4f1a\u6210\u4e3a GC \u7684\u8d1f\u62c5</li> </ul> </li> </ul>"},{"location":"chap12/5chap12_es_cluster_perf/#1-11","title":"1-11 \u4e00\u4e2a\u7d22\u5f15\u8bbe\u5b9a\u7684\u4f8b\u5b50","text":""},{"location":"chap12/5chap12_es_cluster_perf/#2","title":"2\u3001\u63d0\u5347\u96c6\u7fa4\u8bfb\u6027\u80fd","text":""},{"location":"chap12/5chap12_es_cluster_perf/#2-1-denormalize","title":"2-1 \u5c3d\u91cf Denormalize \u6570\u636e","text":"<ul> <li>Elasticsearch != \u5173\u7cfb\u578b\u6570\u636e\u5e93</li> <li>\u5c3d\u53ef\u80fd Denormalize \u6570\u636e\uff0c\u4ece\u800c\u83b7\u53d6\u6700\u4f73\u7684\u6027\u80fd<ul> <li>\u4f7f\u7528 Nested \u7c7b\u578b\u7684\u6570\u636e\u3002\u67e5\u8be2\u901f\u5ea6\u4f1a\u6162\u51e0\u500d</li> <li>\u4f7f\u7528 Parent / Child \u5173\u7cfb\u3002\u67e5\u8be2\u901f\u5ea6\u4f1a\u6162\u51e0\u767e\u500d</li> </ul> </li> </ul>"},{"location":"chap12/5chap12_es_cluster_perf/#2-2","title":"2-2 \u6570\u636e\u5efa\u6a21","text":"<ul> <li>\u5c3d\u91cf\u5c06\u6570\u636e\u5148\u884c\u8ba1\u7b97\uff0c\u7136\u540e\u4fdd\u5b58\u5230 Elasticsearch \u4e2d\u3002\u5c3d\u91cf\u907f\u514d\u67e5\u8be2\u65f6\u7684 Script \u8ba1\u7b97</li> <li>\u5c3d\u91cf\u4f7f\u7528 Filter Context\uff0c\u5229\u7528\u7f13\u5b58\u673a\u5236\uff0c\u51cf\u5c11\u4e0d\u5fc5\u8981\u7684\u7b97\u5206</li> <li>\u7ed3\u5408 profile\uff0cexplain API \u5206\u6790\u6162\u67e5\u8be2\u7684\u95ee\u9898\uff0c\u6301\u7eed\u4f18\u5316\u6570\u636e\u6a21\u578b<ul> <li>\u4e25\u7981\u4f7f\u7528 <code>*</code> \u5f00\u5934\u901a\u914d\u7b26 Terms \u67e5\u8be2: \u5bf9\u6574\u4e2a\u96c6\u7fa4\u7684\u67e5\u8be2\u5e26\u6765\u5927\u7684\u4f24\u5bb3</li> </ul> </li> </ul>"},{"location":"chap12/5chap12_es_cluster_perf/#2-3","title":"2-3 \u907f\u514d\u67e5\u8be2\u65f6\u811a\u672c","text":"<ul> <li>\u53ef\u4ee5\u5728 Index \u6587\u6863\u65f6\uff0c\u4f7f\u7528 Ingest Pipeline\uff0c\u8ba1\u7b97\u5e76\u5199\u5165\u67d0\u4e2a\u5b57\u6bb5\uff0c\u5728\u5199\u5165\u65f6\u5bf9keyword\u8fdb\u884c\u8ba1\u7b97\u5199\u5165\u5230ES\u7684\u5177\u4f53\u5b57\u6bb5\u4e2d</li> </ul>"},{"location":"chap12/5chap12_es_cluster_perf/#2-4-query-context","title":"2-4 \u5e38\u89c1\u7684\u67e5\u8be2\u6027\u80fd\u95ee\u9898 - \u4f7f\u7528 Query Context","text":"<ul> <li>\u5de6\u8fb9\u7684Query Context \u65e0\u6cd5\u4f7f\u7528ES Cache,\u65e0\u6cd5\u63d0\u9ad8\u67e5\u8be2\u6027\u80fd</li> <li>\u53f3\u8fb9\u53ef\u4ee5\u4f7f\u7528Filter \u67e5\u8be2\uff0c \u53ef\u4ee5\u4f7f\u7528ES Cache\uff0c\u63d0\u9ad8\u67e5\u8be2\u6027\u80fd</li> </ul>"},{"location":"chap12/5chap12_es_cluster_perf/#2-5","title":"2-5 \u805a\u5408\u6587\u6863\u6d88\u8017\u5185\u5b58","text":"<ul> <li>\u805a\u5408\u67e5\u8be2\u4f1a\u6d88\u8017\u5185\u5b58\uff0c\u7279\u522b\u662f\u9488\u5bf9\u5f88\u5927\u7684\u6570\u636e\u96c6\u8fdb\u884c\u805a\u5408\u8fd0\u7b97<ul> <li>\u5982\u679c\u53ef\u4ee5\u63a7\u5236\u805a\u5408\u7684\u6570\u91cf\uff0c\u5c31\u80fd\u51cf\u5c11\u5185\u5b58\u7684\u5f00\u9500</li> </ul> </li> <li>\u5f53\u9700\u8981\u4f7f\u7528\u4e0d\u540c\u7684 Query Scope\uff0c\u53ef\u4ee5\u4f7f\u7528 Filter Bucket</li> </ul>"},{"location":"chap12/5chap12_es_cluster_perf/#2-6","title":"2-6 \u901a\u914d\u7b26\u5f00\u59cb\u7684\u6b63\u5219\u8868\u8fbe","text":"<p>\u901a\u914d\u7b26\u5f00\u5934\u7684\u6b63\u5219\uff0c\u6027\u80fd\u975e\u5e38\u7cdf\u7cd5\uff0c\u9700\u907f\u514d\u4f7f\u7528</p> <p></p>"},{"location":"chap12/5chap12_es_cluster_perf/#2-7","title":"2-7 \u4f18\u5316\u5206\u7247","text":"<ul> <li>\u907f\u514d Over Sharding<ul> <li>\u4e00\u4e2a\u67e5\u8be2\u9700\u8981\u8bbf\u95ee\u6bcf\u4e00\u4e2a\u5206\u7247\uff0c\u5206\u7247\u8fc7\u591a\uff0c\u4f1a\u5bfc\u81f4\u4e0d\u5fc5\u8981\u7684\u67e5\u8be2\u5f00\u9500</li> </ul> </li> <li>\u7ed3\u5408\u5e94\u7528\u573a\u666f\uff0c\u63a7\u5236\u5355\u4e2a\u5206\u7247\u7684\u5c3a\u5bf8<ul> <li>Search: 20GB</li> <li>Logging:40GB</li> </ul> </li> <li>Force-merge Read-only \u7d22\u5f15 <ul> <li>\u4f7f\u7528\u57fa\u4e8e\u65f6\u95f4\u5e8f\u5217\u7684\u7d22\u5f15\uff0c\u5c06\u53ea\u8bfb\u7684\u7d22\u5f15\u8fdb\u884c force merge\uff0c\u51cf\u5c11 segment \u6570\u91cf </li> </ul> </li> </ul>"},{"location":"chap12/5chap12_es_cluster_perf/#2-8","title":"2-8 \u8bfb\u6027\u80fd\u4f18\u5316","text":"<ul> <li>\u5f71\u54cd\u67e5\u8be2\u6027\u80fd\u7684\u4e00\u4e9b\u56e0\u7d20<ul> <li>\u6570\u636e\u6a21\u578b\u548c\u7d22\u5f15\u914d\u7f6e\u662f\u5426\u4f18\u5316</li> <li>\u6570\u636e\u89c4\u6a21\u662f\u5426\u8fc7\u5927\uff0c\u901a\u8fc7 Filter \u51cf\u5c11\u4e0d\u5fc5\u8981\u7684\u6570\u636e\u8ba1\u7b97</li> <li>\u67e5\u8be2\u8bed\u53e5\u662f\u5426\u4f18\u5316</li> </ul> </li> </ul>"},{"location":"chap12/5chap12_es_cluster_perf/#2-9-qa","title":"2-9 Q&amp;A","text":"<ul> <li>Q: \u6587\u4e2d\u6211\u4eec\u8bf4\u9700\u8981denormalize\u5efa\u6a21\uff0cdenormalize\u4e0d\u5c31\u662f\u5efa\u7acb\u5185\u5d4c\u6570\u636e\u6216\u8005\u7236\u5b50\u6a21\u578b\u5417\uff0c\u56e0\u4e3anormalize\u662f\u5173\u7cfb\u578b\u6570\u636e\u5e93\u90a3\u6837\u5efa\u7acb\u591a\u4e2a\u8868\u7684\uff0c\u7136\u540e\u8bbe\u7f6e\u5173\u8054\u7684<ul> <li>A:   \u6b63\u5e38\u60c5\u51b5\u4e0b\uff0ces\u4e0d\u652f\u6301\u4e24\u4e2a\u7d22\u5f15\u4e4b\u95f4\u7684join\u3002\u5f53\u7136\u4f60\u53ef\u4ee5\u901a\u8fc7\u5728\u4f60\u5b9e\u73b0\u7684\u4ee3\u7801\u91cc\u9762\u8fdb\u884cjoin\u3002es\u652f\u6301parent - child \uff0c\u53ef\u4ee5\u7406\u89e3\u6210\u662fjoin\u3002</li> <li>\u9664\u6b64\u4ee5\u5916\uff0c\u4f60\u9700\u8981\u5728\u6587\u6863\u4e2d\u4fdd\u5b58\u91cd\u590d\u7684\u6570\u636e\u3002\u4f8b\u5982\u4e00\u672c\u7535\u5f71\u4e2d\u7684\u6f14\u5458\uff0c\u6211\u4eec\u53ef\u4ee5\u628a\u6f14\u5458\u7684first name last name\uff0c\u90fd\u4fdd\u5b58\u5728\u7535\u5f71\u7684\u6587\u6863\u4e2d\uff0c\u800c\u4e0d\u662f\u4fdd\u5b58\u4e00\u4e2a\u6f14\u5458\u7684id\u3002\u8fd9\u79cd\u5b9e\u73b0\u7684\u597d\u5904\u662f\uff0c\u903b\u8f91\u7b80\u5355\uff0c\u6027\u80fd\u597d\u3002\u7f3a\u70b9\u662f\uff0c\u6570\u636e\u6709\u91cd\u590d\uff0c\u6d6a\u8d39\u5b58\u50a8\uff0c\u4e07\u4e00\u771f\u7684\u5b58\u5728\u6f14\u5458\u6539\u540d\u7684\u60c5\u51b5\uff0c\u90a3\u5c31\u9700\u8981\u4fee\u6539\u6240\u6709\u76f8\u5173\u7684\u7535\u5f71\u6587\u6863\u3002</li> </ul> </li> </ul>"},{"location":"chap12/6chap12_es_pre_test/","title":"\u7b2c\u516d\u8282 \u96c6\u7fa4\u538b\u529b\u6d4b\u8bd5","text":""},{"location":"chap12/6chap12_es_pre_test/#1","title":"1\u3001\u538b\u529b\u6d4b\u8bd5","text":""},{"location":"chap12/6chap12_es_pre_test/#1-1","title":"1-1 \u538b\u529b\u6d4b\u8bd5\u7684\u76ee\u7684","text":"<ul> <li>\u5bb9\u91cf\u89c4\u5212 / \u6027\u80fd\u4f18\u5316 / \u7248\u672c\u95f4\u6027\u80fd\u6bd4\u8f83 / \u6027\u80fd\u95ee\u9898\u8bca\u65ad</li> <li>\u786e\u5b9a\u7cfb\u7edf\u7a33\u5b9a\u6027\uff0c\u8003\u5bdf\u7cfb\u7edf\u529f\u80fd\u6781\u9650\u548c\u9690\u60a3</li> </ul>"},{"location":"chap12/6chap12_es_pre_test/#1-2","title":"1-2 \u538b\u529b\u6d4b\u8bd5\u7684\u65b9\u6cd5\u4e0e\u6b65\u9aa4","text":"<ul> <li>\u6d4b\u8bd5\u8ba1\u5212(\u786e\u5b9a\u6d4b\u8bd5\u573a\u666f\u548c\u6d4b\u8bd5\u6570\u636e\u96c6)</li> <li>\u811a\u672c\u5f00\u53d1</li> <li>\u6d4b\u8bd5\u73af\u5883\u642d\u5efa(\u4e0d\u540c\u7684\u8f6f\u786c\u4ef6\u914d\u7f6e) &amp; \u8fd0\u884c\u6d4b\u8bd5 </li> <li>\u5206\u6790\u6bd4\u8f83\u7ed3\u679c</li> </ul>"},{"location":"chap12/6chap12_es_pre_test/#2","title":"2\u3001\u6d4b\u8bd5\u76ee\u6807 &amp; \u6d4b\u8bd5\u6570\u636e","text":""},{"location":"chap12/6chap12_es_pre_test/#2-1","title":"2-1 \u6d4b\u8bd5\u76ee\u6807","text":"<ul> <li>\u6d4b\u8bd5\u96c6\u7fa4\u7684\u8bfb\u5199\u6027\u80fd / \u505a\u96c6\u7fa4\u5bb9\u91cf\u89c4\u5212</li> <li>\u5bf9 ES \u914d\u7f6e\u53c2\u6570\u8fdb\u884c\u4fee\u6539\uff0c\u8bc4\u4f30\u4f18\u5316\u6548\u679c</li> <li>\u4fee\u6539 Mapping \u548c Setting\uff0c\u5bf9\u6570\u636e\u5efa\u6a21\u8fdb\u884c\u4f18\u5316\uff0c\u5e76\u6d4b\u8bd5\u8bc4\u4f30\u6027\u80fd\u6539\u8fdb</li> <li>\u6d4b\u8bd5 ES \u65b0\u7248\u672c\uff0c\u7ed3\u5408\u5b9e\u9645\u573a\u666f\u548c\u8001\u7248\u672c\u8fdb\u884c\u6bd4\u8f83\uff0c\u8bc4\u4f30\u662f\u5426\u8fdb\u884c\u5347\u7ea7</li> </ul>"},{"location":"chap12/6chap12_es_pre_test/#2-2","title":"2-2 \u6d4b\u8bd5\u6570\u636e","text":"<ul> <li>\u6570\u636e\u91cf/\u6570\u636e\u5206\u5e03</li> </ul>"},{"location":"chap12/6chap12_es_pre_test/#3","title":"3\u3001\u6d4b\u8bd5\u811a\u672c","text":"<ul> <li>ES \u672c\u8eab\u63d0\u4f9b\u4e86 REST API\uff0c\u6240\u4ee5\uff0c\u53ef\u4ee5\u901a\u8fc7\u5f88\u591a\u4f20\u7edf\u7684\u6027\u80fd\u6d4b\u8bd5\u5de5\u5177<ul> <li>Load Runner (\u5546\u4e1a\u8f6f\u4ef6\uff0c\u652f\u6301\u5f55\u5236+\u91cd\u653e + DSL )</li> <li>JMeter ( Apache \u5f00\u6e90 \uff0cRecord &amp; Play)</li> <li>Gatling (\u5f00\u6e90\uff0c\u652f\u6301\u5199 Scala \u4ee3\u7801 + DSL)</li> </ul> </li> <li>\u4e13\u95e8\u4e3a Elasticsearch \u8bbe\u8ba1\u7684\u5de5\u5177<ul> <li>ES Pref &amp; Elasticsearch-stress-test</li> <li>Elastic Rally</li> </ul> </li> </ul>"},{"location":"chap12/6chap12_es_pre_test/#4es-rally","title":"4\u3001ES Rally \u7b80\u4ecb","text":"<ul> <li>Elastic \u5b98\u65b9\u5f00\u6e90\uff0c\u57fa\u4e8e Python 3 \u7684\u538b\u529b\u6d4b\u8bd5\u5de5\u5177<ul> <li>https://github.com/elastic/rally</li> <li>\u6027\u80fd\u6d4b\u8bd5\u7ed3\u679c\u6bd4\u8f83: https://elasticsearch-benchmarks.elastic.co</li> </ul> </li> <li>\u529f\u80fd\u4ecb\u7ecd<ul> <li>\u81ea\u52a8\u521b\u5efa\uff0c\u914d\u7f6e\uff0c\u8fd0\u884c\u6d4b\u8bd5\uff0c\u5e76\u4e14\u9500\u6bc1 ES \u96c6\u7fa4</li> <li>\u652f\u6301\u4e0d\u540c\u7684\u6d4b\u8bd5\u6570\u636e\u7684\u6bd4\u8f83\uff0c\u4e5f\u652f\u6301\u5c06\u6570\u636e\u5bfc\u5165 ES \u96c6\u7fa4\uff0c\u8fdb\u884c\u4e8c\u6b21\u5206\u6790</li> <li>\u652f\u6301\u6d4b\u8bd5\u65f6\u6307\u6807\u6570\u636e\u7684\u641c\u96c6\uff0c\u65b9\u4fbf\u5bf9\u6d4b\u8bd5\u7ed3\u679c\u8fdb\u884c\u6df1\u5ea6\u7684\u5206\u6790</li> </ul> </li> <li>Rally \u7684\u5b89\u88c5\u4ee5\u53ca\u5165\u95e8<ul> <li>\u5b89\u88c5\u8fd0\u884c<ul> <li>Python3.4+\u548cpip3 /JDK8 /git1.9+</li> <li>\u8fd0\u884c pip3 install esrally</li> <li>\u8fd0\u884c esrally configure</li> </ul> </li> <li>\u8fd0\u884c<ul> <li>\u8fd0\u884c <code>esrally \u2013distribution-version=7.1.0</code></li> <li>\u8fd0\u884c 1000 \u6761\u6d4b\u8bd5\u6570\u636e: <code>esrally \u2013distribution-version=7.1.0 --test-mode</code> </li> </ul> </li> </ul> </li> </ul>"},{"location":"chap12/6chap12_es_pre_test/#5rally","title":"5\u3001Rally \u57fa\u672c\u6982\u5ff5\u8bb2\u89e3","text":"<p>Elasticsearch \u538b\u6d4b\u65b9\u6848\u4e4b esrally \u7b80\u4ecb</p> <ul> <li>Tournament \u2013 \u5b9a\u4e49\u6d4b\u8bd5\u76ee\u6807\uff0c\u7531\u591a\u4e2a race \u7ec4\u6210<ul> <li>Esrally list races</li> </ul> </li> <li>Track \u2013 \u8d5b\u9053:\u6d4b\u8bd5\u6570\u636e\u548c\u6d4b\u8bd5\u573a\u666f\u4e0e\u7b56\u7565<ul> <li>https://github.com/elastic/rally- tracks</li> <li>esrally list tracks</li> </ul> </li> <li>Car\u2013 \u6267\u884c\u6d4b\u8bd5\u65b9\u6848<ul> <li>\u4e0d\u540c\u914d\u7f6e\u7684 es \u5b9e\u4f8b</li> </ul> </li> <li>Award \u2013 \u6d4b\u8bd5\u7ed3\u679c\u548c\u62a5\u544a</li> </ul>"},{"location":"chap12/6chap12_es_pre_test/#6benchmark-reports","title":"6\u3001Benchmark Reports","text":""},{"location":"chap12/6chap12_es_pre_test/#7","title":"7\u3001\u8fd0\u884c\u4e00\u4e2a\u6d4b\u8bd5","text":"<p>https://esrally.readthedocs.io/en/stable/tournament.html</p> <p></p>"},{"location":"chap12/6chap12_es_pre_test/#8","title":"8\u3001\u4ec0\u4e48\u662f\u538b\u6d4b\u7684\u6d41\u7a0b","text":""},{"location":"chap12/6chap12_es_pre_test/#8-1-pipeline","title":"8-1 Pipeline \u6307\u7684\u662f\u538b\u6d4b\u7684\u4e00\u4e2a\u6d41\u7a0b","text":"<ul> <li><code>Esrally list pipelines</code></li> </ul>"},{"location":"chap12/6chap12_es_pre_test/#8-2","title":"8-2 \u9ed8\u8ba4\u7684\u6d41\u7a0b","text":"<ul> <li><code>From-source-complete</code></li> <li><code>From-source-skip-build</code></li> <li><code>From-distribution</code></li> <li><code>Benchmark-only</code> (\u5bf9\u5df2\u6709\u7684\u96c6\u7fa4\u8fdb\u884c\u6d4b\u8bd5)</li> </ul>"},{"location":"chap12/6chap12_es_pre_test/#9","title":"9\u3001\u81ea\u5b9a\u4e49 &amp; \u5206\u5e03\u5f0f\u6d4b\u8bd5","text":""},{"location":"chap12/6chap12_es_pre_test/#9-1-car","title":"9-1  Car","text":"<ul> <li>https://esrally.readthedocs.io/en/latest/car.html </li> <li>\u4f7f\u7528\u81ea\u5efa\u7684\u96c6\u7fa4</li> </ul>"},{"location":"chap12/6chap12_es_pre_test/#9-2-track","title":"9-2 Track","text":"<ul> <li>\u81ea\u5e26\u7684\u6d4b\u8bd5\u6570\u636e\u96c6:<code>Nyc_taxis 4.5 G / logging 1.2G</code></li> <li>\u66f4\u591a\u7684\u6d4b\u8bd5\u6570\u636e\u96c6: https://github.com/elastic/rally-tracks</li> </ul>"},{"location":"chap12/6chap12_es_pre_test/#9-3","title":"9-3 \u5206\u5e03\u5f0f\u6d4b\u8bd5","text":"<p>https://esrally.readthedocs.io/en/latest/recipes.html#recipe-distributed-load-driver</p>"},{"location":"chap12/6chap12_es_pre_test/#10","title":"10\u3001\u5b9e\u4f8b:","text":""},{"location":"chap12/6chap12_es_pre_test/#10-1","title":"10-1 \u6bd4\u8f83\u4e0d\u540c\u7684\u7248\u672c\u7684\u6027\u80fd","text":"<p>\u6d4b\u8bd5</p> <pre><code>esrally race --distribution-version=6.0.0 --track=nyc_taxis --challenge=append-no-\nconflicts --user-tag=\"version:6.0.0\u201d\n\nesrally race --distribution-version=7.1.0 --track=nyc_taxis --challenge=append-no- conflicts --user-tag=\"version:7.1.0\"\n</code></pre> <p>\u6bd4\u8f83\u7ed3\u679c</p> <ul> <li><code>esrally list races</code></li> <li><code>esrally compare --baseline=[6.0.0 race] --contender=[7.1.0 race]</code></li> </ul>"},{"location":"chap12/6chap12_es_pre_test/#10-2-mapping","title":"10-2 \u6bd4\u8f83\u4e0d\u540c Mapping \u7684\u6027\u80fd","text":"<p>\u6d4b\u8bd5</p> <ul> <li><code>esrally race --distribution-version=7.1.0 --track=nyc_taxis --challenge=append-no- conflicts --user-tag=\"enableSource:true\" --include-tasks=\"type:index\u201d</code></li> <li>\u4fee\u6539:<code>benchmarks/tracks/default/nyc_taxis/mappings.json</code>\uff0c\u4fee\u6539 <code>_source.enabled</code> \u4e3a false</li> <li><code>esrally race --distribution-version=7.1.0 --track=nyc_taxis --challenge=append-no- conflicts --user-tag=\"enableSource:false\" --include-tasks=\"type:index</code></li> </ul> <p>\u6bd4\u8f83</p> <ul> <li><code>esrally compare --baseline=[enableAll race] --contender=[disableAll race]</code></li> </ul>"},{"location":"chap12/6chap12_es_pre_test/#10-3","title":"10-3 \u6d4b\u8bd5\u73b0\u6709\u96c6\u7fa4\u7684\u6027\u80fd","text":"<p>\u6d4b\u8bd5</p> <pre><code>esrally race --pipeline=benchmark-only --target-hosts=127.0.0.1:9200 --track=geonames -- challenge=append-no-conflicts\n</code></pre>"},{"location":"chap12/6chap12_es_pre_test/#11demo","title":"11\u3001\u8bfe\u7a0bdemo","text":"<pre><code>$ esrally configure\n\n    ____        ____\n   / __ \\____ _/ / /_  __\n  / /_/ / __ `/ / / / / /\n / _, _/ /_/ / / / /_/ /\n/_/ |_|\\__,_/_/_/\\__, /\n                /____/\n\nRunning simple configuration. Run the advanced configuration with:\n\n  esrally configure --advanced-config\n\n* Setting up benchmark root directory in /Users/i515190/.rally/benchmarks\n* Setting up benchmark source directory in /Users/i515190/.rally/benchmarks/src/elasticsearch\n\nConfiguration successfully written to /Users/i515190/.rally/rally.ini. Happy benchmarking!\n\nMore info about Rally:\n\n* Type esrally --help\n* Read the documentation at https://esrally.readthedocs.io/en/2.0.2/\n* Ask a question on the forum at https://discuss.elastic.co/tags/c/elastic-stack/elasticsearch/rally\n</code></pre> <pre><code>$ esrally list pipelines\n\n    ____        ____\n   / __ \\____ _/ / /_  __\n  / /_/ / __ `/ / / / / /\n / _, _/ /_/ / / / /_/ /\n/_/ |_|\\__,_/_/_/\\__, /\n                /____/\n\nAvailable pipelines:\n\nName                     Description\n-----------------------  ----------------------------------------------------------------------------------------------\nfrom-sources             Builds and provisions Elasticsearch, runs a benchmark and reports results.\nfrom-sources-complete    Builds and provisions Elasticsearch, runs a benchmark and reports results [deprecated].\nfrom-sources-skip-build  Provisions Elasticsearch (skips the build), runs a benchmark and reports results [deprecated].\nfrom-distribution        Downloads an Elasticsearch distribution, provisions it, runs a benchmark and reports results.\nbenchmark-only           Assumes an already running Elasticsearch instance, runs a benchmark and reports results\n\n-------------------------------\n[INFO] SUCCESS (took 1 seconds)\n-------------------------------\n</code></pre>"},{"location":"chap12/6chap12_es_pre_test/#11-1-1000","title":"11-1 \u53ea\u6d4b\u8bd5 1000\u6761\u6570\u636e","text":"<pre><code># \u53ea\u6d4b\u8bd5 1000\u6761\u6570\u636e\nesrally --distribution-version=7.1.0 --test-mode\n</code></pre> <pre><code>$ esrally --distribution-version=7.1.0 --test-mode\n\n    ____        ____\n   / __ \\____ _/ / /_  __\n  / /_/ / __ `/ / / / / /\n / _, _/ /_/ / / / /_/ /\n/_/ |_|\\__,_/_/_/\\__, /\n                /____/\n\n[INFO] Preparing for race ...\n[INFO] Downloading Elasticsearch 7.1.0 (246.2 MB total size)                        [100%]\n[INFO] Downloading data for track geonames (20.5 kB total size)                   [100.0%]\n[INFO] Decompressing track data from [/Users/i515190/.rally/benchmarks/data/geonames/documents-2-1k.json.bz2] to [/Users/i515190/.rally/benchmarks/data/geona\nmes/documents-2-1k.json] ... [OK]\n[INFO] Preparing file offset table for [/Users/i515190/.rally/benchmarks/data/geonames/documents-2-1k.json] ... [OK]\n[INFO] Racing on track [geonames], challenge [append-no-conflicts] and car ['defaults'] with version [7.1.0].\n\nRunning delete-index                                                           [100% done]\nRunning create-index                                                           [100% done]\nRunning check-cluster-health                                                   [100% done]\nRunning index-append                                                           [100% done]\nRunning refresh-after-index                                                    [100% done]\nRunning force-merge                                                            [100% done]\nRunning refresh-after-force-merge                                              [100% done]\nRunning wait-until-merges-finish                                               [100% done]\nRunning index-stats                                                            [100% done]\nRunning node-stats                                                             [100% done]\nRunning default                                                                [100% done]\nRunning term                                                                   [100% done]\nRunning phrase                                                                 [100% done]\nRunning country_agg_uncached                                                   [100% done]\nRunning country_agg_cached                                                     [100% done]\nRunning scroll                                                                 [100% done]\nRunning expression                                                             [100% done]\nRunning painless_static                                                        [100% done]\nRunning painless_dynamic                                                       [100% done]\nRunning decay_geo_gauss_function_score                                         [100% done]\nRunning decay_geo_gauss_script_score                                           [100% done]\nRunning field_value_function_score                                             [100% done]\nRunning field_value_script_score                                               [100% done]\nRunning large_terms                                                            [100% done]\nRunning large_filtered_terms                                                   [100% done]\nRunning large_prohibited_terms                                                 [100% done]\nRunning desc_sort_population                                                   [100% done]\nRunning asc_sort_population                                                    [100% done]\nRunning desc_sort_geonameid                                                    [100% done]\nRunning asc_sort_geonameid                                                     [100% done]\n\n------------------------------------------------------\n    _______             __   _____\n   / ____(_)___  ____ _/ /  / ___/_________  ________\n  / /_  / / __ \\/ __ `/ /   \\__ \\/ ___/ __ \\/ ___/ _ \\\n / __/ / / / / / /_/ / /   ___/ / /__/ /_/ / /  /  __/\n/_/   /_/_/ /_/\\__,_/_/   /____/\\___/\\____/_/   \\___/\n------------------------------------------------------\n\n|                                                         Metric |                           Task |       Value |    Unit |\n|---------------------------------------------------------------:|-------------------------------:|------------:|--------:|\n|                     Cumulative indexing time of primary shards |                                |   0.0491167 |     min |\n|             Min cumulative indexing time across primary shards |                                |  0.00731667 |     min |\n|          Median cumulative indexing time across primary shards |                                |  0.00953333 |     min |\n|             Max cumulative indexing time across primary shards |                                |     0.01315 |     min |\n|            Cumulative indexing throttle time of primary shards |                                |           0 |     min |\n|    Min cumulative indexing throttle time across primary shards |                                |           0 |     min |\n| Median cumulative indexing throttle time across primary shards |                                |           0 |     min |\n|    Max cumulative indexing throttle time across primary shards |                                |           0 |     min |\n|                        Cumulative merge time of primary shards |                                |           0 |     min |\n|                       Cumulative merge count of primary shards |                                |           0 |         |\n|                Min cumulative merge time across primary shards |                                |           0 |     min |\n|             Median cumulative merge time across primary shards |                                |           0 |     min |\n|                Max cumulative merge time across primary shards |                                |           0 |     min |\n|               Cumulative merge throttle time of primary shards |                                |           0 |     min |\n|       Min cumulative merge throttle time across primary shards |                                |           0 |     min |\n|    Median cumulative merge throttle time across primary shards |                                |           0 |     min |\n|       Max cumulative merge throttle time across primary shards |                                |           0 |     min |\n|                      Cumulative refresh time of primary shards |                                |   0.0755167 |     min |\n|                     Cumulative refresh count of primary shards |                                |          27 |         |\n|              Min cumulative refresh time across primary shards |                                |   0.0118333 |     min |\n|           Median cumulative refresh time across primary shards |                                |   0.0139833 |     min |\n|              Max cumulative refresh time across primary shards |                                |   0.0195667 |     min |\n|                        Cumulative flush time of primary shards |                                |           0 |     min |\n|                       Cumulative flush count of primary shards |                                |           0 |         |\n|                Min cumulative flush time across primary shards |                                |           0 |     min |\n|             Median cumulative flush time across primary shards |                                |           0 |     min |\n|                Max cumulative flush time across primary shards |                                |           0 |     min |\n|                                        Total Young Gen GC time |                                |       0.027 |       s |\n|                                       Total Young Gen GC count |                                |           3 |         |\n|                                          Total Old Gen GC time |                                |           0 |       s |\n|                                         Total Old Gen GC count |                                |           0 |         |\n|                                                     Store size |                                | 0.000568046 |      GB |\n|                                                  Translog size |                                | 0.000323798 |      GB |\n|                                         Heap used for segments |                                |     0.18583 |      MB |\n|                                       Heap used for doc values |                                |   0.0184174 |      MB |\n|                                            Heap used for terms |                                |    0.141861 |      MB |\n|                                            Heap used for norms |                                |   0.0170288 |      MB |\n|                                           Heap used for points |                                | 0.000191689 |      MB |\n|                                    Heap used for stored fields |                                |   0.0083313 |      MB |\n|                                                  Segment count |                                |          28 |         |\n|                                                 Min Throughput |                   index-append |     2453.73 |  docs/s |\n|                                              Median Throughput |                   index-append |     2453.73 |  docs/s |\n|                                                 Max Throughput |                   index-append |     2453.73 |  docs/s |\n|                                        50th percentile latency |                   index-append |     388.967 |      ms |\n|                                       100th percentile latency |                   index-append |     397.785 |      ms |\n|                                   50th percentile service time |                   index-append |     388.967 |      ms |\n|                                  100th percentile service time |                   index-append |     397.785 |      ms |\n|                                                     error rate |                   index-append |           0 |       % |\n|                                                 Min Throughput |                    index-stats |      111.54 |   ops/s |\n|                                              Median Throughput |                    index-stats |      111.54 |   ops/s |\n|                                                 Max Throughput |                    index-stats |      111.54 |   ops/s |\n|                                       100th percentile latency |                    index-stats |     5.73833 |      ms |\n|                                  100th percentile service time |                    index-stats |     5.73833 |      ms |\n|                                                     error rate |                    index-stats |           0 |       % |\n|                                                 Min Throughput |                     node-stats |       101.9 |   ops/s |\n|                                              Median Throughput |                     node-stats |       101.9 |   ops/s |\n|                                                 Max Throughput |                     node-stats |       101.9 |   ops/s |\n|                                       100th percentile latency |                     node-stats |     6.09194 |      ms |\n|                                  100th percentile service time |                     node-stats |     6.09194 |      ms |\n|                                                     error rate |                     node-stats |           0 |       % |\n|                                                 Min Throughput |                        default |       31.92 |   ops/s |\n|                                              Median Throughput |                        default |       31.92 |   ops/s |\n|                                                 Max Throughput |                        default |       31.92 |   ops/s |\n|                                       100th percentile latency |                        default |     6.35889 |      ms |\n|                                  100th percentile service time |                        default |     6.35889 |      ms |\n|                                                     error rate |                        default |           0 |       % |\n|                                                 Min Throughput |                           term |      108.13 |   ops/s |\n|                                              Median Throughput |                           term |      108.13 |   ops/s |\n|                                                 Max Throughput |                           term |      108.13 |   ops/s |\n|                                       100th percentile latency |                           term |     5.45795 |      ms |\n|                                  100th percentile service time |                           term |     5.45795 |      ms |\n|                                                     error rate |                           term |           0 |       % |\n|                                                 Min Throughput |                         phrase |       91.81 |   ops/s |\n|                                              Median Throughput |                         phrase |       91.81 |   ops/s |\n|                                                 Max Throughput |                         phrase |       91.81 |   ops/s |\n|                                       100th percentile latency |                         phrase |     4.26647 |      ms |\n|                                  100th percentile service time |                         phrase |     4.26647 |      ms |\n|                                                     error rate |                         phrase |           0 |       % |\n|                                                 Min Throughput |           country_agg_uncached |       35.53 |   ops/s |\n|                                              Median Throughput |           country_agg_uncached |       35.53 |   ops/s |\n|                                                 Max Throughput |           country_agg_uncached |       35.53 |   ops/s |\n|                                       100th percentile latency |           country_agg_uncached |     4.03273 |      ms |\n|                                  100th percentile service time |           country_agg_uncached |     4.03273 |      ms |\n|                                                     error rate |           country_agg_uncached |           0 |       % |\n|                                                 Min Throughput |             country_agg_cached |      102.24 |   ops/s |\n|                                              Median Throughput |             country_agg_cached |      102.24 |   ops/s |\n|                                                 Max Throughput |             country_agg_cached |      102.24 |   ops/s |\n|                                       100th percentile latency |             country_agg_cached |     6.58807 |      ms |\n|                                  100th percentile service time |             country_agg_cached |     6.58807 |      ms |\n|                                                     error rate |             country_agg_cached |           0 |       % |\n|                                                 Min Throughput |                         scroll |       28.74 | pages/s |\n|                                              Median Throughput |                         scroll |       28.74 | pages/s |\n|                                                 Max Throughput |                         scroll |       28.74 | pages/s |\n|                                       100th percentile latency |                         scroll |     49.4474 |      ms |\n|                                  100th percentile service time |                         scroll |     49.4474 |      ms |\n|                                                     error rate |                         scroll |           0 |       % |\n|                                                 Min Throughput |                     expression |        14.2 |   ops/s |\n|                                              Median Throughput |                     expression |        14.2 |   ops/s |\n|                                                 Max Throughput |                     expression |        14.2 |   ops/s |\n|                                       100th percentile latency |                     expression |     4.38835 |      ms |\n|                                  100th percentile service time |                     expression |     4.38835 |      ms |\n|                                                     error rate |                     expression |           0 |       % |\n|                                                 Min Throughput |                painless_static |       14.65 |   ops/s |\n|                                              Median Throughput |                painless_static |       14.65 |   ops/s |\n|                                                 Max Throughput |                painless_static |       14.65 |   ops/s |\n|                                       100th percentile latency |                painless_static |     4.61457 |      ms |\n|                                  100th percentile service time |                painless_static |     4.61457 |      ms |\n|                                                     error rate |                painless_static |           0 |       % |\n|                                                 Min Throughput |               painless_dynamic |       37.46 |   ops/s |\n|                                              Median Throughput |               painless_dynamic |       37.46 |   ops/s |\n|                                                 Max Throughput |               painless_dynamic |       37.46 |   ops/s |\n|                                       100th percentile latency |               painless_dynamic |     5.86025 |      ms |\n|                                  100th percentile service time |               painless_dynamic |     5.86025 |      ms |\n|                                                     error rate |               painless_dynamic |           0 |       % |\n|                                                 Min Throughput | decay_geo_gauss_function_score |       95.97 |   ops/s |\n|                                              Median Throughput | decay_geo_gauss_function_score |       95.97 |   ops/s |\n|                                                 Max Throughput | decay_geo_gauss_function_score |       95.97 |   ops/s |\n|                                       100th percentile latency | decay_geo_gauss_function_score |     5.43147 |      ms |\n|                                  100th percentile service time | decay_geo_gauss_function_score |     5.43147 |      ms |\n|                                                     error rate | decay_geo_gauss_function_score |           0 |       % |\n|                                                 Min Throughput |   decay_geo_gauss_script_score |       77.94 |   ops/s |\n|                                              Median Throughput |   decay_geo_gauss_script_score |       77.94 |   ops/s |\n|                                                 Max Throughput |   decay_geo_gauss_script_score |       77.94 |   ops/s |\n|                                       100th percentile latency |   decay_geo_gauss_script_score |     4.54284 |      ms |\n|                                  100th percentile service time |   decay_geo_gauss_script_score |     4.54284 |      ms |\n|                                                     error rate |   decay_geo_gauss_script_score |           0 |       % |\n|                                                 Min Throughput |     field_value_function_score |      130.75 |   ops/s |\n|                                              Median Throughput |     field_value_function_score |      130.75 |   ops/s |\n|                                                 Max Throughput |     field_value_function_score |      130.75 |   ops/s |\n|                                       100th percentile latency |     field_value_function_score |     4.21447 |      ms |\n|                                  100th percentile service time |     field_value_function_score |     4.21447 |      ms |\n|                                                     error rate |     field_value_function_score |           0 |       % |\n|                                                 Min Throughput |       field_value_script_score |       73.29 |   ops/s |\n|                                              Median Throughput |       field_value_script_score |       73.29 |   ops/s |\n|                                                 Max Throughput |       field_value_script_score |       73.29 |   ops/s |\n|                                       100th percentile latency |       field_value_script_score |     5.03732 |      ms |\n|                                  100th percentile service time |       field_value_script_score |     5.03732 |      ms |\n|                                                     error rate |       field_value_script_score |           0 |       % |\n|                                                 Min Throughput |                    large_terms |           2 |   ops/s |\n|                                              Median Throughput |                    large_terms |           2 |   ops/s |\n|                                                 Max Throughput |                    large_terms |           2 |   ops/s |\n|                                       100th percentile latency |                    large_terms |     214.641 |      ms |\n|                                  100th percentile service time |                    large_terms |     214.641 |      ms |\n|                                                     error rate |                    large_terms |           0 |       % |\n|                                                 Min Throughput |           large_filtered_terms |         7.4 |   ops/s |\n|                                              Median Throughput |           large_filtered_terms |         7.4 |   ops/s |\n|                                                 Max Throughput |           large_filtered_terms |         7.4 |   ops/s |\n|                                       100th percentile latency |           large_filtered_terms |     119.404 |      ms |\n|                                  100th percentile service time |           large_filtered_terms |     119.404 |      ms |\n|                                                     error rate |           large_filtered_terms |           0 |       % |\n|                                                 Min Throughput |         large_prohibited_terms |       11.45 |   ops/s |\n|                                              Median Throughput |         large_prohibited_terms |       11.45 |   ops/s |\n|                                                 Max Throughput |         large_prohibited_terms |       11.45 |   ops/s |\n|                                       100th percentile latency |         large_prohibited_terms |     73.3847 |      ms |\n|                                  100th percentile service time |         large_prohibited_terms |     73.3847 |      ms |\n|                                                     error rate |         large_prohibited_terms |           0 |       % |\n|                                                 Min Throughput |           desc_sort_population |      118.68 |   ops/s |\n|                                              Median Throughput |           desc_sort_population |      118.68 |   ops/s |\n|                                                 Max Throughput |           desc_sort_population |      118.68 |   ops/s |\n|                                       100th percentile latency |           desc_sort_population |     4.98329 |      ms |\n|                                  100th percentile service time |           desc_sort_population |     4.98329 |      ms |\n|                                                     error rate |           desc_sort_population |           0 |       % |\n|                                                 Min Throughput |            asc_sort_population |      174.72 |   ops/s |\n|                                              Median Throughput |            asc_sort_population |      174.72 |   ops/s |\n|                                                 Max Throughput |            asc_sort_population |      174.72 |   ops/s |\n|                                       100th percentile latency |            asc_sort_population |     3.44778 |      ms |\n|                                  100th percentile service time |            asc_sort_population |     3.44778 |      ms |\n|                                                     error rate |            asc_sort_population |           0 |       % |\n|                                                 Min Throughput |            desc_sort_geonameid |      156.29 |   ops/s |\n|                                              Median Throughput |            desc_sort_geonameid |      156.29 |   ops/s |\n|                                                 Max Throughput |            desc_sort_geonameid |      156.29 |   ops/s |\n|                                       100th percentile latency |            desc_sort_geonameid |     4.53917 |      ms |\n|                                  100th percentile service time |            desc_sort_geonameid |     4.53917 |      ms |\n|                                                     error rate |            desc_sort_geonameid |           0 |       % |\n|                                                 Min Throughput |             asc_sort_geonameid |      174.46 |   ops/s |\n|                                              Median Throughput |             asc_sort_geonameid |      174.46 |   ops/s |\n|                                                 Max Throughput |             asc_sort_geonameid |      174.46 |   ops/s |\n|                                       100th percentile latency |             asc_sort_geonameid |     4.66923 |      ms |\n|                                  100th percentile service time |             asc_sort_geonameid |     4.66923 |      ms |\n|                                                     error rate |             asc_sort_geonameid |           0 |       % |\n\n\n---------------------------------\n[INFO] SUCCESS (took 162 seconds)\n---------------------------------\n</code></pre>"},{"location":"chap12/6chap12_es_pre_test/#11-2","title":"11-2 \u6d4b\u8bd5\u5b8c\u6574\u6570\u636e","text":"<pre><code># \u6d4b\u8bd5\u5b8c\u6574\u6570\u636e\nesrally --distribution-version=7.1.0\n</code></pre> <pre><code>$ esrally --distribution-version=7.1.0\n\n    ____        ____\n   / __ \\____ _/ / /_  __\n  / /_/ / __ `/ / / / / /\n / _, _/ /_/ / / / /_/ /\n/_/ |_|\\__,_/_/_/\\__, /\n                /____/\n\n[INFO] Preparing for race ...\n[INFO] Downloading data for track geonames (252.9 MB total size)                  [100.0%]\n[INFO] Decompressing track data from [/Users/i515190/.rally/benchmarks/data/geonames/documents-2.json.bz2] to [/Users/i515190/.rally/benchmarks/data/geonames\n/documents-2.json] (resulting size: 3.30 GB) ... ^C^C[INFO] Please wait a moment for Rally's internal components to shutdown.\n^C[INFO] Please wait a moment for Rally's internal components to shutdown.\n\n[WARNING] Terminating now at the risk of leaving child processes behind.\n\n[WARNING] The next race may fail due to an unclean shutdown.\n\n\n                 uuuuuuu\n             uu$$$$$$$$$$$uu\n          uu$$$$$$$$$$$$$$$$$uu\n         u$$$$$$$$$$$$$$$$$$$$$u\n        u$$$$$$$$$$$$$$$$$$$$$$$u\n       u$$$$$$$$$$$$$$$$$$$$$$$$$u\n       u$$$$$$$$$$$$$$$$$$$$$$$$$u\n       u$$$$$$\"   \"$$$\"   \"$$$$$$u\n       \"$$$$\"      u$u       $$$$\"\n        $$$u       u$u       u$$$\n        $$$u      u$$$u      u$$$\n         \"$$$$uu$$$   $$$uu$$$$\"\n          \"$$$$$$$\"   \"$$$$$$$\"\n            u$$$$$$$u$$$$$$$u\n             u$\"$\"$\"$\"$\"$\"$u\n  uuu        $$u$ $ $ $ $u$$       uuu\n u$$$$        $$$$$u$u$u$$$       u$$$$\n  $$$$$uu      \"$$$$$$$$$\"     uu$$$$$$\nu$$$$$$$$$$$uu    \"\"\"\"\"    uuuu$$$$$$$$$$\n$$$$\"\"\"$$$$$$$$$$uuu   uu$$$$$$$$$\"\"\"$$$\"\n\"\"\"      \"\"$$$$$$$$$$$uu \"\"$\"\"\"\nuuuu \"\"$$$$$$$$$$uuu\nu$$$uuu$$$$$$$$$uu \"\"$$$$$$$$$$$uuu$$$\n$$$$$$$$$$\"\"\"\"           \"\"$$$$$$$$$$$\"\n   \"$$$$$\"                      \"\"$$$$\"\"\n     $$$\"                         $$$$\"\n\n\n\n---------------------------------\n[INFO] SUCCESS (took 681 seconds)\n---------------------------------\n</code></pre> <ul> <li>https://github.com/elastic/rally</li> <li>https://github.com/elastic/rally-tracks</li> <li>https://logz.io/blog/rally/</li> </ul>"},{"location":"chap12/7chap12_es_segment_merge/","title":"\u7b2c\u4e03\u8282 \u6bb5\u5408\u5e76\u4f18\u5316\u53ca\u6ce8\u610f\u4e8b\u9879","text":""},{"location":"chap12/7chap12_es_segment_merge/#1lucene-index","title":"1\u3001Lucene Index \u539f\u7406\u56de\u987e","text":""},{"location":"chap12/7chap12_es_segment_merge/#1-1-segment","title":"1-1 Segment","text":"<p>\u5728 Lucene \u4e2d\uff0c\u5355\u4e2a\u5012\u6392\u7d22\u5f15\u6587\u4ef6\u88ab\u79f0\u4e3a Segment\u3002</p> <p>Segment \u662f\u81ea\u5305\u542b\u7684\uff0c\u4e0d\u53ef\u53d8\u66f4\u7684\u3002 \u591a\u4e2a Segments \u6c47\u603b\u5728\u4e00\u8d77\uff0c\u79f0\u4e3a Lucene \u7684 Index\uff0c\u5176\u5bf9\u5e94\u7684\u5c31\u662f ES \u4e2d\u7684 Shard</p> <p><code>An ES  Shard = A Lucene Index</code></p>"},{"location":"chap12/7chap12_es_segment_merge/#1-2-commit-point-refresh","title":"1-2 Commit Point &amp; Refresh","text":"<ul> <li>\u5f53\u6709\u65b0\u6587\u6863\u5199\u5165\u65f6\uff0c\u5e76\u4e14\u6267\u884c Refresh\uff0c\u5c31\u4f1a\u751f\u6210\u4e00\u4e2a\u65b0 Segment\u3002</li> <li>Lucene \u4e2d\u6709\u4e00\u4e2a\u6587\u4ef6\uff0c\u7528\u6765\u8bb0\u5f55\u6240\u6709 Segments \u4fe1\u606f\uff0c\u53eb\u505a Commit Point\u3002</li> <li>\u67e5\u8be2\u65f6\u4f1a\u540c\u65f6\u67e5\u8be2\u6240\u6709 Segments\uff0c\u5e76\u4e14\u5bf9\u7ed3\u679c\u6c47\u603b\u3002</li> </ul>"},{"location":"chap12/7chap12_es_segment_merge/#1-3-del","title":"1-3 .del","text":"<ul> <li>\u5220\u9664\u7684\u6587\u6863\u4fe1\u606f\uff0c\u4fdd\u5b58\u5728\u201c.del\u201d\u6587\u4ef6\u4e2d\uff0c\u67e5 \u8be2\u540e\u4f1a\u8fdb\u884c\u8fc7\u6ee4\u3002</li> </ul>"},{"location":"chap12/7chap12_es_segment_merge/#1-4-merge","title":"1-4 Merge","text":"<p>Segment \u4f1a\u5b9a\u671f Merge\uff0c\u5408\u5e76\u6210\u4e00\u4e2a\uff0c\u540c\u65f6\u5220\u9664\u5df2\u5220\u9664\u6587\u6863</p>"},{"location":"chap12/7chap12_es_segment_merge/#2merge","title":"2\u3001Merge \u4f18\u5316","text":"<ul> <li>ES \u548c Lucene \u4f1a\u81ea\u52a8\u8fdb\u884c Merge \u64cd\u4f5c</li> <li>Merge \u64cd\u4f5c\u76f8\u5bf9\u6bd4\u8f83\u91cd\uff0c\u9700\u8981\u4f18\u5316\uff0c\u964d\u4f4e\u5bf9\u7cfb\u7edf\u7684\u5f71\u54cd</li> </ul>"},{"location":"chap12/7chap12_es_segment_merge/#2-1","title":"2-1 \u4f18\u5316\u70b9\u4e00:  \u964d\u4f4e\u5206\u6bb5\u4ea7\u751f\u7684\u6570\u91cf/\u9891\u7387","text":"<ul> <li>\u53ef\u4ee5\u5c06 Refresh Interval \u8c03\u6574\u5230\u5206\u949f\u7ea7\u522b (\u63d0\u9ad8Refresh Interval)</li> <li><code>indices.memory.index_buffer_size</code> (\u9ed8\u8ba4\u662f 10%)</li> <li>\u5c3d\u91cf\u907f\u514d\u6587\u6863\u7684\u66f4\u65b0\u64cd\u4f5c</li> </ul>"},{"location":"chap12/7chap12_es_segment_merge/#2-2","title":"2-2 \u4f18\u5316\u70b9\u4e8c: \u964d\u4f4e\u6700\u5927\u5206\u6bb5\u5927\u5c0f","text":"<ul> <li>\u907f\u514d\u8f83\u5927\u7684\u5206\u6bb5\u7ee7\u7eed\u53c2\u4e0e Merge\uff0c\u8282\u7701\u7cfb\u7edf\u8d44\u6e90\u3002(\u6700\u7ec8\u4f1a\u6709\u591a\u4e2a\u5206\u6bb5)</li> <li><code>Index.merge.policy.segments_per_tier</code>\uff0c\u9ed8\u8ba4\u4e3a 10\uff0c \u8d8a\u5c0f\u9700\u8981\u8d8a\u591a\u7684\u5408\u5e76\u64cd\u4f5c</li> <li><code>Index.merge.policy.max_merged_segment</code>, \u9ed8\u8ba4 5 GB\uff0c \u64cd\u4f5c\u6b64\u5927\u5c0f\u4ee5\u540e\uff0c\u5c31\u4e0d\u518d\u53c2\u4e0e\u540e\u7eed\u7684 \u5408\u5e76\u64cd\u4f5c</li> </ul>"},{"location":"chap12/7chap12_es_segment_merge/#3force-merge","title":"3\u3001Force Merge","text":"<ul> <li> <p>\u5f53 Index \u4e0d\u518d\u6709\u5199\u5165\u64cd\u4f5c\u7684\u65f6\u5019\uff0c\u5efa\u8bae\u5bf9\u5176\u8fdb\u884c force merge</p> <ul> <li>\u63d0\u5347\u67e5\u8be2\u901f\u5ea6 </li> <li>\u51cf\u5c11\u5185\u5b58\u5f00\u9500</li> </ul> </li> <li> <p>\u6700\u7ec8\u5206\u6210\u51e0\u4e2a segments \u6bd4\u8f83\u5408\u9002?</p> <ul> <li>\u8d8a\u5c11\u8d8a\u597d\uff0c\u6700\u597d\u53ef\u4ee5 force merge \u6210 1 \u4e2a\uff0c\u4f46\u662f\uff0cForce Merge \u4f1a\u5360\u7528\u5927\u91cf\u7684\u7f51\u7edc\uff0cIO \u548c CPU</li> <li>\u5982\u679c\u4e0d\u80fd\u5728\u4e1a\u52a1\u9ad8\u5cf0\u671f\u4e4b\u524d\u505a\u5b8c\uff0c\u5c31\u9700\u8981\u8003\u8651\u589e\u5927\u6700\u7ec8\u7684\u5206\u6bb5\u6570<ul> <li>Shard \u7684\u5927\u5c0f</li> <li><code>Index.merge.policy.max_merged_segment</code> \u7684\u5927\u5c0f</li> </ul> </li> </ul> </li> </ul> <p></p>"},{"location":"chap12/8chap12_Circuit_Breaker/","title":"\u7b2c\u516b\u8282 \u7f13\u5b58\u53ca\u4f7f\u7528 Circuit Breaker \u9650\u5236\u5185\u5b58\u4f7f\u7528","text":""},{"location":"chap12/8chap12_Circuit_Breaker/#1inside-the-jvm-heap","title":"1\u3001Inside the JVM Heap","text":"<p>Elasticsearch \u7684\u7f13\u5b58\u4e3b\u8981\u5206\u6210\u4e09\u5927\u7c7b</p> <ul> <li>Node Query Cache (Filter Context)</li> <li>Shard Query Cache (Cache Query\u7684\u7ed3\u679c)</li> <li>Fielddata Cache</li> </ul> <p></p>"},{"location":"chap12/8chap12_Circuit_Breaker/#2shard-request-cache","title":"2\u3001Shard Request Cache","text":""},{"location":"chap12/8chap12_Circuit_Breaker/#2-1","title":"2-1 \u7f13\u5b58\u6bcf\u4e2a\u5206\u7247\u4e0a\u7684\u67e5\u8be2\u7ed3\u679c","text":"<ul> <li>\u53ea\u4f1a\u7f13\u5b58\u8bbe\u7f6e\u4e86 <code>size=0</code> \u7684\u67e5\u8be2\u5bf9\u5e94\u7684\u7ed3\u679c\u3002</li> <li>\u4e0d\u4f1a\u7f13\u5b58<code>hits</code>\u3002\u4f46\u662f\u4f1a\u7f13\u5b58 <code>Aggregations</code>\u548c <code>Suggestions</code></li> </ul>"},{"location":"chap12/8chap12_Circuit_Breaker/#2-2-cache-key","title":"2-2 Cache Key","text":"<ul> <li>LRU \u7b97\u6cd5\uff0c\u5c06\u6574\u4e2a JSON \u67e5\u8be2\u4e32\u4f5c\u4e3a Key\uff0c\u4e0e JSON \u5bf9 \u8c61\u7684\u987a\u5e8f\u76f8\u5173</li> </ul>"},{"location":"chap12/8chap12_Circuit_Breaker/#2-3","title":"2-3 \u9759\u6001\u914d\u7f6e","text":"<ul> <li>\u6570\u636e\u8282\u70b9: <code>indices.requests.cache.size: \u201c1%\u201d</code></li> </ul>"},{"location":"chap12/8chap12_Circuit_Breaker/#3fielddata-cache","title":"3\u3001Fielddata Cache","text":"<ul> <li>\u9664\u4e86 Text \u7c7b\u578b\uff0c\u9ed8\u8ba4\u90fd\u91c7\u7528 <code>doc_values</code>\u3002\u8282\u7ea6\u4e86\u5185\u5b58<ul> <li>Aggregation \u7684 Global ordinals \u4e5f\u4fdd\u5b58\u5728 Fielddata cache \u4e2d</li> </ul> </li> <li>Text \u7c7b\u578b\u7684\u5b57\u6bb5\u9700\u8981\u6253\u5f00 Fileddata \u624d\u80fd\u5bf9\u5176\u8fdb\u884c\u805a\u5408\u548c\u6392\u5e8f<ul> <li>Text \u7ecf\u8fc7\u5206\u8bcd\uff0c\u6392\u5e8f\u548c\u805a\u5408\u6548\u679c\u4e0d\u4f73\uff0c\u5efa\u8bae\u4e0d\u8981\u8f7b\u6613\u4f7f\u7528</li> </ul> </li> <li>\u914d\u7f6e<ul> <li>\u53ef\u4ee5\u63a7\u5236 <code>Indices.fielddata.cache.size</code>, \u907f\u514d\u4ea7\u751f GC (\u9ed8\u8ba4\u65e0\u9650\u5236)</li> </ul> </li> </ul>"},{"location":"chap12/8chap12_Circuit_Breaker/#4","title":"4\u3001\u7f13\u5b58\u5931\u6548","text":""},{"location":"chap12/8chap12_Circuit_Breaker/#4-1-node-query-cache","title":"4-1 Node Query Cache","text":"<p>\u4fdd\u5b58\u7684\u662f Segment \u7ea7\u7f13\u5b58\u547d\u4e2d\u7684\u7ed3\u679c\u3002Segment \u88ab\u5408\u5e76\u540e\uff0c\u7f13\u5b58\u4f1a\u5931\u6548</p>"},{"location":"chap12/8chap12_Circuit_Breaker/#4-2-shard-request-cache","title":"4-2 Shard Request Cache","text":"<ul> <li>\u5206\u7247 <code>Refresh</code> \u65f6\u5019\uff0c<code>Shard Request Cache</code> \u4f1a\u5931\u6548\u3002</li> <li>\u5982\u679c Shard \u5bf9\u5e94\u7684\u6570\u636e\u9891\u7e41\u53d1\u751f\u53d8\u5316\uff0c\u8be5\u7f13\u5b58\u7684\u6548\u7387\u4f1a\u5f88\u5dee</li> </ul>"},{"location":"chap12/8chap12_Circuit_Breaker/#4-3-fielddata-cache","title":"4-3 Fielddata Cache","text":"<p>Segment \u88ab\u5408\u5e76\u540e\uff0c\u4f1a\u5931\u6548</p>"},{"location":"chap12/8chap12_Circuit_Breaker/#5","title":"5\u3001\u7ba1\u7406\u5185\u5b58\u7684\u91cd\u8981\u6027","text":"<ul> <li> <p>Elasticsearch \u9ad8\u6548\u8fd0\u7ef4\u4f9d\u8d56\u4e8e\u5185\u5b58\u7684\u5408\u7406\u5206\u914d</p> <ul> <li>\u53ef\u7528\u5185\u5b58\u4e00\u534a\u5206\u914d\u7ed9 JVM\uff0c\u4e00\u534a\u7559\u7ed9\u64cd\u4f5c\u7cfb\u7edf\uff0c\u7f13\u5b58\u7d22\u5f15\u6587\u4ef6</li> </ul> </li> <li> <p>\u5185\u5b58\u95ee\u9898\uff0c\u5f15\u53d1\u7684\u95ee\u9898</p> <ul> <li>\u957f\u65f6\u95f4 GC\uff0c\u5f71\u54cd\u8282\u70b9\uff0c\u5bfc\u81f4\u96c6\u7fa4\u54cd\u5e94\u7f13\u6162</li> <li>OOM\uff0c \u5bfc\u81f4\u4e22\u8282\u70b9</li> </ul> </li> </ul>"},{"location":"chap12/8chap12_Circuit_Breaker/#6","title":"6\u3001\u8bca\u65ad\u5185\u5b58\u72b6\u51b5","text":"<p>\u67e5\u770b\u5404\u4e2a\u8282\u70b9\u7684\u5185\u5b58\u72b6\u51b5</p> <ul> <li><code>GET _cat/nodes?v</code></li> <li><code>GET _nodes/stats/indices?pretty</code> </li> <li><code>GET _cat/nodes?v&amp;h=name,queryCacheMemory,queryCacheEvictions,requestCacheMemory,reques tCacheHitCount,request_cache.miss_count</code></li> <li><code>GET _cat/nodes?h=name,port,segments.memory,segments.index_writer_memory,fielddata.memo ry_size,query_cache.memory_size,request_cache.memory_size&amp;v</code></li> </ul>"},{"location":"chap12/8chap12_Circuit_Breaker/#7","title":"7\u3001\u4e00\u4e9b\u5e38\u89c1\u7684\u5185\u5b58\u95ee\u9898","text":""},{"location":"chap12/8chap12_Circuit_Breaker/#7-1-segments-full-gc","title":"7-1 Segments \u4e2a\u6570\u8fc7\u591a\uff0c\u5bfc\u81f4 full GC","text":"<ul> <li>\u73b0\u8c61:\u96c6\u7fa4\u6574\u4f53\u54cd\u5e94\u7f13\u6162\uff0c\u4e5f\u6ca1\u6709\u7279\u522b\u591a\u7684\u6570\u636e\u8bfb\u5199\u3002\u4f46\u662f\u53d1\u73b0\u8282\u70b9\u5728\u6301\u7eed\u8fdb\u884c Full GC</li> <li>\u5206\u6790:\u67e5\u770b Elasticsearch \u7684\u5185\u5b58\u4f7f\u7528\uff0c\u53d1\u73b0 segments.memory \u5360\u7528\u5f88\u5927\u7a7a\u95f4</li> <li>\u89e3\u51b3:\u901a\u8fc7 force merge\uff0c\u628a segments \u5408\u5e76\u6210\u4e00\u4e2a\u3002</li> <li>\u5efa\u8bae:<ul> <li>\u5bf9\u4e8e\u4e0d\u5728\u5199\u5165\u548c\u66f4\u65b0\u7684\u7d22\u5f15\uff0c\u53ef\u4ee5\u5c06\u5176\u8bbe\u7f6e\u6210\u53ea\u8bfb\u3002</li> <li>\u540c\u65f6\uff0c\u8fdb\u884c force merge \u64cd\u4f5c\u3002</li> <li>\u5982\u679c\u95ee\u9898\u4f9d\u7136\u5b58\u5728\uff0c\u5219\u9700\u8981\u8003\u8651\u6269\u5bb9\u3002</li> <li>\u6b64\u5916\uff0c\u5bf9\u7d22\u5f15\u8fdb\u884c force merge \uff0c\u8fd8\u53ef\u4ee5\u51cf\u5c11\u5bf9 global_ordinals \u6570\u636e\u7ed3\u6784\u7684\u6784\u5efa\uff0c\u51cf\u5c11\u5bf9 fielddata cache \u7684\u5f00\u9500</li> </ul> </li> </ul>"},{"location":"chap12/8chap12_Circuit_Breaker/#7-2-field-data-cache-full-gc","title":"7-2 Field data cache \u8fc7\u5927\uff0c\u5bfc\u81f4 full GC","text":"<ul> <li>\u73b0\u8c61:\u96c6\u7fa4\u6574\u4f53\u54cd\u5e94\u7f13\u6162\uff0c\u4e5f\u6ca1\u6709\u7279\u522b\u591a\u7684\u6570\u636e\u8bfb\u5199\u3002\u4f46\u662f\u53d1\u73b0\u8282\u70b9\u5728\u6301\u7eed\u8fdb\u884c Full GC</li> <li>\u5206\u6790:\u67e5\u770b Elasticsearch \u7684\u5185\u5b58\u4f7f\u7528\uff0c\u53d1\u73b0 fielddata.memory.size \u5360\u7528\u5f88\u5927\u7a7a\u95f4\u3002\u540c\u65f6\uff0c \u6570\u636e\u4e0d\u5b58\u5728\u5199\u5165\u548c\u66f4\u65b0\uff0c\u4e5f\u6267\u884c\u8fc7 segments merge\u3002</li> <li>\u89e3\u51b3:\u5c06 indices.fielddata.cache.size \u8bbe\u5c0f\uff0c\u91cd\u542f\u8282\u70b9\uff0c\u5806\u5185\u5b58\u6062\u590d\u6b63\u5e38</li> <li>\u5efa\u8bae:   <ul> <li>Field data cache \u7684\u6784\u5efa\u6bd4\u8f83\u91cd\uff0cElasticsearch \u4e0d\u4f1a\u4e3b\u52a8\u91ca\u653e\uff0c</li> <li>\u6240\u4ee5\u8fd9\u4e2a\u503c\u5e94\u8be5\u8bbe\u7f6e\u7684\u4fdd\u5b88\u4e00\u4e9b\u3002\u5982\u679c\u4e1a\u52a1\u4e0a\u786e\u5b9e\u6709\u6240\u9700\u8981\uff0c\u53ef\u4ee5\u901a\u8fc7\u589e\u52a0\u8282\u70b9\uff0c\u6269\u5bb9\u89e3\u51b3</li> </ul> </li> </ul>"},{"location":"chap12/8chap12_Circuit_Breaker/#7-3-full-gc","title":"7-3 \u590d\u6742\u7684\u5d4c\u5957\u805a\u5408\uff0c\u5bfc\u81f4\u96c6\u7fa4 full GC","text":"<ul> <li>\u73b0\u8c61:\u8282\u70b9\u54cd\u5e94\u7f13\u6162\uff0c\u6301\u7eed\u8fdb\u884c Full GC</li> <li>\u5206\u6790:\u5bfc\u51fa Dump \u5206\u6790\u3002\u53d1\u73b0\u5185\u5b58\u4e2d\u6709\u5927\u91cf bucket \u5bf9\u8c61\uff0c\u67e5\u770b \u65e5\u5fd7\uff0c\u53d1\u73b0\u590d\u6742\u7684\u5d4c\u5957\u805a\u5408</li> <li>\u89e3\u51b3:\u4f18\u5316\u805a\u5408</li> <li>\u5efa\u8bae:<ul> <li>\u5728\u5927\u91cf\u6570\u636e\u96c6\u4e0a\u8fdb\u884c\u5d4c\u5957\u805a\u5408\u67e5\u8be2\uff0c\u9700\u8981\u5f88\u5927\u7684\u5806\u5185\u5b58\u6765\u5b8c\u6210\u3002</li> <li>\u5982\u679c\u4e1a\u52a1\u573a\u666f\u786e\u5b9e\u9700\u8981\u3002 \u5219\u9700\u8981\u589e\u52a0\u786c\u4ef6\u8fdb\u884c\u6269\u5c55\u3002</li> <li>\u540c\u65f6\uff0c\u4e3a\u4e86\u907f\u514d\u8fd9\u7c7b\u67e5\u8be2\u5f71\u54cd\u6574\u4e2a\u96c6\u7fa4\uff0c\u9700\u8981\u8bbe\u7f6e Circuit Breaker \u548c <code>search.max_buckets</code> \u7684\u6570\u503c</li> </ul> </li> </ul>"},{"location":"chap12/8chap12_Circuit_Breaker/#8circuit-breaker","title":"8\u3001Circuit Breaker","text":"<p>\u5305\u542b\u591a\u79cd\u65ad\u8def\u5668\uff0c\u907f\u514d\u4e0d\u5408\u7406\u64cd\u4f5c\u5f15\u53d1\u7684 OOM\uff0c\u6bcf\u4e2a\u65ad\u8def\u5668\u53ef\u4ee5\u6307\u5b9a\u5185\u5b58\u4f7f\u7528\u7684\u9650\u5236</p> <ul> <li>Parent circuit breaker:      \u8bbe\u7f6e\u6240\u6709\u7684\u7194\u65ad\u5668\u53ef\u4ee5\u4f7f\u7528\u7684\u5185\u5b58\u7684\u603b\u91cf</li> <li>Fielddata circuit breaker:   \u52a0\u8f7d fielddata \u6240\u9700\u8981\u7684\u5185\u5b58</li> <li>Request circuit breaker: \u9632\u6b62\u6bcf\u4e2a\u8bf7\u6c42\u7ea7\u6570\u636e\u7ed3\u6784\u8d85\u8fc7\u4e00\u5b9a\u7684\u5185\u5b58(\u4f8b\u5982\u805a\u5408\u8ba1\u7b97\u7684\u5185\u5b58) </li> <li>In flight circuit breaker:   Request\u4e2d\u7684\u65ad\u8def\u5668</li> <li>Accounting request circuit breaker: \u8bf7\u6c42\u7ed3\u675f\u540e\u4e0d\u80fd\u91ca\u653e\u7684\u5bf9\u8c61\u6240\u5360\u7528\u7684\u5185\u5b58</li> </ul>"},{"location":"chap12/8chap12_Circuit_Breaker/#9circuit-breaker","title":"9\u3001Circuit Breaker \u7edf\u8ba1\u4fe1\u606f","text":"<ul> <li><code>GET /_nodes/stats/breaker?</code><ul> <li>Tripped \u5927\u4e8e 0\uff0c \u8bf4\u660e\u6709\u8fc7\u7194\u65ad</li> <li>Limit size \u4e0e estimated size \u7ea6\u63a5\u8fd1\uff0c\u8d8a\u53ef\u80fd\u5f15\u53d1\u7194\u65ad</li> </ul> </li> <li>\u5343\u4e07\u4e0d\u8981\u89e6\u53d1\u4e86\u7194\u65ad\uff0c\u5c31\u76f2\u76ee\u8c03\u5927\u53c2\u6570\uff0c\u6709\u53ef\u80fd\u4f1a\u5bfc\u81f4\u96c6\u7fa4\u51fa\u95ee\u9898\uff0c\u4e5f\u4e0d\u56e0\u8be5\u76f2\u76ee\u8c03\u5c0f\uff0c\u9700\u8981\u8fdb\u884c\u8bc4\u4f30</li> <li>\u5efa\u8bae\u5c06\u96c6\u7fa4\u5347\u7ea7\u5230 7.x\uff0c\u66f4\u597d\u7684 Circuit Breaker \u5b9e\u73b0\u673a\u5236<ul> <li>\u589e\u52a0\u4e86<code>indices.breaker.total.use_real_memory</code> \u914d\u7f6e\u9879\uff0c\u53ef\u4ee5\u66f4\u52a0\u7cbe\u51c6\u7684\u5206\u6790\u5185\u5b58\u72b6\u51b5\uff0c\u907f\u514d OOM</li> </ul> </li> </ul> <p>https://www.elastic.co/blog/improving-node-resiliency-with-the-real-memory-circuit-breaker</p> <p></p>"},{"location":"chap12/9chap12_es_ops/","title":"\u7b2c\u4e5d\u8282 \u4e00\u4e9b\u8fd0\u7ef4\u76f8\u5173\u7684\u5efa\u8bae","text":""},{"location":"chap12/9chap12_es_ops/#1","title":"1\u3001\u96c6\u7fa4\u7684\u751f\u547d\u5468\u671f\u7ba1\u7406","text":""},{"location":"chap12/9chap12_es_ops/#1-1","title":"1-1 \u9884\u4e0a\u7ebf","text":"<p>\u8bc4\u4f30\u7528\u6237\u7684\u9700\u6c42\u53ca\u4f7f\u7528\u573a\u666f / \u6570\u636e\u5efa\u6a21 / \u5bb9\u91cf\u89c4\u5212 / \u9009\u62e9\u5408\u9002\u7684\u90e8\u7f72\u67b6\u6784 / \u6027\u80fd\u6d4b\u8bd5</p>"},{"location":"chap12/9chap12_es_ops/#1-2","title":"1-2 \u4e0a\u7ebf","text":"<ul> <li>\u76d1\u63a7\u6d41\u91cf / \u5b9a\u671f\u68c0\u67e5\u6f5c\u5728\u95ee\u9898 (\u9632\u60a3\u4e8e\u672a\u7136\uff0c\u53d1\u73b0\u9519\u8bef\u7684\u4f7f\u7528\u65b9\u5f0f\uff0c\u53ca\u65f6\u589e\u52a0\u673a\u5668)</li> <li>\u5bf9\u7d22\u5f15\u8fdb\u884c\u4f18\u5316(Index Lifecycle Management)\uff0c\u68c0\u6d4b\u662f\u5426\u5b58\u5728\u4e0d\u5747\u8861\u800c\u5bfc\u81f4\u6709\u90e8\u5206\u8282\u70b9\u8fc7\u70ed</li> <li>\u5b9a\u671f\u6570\u636e\u5907\u4efd / \u6eda\u52a8\u5347\u7ea7</li> </ul>"},{"location":"chap12/9chap12_es_ops/#1-3-stage-decommission","title":"1-3 \u4e0b\u67b6\u524d\u76d1\u63a7\u6d41\u91cf\uff0c\u5b9e\u73b0 Stage Decommission","text":""},{"location":"chap12/9chap12_es_ops/#2","title":"2\u3001\u90e8\u7f72\u7684\u5efa\u8bae","text":"<ul> <li>\u6839\u636e\u5b9e\u9645\u573a\u666f\uff0c\u9009\u62e9\u5408\u9002\u7684\u90e8\u7f72\u65b9\u5f0f\uff0c\u9009\u62e9\u5408\u7406\u7684\u786c\u4ef6\u914d\u7f6e<ul> <li>\u641c\u7d22\u7c7b</li> <li>\u65e5\u5fd7/\u6307\u6807</li> </ul> </li> <li>\u90e8\u7f72\u8981\u8003\u8651\uff0c\u53cd\u4eb2\u548c\u6027(Anti-Affinity)<ul> <li>\u5c3d\u91cf\u5c06\u673a\u5668\u5206\u6563\u5728\u4e0d\u540c\u7684\u673a\u67b6\u3002\u4f8b\u5982\uff0c3 \u53f0 Master \u8282\u70b9\u5fc5\u987b\u5206\u6563\u5728\u4e0d\u540c\u7684\u673a\u67b6\u4e0a</li> <li>\u5584\u7528 Shard Filtering \u8fdb\u884c\u914d\u7f6e</li> </ul> </li> </ul>"},{"location":"chap12/9chap12_es_ops/#3","title":"3\u3001\u4f7f\u7528\u8981\u9075\u5faa\u4e00\u5b9a\u7684\u89c4\u8303","text":""},{"location":"chap12/9chap12_es_ops/#3-1-mapping","title":"3-1  Mapping","text":"<ul> <li>\u751f\u4ea7\u73af\u5883\u4e2d\u7d22\u5f15\u5e94\u8003\u8651\u7981\u6b62 Dynamic Index Mapping\uff0c\u907f\u514d\u8fc7\u591a\u5b57\u6bb5\u5bfc\u81f4 Cluster State \u5360\u7528\u8fc7\u591a</li> <li>\u7981\u6b62\u7d22\u5f15\u81ea\u52a8\u521b\u5efa\u7684\u529f\u80fd\uff0c\u521b\u5efa\u65f6\u5fc5\u987b\u63d0\u4f9b Mapping \u6216\u901a\u8fc7 Index Template \u8fdb\u884c\u8bbe\u5b9a</li> </ul>"},{"location":"chap12/9chap12_es_ops/#3-2-slowlogs-pattern","title":"3-2 \u8bbe\u7f6e Slowlogs\uff0c\u53d1\u73b0\u4e00\u4e9b\u6027\u80fd\u4e0d\u597d\uff0c\u751a\u81f3\u662f\u9519\u8bef\u7684\u4f7f\u7528 Pattern","text":"<ul> <li>\u4f8b\u5982: \u9519\u8bef\u7684\u5c06\u7f51\u5740\u6620\u5c04\u6210 keyword\uff0c\u7136\u540e\u7528\u901a\u914d\u7b26\u67e5\u8be2\u3002\u5e94\u8be5\u4f7f\u7528 Text\uff0c\u7ed3\u5408 URL \u5206\u8bcd\u5668</li> <li>\u4e25\u7981\u4e00\u5207 <code>\u201c*\u201d</code>\u5f00\u5934\u7684\u901a\u914d\u7b26\u67e5\u8be2</li> </ul>"},{"location":"chap12/9chap12_es_ops/#4","title":"4\u3001\u5bf9\u91cd\u8981\u7684\u6570\u636e\u8fdb\u884c\u5907\u4efd","text":"<ul> <li>\u96c6\u7fa4\u5907\u4efd</li> <li>https://www.elastic.co/guide/en/elasticsearch/reference/7.1/modules-snapshots.html</li> </ul>"},{"location":"chap12/9chap12_es_ops/#5","title":"5\u3001\u5b9a\u671f\u66f4\u65b0\u5230\u65b0\u7248\u672c","text":"<ul> <li>ES \u5728\u65b0\u7248\u672c\u4e2d\u4f1a\u6301\u7eed\u5bf9\u6027\u80fd\u4f5c\u51fa\u4f18\u5316;\u63d0\u4f9b\u66f4\u591a\u7684\u65b0\u529f\u80fd<ul> <li>Circuit breaker \u5b9e\u73b0\u7684\u6539\u8fdb</li> </ul> </li> <li>\u4fee\u590d\u4e00\u4e9b\u5df2\u77e5\u7684 bug \u548c\u5b89\u5168\u9690\u60a3</li> </ul>"},{"location":"chap12/9chap12_es_ops/#5-1-es","title":"5-1 ES \u7684\u7248\u672c","text":"<p>Elasticsearch \u7684\u7248\u672c\u683c\u5f0f\u662f: X.Y.Z</p> <ul> <li>X: Major</li> <li>Y: Minor</li> <li>Z: Patch</li> </ul> <p>Elasticsearch \u53ef\u4ee5\u4f7f\u7528\u4e0a\u4e00\u4e2a\u4e3b\u7248\u672c\u7684\u7d22\u5f15</p> <ul> <li>7.x \u53ef\u4ee5\u4f7f\u7528 6.x / 7.x \u4e0d\u652f\u6301\u4f7f\u7528 5.x </li> <li>5.x \u53ef\u4ee5\u4f7f\u7528 2.x</li> </ul>"},{"location":"chap12/9chap12_es_ops/#5-2-rolling-upgrade-vs-full-cluster-restart","title":"5-2 Rolling Upgrade v.s Full Cluster Restart","text":"<p>Rolling Upgrade</p> <ul> <li>\u6ca1\u6709 Downtime</li> <li>https://www.elastic.co/guide/en/elasticsearch/reference/7.1/rolling-upgrades.html</li> </ul> <p>Full Cluster Restart</p> <ul> <li>\u96c6\u7fa4\u5728\u66f4\u65b0\u671f\u95f4\u4e0d\u53ef\u7528 </li> <li>\u5347\u7ea7\u66f4\u5feb</li> </ul>"},{"location":"chap12/9chap12_es_ops/#5-3-full-restart","title":"5-3 Full Restart \u7684\u6b65\u9aa4","text":"<ul> <li>\u505c\u6b62\u7d22\u5f15\u6570\u636e\uff0c\u540c\u65f6\u5907\u4efd\u96c6\u7fa4</li> <li>Disable Shard Allocation (Persistent) </li> <li>\u6267\u884c Synced Flush</li> <li>\u5173\u95ed\u5e76\u66f4\u65b0\u6240\u6709\u8282\u70b9</li> <li>\u5148\u8fd0\u884c\u6240\u6709 Master \u8282\u70b9 / \u518d\u8fd0\u884c\u5176\u4ed6\u8282\u70b9 </li> <li>\u7b49\u96c6\u7fa4\u53d8\u9ec4\u540e\u6253\u5f00 Shard Allocation</li> </ul> <pre><code>curl -XGET 'http://ip:9200/_cluster/health?pretty=true'\ncurl -XGET 'http://ip:9200/_cat/indices?v'\n</code></pre> <p>Disable Shard Allocation (Persistent) </p> <pre><code>curl -X PUT \"http://ip:9200/_cluster/settings\" -H 'Content-Type: application/json' -d'\n\n{\n\n   \"transient\":{\n\n      \"cluster.routing.allocation.enable\":\"none\"\n\n   }\n\n}\n'\n</code></pre> <p>\u6267\u884c Synced Flush</p> <p><code>curl -X POST \"http://ip:9200/_flush/synced\"</code></p> <p>\u7b49\u96c6\u7fa4\u53d8\u9ec4\u540e\u6253\u5f00 Shard Allocation</p> <pre><code> curl -X PUT \"http://ip:9200/_cluster/settings\" -H 'Content-Type: application/json' -d'\n\n{\n\n   \"transient\":{\n\n      \"cluster.routing.allocation.enable\":\"all\"\n\n   }\n\n}\n\n'\n</code></pre>"},{"location":"chap12/9chap12_es_ops/#6-cheat-sheet","title":"6\u3001\u8fd0\u7ef4 Cheat Sheet","text":""},{"location":"chap12/9chap12_es_ops/#6-1","title":"6-1 \u79fb\u52a8\u5206\u7247","text":"<ul> <li>\u4ece\u4e00\u4e2a\u8282\u70b9\u79fb\u52a8\u5206\u7247\u5230\u53e6\u5916\u4e00\u4e2a\u8282\u70b9</li> <li>\u4f7f\u7528\u573a\u666f:<ul> <li>\u5f53\u4e00\u4e2a\u6570\u636e\u8282\u70b9\u4e0a\u6709\u8fc7\u591a Hot Shards; </li> <li>\u53ef\u4ee5\u901a\u8fc7\u624b\u52a8\u5206\u914d\u5206\u7247\u5230\u7279\u5b9a\u7684\u8282\u70b9\u89e3\u51b3</li> </ul> </li> </ul>"},{"location":"chap12/9chap12_es_ops/#6-2","title":"6-2 \u4ece\u96c6\u7fa4\u4e2d\u79fb\u9664\u4e00\u4e2a\u8282\u70b9","text":"<p>\u4f7f\u7528\u573a\u666f:\u5f53\u4f60\u60f3\u79fb\u9664\u4e00\u4e2a\u8282\u70b9\uff0c\u6216\u8005\u5bf9\u4e00\u4e2a\u673a\u5668\u8fdb\u884c\u7ef4\u62a4\u3002\u540c\u65f6\u4f60\u53c8\u4e0d\u5e0c\u671b\u5bfc\u81f4\u96c6\u7fa4\u7684\u989c\u8272\u53d8 \u9ec4\u6216\u8005\u53d8\u7ea2</p> <p></p>"},{"location":"chap12/9chap12_es_ops/#6-3-allocation-recovery","title":"6-3 \u63a7\u5236 Allocation \u548c Recovery","text":"<p>\u4f7f\u7528\u573a\u666f:\u63a7\u5236 Allocation \u548c Recovery \u7684\u901f\u7387</p> <p></p>"},{"location":"chap12/9chap12_es_ops/#6-4-synced-flush","title":"6-4 Synced Flush","text":"<p>\u4f7f\u7528\u573a\u666f:\u9700\u8981\u91cd\u542f\u4e00\u4e2a\u8282\u70b9\u3002</p> <p>\u901a\u8fc7 <code>synced flush</code>\uff0c\u53ef\u4ee5\u5728\u7d22\u5f15\u4e0a\u653e\u7f6e\u4e00\u4e2a sync ID\u3002\u8fd9\u6837\u53ef\u4ee5\u63d0\u4f9b\u8fd9\u4e9b\u5206\u7247\u7684 Recovery \u7684\u65f6\u95f4</p> <pre><code>POST _flush/sycned\n</code></pre>"},{"location":"chap12/9chap12_es_ops/#6-5","title":"6-5 \u6e05\u7a7a\u8282\u70b9\u4e0a\u7684\u7f13\u5b58","text":"<p>\u4f7f\u7528\u573a\u666f:\u8282\u70b9\u4e0a\u51fa\u73b0\u4e86\u9ad8\u5185\u5b58\u5360\u7528\u3002\u53ef\u4ee5\u6267\u884c\u6e05\u9664\u7f13\u5b58\u7684\u64cd\u4f5c\u3002\u8fd9\u4e2a\u64cd\u4f5c\u4f1a\u5f71\u54cd\u96c6\u7fa4\u7684\u6027\u80fd\uff0c \u4f46\u662f\u4f1a\u907f\u514d\u4f60\u7684\u96c6\u7fa4\u51fa\u73b0 OOM \u7684\u95ee\u9898</p> <pre><code>POST _cache/clear\n</code></pre>"},{"location":"chap12/9chap12_es_ops/#6-6","title":"6-6 \u63a7\u5236\u641c\u7d22\u7684\u961f\u5217","text":"<p>\u4f7f\u7528\u573a\u666f: \u5f53\u641c\u7d22\u7684\u54cd\u5e94\u65f6\u95f4\u8fc7\u957f\uff0c\u770b\u5230\u6709\u201creject\u201d \u6307\u6807\u7684\u589e\u52a0\uff0c\u90fd\u53ef\u4ee5\u9002\u5f53\u589e\u52a0\u8be5\u6570\u503c</p> <p></p>"},{"location":"chap12/9chap12_es_ops/#6-7-circuit-breaker","title":"6-7 \u8bbe\u7f6e Circuit Breaker","text":"<p>\u4f7f\u7528\u573a\u666f:\u8bbe\u7f6e\u5404\u7c7b Circuit Breaker\u3002\u907f\u514d OOM \u7684\u53d1\u751f\u3002</p> <p></p>"},{"location":"chap12/9chap12_es_ops/#7","title":"7\u3001\u8fd0\u7ef4\u5efa\u8bae","text":"<ul> <li>\u4e86\u89e3\u7528\u6237\u573a\u666f\uff0c\u9009\u62e9\u5408\u9002\u90e8\u7f72 </li> <li>\u5b9a\u671f\u68c0\u67e5\uff0c\u53d1\u73b0\u6f5c\u5728\u95ee\u9898</li> <li>\u5bf9\u91cd\u8981\u7684\u6570\u636e\u8fdb\u884c\u5907\u4efd</li> <li>\u4fdd\u6301\u7248\u672c\u5347\u7ea7</li> </ul>"},{"location":"chap13/1chap13_es_shrink_rolloverapi/","title":"\u7b2c\u4e00\u8282 \u4f7f\u7528 Shrink \u4e0e Rollover API \u7ba1\u7406\u7d22\u5f15","text":""},{"location":"chap13/1chap13_es_shrink_rolloverapi/#1-api","title":"1\u3001\u7d22\u5f15\u7ba1\u7406 API","text":"<ul> <li>Open / Close Index: \u7d22\u5f15\u5173\u95ed\u540e\u65e0\u6cd5\u8fdb\u884c\u8bfb\u5199\uff0c\u4f46\u662f\u7d22\u5f15\u6570\u636e\u4e0d\u4f1a\u88ab\u5220\u9664</li> <li>Shrink Index:\u53ef\u4ee5\u5c06\u7d22\u5f15\u7684\u4e3b\u5206\u7247\u6570\u6536\u7f29\u5230\u8f83\u5c0f\u7684\u503c</li> <li>Split Index:\u53ef\u4ee5\u6269\u5927\u4e3b\u5206\u7247\u4e2a\u6570</li> <li>Rollover Index:\u7c7b\u4f3c Log4J \u8bb0\u5f55\u65e5\u5fd7\u7684\u65b9\u5f0f\uff0c\u7d22\u5f15\u5c3a\u5bf8\u6216\u8005\u65f6\u95f4\u8d85\u8fc7\u4e00\u5b9a\u503c\u540e\uff0c\u521b\u5efa\u65b0\u7684</li> <li>Rollup Index:\u5bf9\u6570\u636e\u8fdb\u884c\u5904\u7406\u540e\uff0c\u91cd\u65b0\u5199\u5165\uff0c\u51cf\u5c11\u6570\u636e\u91cf</li> </ul>"},{"location":"chap13/1chap13_es_shrink_rolloverapi/#2open-close-index-api","title":"2\u3001Open / Close Index API","text":"<ul> <li>\u7d22\u5f15\u5173\u95ed\u540e\uff0c\u5bf9\u96c6\u7fa4\u7684\u76f8\u5173\u5f00\u9500\u57fa\u672c\u964d\u4f4e\u4e3a 0 </li> <li>\u4f46\u662f\u65e0\u6cd5\u88ab\u8bfb\u53d6\u548c\u641c\u7d22</li> <li>\u5f53\u9700\u8981\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u91cd\u65b0\u6253\u5f00</li> </ul>"},{"location":"chap13/1chap13_es_shrink_rolloverapi/#2-1-open-close-index-api-demo","title":"2-1 Open / Close Index API DEMO","text":"<pre><code># \u6253\u5f00\u5173\u95ed\u7d22\u5f15\nDELETE test\n#\u67e5\u770b\u7d22\u5f15\u662f\u5426\u5b58\u5728\nHEAD test\n\n{\"statusCode\":404,\"error\":\"Not Found\",\"message\":\"404 - Not Found\"}\n</code></pre> <pre><code>PUT test/_doc/1\n{\n  \"key\":\"value\"\n}\n\n#\u5173\u95ed\u7d22\u5f15\nPOST /test/_close\n\n{\n  \"acknowledged\" : true,\n  \"shards_acknowledged\" : true,\n  \"indices\" : {\n    \"test\" : {\n      \"closed\" : true\n    }\n  }\n}\n</code></pre> <p>\u7d22\u5f15\u5b58\u5728</p> <pre><code>HEAD test\n\n200 - OK\n</code></pre> <p>\u65e0\u6cd5\u67e5\u8be2</p> <pre><code># \u65e0\u6cd5\u67e5\u8be2\nPOST test/_count\n\n{\n  \"error\" : {\n    \"root_cause\" : [\n      {\n        \"type\" : \"index_closed_exception\",\n        \"reason\" : \"closed\",\n        \"index_uuid\" : \"BmN-xvVSR56W5iAq3BvPTw\",\n        \"index\" : \"test\"\n      }\n    ],\n    \"type\" : \"index_closed_exception\",\n    \"reason\" : \"closed\",\n    \"index_uuid\" : \"BmN-xvVSR56W5iAq3BvPTw\",\n    \"index\" : \"test\"\n  },\n  \"status\" : 400\n}\n</code></pre> <p>\u6253\u5f00\u7d22\u5f15</p> <pre><code>#\u6253\u5f00\u7d22\u5f15\nPOST /test/_open\n\nPOST test/_search\n{\n  \"query\": {\n    \"match_all\": {}\n  }\n}\n\n...\n \"hits\" : {\n    \"total\" : {\n      \"value\" : 1,\n      \"relation\" : \"eq\"\n    },\n...\n</code></pre> <pre><code>POST test/_count\n</code></pre> <pre><code>{\n  \"count\" : 1,\n  \"_shards\" : {\n    \"total\" : 1,\n    \"successful\" : 1,\n    \"skipped\" : 0,\n    \"failed\" : 0\n  }\n}\n</code></pre> <p><code>close</code> \u7684\u7d22\u5f15\u4e0d\u80fd\u88ab\u67e5\u8be2\u3002\u8282\u7ea6\u4e86\u5185\u5b58\u5f00\u9500\u3002\u4f46\u662f\u78c1\u76d8\u7a7a\u95f4\u8fd8\u662f\u88ab\u5360\u7528\u7684\u3002\u5982\u679c\u4f60\u78c1\u76d8\u7a7a\u95f4\u8db3\u591f\u5f53\u7136\u53ef\u4ee5\u4e00\u76f4<code>close</code>\u5e76\u4e0d\u5220\u9664\u3002\u5f53\u7136\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u4f60\u53ef\u4ee5\u7ed3\u5408hot warm\u7684\u67b6\u6784\uff0c\u5b9a\u671f\u5c06\u7d22\u5f15\u79fb\u52a8\u5230\u5ec9\u4ef7\u7684\u5b58\u50a8\u4e0a\uff0c\u518d\u8fdb\u884c<code>close</code></p>"},{"location":"chap13/1chap13_es_shrink_rolloverapi/#3shrink-api","title":"3\u3001Shrink API","text":"<ul> <li>ES 5.x \u540e\u63a8\u51fa\u7684\u4e00\u4e2a\u65b0\u529f\u80fd\uff0c\u4f7f\u7528\u573a\u666f<ul> <li>\u7d22\u5f15\u4fdd\u5b58\u7684\u6570\u636e\u91cf\u6bd4\u8f83\u5c0f\uff0c\u9700\u8981\u91cd\u65b0\u8bbe\u5b9a\u4e3b\u5206\u7247\u6570</li> <li>\u7d22\u5f15\u4ece Hot \u79fb\u52a8\u5230 Warm \u540e\uff0c\u9700\u8981\u964d\u4f4e\u4e3b\u5206\u7247\u6570</li> </ul> </li> <li>\u4f1a\u4f7f\u7528\u548c\u6e90\u7d22\u5f15\u76f8\u540c\u7684\u914d\u7f6e\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u7d22\u5f15\uff0c\u4ec5\u4ec5\u964d\u4f4e\u4e3b\u5206\u7247\u6570<ul> <li>\u6e90\u5206\u7247\u6570\u5fc5\u987b\u662f\u76ee\u6807\u5206\u7247\u6570\u7684\u500d\u6570\u3002\u5982\u679c\u6e90\u5206\u7247\u6570\u662f\u7d20\u6570\uff0c\u76ee\u6807\u5206\u7247\u6570\u53ea\u80fd\u4e3a 1</li> <li>\u5982\u679c\u6587\u4ef6\u7cfb\u7edf\u652f\u6301\u786c\u94fe\u63a5\uff0c\u4f1a\u5c06 Segments \u786c\u8fde\u63a5\u5230\u76ee\u6807\u7d22\u5f15\uff0c\u6240\u4ee5\u6027\u80fd\u597d</li> </ul> </li> <li>\u5b8c\u6210\u540e\uff0c\u53ef\u4ee5\u5220\u9664\u6e90\u7d22\u5f15</li> </ul>"},{"location":"chap13/1chap13_es_shrink_rolloverapi/#3-1-shrink-api","title":"3-1 Shrink API","text":"<ul> <li>\u5206\u7247\u5fc5\u987b\u53ea\u8bfb</li> <li>\u6240\u6709\u7684\u5206\u7247\u5fc5\u987b\u5728\u540c\u4e00\u4e2a\u8282\u70b9\u4e0a </li> <li>\u96c6\u7fa4\u5065\u5eb7\u72b6\u6001\u4e3a Green</li> </ul>"},{"location":"chap13/1chap13_es_shrink_rolloverapi/#3-2-shrink-api-demo","title":"3-2 Shrink API Demo","text":"<pre><code># \u5728\u4e00\u4e2a hot-warm-cold\u7684\u96c6\u7fa4\u4e0a\u8fdb\u884c\u6d4b\u8bd5\n\nGET _cat/nodes\n\n172.19.0.6 49 97 5 0.11 0.21 0.58 dilmrt - es7_warm\n172.19.0.3 48 97 5 0.11 0.21 0.58 dilmrt * es7_hot\n172.19.0.2 71 97 5 0.11 0.21 0.58 dilmrt - es7_cold\n\nGET _cat/nodeattrs\n\nes7_warm 172.19.0.6 172.19.0.6 ml.machine_memory 3973804032\nes7_warm 172.19.0.6 172.19.0.6 ml.max_open_jobs  20\nes7_warm 172.19.0.6 172.19.0.6 box_type          warm\nes7_warm 172.19.0.6 172.19.0.6 xpack.installed   true\nes7_warm 172.19.0.6 172.19.0.6 transform.node    true\nes7_hot  172.19.0.3 172.19.0.3 ml.machine_memory 3973804032\nes7_hot  172.19.0.3 172.19.0.3 box_type          hot\nes7_hot  172.19.0.3 172.19.0.3 xpack.installed   true\nes7_hot  172.19.0.3 172.19.0.3 transform.node    true\nes7_hot  172.19.0.3 172.19.0.3 ml.max_open_jobs  20\nes7_cold 172.19.0.2 172.19.0.2 ml.machine_memory 3973804032\nes7_cold 172.19.0.2 172.19.0.2 ml.max_open_jobs  20\nes7_cold 172.19.0.2 172.19.0.2 box_type          cold\nes7_cold 172.19.0.2 172.19.0.2 xpack.installed   true\nes7_cold 172.19.0.2 172.19.0.2 transform.node    true\n</code></pre> <pre><code>DELETE my_source_index\nDELETE my_target_index\n</code></pre> <pre><code>PUT my_source_index\n{\n \"settings\": {\n   \"number_of_shards\": 4,\n   \"number_of_replicas\": 0\n }\n}\n\nPUT my_source_index/_doc/1\n{\n  \"key\":\"value\"\n}\n\nGET _cat/shards/my_source_index\n</code></pre> <pre><code>my_source_index 3 p STARTED 0 208b 172.19.0.2 es7_cold\nmy_source_index 2 p STARTED 0 208b 172.19.0.3 es7_hot\nmy_source_index 1 p STARTED 0 208b 172.19.0.6 es7_warm\nmy_source_index 0 p STARTED 0 208b 172.19.0.2 es7_cold\n</code></pre> <p>\u5206\u7247\u65703\uff0c\u4f1a\u5931\u8d25</p> <pre><code># \u5206\u7247\u65703\uff0c\u4f1a\u5931\u8d25\nPOST my_source_index/_shrink/my_target_index\n{\n  \"settings\": {\n    \"index.number_of_replicas\": 0,\n    \"index.number_of_shards\": 3,\n    \"index.codec\": \"best_compression\"\n  },\n  \"aliases\": {\n    \"my_search_indices\": {}\n  }\n}\n</code></pre> <p>Output</p> <pre><code>{\n  \"error\" : {\n    \"root_cause\" : [\n      {\n        \"type\" : \"illegal_argument_exception\",\n        \"reason\" : \"the number of source shards [4] must be a multiple of [3]\"\n      }\n    ],\n    \"type\" : \"illegal_argument_exception\",\n    \"reason\" : \"the number of source shards [4] must be a multiple of [3]\"\n  },\n  \"status\" : 400\n}\n</code></pre> <p>\u62a5\u9519\uff0c\u56e0\u4e3a\u6ca1\u6709\u7f6e\u6210 readonly</p> <pre><code>POST my_source_index/_shrink/my_target_index\n{\n  \"settings\": {\n    \"index.number_of_replicas\": 0,\n    \"index.number_of_shards\": 2,\n    \"index.codec\": \"best_compression\"\n  },\n  \"aliases\": {\n    \"my_search_indices\": {}\n  }\n}\n</code></pre> <p>500 - Internal Server Error</p> <pre><code>{\n  \"error\" : {\n    \"root_cause\" : [\n      {\n        \"type\" : \"illegal_state_exception\",\n        \"reason\" : \"index my_source_index must be read-only to resize index. use \\\"index.blocks.write=true\\\"\"\n      }\n    ],\n    \"type\" : \"illegal_state_exception\",\n    \"reason\" : \"index my_source_index must be read-only to resize index. use \\\"index.blocks.write=true\\\"\"\n  },\n  \"status\" : 500\n}\n\n</code></pre> <p>\u5c06 <code>my_source_index</code> \u8bbe\u7f6e\u4e3a\u53ea\u8bfb</p> <pre><code>#\u5c06 my_source_index \u8bbe\u7f6e\u4e3a\u53ea\u8bfb\nPUT /my_source_index/_settings\n{\n  \"settings\": {\n    \"index.blocks.write\": true\n  }\n}\n</code></pre> <p>\u62a5\u9519\uff0c\u5fc5\u987b\u90fd\u5728\u4e00\u4e2a\u8282\u70b9</p> <pre><code># \u62a5\u9519\uff0c\u5fc5\u987b\u90fd\u5728\u4e00\u4e2a\u8282\u70b9\nPOST my_source_index/_shrink/my_target_index\n{\n  \"settings\": {\n    \"index.number_of_replicas\": 0,\n    \"index.number_of_shards\": 2,\n    \"index.codec\": \"best_compression\"\n  },\n  \"aliases\": {\n    \"my_search_indices\": {}\n  }\n}\n</code></pre> <p>500 - Internal Server Error</p> <pre><code>{\n  \"error\" : {\n    \"root_cause\" : [\n      {\n        \"type\" : \"illegal_state_exception\",\n        \"reason\" : \"index my_source_index must have all shards allocated on the same node to shrink index\"\n      }\n    ],\n    \"type\" : \"illegal_state_exception\",\n    \"reason\" : \"index my_source_index must have all shards allocated on the same node to shrink index\"\n  },\n  \"status\" : 500\n}\n</code></pre>"},{"location":"chap13/1chap13_es_shrink_rolloverapi/#3-3-illegal_state_exception","title":"3-3 <code>illegal_state_exception</code>","text":"<ul> <li>the number of source shards [4] must be a multiple of [3]</li> <li>index <code>my_source_index</code> must have all shards allocated on the same node to shrink index</li> <li>index <code>my_source_index</code> must be read-only to resize index. use \\\"index.blocks.write=true</li> </ul> <pre><code>DELETE my_source_index\n\n## \u786e\u4fdd\u5206\u7247\u90fd\u5728 hot\nPUT my_source_index\n{\n \"settings\": {\n   \"number_of_shards\": 4,\n   \"number_of_replicas\": 0,\n   \"index.routing.allocation.include.box_type\":\"hot\"\n }\n}\n\nPUT my_source_index/_doc/1\n{\n  \"key\":\"value\"\n}\n</code></pre> <pre><code>GET _cat/shards/my_source_index\n</code></pre> <p>Output</p> <pre><code># GET _cat/shards/my_source_index\nmy_source_index 1 p STARTED 0   0b 172.19.0.3 es7_hot\nmy_source_index 2 p STARTED 0   0b 172.19.0.3 es7_hot\nmy_source_index 3 p STARTED 0   0b 172.19.0.3 es7_hot\nmy_source_index 0 p STARTED 0 208b 172.19.0.3 es7_hot\n</code></pre> <pre><code>#\u8bbe\u7f6e\u4e3a\u53ea\u8bfb\nPUT /my_source_index/_settings\n{\n  \"settings\": {\n    \"index.blocks.write\": true\n  }\n}\n</code></pre> <pre><code>POST my_source_index/_shrink/my_target_index\n{\n  \"settings\": {\n    \"index.number_of_replicas\": 0,\n    \"index.number_of_shards\": 2,\n    \"index.codec\": \"best_compression\"\n  },\n  \"aliases\": {\n    \"my_search_indices\": {}\n  }\n}\n</code></pre> <p>output:</p> <pre><code>{\n  \"acknowledged\" : true,\n  \"shards_acknowledged\" : true,\n  \"index\" : \"my_target_index\"\n}\n</code></pre> <pre><code>GET _cat/shards/my_target_index\n</code></pre> <p>Output:</p> <pre><code>my_target_index 1 p STARTED 0  208b 172.19.0.3 es7_hot\nmy_target_index 0 p STARTED 1 3.7kb 172.19.0.3 es7_hot\n</code></pre> <pre><code># My target_index\u72b6\u6001\u4e3a\u4e5f\u53ea\u8bfb\nPUT my_target_index/_doc/1\n{\n  \"key\":\"value\"\n}\n</code></pre> <p>Output:</p> <pre><code>{\n  \"error\" : {\n    \"root_cause\" : [\n      {\n        \"type\" : \"cluster_block_exception\",\n        \"reason\" : \"index [my_target_index] blocked by: [FORBIDDEN/8/index write (api)];\"\n      }\n    ],\n    \"type\" : \"cluster_block_exception\",\n    \"reason\" : \"index [my_target_index] blocked by: [FORBIDDEN/8/index write (api)];\"\n  },\n  \"status\" : 403\n}\n\n</code></pre>"},{"location":"chap13/1chap13_es_shrink_rolloverapi/#4split-api","title":"4\u3001Split API","text":""},{"location":"chap13/1chap13_es_shrink_rolloverapi/#4-1","title":"4-1 \u4e00\u4e2a\u65f6\u95f4\u5e8f\u5217\u7d22\u5f15\u7684\u5b9e\u9645\u573a\u666f","text":""},{"location":"chap13/1chap13_es_shrink_rolloverapi/#4-2-split-index-demo","title":"4-2  Split Index Demo","text":"<pre><code># Split Index\nDELETE my_source_index\nDELETE my_target_index\n\nPUT my_source_index\n{\n \"settings\": {\n   \"number_of_shards\": 4,\n   \"number_of_replicas\": 0\n }\n}\n\nPUT my_source_index/_doc/1\n{\n  \"key\":\"value\"\n}\n\n\nGET _cat/shards/my_source_index\n</code></pre> <p>Output</p> <pre><code>my_source_index 3 p STARTED 0  208b 172.19.0.2 es7_cold\nmy_source_index 2 p STARTED 0  208b 172.19.0.3 es7_hot\nmy_source_index 1 p STARTED 0  208b 172.19.0.6 es7_warm\nmy_source_index 0 p STARTED 1 3.7kb 172.19.0.2 es7_cold\n</code></pre> <p>\u5fc5\u987b\u662f\u500d\u6570</p> <pre><code># \u5fc5\u987b\u662f\u500d\u6570\nPOST my_source_index/_split/my_target\n{\n  \"settings\": {\n    \"index.number_of_shards\": 10\n  }\n}\n</code></pre> <p>Output:</p> <pre><code>{\n  \"error\" : {\n    \"root_cause\" : [\n      {\n        \"type\" : \"illegal_argument_exception\",\n        \"reason\" : \"the number of source shards [4] must be a factor of [10]\"\n      }\n    ],\n    \"type\" : \"illegal_argument_exception\",\n    \"reason\" : \"the number of source shards [4] must be a factor of [10]\"\n  },\n  \"status\" : 400\n}\n</code></pre> <p>\u5fc5\u987b\u662f\u53ea\u8bfb</p> <pre><code># \u5fc5\u987b\u662f\u53ea\u8bfb\nPOST my_source_index/_split/my_target\n{\n  \"settings\": {\n    \"index.number_of_shards\": 8\n  }\n}\n</code></pre> <p>Output:  500 - Internal Server Error</p> <pre><code>{\n  \"error\" : {\n    \"root_cause\" : [\n      {\n        \"type\" : \"illegal_state_exception\",\n        \"reason\" : \"index my_source_index must be read-only to resize index. use \\\"index.blocks.write=true\\\"\"\n      }\n    ],\n    \"type\" : \"illegal_state_exception\",\n    \"reason\" : \"index my_source_index must be read-only to resize index. use \\\"index.blocks.write=true\\\"\"\n  },\n  \"status\" : 500\n}\n</code></pre>"},{"location":"chap13/1chap13_es_shrink_rolloverapi/#4-3-illegal_argument_exception","title":"4-3 <code>illegal_argument_exception</code>","text":"<ul> <li>the number of source shards [4] must be a factor of [10]</li> <li>index <code>my_source_index</code> must be read-only to resize index. use \\\"index.blocks.write=true\\\"</li> </ul> <pre><code>#\u8bbe\u7f6e\u4e3a\u53ea\u8bfb\nPUT /my_source_index/_settings\n{\n  \"settings\": {\n    \"index.blocks.write\": true\n  }\n}\n\n\nPOST my_source_index/_split/my_target_index\n{\n  \"settings\": {\n    \"index.number_of_shards\": 8,\n    \"index.number_of_replicas\":0\n  }\n}\n</code></pre> <p>Output</p> <pre><code>{\n  \"acknowledged\" : true,\n  \"shards_acknowledged\" : true,\n  \"index\" : \"my_target_index\"\n}\n</code></pre> <pre><code>GET _cat/shards/my_target_index\n\nmy_target_index 5 p STARTED 0  208b 172.19.0.3 es7_hot\nmy_target_index 2 p STARTED 0  208b 172.19.0.6 es7_warm\nmy_target_index 3 p STARTED 0  208b 172.19.0.6 es7_warm\nmy_target_index 6 p STARTED 0  208b 172.19.0.2 es7_cold\nmy_target_index 1 p STARTED 0  206b 172.19.0.2 es7_cold\nmy_target_index 4 p STARTED 0  208b 172.19.0.3 es7_hot\nmy_target_index 7 p STARTED 0  208b 172.19.0.2 es7_cold\nmy_target_index 0 p STARTED 1 3.7kb 172.19.0.2 es7_cold\n</code></pre> <pre><code># write block\nPUT my_target_index/_doc/1\n{\n  \"key\":\"value\"\n}\n\n### Output\n{\n  \"error\" : {\n    \"root_cause\" : [\n      {\n        \"type\" : \"cluster_block_exception\",\n        \"reason\" : \"index [my_target_index] blocked by: [FORBIDDEN/8/index write (api)];\"\n      }\n    ],\n    \"type\" : \"cluster_block_exception\",\n    \"reason\" : \"index [my_target_index] blocked by: [FORBIDDEN/8/index write (api)];\"\n  },\n  \"status\" : 403\n}\n</code></pre>"},{"location":"chap13/1chap13_es_shrink_rolloverapi/#5rollover-api","title":"5\u3001Rollover API","text":"<ul> <li>\u5f53\u6ee1\u8db3\u4e00\u7cfb\u5217\u7684\u6761\u4ef6\uff0cRollover API \u652f\u6301\u5c06\u4e00\u4e2a Alias \u6307\u5411\u4e00\u4e2a\u65b0\u7684\u7d22\u5f15<ul> <li>\u5b58\u6d3b\u7684\u65f6\u95f4 </li> <li>\u6700\u5927\u6587\u6863\u6570 </li> <li>\u6700\u5927\u7684\u6587\u4ef6\u5c3a\u5bf8</li> </ul> </li> <li>\u5e94\u7528\u573a\u666f<ul> <li>\u5f53\u4e00\u4e2a\u7d22\u5f15\u6570\u636e\u91cf\u8fc7\u5927</li> </ul> </li> <li>\u4e00\u822c\u9700\u8981\u548c Index Lifecycle Management Policies \u7ed3\u5408\u4f7f\u7528<ul> <li>\u53ea\u6709\u8c03\u7528 Rollover API \u65f6\uff0c\u624d\u4f1a\u53bb\u505a\u76f8\u5e94\u7684\u68c0\u6d4b\u3002ES \u5e76\u4e0d\u4f1a\u81ea\u52a8\u53bb\u76d1\u63a7\u8fd9\u4e9b\u7d22\u5f15</li> </ul> </li> </ul>"},{"location":"chap13/1chap13_es_shrink_rolloverapi/#5-1-rollover-apidemo","title":"5-1 Rollover API(Demo)","text":"<pre><code>#Rollover API\nDELETE nginx-logs*\n</code></pre> <pre><code># \u4e0d\u8bbe\u5b9a is_write_true\n# \u540d\u5b57\u7b26\u5408\u547d\u540d\u89c4\u8303\nPUT /nginx-logs-000001\n{\n  \"aliases\": {\n    \"nginx_logs_write\": {}\n  }\n}\n\n# output\n{\n  \"acknowledged\" : true,\n  \"shards_acknowledged\" : true,\n  \"index\" : \"nginx-logs-000001\"\n}\n</code></pre> <pre><code># \u591a\u6b21\u5199\u5165\u6587\u6863 &gt; 5\nPOST nginx_logs_write/_doc\n{\n  \"log\":\"something\"\n}\n</code></pre> <pre><code>POST /nginx_logs_write/_rollover\n{\n  \"conditions\": {\n    \"max_age\":   \"1d\",\n    \"max_docs\":  5,\n    \"max_size\":  \"5gb\"\n  }\n}\n</code></pre> <p>output: true</p> <p>\"[max_docs: 5]\" : true,</p> <pre><code>{\n  \"acknowledged\" : true,\n  \"shards_acknowledged\" : true,\n  \"old_index\" : \"nginx-logs-000001\",\n  \"new_index\" : \"nginx-logs-000002\",\n  \"rolled_over\" : true,\n  \"dry_run\" : false,\n  \"conditions\" : {\n    \"[max_age: 1d]\" : false,\n    \"[max_docs: 5]\" : true,\n    \"[max_size: 5gb]\" : false\n  }\n}\n</code></pre> <pre><code>GET /nginx_logs_write/_count\n</code></pre> <p>output: total \u8fd4\u56de1</p> <pre><code>{\n  \"count\" : 0,\n  \"_shards\" : {\n    \"total\" : 1,\n    \"successful\" : 1,\n    \"skipped\" : 0,\n    \"failed\" : 0\n  }\n}\n</code></pre> <pre><code># \u67e5\u770b Alias\u4fe1\u606f\nGET /nginx_logs_write\n</code></pre> <p>Output: Alias \u6307\u5230\u4e86\u65b0\u7684\u7d22\u5f15\u4e0a\u9762</p> <pre><code>{\n  \"nginx-logs-000002\" : {\n    \"aliases\" : {\n      \"nginx_logs_write\" : { }\n    },\n    \"mappings\" : { },\n    \"settings\" : {\n      \"index\" : {\n        \"creation_date\" : \"1607726860387\",\n        \"number_of_shards\" : \"1\",\n        \"number_of_replicas\" : \"1\",\n        \"uuid\" : \"xHplu5XTTk2Jbak0ZYxqtw\",\n        \"version\" : {\n          \"created\" : \"7090199\"\n        },\n        \"provided_name\" : \"nginx-logs-000002\"\n      }\n    }\n  }\n}\n\n</code></pre> <pre><code>DELETE apache-logs*\n</code></pre>"},{"location":"chap13/1chap13_es_shrink_rolloverapi/#5-2-rollover-api-is_write_index","title":"5-2 Rollover API  <code>is_write_index</code>","text":"<pre><code># \u8bbe\u7f6e is_write_index\nPUT apache-logs1\n{\n  \"aliases\": {\n    \"apache_logs\": {\n      \"is_write_index\":true\n    }\n  }\n}\n</code></pre> <pre><code>POST apache_logs/_count\n# 0\n\nPOST apache_logs/_doc\n{\n  \"key\":\"value\"\n}\n</code></pre> <pre><code># \u9700\u8981\u6307\u5b9a target \u7684\u540d\u5b57\nPOST /apache_logs/_rollover/apache-logs8xxxx\n{\n  \"conditions\": {\n    \"max_age\":   \"1d\",\n    \"max_docs\":  1,\n    \"max_size\":  \"5gb\"\n  }\n}\n</code></pre> <p>Output: true</p> <pre><code>{\n  \"acknowledged\" : true,\n  \"shards_acknowledged\" : true,\n  \"old_index\" : \"apache-logs1\",\n  \"new_index\" : \"apache-logs8xxxx\",\n  \"rolled_over\" : true,\n  \"dry_run\" : false,\n  \"conditions\" : {\n    \"[max_age: 1d]\" : false,\n    \"[max_docs: 1]\" : true,\n    \"[max_size: 5gb]\" : false\n  }\n}\n</code></pre> <pre><code># \u67e5\u770b Alias\u4fe1\u606f\nGET /apache_logs\n\n...\n\"apache-logs8xxxx\" : {\n    \"aliases\" : {\n      \"apache_logs\" : {\n        \"is_write_index\" : true\n      }\n    },\n    \"mappings\" : { },\n    \"settings\" : {\n      \"index\" : {\n        \"creation_date\" : \"1607726455652\",\n        \"number_of_shards\" : \"1\",\n        \"number_of_replicas\" : \"1\",\n        \"uuid\" : \"-mb_kDsbSfyt7ECYitkO9A\",\n        \"version\" : {\n          \"created\" : \"7090199\"\n        },\n        \"provided_name\" : \"apache-logs8xxxx\"\n      }\n    }\n  }\n</code></pre>"},{"location":"chap13/2chap13_index_lms/","title":"\u7b2c\u4e8c\u8282 \u7d22\u5f15\u5168\u751f\u547d\u5468\u671f\u7ba1\u7406\u53ca\u5de5\u5177\u4ecb\u7ecd","text":""},{"location":"chap13/2chap13_index_lms/#1","title":"1\u3001\u65f6\u95f4\u5e8f\u5217\u7684\u7d22\u5f15","text":""},{"location":"chap13/2chap13_index_lms/#1-1","title":"1-1 \u7279\u70b9","text":"<p>\u7d22\u5f15\u4e2d\u7684\u6570\u636e\u968f\u7740\u65f6\u95f4\uff0c\u6301\u7eed\u4e0d\u65ad\u589e\u957f</p>"},{"location":"chap13/2chap13_index_lms/#1-2","title":"1-2 \u6309\u7167\u65f6\u95f4\u5e8f\u5217\u5212\u5206\u7d22\u5f15\u7684\u597d\u5904 &amp; \u6311\u6218","text":"<ul> <li>\u6309\u7167\u65f6\u95f4\u8fdb\u884c\u5212\u5206\u7d22\u5f15\uff0c\u4f1a\u4f7f\u5f97\u7ba1\u7406\u66f4\u52a0\u7b80\u5355\u3002\u4f8b\u5982\uff0c\u5b8c\u6574\u5220\u9664\u4e00\u4e2a\u7d22\u5f15\uff0c\u6027\u80fd\u6bd4 <code>delete by query</code> \u597d</li> <li>\u5982\u4f55\u8fdb\u884c\u81ea\u52a8\u5316\u7ba1\u7406\uff0c\u51cf\u5c11\u4eba\u5de5\u64cd\u4f5c<ul> <li>\u4ece Hot \u79fb\u52a8\u5230 Warm</li> <li>\u5b9a\u671f\u5173\u95ed\u6216\u8005\u5220\u9664\u7d22\u5f15</li> </ul> </li> </ul>"},{"location":"chap13/2chap13_index_lms/#2","title":"2\u3001\u7d22\u5f15\u751f\u547d\u5468\u671f\u5e38\u89c1\u7684\u9636\u6bb5","text":"<ul> <li>Hot:  \u7d22\u5f15\u8fd8\u5b58\u5728\u7740\u5927\u91cf\u7684\u8bfb\u5199\u64cd\u4f5c</li> <li>Warm:     \u7d22\u5f15\u4e0d\u5b58\u5728\u5199\u64cd\u4f5c\uff0c\u8fd8\u6709\u88ab\u67e5\u8be2\u7684\u9700\u8981 </li> <li>Cold: \u6570\u636e\u4e0d\u5b58\u5728\u5199\u64cd\u4f5c\uff0c\u8bfb\u64cd\u4f5c\u4e5f\u4e0d\u591a</li> <li>Delete:       \u7d22\u5f15\u4e0d\u518d\u9700\u8981\uff0c\u53ef\u4ee5\u88ab\u5b89\u5168\u5220\u9664</li> </ul>"},{"location":"chap13/2chap13_index_lms/#3elasticsearch-curator","title":"3\u3001Elasticsearch Curator","text":"<ul> <li>Elastic \u5b98\u65b9\u63a8\u51fa\u7684\u5de5\u5177<ul> <li>\u57fa\u4e8e python \u7684\u547d\u4ee4\u884c\u5de5\u5177</li> </ul> </li> <li>\u914d\u7f6e Actions<ul> <li>\u5185\u7f6e 10 \u591a\u79cd Index \u76f8\u5173\u7684\u64cd\u4f5c</li> <li>\u6bcf\u4e2a\u52a8\u4f5c\u53ef\u4ee5\u987a\u5e8f\u6267\u884c</li> </ul> </li> <li>Filters<ul> <li>\u652f\u6301\u5404\u79cd\u6761\u4ef6\uff0c\u8fc7\u6ee4\u51fa\u9700\u8981\u64cd\u4f5c\u7684\u7d22\u5f15</li> </ul> </li> </ul> <p>https://www.elastic.co/guide/en/elasticsearch/client/curator/current/index.html</p> <p></p>"},{"location":"chap13/2chap13_index_lms/#4ebay-lifecycle-management-tool","title":"4\u3001eBay Lifecycle Management Tool","text":"<ul> <li>eBay Pronto team \u81ea\u7814\u56fe\u5f62\u5316\u5de5\u5177<ul> <li>\u652f\u6301 Curator \u7684\u529f\u80fd</li> <li>\u4e00\u4e2a\u754c\u9762\uff0c\u7ba1\u7406\u591a\u4e2a ES \u96c6\u7fa4</li> <li>\u652f\u6301\u4e0d\u540c\u7684 ES \u7248\u672c</li> </ul> </li> <li>\u652f\u6301\u56fe\u5f62\u5316\u914d\u7f6e</li> <li>Job \u5b9a\u65f6\u89e6\u53d1</li> <li>\u7cfb\u7edf\u9ad8\u53ef\u7528</li> </ul>"},{"location":"chap13/2chap13_index_lms/#5","title":"5\u3001\u5de5\u5177\u6bd4\u8f83","text":""},{"location":"chap13/2chap13_index_lms/#6index-lifecycle-management","title":"6\u3001Index Lifecycle Management","text":"<p>Elasticsearch 6.6 \u63a8\u51fa\u7684\u65b0\u529f\u80fd</p> <ul> <li>\u57fa\u4e8e X-Pack Basic License\uff0c\u53ef\u514d\u8d39\u4f7f\u7528</li> </ul> <p>ILM\u6982\u5ff5</p> <ul> <li>Policy</li> <li>Phase</li> <li>Action</li> </ul>"},{"location":"chap13/2chap13_index_lms/#7ilm-policy","title":"7\u3001ILM Policy","text":"<ul> <li>\u96c6\u7fa4\u4e2d\u652f\u6301\u5b9a\u4e49\u591a\u4e2a Policy</li> <li>\u6bcf\u4e2a\u7d22\u5f15\u53ef\u4ee5\u4f7f\u7528\u76f8\u540c\u6216\u4e0d\u76f8\u540c\u7684 Policy</li> </ul>"},{"location":"chap13/2chap13_index_lms/#8index-lifecycle-policies","title":"8\u3001Index Lifecycle Policies \u56fe\u5f62\u5316\u754c\u9762","text":"<ul> <li>\u901a\u8fc7 Kibana Management \u8bbe\u5b9a</li> <li>Hot phase \u662f\u5fc5\u987b\u8981\u7684<ul> <li>\u53ef\u4ee5 enable rollover</li> </ul> </li> <li>\u5176\u4ed6 Phase \u6309\u9700\u8bbe\u5b9a</li> <li>Watch-history-ilm policy<ul> <li>\u521b\u5efa 7 \u5929\u540e\u81ea\u52a8\u5220\u9664</li> </ul> </li> </ul>"},{"location":"chap13/2chap13_index_lms/#9live-demo","title":"9\u3001Live Demo","text":"<ul> <li>\u5c06ILM\u5237\u65b0\u65f6\u95f4\u8bbe\u5b9a\u4e3a1\u79d2\uff0c\u9ed8\u8ba410\u5206\u949f</li> <li>\u8bbe\u7f6eHot/Warm/Cold\u548cDelete\u56db\u4e2a\u9636\u6bb5<ul> <li>\u8d85\u8fc7 5 \u4e2a\u6587\u6863\u4ee5\u540e rollover</li> <li>10 \u79d2\u540e\u8fdb\u5165 warm</li> <li>15 \u79d2\u540e\u8fdb\u5165 Cold</li> <li>20 \u79d2\u540e\u5220\u9664\u7d22\u5f15</li> </ul> </li> </ul> <pre><code># \u8fd0\u884c\u4e09\u4e2a\u8282\u70b9\uff0c\u5206\u7247 \u5c06box_type\u8bbe\u7f6e\u6210 hot\uff0cwarm\u548ccold\n# \u5177\u4f53\u53c2\u8003 github\u4e0b\uff0cdocker-hot-warm-cold \u4e0b\u7684docker-compose \u6587\u4ef6\n</code></pre> <p>\u542f\u52a8hot-warm-cold\u96c6\u7fa4</p> <pre><code># \u8bbe\u7f6e 1\u79d2\u5237\u65b01\u6b21\uff0c\u751f\u4ea7\u73af\u588310\u5206\u79cd\u5237\u65b0\u4e00\u6b21\nPUT _cluster/settings\n{\n  \"persistent\": {\n    \"indices.lifecycle.poll_interval\":\"1s\"\n  }\n}\n</code></pre> <pre><code>GET _cluster/settings\n\n### output\n{\n  \"persistent\" : {\n    \"indices\" : {\n      \"lifecycle\" : {\n        \"poll_interval\" : \"1s\"\n      }\n    }\n  },\n  \"transient\" : { }\n}\n</code></pre> <pre><code># \u8bbe\u7f6e Policy\nPUT /_ilm/policy/log_ilm_policy\n{\n  \"policy\": {\n    \"phases\": {\n      \"hot\": {\n        \"actions\": {\n          \"rollover\": {\n            \"max_docs\": 5\n          }\n        }\n      },\n      \"warm\": {\n        \"min_age\": \"10s\",\n        \"actions\": {\n          \"allocate\": {\n            \"include\": {\n              \"box_type\": \"warm\"\n            }\n          }\n        }\n      },\n      \"cold\": {\n        \"min_age\": \"15s\",\n        \"actions\": {\n          \"allocate\": {\n            \"include\": {\n              \"box_type\": \"cold\"\n            }\n          }\n        }\n      },\n      \"delete\": {\n        \"min_age\": \"20s\",\n        \"actions\": {\n          \"delete\": {}\n        }\n      }\n    }\n  }\n}\n</code></pre> <pre><code># \u8bbe\u7f6e\u7d22\u5f15\u6a21\u7248\nPUT /_template/log_ilm_template\n{\n  \"index_patterns\" : [\n      \"ilm_index-*\"\n    ],\n    \"settings\" : {\n      \"index\" : {\n        \"lifecycle\" : {\n          \"name\" : \"log_ilm_policy\",\n          \"rollover_alias\" : \"ilm_alias\"\n        },\n        \"routing\" : {\n          \"allocation\" : {\n            \"include\" : {\n              \"box_type\" : \"hot\"\n            }\n          }\n        },\n        \"number_of_shards\" : \"1\",\n        \"number_of_replicas\" : \"0\"\n      }\n    },\n    \"mappings\" : { },\n    \"aliases\" : { }\n}\n</code></pre> <pre><code>PUT ilm_index-000001\n{\n  \"settings\": {\n    \"number_of_shards\": 1,\n    \"number_of_replicas\": 0,\n    \"index.lifecycle.name\": \"log_ilm_policy\",\n    \"index.lifecycle.rollover_alias\": \"ilm_alias\",\n    \"index.routing.allocation.include.box_type\":\"hot\"\n  },\n  \"aliases\": {\n    \"ilm_alias\": {\n      \"is_write_index\": true\n    }\n  }\n}\n</code></pre> <p>Output:</p> <pre><code>{\n  \"acknowledged\" : true,\n  \"shards_acknowledged\" : true,\n  \"index\" : \"ilm_index-000001\"\n}\n</code></pre> <pre><code># \u5bf9 Alias\u5199\u5165\u6587\u6863\nPOST  ilm_alias/_doc\n{\n  \"dfd\":\"dfdsf\"\n}\n</code></pre> <p>Output:</p> <pre><code>{\n  \"_index\" : \"ilm_index-000001\",\n  \"_type\" : \"_doc\",\n  \"_id\" : \"9PpPVXYB_xXR0dDRfje1\",\n  \"_version\" : 1,\n  \"result\" : \"created\",\n  \"_shards\" : {\n    \"total\" : 1,\n    \"successful\" : 1,\n    \"failed\" : 0\n  },\n  \"_seq_no\" : 0,\n  \"_primary_term\" : 1\n}\n</code></pre> <pre><code>GET _cat/shards/ilm_index-000001\n</code></pre> <pre><code>GET _cat/shards/ilm_index-000001\n</code></pre> <p>Output</p> <pre><code>...\n{\n  \"error\" : {\n    \"root_cause\" : [\n      {\n        \"type\" : \"index_not_found_exception\",\n        \"reason\" : \"no such index [ilm_index-000001]\",\n        \"resource.type\" : \"index_or_alias\",\n        \"resource.id\" : \"ilm_index-000001\",\n        \"index_uuid\" : \"_na_\",\n        \"index\" : \"ilm_index-000001\"\n      }\n    ],\n    \"type\" : \"index_not_found_exception\",\n    \"reason\" : \"no such index [ilm_index-000001]\",\n    \"resource.type\" : \"index_or_alias\",\n    \"resource.id\" : \"ilm_index-000001\",\n    \"index_uuid\" : \"_na_\",\n    \"index\" : \"ilm_index-000001\"\n  },\n  \"status\" : 404\n}\n</code></pre>"},{"location":"chap14/1logstash_introduce/","title":"\u7b2c\u4e00\u8282 Logstash \u5165\u95e8\u53ca\u67b6\u6784\u4ecb\u7ecd","text":""},{"location":"chap14/1logstash_introduce/#1logstash","title":"1\u3001Logstash","text":"<p>Logstash: ETL \u5de5\u5177 / \u6570\u636e\u641c\u96c6\u5904\u7406\u5f15\u64ce\u3002\u652f\u6301 200 \u591a\u4e2a\u63d2\u4ef6</p> <p></p>"},{"location":"chap14/1logstash_introduce/#2logstash-concepts","title":"2\u3001Logstash Concepts","text":""},{"location":"chap14/1logstash_introduce/#1-1-pipeline","title":"1-1 Pipeline","text":"<ul> <li>\u5305\u542b\u4e86 <code>input-filter-output</code> \u4e09\u4e2a\u9636\u6bb5\u7684\u5904\u7406\u6d41\u7a0b</li> <li>\u63d2\u4ef6\u751f\u547d\u5468\u671f\u7ba1\u7406</li> <li>\u961f\u5217\u7ba1\u7406</li> </ul>"},{"location":"chap14/1logstash_introduce/#1-2-logstash-event","title":"1-2 Logstash Event","text":"<ul> <li>\u6570\u636e\u5728\u5185\u90e8\u6d41\u8f6c\u65f6\u7684\u5177\u4f53\u8868\u73b0\u5f62\u5f0f\u3002\u6570\u636e\u5728 <code>input</code> \u9636\u6bb5\u88ab\u8f6c\u6362\u4e3a <code>Event</code>\uff0c\u5728 <code>output</code> \u88ab\u8f6c\u5316\u6210\u76ee\u6807\u683c\u5f0f\u6570\u636e</li> <li>Event \u5176\u5b9e\u662f\u4e00\u4e2a Java Object\uff0c\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\uff0c\u5bf9 Event \u7684\u5c5e\u6027\u8fdb\u884c\u589e\u5220\u6539\u67e5</li> </ul>"},{"location":"chap14/1logstash_introduce/#3logstash","title":"3\u3001Logstash \u67b6\u6784\u7b80\u4ecb","text":"<p>Codec(Code / Decode):</p> <ul> <li>\u5c06\u539f\u59cb\u6570\u636e decode \u6210 Event;</li> <li>\u5c06 Event encode \u6210\u76ee\u6807\u6570\u636e</li> </ul> <p></p>"},{"location":"chap14/1logstash_introduce/#4logstash","title":"4\u3001Logstash \u914d\u7f6e\u6587\u4ef6\u7ed3\u6784","text":"<ul> <li><code>bin/logstash -f demo.conf</code></li> <li>Pipeline<ul> <li>Input / Filter / Output</li> </ul> </li> <li>Codec<ul> <li>Line / json</li> </ul> </li> </ul> <ul> <li>Input: stdin</li> <li>filter: <ul> <li>grok</li> <li>date</li> </ul> </li> <li>output:<ul> <li>elasticsearch</li> <li>stdout</li> </ul> </li> </ul>"},{"location":"chap14/1logstash_introduce/#4-1-input-plugins","title":"4-1 Input Plugins","text":"<ul> <li>\u4e00\u4e2a Pipeline \u53ef\u4ee5\u6709\u591a\u4e2a input \u63d2\u4ef6<ul> <li>Stdin / File</li> <li>Beats / Log4J / Elasticsearch / JDBC / Kafka / Rabbitmq / Redis</li> <li>JMX / HTTP / Websocket / UDP / TCP</li> <li>Google Cloud Storage / S3</li> <li>Github / Twitter</li> </ul> </li> </ul>"},{"location":"chap14/1logstash_introduce/#4-2-output-plugins","title":"4-2 Output Plugins","text":"<ul> <li>\u5c06 Event \u53d1\u9001\u5230\u7279\u5b9a\u7684\u76ee\u7684\u5730\uff0c\u662f Pipeline \u7684\u6700\u540e\u4e00\u4e2a\u9636\u6bb5</li> <li>\u5e38\u89c1 Output Plugins: https://www.elastic.co/guide/en/logstash/7.1/output-plugins.html<ul> <li>Elasticsearch</li> <li>Email / Pageduty</li> <li>Influxdb / Kafka / Mongodb / Opentsdb / Zabbix </li> <li>Http / TCP / Websocket</li> </ul> </li> </ul>"},{"location":"chap14/1logstash_introduce/#4-3-codec-plugins","title":"4-3 Codec Plugins","text":"<ul> <li>\u5c06\u539f\u59cb\u6570\u636e decode \u6210 Event;</li> <li>\u5c06 Event encode \u6210\u76ee\u6807\u6570\u636e</li> <li>\u5185\u7f6e\u7684 Codec Plugins https://www.elastic.co/guide/en/logstash/7.1/codec-plugins.html<ul> <li>Line / Multiline</li> <li>JSON / Avro / Cef (ArcSight Common Event Format)</li> <li>Dots / Rubydebug</li> </ul> </li> </ul>"},{"location":"chap14/1logstash_introduce/#4-4-filter-plugins","title":"4-4 Filter Plugins","text":"<ul> <li>\u5904\u7406 Event</li> <li>\u5185\u7f6e\u7684 Filter Plugins\uff1a https://www.elastic.co/guide/en/logstash/7.1/filter-plugins.html<ul> <li>Mutate \u2013 \u64cd\u4f5c Event \u7684\u5b57\u6bb5</li> <li>Metrics \u2013 Aggregate metrics</li> <li>Ruby\u2013\u6267\u884cRuby\u4ee3\u7801</li> </ul> </li> </ul>"},{"location":"chap14/1logstash_introduce/#5-queue","title":"5\u3001 Queue","text":""},{"location":"chap14/1logstash_introduce/#5-1-pipelines","title":"5-1 \u591a Pipelines \u5b9e\u4f8b","text":"<ul> <li><code>Pipeline.works</code>: Pipeline \u7ebf\u7a0b\u6570\uff0c\u9ed8\u8ba4\u662f CPU \u6838\u6570</li> <li><code>Pipeline.batch.size</code>:   Batcher \u4e00\u6b21\u6279\u91cf\u83b7\u53d6\u7b49\u5f85\u5904\u7406\u7684\u6587\u6863\u6570\uff0c\u9ed8\u8ba4 125\u3002\u9700\u7ed3\u5408 <code>jvm.options</code>\u8c03\u8282</li> <li><code>Pipeline.batch.delay</code>:  Batcher \u7b49\u5f85\u65f6\u95f4</li> </ul>"},{"location":"chap14/1logstash_introduce/#5-1-logstash-queue","title":"5-1 Logstash Queue","text":"<p>In Memory Queue</p> <p>\u8fdb\u7a0b Crash\uff0c\u673a\u5668\u5f53\u673a\uff0c\u90fd\u4f1a\u5f15\u8d77\u6570\u636e\u7684\u4e22\u5931</p> <p>Persistent Queue</p> <ul> <li>Queue.type.persisted (\u9ed8\u8ba4\u662f memory)<ul> <li><code>Queue.max_bytes: 4gb</code></li> </ul> </li> <li>\u673a\u5668\u5f53\u673a\uff0c\u6570\u636e\u4e5f\u4e0d\u4f1a\u4e22\u5931;</li> <li>\u6570\u636e\u4fdd\u8bc1\u4f1a\u88ab\u6d88\u8d39;</li> <li>\u53ef\u4ee5\u66ff\u4ee3 Kafka \u7b49\u6d88\u606f\u961f\u5217\u7f13\u51b2\u533a\u7684\u4f5c\u7528</li> <li>https://www.elastic.co/guide/en/logstash/7.1/persistent-queues.html</li> </ul>"},{"location":"chap14/1logstash_introduce/#6codec-plugin","title":"6\u3001Codec Plugin","text":""},{"location":"chap14/1logstash_introduce/#6-1-single-line","title":"6-1 Single Line","text":""},{"location":"chap14/1logstash_introduce/#6-2-multiline","title":"6-2 Multiline","text":"<p>\u8bbe\u7f6e\u53c2\u6570</p> <ul> <li>Pattern: \u8bbe\u7f6e\u884c\u5339\u914d\u7684\u6b63\u5219\u8868\u8fbe\u5f0f</li> <li>What :\u5982\u679c\u5339\u914d\u6210\u529f\uff0c\u90a3\u4e48\u5339\u914d\u884c\u5c5e\u4e8e\u4e0a\u4e00\u4e2a\u4e8b\u4ef6\u8fd8\u662f\u4e0b\u4e00\u4e2a\u4e8b\u4ef6<ul> <li>Previous / Next</li> </ul> </li> <li>Negate true / false:\u662f\u5426\u5bf9 pattern \u7ed3\u679c\u53d6\u53cd<ul> <li>True / False</li> </ul> </li> </ul>"},{"location":"chap14/1logstash_introduce/#6-3-codec-plugin-multiline","title":"6-3 Codec Plugin \u2013 Multiline(\u5f02\u5e38\u65e5\u5fd7)","text":""},{"location":"chap14/1logstash_introduce/#7input-plugin-file","title":"7\u3001Input Plugin \u2013 File","text":"<ul> <li>\u652f\u6301\u4ece\u6587\u4ef6\u4e2d\u8bfb\u53d6\u6570\u636e\uff0c\u5982\u65e5\u5fd7\u6587\u4ef6</li> <li>\u6587\u4ef6\u8bfb\u53d6\u9700\u8981\u89e3\u51b3\u7684\u95ee\u9898<ul> <li>\u53ea\u88ab\u8bfb\u53d6\u4e00\u6b21\u3002\u91cd\u542f\u540e\u9700\u8981\u4ece\u4e0a\u6b21\u8bfb\u53d6\u7684\u4f4d\u7f6e\u7ee7\u7eed(\u901a\u8fc7 sincedb \u5b9e\u73b0)</li> </ul> </li> <li>\u8bfb\u53d6\u5230\u6587\u4ef6\u65b0\u5185\u5bb9\uff0c\u53d1\u73b0\u65b0\u6587\u4ef6</li> <li>\u6587\u4ef6\u53d1\u751f\u5f52\u6863\u64cd\u4f5c(\u6587\u6863\u4f4d\u7f6e\u53d1\u751f\u53d8\u5316\uff0c\u65e5\u5fd7 rotation)\uff0c\u4e0d\u80fd\u5f71\u54cd\u5f53\u524d\u7684\u5185\u5bb9\u8bfb\u53d6</li> </ul>"},{"location":"chap14/1logstash_introduce/#8filter-plugin","title":"8\u3001Filter Plugin","text":"<p>Filter Plugin \u53ef\u4ee5\u5bf9 Logstash Event \u8fdb\u884c\u5404\u79cd\u5904\u7406\uff0c\u4f8b\u5982\u89e3\u6790\uff0c\u5220\u9664\u5b57\u6bb5\uff0c\u7c7b\u578b\u8f6c\u6362</p> <ul> <li>Date:\u65e5\u671f\u89e3\u6790</li> <li>Dissect:\u5206\u5272\u7b26\u89e3\u6790</li> <li>Grok:\u6b63\u5219\u5339\u914d\u89e3\u6790</li> <li>Mutate:\u5904\u7406\u5b57\u6bb5\u3002\u91cd\u547d\u540d\uff0c\u5220\u9664\uff0c\u66ff\u6362</li> <li>Ruby:\u5229\u7528 Ruby \u4ee3\u7801\u6765\u52a8\u6001\u4fee\u6539 Event</li> </ul>"},{"location":"chap14/1logstash_introduce/#8-1-filter-plugin-mutate","title":"8-1 Filter Plugin - Mutate","text":"<p>\u5bf9\u5b57\u6bb5\u505a\u5404\u79cd\u64cd\u4f5c</p> <ul> <li>Convert \u7c7b\u578b\u8f6c\u6362</li> <li>Gsub \u5b57\u7b26\u4e32\u66ff\u6362</li> <li>Split / Join / Merge \u5b57\u7b26\u4e32\u5207\u5272\uff0c\u6570\u7ec4\u5408\u5e76\u5b57\u7b26\u4e32\uff0c\u6570\u7ec4\u5408\u5e76\u6570\u7ec4 </li> <li>Rename \u5b57\u6bb5\u91cd\u547d\u540d</li> <li>Update / Replace \u5b57\u6bb5\u5185\u5bb9\u66f4\u65b0\u66ff\u6362</li> <li><code>Remove_field</code> \u5b57\u6bb5\u5220\u9664</li> </ul>"},{"location":"chap14/1logstash_introduce/#9demo","title":"9\u3001DEMO","text":"<p>JVM \u5347\u7ea7\u5bfc\u81f4logstash \u542f\u52a8\u5931\u8d25</p> <pre><code>$ logstash -h\nUnrecognized VM option 'UseConcMarkSweepGC'\nError: Could not create the Java Virtual Machine.\nError: A fatal exception has occurred. Program will exit.\n\nvim /usr/share/logstash/config/jvm.options\n\n...\n## GC configuration\n## -XX:+UseConcMarkSweepGC\n## -XX:CMSInitiatingOccupancyFraction=75\n## -XX:+UseCMSInitiatingOccupancyOnly\n-XX:+UseG1GC\n...\n</code></pre>"},{"location":"chap14/1logstash_introduce/#9-1-logstash-filterconf","title":"9-1 logstash-filter.conf","text":"<pre><code>input { stdin { } }\n\nfilter {\n  grok {\n    match =&gt; { \"message\" =&gt; \"%{COMBINEDAPACHELOG}\" }\n  }\n  date {\n    match =&gt; [ \"timestamp\" , \"dd/MMM/yyyy:HH:mm:ss Z\" ]\n  }\n}\n\noutput {\n  stdout { codec =&gt; rubydebug }\n}\n</code></pre> <pre><code># \u4e00\u4e2a Demo\uff0c demo \u8fd0\u884c\nlogstash -f logstash-filter.conf\n...\n[2020-12-12T19:13:11,145][INFO ][logstash.javapipeline    ][main] Pipeline started {\"pipeline.id\"=&gt;\"main\"}\n[2020-12-12T19:13:11,190][INFO ][logstash.agent           ] Pipelines running {:count=&gt;1, :running_pipelines=&gt;[:main], :non_running_pipelines=&gt;[]}\n[2020-12-12T19:13:11,599][INFO ][logstash.agent           ] Successfully started Logstash API endpoint {:port=&gt;9600}\n\nhello world\n{\n    \"@timestamp\" =&gt; 2020-12-12T19:15:13.324Z,\n          \"tags\" =&gt; [\n        [0] \"_grokparsefailure\"\n    ],\n      \"@version\" =&gt; \"1\",\n       \"message\" =&gt; \"hello world\",\n          \"host\" =&gt; \"elasticsearch7\"\n}\n</code></pre>"},{"location":"chap14/1logstash_introduce/#9-2-codecline","title":"9-2 <code>codec=&gt;line</code>","text":"<pre><code>logstash -e \"input{stdin{codec=&gt;line}}output{stdout{codec=&gt; rubydebug}}\"\n\nhello world\n{\n    \"@timestamp\" =&gt; 2020-12-12T19:17:36.692Z,\n       \"message\" =&gt; \"hello world\",\n          \"host\" =&gt; \"elasticsearch7\",\n      \"@version\" =&gt; \"1\"\n}\n</code></pre>"},{"location":"chap14/1logstash_introduce/#9-3-codec-json","title":"9-3 <code>codec=&gt; json</code>","text":"<pre><code>logstash -e \"input{stdin{codec=&gt;json}}output{stdout{codec=&gt; rubydebug}}\"\n\n# line: error\nhello world\n[2020-12-12T19:19:45,222][WARN ][logstash.codecs.jsonlines][main][88ac75a22ddd4bf4cc22d3c0ae803da99e4ef96a529188df0a584d9d02739682] JSON parse error, original data now in message field {:error=&gt;#&lt;LogStash::Json::ParserError: Unrecognized token 'hello': was expecting ('true', 'false' or 'null')\n at [Source: (String)\"hello world\"; line: 1, column: 6]&gt;, :data=&gt;\"hello world\"}\n{\n          \"tags\" =&gt; [\n        [0] \"_jsonparsefailure\"\n    ],\n    \"@timestamp\" =&gt; 2020-12-12T19:19:45.230Z,\n       \"message\" =&gt; \"hello world\",\n          \"host\" =&gt; \"elasticsearch7\",\n      \"@version\" =&gt; \"1\"\n}\n\n\n# json: successful\n{\"hello\":\"world\"}\n{\n         \"hello\" =&gt; \"world\",\n    \"@timestamp\" =&gt; 2020-12-12T19:20:12.973Z,\n          \"host\" =&gt; \"elasticsearch7\",\n      \"@version\" =&gt; \"1\"\n}\n</code></pre>"},{"location":"chap14/1logstash_introduce/#9-4-stdoutcodec-dots","title":"9-4 <code>stdout{codec=&gt; dots}</code>","text":"<pre><code>logstash -e \"input{stdin{codec=&gt;line}}output{stdout{codec=&gt; dots}}\"\n\nhello world\n.\n</code></pre>"},{"location":"chap14/1logstash_introduce/#9-5-multiline-exceptionconf","title":"9-5 multiline-exception.conf","text":"<p>multiline-exception.conf</p> <pre><code>input {\n  stdin {\n    codec =&gt; multiline {\n      pattern =&gt; \"^\\s\"\n      what =&gt; \"previous\"\n    }\n  }\n}\n\n\nfilter {}\n\noutput {\n  stdout { codec =&gt; rubydebug }\n}\n</code></pre> <pre><code>logstash -f multiline-exception.conf\n\n# \u591a\u884c\u6570\u636e\uff0c\u5f02\u5e38\nException in thread \"main\" java.lang.NullPointerException\n        at com.example.myproject.Book.getTitle(Book.java:16)\n        at com.example.myproject.Author.getBookTitles(Author.java:25)\n        at com.example.myproject.Bootstrap.main(Bootstrap.java:14)\nhello world\n{\n    \"@timestamp\" =&gt; 2020-12-12T19:28:38.285Z,\n       \"message\" =&gt; \"Exception in thread \\\"main\\\" java.lang.NullPointerException\\n        at com.example.myproject.Book.getTitle(Book.java:16)\\n        at com.example.myproject.Author.getBookTitles(Author.java:25)\\n        at com.example.myproject.Bootstrap.main(Bootstrap.java:14)\",\n      \"@version\" =&gt; \"1\",\n          \"tags\" =&gt; [\n        [0] \"multiline\"\n    ],\n          \"host\" =&gt; \"elasticsearch7\"\n}\n</code></pre>"},{"location":"chap14/1logstash_introduce/#9-6-movielenslogstashconf","title":"9-6 movielens/logstash.conf","text":"<p>logstash.conf</p> <pre><code>input {\n  file {\n    path =&gt; \"/home/vagrant/logstash/movielens/ml-latest-small/movies.csv\"\n    start_position =&gt; \"beginning\"\n    sincedb_path =&gt; \"/dev/null\"\n  }\n}\nfilter {\n  csv {\n    separator =&gt; \",\"\n    columns =&gt; [\"id\",\"content\",\"genre\"]\n  }\n\n  mutate {\n    split =&gt; { \"genre\" =&gt; \"|\" }\n    remove_field =&gt; [\"path\", \"host\",\"@timestamp\",\"message\"]\n  }\n\n  mutate {\n\n    split =&gt; [\"content\", \"(\"]\n    add_field =&gt; { \"title\" =&gt; \"%{[content][0]}\"}\n    add_field =&gt; { \"year\" =&gt; \"%{[content][1]}\"}\n  }\n\n  mutate {\n    convert =&gt; {\n      \"year\" =&gt; \"integer\"\n    }\n    strip =&gt; [\"title\"]\n    remove_field =&gt; [\"path\", \"host\",\"@timestamp\",\"message\",\"content\"]\n  }\n\n}\noutput {\n   elasticsearch {\n     hosts =&gt; \"http://localhost:9200\"\n     index =&gt; \"movies\"\n     document_id =&gt; \"%{id}\"\n   }\n  stdout {}\n}\n</code></pre> <ul> <li>path: filter location</li> <li><code>sincedb_path</code>: \u6211\u4eec\u4e0d\u9700\u8981\u8fd9\u4e2a\u529f\u80fd\uff0c\u6240\u4ee5\u6307\u5b9a\u5230\u4e86\"/dev/null\"</li> <li>output: elasticsearch<ul> <li>hosts / index / document_id</li> </ul> </li> </ul>"},{"location":"chap14/1logstash_introduce/#10qa","title":"10\u3001Q&amp;A","text":"<p>Q: \u600e\u6837\u4f7f\u7528logstash\u5bfc\u5165word\u6587\u6863\u5230ES\u5462</p> <p>A:</p> <p>logstash \u4f3c\u4e4e\u5e76\u4e0d\u80fd\u5904\u7406word\u6587\u6863\u3002\u5982\u679c\u9700\u8981\u5904\u7406pdf\uff0cppt\u7b49\u6587\u6863\uff0c\u9700\u8981\u5b89\u88c5 ingest-attachment\u63d2\u4ef6 https://www.elastic.co/guide/en/elasticsearch/plugins/current/ingest-attachment.html</p>"},{"location":"chap14/2JDBC_logstash_ES/","title":"\u7b2c\u4e8c\u8282 \u5229\u7528 JDBC \u63d2\u4ef6\u5bfc\u5165\u6570\u636e\u5230 Elasticsearch","text":""},{"location":"chap14/2JDBC_logstash_ES/#1-elasticsearch","title":"1\u3001\u540c\u6b65\u6570\u636e\u5e93\u6570\u636e\u5230 Elasticsearch","text":"<p>\u9700\u6c42 \u2013 \u5c06\u6570\u636e\u5e93\u4e2d\u7684\u6570\u636e\u540c\u6b65\u5230 ES\uff0c\u501f\u52a9 ES \u7684\u5168\u6587\u641c\u7d22\uff0c\u63d0\u9ad8\u641c\u7d22\u901f\u5ea6</p> <ul> <li>\u9700\u8981\u628a\u65b0\u589e\u7528\u6237\u4fe1\u606f\u540c\u6b65\u5230 Elasticsearch \u4e2d</li> <li>\u7528\u6237\u4fe1\u606f Update \u540e\uff0c\u9700\u8981\u80fd\u88ab\u66f4\u65b0\u5230 Elasticsearch</li> <li>\u652f\u6301\u589e\u91cf\u66f4\u65b0</li> <li>\u7528\u6237\u6ce8\u9500\u540e\uff0c\u4e0d\u80fd\u88ab ES \u6240\u641c\u7d22\u5230</li> </ul>"},{"location":"chap14/2JDBC_logstash_ES/#2jdbc-input-plugin","title":"2\u3001JDBC Input Plugin &amp; \u8bbe\u8ba1\u5b9e\u73b0\u601d\u8def","text":"<ul> <li>\u652f\u6301\u901a\u8fc7 JDBC Input Plugin \u5c06\u6570\u636e\u4ece\u6570\u636e\u5e93\u4ece\u8bfb\u5230 Logstash<ul> <li>\u9700\u8981\u81ea\u5df1\u63d0\u4f9b\u6240\u9700\u7684 JDBC Driver</li> </ul> </li> <li>Scheduling<ul> <li>\u8bed\u6cd5\u6765\u81ea Rufus-scheduler</li> <li>\u6269\u5c55\u4e86 Cron\uff0c\u652f\u6301\u65f6\u533a</li> </ul> </li> <li>State<ul> <li><code>Tracking_column</code> / <code>sql_last_value</code></li> </ul> </li> </ul> <p>https://www.elastic.co/downloads/jdbc-client</p> <pre><code>cd /usr/share/logstash/logstash-core/lib/jars\nwget https://cdn.mysql.com//Downloads/Connector-J/mysql-connector-java-5.1.49.zip\nsudo yum install unzip\nunzip mysql-connector-java-5.1.49.zip\ncd mysql-connector-java-5.1.49\nmv mysql-connector-java-5.1.49.jar ../\n\n</code></pre> <pre><code>use dbtest;\n\nCREATE TABLE user (\n    id INT AUTO_INCREMENT PRIMARY KEY,\n    name VARCHAR(255) NOT NULL,\n    email VARCHAR(320),\n    last_updated INT(11) NOT NULL DEFAULT '0',\n    is_deleted TINYINT(1) NOT NULL DEFAULT '0'\n);\n\n\nmysql&gt; CREATE TABLE user (\n    -&gt;     id INT AUTO_INCREMENT PRIMARY KEY,\n    -&gt;     name VARCHAR(255) NOT NULL,\n    -&gt;     email VARCHAR(320),\n    -&gt;     last_updated INT(11) NOT NULL DEFAULT '0',\n    -&gt;     is_deleted TINYINT(1) NOT NULL DEFAULT '0'\n    -&gt; );\nQuery OK, 0 rows affected (0.32 sec)\n\nmysql&gt; insert into user values('','jacob','jacob@test.com','','');\nQuery OK, 1 row affected, 3 warnings (0.20 sec)\n\nmysql&gt; select * from user;\n+----+-------+----------------+--------------+------------+\n| id | name  | email          | last_updated | is_deleted |\n+----+-------+----------------+--------------+------------+\n|  1 | jacob | jacob@test.com |            0 |          0 |\n+----+-------+----------------+--------------+------------+\n1 row in set (0.19 sec)\n</code></pre> <p><code>mysql-demo.conf</code></p> <pre><code>input {\n  jdbc {\n\n    jdbc_driver_library =&gt; \"/usr/share/logstash/logstash-core/lib/jars/mysql-connector-java-5.1.49.jar\"\n    jdbc_driver_class =&gt; \"com.mysql.jdbc.Driver\"\n    jdbc_connection_string =&gt; \"jdbc:mysql://db_hots:3306/dbtest?useSSL=false\"\n    # useSSL=false disable SSL the verify\n    jdbc_user =&gt; admin\n    jdbc_password =&gt; passoword\n    #\u542f\u7528\u8ffd\u8e2a\uff0c\u5982\u679c\u4e3atrue\uff0c\u5219\u9700\u8981\u6307\u5b9atracking_column\n    use_column_value =&gt; true\n    #\u6307\u5b9a\u8ffd\u8e2a\u7684\u5b57\u6bb5\uff0c\n    tracking_column =&gt; \"last_updated\"\n    #\u8ffd\u8e2a\u5b57\u6bb5\u7684\u7c7b\u578b\uff0c\u76ee\u524d\u53ea\u6709\u6570\u5b57(numeric)\u548c\u65f6\u95f4\u7c7b\u578b(timestamp)\uff0c\u9ed8\u8ba4\u662f\u6570\u5b57\u7c7b\u578b\n    tracking_column_type =&gt; \"numeric\"\n    #\u8bb0\u5f55\u6700\u540e\u4e00\u6b21\u8fd0\u884c\u7684\u7ed3\u679c\n    record_last_run =&gt; true\n    #\u4e0a\u9762\u8fd0\u884c\u7ed3\u679c\u7684\u4fdd\u5b58\u4f4d\u7f6e\n    last_run_metadata_path =&gt; \"jdbc-position.txt\"\n    statement =&gt; \"SELECT * FROM user where last_updated &gt;:sql_last_value;\"\n    schedule =&gt; \" * * * * * *\"\n  }\n}\noutput {\n  elasticsearch {\n    document_id =&gt; \"%{id}\"\n    document_type =&gt; \"_doc\"\n    index =&gt; \"users\"\n    hosts =&gt; [\"http://localhost:9200\"]\n  }\n  stdout{\n    codec =&gt; rubydebug\n  }\n}\n</code></pre> <pre><code>$ logstash -f mysql-demo.conf\n FROM user where last_updated &gt;0;\n[2020-12-13T05:15:46,179][INFO ][logstash.inputs.jdbc     ][main][6b0ee2f856c602fc2c0158f436cb05489d0e96fe565728ffb597961d7dc64a68] (0.217996s) SELECT * FROM user where last_updated &gt;0;\n[2020-12-13T05:15:48,815][INFO ][logstash.inputs.jdbc     ][main][6b0ee2f856c602fc2c0158f436cb05489d0e96fe565728ffb597961d7dc64a68] (0.215261s) SELECT * FROM user where last_updated &gt;0;\n[2020-12-13T05:15:51,512][INFO ][logstash.inputs.jdbc     ][main][6b0ee2f856c602fc2c0158f436cb05489d0e96fe565728ffb597961d7dc64a68] (0.214389s) SELECT * FROM user where last_updated &gt;0;\n[2020-12-13T05:15:54,139][INFO ][logstash.inputs.jdbc     ][main][6b0ee2f856c602fc2c0158f436cb05489d0e96fe565728ffb597961d7dc64a68] (0.212874s) SELECT * FROM user where last_updated &gt;0;\n[2020-12-13T05:15:56,748][INFO ][logstash.inputs.jdbc     ][main][6b0ee2f856c602fc2c0158f436cb05489d0e96fe565728ffb597961d7dc64a68] (0.216092s) SELECT * FROM user where last_updated &gt;0;\n[2020-12-13T05:15:59,373][INFO ][logstash.inputs.jdbc     ][main][6b0ee2f856c602fc2c0158f436cb05489d0e96fe565728ffb597961d7dc64a68] (0.217051s) SELECT * FROM user where last_updated &gt;0;\n[2020-12-13T05:16:02,001][INFO ][logstash.inputs.jdbc     ][main][6b0ee2f856c602fc2c0158f436cb05489d0e96fe565728ffb597961d7dc64a68] (0.213808s) SELECT * FROM user where last_updated &gt;0;\n[2020-12-13T05:16:05,164][INFO ][logstash.inputs.jdbc     ][main][6b0ee2f856c602fc2c0158f436cb05489d0e96fe565728ffb597961d7dc64a68] (0.210873s) SELECT * FROM user where last_updated &gt;0;\n[2020-12-13T05:16:07,750][INFO ][logstash.inputs.jdbc     ][main][6b0ee2f856c602fc2c0158f436cb05489d0e96fe565728ffb597961d7dc64a68] (0.213390s) SELECT * FROM user where last_updated &gt;0;\n[2020-12-13T05:16:10,385][INFO ][logstash.inputs.jdbc     ][main][6b0ee2f856c602fc2c0158f436cb05489d0e96fe565728ffb597961d7dc64a68] (0.218651s) SELECT * FROM user where last_updated &gt;0;\n[2020-12-13T05:16:13,240][INFO ][logstash.inputs.jdbc     ][main][6b0ee2f856c602fc2c0158f436cb05489d0e96fe565728ffb597961d7dc64a68] (0.213114s) SELECT * FROM user where last_updated &gt;0;\n[2020-12-13T05:16:15,803][INFO ][logstash.inputs.jdbc     ][main][6b0ee2f856c602fc2c0158f436cb05489d0e96fe565728ffb597961d7dc64a68] (0.211320s) SELECT * FROM user where last_updated &gt;0;\n[2020-12-13T05:16:18,389][INFO ][logstash.inputs.jdbc     ][main][6b0ee2f856c602fc2c0158f436cb05489d0e96fe565728ffb597961d7dc64a68] (0.213701s) SELECT * FROM user where last_updated &gt;0;\n[2020-12-13T05:16:20,998][INFO ][logstash.inputs.jdbc     ][main][6b0ee2f856c602fc2c0158f436cb05489d0e96fe565728ffb597961d7dc64a68] (0.216809s) SELECT * FROM user where last_updated &gt;0;\n[2020-12-13T05:16:23,646][INFO ][logstash.inputs.jdbc     ][main][6b0ee2f856c602fc2c0158f436cb05489d0e96fe565728ffb597961d7dc64a68] (0.215923s) SELECT * FROM user where last_updated &gt;0;\n[2020-12-13T05:16:26,350][INFO ][logstash.inputs.jdbc     ][main][6b0ee2f856c602fc2c0158f436cb05489d0e96fe565728ffb597961d7dc64a68] (0.214398s) SELECT * FROM user where last_updated &gt;0;\n</code></pre>"},{"location":"chap14/2JDBC_logstash_ES/#3demo","title":"3\u3001Demo","text":""},{"location":"chap14/2JDBC_logstash_ES/#3-1","title":"3-1 \u63d2\u5165\u65b0\u7684\u6570\u636e","text":"<pre><code>mysql&gt; insert into user values('','ham','ham@test.com',UNIX_TIMESTAMP() ,'');\nQuery OK, 1 row affected, 2 warnings (0.20 sec)\n\nmysql&gt; select * from user;\n+----+-------+----------------+--------------+------------+\n| id | name  | email          | last_updated | is_deleted |\n+----+-------+----------------+--------------+------------+\n|  1 | jacob | jacob@test.com |            0 |          0 |\n|  2 | ham   | ham@test.com   |   1608174096 |          0 |\n+----+-------+----------------+--------------+------------+\n2 rows in set (0.20 sec)\n</code></pre> <pre><code>$ logstash -f mysql-demo.conf\n\n[2020-12-13T05:40:18,761][INFO ][logstash.inputs.jdbc     ][main][6b0ee2f856c602fc2c0158f436cb05489d0e96fe565728ffb597961d7dc64a68] (0.215617s) SELECT * FROM user where last_updated &gt;1608174096;\n{\n           \"email\" =&gt; \"ham@test.com\",\n            \"name\" =&gt; \"ham\",\n      \"@timestamp\" =&gt; 2020-12-13T05:40:15.249Z,\n              \"id\" =&gt; 2,\n        \"@version\" =&gt; \"1\",\n      \"is_deleted\" =&gt; false,\n    \"last_updated\" =&gt; 1608174096\n}\n[2020-12-13T05:40:21,395][INFO ][logstash.inputs.jdbc     ][main][6b0ee2f856c602fc2c0158f436cb05489d0e96fe565728ffb597961d7dc64a68] (0.213273s) SELECT * FROM user where last_updated &gt;1608174096;\n[2020-12-13T05:40:25,689][INFO ][logstash.inputs.jdbc     ][main][6b0ee2f856c602fc2c0158f436cb05489d0e96fe565728ffb597961d7dc64a68] (0.217912s) SELECT * FROM user where last_updated &gt;1608174096;\n</code></pre> <pre><code>insert into user values('','mike','mike@test.com',UNIX_TIMESTAMP() ,'');\ninsert into user values('','kate','kate@test.com',UNIX_TIMESTAMP() ,'');\n</code></pre> <pre><code>[2020-12-13T05:42:54,156][INFO ][logstash.inputs.jdbc     ][main][6b0ee2f856c602fc2c0158f436cb05489d0e96fe565728ffb597961d7dc64a68] (0.216099s) SELECT * FROM user where last_updated &gt;1608174096;\n{\n           \"email\" =&gt; \"mike@test.com\",\n            \"name\" =&gt; \"mike\",\n      \"@timestamp\" =&gt; 2020-12-13T05:42:54.162Z,\n              \"id\" =&gt; 3,\n        \"@version\" =&gt; \"1\",\n      \"is_deleted\" =&gt; false,\n    \"last_updated\" =&gt; 1608174346\n}\n\n....\n[2020-12-13T05:43:20,257][INFO ][logstash.inputs.jdbc     ][main][6b0ee2f856c602fc2c0158f436cb05489d0e96fe565728ffb597961d7dc64a68] (0.218078s) SELECT * FROM user where last_updated &gt;1608174346;\n{\n           \"email\" =&gt; \"kate@test.com\",\n            \"name\" =&gt; \"kate\",\n      \"@timestamp\" =&gt; 2020-12-13T05:43:20.259Z,\n              \"id\" =&gt; 4,\n        \"@version\" =&gt; \"1\",\n      \"is_deleted\" =&gt; false,\n    \"last_updated\" =&gt; 1608174368\n}\n...\n</code></pre>"},{"location":"chap14/2JDBC_logstash_ES/#3-2-check-insterted-user","title":"3-2 Check insterted user","text":"<pre><code>GET users/_search\n</code></pre> <pre><code>{\n  \"took\" : 28,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 1,\n    \"successful\" : 1,\n    \"skipped\" : 0,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : {\n      \"value\" : 3,\n      \"relation\" : \"eq\"\n    },\n    \"max_score\" : 1.0,\n    \"hits\" : [\n      {\n        \"_index\" : \"users\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"2\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"email\" : \"ham@test.com\",\n          \"name\" : \"ham\",\n          \"@timestamp\" : \"2020-12-13T05:40:15.249Z\",\n          \"id\" : 2,\n          \"@version\" : \"1\",\n          \"is_deleted\" : false,\n          \"last_updated\" : 1608174096\n        }\n      },\n      {\n        \"_index\" : \"users\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"3\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"email\" : \"mike@test.com\",\n          \"name\" : \"mike\",\n          \"@timestamp\" : \"2020-12-13T05:42:54.162Z\",\n          \"id\" : 3,\n          \"@version\" : \"1\",\n          \"is_deleted\" : false,\n          \"last_updated\" : 1608174346\n        }\n      },\n      {\n        \"_index\" : \"users\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"4\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"email\" : \"kate@test.com\",\n          \"name\" : \"kate\",\n          \"@timestamp\" : \"2020-12-13T05:43:20.259Z\",\n          \"id\" : 4,\n          \"@version\" : \"1\",\n          \"is_deleted\" : false,\n          \"last_updated\" : 1608174368\n        }\n      }\n    ]\n  }\n}\n</code></pre>"},{"location":"chap14/2JDBC_logstash_ES/#3-3-update-data","title":"3-3 Update Data","text":"<pre><code>UPDATE user SET name=\"ham2\", last=UNIX_TIMESTAMP() where id=2;\n</code></pre> <pre><code>...\n[2020-12-13T06:20:02,467][INFO ][logstash.inputs.jdbc     ][main][6b0ee2f856c602fc2c0158f436cb05489d0e96fe565728ffb597961d7dc64a68] (0.215766s) SELECT * FROM user where last_updated &gt;1608174368;\n{\n           \"email\" =&gt; \"ham@test.com\",\n            \"name\" =&gt; \"ham2\",\n      \"@timestamp\" =&gt; 2020-12-13T06:20:02.542Z,\n              \"id\" =&gt; 2,\n        \"@version\" =&gt; \"1\",\n      \"is_deleted\" =&gt; false,\n    \"last_updated\" =&gt; 1608176401\n}\n...\n</code></pre>"},{"location":"chap14/2JDBC_logstash_ES/#3-3-check-deleted-user-data","title":"3-3 Check Deleted User Data","text":"<pre><code># \u521b\u5efa alias\uff0c\u53ea\u663e\u793a\u6ca1\u6709\u88ab\u6807\u8bb0 deleted\u7684\u7528\u6237\nPOST /_aliases\n{\n  \"actions\": [\n    {\n      \"add\": {\n        \"index\": \"users\",\n        \"alias\": \"view_users\",\n         \"filter\" : { \"term\" : { \"is_deleted\" : false } }\n      }\n    }\n  ]\n}\n</code></pre> <p>Set one user is_deleted as true</p> <pre><code>UPDATE user SET is_deleted=1, last_updated=UNIX_TIMESTAMP() WHERE id=4;\n\n\nselect * from user;\n+----+-------+----------------+--------------+------------+\n| id | name  | email          | last_updated | is_deleted |\n+----+-------+----------------+--------------+------------+\n|  1 | jacob | jacob@test.com |            0 |          0 |\n|  2 | ham2  | ham@test.com   |   1608176401 |          0 |\n|  3 | mike  | mike@test.com  |   1608174346 |          0 |\n|  4 | kate  | kate@test.com  |   1608213235 |          1 |\n+----+-------+----------------+--------------+------------+\n4 rows in set (0.20 sec)\n</code></pre> <pre><code>...\n{\n      \"@timestamp\" =&gt; 2020-12-13T07:11:09.431Z,\n            \"name\" =&gt; \"kate\",\n              \"id\" =&gt; 4,\n           \"email\" =&gt; \"kate@test.com\",\n    \"last_updated\" =&gt; 1608213235,\n        \"@version\" =&gt; \"1\",\n      \"is_deleted\" =&gt; true\n}\n...\n</code></pre> <pre><code># \u901a\u8fc7 Alias\u67e5\u8be2\uff0c\u67e5\u4e0d\u5230\u88ab\u6807\u8bb0\u6210 deleted\u7684\u7528\u6237\nPOST view_users/_search\n{\n\n}\n</code></pre> <p>Output\uff1akate disappear</p> <pre><code>\"hits\" : [\n      {\n        \"_index\" : \"users\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"3\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"email\" : \"mike@test.com\",\n          \"name\" : \"mike\",\n          \"@timestamp\" : \"2020-12-13T05:42:54.162Z\",\n          \"id\" : 3,\n          \"@version\" : \"1\",\n          \"is_deleted\" : false,\n          \"last_updated\" : 1608174346\n        }\n      },\n      {\n        \"_index\" : \"users\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"2\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"email\" : \"ham@test.com\",\n          \"name\" : \"ham2\",\n          \"@timestamp\" : \"2020-12-13T06:20:02.542Z\",\n          \"id\" : 2,\n          \"@version\" : \"1\",\n          \"is_deleted\" : false,\n          \"last_updated\" : 1608176401\n        }\n      }\n    ]\n  }\n</code></pre> <p>\u5728\u53ea\u663e\u793a\u672a\u88ab\u5220\u9664\u7684\u7528\u6237\u7684<code>view_users</code>\u67e5\u8be2</p> <pre><code>POST view_users/_search\n{\n  \"query\": {\n    \"term\": {\n      \"name.keyword\": {\n        \"value\": \"kate\"\n      }\n    }\n  }\n}\n</code></pre> <pre><code>\"hits\" : [ ]\n</code></pre> <p>\u5728\u5168\u90e8\u7528\u6237\u7684<code>users</code>\u67e5\u8be2</p> <pre><code>POST users/_search\n{\n  \"query\": {\n    \"term\": {\n      \"name.keyword\": {\n        \"value\": \"kate\"\n      }\n    }\n  }\n}\n</code></pre> <pre><code>\"hits\" : [\n      {\n        \"_index\" : \"users\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"4\",\n        \"_score\" : 0.6931471,\n        \"_source\" : {\n          \"@timestamp\" : \"2020-12-13T07:11:09.431Z\",\n          \"name\" : \"kate\",\n          \"id\" : 4,\n          \"email\" : \"kate@test.com\",\n          \"last_updated\" : 1608213235,\n          \"@version\" : \"1\",\n          \"is_deleted\" : true\n        }\n      }\n    ]\n</code></pre>"},{"location":"chap14/2JDBC_logstash_ES/#4qa","title":"4\u3001Q&amp;A","text":"<ul> <li> <p>\u8fd9\u79cd\u67e5\u8868\u5f97\u65b9\u5f0f\u5e94\u8be5\u4e0d\u662f\u5f88\u9002\u7528\u4e8e\u751f\u4ea7\u73af\u5883\u7684\uff0c\u76d1\u542cbinlog\u65e5\u5fd7\u76f8\u5bf9\u4e8e\u751f\u4ea7\u73af\u5883\u6765\u8bf4\u66f4\u597d\u70b9</p> <ul> <li>\u76d1\u542cbinlog\u786e\u5b9e\u6709\u66f4\u591ajdbc\u4e0d\u5177\u5907\u7684\u4f18\u70b9</li> </ul> </li> <li> <p>\u8bf7\u95eelogstash\u8fd9\u79cd\u8f6e\u8be2\u65b9\u5f0f\u83b7\u53d6\u6570\u636e\u6709\u6ca1\u6709\u5565\u6027\u80fd\u95ee\u9898\uff1f\u6211\u4eec\u76ee\u524d\u4f7f\u7528\u65b9\u5f0f\u662fkafka\u8ba2\u9605binlog</p> </li> </ul>"},{"location":"chap14/3Beats/","title":"\u7b2c\u4e09\u8282 Beats \u4ecb\u7ecd","text":""},{"location":"chap14/3Beats/#1-beats","title":"1\u3001\u4ec0\u4e48\u662f Beats","text":"<p>Light weight data shippers</p> <ul> <li>\u4ee5\u641c\u96c6\u6570\u636e\u4e3a\u4e3b</li> <li>\u652f\u6301\u4e0e Logstash \u6216 ES \u96c6\u6210</li> </ul> <p>\u5168\u54c1\u7c7b/\u8f7b\u91cf\u7ea7/\u5f00\u7bb1\u5373\u7528/\u53ef\u63d2\u62d4 / \u53ef\u6269\u5c55 / \u53ef\u89c6\u5316</p> <p></p>"},{"location":"chap14/3Beats/#2metricbeat","title":"2\u3001Metricbeat","text":""},{"location":"chap14/3Beats/#2-1-metricbeat","title":"2-1 Metricbeat \u7b80\u4ecb","text":"<ul> <li>\u7528\u6765\u5b9a\u671f\u641c\u96c6\u64cd\u4f5c\u7cfb\u7edf\uff0c\u8f6f\u4ef6\u7684\u6307\u6807\u6570\u636e<ul> <li>Metric v.s Logs: <ul> <li>Metric \u2013 \u53ef\u805a\u5408\u7684\u6570\u636e\uff0c\u5b9a\u671f\u641c\u96c6</li> <li>Logs \u6587\u672c\u6570\u636e\uff0c\u968f\u673a\u641c\u96c6</li> </ul> </li> </ul> </li> <li>\u6307\u6807\u5b58\u50a8\u5728 Elasticsearch \u4e2d\uff0c\u53ef\u4ee5\u901a\u8fc7 Kibana \u8fdb\u884c\u5b9e\u65f6\u7684\u6570\u636e\u5206\u6790</li> </ul>"},{"location":"chap14/3Beats/#2-2-metricbeat","title":"2-2 Metricbeat \u7ec4\u6210","text":"<p>Module</p> <p>\u641c\u96c6\u7684\u6307\u6807\u5bf9\u8c61\uff0c\u4f8b\u5982\u4e0d\u540c\u7684\u64cd\u4f5c\u7cfb\u7edf\uff0c\u4e0d\u540c\u7684\u6570\u636e\u5e93\uff0c\u4e0d\u540c\u7684\u5e94\u7528\u7cfb\u7edf</p> <p>Metricset</p> <ul> <li>\u4e00\u4e2a Module\u53ef\u4ee5\u6709\u591a\u4e2a metricset</li> <li>\u5177\u4f53\u7684\u6307\u6807\u96c6\u5408\u3002\u4ee5\u51cf\u5c11\u8c03\u7528\u6b21\u6570\u4e3a\u539f\u5219\u8fdb\u884c\u5212\u5206<ul> <li>\u4e0d\u540c\u7684 metricset \u53ef\u4ee5\u8bbe\u7f6e\u4e0d\u540c\u7684\u6293\u53d6\u65f6\u957f</li> </ul> </li> </ul>"},{"location":"chap14/3Beats/#2-3-module","title":"2-3 Module \u7ec4\u6210","text":"<ul> <li>Metricbeat \u63d0\u4f9b\u4e86\u5927\u91cf\u7684\u5f00\u7bb1\u5373\u7528\u7684 Module<ul> <li>https://www.elastic.co/guide/en/beats/metricbeat/7.1/index.html</li> </ul> </li> <li>\u901a\u8fc7\u6267\u884c <code>metricbeat module list</code> \u67e5\u770b</li> <li>\u901a\u8fc7\u6267\u884c <code>metricbeat moudle enable module_name</code> \u5b9a\u5236</li> </ul>"},{"location":"chap14/3Beats/#2-4-metricsets","title":"2-4 Metricsets","text":"<p>\u6bcf\u4e2a Module \u90fd\u6709\u81ea\u5df1\u7684 metricsets\uff0c\u4ee5 System Module \u4e3a\u4f8b</p> <ul> <li>core</li> <li>CPU</li> <li>disk IO </li> <li>filesystem </li> <li>load</li> <li>memory</li> </ul>"},{"location":"chap14/3Beats/#2-5-metricbeat-event","title":"2-5 Metricbeat Event","text":""},{"location":"chap14/3Beats/#2-5-metricbeat-demo","title":"2-5 Metricbeat Demo","text":"<ul> <li>\u4e0b\u8f7d\u5b89\u88c5\u5e76\u914d\u7f6e Metricbeat<ul> <li>Enable \u67e5\u770b system &amp; Mysql</li> <li>\u5b9a\u4e49 interval  </li> </ul> </li> <li>\u914d\u7f6e Kibana Dashboard</li> <li>\u8fd0\u884c</li> <li>\u67e5\u770b \u7d22\u5f15 / Dashboard</li> </ul> <p>https://www.elastic.co/downloads/beats/metricbeat</p> <pre><code>wget https://artifacts.elastic.co/downloads/beats/metricbeat/metricbeat-7.10.1-linux-x86_64.tar.gz\ntar xvzf metricbeat-7.10.1-linux-x86_64.tar.gz\ncd metricbeat-7.10.1-linux-x86_64\n</code></pre> <pre><code>./metricbeat modules list\n\n./metricbeat modules list\nEnabled:\nsystem\n\nDisabled:\nactivemq\naerospike\napache\nappsearch\naws\nazure\nbeat\nbeat-xpack\nceph\nceph-mgr\ncloudfoundry\ncockroachdb\nconsul\ncoredns\ncouchbase\ncouchdb\ndocker\ndropwizard\nelasticsearch\nelasticsearch-xpack\nenvoyproxy\netcd\ngolang\ngooglecloud\n...\n</code></pre> <pre><code>./metricbeat modules enable docker\n./metricbeat modules enable kibana\n./metricbeat modules enable elasticsearch\n</code></pre> <pre><code> ./metricbeat modules list\nEnabled:\ndocker\nelasticsearch\nkibana\nsystem\n\nDisabled:\nactivemq\n</code></pre> <pre><code>$ ./metricbeat setup --dashboards\nLoading dashboards (Kibana must be running and reachable)\nLoaded dashboards\n</code></pre> <p></p> <pre><code>vim module/mysql/module.yml\n\n# add db basic infomation\n</code></pre> <p></p> <p></p>"},{"location":"chap14/3Beats/#2-6-my-metricbeat-experiments","title":"2-6 My Metricbeat Experiments","text":"<p>Install</p> <p>https://www.elastic.co/guide/en/beats/metricbeat/current/setup-repositories.html</p> <pre><code>sudo vim /etc/yum.repos.d/elastic.repo\n\n[elastic-7.x]\nname=Elastic repository for 7.x packages\nbaseurl=https://artifacts.elastic.co/packages/7.x/yum\ngpgcheck=1\ngpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch\nenabled=1\nautorefresh=1\ntype=rpm-md\n</code></pre> <pre><code>sudo yum install metricbeat\nsudo systemctl enable metricbeat\n\nsudo systemctl start metricbeat\nsudo journalctl -u metricbeat.service -r\n\nconfig file (\"/etc/metricbeat/metricbeat.yml\") must be owned by the user identifier (uid=0) or root\n\n\nsudo chown root:root /etc/metricbeat/metricbeat.yml\nsudo systemctl restart metricbeat.service\nsudo systemctl status metricbeat.service\n\n$ sudo systemctl status metricbeat.service\n\u25cf metricbeat.service - Metricbeat is a lightweight shipper for metrics.\n   Loaded: loaded (/usr/lib/systemd/system/metricbeat.service; enabled; vendor preset: disabled)\n   Active: active (running) since Mon 2020-12-14 04:01:35 UTC; 2h 44min ago\n     Docs: https://www.elastic.co/products/beats/metricbeat\n Main PID: 34765 (metricbeat)\n   CGroup: /system.slice/metricbeat.service\n           \u2514\u250034765 /usr/share/metricbeat/bin/metricbeat --environment systemd -c /etc/metricbeat/metricbeat.yml --path.home /usr/share/metricbeat --p...\n\nDec 14 06:41:51 elasticsearch7 metricbeat[34765]: 2020-12-14T06:41:51.066Z        INFO        [add_docker_metadata.docker]        docker/watc...tch call\nDec 14 06:42:05 elasticsearch7 metricbeat[34765]: 2020-12-14T06:42:05.354Z        INFO        [monitoring]        log/log.go:145        Non-zero metr...\nDec 14 06:42:35 elasticsearch7 metricbeat[34765]: 2020-12-14T06:42:35.357Z        INFO        [monitoring]        log/log.go:145        Non-zero metr...\nDec 14 06:43:05 elasticsearch7 metricbeat[34765]: 2020-12-14T06:43:05.353Z        INFO        [monitoring]        log/log.go:145        Non-zero metr...\nDec 14 06:43:35 elasticsearch7 metricbeat[34765]: 2020-12-14T06:43:35.353Z        INFO        [monitoring]        log/log.go:145        Non-zero metr...\nDec 14 06:44:05 elasticsearch7 metricbeat[34765]: 2020-12-14T06:44:05.353Z        INFO        [monitoring]        log/log.go:145        Non-zero metr...\nDec 14 06:44:35 elasticsearch7 metricbeat[34765]: 2020-12-14T06:44:35.354Z        INFO        [monitoring]        log/log.go:145        Non-zero metr...\nDec 14 06:45:05 elasticsearch7 metricbeat[34765]: 2020-12-14T06:45:05.353Z        INFO        [monitoring]        log/log.go:145        Non-zero metr...\nDec 14 06:45:35 elasticsearch7 metricbeat[34765]: 2020-12-14T06:45:35.353Z        INFO        [monitoring]        log/log.go:145        Non-zero metr...\nDec 14 06:46:05 elasticsearch7 metricbeat[34765]: 2020-12-14T06:46:05.354Z        INFO        [monitoring]        log/log.go:145        Non-zero metr...\nHint: Some lines were ellipsized, use -l to show in full.\n</code></pre> <p></p> <p>Overview</p> <p></p> <p>Nodes</p> <p></p> <p>Docker Metric Dashboard</p> <p></p>"},{"location":"chap14/3Beats/#3packetbeat","title":"3\u3001Packetbeat","text":""},{"location":"chap14/3Beats/#3-1-packetbeat","title":"3-1 Packetbeat \u7b80\u4ecb","text":"<ul> <li> <p>Packetbeat - \u5b9e\u65f6\u7f51\u7edc\u6570\u636e\u5206\u6790\uff0c\u76d1\u63a7\u5e94\u7528\u670d\u52a1\u5668\u4e4b\u95f4\u7684\u7f51\u7edc\u6d41\u91cf</p> <ul> <li>\u5e38\u89c1\u6293\u5305\u5de5\u5177 - Tcpdump /wireshark</li> <li>\u5e38\u89c1\u6293\u5305\u914d\u7f6e - Pcap \u57fa\u4e8e libpcap\uff0c\u8de8\u5e73\u53f0 / <code>Af_packet</code> \u4ec5\u652f\u6301 Linux\uff0c\u57fa\u4e8e\u5185\u5b58\u6620\u5c04\u55c5\u63a2\uff0c\u9ad8\u6027 \u80fd</li> </ul> </li> <li> <p>Packetbeat \u652f\u6301\u7684\u534f\u8bae</p> <ul> <li>ICMP / DHCP / DNS / HTTP / Cassandra / Mysql / PostgresSQL / Redis / MongoDB / Memcache / TLS</li> </ul> </li> <li> <p>Network flows:\u6293\u53d6\u8bb0\u5f55\u7f51\u7edc\u6d41\u91cf\u6570\u636e\uff0c\u4e0d\u6d89\u53ca\u534f\u8bae\u89e3\u6790</p> </li> </ul>"},{"location":"chap14/3Beats/#3-2-packetbeat-demo","title":"3-2 Packetbeat Demo","text":"<ul> <li>https://www.elastic.co/guide/en/beats/packetbeat/7.1/packetbeat-getting- started.html</li> <li>\u5b89\u88c5\u914d\u7f6e</li> <li>\u914d\u7f6e Kibana Dashboard<ul> <li><code>packetbeat setup --dashboards</code></li> </ul> </li> <li>\u8fd0\u884c Packetbeat</li> <li>\u67e5\u770b Dashboard</li> </ul> <pre><code>tar xvzf packetbeat-7.10.1-linux-x86_64.tar.gz\ncd packetbeat-7.10.1-linux-x86_64\n\nvim packetbeat.yml\n\n./packetbeat setup --dashboards\nLoading dashboards (Kibana must be running and reachable)\nLoaded dashboards\n</code></pre>"},{"location":"chap14/3Beats/#3-3-my-packetbeat-experiment","title":"3-3 My Packetbeat Experiment","text":"<pre><code>sudo yum install packetbeat\nsudo systemctl enable packetbeat\n\nsudo packetbeat setup --dashboards\n</code></pre> <p>[Packetbeat] Flows ECS</p> <p></p>"},{"location":"chap15/1chap15_index_pattern/","title":"\u7b2c\u4e00\u8282 \u4f7f\u7528 Index Pattern \u914d\u7f6e\u6570\u636e","text":""},{"location":"chap15/1chap15_index_pattern/#1index-pattern","title":"1\u3001Index Pattern","text":""},{"location":"chap15/1chap15_index_pattern/#2demo","title":"2\u3001Demo","text":""},{"location":"chap15/1chap15_index_pattern/#2-1-management","title":"2-1 Management","text":"<ul> <li>Index Patterns </li> <li>Saved Objects (\u5bfc\u51fa\u5907\u4efd)</li> </ul> <pre><code>http://192.168.33.12:5601/status\n</code></pre> <pre><code>PUT /logstash-2015.05.18\n{\n  \"mappings\": {\n    \"properties\": {\n      \"geo\": {\n        \"properties\": {\n          \"coordinates\": {\n            \"type\": \"geo_point\"\n          }\n        }\n      }\n    }\n  }\n}\n\n\n\nPUT /logstash-2015.05.19\n{\n  \"mappings\": {\n    \"properties\": {\n      \"geo\": {\n        \"properties\": {\n          \"coordinates\": {\n            \"type\": \"geo_point\"\n          }\n        }\n      }\n    }\n  }\n}\n\n\nPUT /logstash-2015.05.20\n{\n  \"mappings\": {\n    \"properties\": {\n      \"geo\": {\n        \"properties\": {\n          \"coordinates\": {\n            \"type\": \"geo_point\"\n          }\n        }\n      }\n    }\n  }\n}\n</code></pre> <pre><code>wget https://raw.githubusercontent.com/geektime-geekbang/geektime-ELK/master/part-4/13.1-%E4%BD%BF%E7%94%A8IndexPattern%E9%85%8D%E7%BD%AE%E6%95%B0%E6%8D%AE/accounts.json\n\nls -la\n\n$ ls -lah\ntotal 51M\ndrwxrwxr-x   2 vagrant vagrant   45 Dec 13 21:07 .\ndrwx------. 19 vagrant vagrant 4.0K Dec 13 20:55 ..\n-rw-rw-r--   1 vagrant vagrant 238K Dec 13 20:55 accounts.json\n-rw-rw-r--   1 vagrant vagrant  51M Dec 13 21:07 logs.jsonl\n</code></pre> <pre><code>curl -H 'Content-Type: application/x-ndjson' -XPOST 'localhost:9200/bank/account/_bulk?pretty' --data-binary @accounts.json\n\ncurl -H 'Content-Type: application/x-ndjson' -XPOST 'localhost:9200/_bulk?pretty' --data-binary @logs.jsonl\n</code></pre> <pre><code>\n$ curl -H 'Content-Type: application/x-ndjson' -XPOST 'localhost:9200/_bulk?pretty' --data-binary @logs.jsonl\n{\n  \"error\" : {\n    \"root_cause\" : [\n      {\n        \"type\" : \"es_rejected_execution_exception\",\n        \"reason\" : \"rejected execution of coordinating operation [coordinating_and_primary_bytes=0, replica_bytes=0, all_bytes=0, coordinating_operation_bytes=54215758, max_coordinating_and_primary_bytes=53687091]\"\n      }\n    ],\n    \"type\" : \"es_rejected_execution_exception\",\n    \"reason\" : \"rejected execution of coordinating operation [coordinating_and_primary_bytes=0, replica_bytes=0, all_bytes=0, coordinating_operation_bytes=54215758, max_coordinating_and_primary_bytes=53687091]\"\n  },\n  \"status\" : 429\n}\n</code></pre>"},{"location":"chap15/1chap15_index_pattern/#2-2-created-index-pattern-save-as-default-pattern","title":"2-2 Created Index Pattern (Save As default Pattern)","text":"<ul> <li>Fields:Type\uff0cSearchable/Aggregation / Format(Number / Image)</li> <li>Script Fields</li> </ul> <pre><code>http://192.168.33.12:9200/_cat/indices?v\n...\ngreen  open bank jWdzaovdQ92o74GE8wu90w 1 1  1000  0 811.9kb 429.6kb\ngreen  open logstash-2015.05.18                 jxaEDe-IRDi7TrNOnTy58g 1 1  2000  0  17.3mb   8.8mb\ngreen  open logstash-2015.05.19                 iJ9DNC14QwukRkCuIWTCoA 1 1  1500  0  12.9mb   6.2mb\ngreen  open logstash-2015.05.20                 i29NGn-4Q1ihdQ-BOr-4fA 1 1  1500  0  13.1mb   6.7mb\n\n</code></pre>"},{"location":"chap15/1chap15_index_pattern/#2-3-create-log-index","title":"2-3 Create <code>log*</code> index","text":"<p>Timefield =&gt; @timestamp</p> <p></p> <p>fields</p> <p></p> <p></p>"},{"location":"chap15/1chap15_index_pattern/#2-4-create-bank-index","title":"2-4 Create <code>bank</code> index","text":""},{"location":"chap15/1chap15_index_pattern/#3qa","title":"3\u3001Q&amp;A","text":"<p>A: Index Pattern \u662f\u4ec0\u4e48\uff1f\u548c Index Template \u6709\u4ec0\u4e48\u533a\u522b\u548c\u8054\u7cfb\uff1f</p> <ul> <li>index pattern\u662f\u5728kibana\u4e2d\u4f7f\u7528\u65f6\u53ea\u9700\u8981\u7684\u4e00\u4e2a\u6982\u5ff5\u3002</li> <li>template\u5219\u662f\u901a\u8fc7\u4e00\u7cfb\u5217\u89c4\u5219\u521b\u5efa\u7d22\u5f15\u7684mapping</li> </ul>"},{"location":"chap15/2chap15_kibana/","title":"\u7b2c\u4e8c\u8282 Kibana \u4f7f\u7528\u7684\u6280\u5de7","text":""},{"location":"chap15/2chap15_kibana/#1kibana-discover","title":"1\u3001\u4f7f\u7528Kibana Discover\u63a2\u7d22\u6570\u636e","text":""},{"location":"chap15/2chap15_kibana/#1-1","title":"1-1 \u8bbe\u7f6e\u65f6\u95f4\u8fc7\u6ee4\u5668","text":""},{"location":"chap15/2chap15_kibana/#1-2","title":"1-2 \u5199\u5165\u6761\u4ef6\u8fdb\u884c\u8fc7\u6ee4","text":"<ul> <li><code>geo.dest : CN</code></li> </ul>"},{"location":"chap15/2chap15_kibana/#1-3","title":"1-3 \u6839\u636e\u5b57\u6bb5\u8fc7\u6ee4","text":"<p>Add filter</p> <ul> <li>@timestamp</li> <li>bytes</li> <li>memory</li> </ul> <p></p>"},{"location":"chap15/2chap15_kibana/#1-4","title":"1-4 \u67e5\u770b\u5b57\u6bb5\u6570\u636e\u7edf\u8ba1","text":""},{"location":"chap15/2chap15_kibana/#1-5","title":"1-5 \u6587\u6863\u4e0a\u4e0b\u6587","text":""},{"location":"chap15/2chap15_kibana/#2","title":"2\u3001\u57fa\u672c\u53ef\u89c6\u5316\u7ec4\u4ef6\u4ecb\u7ecd","text":""},{"location":"chap15/2chap15_kibana/#2-1-pie-chart-inspector","title":"2-1 \u8d26\u6237\u5b58\u6b3e Pie Chart (Inspector)","text":"<p>1\u3001Check back index data </p> <p></p> <p>2\u3001Create <code>Pie Chart</code> New Visualization </p> <p></p> <p>3\u3001Balance Aggregation</p> <ul> <li>Metrics: Count</li> <li>Buckets: Split slices<ul> <li>Aggregation: Histogram</li> <li>Field: balance</li> <li>Minimum Interval: 5000</li> </ul> </li> </ul> <p></p> <p>4\u3001Add sub Aggregation: gender</p> <p>Sub Aggregation:</p> <ul> <li>Term (gender is type term in es)</li> <li>Field: gender.keyword</li> <li>Size: 5</li> </ul> <p></p> <p>5\u3001Add another sub Aggregation: age</p> <p>Sub Aggregation:</p> <ul> <li>Term (age is type term in es)</li> <li>Field: age</li> <li>Size: 3</li> </ul> <p></p> <p>6\u3001Adjust buckets order</p> <p>balance -&gt; age -&gt; gender</p> <p></p> <p></p> <p>7\u3001Inpect Visualization</p> <p></p> <p>8\u3001Inpect request</p> <p></p> <pre><code>{\n  \"aggs\": {\n    \"2\": {\n      \"histogram\": {\n        \"field\": \"balance\",\n        \"interval\": 5000,\n        \"min_doc_count\": 1\n      },\n      \"aggs\": {\n        \"4\": {\n          \"terms\": {\n            \"field\": \"age\",\n            \"order\": {\n              \"_count\": \"desc\"\n            },\n            \"size\": 3\n          },\n          \"aggs\": {\n            \"3\": {\n              \"terms\": {\n                \"field\": \"gender.keyword\",\n                \"order\": {\n                  \"_count\": \"desc\"\n                },\n                \"size\": 5\n              }\n            }\n          }\n        }\n      }\n    }\n  },\n  \"size\": 0,\n  \"stored_fields\": [\n    \"*\"\n  ],\n  \"script_fields\": {},\n  \"docvalue_fields\": [],\n  \"_source\": {\n    \"excludes\": []\n  },\n  \"query\": {\n    \"bool\": {\n      \"must\": [],\n      \"filter\": [\n        {\n          \"match_all\": {}\n        }\n      ],\n      \"should\": [],\n      \"must_not\": []\n    }\n  }\n}\n</code></pre> <p>9\u3001Save Visualization</p> <p></p> <p></p>"},{"location":"chap15/2chap15_kibana/#2-2","title":"2-2 \u65e5\u5fd7\u76f8\u5173","text":"<ul> <li>Area Chart (X \u8f74 Y \u8f74\uff0c \u987a\u5e8f\uff0cetc)</li> <li>Bar Chart</li> </ul> <p>1\u3001Create Area Chart for logstash</p> <ul> <li>Y Axis Aggregation: Date Histogram</li> <li>Minimum Inrterval: Auto</li> </ul> <p></p> <p>2\u3001Split series</p> <ul> <li>terms</li> <li>geo.src.keywords</li> <li>5</li> </ul> <p></p> <pre><code>{\n  \"aggs\": {\n    \"2\": {\n      \"date_histogram\": {\n        \"field\": \"@timestamp\",\n        \"fixed_interval\": \"3h\",\n        \"time_zone\": \"Asia/Shanghai\",\n        \"min_doc_count\": 1\n      },\n      \"aggs\": {\n        \"3\": {\n          \"terms\": {\n            \"field\": \"geo.src.keyword\",\n            \"order\": {\n              \"_count\": \"desc\"\n            },\n            \"size\": 5\n          }\n        }\n      }\n    }\n  },\n  \"size\": 0,\n  \"stored_fields\": [\n    \"*\"\n  ],\n  \"script_fields\": {},\n  \"docvalue_fields\": [\n    {\n      \"field\": \"@timestamp\",\n      \"format\": \"date_time\"\n    },\n    {\n      \"field\": \"relatedContent.article:modified_time\",\n      \"format\": \"date_time\"\n    },\n    {\n      \"field\": \"relatedContent.article:published_time\",\n      \"format\": \"date_time\"\n    },\n    {\n      \"field\": \"utc_time\",\n      \"format\": \"date_time\"\n    }\n  ],\n  \"_source\": {\n    \"excludes\": []\n  },\n  \"query\": {\n    \"bool\": {\n      \"must\": [],\n      \"filter\": [\n        {\n          \"match_all\": {}\n        },\n        {\n          \"range\": {\n            \"@timestamp\": {\n              \"gte\": \"2015-05-16T09:28:21.808Z\",\n              \"lte\": \"2015-05-24T02:54:25.665Z\",\n              \"format\": \"strict_date_optional_time\"\n            }\n          }\n        }\n      ],\n      \"should\": [],\n      \"must_not\": []\n    }\n  }\n}\n</code></pre> <p>3\u3001Adjust order\uff1a Split series -&gt; @timestamp</p> <p></p> <p>4\u3001Split chart</p> <ul> <li>terms</li> <li>geo.src.keywords</li> <li>5</li> </ul> <p></p> <ul> <li>Disable: Split series</li> <li>Adjust Order:  Split chart -&gt; @timestamp</li> </ul> <p></p> <p>5\u3001Change chart type</p> <p>Change Area -&gt; line</p> <p></p>"},{"location":"chap15/2chap15_kibana/#3dashboard","title":"3\u3001\u6784\u5efaDashboard","text":""},{"location":"chap15/2chap15_kibana/#3-1","title":"3-1 \u521b\u5efa\u4eea\u8868\u76d8","text":"<p>Add <code>back_vis</code> as dashboard</p> <p></p>"},{"location":"chap15/2chap15_kibana/#3-2-check-provisioned-web-traffic-dashboard","title":"3-2 Check Provisioned Web Traffic Dashboard","text":""},{"location":"chap16/1ES_monitor_alert_xpack/","title":"\u7b2c\u4e00\u8282 \u7528Monitoring\u548cAlerting\u76d1\u63a7Elasticsearch\u96c6\u7fa4","text":""},{"location":"chap16/1ES_monitor_alert_xpack/#1x-pack-monitoring","title":"1\u3001X-Pack Monitoring","text":"<ul> <li>X-Pack \u63d0\u4f9b\u4e86\u514d\u8d39\u96c6\u7fa4\u76d1\u63a7\u7684\u529f\u80fd</li> <li>\u4f7f\u7528 Elasticsearch \u76d1\u63a7 Elasticsearch<ul> <li><code>Xpack.monitoring.collection.interval</code> \u9ed8\u8ba4\u8bbe\u7f6e 10 \u79d2</li> </ul> </li> <li>\u5728\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u5efa\u8bae\u642d\u5efa dedicated \u96c6\u7fa4\u7528\u4e8e ES \u96c6\u7fa4\u7684\u76d1\u63a7\u3002\u6709\u4ee5\u4e0b\u51e0\u4e2a\u597d\u5904<ul> <li>\u51cf\u5c11\u8d1f\u8f7d\u548c\u6570\u636e</li> <li>\u5f53\u88ab\u76d1\u63a7\u96c6\u7fa4\u51fa\u73b0\u95ee\u9898\uff0c\u8fd8\u80fd\u770b\u5230\u76d1\u63a7\u76f8\u5173\u7684\u6570\u636e</li> </ul> </li> </ul> <p>https://www.elastic.co/subscriptions</p>"},{"location":"chap16/1ES_monitor_alert_xpack/#2-monitoring","title":"2\u3001\u914d\u7f6e Monitoring","text":"<p>https://www.elastic.co/guide/en/x-pack/current/xpack-settings.html</p>"},{"location":"chap16/1ES_monitor_alert_xpack/#2-1-enable-elasticsearch-xpack","title":"2-1 Enable <code>elasticsearch-xpack</code>","text":"<pre><code>metricbeat modules enable elasticsearch-xpack\nEnabled elasticsearch-xpack\n</code></pre>"},{"location":"chap16/1ES_monitor_alert_xpack/#2-2-management-monitoring-overview","title":"2-2 Management Monitoring -&gt; Overview","text":""},{"location":"chap16/1ES_monitor_alert_xpack/#2-2-management-monitoring-nodes","title":"2-2 Management Monitoring -&gt; Nodes","text":""},{"location":"chap16/1ES_monitor_alert_xpack/#2-3-management-monitoring-indices","title":"2-3 Management Monitoring -&gt; Indices","text":""},{"location":"chap16/1ES_monitor_alert_xpack/#3alerts-and-actions","title":"3\u3001Alerts and Actions","text":""},{"location":"chap16/1ES_monitor_alert_xpack/#3-1-enable-alerts-and-actions","title":"3-1 Enable Alerts and Actions","text":"<p>Stack Management -&gt; Alerts and Actions</p> <pre><code>$ docker ps | grep kibana\nc874705b1ef6   docker.elastic.co/kibana/kibana:7.9.1                 \"/usr/local/bin/dumb\u2026\"   3 weeks ago   Up 7 days   0.0.0.0:5601-&gt;5601/tcp             hwc_kibana7\n\ndocker exec -it c874705b1ef6 bash \ncd config/\nvi kibana.yml\n\n\nxpack.encryptedSavedObjects.encryptionKey: \"EePXCifCaykPORwjqKGbINHCPFYnNXZT\"\n\ndocker restart c874705b1ef6\n</code></pre> <p></p> <p></p>"},{"location":"chap16/1ES_monitor_alert_xpack/#3-2-create-alerts","title":"3-2 Create Alerts","text":"<ul> <li>Name: Mytestalert</li> <li>Index threshold: <ul> <li>index: <code>.monitoring-es-7-...</code></li> <li>conditon</li> </ul> </li> <li>Actions: <ul> <li>Log</li> </ul> </li> </ul>"},{"location":"chap16/1ES_monitor_alert_xpack/#3-3-default-cpu-alerts","title":"3-3 Default CPU Alerts","text":""},{"location":"chap16/2Xpack_APM/","title":"\u7b2c\u4e8c\u8282 \u7528 APM \u8fdb\u884c\u7a0b\u5e8f\u6027\u80fd\u76d1\u63a7","text":""},{"location":"chap16/2Xpack_APM/#1elastic","title":"1\u3001Elastic \u5168\u6808\u76d1\u63a7","text":""},{"location":"chap16/2Xpack_APM/#2","title":"2\u3001\u6838\u5fc3\u5e94\u7528\u6307\u6807","text":"<ul> <li>\u8bf7\u6c42\u54cd\u5e94\u65f6\u95f4</li> <li>\u672a\u5904\u7406\u7684\u9519\u8bef\u53ca\u5f02\u5e38 </li> <li>\u53ef\u89c6\u5316\u8c03\u7528\u5173\u7cfb</li> <li>\u53d1\u73b0\u6027\u80fd\u74f6\u9888</li> <li>\u4ee3\u7801\u4e0b\u94bb</li> </ul>"},{"location":"chap16/2Xpack_APM/#3apm","title":"3\u3001APM \u5b89\u88c5","text":"<p>https://www.elastic.co/apm</p> <p></p> <p>https://www.elastic.co/downloads</p> <pre><code>wget https://artifacts.elastic.co/downloads/apm-server/apm-server-7.9.1-linux-x86_64.tar.gz\n\ntar xvf apm-server-7.9.1-linux-x86_64.tar.gz\n</code></pre> <pre><code>sudo vim /etc/yum.repos.d/elastic.repo\n\n[elastic-7.x]\nname=Elastic repository for 7.x packages\nbaseurl=https://artifacts.elastic.co/packages/7.x/yum\ngpgcheck=1\ngpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch\nenabled=1\nautorefresh=1\ntype=rpm-md\n\nsudo yum install apm-server\nsudo systemctl start apm-server\n\n$ sudo systemctl status apm-server\n\u25cf apm-server.service - Elastic APM Server\n   Loaded: loaded (/usr/lib/systemd/system/apm-server.service; disabled; vendor preset: disabled)\n   Active: active (running) since Mon 2020-12-21 09:41:07 UTC; 2s ago\n     Docs: https://www.elastic.co/solutions/apm\n Main PID: 54731 (apm-server)\n    Tasks: 6\n   Memory: 98.1M\n   CGroup: /system.slice/apm-server.service\n           \u2514\u250054731 /usr/share/apm-server/bin/apm-server --environment systemd -c /etc/apm-server/apm-server.yml --path.home /usr/share/apm-server --p...\n\nDec 21 09:41:08 elasticsearch7 apm-server[54731]: 2020-12-21T09:41:08.630Z        INFO        [esclientleg]        eslegclient/connection.go:...on 7.9.1\nDec 21 09:41:08 elasticsearch7 apm-server[54731]: 2020-12-21T09:41:08.729Z        INFO        [index-management]        idxmgmt/manager.go:84...isabled.\nDec 21 09:41:08 elasticsearch7 apm-server[54731]: 2020-12-21T09:41:08.729Z        INFO        [index-management]        idxmgmt/manager.go:20...sion]}'.\nDec 21 09:41:08 elasticsearch7 apm-server[54731]: 2020-12-21T09:41:08.729Z        INFO        [index-management]        idxmgmt/manager.go:20...ion]}*'.\nDec 21 09:41:08 elasticsearch7 apm-server[54731]: 2020-12-21T09:41:08.860Z        INFO        template/load.go:117        Try loading templat...icsearch\nDec 21 09:41:09 elasticsearch7 apm-server[54731]: 2020-12-21T09:41:09.350Z        INFO        template/load.go:109        template with name ... loaded.\nDec 21 09:41:09 elasticsearch7 apm-server[54731]: 2020-12-21T09:41:09.350Z        INFO        [index-management]        idxmgmt/manager.go:21...emplate.\nDec 21 09:41:09 elasticsearch7 apm-server[54731]: 2020-12-21T09:41:09.366Z        INFO        [index-management.ilm]        ilm/std.go:139   ...te=false\nDec 21 09:41:09 elasticsearch7 apm-server[54731]: 2020-12-21T09:41:09.366Z        INFO        [index-management]        idxmgmt/manager.go:24... loaded.\nDec 21 09:41:09 elasticsearch7 apm-server[54731]: 2020-12-21T09:41:09.382Z        INFO        template/load.go:117        Try loading templat...icsearch\nHint: Some lines were ellipsized, use -l to show in full.\n</code></pre>"},{"location":"chap16/2Xpack_APM/#3apm_1","title":"3\u3001APM \u8bbe\u7f6e","text":""},{"location":"chap16/2Xpack_APM/#3-1-apm-server","title":"3-1 APM server","text":"<p>Check APM server status</p> <p></p>"},{"location":"chap16/2Xpack_APM/#3-1-apm-agent","title":"3-1 APM Agent","text":"<p>Exp: Java</p> <pre><code>java -javaagent:/path/to/elastic-apm-agent-&lt;version&gt;.jar \\\n     -Delastic.apm.service_name=my-application \\\n     -Delastic.apm.server_urls=http://localhost:8200 \\\n     -Delastic.apm.secret_token= \\\n     -Delastic.apm.application_packages=org.example \\\n     -jar my-application.jar\n</code></pre>"},{"location":"chap16/2Xpack_APM/#4apm","title":"4\u3001APM \u5c55\u793a","text":""},{"location":"chap16/2Xpack_APM/#4-1-transaction","title":"4-1 Transaction","text":""},{"location":"chap16/3Xpack_ML/","title":"\u7b2c\u4e09\u8282 \u7528\u673a\u5668\u5b66\u4e60\u5b9e\u73b0\u5f02\u5e38\u68c0\u6d4b","text":""},{"location":"chap16/3Xpack_ML/#1","title":"1\u3001\u5f02\u5e38\u68c0\u6d4b\u6240\u89e3\u51b3\u7684\u95ee\u9898","text":"<ul> <li>\u89e3\u51b3\u4e00\u4e9b\u57fa\u4e8e\u89c4\u5219\u6216\u8005 Dashboard \u96be\u4ee5\u5b9e\u65f6\u53d1\u73b0\u7684\u95ee\u9898</li> <li>IT\u8fd0\u7ef4<ul> <li>\u5982\u4f55\u77e5\u9053\u7cfb\u7edf\u6b63\u5e38\u8fd0\u884c</li> <li>\u5982\u4f55\u8c03\u8282\u9608\u503c\u89e6\u53d1\u5408\u9002\u7684\u62a5\u8b66</li> <li>\u5982\u4f55\u8fdb\u884c\u5f52\u56e0\u5206\u6790</li> </ul> </li> <li>\u4fe1\u606f\u5b89\u5168<ul> <li>\u54ea\u4e9b\u7528\u6237\u6784\u6210\u4e86\u5185\u90e8\u5a01\u80c1</li> <li>\u7cfb\u7edf\u662f\u5426\u611f\u67d3\u4e86\u75c5\u6bd2</li> </ul> </li> <li>\u7269\u8054\u7f51 / \u6570\u636e\u91c7\u96c6\u76d1\u63a7<ul> <li>\u5de5\u5382\u548c\u8bbe\u5907\u662f\u5426\u6b63\u5e38\u8fd0\u8425</li> </ul> </li> </ul>"},{"location":"chap16/3Xpack_ML/#2","title":"2\u3001\u4ec0\u4e48\u662f\u6b63\u5e38","text":"<ul> <li>\u968f\u7740\u65f6\u95f4\u7684\u63a8\u79fb\uff0c\u67d0\u4e2a\u4e2a\u4f53\u4e00\u76f4\u8868\u73b0\u51fa\u4e00\u81f4\u7684\u884c\u4e3a</li> <li>\u67d0\u4e2a\u4e2a\u4f53\u548c\u4ed6\u7684\u540c\u7c7b\u6bd4\u8f83\uff0c\u4e00\u76f4\u8868\u73b0\u51fa\u548c\u5176\u4ed6\u4e2a\u4f53\u4e00\u81f4\u7684\u884c\u4e3a</li> </ul>"},{"location":"chap16/3Xpack_ML/#3","title":"3\u3001\u4ec0\u4e48\u662f\u5f02\u5e38","text":"<ul> <li>\u548c\u81ea\u5df1\u6bd4 - \u4e2a\u4f53\u7684\u884c\u4e3a\u53d1\u751f\u4e86\u6025\u5267\u7684\u53d8\u5316</li> <li>\u548c\u4ed6\u4eba\u6bd4 - \u4e2a\u4f53\u660e\u663e\u533a\u522b\u4e8e\u5176\u4ed6\u7684\u4e2a\u4f53</li> </ul>"},{"location":"chap16/3Xpack_ML/#4","title":"4\u3001\u76f8\u5173\u672f\u8bed","text":"<ul> <li>Elastic \u5e73\u53f0\u7684\u673a\u5668\u5b66\u4e60\u529f\u80fd<ul> <li>Elastic \u7684ML\uff0c\u4e3b\u8981\u9488\u5bf9\u65f6\u5e8f\u6570\u636e\u7684\u5f02\u5e38\u68c0\u6d4b\u548c\u9884\u6d4b</li> </ul> </li> <li>\u975e\u76d1\u7763\u673a\u5668\u5b66\u4e60<ul> <li>\u4e0d\u9700\u8981\u4f7f\u7528\u4eba\u5de5\u6807\u7b7e\u7684\u6570\u636e\u6765\u5b66\u4e60\uff0c\u4ec5\u4ec5\u4f9d\u9760\u5386\u53f2\u6570\u636e\u81ea\u52a8\u5b66\u4e60</li> </ul> </li> <li>\u8d1d\u53f6\u65af\u7edf\u8ba1<ul> <li>\u4e00\u79cd\u6982\u7387\u8ba1\u7b97\u65b9\u6cd5\uff0c\u4f7f\u7528\u5148\u9a8c\u7ed3\u679c\u6765\u8ba1\u7b97\u73b0\u503c\u6216\u8005\u9884\u6d4b\u672a\u6765\u7684\u6570\u503c</li> </ul> </li> <li>\u5f02\u5e38\u68c0\u6d4b<ul> <li>\u5f02\u5e38\u4ee3\u8868\u7684\u662f\u4e0d\u540c\u7684\uff0c\u4f46\u672a\u5fc5\u4ee3\u8868\u7684\u662f\u574f\u7684 </li> <li>\u5b9a\u4e49\u5f02\u5e38\u9700\u8981\u4e00\u4e9b\u6307\u5bfc\uff0c\u4ece\u54ea\u4e2a\u65b9\u9762\u53bb\u770b</li> </ul> </li> </ul>"},{"location":"chap16/3Xpack_ML/#5","title":"5\u3001\u5982\u4f55\u5b66\u4e60\u201c\u6b63\u5e38\u201d","text":"<ul> <li>\u5bdf\u4e0d\u540c\u7684\u4eba\u6bcf\u5929\u8d70\u8def\u7684\u6b65\u6570\uff0c\u7531\u6b64\u9884\u6d4b\u660e\u5929\u4ed6\u4f1a\u8d70\u591a\u5c11\u6b65</li> <li>\u9700\u8981\u89c2\u5bdf\u4e0d\u540c\u7684\u4eba\uff0c\u9700\u8981\u89c2\u5bdf\u591a\u4e45?<ul> <li>\u4e00\u5929/\u4e00\u5468/\u4e00\u4e2a\u6708/\u4e00\u5e74/\u5341\u5e74</li> </ul> </li> <li>\u76f4\u89c9: \u89c2\u5bdf\u7684\u6570\u636e\u591a\uff0c\u4f60\u7684\u9884\u6d4b\u8d8a\u51c6\u786e</li> <li>\u4f7f\u7528\u8fd9\u4e9b\u89c2\u5bdf\u6765\u521b\u5efa\u4e00\u4e2a\u6a21\u578b<ul> <li>\u6982\u7387\u5206\u5e03\u51fd\u6570;\u4f7f\u7528\u8fd9\u4e2a\u6a21\u578b\u627e\u51fa\u4ec0\u4e48\u4e8b\u51e0\u4e4e\u4e0d\u53ef\u80fd\u7684\u4e8b\u4ef6</li> </ul> </li> </ul>"},{"location":"chap16/3Xpack_ML/#6","title":"6\u3001\u673a\u5668\u5b66\u4e60\u5e2e\u4f60\u81ea\u52a8\u6311\u9009\u6a21\u578b","text":"<ul> <li>\u4f7f\u7528\u6210\u719f\u7684\u673a\u5668\u5b66\u4e60\u6280\u672f\uff0c\u6311\u9009\u9002\u5408\u6570\u636e\u7684\u6b63\u786e\u7684\u7edf\u8ba1\u6a21\u578b</li> <li>\u66f4\u597d\u7684\u6a21\u578b = \u66f4\u597d\u7684\u5f02\u5e38\u68c0\u6d4b = \u66f4\u5c11\u7684\u8bef\u62a5\u548c\u6f0f\u62a5</li> <li>\u51fa\u73b0\u5728\u4f4e\u6982\u7387\u533a\u57df\uff0c\u53d1\u73b0\u5f02\u5e38 </li> </ul>"},{"location":"chap16/3Xpack_ML/#7","title":"7\u3001\u6a21\u578b\u4e0e\u9700\u8981\u8003\u8651\u4efb\u4f55\u7684\u5468\u671f","text":"<p>\u5468\u671f\u9009\u62e9 </p> <ul> <li>\u9700\u8981\u4e00\u5b9a\u5468\u671f\u7684\u5b66\u4e60\uff0c\u624d\u80fd\u4f7f\u7684\u7f6e\u4fe1\u533a\u95f4\u7684\u8303\u56f4\u66f4\u5c0f </li> <li>\u65f6\u95f4\u592a\u957f:\u5f71\u54cd\u56e0\u7d20\u592a\u591a\uff0c\u5bfc\u81f4\u968f\u673a\u5206\u5e03 </li> <li>\u65f6\u95f4\u592a\u77ed:\u5b8c\u5168\u662f\u968f\u673a\u6ce2\u52a8</li> </ul> <p></p>"},{"location":"chap16/3Xpack_ML/#8es-ml","title":"8\u3001ES ML:\u5355\u6307\u6807 / \u591a\u6307\u6807 / \u79cd\u7fa4\u5206\u6790","text":""},{"location":"chap16/3Xpack_ML/#9","title":"9\u3001\u5355\u6307\u6807\u4efb\u52a1","text":"<ul> <li>Create New Job</li> <li>\u9009\u62e9 Index Pattern\uff0c\u9009\u62e9 Fare quote</li> <li>\u9009\u62e9\u5355\u6307\u6807\u4efb\u52a1<ul> <li>Aggregation </li> <li>Field</li> <li>Bucket Span (\u53d6\u51b3\u4e8e\u7528\u6237\u7684\u6570\u636e\u4e1a\u52a1 / \u6570\u636e\u7684\u91c7\u6837\u65f6\u95f4 / \u6ce2\u52a8\u60c5\u51b5 / \u9700\u8981\u9884\u6d4b\u7684\u9891\u7387)</li> <li>Use full data</li> </ul> </li> </ul>"},{"location":"chap16/3Xpack_ML/#10-demo","title":"10\u3001\u5f02\u5e38\u68c0\u6d4b\u4e0a Demo","text":""},{"location":"chap16/3Xpack_ML/#10-1-upload-server_metrics-data","title":"10-1 Upload  server_metrics data","text":"<pre><code>mkdir server_metrics \ncd server_metrics\nwget https://download.elasticsearch.org/demos/machine_learning/gettingstarted/server_metrics.tar.gz\ntar -xvf server_metrics.tar.gz\n\ncd files\n\nchmod +x upload_server_metrics_noauth.sh\n./upload_server_metrics_noauth.sh\n</code></pre> <pre><code>./upload_server_metrics_noauth.sh\n\n== Script for creating index and uploading data == \n\n\n== Deleting old index == \n\n{\"error\":{\"root_cause\":[{\"type\":\"index_not_found_exception\",\"reason\":\"no such index [server-metrics]\",\"index_uuid\":\"_na_\",\"resource.type\":\"index_or_alias\",\"resource.id\":\"server-metrics\",\"index\":\"server-metrics\"}],\"type\":\"index_not_found_exception\",\"reason\":\"no such index [server-metrics]\",\"index_uuid\":\"_na_\",\"resource.type\":\"index_or_alias\",\"resource.id\":\"server-metrics\",\"index\":\"server-metrics\"},\"status\":404}\n== Creating Index - server-metrics == \n\n{\"error\":{\"root_cause\":[{\"type\":\"mapper_parsing_exception\",\"reason\":\"Root mapping definition has unsupported parameters:  [metric : {properties={deny={type=long}, total={type=long}, @timestamp={type=date}, response={type=float}, service={type=keyword}, host={type=keyword}, accept={type=long}}}]\"}],\"type\":\"mapper_parsing_exception\",\"reason\":\"Failed to parse mapping [_doc]: Root mapping definition has unsupported parameters:  [metric : {properties={deny={type=long}, total={type=long}, @timestamp={type=date}, response={type=float}, service={type=keyword}, host={type=keyword}, accept={type=long}}}]\",\"caused_by\":{\"type\":\"mapper_parsing_exception\",\"reason\":\"Root mapping definition has unsupported parameters:  [metric : {properties={deny={type=long}, total={type=long}, @timestamp={type=date}, response={type=float}, service={type=keyword}, host={type=keyword}, accept={type=long}}}]\"}},\"status\":400}\n== Bulk uploading data to index... \n\nServer-metrics_1 uploaded\nServer-metrics_2 uploaded\nServer-metrics_3 uploaded\nServer-metrics_4 uploaded\nServer-metrics_5 uploaded\nServer-metrics_6 uploaded\nServer-metrics_7 uploaded\nServer-metrics_8 uploaded\nServer-metrics_9 uploaded\nServer-metrics_10 uploaded\nServer-metrics_11 uploaded\nServer-metrics_12 uploaded\nServer-metrics_13 uploaded\nServer-metrics_14 uploaded\nServer-metrics_15 uploaded\nServer-metrics_16 uploaded\nServer-metrics_17 uploaded\nServer-metrics_18 uploaded\nServer-metrics_19 uploaded\nServer-metrics_20 uploaded\n done - output to /dev/null\n\n== Check upload \nhealth status index          uuid                   pri rep docs.count docs.deleted store.size pri.store.size\ngreen  open   server-metrics EQcyn1KcRI-_ZLCAUAebxA   1   1     860643            0    145.5mb         82.9mb\n\n Server-metrics uploaded\n</code></pre>"},{"location":"chap16/3Xpack_ML/#10-2-create-index-pattern","title":"10-2 Create Index Pattern","text":"<p>Stack Management -&gt; Index Patterns</p> <pre><code>http://192.168.33.12:9200/_cat/indices\ngreen open server-metrics                      EQcyn1KcRI-_ZLCAUAebxA 1 1 905940      0 149.9mb  75.1mb\n</code></pre> <p>server-metrics</p> <p></p> <p></p> <p></p> <p>Stack Management -&gt; License Management -&gt; Start trial</p> <p></p> <p></p>"},{"location":"chap16/3Xpack_ML/#10-3-create-job-anomaly-detection","title":"10-3 Create job Anomaly Detection","text":"<p>1\u3001Ceate Single Metrics job</p> <p></p> <p>2\u3001Ceate job</p> <ul> <li>Tim Range: Click Use full server-metrics data</li> </ul> <p></p> <ul> <li>Pick fields:<ul> <li>Sum total</li> <li>Bucket span: 15m</li> </ul> </li> </ul> <p></p> <ul> <li>Job details:<ul> <li>single-metrics-demo</li> </ul> </li> </ul> <p></p> <ul> <li>Summary</li> </ul> <p></p> <ul> <li>View anomalies in different time span</li> </ul> <p></p> <ul> <li>Run the 2d forcasting</li> </ul> <p></p> <ul> <li>Created detection jobs: single-metrics-demo</li> </ul> <p></p> <ul> <li>Add Custom URLS for single-metrics-demo<ul> <li>Label:  single-anomly</li> </ul> </li> </ul> <p></p> <p></p> <ul> <li>Check actions:  single-anomly</li> </ul> <p></p> <p></p> <ul> <li>Sum total &lt; 0</li> </ul> <p></p> <ul> <li>Add total: <code>total gte 0</code> and saved as index </li> </ul> <p></p>"},{"location":"chap16/3Xpack_ML/#10-3-create-another-job-anomaly-detection-job-with-gte-0-index","title":"10-3 Create another job Anomaly Detection job with gte 0 index","text":"<ul> <li>Job details:<ul> <li>enhanced-demo-metrics</li> </ul> </li> </ul> <ul> <li>Created detection jobs: enhanced-demo-metrics</li> </ul>"},{"location":"chap16/3Xpack_ML/#11multi-metrics","title":"11\u3001Multi Metrics \u591a\u6307\u6807\u68c0\u6d4b","text":""},{"location":"chap16/3Xpack_ML/#11-1","title":"11-1 \u591a\u6307\u6807\u68c0\u6d4b","text":"<ul> <li>\u591a\u4e2a\u6307\u6807</li> <li>\u6309\u7167\u67d0\u4e2a\u5b57\u6bb5\u8fdb\u884c\u5206\u7c7b</li> <li>\u4ec0\u4e48\u662f\u5f71\u54cd\u56e0\u5b50<ul> <li>\u5f71\u54cd\u56e0\u5b50\u662f\u4e00\u4e2a\u5b57\u6bb5</li> <li>\u8fd9\u4e2a\u5b57\u6bb5\u4ece\u903b\u8f91\u5206\u6790\u4e0a\u770b\uff0c\u662f\u53ef\u80fd\u9020\u6210\u5f02\u5e38\u7684\u539f\u56e0</li> <li>\u4e0d\u4e00\u5b9a\u5fc5\u987b\u662f\u4e00\u4e2a\u68c0\u6d4b\u5668\uff0c\u4f46\u662f\u8fd9\u4e2a\u5b57\u6bb5\u901a\u5e38\u80fd\u591f\u88ab\u7528\u4e8e\u533a\u5206\u6570\u636e</li> <li>\u5bf9\u5f71\u54cd\u56e0\u5b50\u4e5f\u53ef\u4ee5\u6253\u5206\uff0c\u6253\u5206\u662f\u57fa\u4e8e\u5176\u591a\u5927\u7a0b\u5ea6\u4f1a\u5f71\u54cd\u5230\u5f02\u5e38</li> </ul> </li> </ul>"},{"location":"chap16/3Xpack_ML/#11-2-create-job-multi-metric","title":"11-2 Create job: multi-metric","text":"<ul> <li>Pick fields:<ul> <li>Mean (accpet)</li> <li>Mean (deny)</li> <li>Mean (repsonse)</li> </ul> </li> <li>Split field: <code>service.keword</code></li> <li>Bukcet span: 15m</li> </ul> <p>job id: multi-metrics-job</p> <p></p> <p></p> <p>Run the job</p> <p></p> <p>Check the anomaly</p> <p></p> <p></p>"},{"location":"chap16/3Xpack_ML/#12","title":"12\u3001\u79cd\u7fa4\u5206\u6790","text":""},{"location":"chap16/3Xpack_ML/#12-1","title":"12-1 \u79cd\u7fa4\u5206\u6790","text":"<ul> <li>\u5982\u4f55\u5206\u6790<ul> <li>\u79cd\u7fa4\u4e4b\u95f4\u6bd4\u8f83</li> <li>\u4e0d\u548c\u81ea\u5df1\u7684\u8fc7\u53bb\u6bd4\u8f83</li> </ul> </li> <li>\u9002\u7528\u60c5\u666f<ul> <li>\u4e2a\u4f53\u5177\u5907\u9ad8 Cardinality</li> <li>\u5c11\u6570\u4e2a\u4f53\u4ece\u65f6\u95f4\u4e0a\u662f\u7a00\u758f\u7684</li> <li>\u4f5c\u4e3a\u6574\u4f53\u770b\uff0c\u7fa4\u4f53\u884c\u4e3a\u662f\u5747\u5300\u7684</li> </ul> </li> <li>\u4e0d\u9002\u7528\u7684\u573a\u666f<ul> <li>\u4e2a\u4f53\u7684\u884c\u4e3a\u5404\u81ea\u90fd\u4e0d\u76f8\u540c</li> </ul> </li> </ul>"},{"location":"chap16/3Xpack_ML/#12-2-create-pattern-index-user-activity","title":"12-2 Create pattern index: <code>user-activity</code>","text":"<pre><code>DELETE user-activty\nPUT _bulk\n{\"index\": {\"_index\": \"user-activity\", \"_type\": \"_doc\", \"_id\": \"AVvhFsqUD6JSRXpujonE\"}}\n{\"username\": \"Frederica\", \"@timestamp\": \"2017-04-16T21:06:58.963073\", \"bytesSent\": 313}\n....\n</code></pre> <p>user-activity.json</p> <p><code>user-activity</code></p> <p></p> <p></p> <p></p> <ul> <li>@timestamp</li> <li><code>_id</code></li> <li><code>_index</code></li> <li><code>_score</code></li> <li><code>_type</code></li> <li><code>bytesSent</code></li> <li><code>username</code></li> </ul>"},{"location":"chap16/3Xpack_ML/#12-3-create-job-population-for-user-activiy","title":"12-3 Create Job Population for <code>user-activiy</code>","text":"<ul> <li>Population field: username.keyword</li> <li>Add metrics: Mean (bytesSent)</li> <li>Bucket span: 15m</li> <li><code>mean(bytesSent) over \"username.keyword\"</code></li> <li>Job ID: population</li> </ul> <p>Run Job</p> <p></p> <p>Check who(username.keyword) bytesSent casue most severity</p> <p>Zoraida</p> <p></p> <p>Check anomalies</p> <p></p>"},{"location":"chap16/3Xpack_ML/#13calenders","title":"13\u3001Calenders","text":"<p>Calendars contain a list of scheduled events for which you do not want to generate anomalies, such as planned system outages or public holidays.</p> <p>settings -&gt; Calenders</p> <ul> <li>national-day</li> </ul> <p></p> <p></p>"},{"location":"chap16/4ELK_Filebeat/","title":"\u7b2c\u56db\u8282 \u7528 Elastic Stack \u8fdb\u884c\u65e5\u5fd7\u7ba1\u7406","text":""},{"location":"chap16/4ELK_Filebeat/#1","title":"1\u3001\u65e5\u5fd7\u7684\u91cd\u8981\u6027","text":"<ul> <li>\u4e3a\u4ec0\u4e48\u91cd\u8981<ul> <li>\u8fd0\u7ef4:\u533b\u751f\u7ed9\u75c5\u4eba\u770b\u75c5\u3002\u65e5\u5fd7\u5c31\u662f\u75c5\u4eba\u5bf9\u81ea\u5df1\u7684\u9648\u8ff0</li> <li>\u6076\u610f\u653b\u51fb\uff0c\u6076\u610f\u6ce8\u518c\uff0c\u5237\u5355\uff0c\u6076\u610f\u5bc6\u7801\u731c\u6d4b</li> </ul> </li> <li>\u6311\u6218<ul> <li>\u5173\u6ce8\u70b9\u5f88\u591a\uff0c\u4efb\u4f55\u4e00\u4e2a\u70b9\u90fd\u6709\u53ef\u80fd\u5f15\u8d77\u95ee\u9898</li> <li>\u65e5\u5fd7\u5206\u6563\u5728\u5f88\u591a\u673a\u5668\uff0c\u51fa\u4e86\u95ee\u9898\u65f6\uff0c\u624d\u53d1\u73b0\u65e5\u5fd7\u88ab\u5220\u4e86</li> <li>\u5f88\u591a\u8fd0\u7ef4\u4eba\u5458\u662f\u6d88\u9632\u5458\uff0c\u54ea\u91cc\u6709\u95ee\u9898\u53bb\u54ea\u91cc</li> </ul> </li> </ul>"},{"location":"chap16/4ELK_Filebeat/#2","title":"2\u3001\u96c6\u4e2d\u5316\u65e5\u5fd7\u7ba1\u7406","text":""},{"location":"chap16/4ELK_Filebeat/#3filebeat","title":"3\u3001Filebeat \u7b80\u4ecb","text":""},{"location":"chap16/4ELK_Filebeat/#3-1","title":"3-1 \u7b80\u4ecb","text":"<ul> <li>A log data shipper for local files</li> <li>\u8bfb\u53d6\u65e5\u5fd7\u6587\u4ef6\uff0cFilebeat \u4e0d\u505a\u6570\u636e\u7684\u89e3\u6790\uff0c\u52a0\u5de5\u5904\u7406<ul> <li>\u65e5\u5fd7\u662f\u975e\u7ed3\u6784\u5316\u6570\u636e</li> <li>\u9700\u8981\u8fdb\u884c\u5904\u7406\u540e\uff0c\u4ee5\u7ed3\u6784\u5316\u7684\u65b9\u5f0f\u4fdd\u5b58\u5230 Elasticsearch</li> </ul> </li> <li>\u4fdd\u8bc1\u6570\u636e\u81f3\u5c11\u88ab\u8bfb\u53d6\u4e00\u6b21</li> <li>\u5904\u7406\u591a\u884c\u6570\u636e\uff0c\u89e3\u6790 JSON \u683c\u5f0f \uff0c\u7b80\u5355\u7684\u8fc7\u6ee4</li> </ul>"},{"location":"chap16/4ELK_Filebeat/#4filebeat","title":"4\u3001Filebeat \u6267\u884c\u6d41\u7a0b","text":"<ul> <li>\u5b9a\u4e49\u6570\u636e\u91c7\u96c6: <code>Prospector</code> \u914d\u7f6e\u3002\u901a\u8fc7 <code>filebeat.yml</code></li> <li>\u5efa\u7acb\u6570\u636e\u6a21\u578b: <code>Index Template</code></li> <li>\u5efa\u7acb\u6570\u636e\u5904\u7406\u6d41\u7a0b: <code>Ingest Pipeline</code></li> <li>\u5b58\u50a8\u5e76\u63d0\u4f9b\u53ef\u89c6\u5316\u5206\u6790:ES + Kibana Dashboard</li> </ul>"},{"location":"chap16/4ELK_Filebeat/#5modules","title":"5\u3001Modules \u5f00\u7bb1\u5373\u7528","text":""},{"location":"chap16/4ELK_Filebeat/#5-1","title":"5-1 \u5927\u91cf\u5f00\u7bb1\u5373\u7528\u7684\u65e5\u5fd7\u6a21\u5757","text":"<ul> <li>\u7b80\u5316\u4f7f\u7528\u6d41\u7a0b</li> <li>\u51cf\u5c11\u5f00\u53d1\u7684\u6295\u5165</li> <li>\u6700\u4f73\u53c2\u8003\u5b9e\u8df5</li> </ul>"},{"location":"chap16/4ELK_Filebeat/#5-2","title":"5-2 \u4e00\u4e9b\u547d\u4ee4","text":"<ul> <li><code>./filebeat modules list</code></li> <li><code>./filebeat modules enable nginx</code></li> </ul>"},{"location":"chap16/4ELK_Filebeat/#6demo","title":"6\u3001Demo","text":"<ul> <li><code>filebeat modules list</code></li> <li><code>filebeat modules enable system</code></li> <li>Module \u548c module.d \u76ee\u5f55</li> <li><code>filebeat export template</code></li> <li><code>filebeat setup --dashboards</code></li> <li><code>./filebeat -e</code></li> </ul>"},{"location":"chap16/4ELK_Filebeat/#install-option-1","title":"install Option 1","text":"<pre><code>sudo rpm --import https://packages.elastic.co/GPG-KEY-elasticsearch\n</code></pre> <pre><code>[elastic-7.x]\nname=Elastic repository for 7.x packages\nbaseurl=https://artifacts.elastic.co/packages/7.x/yum\ngpgcheck=1\ngpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch\nenabled=1\nautorefresh=1\ntype=rpm-md\n</code></pre> <pre><code>sudo yum install filebeat\n\nsudo systemctl enable filebeat\n\nsudo systemctl start filebeat\n\n$ sudo systemctl status filebeat\n\u25cf filebeat.service - Filebeat sends log files to Logstash or directly to Elasticsearch.\n   Loaded: loaded (/usr/lib/systemd/system/filebeat.service; enabled; vendor preset: disabled)\n   Active: active (running) since Tue 2020-12-22 14:18:27 UTC; 23s ago\n     Docs: https://www.elastic.co/products/beats/filebeat\n Main PID: 135013 (filebeat)\n    Tasks: 6\n   Memory: 83.2M\n   CGroup: /system.slice/filebeat.service\n           \u2514\u2500135013 /usr/share/filebeat/bin/filebeat --environment systemd -c /etc/filebeat/filebeat.yml --path.home /usr/share/filebeat --path.confi...\n\nDec 22 14:18:28 elasticsearch7 filebeat[135013]: 2020-12-22T14:18:28.043Z        INFO        instance/beat.go:455        filebeat start running.\nDec 22 14:18:28 elasticsearch7 filebeat[135013]: 2020-12-22T14:18:28.055Z        INFO        [monitoring]        log/log.go:118        Starti...very 30s\nDec 22 14:18:28 elasticsearch7 filebeat[135013]: 2020-12-22T14:18:28.058Z        INFO        memlog/store.go:119        Loading data file of ...ion id=0\nDec 22 14:18:28 elasticsearch7 filebeat[135013]: 2020-12-22T14:18:28.058Z        INFO        memlog/store.go:124        Finished loading tran...ion id=0\nDec 22 14:18:28 elasticsearch7 filebeat[135013]: 2020-12-22T14:18:28.058Z        INFO        [registrar]        registrar/registrar.go:109   ...strar: 0\nDec 22 14:18:28 elasticsearch7 filebeat[135013]: 2020-12-22T14:18:28.058Z        INFO        [crawler]        beater/crawler.go:71        Loa...nputs: 2\nDec 22 14:18:28 elasticsearch7 filebeat[135013]: 2020-12-22T14:18:28.058Z        INFO        [crawler]        beater/crawler.go:108        Lo...nputs: 0\nDec 22 14:18:28 elasticsearch7 filebeat[135013]: 2020-12-22T14:18:28.059Z        INFO        cfgfile/reload.go:164        Config reloader started\nDec 22 14:18:28 elasticsearch7 filebeat[135013]: 2020-12-22T14:18:28.059Z        INFO        cfgfile/reload.go:224        Loading of config f...mpleted.\nDec 22 14:18:30 elasticsearch7 filebeat[135013]: 2020-12-22T14:18:30.971Z        INFO        [add_cloud_metadata]        add_cloud_metadata/a...etected.\nHint: Some lines were ellipsized, use -l to show in full.\n</code></pre> <pre><code>cd /usr/share/filebeat\n$ ls -al\ntotal 8400\ndrwxr-xr-x   5 root root     122 Dec 22 14:17 .\ndrwxr-xr-x. 80 root root    4096 Dec 22 14:17 ..\ndrwxr-xr-x   2 root root      42 Dec 22 14:17 bin\n-rw-r--r--   1 root root      41 Dec  4 23:31 .build_hash.txt\ndrwxr-xr-x   3 root root      15 Dec 22 14:17 kibana\n-rw-r--r--   1 root root   13675 Dec  4 22:14 LICENSE.txt\ndrwxr-xr-x  66 root root    4096 Dec 22 14:17 module\n-rw-r--r--   1 root root 8566190 Dec  4 22:16 NOTICE.txt\n-rw-r--r--   1 root root     814 Dec  4 23:31 README.md\n</code></pre> <pre><code>sudo filebeat modules enable system\nsudo filebeat modules enable elasticsearch\nsudo filebeat modules enable nginx\n\n\n$ sudo filebeat modules list\nEnabled:\nelasticsearch\nnginx\nsystem\n</code></pre> <pre><code>cd usr/share/filebeat/module\n</code></pre> <pre><code>sudo filebeat setup \u2013dashboards\n</code></pre>"},{"location":"chap16/4ELK_Filebeat/#install-option-2-my-operation-way","title":"install Option 2 (My Operation Way)","text":"<pre><code>curl -L -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.9.1-linux-x86_64.tar.gz\n\n\ntar xzvf filebeat-7.9.1-linux-x86_64.tar.gz\n</code></pre> <pre><code>./filebeat modules list\n./filebeat modules enable system\n./filebeat modules enable elasticsearch\n./filebeat modules enable nginx\n\n$ ./filebeat setup \u2013dashboards\nOverwriting ILM policy is disabled. Set `setup.ilm.overwrite: true` for enabling.\n\nIndex setup finished.\nLoading dashboards (Kibana must be running and reachable)\nLoaded dashboards\nSetting up ML using setup --machine-learning is going to be removed in 8.0.0. Please use the ML app instead.\nSee more: https://www.elastic.co/guide/en/machine-learning/current/index.html\nLoaded machine learning job configurations\nLoaded Ingest pipelines\n</code></pre> <pre><code>$ cd modules.d\n$ ls\nactivemq.yml.disabled    coredns.yml.disabled      ibmmq.yml.disabled     microsoft.yml.disabled  okta.yml.disabled        squid.yml.disabled\napache.yml.disabled      crowdstrike.yml.disabled  icinga.yml.disabled    misp.yml.disabled       osquery.yml.disabled     suricata.yml.disabled\nauditd.yml.disabled      cylance.yml.disabled      iis.yml.disabled       mongodb.yml.disabled    panw.yml.disabled        system.yml\n...\n</code></pre> <pre><code>cat system.yml\n\n$ cat system.yml\n# Module: system\n# Docs: https://www.elastic.co/guide/en/beats/filebeat/7.9/filebeat-module-system.html\n\n- module: system\n  # Syslog\n  syslog:\n    enabled: true\n\n    # Set custom paths for the log files. If left empty,\n    # Filebeat will choose the paths depending on your OS.\n    #var.paths:\n\n  # Authorization logs\n  auth:\n    enabled: true\n\n    # Set custom paths for the log files. If left empty,\n    # Filebeat will choose the paths depending on your OS.\n    #var.paths:\n</code></pre> <pre><code>cd /module/system/auth/ingest\n$ cat pipeline.yml\ndescription: Pipeline for parsing system authorisation/secure logs\nprocessors:\n- grok:\n    field: message\n    ignore_missing: true\n    pattern_definitions:\n      GREEDYMULTILINE: |-\n        (.|\n        )*\n      TIMESTAMP: (?:%{TIMESTAMP_ISO8601}|%{SYSLOGTIMESTAMP})\n    patterns:\n    - '%{TIMESTAMP:system.auth.timestamp} %{SYSLOGHOST:host.hostname} %{DATA:process.name}(?:\\[%{POSINT:process.pid:long}\\])?:\n      %{DATA:system.auth.ssh.event} %{DATA:system.auth.ssh.method} for (invalid user\n      )?%{DATA:user.name} from %{IPORHOST:source.ip} port %{NUMBER:source.port:long}\n      ssh2(: %{GREEDYDATA:system.auth.ssh.signature})?'\n    - '%{TIMESTAMP:system.auth.timestamp} %{SYSLOGHOST:host.hostname} %{DATA:process.name}(?:\\[%{POSINT:process.pid:long}\\])?:\n      %{DATA:system.auth.ssh.event} user %{DATA:user.name} from %{IPORHOST:source.ip}'\n    - '%{TIMESTAMP:system.auth.timestamp} %{SYSLOGHOST:host.hostname} %{DATA:process.name}(?:\\[%{POSINT:process.pid:long}\\])?:\n      Did not receive identification string from %{IPORHOST:system.auth.ssh.dropped_ip}'\n    - '%{TIMESTAMP:system.auth.timestamp} %{SYSLOGHOST:host.hostname} %{DATA:process.name}(?:\\[%{POSINT:process.pid:long}\\])?:\n      \\s*%{DATA:user.name} :( %{DATA:system.auth.sudo.error} ;)? TTY=%{DATA:system.auth.sudo.tty}\n      ; PWD=%{DATA:system.auth.sudo.pwd} ; USER=%{DATA:system.auth.sudo.user} ; COMMAND=%{GREEDYDATA:system.auth.sudo.command}'\n    - '%{TIMESTAMP:system.auth.timestamp} %{SYSLOGHOST:host.hostname} %{DATA:process.name}(?:\\[%{POSINT:process.pid:long}\\])?:\n      new group: name=%{DATA:group.name}, GID=%{NUMBER:group.id}'\n    - '%{TIMESTAMP:system.auth.timestamp} %{SYSLOGHOST:host.hostname} %{DATA:process.name}(?:\\[%{POSINT:process.pid:long}\\])?:\n      new user: name=%{DATA:user.name}, UID=%{NUMBER:user.id}, GID=%{NUMBER:group.id},\n      home=%{DATA:system.auth.useradd.home}, shell=%{DATA:system.auth.useradd.shell}$'\n    - '%{TIMESTAMP:system.auth.timestamp} %{SYSLOGHOST:host.hostname}? %{DATA:process.name}(?:\\[%{POSINT:process.pid:long}\\])?:\n      %{GREEDYMULTILINE:system.auth.message}'\n- remove:\n    field: message\n- rename:\n    field: system.auth.message\n    target_field: message\n    ignore_missing: true\n- set:\n    field: source.ip\n    value: '{{system.auth.ssh.dropped_ip}}'\n    ignore_empty_value: true\n- date:\n    if: ctx.event.timezone == null\n    field: system.auth.timestamp\n    target_field: '@timestamp'\n...\n</code></pre> <pre><code>cd /var/log\nsudo chown vagrant:vagrant secure*\nsudo chown vagrant:vagrant messages*\n\n./filebeat -e\n</code></pre>"},{"location":"chap16/5xpack_canvas/","title":"\u7b2c\u4e94\u8282 \u7528 Canvas \u8fdb\u884c\u6570\u636e\u7684\u5b9e\u65f6\u5c55\u793a","text":""},{"location":"chap16/5xpack_canvas/#1","title":"1\u3001\u5b9e\u65f6\u5c55\u793a\u6570\u636e\uff0c\u5e76\u4e14\u8fbe\u5230\u5b8c\u7f8e\u50cf\u7d20\u7ea7\u8981\u6c42","text":"<ul> <li>\u7528\u66f4\u52a0\u9177\u70ab\u7684\u65b9\u5f0f\uff0c\u6f14\u7ece\u4f60\u7684\u6570\u636e   <ul> <li>\u57fa\u4e8e ES \u5b9e\u73b0\u51c6\u5b9e\u65f6\u7684\u6570\u636e\u5206\u6790</li> </ul> </li> <li>\u66f4\u597d\u7684\u60f3\u6cd5\uff0c\u66f4\u5927\u7684\u5c4f\u5e55<ul> <li>\u54c1\u724c\u5ba3\u4f20\uff0c\u4f1a\u8bae\u5927\u5c4f</li> </ul> </li> <li>\u9ad8\u5ea6\u5b9a\u5236\u5316<ul> <li>\u8c03\u8272\u677f/CSS/\u62d6\u653e\u5143\u7d20</li> </ul> </li> </ul>"},{"location":"chap16/5xpack_canvas/#2","title":"2\u3001\u4e2a\u6027\u5316\u65b9\u5f0f\u5c55\u73b0\u4f60\u7684\u6570\u636e","text":"<ul> <li>\u516c\u53f8\u7684 Logo</li> <li>\u7b26\u5408\u516c\u53f8\u7684\u914d\u8272\u65b9\u6848\u4ee5\u53ca\u8bbe\u8ba1\u5143\u7d20 </li> <li>Kibana \u4e2d\u514d\u8d39\u63d0\u4f9b</li> </ul>"},{"location":"chap16/5xpack_canvas/#2-1","title":"2-1\u3001\u65e5\u5fd7\u5206\u6790","text":""},{"location":"chap16/5xpack_canvas/#2-2","title":"2-2\u3001\u57fa\u7840\u8bbe\u65bd\u76d1\u63a7","text":""},{"location":"chap16/5xpack_canvas/#2-3apm","title":"2-3\u3001APM","text":""},{"location":"chap16/5xpack_canvas/#2-4","title":"2-4\u3001\u5b89\u5168\u8fd0\u7ef4","text":""},{"location":"chap16/5xpack_canvas/#2-5","title":"2-5\u3001\u4e1a\u52a1\u5206\u6790","text":"<p>[eCommerce] Revenue Tracking</p> <p></p> <p></p> <p></p> <p>[Flights] Overview</p> <p></p> <p>[Logs] Web Traffic</p> <p></p>"},{"location":"chap16/5xpack_canvas/#3demo","title":"3\u3001DEMO","text":"<p><code>elasticcoffee-data.bulk</code></p> <pre><code>POST _bulk\n{ \"index\" : { \"_index\" : \"elasticoffee\",   \"_id\" : \"1\" } }\n{\"sceneID\": \"2\", \"sceneData\": \"0\", \"entityID\": \"zwave.quad2\", \"quadId\": 2, \"quadMod\": \"1\", \"@timestamp\": \"2018-02-27T22:26:39Z\", \"beverageClass\": \"Hot Beverages\", \"beverage\": \"Latte\", \"beverageSide\": \"left\", \"beverageIndex\": 5, \"quantity\": 1}\n...\n</code></pre> <pre><code>POST elasticoffee/_search \n{ \"size\": 0, \n  \"aggs\": { \n    \"by\": { \n      \"terms\": { \n        \"field\": \"beverage.keyword\", \n        \"size\": 10 \n        } \n      } \n  } \n}\n</code></pre> <p>Output:</p> <pre><code>{\n  \"took\" : 127,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 1,\n    \"successful\" : 1,\n    \"skipped\" : 0,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : {\n      \"value\" : 1368,\n      \"relation\" : \"eq\"\n    },\n    \"max_score\" : null,\n    \"hits\" : [ ]\n  },\n  \"aggregations\" : {\n    \"by\" : {\n      \"doc_count_error_upper_bound\" : 0,\n      \"sum_other_doc_count\" : 0,\n      \"buckets\" : [\n        {\n          \"key\" : \"Latte\",\n          \"doc_count\" : 322\n        },\n        {\n          \"key\" : \"Other\",\n          \"doc_count\" : 253\n        },\n        {\n          \"key\" : \"Cappuccino\",\n          \"doc_count\" : 238\n        },\n        {\n          \"key\" : \"Mocha\",\n          \"doc_count\" : 176\n        },\n        {\n          \"key\" : \"Espresso\",\n          \"doc_count\" : 175\n        },\n        {\n          \"key\" : \"Macchiato\",\n          \"doc_count\" : 85\n        },\n        {\n          \"key\" : \"Americano\",\n          \"doc_count\" : 61\n        },\n        {\n          \"key\" : \"Coffee\",\n          \"doc_count\" : 58\n        }\n      ]\n    }\n  }\n}\n</code></pre> <p>Import workpad JSON file for CANVAS dashboard</p> <p><code>canvas-workpad-CafeCanvas.json</code></p> <p></p>"},{"location":"chap17/1ES_WS_movie/","title":"\u7b2c\u4e00\u8282  \u7535\u5f71\u641c\u7d22\u670d\u52a1","text":""},{"location":"chap17/1ES_WS_movie/#1","title":"1\u3001\u9700\u6c42\u5206\u6790\u53ca\u67b6\u6784\u8bbe\u8ba1","text":""},{"location":"chap17/1ES_WS_movie/#1-1","title":"1-1 \u9700\u6c42\u5206\u6790","text":"<ul> <li>IMDB:Movie DB<ul> <li>\u641c\u7d22\u6846\uff0c\u652f\u6301\u8f93\u5165\u63d0\u793a</li> <li>\u8fc7\u6ee4\u5668\u8fc7\u6ee4\u7ed3\u679c\uff0c\u652f\u6301\u6392\u5e8f</li> <li>\u641c\u7d22\u7ed3\u679c\u7684\u76f8\u5173\u6027\u6392\u5e8f</li> </ul> </li> </ul>"},{"location":"chap17/1ES_WS_movie/#1-2","title":"1-2 \u641c\u7d20\u7c7b\u5e94\u7528\u524d\u7aef\u901a\u7528\u5e03\u5c40","text":""},{"location":"chap17/1ES_WS_movie/#1-3","title":"1-3 \u540e\u7aef\u901a\u7528\u9700\u6c42","text":""},{"location":"chap17/1ES_WS_movie/#1-4-ui","title":"1-4 \u540e\u7aef UI","text":"<ul> <li>\u81ea\u5b9a\u4e49\u540c\u4e49\u8bcd(Matrix = \u9ed1\u5ba2\u5e1d\u56fd = \u77e9\u9635\u9769\u547d)</li> <li>\u83b7\u53d6\u7528\u6237\u641c\u7d22\u7edf\u8ba1\u6570\u636e</li> <li>\u8c03\u6574\u5b57\u6bb5\u7684\u76f8\u5173\u6027\u6743\u91cd</li> </ul>"},{"location":"chap17/1ES_WS_movie/#1-5-elastic-app-search","title":"1-5 Elastic App Search \u4ecb\u7ecd","text":"<p>https://www.elastic.co/app-search/</p> <p></p>"},{"location":"chap17/1ES_WS_movie/#1-6","title":"1-6 \u67b6\u6784","text":""},{"location":"chap17/1ES_WS_movie/#1-7-demo","title":"1-7 \u5b89\u88c5\u4e0e\u914d\u7f6e Demo","text":"<p>DEMO \u4e2d\uff0c\u4f7f\u7528 AppSearch 7.3.1 \u548c Elasticsearch 7.3.1</p> <p>Elasticsearch 7.3.1 - <code>docker-compose</code></p> <p><code>docker-compose.yaml</code></p> <pre><code>version: '2.2'\nservices:\n  cerebro:\n    image: lmenezes/cerebro:0.8.3\n    container_name: apps_cerebro\n    ports:\n      - \"9000:9000\"\n    command:\n      - -Dhosts.0.host=http://elasticsearch:9200\n    networks:\n      - hw_hwc_es7net\n  kibana:\n    image: docker.elastic.co/kibana/kibana:7.9.1\n    container_name: apps_kibana7\n    environment:\n      #- I18N_LOCALE=zh-CN\n      - XPACK_GRAPH_ENABLED=true\n      - TIMELION_ENABLED=true\n      - XPACK_MONITORING_COLLECTION_ENABLED=\"true\"\n    ports:\n      - \"5601:5601\"\n    networks:\n      - hw_hwc_es7net\n  elasticsearch:\n    image: docker.elastic.co/elasticsearch/elasticsearch:7.3.1\n    container_name: apps_hot\n    environment:\n      - cluster.name=apps-imdb\n      - node.name=apps_hot\n      - node.attr.box_type=hot\n      - bootstrap.memory_lock=true\n      - \"ES_JAVA_OPTS=-Xms512m -Xmx512m\"\n      - discovery.seed_hosts=apps_hot,apps_warm,apps_cold\n      - cluster.initial_master_nodes=apps_hot,apps_warm,apps_cold\n    ulimits:\n      memlock:\n        soft: -1\n        hard: -1\n    volumes:\n      - hwc_es7data_hot:/usr/share/elasticsearch/data\n    ports:\n      - 9200:9200\n    networks:\n      - hw_hwc_es7net\n  elasticsearch2:\n    image: docker.elastic.co/elasticsearch/elasticsearch:7.3.1\n    container_name: apps_warm\n    environment:\n      - cluster.name=apps-imdb\n      - node.name=apps_warm\n      - node.attr.box_type=warm\n      - bootstrap.memory_lock=true\n      - \"ES_JAVA_OPTS=-Xms512m -Xmx512m\"\n      - discovery.seed_hosts=apps_hot,apps_warm,apps_cold\n      - cluster.initial_master_nodes=apps_hot,apps_warm,apps_cold\n    ulimits:\n      memlock:\n        soft: -1\n        hard: -1\n    volumes:\n      - hwc_es7data_warm:/usr/share/elasticsearch/data\n    networks:\n      - hw_hwc_es7net\n  elasticsearch3:\n    image: docker.elastic.co/elasticsearch/elasticsearch:7.3.1\n    container_name: apps_cold\n    environment:\n      - cluster.name=apps-imdb\n      - node.name=apps_cold\n      - node.attr.box_type=cold\n      - bootstrap.memory_lock=true\n      - \"ES_JAVA_OPTS=-Xms512m -Xmx512m\"\n      - discovery.seed_hosts=apps_hot,apps_warm,apps_cold\n      - cluster.initial_master_nodes=apps_hot,apps_warm,apps_cold\n    ulimits:\n      memlock:\n        soft: -1\n        hard: -1\n    volumes:\n      - hwc_es7data_cold:/usr/share/elasticsearch/data\n    networks:\n      - hw_hwc_es7net\n\n\nvolumes:\n  hwc_es7data_hot:\n    driver: local\n  hwc_es7data_warm:\n    driver: local\n  hwc_es7data_cold:\n    driver: local\n\nnetworks:\n  # hwc_es7net:\n  hw_hwc_es7net:\n    driver: bridge\n</code></pre> <pre><code>docker-compose up -d \n</code></pre> <p><code>AppSearch 7.3.1</code></p> <p></p> <pre><code>wget https://appsearch.elastic.co/downloads/app-search/app-search-7.3.1.tar.gz --no-check-certificate\n\nvim config/app-search.yml\n\n...\nallow_es_settings_modification: true\n...\n</code></pre> <pre><code>sudo yum install java-11-openjdk-devel\nsudo yum install java-11-openjdk-devel\n\n$ java --version\nopenjdk 11.0.9.1 2020-11-04 LTS\nOpenJDK Runtime Environment 18.9 (build 11.0.9.1+1-LTS)\nOpenJDK 64-Bit Server VM 18.9 (build 11.0.9.1+1-LTS, mixed mode, sharing)\n</code></pre> <pre><code>vim config/enterprise-search.yml\n\napp_search.external_url: http://192.168.33.12:3002\nallow_es_settings_modification: true\napp_search.listen_host: 192.168.33.12\n...\n</code></pre>"},{"location":"chap17/1ES_WS_movie/#1-8-app-search","title":"1-8 \u542f\u52a8 App Search \u670d\u52a1","text":"<pre><code>./bin/app-search\n</code></pre> <p>\u5728\u6d4f\u89c8\u5668\u6253\u5f00\uff1a <code>http://192.168.33.12:3002/</code></p> <p></p> <p></p> <p>Check Overview</p> <p></p> <p>Check Credentials</p> <p></p> <p>R+W: <code>private-3493whudatnyokeed7uifkcw</code></p>"},{"location":"chap17/1ES_WS_movie/#2-elasticsearch","title":"2\u3001\u5c06\u7535\u5f71\u6570\u636e\u5bfc\u5165 Elasticsearch","text":""},{"location":"chap17/1ES_WS_movie/#2-1-api-onboarding","title":"2-1 \u901a\u8fc7API Onboarding \u6570\u636e","text":"<p>TMDB \u6570\u636e\u5e93</p> <ul> <li> <p>\u521b\u5efa\u4e8e 2008 \u5e74\uff0c\u7535\u5f71\u7684 Meta Data \u5e93</p> <ul> <li>46 \u4e07\u672c\u7535\u5f71 / 12\u4e07\u672c\u7535\u89c6\u5267 / 230\u4e07\u5f20\u56fe\u7247 / \u6bcf\u5468 20\u4e07\u6b21\u7f16\u8f91</li> </ul> </li> <li> <p>\u63d0\u4f9b API\u3002\u603b\u5171\u6709\u8d85\u8fc720\u4e07\u5f00\u53d1\u4eba\u5458\u548c\u516c\u53f8\u5728\u4f7f\u7528</p> </li> </ul> <p></p> <p>tmdb.json (small)</p>"},{"location":"chap17/1ES_WS_movie/#2-2-ingest-data","title":"2-2 Ingest data","text":"<p><code>ingest_tmdb_to_appserarch.py</code></p> <pre><code>import requests\nimport json\nimport os\n\nAPP_NAME= os.getenv('APP_SEARCH_NAME')\nAPP_PWD = os.getenv('APP_SEARCH_PWD')\n\ndef extract():\n    f = open('./tmdb.json')\n    if f:\n         return json.loads(f.read());        \n    return {}\n\n\ndef index_all(movieDict={}):\n\n    for id, movie in movieDict.iteritems(): \n        index_doc(movie)\n        print(id)\n\n\ndef index_doc(doc):\n    content=[]\n    content.append(doc)\n    resp = requests.post(\"http://192.168.33.12:3002/api/as/v1/engines/\"+APP_NAME+\"/documents\", \n        headers={\"content-type\":\"application/json\",\"Authorization\": \"Bearer \"+APP_PWD}, \n        data=json.dumps(content))\n    print resp\n\n\n\ndef main():\n    movieDict = extract()\n    index_all(movieDict=movieDict)\n\nif __name__== \"__main__\":\n  main()    \n</code></pre> <pre><code>APP_SEARCH_NAME=tmdb APP_SEARCH_PWD=private-3493whudatnyokeed7uifkcw python ./ingest_tmdb_to_appserarch.py\n</code></pre>"},{"location":"chap17/1ES_WS_movie/#2-3-dashboard","title":"2-3 \u67e5\u770b Dashboard","text":""},{"location":"chap17/1ES_WS_movie/#2-3-documents","title":"2-3 \u67e5\u770b Documents","text":""},{"location":"chap17/1ES_WS_movie/#3","title":"3\u3001\u642d\u5efa\u4f60\u7684\u7535\u5f71\u641c\u7d22\u670d\u52a1","text":""},{"location":"chap17/1ES_WS_movie/#3-1-reference-ui","title":"3-1 \u6784\u5efa Reference UI","text":""},{"location":"chap17/1ES_WS_movie/#3-2-search-ui","title":"3-2 Search UI","text":"<ul> <li>\u529f\u80fd\u6982\u89c8<ul> <li>Analytics: \u83b7\u53d6\u7528\u6237\u641c\u7d22\u76f8\u5173\u7684\u7edf\u8ba1\u6570\u636e</li> <li>UI \u7684\u53c2\u8003\u5b9e\u73b0</li> </ul> </li> <li>\u7ba1\u7406</li> <li>https://github.com/elastic/search-ui</li> </ul>"},{"location":"chap17/1ES_WS_movie/#3-3","title":"3-3 \u5b9a\u5236\u524d\u7aef\u754c\u9762","text":""},{"location":"chap17/1ES_WS_movie/#3-4","title":"3-4 \u5176\u4ed6\u7684\u524d\u7aef\u6846\u67b6","text":"<ul> <li>Reactive Search</li> </ul> <p>https://opensource.appbase.io/reactivesearch</p> <ul> <li>Demo</li> </ul> <p>https://github.com/appbaseio-apps/airbeds</p>"},{"location":"chap17/1ES_WS_movie/#3-5-app-search","title":"3-5 App Search \u540e\u53f0\u7ba1\u7406","text":"<p>http://localhost:3002</p> <ul> <li>\u529f\u80fd\u6982\u89c8<ul> <li>Analytics: \u83b7\u53d6\u7528\u6237\u641c\u7d22\u76f8\u5173\u7684\u7edf\u8ba1\u6570\u636e </li> </ul> </li> <li>\u7ba1\u7406<ul> <li>\u6587\u6863/Schema/API\u65e5\u5fd7 </li> </ul> </li> <li>\u641c\u7d22\u8bbe\u5b9a<ul> <li>\u81ea\u5b9a\u4e49\u540c\u610f\u8bcd(Matrix = \u9ed1\u5ba2\u5e1d\u56fd = \u77e9\u9635\u9769\u547d) </li> <li>\u8c03\u6574\u5b57\u6bb5\u7684\u76f8\u5173\u6027\u6743\u91cd</li> </ul> </li> </ul>"},{"location":"chap17/1ES_WS_movie/#3-6-schema","title":"3-6 \u4fee\u6539\u6570\u636e Schema","text":"<ul> <li>\u65e5\u671f\u7c7b\u578b:\u5982 Release data</li> <li>\u6570\u5b57\u7c7b\u578b:View Count</li> </ul>"},{"location":"chap17/1ES_WS_movie/#3-7-curator","title":"3-7 Curator \u641c\u7d22\u7ed3\u679c","text":""},{"location":"chap17/2ES_WS_stackoverflow/","title":"\u7b2c\u4e8c\u8282 Stackoverflow\u7528\u6237\u8c03\u67e5\u95ee\u5377\u5206\u6790","text":""},{"location":"chap17/2ES_WS_stackoverflow/#1","title":"1\u3001\u9700\u6c42\u5206\u6790\u53ca\u67b6\u6784\u8bbe\u8ba1","text":""},{"location":"chap17/2ES_WS_stackoverflow/#1-1-2020-stackoverflow-survery","title":"1-1 2020 Stackoverflow Survery","text":"<p>https://insights.stackoverflow.com/survey/2020</p> <p></p> <p></p>"},{"location":"chap17/2ES_WS_stackoverflow/#1-2-insights","title":"1-2 Insights","text":""},{"location":"chap17/2ES_WS_stackoverflow/#1-3-open-data","title":"1-3 Open Data","text":""},{"location":"chap17/2ES_WS_stackoverflow/#1-4-survy-schema","title":"1-4 Survy Schema","text":""},{"location":"chap17/2ES_WS_stackoverflow/#1-5","title":"1-5 \u67b6\u6784\u8bbe\u8ba1","text":"<ul> <li>File Input </li> <li>CSV Filter</li> <li>ES Output</li> </ul> <ul> <li>Reindex </li> <li>Ingest Pipeline</li> </ul> <ul> <li>Discovery</li> <li>Visualization </li> <li>Dashboard</li> </ul>"},{"location":"chap17/2ES_WS_stackoverflow/#2-extract-enrichment","title":"2\u3001\u6570\u636e Extract &amp; Enrichment","text":""},{"location":"chap17/2ES_WS_stackoverflow/#2-1-logstash","title":"2-1 Logstash \u5bfc\u5165\u6570\u636e","text":"<ul> <li> <p>Input Plugin </p> <ul> <li>File Input</li> </ul> </li> <li> <p>Filter Plugin </p> <ul> <li>CSV Filter</li> </ul> </li> <li> <p>Output Plugin </p> <ul> <li>ES Output</li> </ul> </li> </ul> <p><code>survey_results_public.csv - (2020) small</code></p> <p><code>logstash-stackoverflow-survey.conf</code></p> <pre><code>input {\n  file {\n    path =&gt; \"/home/vagrant/stack/survey_results_public.csv\"\n    start_position =&gt; \"beginning\"\n    sincedb_path =&gt; \"/dev/null\"\n  }\n}\n\nfilter {\n  csv {\n        autogenerate_column_names =&gt; false\n        skip_empty_columns =&gt; true\n\n        columns =&gt; [\n          \"Respondent\",\"MainBranch\",\"Hobbyist\",\"OpenSourcer\",\"OpenSource\",\"Employment\",\"Country\",\"Student\",\"EdLevel\",\"UndergradMajor\",\"EduOther\",\"OrgSize\",\"DevType\",\"YearsCode\",\"Age1stCode\",\"YearsCodePro\",\"CareerSat\",\"JobSat\",\"MgrIdiot\",\"MgrMoney\",\"MgrWant\",\"JobSeek\",\"LastHireDate\",\"LastInt\",\"FizzBuzz\",\"JobFactors\",\"ResumeUpdate\",\"CurrencySymbol\",\"CurrencyDesc\",\"CompTotal\",\"CompFreq\",\"ConvertedComp\",\"WorkWeekHrs\",\"WorkPlan\",\"WorkChallenge\",\"WorkRemote\",\"WorkLoc\",\"ImpSyn\",\"CodeRev\",\"CodeRevHrs\",\"UnitTests\",\"PurchaseHow\",\"PurchaseWhat\",\"LanguageWorkedWith\",\"LanguageDesireNextYear\",\"DatabaseWorkedWith\",\"DatabaseDesireNextYear\",\"PlatformWorkedWith\",\"PlatformDesireNextYear\",\"WebFrameWorkedWith\",\"WebFrameDesireNextYear\",\"MiscTechWorkedWith\",\"MiscTechDesireNextYear\",\"DevEnviron\",\"OpSys\",\"Containers\",\"BlockchainOrg\",\"BlockchainIs\",\"BetterLife\",\"ITperson\",\"OffOn\",\"SocialMedia\",\"Extraversion\",\"ScreenName\",\"SOVisit1st\",\"SOVisitFreq\",\"SOVisitTo\",\"SOFindAnswer\",\"SOTimeSaved\",\"SOHowMuchTime\",\"SOAccount\",\"SOPartFreq\",\"SOJobs\",\"EntTeams\",\"SOComm\",\"WelcomeChange\",\"SONewContent\",\"Age\",\"Gender\",\"Trans,Sexuality\",\"Ethnicity\",\"Dependents\",\"SurveyLength\",\"SurveyEase\"\n        ]\n\n      }\n  if ([collector] == \"collector\") {\n    drop {}\n  }\n  mutate { remove_field =&gt; [\"message\", \"@version\", \"@timestamp\", \"host\"] }\n}\noutput {\n  stdout { codec =&gt; \"dots\" }\n  elasticsearch {\n                hosts =&gt; [\"http://localhost:9200\"]  \n    index =&gt; \"stackoverflow-survey-raw\"\n                document_type =&gt; \"_doc\"\n                }\n}\n</code></pre> <pre><code>logstash -f logstash-stackoverflow-survey.conf\n\n[2020-12-24T02:37:12,847][INFO ][logstash.runner          ] Starting Logstash {\"logstash.version\"=&gt;\"7.9.1\", \"jruby.version\"=&gt;\"jruby 9.2.13.0 (2.5.7) 2020-08-03 9a89c94bcc OpenJDK 64-Bit Server VM 15.0.1+9 on 15.0.1+9 +indy +jit [linux-x86_64]\"}\n[2020-12-24T02:37:14,795][WARN ][logstash.config.source.multilocal] Ignoring the 'pipelines.yml' file because modules or command line options are specified\n[2020-12-24T02:37:31,855][INFO ][org.reflections.Reflections] Reflections took 128 ms to scan 1 urls, producing 22 keys and 45 values \n[2020-12-24T02:37:36,145][WARN ][logstash.outputs.elasticsearch] You are using a deprecated config setting \"document_type\" set in elasticsearch. Deprecated settings will continue to work, but are scheduled for removal from logstash in the future. Document types are being deprecated in Elasticsearch 6.0, and removed entirely in 7.0. You should avoid this feature If you have any questions about this, please visit the #logstash channel on freenode irc. {:name=&gt;\"document_type\", :plugin=&gt;&lt;LogStash::Outputs::ElasticSearch index=&gt;\"stackoverflow-survey-raw\", id=&gt;\"788c362caf32ff9f16ab96207729a1340067fafd86f87c552ea2bf1b783e431b\", hosts=&gt;[http://localhost:9200], document_type=&gt;\"_doc\", enable_metric=&gt;true, codec=&gt;&lt;LogStash::Codecs::Plain id=&gt;\"plain_a90d9c2d-256e-4565-ae1e-e97e2b99dc05\", enable_metric=&gt;true, charset=&gt;\"UTF-8\"&gt;, workers=&gt;1, manage_template=&gt;true, template_overwrite=&gt;false, doc_as_upsert=&gt;false, script_type=&gt;\"inline\", script_lang=&gt;\"painless\", script_var_name=&gt;\"event\", scripted_upsert=&gt;false, retry_initial_interval=&gt;2, retry_max_interval=&gt;64, retry_on_conflict=&gt;1, ilm_enabled=&gt;\"auto\", ilm_pattern=&gt;\"{now/d}-000001\", ilm_policy=&gt;\"logstash-policy\", ecs_compatibility=&gt;:disabled, action=&gt;\"index\", ssl_certificate_verification=&gt;true, sniffing=&gt;false, sniffing_delay=&gt;5, timeout=&gt;60, pool_max=&gt;1000, pool_max_per_route=&gt;100, resurrect_delay=&gt;5, validate_after_inactivity=&gt;10000, http_compression=&gt;false&gt;}\n[2020-12-24T02:37:38,461][INFO ][logstash.outputs.elasticsearch][main] Elasticsearch pool URLs updated {:changes=&gt;{:removed=&gt;[], :added=&gt;[http://localhost:9200/]}}\n[2020-12-24T02:37:38,956][WARN ][logstash.outputs.elasticsearch][main] Restored connection to ES instance {:url=&gt;\"http://localhost:9200/\"}\n[2020-12-24T02:37:39,272][INFO ][logstash.outputs.elasticsearch][main] ES Output version determined {:es_version=&gt;7}\n[2020-12-24T02:37:39,279][WARN ][logstash.outputs.elasticsearch][main] Detected a 6.x and above cluster: the `type` event field won't be used to determine the document _type {:es_version=&gt;7}\n[2020-12-24T02:37:39,579][INFO ][logstash.outputs.elasticsearch][main] New Elasticsearch output {:class=&gt;\"LogStash::Outputs::ElasticSearch\", :hosts=&gt;[\"http://localhost:9200\"]}\n[2020-12-24T02:37:39,708][INFO ][logstash.outputs.elasticsearch][main] Using a default mapping template {:es_version=&gt;7, :ecs_compatibility=&gt;:disabled}\n[2020-12-24T02:37:39,865][INFO ][logstash.javapipeline    ][main] Starting pipeline {:pipeline_id=&gt;\"main\", \"pipeline.workers\"=&gt;1, \"pipeline.batch.size\"=&gt;125, \"pipeline.batch.delay\"=&gt;50, \"pipeline.max_inflight\"=&gt;125, \"pipeline.sources\"=&gt;[\"/home/vagrant/stack/logstash-stackoverflow-survey.conf\"], :thread=&gt;\"#&lt;Thread:0x471284f2 run&gt;\"}\n[2020-12-24T02:37:40,204][INFO ][logstash.outputs.elasticsearch][main] Attempting to install template {:manage_template=&gt;{\"index_patterns\"=&gt;\"logstash-*\", \"version\"=&gt;60001, \"settings\"=&gt;{\"index.refresh_interval\"=&gt;\"5s\", \"number_of_shards\"=&gt;1}, \"mappings\"=&gt;{\"dynamic_templates\"=&gt;[{\"message_field\"=&gt;{\"path_match\"=&gt;\"message\", \"match_mapping_type\"=&gt;\"string\", \"mapping\"=&gt;{\"type\"=&gt;\"text\", \"norms\"=&gt;false}}}, {\"string_fields\"=&gt;{\"match\"=&gt;\"*\", \"match_mapping_type\"=&gt;\"string\", \"mapping\"=&gt;{\"type\"=&gt;\"text\", \"norms\"=&gt;false, \"fields\"=&gt;{\"keyword\"=&gt;{\"type\"=&gt;\"keyword\", \"ignore_above\"=&gt;256}}}}}], \"properties\"=&gt;{\"@timestamp\"=&gt;{\"type\"=&gt;\"date\"}, \"@version\"=&gt;{\"type\"=&gt;\"keyword\"}, \"geoip\"=&gt;{\"dynamic\"=&gt;true, \"properties\"=&gt;{\"ip\"=&gt;{\"type\"=&gt;\"ip\"}, \"location\"=&gt;{\"type\"=&gt;\"geo_point\"}, \"latitude\"=&gt;{\"type\"=&gt;\"half_float\"}, \"longitude\"=&gt;{\"type\"=&gt;\"half_float\"}}}}}}}\n[2020-12-24T02:37:40,659][INFO ][logstash.outputs.elasticsearch][main] Installing elasticsearch template to _template/logstash\n[2020-12-24T02:37:42,604][INFO ][logstash.javapipeline    ][main] Pipeline Java execution initialization time {\"seconds\"=&gt;2.72}\n[2020-12-24T02:37:44,490][INFO ][logstash.javapipeline    ][main] Pipeline started {\"pipeline.id\"=&gt;\"main\"}\n[2020-12-24T02:37:44,796][INFO ][filewatch.observingtail  ][main][1289d8dea60663368244c6988aa9437f732c80f68c97f64cf9a5c7a12e9e31bf] START, creating Discoverer, Watch with file and sincedb collections\n[2020-12-24T02:37:45,115][INFO ][logstash.agent           ] Pipelines running {:count=&gt;1, :running_pipelines=&gt;[:main], :non_running_pipelines=&gt;[]}\n[2020-12-24T02:37:46,777][INFO ][logstash.agent           ] Successfully started Logstash API endpoint {:port=&gt;9600}\n...\n</code></pre>"},{"location":"chap17/2ES_WS_stackoverflow/#2-2-index-pattern-discovery","title":"2-2 \u521b\u5efa Index Pattern &amp; Discovery","text":"<pre><code>GET stackoverflow-survey-raw/_mapping\n</code></pre> <p>Output</p> <pre><code>{\n  \"stackoverflow-survey-raw\" : {\n    \"mappings\" : {\n      \"properties\" : {\n        \"Age1stCode\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n            }\n          }\n        },\n        \"BetterLife\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n            }\n          }\n        },\n        \"BlockchainIs\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n            }\n          }\n        },\n        \"BlockchainOrg\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n            }\n          }\n        },\n...\n</code></pre>"},{"location":"chap17/2ES_WS_stackoverflow/#2-3-dynamic-template-mapping","title":"2-3 \u4f7f\u7528 Dynamic Template \u5904\u7406\u6587\u672c\u7c7b\u578b Mapping","text":"<pre><code>PUT final-stackoverflow-survey\n{\n  \"mappings\": {\n    \"dynamic_templates\": [\n      {\n        \"strings_as_keywords\": {\n          \"match_mapping_type\": \"string\",\n          \"mapping\": {\n            \"type\": \"keyword\"\n          }\n        }\n      }\n    ]\n  },\n  \"settings\": {\n    \"number_of_replicas\": 0\n  }\n}\n</code></pre> <p>Output</p> <pre><code>{\n  \"acknowledged\" : true,\n  \"shards_acknowledged\" : true,\n  \"index\" : \"final-stackoverflow-survey\"\n}\n</code></pre> <p>\u6570\u5b57\u76f8\u5173</p> <ul> <li>YearsCode</li> <li>WorkWeekHrs</li> <li>Age</li> <li>Age1stCode 16</li> <li>YearsCodePro</li> </ul>"},{"location":"chap17/2ES_WS_stackoverflow/#2-4-ingest-pipeline","title":"2-4 \u521b\u5efa Ingest Pipeline","text":"<pre><code>PUT _ingest/pipeline/stackoverflow_pipeline\n{\n  \"description\": \"Pipeline for stackoverflow survey\",\n  \"processors\": [\n    {\n      \"split\": {\n        \"field\": \"DatabaseDesireNextYear\",\n        \"separator\": \";\"\n      }\n    },\n    {\n      \"split\": {\n        \"field\": \"DatabaseWorkedWith\",\n        \"separator\": \";\"\n      }\n    },\n    {\n      \"split\": {\n        \"field\": \"DevEnviron\",\n        \"separator\": \";\"\n      }\n    },\n    {\n      \"split\": {\n        \"field\": \"LanguageWorkedWith\",\n        \"separator\": \";\"\n      }\n    },\n    {\n      \"split\": {\n        \"field\": \"MiscTechDesireNextYear\",\n        \"separator\": \";\"\n      }\n    },\n    {\n      \"split\": {\n        \"field\": \"PlatformWorkedWith\",\n        \"separator\": \";\"\n      }\n    },\n    {\n      \"split\": {\n        \"field\": \"PlatformDesireNextYear\",\n        \"separator\": \";\"\n      }\n    },\n    {\n      \"split\": {\n        \"field\": \"WebFrameWorkedWith\",\n        \"separator\": \";\"\n      }\n    },\n    {\n      \"split\": {\n        \"field\": \"WebFrameDesireNextYear\",\n        \"separator\": \";\"\n      }\n    },\n    {\n      \"split\": {\n        \"field\": \"Containers\",\n        \"separator\": \";\"\n      }\n    },\n    {\n      \"script\": {\n        \"source\": \"\"\"\n          try{\n              ctx.YearsCode = Integer.parseInt(ctx.YearsCode);\n            }catch(Exception e){\n                ctx.YearsCode = 0;\n            }\n\"\"\"\n      }\n    },\n    {\n      \"script\": {\n        \"source\": \"\"\"\n          try{\n              ctx.WorkWeekHrs = Integer.parseInt(ctx.WorkWeekHrs);\n            }catch(Exception e){\n                ctx.WorkWeekHrs = 0;\n            }\n\"\"\"\n      }\n    },\n    {\n      \"script\": {\n        \"source\": \"\"\"\n          try{\n              ctx.Age = Integer.parseInt(ctx.Age);\n            }catch(Exception e){\n                ctx.Age = 0;\n            }\n\"\"\"\n      }\n    },\n    {\n      \"script\": {\n        \"source\": \"\"\"\n          try{\n              ctx.Age1stCode = Integer.parseInt(ctx.Age1stCode);\n            }catch(Exception e){\n                ctx.Age1stCode = 0;\n            }\n\"\"\"\n      }\n    },\n    {\n      \"script\": {\n        \"source\": \"\"\"\n          try{\n              ctx.YearsCodePro = Integer.parseInt(ctx.YearsCodePro);\n            }catch(Exception e){\n                ctx.YearsCodePro = 0;\n            }\n\"\"\"\n      }\n    }\n  ]\n}\n</code></pre> <p>Output:</p> <pre><code>{\n  \"acknowledged\" : true\n}\n</code></pre>"},{"location":"chap17/2ES_WS_stackoverflow/#2-5-reindex","title":"2-5 Reindex","text":"<pre><code>POST _reindex?wait_for_completion=false\n{\n  \"source\": {\n    \"index\": \"stackoverflow-survey-raw\"\n  },\n  \"dest\": {\n    \"index\": \"final-stackoverflow-survey\",\n    \"pipeline\": \"stackoverflow_pipeline\"\n  }\n}\n</code></pre> <p>Output</p> <pre><code>{\n  \"task\" : \"vB-aGlnVTQmjFhdCQVpfVQ:42801\"\n}\n</code></pre>"},{"location":"chap17/2ES_WS_stackoverflow/#2-6-index-pattern","title":"2-6 Index Pattern","text":"<pre><code>GET final-stackoverflow-survey/_mapping\n</code></pre> <pre><code>\"Age\" : {\n          \"type\" : \"long\"\n        },\n\"Age1stCode\" : {\n          \"type\" : \"long\"\n        },\n\"WorkWeekHrs\" : {\n          \"type\" : \"long\"\n        },\n\"YearsCode\" : {\n          \"type\" : \"long\"\n        },\n \"YearsCodePro\" : {\n          \"type\" : \"long\"\n        },\n</code></pre> <p><code>final-stackoverflow-survey</code></p> <p></p> <p></p>"},{"location":"chap17/2ES_WS_stackoverflow/#3-insights-dashboard","title":"3\u3001\u6784\u5efa Insights Dashboard","text":""},{"location":"chap17/2ES_WS_stackoverflow/#3-1-dashboard","title":"3-1 Dashboard","text":""},{"location":"chap17/2ES_WS_stackoverflow/#3-2-web-framework-worked-with","title":"3-2 Web Framework Worked with","text":""},{"location":"chap17/2ES_WS_stackoverflow/#3-3-database-desired-next-year","title":"3-3 Database Desired Next Year","text":"<p>Visualization Markdown: <code>stackoverflow-DBnextyear-intro</code></p> <p></p> <p>Visualization Tagdown: <code>stackoverflow-DBnextyear-tag</code></p> <p></p> <p></p>"},{"location":"chap17/2ES_WS_stackoverflow/#3-4-age-average-work-hoursper-week","title":"3-4 Age &amp; Average Work Hours(per week)","text":""},{"location":"chap17/2ES_WS_stackoverflow/#3-5-countrybetter-life","title":"3-5 Country(Better Life)","text":""},{"location":"chap17/3EFK_jfrog/","title":"\u7b2c\u4e09\u8282 \u901a\u8fc7EFK\u5bf9Artifactory\u8fdb\u884c\u65e5\u5fd7\u5206\u6790","text":"<p>JFrog Artifactory</p> <p></p> <p>JFrog Platform</p> <p></p>"},{"location":"chap17/3EFK_jfrog/#artifactory-logging","title":"Artifactory logging\u56de\u987e","text":""},{"location":"chap17/3EFK_jfrog/#artifactory-service","title":"Artifactory Service","text":"<ul> <li>Artifactory \u5e94\u7528\u670d\u52a1</li> <li>Access      \u8ba4\u8bc1\u670d\u52a1</li> <li>Router      \u5e73\u53f0\u7f51\u5173\u670d\u52a1</li> <li>Frontend    \u524d\u7aef\u670d\u52a1</li> <li>Metadata    \u5236\u54c1\u4fe1\u606f\u7edf\u8ba1</li> </ul> <p>Artifactory Logging</p> <p>Frog Logging Doc: https://jfrog.com/help/r/jfrog-platform-administration-documentation/logging</p> <p>\u4e3a\u4ec0\u4e48\u8981\u7edf\u8ba1\u65e5\u5fd7</p> <ul> <li>\u4e8b\u4ef6\u8bb0\u5f55</li> <li>\u9519\u8bef\u8bb0\u5f55</li> <li>\u72b6\u6001\u8bb0\u5f55</li> </ul> <p>\u53ef\u4ee5\u5e2e\u6211\u4eec\u89e3\u51b3\u4ec0\u4e48\u95ee\u9898 </p> <ul> <li>\u95ee\u9898\u6392\u67e5</li> <li>\u4e86\u89e3\u72b6\u6001</li> <li>\u8fd0\u7ef4\u7ba1\u7406</li> <li>\u5b9e\u65f6\u9884\u8b66</li> </ul> <p></p>"},{"location":"chap17/3EFK_jfrog/#efk","title":"EFK\u4ecb\u7ecd\u4ee5\u53ca\u5b89","text":"<p>Elasticsearch</p> <ul> <li>\u5f00\u6e90\u641c\u7d22\u5f15\u64ce</li> <li>\u652f\u6301\u5206\u5e03\u5f0f</li> </ul> <p>Kibana</p> <ul> <li>Dashboards</li> <li>ES\u53ef\u89c6\u5316\u5e73\u53f0</li> </ul> <p></p> <ul> <li>docker-compose\u5b89\u88c5</li> <li>kibana.yml</li> <li> <p>elasticsearch</p> </li> <li> <p>elasticsearch.yml</p> </li> <li>elasticsearch/data</li> <li>elasticsearch/plugins</li> <li>elasticsearch/logs</li> </ul> <p></p>"},{"location":"chap17/3EFK_jfrog/#fluentd","title":"Fluentd","text":"<ul> <li>\u5f00\u6e90</li> <li>\u5b89\u88c5\u914d\u7f6e\u7b80\u5355</li> <li>\u7edf\u4e00\u65e5\u5fd7\u5904\u7406</li> <li>Elastic + Kibana</li> <li>Splunk</li> <li>Datadog</li> <li>Prometheus + Grafana</li> </ul>"},{"location":"chap17/3EFK_jfrog/#fluentd_1","title":"Fluentd\u5b89\u88c5","text":"<ul> <li>docker-compose\u5b89\u88c5 \u65e5\u5fd7\u5904\u7406\u8def\u5f84\u6302\u8f7d</li> <li>Artifactory logs dir</li> <li>fluent.conf</li> <li>\u73af\u5883\u53d8\u91cf</li> <li><code>JF_JPD</code></li> <li>ELSATIC</li> </ul>"},{"location":"chap17/3EFK_jfrog/#1-centos-7","title":"1. \u73af\u5883\u51c6\u5907\uff1a\uff08CentOS 7\uff09","text":"<p>Docker-ce\u5b89\u88c5\uff1a</p> <pre><code>yum install -y yum-utils device-mapper-persistent-data lvm2 yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo \n\nyum install docker-ce -y \n\nsystemctl start docker &amp;&amp; systemctl enable docker \n\n# docker\u7248\u672c\u786e\u8ba4 \ndocker --version\nDocker Version 20.10.17\n</code></pre> <p>docker-compose\u5b89\u88c5\uff1a</p> <pre><code>sudo curl -L \"https://github.com/docker/compose/releases/download/1.29.2/docker- compose-$(uname -s)-$(uname -m)\" -o /usr/local/bin/docker-compose\n\n# docker-compose\u7248\u672c\u786e\u8ba4 docker-compose --version\n</code></pre>"},{"location":"chap17/3EFK_jfrog/#2-elasticsearch-kibana851","title":"2. elasticsearch &amp; kibana\u5b89\u88c5\uff088.5.1\u7248\u672c\uff09","text":"<p>\u6240\u9700\u2f6c\u5f55\u521b\u5efa</p> <pre><code># \u521b\u5efaelasticsearch &amp; kibana\u6302\u8f7d\u2f6c\u5f55 mkdir -p /data/elasticsearch/{config,data,logs,plugins} mkdir -p /data/kibana/config\n\n# \u4fee\u6539\u6743\u9650 \nchown 1000:1000 /data/{elasticsearch,kibana}/ -R \nchmod 755 /data/{elasticsearch,kibana}/ -R\n\n# \u521b\u5efadocker-compose.yml\u2f42\u4ef6 \nmkdir /opt/EFK &amp;&amp; cd /opt/EFK\n</code></pre> <ul> <li>docker-compose\u2f42\u4ef6\uff1a\uff08<code>/opt/EFK/docker-compose.yml</code>\uff09</li> </ul> <pre><code>version: '3.2' \nservices: \n    elasticsearch: \n        image: elasticsearch:8.5.1 \n        ports: \n            - \"9200:9200\" \n            - \"9300:9300\" \n        container_name: \"elasticsearch\" \n        enviro__nment: \n            - discovery.type=single-node \n            - \"ES_JAVA_OPTS=-Xms1G -Xmx4G\" \n        restart: always \n        volumes: \n            - /data/elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/co \n            - /data/elasticsearch/data:/usr/share/elasticsearch/data \n            - /data/elasticsearch/plugins:/usr/share/elasticsearch/plugins          - /data/elasticsearch/logs:/data/elasticsearch/logs \nkibana: \n    image: kibana:8.5.1 \n    ports: \n        - \"5601:5601\" \n    container_name: \"kibana\" \n    environment: \n        - ELASTICSEARCH_HOSTS=http://192.168.56.134:9200 \n        - ELASTICSEARCH_USERNAME=kibana \n        - ELASTICSEARCH_PASSWORD=\"123456\" \n    restart: always \n    depends_on: \n        - elasticsearch \n    volumes: - /data/kibana/config/kibana.yml:/usr/share/kibana/config/kibana.yml\n</code></pre>"},{"location":"chap17/3EFK_jfrog/#3","title":"3. \u914d\u7f6e\u2f42\u4ef6\uff1a","text":"<p><code>elasticsearch.yml (/data/elasticsearch/config/elasticsearch.yml)</code></p> <pre><code>cluster.name: \"EFK-cluster\" \nnetwork.host: 0.0.0.0 \n\nhttp.cors.allow-origin: \"*\" \nhttp.cors.enabled: true \nhttp.cors.allow-headers: Authorization,X-Requested-With,Content-Length,Content-T \n\nxpack.security.enabled: true \nxpack.security.enrollment.enabled: true\n</code></pre> <p><code>kibana.yml (/data/kibana/config/kibana.yml)</code></p> <pre><code>server.name: kibana \nserver.host: \"0.0.0.0\" \nelasticsearch.hosts: [ \"http://192.168.56.134:9200\" ] \n\nxpack.monitoring.ui.container.elasticsearch.enabled: true \n# \u4e2d\u2f42\u53ef\u9009 \ni18n.locale: \"zh-CN\"\n</code></pre> <ul> <li>elasticsearch &amp; kibana\u670d\u52a1\u542f\u52a8\u914d\u7f6e</li> </ul> <pre><code># \u9700\u8981\u63d0\u524d\u51c6\u5907\u597delasticsearch &amp; kibana\u6240\u9700\u955c\u50cf \ndocker pull elasticsearch:8.5.1 \ndocker pull kibana:8.5.1 45 \n\n# docker-compose\u542f\u52a8 \ncd /opt/EFK \ndocker-compose up -d \n\n# \u68c0\u67e5\u542f\u52a8\u72b6\u6001 \ndocker-compose ps \n\n# \u901a\u8fc7log\u68c0\u67e5\u670d\u52a1\u542f\u52a8\u72b6\u6001\uff0c\u67e5\u770b\u662f\u5426\u6709\u5176\u4ed6\u7684\u5f02\u5e38 \ndocker-compose logs -f --tail 100 elasticsearch \ndocker-compose logs -f --tail 100 kibana\n</code></pre> <ul> <li>\u91cd\u7f6eelasticsearch &amp; kibana\u5bc6\u7801</li> </ul> <p></p> <pre><code># \u8fdb\u2f0a\u5230elasticsearch\u5bb9\u5668\u4e2d \ndocker exec -it elasticsearch bash \n\n# \u91cd\u7f6e\u2f64\u2f3e\u5bc6\u7801\uff08elasticsearch V8\u4e0d\u518d\u5141\u8bb8\u4f7f\u2f64elastic\u2f64\u2f3e\u8fdb\u2f8f\u914d\u7f6e\uff09 \n# \u91cd\u7f6eelastic\u2f64\u2f3e\u5bc6\u7801 \nbin/elasticsearch-reset-password --username elastic -i \n\n# \u91cd\u7f6ekibana\u2f64\u2f3e\u5bc6\u7801 \nbin/elasticsearch-reset-password --username kibana -i 12345678\n</code></pre> <p></p> <ul> <li>\u91cd\u542f\u670d\u52a1</li> </ul> <pre><code># docker-compose\u91cd\u542f \ndocker-compose down\n\ndocker-compose up -d\n\n# \u68c0\u67e5\u542f\u52a8\u72b6\u6001 \ndocker-compose ps\n</code></pre> <p></p>"},{"location":"chap17/3EFK_jfrog/#4","title":"4. \u670d\u52a1\u9a8c\u8bc1","text":"<pre><code># \u9a8c\u8bc1elasticsearch\u542f\u52a8\u72b6\u6001 \ncurl localhost:9200 -u elastic\n\n# \u8bbf\u95eeelasticsearch &amp; kibana\u524d\u7aef\uff0c\u4f7f\u2f64elastic\u2f64\u2f3e\u767b\u5f55\nhttp://192.168.56.134:5601\n</code></pre>"},{"location":"chap17/3EFK_jfrog/#flutend","title":"Flutend\u5b89\u88c5\u914d\u7f6e","text":"<ol> <li>\u73af\u5883\u51c6\u5907\uff1a\uff08CentOS 7\uff09 </li> </ol> <p>Flutend\u4f5c\u4e3a\u2f47\u5fd7\u6536\u96c6\u5ba2\u2f3e\u7aef\uff0c\u9700\u8981\u5b89\u88c5\u5728Artifactory\u8282\u70b9\u4e0a</p> <ul> <li>Docker-ce\u5b89\u88c5\uff1a</li> </ul> <pre><code>yum install -y yum-utils device-mapper-persistent-data lvm2 \nyum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo \nyum install docker-ce -y \n\nsystemctl start docker &amp;&amp; systemctl enable docker \n\n# docker\u7248\u672c\u786e\u8ba4 \ndocker --version\n</code></pre> <p>docker-compose\u5b89\u88c5\uff1a</p> <pre><code>sudo curl -L \"https://github.com/docker/compose/releases/download/1.29.2/docker- compose-$(uname -s)-$(uname -m)\" -o /usr/local/bin/docker-compose\n\n# docker-compose\u7248\u672c\u786e\u8ba4\ndocker-compose --version\n</code></pre> <ul> <li>Artifactory\u4e2d\u9700\u8981\u5f00\u542fmetrics\uff0c\u5f00\u542f\u540e\u91cd\u542fArtifactory\u2f63\u6548\uff1a</li> </ul> <pre><code> # Artifactory $JFROG_HOME/artifactory/var/etc/system.yaml \u65b0\u589e\u5982\u4e0b\u53c2\u6570\n\n shared:\n    metrics: \n        enabled: true \n\nartifactory: \n    metrics: \n        enabled: true \n\nmc: \n    enabled: true\n</code></pre>"},{"location":"chap17/3EFK_jfrog/#2-flutenddocker-compose","title":"2. flutend\u5b89\u88c5\uff08docker-compose\uff09","text":"<ul> <li>\u6240\u9700\u2f6c\u5f55\u521b\u5efa</li> </ul> <pre><code># \u521b\u5efa\u9879\u2f6c\u2f6c\u5f55 \nmkdir /opt/flutend/config -p \n\n# \u6743\u9650\u4fee\u6539\nhown 1000:1000 /opt/flutend -R \nchmod 755 /opt/flutend -R\n</code></pre> <ul> <li><code>docker-compose</code>\u2f42\u4ef6\uff1a\uff08<code>/opt/flutend/docker-compose.yml</code>\uff09\uff0c\u5c06\u2f63\u6210\u7684<code>API Key</code>\u548c<code>Access token</code>\u586b\u5199\u5230yml\u2f42\u4ef6\u4e2d</li> </ul> <pre><code>version: '3.2' \nservices: \n    td-agent: \n        image: partnership-public-images.jfrog.io/fluentd/fluentd:1.18.0 \n        container_name: \"td-agent\" \n        environment: \n            - JF_PRODUCT_DATA_INTERNAL=/opt/jfrog/artifactory/var/ \n            - JF_JPD_URL=http://192.168.56.135:8082 \n            - JF_JPD_USER_NAME=admin \n            - JF_JPD_API_KEY=xxx \n            - JF_JPD_TOKEN=xxx \n            - ELASTIC_USER=elastic \n            - ELASTIC_PASSWORD=xxx \n            - ELASTIC_SCHEME=http \n            - ELASTIC_SSL_VERIFY=false \n        restart: always \n        volumes: \n            - /opt/flutend/config:/etc/td-agent \n            - /opt/jfrog/artifactory/var/:/opt/jfrog/artifactory/var/ \n        command: [\"fluentd\",\"-v\",\"-c\",\"/etc/td-agent/fluent.conf\"]\n</code></pre> <ul> <li>fluent.conf\u914d\u7f6e\u2f42\u4ef6(<code>/opt/fluentd/config/fluent.conf</code>)</li> </ul> <pre><code>&lt;source&gt; \n    @type tail\n    @id access_service_tail\n    path \"#{ENV['JF_PRODUCT_DATA_INTERNAL']}/log/access-service.log\"\n    pos_file \"#{ENV['JF_PRODUCT_DATA_INTERNAL']}/log/access-service.log.pos\"\n    tag jfrog.rt.access.service\n    &lt;parse&gt; \n        @type none \n    &lt;/parse&gt;\n&lt;/source&gt;\n\n&lt;source&gt;\n    @type tail\n    @id artifactory_service_tail\n    path \"#{ENV['JF_PRODUCT_DATA_INTERNAL']}/log/artifactory-service.log\"\n  pos_file \"#{ENV['JF_PRODUCT_DATA_INTERNAL']}/log/artifactory-service.log.pos\"\n  tag jfrog.rt.artifactory.service\n  &lt;parse&gt; \n    @type none \n  &lt;/parse&gt; \n &lt;/source&gt; \n &lt;source&gt;\n    @type tail\n    @id frontend_service_tail\n    path \"#{ENV['JF_PRODUCT_DATA_INTERNAL']}/log/frontend-service.log\"\n    pos_file \"#{ENV['JF_PRODUCT_DATA_INTERNAL']}/log/frontend-service.log.pos\"\n    tag jfrog.rt.frontend.service\n    &lt;parse&gt;\n        @type none\n    &lt;/parse&gt;\n &lt;/source&gt;\n    @type tail \n    @id metadata_service_tail \n    path \"#{ENV['JF_PRODUCT_DATA_INTERNAL']}/log/metadata-service.log\" \n    pos_file \"#{ENV['JF_PRODUCT_DATA_INTERNAL']}/log/metadata-service.log.pos\" \n    tag jfrog.rt.metadata.service \n    &lt;parse&gt; \n        @type none \n    &lt;/parse&gt; \n&lt;/source&gt; \n&lt;source&gt; \n    @type tail \n    @id router_service_tail \n    path \"#{ENV['JF_PRODUCT_DATA_INTERNAL']}/log/router-service.log\" \n    pos_file \"#{ENV['JF_PRODUCT_DATA_INTERNAL']}/log/router-service.log.pos\" \n    tag jfrog.rt.router.service \n    &lt;parse&gt; \n        @type none \n    &lt;/parse&gt;\n&lt;/source&gt; \n# Strip out color codes then field extract the service fields \n&lt;filter jfrog.rt.**.service&gt; \n    @type record_transformer \n    enable_ruby true \n    &lt;record&gt; \n        message ${record[\"message\"].gsub(/\\e\\[([;\\d]+)?m/, '')} \n    &lt;/record&gt; \n&lt;/filter&gt; \n&lt;filter jfrog.rt.**.service&gt; \n    @type parser \n    key_name message \n    &lt;parse&gt; \n        @type multiline \n        format_firstline /\\d{4}-\\d{1,2}-\\d{1,2}/ \n        format1 /^(?&lt;timestamp&gt;[^ ]*) \\[(?&lt;service_type&gt;[^\\]]*)\\] \\[(?&lt;log_level&gt;[ \n    &lt;/parse&gt; \n&lt;/filter&gt; \n# End Service Fields Extraction\n&lt;source&gt; \n    @type tail \n    @id router_traefik_tail \n    path \"#{ENV['JF_PRODUCT_DATA_INTERNAL']}/log/router-traefik.log\" \n    pos_file \"#{ENV['JF_PRODUCT_DATA_INTERNAL']}/log/router-traefik.log.pos\" \n    tag jfrog.rt.router.traefik \n    &lt;parse&gt; \n        @type multiline \n        format_firstline /\\d{4}-\\d{1,2}-\\d{1,2}/ \n        format1 /^(?&lt;timestamp&gt;[^ ]*) \\[(?&lt;service_type&gt;[^\\]]*)\\] \\[(?&lt;log_level&gt;[ \n    &lt;/parse&gt; \n&lt;/source&gt;\n\n&lt;source&gt; \n    @type tail\n    @id access_request_tail \n    path \"#{ENV['JF_PRODUCT_DATA_INTERNAL']}/log/access-request.log\" \n    pos_file \"#{ENV['JF_PRODUCT_DATA_INTERNAL']}/log/access-request.log.pos\" \n    tag jfrog.rt.access.request \n        &lt;parse&gt; \n            @type regexp \n            expression ^(?&lt;timestamp&gt;[^ ]*)\\|(?&lt;trace_id&gt;[^\\|]*)\\|(?&lt;remote_address&gt;[^\\| \n        &lt;/parse&gt; \n&lt;/source&gt; \n&lt;source&gt; \n    @type tail\n            @id artifactory_request_tail \n        path \"#{ENV['JF_PRODUCT_DATA_INTERNAL']}/log/artifactory-request.log\" \n        pos_file \"#{ENV['JF_PRODUCT_DATA_INTERNAL']}/log/artifactory-request.log.pos\" \n        tag jfrog.rt.artifactory.request \n        &lt;parse&gt; \n            @type regexp \n            expression ^(?&lt;timestamp&gt;[^ ]*)\\|(?&lt;trace_id&gt;[^\\|]*)\\|(?&lt;remote_address&gt;[^\\|\n        &lt;/parse&gt; \n    &lt;/source&gt; \n    &lt;filter jfrog.rt.artifactory.request&gt; \n        @type record_transformer \n        enable_ruby true \n        &lt;record&gt; \n            repo ${record[\"request_url\"].include?(\"/api/docker\") &amp;&amp; !record[\"request_url \n            image ${record[\"request_url\"].include?(\"/api/docker\") &amp;&amp; !record[\"request_ur \n        &lt;/record&gt; \n    &lt;/filter&gt; \n    &lt;source&gt; \n        @type tail \n        @id frontend_request_tail \n        path \"#{ENV['JF_PRODUCT_DATA_INTERNAL']}/log/frontend-request.log\" \n        pos_file \"#{ENV['JF_PRODUCT_DATA_INTERNAL']}/log/frontend-request.log.pos\" 1\n        tag jfrog.rt.frontend.request \n        &lt;parse&gt; \n            @type regexp \n            expression ^(?&lt;timestamp&gt;[^ ]*)\\|(?&lt;trace_id&gt;[^\\|]*)\\|(?&lt;remote_address&gt;[^\\| \n        &lt;/parse&gt; \n    &lt;/source&gt; \n    &lt;source&gt; \n        @type tail \n        @id metadata_request_tail \n        path \"#{ENV['JF_PRODUCT_DATA_INTERNAL']}/log/metadata-request.log\" \n        pos_file \"#{ENV['JF_PRODUCT_DATA_INTERNAL']}/log/metadata-request.log.pos\" \n        tag jfrog.rt.metadata.request \n        &lt;parse&gt; \n            @type regexp \n            expression ^(?&lt;timestamp&gt;[^ ]*)\\|(?&lt;trace_id&gt;[^\\|]*)\\|(?&lt;remote_address&gt;[^\\| \n        &lt;/parse&gt; \n    &lt;/source&gt; \n    &lt;source&gt; \n        @type tail \n        @id router_request_tail \n        path \"#{ENV['JF_PRODUCT_DATA_INTERNAL']}/log/router-request.log\" \n        pos_file \"#{ENV['JF_PRODUCT_DATA_INTERNAL']}/log/router-request.log.pos\" \n        tag jfrog.rt.router.request \n        &lt;parse&gt; \n            @type json\n            &lt;/parse&gt; \n&lt;/source&gt; \n&lt;source&gt; \n    @type tail \n    @id artifactory_access_tail \n    path \"#{ENV['JF_PRODUCT_DATA_INTERNAL']}/log/artifactory-access.log\" \n    pos_file \"#{ENV['JF_PRODUCT_DATA_INTERNAL']}/log/artifactory-access.log.pos\" \n    tag jfrog.rt.artifactory.access \n    &lt;parse&gt; \n        @type regexp \n        expression /^(?&lt;timestamp&gt;[^ ]*) \\[(?&lt;trace_id&gt;[^\\]]*)\\] \\[(?&lt;action_respons \n    &lt;/parse&gt; \n&lt;/source&gt; \n&lt;source&gt; \n    @type tail \n    @id access_security_audit_tail \n    path \"#{ENV['JF_PRODUCT_DATA_INTERNAL']}/log/access-security-audit.log\" \n    pos_file \"#{ENV['JF_PRODUCT_DATA_INTERNAL']}/log/access-security-audit.log.pos \n    tag jfrog.rt.access.audit \n    &lt;parse&gt; \n        @type regexp \n        expression /^(?&lt;timestamp&gt;[^ ]*)\\|(?&lt;token_id&gt;[^ ]*)\\|(?&lt;user_ip&gt;[^ ]*)\\|(?&lt;  \n    &lt;/parse&gt; \n    &lt;/source&gt; \n    &lt;filter jfrog.**&gt; \n        @type record_transformer \n        &lt;record&gt; \n            hostname \"#{Socket.gethostname}\" \n            log_source ${tag} \n        &lt;/record&gt; \n    &lt;/filter&gt; \n&lt;source&gt; \n    @type exec \n    tag jfrog.callhome \n    command \"curl --request GET 'http://localhost:8081/artifactory/api/system/vers run_interval 1d \n    &lt;parse&gt; \n        @type json \n    &lt;/parse&gt; \n&lt;/source&gt; \n&lt;filter jfrog.callhome&gt; \n    @type record_transformer \n    renew_record true \n    keep_keys 'productId,features' \n    enable_ruby true \n    &lt;record&gt; \n        productId 'jfrogLogAnalyticsElastic/0.9.0'\n                features ${return([{\"featureId\" =&gt; \"ArtifactoryVersion/\" + record[\"version\"] \n    &lt;/record&gt; \n&lt;/filter&gt; \n&lt;match jfrog.callhome&gt; \n    @type http \n    endpoint http://localhost:8081/artifactory/api/system/usage \n    open_timeout 5 \n    content_type application/json \n    headers {\"Authorization\":\"Bearer &lt;TOKEN&gt;\"} \n    &lt;format&gt; \n        @type json \n        &lt;/format&gt; \n        &lt;buffer&gt; \n            flush_interval 5s\n        &lt;/buffer&gt; \n        &lt;/match&gt; \n        &lt;filter jfrog.rt.artifactory.request&gt; \n            @type record_transformer \n            enable_ruby true \n            &lt;record&gt; \n                repo ${record[\"request_url\"].include?(\"/api/docker\") &amp;&amp; !record[\"request_url\n                image ${record[\"request_url\"].include?(\"/api/docker\") &amp;&amp; !record[\"request_ur\n            &lt;/record&gt; \n        &lt;/filter&gt; \n    &lt;filter jfrog.rt.artifactory.request&gt; \n        @type record_transformer \n        enable_ruby true \n        &lt;record&gt; \n            response_content_length_2 ${record[\"response_content_length\"].to_f} \n            request_content_length_2 ${record[\"request_content_length\"].to_f} \n        &lt;/record&gt; \n    &lt;/filter&gt; \n\n###JFROG METRICS Plugin \n&lt;source&gt; \n    @type jfrog_metrics \n    @id metrics_http_jfrt \n    tag jfrog.metrics.artifactory \n    interval 5s \n    metric_prefix 'jfrog.artifactory' \n    jpd_url http://192.168.56.135:8082 \n    username admin \n    apikey AKCp8ohUb3ShLFuU9ydRa9rLE6LbZCn3xYs7txHH78L8jGG7boL5xqsECTZssbTSz6tbTNi \n    token eyJ2ZXIiOiIyIiwidHlwIjoiSldUIiwiYWxnIjoiUlMyNTYiLCJraWQiOiJ0YmhLQWVNVFh6 target_platform \"ELASTIC\" \n&lt;/source&gt; \n\n########################\n# ELASTIC OUTPUT METRICS\n########################\n&lt;match jfrog.metrics.**&gt;\n    @type elasticsearch\n    @id elasticsearch_metrics\n    host 192.168.56.134\n    port 9200\n    user elastic\n    password 123456\n    # scheme \"http\"\n    # ssl_verify \"false\n    index_name unified-metrics-artifactory\n    include_tag_key true\n    type_name fluentd\n    logstash_format false\n    include_timestamp true\n    &lt;/match&gt;\n#END ELASTIC OUTPUT\n\n# &lt;match jfrog.metrics.**&gt;\n# @type stdout\n# &lt;/match&gt;\n\n########################\n# ELASTIC OUTPUT LOGS\n########################\n&lt;match jfrog.**&gt;\n    @type elasticsearch\n    @id elasticsearch_logs\n    host 192.168.56.134\n    port 9200\n    user elastic\n    password 123456\n    # scheme \"#{ENV['ELASTIC_SCHEME']}\"\n    # ssl_verify \"#{ENV['ELASTIC_SSL_VERIFY']}\"\n    index_name unified-artifactory\n    include_tag_key true\n    type_name fluentd\n    logstash_format false\n&lt;/match&gt;\n\n#END ELASTIC OUTPUT\n\n# &lt;match jfrog.**&gt;\n# @type stdout\n# &lt;/match&gt;\n</code></pre> <p>Flutend \u670d\u52a1\u542f\u52a8</p> <pre><code># \u9700\u8981\u63d0\u524d\u51c6\u5907\u597dFlutend\u6240\u9700\u955c\u50cf \ndocker pull partnership-public-images.jfrog.io/fluentd/fluentd:1.18.0 34 \n\n# docker-compose\u542f\u52a8 \ncd /opt/flutend \ndocker-compose up -d \n\n# \u68c0\u67e5\u542f\u52a8\u72b6\u6001 \ndocker-compose ps \n\n# \u901a\u8fc7log\u68c0\u67e5\u670d\u52a1\u542f\u52a8\u72b6\u6001\uff0c\u67e5\u770b\u662f\u5426\u6709\u5176\u4ed6\u7684\u5f02\u5e38 \ndocker-compose logs -f --tail 100\n</code></pre> <p></p>"},{"location":"chap17/3EFK_jfrog/#efk_1","title":"\u4e09\u3001EFK\u914d\u7f6e\u8c03","text":""},{"location":"chap17/3EFK_jfrog/#1-elasticsearch","title":"1. elasticsearch\u7d22\u5f15","text":"<p>\u767b\u5f55elasticsearch\u540e\u70b9\u51fbManagement\uff0c\u5f53fluentd\u5411ES\u6210\u529f\u53d1\u9001\u6570\u636e\u540e\uff0c\u53ef\u4ee5\u5728Index Management\u770b\u5230<code>unified-artifactory</code>\u548c <code>unified-metrics-artifactory</code>\u4e24\u4e2aIndex</p> <p></p>"},{"location":"chap17/3EFK_jfrog/#2","title":"2. \u5bfc\u2f0a\u6a21\u7248","text":"<p>\u5bfc\u2f0aJFrog Github\u9879\u2f6c\u4e2d\u63d0\u9001\u7684NSJSON\u2f42\u4ef6\uff0c\u70b9\u51fbSave Object\uff0c\u70b9\u51fbImport\u5bfc\u2f0a kibana_dashboard_v1.ndjson</p> <p></p>"},{"location":"chap17/3EFK_jfrog/#3-dashboard","title":"3. Dashboard\u8c03\u8bd5","text":"<p>\u70b9\u51fbDiscover\u53ef\u4ee5\u770b\u5230unified-artifactory\u548cunified-metrics-artifactory\u4e0b\u7684\u6570\u636e</p> <p></p> <p></p> <p>\u70b9\u51fbDashboard\u53ef\u4ee5\u770b\u5230\u5bfc\u2f0a\u7684Artifactory\u76f8\u5173\u7684\u6a21\u7248</p> <p></p>"},{"location":"chap17/3EFK_jfrog/#efk_2","title":"EFK\u81ea\u5b9a\u4e49\u53ef\u89c6\u5316\u56fe\u8868\u76d1\u63a7","text":"<p>EFK\u96c6\u6210\u81ea\u5b9a\u4e49\u53ef\u89c6\u5316\u56fe\u8868</p> <p>remote\u4ed3\u5e93\u5e73\u5747\u8bf7\u6c42\u65f6\u957f</p> <ul> <li>artifactory-request-out.log</li> <li>fluent.conf\u6dfb\u52a0source</li> </ul> <p>ES\u4e2d\u6dfb\u52a0\u56fe\u8868</p> <ul> <li>remote avg request</li> </ul> <p></p>"},{"location":"chap17/3EFK_jfrog/#efk_3","title":"EFK\u96c6\u6210\u81ea\u5b9a\u4e49\u53ef\u89c6\u5316\u56fe\u8868","text":"<p>source</p> <ul> <li>\u6307\u5b9a<code>request-out log</code></li> <li>\u8fc7\u6ee4\u5b57\u6bb5</li> </ul> <p>\u8f6c\u6362<code>request_duration</code></p> <ul> <li>\u6dfb\u52a0fileter</li> </ul> <p></p> <p></p>"},{"location":"chap18/1ES_Certified_test/","title":"\u7b2c\u4e00\u8282 Elastic \u8ba4\u8bc1\u8003\u8bd5","text":""},{"location":"chap18/1ES_Certified_test/#1elastic","title":"1\u3001Elastic \u8ba4\u8bc1\u4ecb\u7ecd","text":""},{"location":"chap18/1ES_Certified_test/#1-1-elastic-certified-engineer","title":"1-1 Elastic Certified Engineer","text":"<ul> <li>Elastic Certified 2018 \u5e74 6 \u6708 29 \u65e5\u63a8\u51fa</li> <li>OPS Analyst:Coming soon......</li> <li>\u5f53\u524d\u8003\u8bd5\u4f7f\u7528\u7684 ES \u7248\u672c\u4e3a 7.2<ul> <li>2019 \u5e74 8\u67086\u65e5\u4ece 6.5 \u5347\u7ea7\u5230\u7248\u672c 7.2</li> </ul> </li> <li>\u8003\u8bd5\u5f62\u5f0f:3\u4e2a\u5c0f\u65f6\uff0c12\u9053\u5b9e\u6218\u9898\u3002\u76ee\u524d\u53ea\u652f\u6301\u5168\u82f1\u6587\u5f62\u5f0f<ul> <li>\u7efc\u5408\u6027\u7684 Hands-on Tasks</li> </ul> </li> </ul> <p>https://www.elastic.co/training/certification</p> <ul> <li>Elastic Certified Engineer</li> <li>Elastic Certified Analyst</li> <li>Elastic Certified Observability Engineer</li> </ul> <p> </p> <ul> <li>Elastic Certified Engineer: 7.2</li> <li>Elastic Certified Analyst: 7.6</li> <li>Elastic Certified Observability Engineer: coming soon!</li> </ul>"},{"location":"chap18/1ES_Certified_test/#1-2","title":"1-2 \u8003\u8bd5\u8986\u76d6\u5185\u5bb9","text":""},{"location":"chap18/1ES_Certified_test/#1-3","title":"1-3 \u6ce8\u518c","text":"<ul> <li>\u6ce8\u518c\u62a5\u540d:</li> </ul> <pre><code>* [https://training.elastic.co/exam/elastic-certified-engineer]()\n</code></pre> <ul> <li>\u9884\u7ea6\u540e\uff0c\u7f51\u4e0a\u5728\u7ebf\u8003\u8bd5</li> </ul>"},{"location":"chap18/1ES_Certified_test/#1-4","title":"1-4 \u9884\u7ea6\u7f51\u4e0a\u8003\u8bd5\u65f6\u95f4","text":"<ul> <li>\u6ce8\u518c email</li> <li>\u9009\u62e9\u65f6\u533a</li> <li>\u9884\u7ea6\u8003\u8bd5\u65f6\u95f4</li> <li>\u63d0\u524d 48 \u5c0f\u65f6\uff0c\u53d6\u6d88\u8003\u8bd5</li> </ul>"},{"location":"chap18/1ES_Certified_test/#1-5","title":"1-5 \u8003\u8bd5\u8fc7\u7a0b","text":"<p>\u8fdc\u7a0b\u8003\u8bd5</p> <ul> <li>\u63d0\u524d 20 \u5206\u949f\uff0c\u73af\u5883\u51c6\u5907\u4e0e\u68c0\u67e5</li> <li>\u5171\u4eab\u684c\u9762\u4e0e\u6444\u50cf\u5934\uff0c\u4f1a\u6709\u4e13\u4eba\u8fdc\u7a0b\u67e5\u770b</li> <li>\u8003\u8bd5\u524d\u9700\u8981\u6838\u5bf9 ID \u8bc1\u4ef6</li> <li>\u4e0d\u51c6\u6709\u5634\u90e8\u52a8\u4f5c:\u8bf4\u8bdd\uff0c\u5403\u4e1c\u897f\uff0c\u559d\u6c34 / \u4e0d\u5141\u8bb8\u6709\u5176\u4ed6\u7684\u7a0b\u5e8f\u5728\u540e\u53f0\u8fd0\u884c</li> <li>\u5bc6\u95ed\u623f\u95f4\u5185\uff0c\u8003\u8bd5\u671f\u95f4\u4e0d\u80fd\u6709\u5176\u4ed6\u4eba\u8fdb\u5165\uff0c\u9700\u8981\u4fdd\u6301\u684c\u9762\u5e72\u51c0\u6574\u9f50\uff0c\u6ca1\u6709\u5176\u4ed6\u7269\u54c1</li> </ul>"},{"location":"chap18/1ES_Certified_test/#1-6","title":"1-6 \u8003\u8bd5\u73af\u5883","text":"<ul> <li>\u6d4f\u89c8\u5668\u63a5\u5165\u865a\u62df\u673a\uff0c\u6240\u6709\u64cd\u4f5c\u90fd\u5728\u865a\u62df\u673a\u5185\u6267\u884c;\u865a\u62df\u673a\u5185\u53ef\u4ee5\u4f7f\u7528\u6d4f\u89c8\u5668\u8fde\u63a5 ES \u5b98\u65b9\u6587\u6863</li> <li>\u53ea\u9700\u4e00\u4e9b\u57fa\u672c\u7684 Linux \u547d\u4ee4<ul> <li>\u4f7f\u7528\u7ec8\u7aef SSH \u8fde\u63a5\u5230\u8003\u8bd5\u7528\u7684\u4e3b\u673a / Vim \u7f16\u8f91\u6587\u4ef6</li> </ul> </li> <li>\u672c\u673a\u90e8\u7f72\u4e86\u591a\u4e2a ES \u96c6\u7fa4\uff0c\u5747\u6709\u5b89\u88c5 Kibana<ul> <li>\u53ef\u4ee5\u4f7f\u7528 Dev Tool</li> <li>\u5b89\u5168\u7ba1\u7406\u529f\u80fd</li> <li>\u53ef\u89c6\u5316\u7ec4\u4ef6\u7684\u529f\u80fd\u88ab\u7981\u7528\u4e86</li> </ul> </li> </ul>"},{"location":"chap18/1ES_Certified_test/#1-7","title":"1-7 \u8003\u8bd5\u73af\u5883","text":""},{"location":"chap18/1ES_Certified_test/#1-8","title":"1-8 \u8003\u8bd5\u9898\u578b","text":""},{"location":"chap18/1ES_Certified_test/#1-9","title":"1-9 \u8ba4\u8bc1\u7684\u65f6\u6548\u6027","text":"<ul> <li>\u8ba4\u8bc1\u4e24\u5e74\u5185\u6709\u6548</li> <li>\u4f1a\u6301\u7eed\u63a8\u51fa\u65b0\u7684\u8ba4\u8bc1<ul> <li>Ops Analysis</li> <li>Logging Specialist</li> <li>Search Specialist</li> <li>Security Analysis</li> </ul> </li> </ul>"},{"location":"chap18/1ES_Certified_test/#2","title":"2\u3001\u8003\u70b9\u68b3\u7406","text":""},{"location":"chap18/1ES_Certified_test/#2-1","title":"2-1 \u8003\u9898\u5f62\u5f0f","text":"<p>\u96c6\u7fa4\u914d\u7f6e</p> <ul> <li>\u914d\u7f6e 3 \u4e2a\u8282\u70b9\u7684\u96c6\u7fa4\uff0c\u6307\u5b9a\u8282\u70b9\u7684\u540d\u5b57\u3002\u6309\u7167\u9700\u6c42\uff0c\u4e3a\u6bcf\u4e00\u4e2a\u8282\u70b9\u6307\u5b9a\u540d\u5b57;\u5e76\u4e14\u4e3a\u8282\u70b9\u6307\u5b9a\u7279\u5b9a\u7684\u89d2\u8272; \u4e3a\u8282\u70b9\u8bbe\u5b9a\u4e0d\u540c\u7684\u5c5e\u6027</li> <li>\u8bbe\u7f6e Hot &amp; Warm Architecture / \u4fee\u6539 JVM Heap \u914d\u7f6e / \u8bbe\u7f6e\u5b89\u5168\u4fdd\u62a4</li> </ul> <p>\u641c\u7d22\u4e0e\u805a\u5408</p> <ul> <li>\u7d22\u5f15\u4e2d\u5305\u542b\u4e86\u4e00\u5e74\u7684\u9500\u552e\u6570\u636e:</li> <li>\u627e\u51fa\u7684\u9500\u552e\u989d\u6700\u9ad8\u7684\u6708\u4efd\u7684\u603b\u9500\u552e\u989d\u662f\u591a\u5c11</li> <li>Match / Match Phrase / Highlight / Sorting / \u5206\u9875</li> </ul>"},{"location":"chap18/1ES_Certified_test/#2-2","title":"2-2 \u8003\u8bd5\u9898\u578b","text":""},{"location":"chap18/1ES_Certified_test/#2-3","title":"2-3 \u8003\u8bd5\u5efa\u8bae","text":"<ul> <li>\u4ed4\u7ec6\u9605\u8bfb\u8003\u7eb2\uff0c\u8bb0\u4f4f\u6bcf\u4e2a\u8003\u70b9\u7684\u5b98\u65b9\u6587\u6863\u4f4d\u7f6e</li> <li>\u6709\u65f6\u95f4\u53ef\u4ee5\u5c06\u76f8\u5173\u7684\u6559\u7a0b\u89c6\u9891\u8fdb\u884c\u5feb\u901f\u7684\u56de\u987e</li> <li>\u8003\u8bd5\u4e4b\u524d\uff0c\u9002\u5f53\u7684\u52a8\u624b\u505a\u4e00\u4e9b\u5b9e\u6218\uff0c\u9700\u8981\u7406\u89e3\u6bcf\u4e00\u4e2a\u8003\u70b9\uff0c\u5207\u52ff\u6b7b\u8bb0\u786c\u80cc</li> </ul>"},{"location":"chap18/1ES_Certified_test/#3","title":"3\u3001\u8003\u7eb2\u6574\u7406","text":""},{"location":"chap18/1ES_Certified_test/#3-1","title":"3-1 \u5b89\u88c5\u914d\u7f6e","text":"<p>1\u3001\u6839\u636e\u9700\u6c42\uff0c\u914d\u7f6e\u90e8\u7f72\u96c6\u7fa4</p> <ul> <li> <p>Setup Elasticsearch</p> <ul> <li>Installing Elasticsearch</li> <li>Configuring Elasticsearch</li> </ul> </li> <li> <p>Module </p> <ul> <li>Node</li> <li>Discovery and cluster formation </li> </ul> </li> </ul> <p>2\u3001\u914d\u7f6e\u96c6\u7fa4\u7684\u8282\u70b9</p> <ul> <li>Modules\uff1a Node</li> </ul> <p>3\u3001\u4e3a\u96c6\u7fa4\u8bbe\u7f6e\u5b89\u5168\u4fdd\u62a4</p> <ul> <li>Set up Elasticsearch: <code>Configuration &gt; Security settings</code></li> <li>\u96c6\u7fa4\u8eab\u4efd\u8ba4\u8bc1\u4e0e\u7528\u6237\u9274\u6743</li> <li>\u96c6\u7fa4\u5185\u90e8\u5b89\u5168\u901a\u4fe1</li> <li>\u96c6\u7fa4\u4e0e\u5916\u90e8\u95f4\u7684\u5b89\u5168\u901a\u4fe1</li> </ul> <p>4\u3001\u57fa\u4e8e X-Pack\uff0c\u4e3a\u96c6\u7fa4\u914d\u7f6e RBAC</p>"},{"location":"chap18/1ES_Certified_test/#3-2","title":"3-2 \u7d22\u5f15\u6570\u636e","text":"<p>1\u3001\u6839\u636e\u9700\u6c42\uff0c\u5b9a\u4e49\u4e00\u4e2a\u7d22\u5f15</p> <ul> <li>REST APIs</li> <li>Index APIs &gt; Create Index </li> <li>\u663e\u793a Mapping \u8bbe\u7f6e\u548c\u5e38\u89c1\u5b57\u6bb5\u7c7b\u578b</li> </ul> <p>2\u3001\u6267\u884c\u7d22\u5f15\u7684Index\uff0cCRUD</p> <ul> <li>\u6587\u6863\u7684\u57fa\u672cCRUD\u4e0e\u6279\u91cf\u64cd\u4f5c</li> </ul> <p>3\u3001\u5b9a\u4e49\u4e0e\u4f7f\u7528 Index Alias</p> <ul> <li>Index APIs\uff1a<ul> <li>Add Index  Alias / Delete Index Alias / Get Index Alias / Index Alias exists / Update Index Alias</li> <li>\u4f7f\u7528 Search Template \u548c Index Alias \u67e5\u8be2</li> </ul> </li> </ul> <p>4\u3001\u5b9a\u4e49\u4e0e\u4f7f\u7528 Index Teamplate</p> <ul> <li>Index APIs<ul> <li>Put index template / delete index template / get template index / index template exists</li> </ul> </li> <li>Index Template \u548c Dynamic Template</li> </ul> <p>5\u3001\u5b9a\u4e49\u4e0e\u4f7f\u7528 Dynamic Template</p> <ul> <li>Mapping<ul> <li>Dynamic Mapping &gt; Dynamic Templates</li> </ul> </li> <li>Index Template \u548c Dynamic Template</li> </ul> <p>6\u3001\u4f7f\u7528 Reindex API &amp; Update By Query \u91cd\u65b0\u7d22\u5f15\u6587\u6863</p> <ul> <li>Update By Query &amp; Reindex API</li> </ul> <p>7\u3001\u5b9a\u4e49 Ingest Pipeline\uff08\u5305\u62ec\u4f7f\u7528 Painless \u811a\u672c\uff09</p> <ul> <li> <p>Ingest Node </p> <ul> <li>Pipeline Definition / Ingest APIs</li> </ul> </li> <li> <p>Ingest Pipeline &amp;  Painless Script</p> </li> </ul>"},{"location":"chap18/1ES_Certified_test/#3-3","title":"3-3 \u67e5\u8be2","text":"<p>1\u3001\u4f7f\u7528 terms \u6216 phrase \u67e5\u8be2\u4e00\u4e2a\u6216\u591a\u4e2a\u5b57\u6bb5</p> <ul> <li>Query DSL</li> </ul> <p>2\u3001\u4f7f\u7528 Bool query</p> <p>3\u3001\u9ad8\u4eae\u67e5\u8be2\u7ed3\u679c</p> <p>4\u3001\u5bf9\u67e5\u8be2\u7ed3\u679c\u6392\u5e8f</p> <ul> <li>Search APIs\uff1a Request body search\uff1a sort</li> </ul> <p>5\u3001\u5bf9\u67e5\u8be2\u7ed3\u679c\u5206\u9875</p> <p>6\u3001\u4f7f\u7528 Scroll API</p> <ul> <li>Search APIs\uff1a Request body search\uff1a Scroll API</li> </ul> <p>7\u3001\u4f7f\u7528\u6a21\u7cca\u67e5\u8be2</p> <p>8\u3001\u4f7f\u7528 Search Template</p> <p>9\u3001\u8de8\u96c6\u7fa4\u641c\u7d22</p> <ul> <li>Search across clusters</li> <li>\u914d\u7f6e\u8de8\u96c6\u7fa4\u641c\u7d22</li> </ul>"},{"location":"chap18/1ES_Certified_test/#3-4","title":"3-4 \u805a\u5408","text":"<p>1\u3001metric &amp; Bucket Aggregation</p> <ul> <li>Aggregations<ul> <li>Bucket Aggregations<ul> <li>Metric Aggregations</li> <li>Bucket&amp; Metrix \u805a\u5408\u5206\u6790\u53ca\u5d4c\u5957\u805a\u5408</li> </ul> </li> </ul> </li> </ul> <p>2\u3001sub-aggregation</p> <ul> <li>Aggregations\uff08\u67e5\u770b Structuring Aggregations\uff09</li> <li>Bucket &amp; Metric \u805a\u5408\u5206\u6790\u53ca\u5d4c\u5957\u805a\u5408</li> </ul> <p>3\u3001pipeline aggregation</p> <ul> <li>Pipeline Aggregations</li> <li>Pipeline \u805a\u5408\u5206\u6790</li> </ul>"},{"location":"chap18/1ES_Certified_test/#3-5","title":"3-5 \u6620\u5c04\u4e0e\u5206\u8bcd","text":"<p>1\u3001\u6309\u9700\u5b9a\u4e49\u7d22\u5f15 mapping</p> <ul> <li>REST APIs\uff1a Index APIs &gt; Put Mapping</li> </ul> <p>2\u3001\u6309\u9700\u81ea\u5b9a\u4e49 analyzer</p> <ul> <li>Mapping\uff1a Mapping parameters\uff1a fields</li> </ul> <p>3\u3001\u4e3a\u5b57\u6bb5\u5b9a\u4e49\u591a\u5b57\u6bb5\u7c7b\u578b\uff08\u4e0d\u540c\u7684\u5b57\u6bb5\u4f7f\u7528\u4e0d\u540c\u7684 type \u548c analyzer\uff09</p> <p>4\u3001\u5b9a\u4e49\u548c\u67e5\u8be2 nested \u6587\u6863</p> <p>5\u3001\u5b9a\u4e49\u53ca\u67e5\u8be2 parent/child \u6587\u6863 </p> <ul> <li>Mapping\uff1a Join</li> </ul>"},{"location":"chap18/1ES_Certified_test/#3-6","title":"3-6 \u96c6\u7fa4\u7ba1\u7406","text":"<p>1\u3001\u6309\u9700\u5c06\u7d22\u5f15\u7684\u5206\u7247\u5206\u914d\u5230\u7279\u5b9a\u7684\u8282\u70b9</p> <p>2\u3001\u4e3a\u7d22\u5f15\u914d\u7f6e Shard allocation awareness &amp; Force awareness</p> <p>3\u3001\u8bca\u65ad\u5206\u7247\u7684\u95ee\u9898\uff0c\u6062\u590d\u96c6\u7fa4\u7684health \u72b6\u6001</p> <p>4\u3001Backup &amp; Restore \u96c6\u7fa4\u6216\u8005\u7279\u5b9a\u7684\u7d22\u5f15</p> <ul> <li>Administering Elasticsearch &gt; Back up a cluster</li> <li>Modules &gt; Snapshot and Restore</li> </ul> <p>5\u3001\u914d\u7f6e\u4e00\u4e2a hot &amp; warm \u67b6\u6784\u7684\u96c6\u7fa4</p> <p>6\u3001\u914d\u7f6e\u8de8\u96c6\u7fa4\u641c\u7d22</p> <ul> <li>Cross-cluster search</li> <li>\u914d\u7f6e\u8de8\u96c6\u7fa4\u641c\u7d22</li> </ul>"},{"location":"chap18/1ES_Certified_test/#4","title":"4\u3001\u6a21\u62df\u6d4b\u8bd5","text":""},{"location":"chap18/1ES_Certified_test/#4-1","title":"4-1 \u5b89\u88c5\u914d\u7f6e","text":"<p>1\u3001\u90e8\u7f72 3 \u8282\u70b9\u7684\u96c6\u7fa4\uff0c\u9700\u8981\u540c\u65f6\u6ee1\u8db3\u4ee5\u4e0b\u8981\u6c42</p> <ul> <li>cluster.name</li> <li>\u5c06\u6bcf\u4e2a\u8282\u70b9\u7684\u540d\u5b57\u8bbe\u4e3a\u548c\u673a\u5668\u540d\u4e00\u6837\uff0c\u5206\u522b\u4e3a node1\uff0cnode2\uff0cnode3<ul> <li>node.name</li> </ul> </li> <li>node1 \u914d\u7f6e\u6210<code>dedicated master-eligable</code>\u8282\u70b9</li> <li>node2\u548cnode3\u914d\u7f6e\u6210 ingest \u548c data node<ul> <li>\u8bb0\u5f97\u8981\u5c06 node.ml \u8bbe\u7f6e\u6210 false</li> </ul> </li> <li>\u8bbe\u7f6e jvm \u4e3a1g<ul> <li>\u8bbe\u7f6e jvm.options</li> </ul> </li> </ul> <p>2\u3001\u914d\u7f6e 3\u8282\u70b9\u7684\u96c6\u7fa4\uff0c\u52a0\u4e0a\u4e00\u4e2a Kibana \u7684\u5b9e\u4f8b\uff0c\u8bbe\u5b9a\u4ee5\u4e0b\u5b89\u5168\u9632\u62a4</p> <ul> <li>\u4e3a\u96c6\u7fa4\u914d\u7f6e basic authentication</li> <li>\u5c06 Kibana \u8fde\u63a5\u5230 Elasticsearch</li> <li>\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a es \u7684\u7528\u6237</li> <li>\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a orders \u7684\u7d22\u5f15</li> <li>es \u7528\u6237\u53ea\u80fd\u8bfb\u53d6\u548c\u5199\u5165 orders \u7684\u7d22\u5f15\uff0c\u4e0d\u80fd\u5220\u9664\u53ca\u4fee\u6539 orders</li> </ul> <p>3\u3001\u914d\u7f6e 3\u8282\u70b9\u7684\u96c6\u7fa4\uff0c\u540c\u65f6\u6ee1\u8db3\u4ee5\u4e0b\u8981\u6c42</p> <ul> <li>\u786e\u4fdd\u7d22\u5f15 A \u7684\u5206\u7247\u5168\u90e8\u843d\u5728\u5728\u8282\u70b91</li> <li>\u7d22\u5f15 B \u5206\u7247\u5168\u90e8\u843d\u5728 \u8282\u70b9 2\u548c3</li> <li>\u4e0d\u5141\u8bb8\u5220\u9664\u6570\u636e\u7684\u60c5\u51b5\u4e0b\uff0c\u4fdd\u8bc1\u96c6\u7fa4\u72b6\u6001\u4e3a Green</li> </ul>"},{"location":"chap18/1ES_Certified_test/#4-2","title":"4-2 \u7d22\u5f15\u6570\u636e","text":"<p>1\u3001\u4e3a\u4e00\u4e2a\u7d22\u5f15\uff0c\u6309\u8981\u6c42\u8bbe\u7f6e\u4ee5\u4e0b dynamic Mapping</p> <ul> <li>\u4e00\u5207 text \u7c7b\u578b\u7684\u5b57\u6bb5\uff0c\u7c7b\u578b\u5168\u90e8\u6620\u5c04\u6210 keyword</li> <li>\u4e00\u5207\u4ee5 <code>int_</code> \u5f00\u5934\u547d\u540d\u7684\u5b57\u6bb5\uff0c\u7c7b\u578b\u90fd\u8bbe\u7f6e\u6210 integer</li> </ul> <p>2\u3001\u8bbe\u7f6e\u4e00\u4e2aIndex Template\uff0c\u7b26\u5408\u4ee5\u4e0b\u7684\u8981\u6c42</p> <ul> <li>\u4e3a log \u548clog- \u5f00\u5934\u7684\u7d22\u5f15\u3002\u521b\u5efa 3 \u4e2a\u4e3b\u5206\u7247\uff0c1 \u4e2a\u526f\u672c\u5206\u7247</li> <li>\u540c\u65f6\u4e3a\u7d22\u5f15\u521b\u5efa\u4e00\u4e2a\u76f8\u5e94\u7684 alias</li> <li>\u4f7f\u7528 bulk API\uff0c\u5199\u5165\u591a\u6761\u7535\u5f71\u6570\u636e</li> </ul> <p>3\u3001\u4e3a movies index \u8bbe\u5b9a\u4e00\u4e2a Index Alias\uff0c\u9ed8\u8ba4\u67e5\u8be2\u53ea\u8fd4\u56de\u8bc4\u5206\u5927\u4e8e3\u7684\u7535\u5f71</p> <p>4\u3001\u7ed9\u4e00\u4e2a\u7d22\u5f15 A\uff0c\u8981\u6c42\u521b\u5efa\u7d22\u5f15 B\uff0c\u901a\u8fc7 Reindex API\uff0c\u5c06\u7d22\u5f15 A \u4e2d\u7684\u6587\u6863\u5199\u5165\u7d22\u5f15 B\uff0c\u540c\u65f6\u6ee1\u8db3\u4ee5\u4e0b\u8981\u6c42</p> <ul> <li>\u589e\u52a0\u4e00\u4e2a\u6574\u5f62\u5b57\u6bb5\uff0c\u5c06\u7d22\u5f15 A\u4e2d\u7684\u4e00\u4e2a\u5b57\u6bb5\u7684\u5b57\u7b26\u4e32\u957f\u5ea6\uff0c\u8ba1\u7b97\u540e\u5199\u5165</li> <li>\u5c06 A \u6587\u6863\u4e2d\u7684\u5b57\u7b26\u4e32\u4ee5<code>\u201c;\u201d</code>\u5206\u9694\u540e\uff0c\u5199\u5165\u7d22\u5f15B\u4e2d\u7684\u6570\u7ec4\u5b57\u6bb5\u4e2d</li> </ul> <p>5\u3001\u5b9a\u4e49\u4e00\u4e2a Pipeline\uff0c\u5e76\u4e14\u5c06 eathquakes \u7d22\u5f15\u7684\u6587\u6863\u8fdb\u884c\u66f4\u65b0</p> <ul> <li>pipeline\u7684 ID \u4e3a <code>eathquakes_pipeline</code></li> <li>\u5c06 <code>magnitude_type</code> \u7684\u5b57\u6bb5\u503c\u6539\u4e3a\u5927\u5199</li> <li>\u5982\u679c\u6587\u6863\u4e0d\u5305\u542b <code>\u201cbatch_number\u201d</code>, \u589e\u52a0\u8fd9\u4e2a\u5b57\u6bb5\uff0c\u5c06\u6570\u503c\u8bbe\u7f6e\u4e3a 1</li> <li>\u5982\u679c\u5df2\u7ecf\u5305\u542b <code>batch_number</code>, \u5b57\u6bb5\u503c<code>+1</code></li> </ul> <p>6\u3001\u4e3a\u7d22\u5f15\u4e2d\u7684\u6587\u6863\u589e\u52a0\u4e00\u4e2a\u65b0\u7684\u5b57\u6bb5\uff0c\u5b57\u6bb5\u503c\u4e3a\u73b0\u6709\u5b57\u6bb51+\u73b0\u6709\u5b57\u6bb52+\u73b0\u6709\u5b57\u6bb53</p>"},{"location":"chap18/1ES_Certified_test/#4-3","title":"4-3 \u67e5\u8be2","text":"<p>1\u3001\u5199\u4e00\u4e2a\u67e5\u8be2\uff0c\u8981\u6c42\u67d0\u4e2a\u5173\u952e\u5b57\u5728\u6587\u6863\u7684 4 \u4e2a\u5b57\u6bb5\u4e2d\u81f3\u5c11\u5305\u542b\u4e24\u4e2a\u4ee5\u4e0a</p> <ul> <li>bool \u67e5\u8be2\uff0cshould / <code>minimum_should_match</code></li> </ul> <p>2\u3001\u6309\u7167\u8981\u6c42\u5199\u4e00\u4e2a search template</p> <ul> <li>\u5199\u5165 search template</li> <li>\u6839\u636e search template \u5199\u51fa\u76f8\u5e94\u7684 query</li> </ul> <p>3\u3001\u5bf9\u4e00\u4e2a\u6587\u6863\u7684\u591a\u4e2a\u5b57\u6bb5\u8fdb\u884c\u67e5\u8be2\uff0c\u8981\u6c42\u6700\u7ec8\u7684\u7b97\u5206\u662f\u51e0\u4e2a\u5b57\u6bb5\u4e0a\u7b97\u5206\u7684\u603b\u548c\uff0c\u540c\u65f6\u8981\u6c42\u5bf9\u7279\u5b9a\u5b57\u6bb5\u8bbe\u7f6e boosting \u503c</p> <p>4\u3001\u9488\u5bf9\u4e00\u4e2a\u7d22\u5f15\u8fdb\u884c\u67e5\u8be2\uff0c\u5f53\u7d22\u5f15\u7684\u6587\u6863\u4e2d\u5b58\u5728\u5bf9\u8c61\u6570\u7ec4\u65f6\uff0c\u4f1a\u641c\u7d22\u5230\u4e86\u4e0d\u671f\u671b\u7684\u6570\u636e\u3002\u9700\u8981\u91cd\u65b0\u5b9a\u4e49 mapping\uff0c\u5e76\u63d0\u4f9b\u6539\u5199\u540e</p> <ul> <li>Nested Object</li> </ul>"},{"location":"chap18/1ES_Certified_test/#4-4","title":"4-4 \u805a\u5408","text":"<p>1\u3001earthquakes\u7d22\u5f15\u4e2d\u5305\u542b\u4e86\u8fc7\u53bb11\u4e2a\u6708\u7684\u5730\u9707\u4fe1\u606f\uff0c\u8bf7\u901a\u8fc7\u4e00\u53e5\u67e5\u8be2\uff0c\u83b7\u53d6\u4ee5\u4e0b\u4fe1\u606f</p> <ul> <li>\u8fc7\u53bb11\u4e2a\u6708\uff0c\u6bcf\u4e2a\u6708\u7684\u5e73\u5747 \u5730\u9707\u7b49\u7ea7\uff08magiitude\uff09</li> <li>\u8fc7\u53bb11\u4e2a\u6708\u91cc\uff0c\u5e73\u5747\u5730\u9707\u7b49\u7ea7\u6700\u9ad8\u7684\u4e00\u4e2a\u6708\u53ca\u5176\u5e73\u5747\u5730\u9707\u7b49\u7ea7</li> <li>\u641c\u7d22\u4e0d\u80fd\u8fd4\u56de\u4efb\u4f55\u6587\u6863</li> </ul> <p>2\u3001Query Fileter Bucket Filter</p> <p>3\u3001Pipeline Aggregation -&gt; Bucket Filter</p>"},{"location":"chap18/1ES_Certified_test/#4-5","title":"4-5 \u6620\u5c04\u4e0e\u5206\u8bcd","text":"<ul> <li> <p>\u4e00\u7bc7\u6587\u6863\uff0c\u5b57\u6bb5\u5185\u5bb9\u5305\u62ec\u4e86 \u201chello &amp; world\u201d\uff0c\u7d22\u5f15\u540e\uff0c\u8981\u6c42\u4f7f\u7528 <code>match_phrase query</code>, \u67e5\u8be2 hello &amp; world \u6216\u8005 hello and world \u90fd\u80fd\u5339\u914d</p> </li> <li> <p>reindex \u7d22\u5f15\uff0c\u540c\u65f6\u786e\u4fdd\u7ed9\u5b9a\u7684\u4e24\u4e2a\u67e5\u8be2\uff0c\u90fd\u80fd\u641c\u7d22\u5230\u76f8\u5173\u7684\u6587\u6863\uff0c\u5e76\u4e14\u6587\u6863\u7684\u7b97\u5206\u662f\u4e00\u6837\u7684</p> <ul> <li>match \u67e5\u8be2\uff0c\u5206\u522b\u67e5 \u201csmith's\u201d \uff0c\u201csmiths\u201d</li> <li>\u5728\u4e0d\u6539\u53d8\u5b57\u6bb5\u7684\u5c5e\u6027\uff0c\u5c06\u6570\u636e\u7d22\u5f15\u5230\u65b0\u7684\u7d22\u5f15\u4e0a</li> <li>\u786e\u4fdd\u4e24\u4e2a\u67e5\u8be2\u6709\u4e00\u81f4\u7684\u641c\u7d22\u7ed3\u679c\u548c\u7b97\u5206 </li> </ul> </li> </ul>"},{"location":"chap18/1ES_Certified_test/#4-6","title":"4-6 \u96c6\u7fa4\u7ba1\u7406","text":"<ul> <li> <p>\u5b89\u88c5\u5e76\u914d\u7f6e \u4e00\u4e2a hot &amp; warm \u67b6\u6784\u7684\u96c6\u7fa4</p> <ul> <li>\u4e09\u4e2a\u8282\u70b9\uff0c node 1 \u4e3a hot \uff0c node2 \u4e3a warm\uff0cnode 3 \u4e3acold</li> <li>\u4e09\u4e2a\u8282\u70b9\u5747\u4e3a master-eligable \u8282\u70b9</li> <li>\u65b0\u521b\u5efa\u7684\u7d22\u5f15\uff0c\u6570\u636e\u5199\u5165 hot \u8282\u70b9</li> <li>\u901a\u8fc7\u4e00\u6761\u547d\u4ee4\uff0c\u5c06\u6570\u636e\u4ece hot \u8282\u70b9\u79fb\u52a8\u5230 warm \u8282\u70b9</li> </ul> </li> <li> <p>\u4e3a\u4e24\u4e2a\u96c6\u7fa4\u914d\u7f6e\u8de8\u96c6\u7fa4\u641c\u7d22</p> <ul> <li>\u4e24\u4e2a\u96c6\u7fa4\u90fd\u6709 movies \u7684\u7d22\u5f15</li> <li>\u521b\u5efa\u8de8\u96c6\u7fa4\u641c\u7d22</li> <li>\u521b\u5efa\u4e00\u6761\u67e5\u8be2\uff0c\u80fd\u591f\u540c\u65f6\u67e5\u5230\u4e24\u4e2a\u96c6\u7fa4\u4e0a\u7684 movies \u6570\u636e</li> </ul> </li> <li>\u89e3\u51b3\u96c6\u7fa4\u53d8\u7ea2\u6216\u8005\u53d8\u9ec4\u7684\u95ee\u9898<ul> <li>\u6280\u80fd1\uff1a\u901a\u8fc7 explain API \u67e5\u770b</li> <li>\u6280\u80fd2\uff1ashard filtering API\uff0c\u67e5\u770b include</li> <li>\u6280\u80fd3\uff1a \u66f4\u65b0\u4e00\u4e0b routing\uff0c\u786e\u8ba4 replica \u53ef\u4ee5\u5206\u914d\uff08include \u66f4\u52a0\u591a\u7684 rack\uff09</li> </ul> </li> <li>\u89e3\u51b3\u65b9\u6848\uff1a<ul> <li>\u4e3a\u96c6\u7fa4\u914d\u7f6e\u5ef6\u8fdf\u5206\u914d\u548c\u4e00\u4e2a\u8282\u70b9\u4e0a\u6700\u591a\u51e0\u4e2a\u5206\u7247\u7684\u914d\u7f6e</li> <li>\u8bbe\u7f6e Replica \u4e3a 0</li> <li>\u5220\u9664 dangling index</li> <li>\u4f7f\u7528\u4e86\u9519\u8bef\u7684 routing node attribute</li> </ul> </li> <li>\u5907\u4efd\u4e00\u4e2a\u96c6\u7fa4\u4e2d\u6307\u5b9a\u7684\u51e0\u4e2a\u7d22\u5f15</li> </ul>"},{"location":"chap18/2ES_backup_restore/","title":"\u7b2c\u4e8c\u8282 \u96c6\u7fa4 Backup &amp; Restore","text":""},{"location":"chap18/2ES_backup_restore/#1","title":"1\u3001\u96c6\u7fa4\u7684\u5907\u4efd\u4e0e\u6062\u590d","text":""},{"location":"chap18/2ES_backup_restore/#2-repository","title":"2\u3001\u6ce8\u518c Repository","text":"<p>Elasticsearch.yml \u52a0\u5165\u76f8\u5173\u7684\u914d\u7f6e</p> <pre><code>path.repo: [\"/home/vagrant/bak\"]\n</code></pre> <pre><code>PUT /_snapshot/my_fs_backup\n{\n    \"type\": \"fs\",\n    \"settings\": {\n        \"location\": \"/home/vagrant/bak\",\n        \"compress\": true\n    }\n}\n</code></pre> <p>\u8fd8\u652f\u6301 Amazon S3, HDFS, Google Cloud Storage \u7b49\u5b58\u50a8\u65b9\u5f0f</p>"},{"location":"chap18/2ES_backup_restore/#3","title":"3\u3001\u5feb\u7167\u7684\u7248\u672c\u517c\u5bb9","text":""},{"location":"chap18/2ES_backup_restore/#4backup-restore-demo","title":"4\u3001Backup &amp; Restore Demo","text":""},{"location":"chap18/2ES_backup_restore/#4-1-repository","title":"4-1 \u4fee\u6539\u6ce8\u518c Repository \u914d\u7f6e","text":"<pre><code>cd /etc/elasticsearch\nvim elasticsearch.yml\n\npath.repo: [\"/home/vagrant/bak\"]\n</code></pre>"},{"location":"chap18/2ES_backup_restore/#4-2-elasticsearch-kibana","title":"4-2 \u542f\u52a8Elasticsearch &amp; kibana","text":"<pre><code>elasticsearch -E node.name=node0 -E cluster.name=jx -E path.data=node0_data -d\nelasticsearch -E node.name=node1 -E cluster.name=jx -E path.data=node1_data -d\nelasticsearch -E node.name=node2 -E cluster.name=jx -E path.data=node2_data -d\n</code></pre> <pre><code>nohup kibana \n</code></pre>"},{"location":"chap18/2ES_backup_restore/#4-3-repositoty","title":"4-3 \u521b\u5efa\u4e00\u4e2a repositoty","text":"<pre><code># \u521b\u5efa\u4e00\u4e2a repositoty\nPUT /_snapshot/my_fs_backup\n{\n    \"type\": \"fs\",\n    \"settings\": {\n        \"location\": \"/home/vagrant/bak\",\n        \"compress\": true\n    }\n}\n</code></pre>"},{"location":"chap18/2ES_backup_restore/#4-4-snapshot","title":"4-4 \u521b\u5efa\u4e00\u4e2asnapshot","text":"<pre><code># \u521b\u5efa\u4e00\u4e2asnapshot\nPUT /_snapshot/my_fs_backup/snapshot_1?wait_for_completion=true\n</code></pre> <p>Output:</p> <pre><code>{\n  \"snapshot\" : {\n    \"snapshot\" : \"snapshot_1\",\n    \"uuid\" : \"Tz7tdndGR6i9BPXlRg3L1w\",\n    \"version_id\" : 7100199,\n    \"version\" : \"7.10.1\",\n    \"indices\" : [\n      \"my_index\",\n      \"kibana_sample_data_ecommerce\",\n      \".async-search\",\n      \"kibana_sample_data_flights\",\n      \".kibana_1\",\n      \".kibana-event-log-7.9.1-000002\",\n      \".apm-agent-configuration\",\n      \".kibana-event-log-7.9.1-000001\",\n      \"kibana_sample_data_logs\",\n      \"ilm-history-2-000001\",\n      \"ilm-history-2-000002\",\n      \"log-2020.11.24\",\n      \".apm-custom-link\",\n      \"log-2020.11.23\",\n      \".kibana_task_manager_1\",\n      \"my_index1\"\n    ],\n    \"data_streams\" : [ ],\n    \"include_global_state\" : true,\n    \"state\" : \"SUCCESS\",\n    \"start_time\" : \"2020-12-26T16:55:36.839Z\",\n    \"start_time_in_millis\" : 1609001736839,\n    \"end_time\" : \"2020-12-26T16:55:39.866Z\",\n    \"end_time_in_millis\" : 1609001739866,\n    \"duration_in_millis\" : 3027,\n    \"failures\" : [ ],\n    \"shards\" : {\n      \"total\" : 17,\n      \"failed\" : 0,\n      \"successful\" : 17\n    }\n  }\n}\n</code></pre>"},{"location":"chap18/2ES_backup_restore/#4-5","title":"4-5 \u6307\u5b9a\u7d22\u5f15\u521b\u5efa\u5feb\u7167","text":"<pre><code># \u6307\u5b9a\u7d22\u5f15\u521b\u5efa\u5feb\u7167\nPUT /_snapshot/my_fs_backup/snapshot_2?wait_for_completion=true\n{\n  \"indices\": \"my_index\",\n  \"ignore_unavailable\": true,\n  \"include_global_state\": false,\n  \"metadata\": {\n    \"taken_by\": \"jacob\",\n    \"taken_because\": \"backup before upgrading\"\n  }\n}\n</code></pre> <p>Output:</p> <pre><code>\"snapshot\" : {\n    \"snapshot\" : \"snapshot_2\",\n    \"uuid\" : \"HtIH5dRHR0OxzBaMvi444w\",\n    \"version_id\" : 7100199,\n    \"version\" : \"7.10.1\",\n    \"indices\" : [\n      \"my_index\"\n    ],\n    \"data_streams\" : [ ],\n    \"include_global_state\" : false,\n    \"metadata\" : {\n      \"taken_by\" : \"jacob\",\n      \"taken_because\" : \"backup before upgrading\"\n    },\n    \"state\" : \"SUCCESS\",\n    \"start_time\" : \"2020-12-26T17:05:17.350Z\",\n    \"start_time_in_millis\" : 1609002317350,\n    \"end_time\" : \"2020-12-26T17:05:17.551Z\",\n    \"end_time_in_millis\" : 1609002317551,\n    \"duration_in_millis\" : 201,\n    \"failures\" : [ ],\n    \"shards\" : {\n      \"total\" : 1,\n      \"failed\" : 0,\n      \"successful\" : 1\n    }\n  }\n}\n</code></pre>"},{"location":"chap18/2ES_backup_restore/#4-6","title":"4-6 \u67e5\u770b\u6240\u6709\u7684\u5feb\u7167","text":"<pre><code># \u67e5\u770b\u6240\u6709\u7684\u5feb\u7167\nGET /_snapshot/my_fs_backup/_all\n</code></pre> <p>Output:</p> <pre><code>{\n  \"snapshots\" : [\n    {\n      \"snapshot\" : \"snapshot_1\",\n      \"uuid\" : \"Tz7tdndGR6i9BPXlRg3L1w\",\n      \"version_id\" : 7100199,\n      \"version\" : \"7.10.1\",\n      \"indices\" : [\n        \"my_index\",\n        \"kibana_sample_data_ecommerce\",\n        ....\n        \"my_index1\"\n      ],\n      \"data_streams\" : [ ],\n      \"include_global_state\" : true,\n      \"state\" : \"SUCCESS\",\n      \"start_time\" : \"2020-12-26T16:55:36.839Z\",\n      \"start_time_in_millis\" : 1609001736839,\n      \"end_time\" : \"2020-12-26T16:55:39.866Z\",\n      \"end_time_in_millis\" : 1609001739866,\n      \"duration_in_millis\" : 3027,\n      \"failures\" : [ ],\n      \"shards\" : {\n        \"total\" : 17,\n        \"failed\" : 0,\n        \"successful\" : 17\n      }\n    },\n    {\n      \"snapshot\" : \"snapshot_2\",\n      \"uuid\" : \"HtIH5dRHR0OxzBaMvi444w\",\n      \"version_id\" : 7100199,\n      \"version\" : \"7.10.1\",\n      \"indices\" : [\n        \"my_index\"\n      ],\n      \"data_streams\" : [ ],\n      \"include_global_state\" : false,\n      \"metadata\" : {\n        \"taken_by\" : \"jacob\",\n        \"taken_because\" : \"backup before upgrading\"\n      },\n      \"state\" : \"SUCCESS\",\n      \"start_time\" : \"2020-12-26T17:05:17.350Z\",\n      \"start_time_in_millis\" : 1609002317350,\n      \"end_time\" : \"2020-12-26T17:05:17.551Z\",\n      \"end_time_in_millis\" : 1609002317551,\n      \"duration_in_millis\" : 201,\n      \"failures\" : [ ],\n      \"shards\" : {\n        \"total\" : 1,\n        \"failed\" : 0,\n        \"successful\" : 1\n      }\n    }\n  ]\n}\n</code></pre>"},{"location":"chap18/2ES_backup_restore/#4-7","title":"4-7 \u5220\u9664\u5feb\u7167","text":"<pre><code>DELETE /_snapshot/my_fs_backup/snapshot_2\n</code></pre> <pre><code>POST /_snapshot/my_fs_backup/snapshot_1/_restore\n{\n\n}\n</code></pre> <p>Output:</p> <p>because an open index with same name already exists in the cluster.</p> <pre><code>{\n  \"error\" : {\n    \"root_cause\" : [\n      {\n        \"type\" : \"snapshot_restore_exception\",\n        \"reason\" : \"[my_fs_backup:snapshot_1/Tz7tdndGR6i9BPXlRg3L1w] cannot restore index [.kibana-event-log-7.9.1-000002] because an open index with same name already exists in the cluster. Either close or delete the existing index or restore the index under a different name by providing a rename pattern and replacement name\"\n      }\n    ],\n    \"type\" : \"snapshot_restore_exception\",\n    \"reason\" : \"[my_fs_backup:snapshot_1/Tz7tdndGR6i9BPXlRg3L1w] cannot restore index [.kibana-event-log-7.9.1-000002] because an open index with same name already exists in the cluster. Either close or delete the existing index or restore the index under a different name by providing a rename pattern and replacement name\"\n  },\n  \"status\" : 500\n}\n</code></pre>"},{"location":"chap18/2ES_backup_restore/#4-8","title":"4-8 \u56de\u590d\u5feb\u7167","text":"<pre><code>DELETE my_index\n\nPOST /_snapshot/my_fs_backup/snapshot_1/_restore\n{\n  \"indices\": \"my_index\",\n  \"index_settings\": {\n    \"index.number_of_replicas\": 5\n  },\n  \"ignore_index_settings\": [\n    \"index.refresh_interval\"\n  ]\n}\n</code></pre> <p>Output:</p> <pre><code>{\n  \"accepted\" : true\n}\n</code></pre> <pre><code>DELETE /_snapshot/my_fs_backup/snapshot_1\n</code></pre>"},{"location":"chap18/2ES_backup_restore/#4-9","title":"4-9 \u67e5\u770b\u5feb\u7167\u6587\u4ef6","text":"<pre><code>cd /home/vagrant/bak\n\n$ ls\nindex-2  index.latest  indices  meta-Tz7tdndGR6i9BPXlRg3L1w.dat  snap-Tz7tdndGR6i9BPXlRg3L1w.dat\n</code></pre>"},{"location":"chap18/3ES_Java/","title":"\u7b2c\u4e09\u8282 \u57fa\u4e8e Java \u548c Elasticsearch \u5f00\u53d1\u5e94\u7528","text":""},{"location":"chap18/3ES_Java/#1java-low-level-client","title":"1\u3001Java Low Level Client","text":"<p>https://www.elastic.co/guide/en/elasticsearch/client/java-rest/master/java-rest-low.html</p> <p></p> <p>https://snapshots.elastic.co/javadoc/org/elasticsearch/client/elasticsearch-rest-client/8.0.0-SNAPSHOT/org/elasticsearch/client/package-summary.html</p>"},{"location":"chap18/3ES_Java/#2maven-gradle-configuration","title":"2\u3001Maven &amp; Gradle Configuration","text":""},{"location":"chap18/3ES_Java/#3java-high-level-client","title":"3\u3001Java High Level Client","text":"<ul> <li>\u4ece6.0\u5f00\u59cb\u63d0\u4f9b</li> <li>\u57fa\u4e8e Low Level REST Client \u6784\u5efa<ul> <li>\u66b4\u9732 API\uff0cQuery DSL \u76f8\u5173\u7684\u65b9\u6cd5\uff0c\u8fd4\u56de\u5bf9\u5e94\u7684 Response \u5bf9\u8c61</li> </ul> </li> <li>\u652f\u6301\u540c\u6b65\u548c\u5f02\u6b65\u8c03\u7528<ul> <li>Synchronous methods \u8fd4\u56de Response \u5bf9\u8c61</li> <li>Async \u524d\u7f00\u7684\u65b9\u6cd5\uff0c\u662f\u5f02\u6b65\u8c03\u7528\uff0c\u9700\u8981\u5728\u53c2\u6570\u4e2d\u63d0\u4f9b listener</li> </ul> </li> </ul>"},{"location":"chap18/3ES_Java/#4elasticsearch-spring-data","title":"4\u3001Elasticsearch Spring Data","text":"<ul> <li>https://github.com/spring-projects/spring-data-elasticsearch</li> <li>Java Based @Configuration for ES client</li> <li>\u81ea\u52a8\u5b9e\u73b0 Repository \u63a5\u53e3\uff0c\u5b9e\u73b0\u57fa\u672c CRUD</li> </ul>"},{"location":"chap18/4ES_migration/","title":"\u7b2c\u56db\u8282 3\u79cd Elasticsearch \u6570\u636e\u79bb\u7ebf\u8fc1\u79fb\u65b9\u6848","text":"<p>\u5982\u679c\u51c6\u5907\u5c06\u81ea\u5efa\u7684elasticsearch\u8fc1\u79fb\u4e0a\u4e91\uff0c\u6216\u8005\u7684\u8fc1\u79fb\u5230\u5176\u4ed6es\u96c6\u7fa4\u5185\uff0c\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u4e1a\u52a1\u9700\u8981\u9009\u62e9\u5408\u9002\u7684\u8fc1\u79fb\u65b9\u6848\u3002\u5982\u679c\u4e1a\u52a1\u53ef\u4ee5\u505c\u670d\u6216\u8005\u53ef\u4ee5\u6682\u505c\u5199\u64cd\u4f5c\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u51e0\u79cd\u65b9\u5f0f\u8fdb\u884c\u6570\u636e\u8fc1\u79fb</p> <ul> <li>COS \u5feb\u7167,\u5373Cloud Object Storage</li> <li>logstash</li> <li>elasticsearch-dump</li> </ul> <p>\u5404\u79cd\u8fc1\u79fb\u65b9\u5f0f\u7684\u5bf9\u6bd4\u5982\u4e0b\uff1a</p> <p></p>"},{"location":"chap18/4ES_migration/#1-cos","title":"1 COS\u5feb\u7167","text":"<p>\u57fa\u4e8e COS \u5feb\u7167\u7684\u8fc1\u79fb\u65b9\u5f0f\u662f\u4f7f\u7528 ES \u7684 snapshot api \u63a5\u53e3\u8fdb\u884c\u8fc1\u79fb\uff0c\u57fa\u672c\u539f\u7406\u5c31\u662f\u4ece\u6e90 ES \u96c6\u7fa4\u521b\u5efa\u7d22\u5f15\u5feb\u7167\uff0c\u7136\u540e\u5728\u76ee\u6807 ES \u96c6\u7fa4\u4e2d\u8fdb\u884c\u6062\u590d\u3002\u901a\u8fc7 snapshot \u65b9\u5f0f\u8fdb\u884c\u6570\u636e\u8fc1\u79fb\u65f6\uff0c\u7279\u522b\u9700\u8981\u6ce8\u610f ES \u7684\u7248\u672c\u95ee\u9898\uff1a</p> <pre><code>\u76ee\u6807 ES \u96c6\u7fa4\u7684\u4e3b\u7248\u672c\u53f7\uff08\u59825.6.4\u4e2d\u76845\u4e3a\u4e3b\u7248\u672c\u53f7\uff09\u8981\u5927\u4e8e\u7b49\u4e8e\u6e90 ES \u96c6\u7fa4\u7684\u4e3b\u7248\u672c\u53f7\u3002\n1.x \u7248\u672c\u7684\u96c6\u7fa4\u521b\u5efa\u7684\u5feb\u7167\u4e0d\u80fd\u5728 5.x \u7248\u672c\u4e2d\u6062\u590d\u3002\n</code></pre>"},{"location":"chap18/4ES_migration/#esrepository","title":"\u5728\u6e90ES\u96c6\u7fa4\u4e2d\u521b\u5efarepository","text":"<p>\u521b\u5efa\u5feb\u7167\u524d\u5fc5\u987b\u5148\u521b\u5efa repository \u4ed3\u5e93\uff0c\u4e00\u4e2a repository \u4ed3\u5e93\u53ef\u4ee5\u5305\u542b\u591a\u4efd\u5feb\u7167\u6587\u4ef6\uff0crepository \u4e3b\u8981\u6709\u4ee5\u4e0b\u51e0\u79cd\u7c7b\u578b\u3002</p> <ul> <li>fs\uff1a\u5171\u4eab\u6587\u4ef6\u7cfb\u7edf\uff0c\u5c06\u5feb\u7167\u6587\u4ef6\u5b58\u653e\u4e8e\u6587\u4ef6\u7cfb\u7edf\u4e2d\u3002</li> <li>url\uff1a\u6307\u5b9a\u6587\u4ef6\u7cfb\u7edf\u7684 URL \u8def\u5f84\uff0c\u652f\u6301\u534f\u8bae\uff1ahttp\u3001https\u3001ftp\u3001file\u3001jar\u3002</li> <li>s3\uff1aAWS S3 \u5bf9\u8c61\u5b58\u50a8,\u5feb\u7167\u5b58\u653e\u4e8e S3 \u4e2d\uff0c\u4ee5\u63d2\u4ef6\u5f62\u5f0f\u652f\u6301\uff0c\u5b89\u88c5\u8be5\u63d2\u4ef6\u8bf7\u53c2\u8003 repository-s3\u3002</li> <li>hdfs\uff1a\u5feb\u7167\u5b58\u653e\u4e8e hdfs \u4e2d\uff0c\u4ee5\u63d2\u4ef6\u5f62\u5f0f\u652f\u6301\uff0c\u5b89\u88c5\u8be5\u63d2\u4ef6\u8bf7\u53c2\u8003 repository-hdfs\u3002</li> <li> <p>cos\uff1a\u5feb\u7167\u5b58\u653e\u4e8e\u817e\u8baf\u4e91COS\u5bf9\u8c61\u5b58\u50a8\u4e2d\uff0c\u4ee5\u63d2\u4ef6\u5f62\u5f0f\u652f\u6301\uff0c\u5b89\u88c5\u8be5\u63d2\u4ef6\u8bf7\u53c2\u8003 cos-repository\u3002</p> </li> <li> <p><code>repository-s3</code>: https://www.elastic.co/guide/en/elasticsearch/plugins/current/repository-s3.html</p> </li> </ul> <p>\u5982\u679c\u9700\u8981\u4ece\u81ea\u5efa ES \u96c6\u7fa4\u8fc1\u79fb\u81f3\u817e\u8baf\u4e91\u7684 ES \u96c6\u7fa4\uff0c\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 COS \u7c7b\u578b\u4ed3\u5e93\u3002</p> <p>\u4f46\u9700\u8981\u5148\u5728\u81ea\u5efa ES \u96c6\u7fa4\u4e0a\u5b89\u88c5 <code>cos-repository</code> \u63d2\u4ef6\uff08\u5b89\u88c5\u63d2\u4ef6\u540e\u9700\u8981\u91cd\u542f\u96c6\u7fa4\u624d\u80fd\u4f7f\u7528\uff09\uff0c\u5148\u628a\u81ea\u5efa ES \u96c6\u7fa4\u4e2d\u7684\u6570\u636e\u5148\u5907\u4efd\u5230 <code>COS</code>\uff0c\u7136\u540e\u5728\u817e\u8baf\u4e91\u4e0a\u7684 ES \u96c6\u7fa4\u4e2d\u6062\u590d\u51fa\u6765\uff0c\u4ee5\u5b8c\u6210\u6570\u636e\u7684\u8fc1\u79fb\u3002</p> <p>\u5982\u679c\u81ea\u5efa ES \u7684\u96c6\u7fa4\u4e0d\u65b9\u4fbf\u5b89\u88c5 cos-repository \u63d2\u4ef6\uff0c\u4f46\u662f\u5df2\u7ecf\u5b89\u88c5 repository-s3 \u6216\u8005 <code>repository-hdfs</code> \u63d2\u4ef6\uff0c\u5219\u53ef\u4ee5\u5148\u628a\u6570\u636e\u5907\u4efd\u5230 S3 \u6216\u8005 HDFS \u4e2d\uff0c\u7136\u540e\u628a S3 \u6216\u8005 HDFS \u4e2d\u5907\u4efd\u597d\u7684\u6587\u4ef6\u4e0a\u4f20\u5230\u817e\u8baf\u4e91 COS \u4e2d\uff0c\u4e4b\u540e\u5728\u817e\u8baf\u4e91\u4e0a\u7684\u96c6\u7fa4\u4e2d\u8fdb\u884c\u6062\u590d\u3002</p> <p>\u901a\u8fc7 COS \u5feb\u7167\u8fdb\u884c\u6570\u636e\u8fc1\u79fb\u65f6\uff0c\u9700\u8981\u5148\u521b\u5efa COS \u4ed3\u5e93\uff0c\u60a8\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\u521b\u5efa\u4ed3\u5e93\uff1a</p> <pre><code>PUT _snapshot/my_cos_backup\n{\n    \"type\": \"cos\",\n    \"settings\": {\n        \"app_id\": \"xxxxxxx\",\n        \"access_key_id\": \"xxxxxx\",\n        \"access_key_secret\": \"xxxxxxx\",\n        \"bucket\": \"xxxxxx\",\n        \"region\": \"ap-guangzhou\",\n        \"compress\": true,\n        \"chunk_size\": \"500mb\",\n        \"base_path\": \"/\"\n    }\n}\n</code></pre> <ul> <li><code>app_id</code>\uff1a\u817e\u8baf\u4e91\u8d26\u53f7 APPID\u3002</li> <li><code>access_key_id</code>\uff1a\u817e\u8baf\u4e91 API \u5bc6\u94a5 SecretId\u3002</li> <li><code>access_key_secret</code>\uff1a\u817e\u8baf\u4e91 API \u5bc6\u94a5 SecretKey\u3002</li> <li><code>bucket</code>\uff1aCOS Bucket \u540d\u5b57\uff0c\u4e0d\u5e26 appId \u540e\u7f00\u7684 bucket \u540d\u3002</li> <li><code>region</code>\uff1aCOS Bucket \u5730\u57df\uff0c\u5fc5\u987b\u4e0e ES \u96c6\u7fa4\u540c\u5730\u57df\u3002</li> <li><code>base_path</code>\uff1a\u5907\u4efd\u76ee\u5f55\u3002</li> </ul>"},{"location":"chap18/4ES_migration/#es-snapshot","title":"\u5728\u6e90 ES \u96c6\u7fa4\u4e2d\u521b\u5efa snapshot","text":"<p>\u8c03\u7528 snapshot api \u521b\u5efa\u5feb\u7167\u4ee5\u5907\u4efd\u7d22\u5f15\u6570\u636e\uff0c\u521b\u5efa\u5feb\u7167\u65f6\u53ef\u4ee5\u6307\u5b9a\u53ea\u5bf9\u90e8\u5206\u7d22\u5f15\u8fdb\u884c\u5907\u4efd\uff0c\u4e5f\u53ef\u4ee5\u5907\u4efd\u6240\u6709\u7684\u7d22\u5f15\uff0c\u5177\u4f53\u7684 api \u63a5\u53e3\u53c2\u6570\u53ef\u4ee5\u67e5\u9605 \u5b98\u65b9\u6587\u6863\u3002</p>"},{"location":"chap18/4ES_migration/#_1","title":"\u5907\u4efd\u6240\u6709\u7d22\u5f15","text":"<p>\u5c06\u6e90 ES \u96c6\u7fa4\u4e2d\u7684\u6240\u6709\u7d22\u5f15\u5907\u4efd\u5230 <code>my_cos_backup</code> \u4ed3\u5e93\u4e0b\uff0c\u5e76\u547d\u540d\u4e3a <code>snapshot_1</code>\uff1a</p> <pre><code>PUT _snapshot/my_cos_backup/snapshot_1\n</code></pre> <p>\u8fd9\u4e2a\u547d\u4ee4\u4f1a\u7acb\u523b\u8fd4\u56de\uff0c\u5e76\u5728\u540e\u53f0\u5f02\u6b65\u6267\u884c\u76f4\u5230\u7ed3\u675f\u3002\u5982\u679c\u5e0c\u671b\u521b\u5efa\u5feb\u7167\u547d\u4ee4\u963b\u585e\u6267\u884c\uff0c\u53ef\u4ee5\u6dfb\u52a0 <code>wait_for_completion</code> \u53c2\u6570\uff1a</p> <pre><code>PUT _snapshot/my_cos_backup/snapshot_1?wait_for_completion=true\n</code></pre>"},{"location":"chap18/4ES_migration/#_2","title":"\u5907\u4efd\u6307\u5b9a\u7d22\u5f15","text":"<p>\u60a8\u53ef\u4ee5\u5728\u521b\u5efa\u5feb\u7167\u7684\u65f6\u5019\u6307\u5b9a\u8981\u5907\u4efd\u7684\u7d22\u5f15\uff1a</p> <pre><code>PUT _snapshot/my_cos_backup/snapshot_2\n{\n    \"indices\": \"index_1,index_2\"\n}\n</code></pre>"},{"location":"chap18/4ES_migration/#_3","title":"\u67e5\u770b\u5feb\u7167\u72b6\u6001","text":"<p>\u901a\u8fc7\u4ee5\u4e0b\u547d\u4ee4\u68c0\u67e5\u5feb\u7167\u662f\u5426\u5907\u4efd\u5b8c\u6210\uff0c\u8fd4\u56de\u7ed3\u679c\u4e2d\u7684state\u5b57\u6bb5\u4e3aSUCCESS\u5219\u8bf4\u660e\u5feb\u7167\u5df2\u7ecf\u5907\u4efd\u6210\u529f\uff1a</p> <pre><code>GET _snapshot/my_cos_backup/snapshot_1\n</code></pre>"},{"location":"chap18/4ES_migration/#es-repository","title":"\u5728\u76ee\u6807 ES \u96c6\u7fa4\u4e2d\u521b\u5efa repository","text":"<p>\u5728\u76ee\u6807 ES \u96c6\u7fa4\u4e2d\u521b\u5efa\u4ed3\u5e93\u548c\u5728\u6e90 ES \u96c6\u7fa4\u4e2d\u521b\u5efa\u4ed3\u5e93\u5b8c\u5168\u76f8\u540c\u3002</p>"},{"location":"chap18/4ES_migration/#_4","title":"\u4ece\u5feb\u7167\u6062\u590d","text":"<p>\u5c06\u5feb\u7167\u4e2d\u5907\u4efd\u7684\u6240\u6709\u7d22\u5f15\u90fd\u6062\u590d\u5230 ES \u96c6\u7fa4\u4e2d\uff1a</p> <pre><code>POST _snapshot/my_cos_backup/snapshot_1/_restore\n</code></pre> <p>\u5982\u679c <code>snapshot_1</code> \u5305\u62ec5\u4e2a\u7d22\u5f15\uff0c\u5219\u8fd95\u4e2a\u7d22\u5f15\u90fd\u4f1a\u88ab\u6062\u590d\u5230 ES \u96c6\u7fa4\u4e2d\u3002</p> <p>\u60a8\u8fd8\u53ef\u4ee5\u4f7f\u7528\u9644\u52a0\u7684\u9009\u9879\u5bf9\u7d22\u5f15\u8fdb\u884c\u91cd\u547d\u540d\u3002</p> <p>\u8be5\u9009\u9879\u5141\u8bb8\u60a8\u901a\u8fc7\u6a21\u5f0f\u5339\u914d\u7d22\u5f15\u540d\u79f0\uff0c\u5e76\u901a\u8fc7\u6062\u590d\u8fdb\u7a0b\u63d0\u4f9b\u4e00\u4e2a\u65b0\u540d\u79f0\u3002\u5982\u679c\u60a8\u60f3\u5728\u4e0d\u66ff\u6362\u73b0\u6709\u6570\u636e\u7684\u524d\u63d0\u4e0b\uff0c\u6062\u590d\u65e7\u6570\u636e\u6765\u9a8c\u8bc1\u5185\u5bb9\u6216\u8fdb\u884c\u5176\u4ed6\u64cd\u4f5c\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528\u8be5\u9009\u9879\u3002\u4ece\u5feb\u7167\u91cc\u6062\u590d\u5355\u4e2a\u7d22\u5f15\u5e76\u63d0\u4f9b\u4e00\u4e2a\u66ff\u6362\u7684\u540d\u79f0\uff1a</p> <pre><code>POST /_snapshot/my_cos_backup/snapshot_1/_restore\n{\n    \"indices\": \"index_1\",\n    \"rename_pattern\": \"index_(.+)\",\n    \"rename_replacement\": \"restored_index_$1\"\n}\n</code></pre> <ul> <li>indices\uff1a\u53ea\u6062\u590d <code>index_1</code> \u7d22\u5f15\uff0c\u5ffd\u7565\u5feb\u7167\u4e2d\u5b58\u5728\u7684\u5176\u4ed6\u7d22\u5f15\u3002</li> <li><code>rename_pattern</code>\uff1a\u67e5\u627e\u6240\u63d0\u4f9b\u7684\u6a21\u5f0f\u80fd\u5339\u914d\u4e0a\u7684\u6b63\u5728\u6062\u590d\u7684\u7d22\u5f15\u3002</li> <li><code>rename_replacement</code>\uff1a\u5c06\u5339\u914d\u7684\u7d22\u5f15\u91cd\u547d\u540d\u6210\u66ff\u4ee3\u7684\u6a21\u5f0f\u3002</li> </ul>"},{"location":"chap18/4ES_migration/#_5","title":"\u67e5\u770b\u7d22\u5f15\u6062\u590d\u72b6\u6001","text":"<p>\u60a8\u53ef\u4ee5\u901a\u8fc7\u8c03\u7528 <code>_recovery API</code>\uff0c\u67e5\u770b\u6307\u5b9a\u7d22\u5f15\u6062\u590d\u7684\u8fdb\u5ea6\uff1a</p> <pre><code>GET index_1/_recovery\n</code></pre> <p>\u53e6\u5916\u53ef\u4ee5\u901a\u8fc7\u8c03\u7528\u4ee5\u4e0b API\uff0c\u67e5\u770b\u6307\u5b9a\u7d22\u5f15\u7684\u72b6\u6001\uff0c\u8fd4\u56de\u7ed3\u679c\u4e2d status \u4e3a green\uff0c\u5219\u8bf4\u660e\u7d22\u5f15\u5df2\u7ecf\u5b8c\u5168\u6062\u590d\uff1a</p> <pre><code>GET _cluster/health/index_1\n</code></pre>"},{"location":"chap18/4ES_migration/#2-logstash","title":"2 logstash","text":"<p>logstash \u652f\u6301\u4ece\u4e00\u4e2a ES \u96c6\u7fa4\u4e2d\u8bfb\u53d6\u6570\u636e\u7136\u540e\u5199\u5165\u5230\u53e6\u4e00\u4e2a ES \u96c6\u7fa4\uff0c\u56e0\u6b64\u53ef\u4ee5\u4f7f\u7528 logstash \u8fdb\u884c\u6570\u636e\u8fc1\u79fb\uff0c\u4f7f\u7528 logstash \u8fdb\u884c\u8fc1\u79fb\u524d\uff0c\u9700\u8981\u6ce8\u610f\u4ee5\u4e0b\u51e0\u70b9\uff1a</p> <ul> <li>\u9700\u8981\u5728\u548c\u817e\u8baf\u4e91\u4e0a\u7684 ES \u96c6\u7fa4\u76f8\u540c\u7684 VPC \u4e0b\u521b\u5efa CVM\uff0c\u90e8\u7f72 logstash\uff0c\u540c\u65f6\u4fdd\u8bc1\u8be5 CVM \u80fd\u591f\u8bbf\u95ee\u5230\u6e90 ES \u96c6\u7fa4\u3002</li> <li>\u7528\u4e8e\u90e8\u7f72 logstash \u7684 CVM \u6700\u597d\u9009\u62e9\u6bd4\u8f83\u9ad8\u7684\u914d\u7f6e\uff0c\u4f8b\u5982 CPU \u4e3a16\u6838\uff0c\u5185\u5b58\u4e3a32GB\u3002</li> <li>logstash \u5e94\u8be5\u548c\u76ee\u6807 ES \u96c6\u7fa4\u7684\u4e3b\u7248\u672c\u53f7\u76f8\u540c\uff0c\u4f8b\u5982\u76ee\u6807 ES \u96c6\u7fa4\u4e3a6.8.2\u7248\u672c\uff0c\u5219 logstash \u4e5f\u9700\u8981\u4f7f\u75286.8\u7248\u672c\u3002</li> <li>\u9700\u8981\u7279\u522b\u6ce8\u610f\u7d22\u5f15 type \u7684\u95ee\u9898\uff0c\u56e0\u4e3a ES \u7684\u4e0d\u540c\u7248\u672c\u5bf9\u7d22\u5f15 type \u7684\u7ea6\u675f\u4e0d\u540c\uff0c\u8de8\u5927\u7248\u672c\u8fc1\u79fb ES \u96c6\u7fa4\u65f6\u53ef\u80fd\u51fa\u73b0\u56e0\u4e3a\u7d22\u5f15\u7684 type \u800c\u5bfc\u81f4\u5199\u5165\u76ee\u6807\u96c6\u7fa4\u5931\u8d25\u7b49\u7684\u95ee\u9898\u3002\u5177\u4f53\u53ef\u53c2\u8003 <code>logstash-output-elasticsearch</code> \u63d2\u4ef6\u4e2d\u5bf9 <code>document_type</code> \u53c2\u6570\u7684\u8bf4\u660e\u3002</li> </ul> <p>\u4e00\u4e2a\u5e38\u7528\u7684\u4f7f\u7528 logstash \u8fdb\u884c\u8de8\u96c6\u7fa4\u6570\u636e\u8fc1\u79fb\u7684\u914d\u7f6e\u6587\u4ef6\u5982\u4e0b\uff1a</p> <pre><code>input {\n    elasticsearch {\n        hosts =&gt; \"1.1.1.1:9200\"\n        index =&gt; \"*\"\n        docinfo =&gt; true\n        size =&gt; 5000\n        scroll =&gt; \"5m\"\n      }\n}\n\noutput {\n    elasticsearch {\n        hosts =&gt; [\"http://2.2.2.2:9200\"]\n        user =&gt; \"elastic\"\n        password =&gt; \"your_password\"\n        index =&gt; \"%{[@metadata][_index]}\"\n        document_type =&gt; \"%{[@metadata][_type]}\"\n        document_id =&gt; \"%{[@metadata][_id]}\"\n    }\n}\n</code></pre> <p>\u4e0a\u8ff0\u914d\u7f6e\u6587\u4ef6\u5c06\u6e90 ES \u96c6\u7fa4\u7684\u6240\u6709\u7d22\u5f15\u540c\u6b65\u5230\u76ee\u6807\u96c6\u7fa4\u4e2d\uff0c\u540c\u65f6\u4e5f\u53ef\u4ee5\u8bbe\u7f6e\u53ea\u540c\u6b65\u6307\u5b9a\u7684\u7d22\u5f15\uff0c\u5229\u7528 logstash \u8fdb\u884c\u8fc1\u79fb\u7684\u66f4\u591a\u529f\u80fd\u53ef\u67e5\u9605 logstash-input-elasticsearch \u548c logstash-output-elasticsearc</p>"},{"location":"chap18/4ES_migration/#3-elasticsearch-dump","title":"3 elasticsearch-dump","text":"<p>elasticsearch-dump \u662f\u4e00\u6b3e\u5f00\u6e90\u7684 ES \u6570\u636e\u8fc1\u79fb\u5de5\u5177\uff0cgithub \u5730\u5740\u3002</p> <p>1 \u5b89\u88c5 elasticsearch-dump</p> <p><code>elasticsearch-dump</code> \u4f7f\u7528 node.js \u5f00\u53d1\uff0c\u53ef\u4f7f\u7528 npm \u5305\u7ba1\u7406\u5de5\u5177\u76f4\u63a5\u5b89\u88c5\uff1a</p> <pre><code>npm install elasticdump -g\n</code></pre> <p>2 \u4e3b\u8981\u53c2\u6570\u8bf4\u660e</p> <ul> <li><code>--input</code>: \u6e90\u5730\u5740\uff0c\u53ef\u4e3a ES \u96c6\u7fa4 URL\u3001\u6587\u4ef6\u6216 stdin,\u53ef\u6307\u5b9a\u7d22\u5f15\uff0c\u683c\u5f0f\u4e3a<code>\uff1a{protocol}://{host}:{port}/{index}</code></li> <li><code>--input-index</code>: \u6e90 ES \u96c6\u7fa4\u4e2d\u7684\u7d22\u5f15</li> <li><code>--output</code>: \u76ee\u6807\u5730\u5740\uff0c\u53ef\u4e3a ES \u96c6\u7fa4\u5730\u5740 URL\u3001\u6587\u4ef6\u6216 stdout\uff0c\u53ef\u6307\u5b9a\u7d22\u5f15\uff0c\u683c\u5f0f\u4e3a\uff1a<code>{protocol}://{host}:{port}/{index}</code></li> <li><code>--output-index:</code> \u76ee\u6807 ES \u96c6\u7fa4\u7684\u7d22\u5f15</li> <li><code>--type</code>: \u8fc1\u79fb\u7c7b\u578b\uff0c\u9ed8\u8ba4\u4e3a data\uff0c\u8868\u660e\u53ea\u8fc1\u79fb\u6570\u636e\uff0c\u53ef\u9009 settings, analyzer, data, mapping</li> </ul> <p>3 \u5982\u679c\u96c6\u7fa4\u6709\u5b89\u5168\u8ba4\u8bc1\uff0c\u53ef\u4ee5\u53c2\u7167\u4e0b\u9762\u7684\u65b9\u6cd5\u4f7f\u7528 reindex \u96c6\u7fa4\u9274\u6743\u3002\u5728\u5bf9\u5e94\u7684 http \u540e\u9762\uff0c\u6dfb\u52a0 user:password@ \u53c2\u8003\u6837\u4f8b <code>elasticsearch-dump --input=http://192.168.1.2:9200/my_index --output=http://user:password@192.168.1.2:9200/my_index --type=data</code>\u3002</p> <p>4 \u8fc1\u79fb\u5355\u4e2a\u7d22\u5f15</p> <p>\u4ee5\u4e0b\u64cd\u4f5c\u901a\u8fc7 <code>elasticdump</code> \u547d\u4ee4\u5c06\u96c6\u7fa4172.16.0.39\u4e2d\u7684 <code>companydatabase</code> \u7d22\u5f15\u8fc1\u79fb\u81f3\u96c6\u7fa4<code>172.16.0.20</code>\u3002</p> <pre><code>elasticdump --input=http://172.16.0.39:9200/companydatabase --output=http://172.16.0.20:9200/companydatabase --type=settings\nelasticdump --input=http://172.16.0.39:9200/companydatabase --output=http://172.16.0.20:9200/companydatabase --type=mapping\nelasticdump --input=http://172.16.0.39:9200/companydatabase --output=http://172.16.0.20:9200/companydatabase --type=data\n</code></pre> <p>5 \u8fc1\u79fb\u6240\u6709\u7d22\u5f15</p> <p>\u4ee5\u4e0b\u64cd\u4f5c\u901a\u8fc7 elasticdump \u547d\u4ee4\u5c06\u96c6\u7fa4172.16.0.39\u4e2d\u7684\u6240\u6709\u7d22\u5f15\u8fc1\u79fb\u81f3\u96c6\u7fa4172.16.0.20\u3002</p> <pre><code>elasticdump --input=http://172.16.0.39:9200 --output=http://172.16.0.20:9200\n</code></pre>"},{"location":"chap18/4ES_migration/#4","title":"4 \u603b\u7ed3","text":"<ul> <li>elasticsearch-dump \u548c logstash \u505a\u8de8\u96c6\u7fa4\u6570\u636e\u8fc1\u79fb\u65f6\uff0c\u90fd\u8981\u6c42\u7528\u4e8e\u6267\u884c\u8fc1\u79fb\u4efb\u52a1\u7684\u673a\u5668\u53ef\u4ee5\u540c\u65f6\u8bbf\u95ee\u5230\u4e24\u4e2a\u96c6\u7fa4\uff0c\u56e0\u4e3a\u7f51\u7edc\u65e0\u6cd5\u8fde\u901a\u7684\u60c5\u51b5\u4e0b\u5c31\u65e0\u6cd5\u5b9e\u73b0\u8fc1\u79fb\u3002<ul> <li>\u800c\u4f7f\u7528 snapshot \u7684\u65b9\u5f0f\u5219\u6ca1\u6709\u8fd9\u4e2a\u9650\u5236\uff0c\u56e0\u4e3a snapshot \u65b9\u5f0f\u662f\u5b8c\u5168\u79bb\u7ebf\u7684\u3002</li> <li>\u56e0\u6b64 elasticsearch-dump \u548c logstash \u8fc1\u79fb\u65b9\u5f0f\u66f4\u9002\u5408\u4e8e\u6e90 ES \u96c6\u7fa4\u548c\u76ee\u6807 ES \u96c6\u7fa4\u5904\u4e8e\u540c\u4e00\u7f51\u7edc\u7684\u60c5\u51b5\u4e0b\u8fdb\u884c\u8fc1\u79fb\u3002</li> <li>\u800c\u9700\u8981\u8de8\u4e91\u5382\u5546\u7684\u8fc1\u79fb\uff0c\u53ef\u4ee5\u9009\u62e9\u4f7f\u7528 snapshot \u7684\u65b9\u5f0f\u8fdb\u884c\u8fc1\u79fb\uff0c\u4f8b\u5982\u4ece\u963f\u91cc\u4e91 ES \u96c6\u7fa4\u8fc1\u79fb\u81f3\u817e\u8baf\u4e91 ES \u96c6\u7fa4\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7\u6253\u901a\u7f51\u7edc\u5b9e\u73b0\u96c6\u7fa4\u4e92\u901a\uff0c\u4f46\u662f\u6210\u672c\u8f83\u9ad8\u3002</li> </ul> </li> <li>elasticsearch-dump \u5de5\u5177\u548c MySQL \u6570\u636e\u5e93\u7528\u4e8e\u505a\u6570\u636e\u5907\u4efd\u7684\u5de5\u5177 mysqldump \u7c7b\u4f3c\uff0c\u90fd\u662f\u903b\u8f91\u5907\u4efd\uff0c\u9700\u8981\u5c06\u6570\u636e\u4e00\u6761\u4e00\u6761\u5bfc\u51fa\u540e\u518d\u6267\u884c\u5bfc\u5165\uff0c\u6240\u4ee5\u9002\u5408\u6570\u636e\u91cf\u5c0f\u7684\u573a\u666f\u4e0b\u8fdb\u884c\u8fc1\u79fb\u3002</li> <li>snapshot \u7684\u65b9\u5f0f\u9002\u5408\u6570\u636e\u91cf\u5927\u7684\u573a\u666f\u4e0b\u8fdb\u884c\u8fc1\u79fb\u3002</li> </ul>"},{"location":"chap19/sum1_search_api/","title":"ElasticSearch URI \u5e38\u7528\u8bed\u53e5\u603b\u7ed3\u7bc7","text":""},{"location":"chap19/sum1_search_api/#1elasticsearch","title":"1\u3001ElasticSearch \u57fa\u672c\u6982\u5ff5","text":"<p>1-1 \u7d22\u5f15</p> <pre><code>GET movies/_doc/1\n\nGET movies/_settings\n# Setting\u5b9a\u4e49\u4e0d\u540c\u7684\u6570\u636e\u5206\u5e03\n\nGET movies/_mapping\n# Mapping\u5b9a\u4e49\u6587\u6863\u5b57\u6bb5\u7684\u7c7b\u578b\n</code></pre> <p>1-2 CAT Index API</p> <pre><code>#\u67e5\u770b\u7d22\u5f15\u7684\u6587\u6863\u603b\u6570\nGET kibana_sample_data_ecommerce/_count\n\n#\u67e5\u770b\u524d10\u6761\u6587\u6863\uff0c\u4e86\u89e3\u6587\u6863\u683c\u5f0f\nPOST kibana_sample_data_ecommerce/_search\n{\n}\n\n#_cat indices API\n#\u67e5\u770bindices\nGET /_cat/indices/kibana*?v&amp;s=index\n\n#\u67e5\u770b\u72b6\u6001\u4e3a\u7eff\u7684\u7d22\u5f15\nGET /_cat/indices?v&amp;health=green\n\n#\u6309\u7167\u6587\u6863\u4e2a\u6570\u6392\u5e8f\nGET /_cat/indices?v&amp;s=docs.count:desc\n\n#\u67e5\u770b\u5177\u4f53\u7684\u5b57\u6bb5\nGET /_cat/indices/kibana*?pri&amp;v&amp;h=health,index,pri,rep,docs.count,mt\n\n#How much memory is used per index?\nGET /_cat/indices?v&amp;h=i,tm&amp;s=tm:desc\n</code></pre> <p>1-2 CAT Cluster/Shards API</p> <pre><code>GET _cluster/health\n\nGET _cat/nodes?v\nGET /_nodes/es79,es7_02\nGET /_cat/nodes?v\nGET /_cat/nodes?v&amp;h=id,ip,port,v,m\n\nGET _cluster/health\nGET _cluster/health?level=shards\nGET /_cluster/health/kibana_sample_data_ecommerce,kibana_sample_data_flights\nGET /_cluster/health/kibana_sample_data_flights?level=shards\n\n#### cluster state The cluster state API allows access to metadata representing the state of the whole cluster. This includes information such as\nGET /_cluster/state\n\n#cluster get settings\nGET /_cluster/settings\nGET /_cluster/settings?include_defaults=true\n\nGET _cat/shards\nGET _cat/shards?h=index,shard,prirep,state,unassigned.reason\n</code></pre>"},{"location":"chap19/sum1_search_api/#2crud-bulk-api","title":"2\u3001\u6587\u6863\u7684\u57fa\u672cCRUD\u4e0e\u6279\u91cf\u64cd\u4f5c &amp; \u8bfb\u53d6\uff06Bulk API","text":"<p>2-1 Create \u4e00\u4e2a\u6587\u6863</p> <pre><code>POST users/_doc\n{\n    \"user\" : \"Mike\",\n    \"post_date\" : \"2019-04-15T14:12:12\",\n    \"message\" : \"trying out Kibana\"\n}\n\n# create document. \u6307\u5b9aId\u3002\u5982\u679cid\u5df2\u7ecf\u5b58\u5728\uff0c\u62a5\u9519\n\nPUT users/_doc/1?op_type=create\n{\n    \"user\" : \"Jack\",\n    \"post_date\" : \"2019-05-15T14:12:12\",\n    \"message\" : \"trying out Elasticsearch\"\n}\n# sucess \n\n# create document. \u6307\u5b9a ID \u5982\u679c\u5df2\u7ecf\u5b58\u5728\uff0c\u5c31\u62a5\u9519\nPUT users/_create/1\n{\n     \"user\" : \"Jack\",\n    \"post_date\" : \"2019-05-15T14:12:12\",\n    \"message\" : \"trying out Elasticsearch\"\n}\n</code></pre> <p>2-2 Get \u4e00\u4e2a\u6587\u6863</p> <pre><code>GET users/_doc/1\n</code></pre> <p>2-3 Index\u6587\u6863</p> <pre><code>#Update \u6307\u5b9a ID  (\u5148\u5220\u9664\uff0c\u5728\u5199\u5165)\nPUT users/_doc/1\n{\n    \"user\" : \"Mike\"\n}\n</code></pre> <p>2-4 Update \u6587\u6863</p> <pre><code># Updete\u65b9\u6cd5\u4e0d\u4f1a\u5220\u9664\u539f\u6765\u7684\u6587\u6863\u800c\u662f\u5b9e\u73b0\u771f\u6b63\u7684\u6570\u636e\u66f4\u65b0\nPOST users/_update/1/\n{\n    \"doc\":{\n        \"post_date\" : \"2019-05-15T14:12:12\",\n        \"message\" : \"trying out Elasticsearch\"\n    }\n}\n</code></pre> <p>2-5 \u5220\u9664\u6587\u6863</p> <pre><code>### Delete by Id\n\nDELETE users/_doc/1\n</code></pre> <p>2-6  Bulk API</p> <pre><code>#\u6267\u884c\u7b2c1\u6b21\nPOST _bulk\n{ \"index\" : { \"_index\" : \"test\", \"_id\" : \"1\" } }\n{ \"field1\" : \"value1\" }\n{ \"delete\" : { \"_index\" : \"test\", \"_id\" : \"2\" } }\n{ \"create\" : { \"_index\" : \"test2\", \"_id\" : \"3\" } }\n{ \"field1\" : \"value3\" }\n{ \"update\" : {\"_id\" : \"1\", \"_index\" : \"test\"} }\n{ \"doc\" : {\"field2\" : \"value2\"} }\n</code></pre> <p>2-7  \u6279\u91cf\u8bfb\u53d6\u4e00mget</p> <pre><code>GET /_mget\n{\n    \"docs\" : [\n        {\n            \"_index\" : \"test\",\n            \"_id\" : \"1\"\n        },\n        {\n            \"_index\" : \"test\",\n            \"_id\" : \"2\"\n        }\n    ]\n}\n</code></pre> <p>2-8 \u6279\u91cf\u67e5\u8be2\u4e00msearch</p> <pre><code>GET /_mget\n{\n    \"docs\" : [\n        {\n            \"_index\" : \"test\",\n            \"_id\" : \"1\",\n            \"_source\" : false\n        },\n        {\n            \"_index\" : \"test\",\n            \"_id\" : \"2\",\n            \"_source\" : [\"field3\", \"field4\"]\n        },\n        {\n            \"_index\" : \"test\",\n            \"_id\" : \"3\",\n            \"_source\" : {\n                \"include\": [\"user\"],\n                \"exclude\": [\"user.location\"]\n            }\n        }\n    ]\n}\n</code></pre> <pre><code>POST kibana_sample_data_ecommerce/_msearch\n{}\n{\"query\" : {\"match_all\" : {}},\"size\":1}\n{\"index\" : \"kibana_sample_data_flights\"}\n{\"query\" : {\"match_all\" : {}},\"size\":2}\n</code></pre>"},{"location":"chap19/sum1_search_api/#_1","title":"``","text":"<p>3-1 \u4f7f\u7528<code>_analyzer API</code></p> <pre><code>GET _analyze\n{\n  \"analyzer\": \"standard\",\n  \"text\": \"2 running Quick brown-foxes leap over lazy dogs in the summer evening.\"\n}\n</code></pre> <p>3-2 Simple Analyzer</p> <pre><code>#simpe\nGET _analyze\n{\n  \"analyzer\": \"simple\",\n  \"text\": \"2 running Quick brown-foxes leap over lazy dogs in the summer evening.\"\n}\n</code></pre> <p>3-3 White Analyzer</p> <pre><code>#whitespace\nGET _analyze\n{\n  \"analyzer\": \"whitespace\",\n  \"text\": \"2 running Quick brown-foxes leap over lazy dogs in the summer evening.\"\n}\n</code></pre> <p>3-4 Stop Analyzer</p> <pre><code>GET _analyze\n{\n  \"analyzer\": \"stop\",\n  \"text\": \"2 running Quick brown-foxes leap over lazy dogs in the summer evening.\"\n}\n</code></pre> <p>3-5 Keyword Analyzer</p> <pre><code>#keyword\nGET _analyze\n{\n  \"analyzer\": \"keyword\",\n  \"text\": \"2 running Quick brown-foxes leap over lazy dogs in the summer evening.\"\n}\n</code></pre> <p>3-6 Pattern Analyzer</p> <pre><code>GET _analyze\n{\n  \"analyzer\": \"pattern\",\n  \"text\": \"2 running Quick brown-foxes leap over lazy dogs in the summer evening.\"\n}\n</code></pre> <p>3-7 Language Analyzer</p> <pre><code>#english\nGET _analyze\n{\n  \"analyzer\": \"english\",\n  \"text\": \"2 running Quick brown-foxes leap over lazy dogs in the summer evening.\"\n}\n</code></pre>"},{"location":"chap19/sum1_search_api/#4elasticsearch-search","title":"4\u3001ElasticSearch Search\u8bed\u53e5","text":"<pre><code>GET kibana_sample_data_ecommerce/_search?q=customer_first_name:Eddie'\n\nGET /_all/_search?q=customer_first_name:Eddie\n</code></pre> <p>4-1 Request Body</p> <pre><code>#REQUEST Body\nPOST kibana_sample_data_ecommerce/_search\n{\n    \"profile\": true,\n    \"query\": {\n        \"match_all\": {}\n    }\n}\n</code></pre> <p>4-2 URI Search\u8be6\u89e3</p> <pre><code>#\u57fa\u672c\u67e5\u8be2\nGET /movies/_search?q=2012&amp;df=title&amp;sort=year:desc&amp;from=0&amp;size=10&amp;timeout=1s\n</code></pre> <pre><code>GET /movies/_search?q=2012&amp;df=title\n{\n    \"profile\":\"true\"\n}\n</code></pre> <pre><code>#\u6cdb\u67e5\u8be2\uff0c\u6b63\u5bf9_all,\u6240\u6709\u5b57\u6bb5\nGET /movies/_search?q=2012\n{\n    \"profile\":\"true\"\n}\n</code></pre> <pre><code>#\u6307\u5b9a\u5b57\u6bb5\nGET /movies/_search?q=title:2012&amp;sort=year:desc&amp;from=0&amp;size=10&amp;timeout=1s\n{\n    \"profile\":\"true\"\n}\n</code></pre> <pre><code># \u6cdb\u67e5\u8be2\nGET /movies/_search?q=title:2012\n{\n    \"profile\":\"true\"\n}\n</code></pre> <p>Term vs Phrase</p> <ul> <li><code>Beautifual Mind</code>\u7b49\u6548\u4e8e<code>Beautiful OR Mind</code></li> <li><code>\"Beautifual Mind\"</code>\u7b49\u6548\u4e8e<code>Beautiful AND Mind</code>, Phrase\u67e5\u8be2\u8fd8\u8981\u6c42\u524d\u540e\u987a\u5e8f\u4fdd\u5f85\u4e00\u81f4</li> </ul> <pre><code># \u67e5\u627e\u7f8e\u4e3d\u5fc3\u7075, Mind\u4e3a\u6cdb\u67e5\u8be2\nGET /movies/_search?q=title:Beautiful Mind\n{\n    \"profile\":\"true\"\n}\n</code></pre> <p>\u5206\u7ec4\u4e0e\u5f15\u53f7</p> <ul> <li><code>title:(Beautiful AND Mind)</code></li> <li><code>title=\"Beautifual Mind\"</code></li> </ul> <pre><code>#\u4f7f\u7528\u5f15\u53f7\uff0cPhrase\u67e5\u8be2\nGET /movies/_search?q=title:\"Beautiful Mind\"\n{\n    \"profile\":\"true\"\n}\n</code></pre> <pre><code>#\u5206\u7ec4\uff0cBool\u67e5\u8be2\nGET /movies/_search?q=title:(Beautiful Mind)\n{\n    \"profile\":\"true\"\n}\n</code></pre> <p>\u5e03\u5c14\u64cd\u4f5c</p> <ul> <li><code>AND/OR/NOT</code> \u6216\u8005 <code>&amp;&amp; / || / !</code></li> <li>\u5fc5\u987b\u5927\u5199</li> <li><code>title:(matrix NOT reloaded)</code></li> </ul> <pre><code>#\u5e03\u5c14\u64cd\u4f5c\u7b26\nGET /movies/_search?q=title:(Beautiful AND Mind)\n{\n    \"profile\":\"true\"\n}\n\n# \u67e5\u627e\u7f8e\u4e3d\u5fc3\u7075\nGET /movies/_search?q=title:(Beautiful NOT Mind)\n{\n    \"profile\":\"true\"\n}\n\n# \u67e5\u627e\u7f8e\u4e3d\u5fc3\u7075\nGET /movies/_search?q=title:(Beautiful %2BMind)\n{\n    \"profile\":\"true\"\n}\n</code></pre> <p>\u5206\u7ec4</p> <ul> <li>\u8868\u793amust</li> <li>\u8868\u793a<code>must_not</code></li> <li><code>title:(+matrix -reloaded)</code></li> </ul> <p>\u8303\u56f4\u67e5\u8be2</p> <ul> <li>\u533a\u95f4\u8868\u793a\uff1a<code>[] \u95ed\u533a\u95f4,{}\u5f00\u533a\u95f4</code></li> <li>\u7b97\u6570\u7b26\u53f7</li> </ul> <pre><code>#\u8303\u56f4\u67e5\u8be2 ,\u533a\u95f4\u5199\u6cd5\nGET /movies/_search?q=title:beautiful AND year:[2002 TO 2018%7D\n{\n    \"profile\":\"true\"\n}\n\n</code></pre> <p>\u901a\u914d\u7b26\u67e5\u8be2\uff08\u901a\u914d\u7b26\u67e5\u8be2\u6548\u7387\u4f4e, \u5360\u7528\u5185\u5b58\u5927,\u4e0d\u5efa\u8bae\u4f7f\u7528\u3002\u7279\u522b\u662f\u653e\u5728\u6700\u524d\u9762\uff09</p> <ul> <li>?\u4ee3\u88681\u4e2a\u5b87\u7b26\uff0c\uff0a\u4ee3\u88680\u6216\u591a\u4e2a\u5b87\u7b26</li> </ul> <pre><code>#\u901a\u914d\u7b26\u67e5\u8be2\nGET /movies/_search?q=title:b*\n{\n    \"profile\":\"true\"\n}\n</code></pre> <ul> <li>\u6b63\u5219\u8868\u8fbe: <code>title:[bt]oy</code></li> <li>\u6a21\u7cca\u5339\u914d\u4e0e\u8fd1\u4f3c\u67e5\u8be2<ul> <li><code>title:befutifl~1</code></li> <li><code>title:\"lord rings\"~2</code></li> </ul> </li> </ul> <pre><code>//\u6a21\u7cca\u5339\u914d&amp;\u8fd1\u4f3c\u5ea6\u5339\u914d\nGET /movies/_search?q=title:beautifl~1\n{\n    \"profile\":\"true\"\n}\n</code></pre> <pre><code>GET /movies/_search?q=title:\"Lord Rings\"~2\n{\n    \"profile\":\"true\"\n}\n</code></pre> <p>4-3 Request Body &amp; Query DSL\u4ecb\u7ecd</p> <p>Request Body Search:</p> <pre><code>#\u67e5\u8be2movies\u5206\u9875\nPOST /movies,404_idx/_search?ignore_unavailable=true\n{\n  \"profile\": true,\n    \"query\": {\n        \"match_all\": {}\n    }\n}\n</code></pre> <p>\u5206\u9875:</p> <pre><code>POST /kibana_sample_data_ecommerce/_search\n{\n  \"from\":10,\n  \"size\":20,\n  \"query\":{\n    \"match_all\": {}\n  }\n}\n</code></pre> <p>\u6392\u5e8f</p> <pre><code>#\u5bf9\u65e5\u671f\u6392\u5e8f\nPOST kibana_sample_data_ecommerce/_search\n{\n  \"sort\":[{\"order_date\":\"desc\"}],\n  \"query\":{\n    \"match_all\": {}\n  }\n\n}\n</code></pre> <p><code>_source filerting</code></p> <ul> <li>\u5982\u679c <code>_source</code>\u6ca1\u6709\u5b58\u50a8 \uff0c\u90a3\u5c31\u53ea\u8fd4\u56de\u5339\u914d\u7684\u6587\u6863\u7684\u5143\u6570\u636e</li> <li><code>_source</code>\u652f\u6301\u4f7f\u7528\u901a\u914d\u7b26\uff0c <code>_source[\"name*\",\"desc*\"]</code></li> </ul> <pre><code>#source filtering\nPOST kibana_sample_data_ecommerce/_search\n{\n  \"_source\":[\"order_date\"],\n  \"query\":{\n    \"match_all\": {}\n  }\n}\n</code></pre> <p>\u811a\u672c\u5b57\u6bb5</p> <pre><code>#\u811a\u672c\u5b57\u6bb5\nGET kibana_sample_data_ecommerce/_search\n{\n  \"script_fields\": {\n    \"new_field\": {\n      \"script\": {\n        \"lang\": \"painless\",\n        \"source\": \"doc['order_date'].value+'hello'\"\n      }\n    }\n  },\n  \"query\": {\n    \"match_all\": {}\n  }\n}\n</code></pre> <p>\u4f7f\u7528\u67e5\u8be2\u8868\u8fbe\u5f0f\u4e00Match</p> <pre><code>POST movies/_search\n{\n  \"query\": {\n    \"match\": {\n      \"title\": {\n        \"query\": \"last christmas\",\n        \"operator\": \"and\"\n      }\n    }\n  }\n}\n</code></pre> <pre><code>POST movies/_search\n{\n  \"query\": {\n    \"match_phrase\": {\n      \"title\":{\n        \"query\": \"one love\"\n\n      }\n    }\n  }\n}\n</code></pre> <p>4-4 Query String&amp;Simple Query String\u67e5\u8be2</p> <ul> <li>query \u529f\u80fd\u5f3a\u5927\u6613\u51fa\u9519</li> <li><code>query_string</code> \u529f\u80fd\u7b80\u5355\u7075\u6d3b\u6027\u4f4e</li> <li><code>simple_query_string</code> \u529f\u80fd\u7b80\u5355\u7075\u6d3b\u6027\u4f4e</li> </ul> <p>Query String Query: \u7c7b\u4f3cURI Query</p> <pre><code>POST users/_search\n{\n  \"query\": {\n    \"query_string\": {\n      \"default_field\": \"name\",\n      \"query\": \"Xi AND Jacob\"\n    }\n  }\n}\n</code></pre> <pre><code>POST users/_search\n{\n  \"query\": {\n    \"query_string\": {\n      \"fields\":[\"name\",\"about\"],\n      \"query\": \"(Xi AND Jacob) OR (Java AND Elasticsearch)\"\n    }\n  }\n}\n</code></pre> <p>Simple Query String Query</p> <ul> <li>\u7c7b\u4f3c<code>Query String</code>\uff0c\u4f46\u662f\u4f1a\u5ffd\u7565\u9519\u8bef\u7684\u8bed\u6cd5\uff0c \u540c\u65f6\u53ea\u652f\u6301\u90e8\u5206\u67e5\u8be2\u8bed\u6cd5</li> <li>\u4e0d\u652f\u6301<code>AND OR NOT</code>\uff0c\u4f1a\u5f53\u4f5c\u5b57\u7b26\u4e32\u5904\u7406</li> <li><code>Term</code>\u4e4b\u95f4\u9ed8\u8ba4\u7684\u5173\u7cfb\u662f<code>OR</code>\uff0c\u53ef\u4ee5\u6307\u5b9a <code>Operator</code></li> </ul> <pre><code>#Simple Query \u9ed8\u8ba4\u7684operator\u662f Or\nPOST users/_search\n{\n  \"query\": {\n    \"simple_query_string\": {\n      \"query\": \"Xi AND Jacob\",\n      \"fields\": [\"name\"]\n    }\n  }\n}\n</code></pre> <pre><code>POST users/_search\n{\n  \"query\": {\n    \"simple_query_string\": {\n      \"query\": \"Xi Jacob\",\n      \"fields\": [\"name\"],\n      \"default_operator\": \"AND\"\n    }\n  }\n}\n</code></pre> <p>Single field Query String</p> <pre><code>GET /movies/_search\n{\n    \"profile\": true,\n    \"query\":{\n        \"query_string\":{\n            \"default_field\": \"title\",\n            \"query\": \"Beafiful AND Mind\"\n        }\n    }\n}\n</code></pre> <p>Multiple Simple Query String</p> <pre><code># \u591afields\nGET /movies/_search\n{\n    \"profile\": true,\n    \"query\":{\n        \"query_string\":{\n            \"fields\":[\n                \"title\",\n                \"year\"\n            ],\n            \"query\": \"2012\"\n        }\n    }\n}\n</code></pre> <p>Simple Query String</p> <pre><code>GET /movies/_search\n{\n    \"profile\":true,\n    \"query\":{\n        \"simple_query_string\":{\n            \"query\":\"Beautiful +mind\",\n            \"fields\":[\"title\"]\n        }\n    }\n}\n</code></pre>"},{"location":"chap19/sum1_search_api/#5elasticsearch-mapping","title":"5\u3001ElasticSearch Mapping \u4ecb\u7ecd","text":"<pre><code>#\u5199\u5165\u6587\u6863\uff0c\u67e5\u770b Mapping\nPUT mapping_test/_doc/1\n{\n  \"firstName\":\"Chan\",\n  \"lastName\": \"Jackie\",\n  \"loginDate\":\"2018-07-24T10:29:48.103Z\"\n}\n</code></pre> <pre><code>GET mapping_test/_mapping\n\nDELETE mapping_test\n\n# dynamic mapping\uff0c\u63a8\u65ad\u5b57\u6bb5\u7684\u7c7b\u578b\nPUT mapping_test/_doc/1\n{\n    \"uid\" : \"123\",\n    \"isVip\" : false,\n    \"isAdmin\": \"true\",\n    \"age\":19,\n    \"heigh\":180\n}\n</code></pre> <p>1\u3001\u63a7\u5236Dynamic Mappings</p> <pre><code># \u4fee\u6539\u4e3afalse\n\nPUT movies\n{\n    \"mappings\": {\n        \"_doc\": {\n            \"dynamic\" : \"false\"\n        }\n    }\n}\n\n# \u65b0\u589e anotherField\n\nPUT dynamic_mapping_test/_doc/10\n{\n  \"anotherField\":\"someValue\"\n}\n\n# \"dynamic\": false: \u53ef\u4ee5\u63d2\u5165\uff0c\u65e0\u6cd5\u88ab\u641c\u7d22\u5230\n\nPOST dynamic_mapping_test/_search\n{\n  \"query\":{\n    \"match\":{\n      \"anotherField\":\"someValue\"\n    }\n  }\n}\n\n# \u4fee\u6539\u4e3astrict\nPUT dynamic_mapping_test/_mapping\n{\n  \"dynamic\": \"strict\"\n}\n\n\n</code></pre> <p>2\u3001\u663e\u5f0fMapping\u8bbe\u7f6e\u4e0e\u5e38\u89c1\u53c2\u6570\u4ecb\u7ecd</p> <pre><code>#\u8bbe\u7f6e Mobile index \u4e3a false\nDELETE users\n\n\nPUT users\n{\n    \"mappings\" : {\n      \"properties\" : {\n        \"firstName\" : {\n          \"type\" : \"text\"\n        },\n        \"lastName\" : {\n          \"type\" : \"text\"\n        },\n        \"mobile\" : {\n          \"type\" : \"text\",\n          \"index\": false\n        }\n      }\n    }\n}\n</code></pre> <ul> <li>\"index\": false</li> </ul> <p>3\u3001Index Options</p> <ul> <li>docs\u2014\u2014\u8bb0\u5f55doc id</li> <li>freqs\u2014\u2014\u8bb0\u5f55doc id\u548cterm frequencies</li> <li>positions\u4e00\u8bb0\u5f55doc id / term frequencies / term position</li> <li>offsets \u4e00 doc id/term frequencies/term posistion/character offects</li> </ul> <p>4\u3001<code>null_values</code></p> <pre><code>\"null_value\": \"NULL\"\n</code></pre> <p>5\u3001<code>copy_to</code> \u8bbe\u7f6e</p> <ul> <li><code>copy_to</code>\u5c06\u5b57\u6bb5\u7684\u6570\u503c\u62f7\u8d1d\u5230\u76ee\u6807\u5b57\u6bb5\uff0c\u5b9e\u73b0\u7c7b\u4f3c<code>_all</code>\u7684\u4f5c\u7528</li> </ul> <pre><code>PUT users\n{\n  \"mappings\": {\n    \"properties\": {\n      \"firstName\":{\n        \"type\": \"text\",\n        \"copy_to\": \"fullName\"\n      },\n      \"lastName\":{\n        \"type\": \"text\",\n        \"copy_to\": \"fullName\"\n      }\n    }\n  }\n}\n</code></pre> <pre><code>PUT users/_doc/1\n{\n  \"firstName\":\"Jacob\",\n  \"lastName\": \"Xi\"\n}\n</code></pre> <p>Check:</p> <pre><code>GET users/_search?q=fullName:(Jacob Xi)\n\nPOST users/_search\n{\n  \"query\": {\n    \"match\": {\n       \"fullName\":{\n        \"query\": \"Jacob Xi\",\n        \"operator\": \"and\"\n      }\n    }\n  }\n}\n</code></pre> <p>6\u3001\u6570\u7ec4\u7c7b\u578b</p> <pre><code>PUT users/_doc/1\n{\n  \"name\":\"twobirds\",\n  \"interests\":[\"reading\",\"music\"]\n}\n</code></pre> <pre><code>POST users/_search\n{\n  \"query\": {\n        \"match_all\": {}\n    }\n}\n</code></pre> <p>\u591a\u5b57\u6bb5\u7279\u6027\u53caMapping\u4e2d\u914d\u7f6e\u81ea\u5b9a\u4e49Analyzer</p> <p>1\u3001\u591a\u5b57\u6bb5\u7c7b\u578b</p> <ul> <li>\u589e\u52a0\u4e00\u4e2akeyword\u5b57\u6bb5</li> </ul> <p>2\u3001Exact Values\u4e0d\u9700\u8981\u88ab\u5206\u8bcd</p> <p>3\u3001\u81ea\u5b9a\u4e49\u5206\u8bcd</p> <ul> <li>Character Filter</li> <li>Tokenizer</li> <li>Token Filter</li> </ul> <p>4\u3001 Character Filters</p> <p>\u5728Tokenizer\u4e4b\u524d\u5bf9\u6587\u672c\u8fdb\u884c\u5904\u7406\uff0c\u4f8b\u5982\u589e\u52a0\u5220\u9664\u53ca\u66ff\u6362\u5b57\u7b26\u3002\u53ef\u4ee5\u914d\u7f6e\u591a\u4e2aCharacter Filters\u3002\u4f1a\u5f71\u54cdTokenizer\u7684<code>position</code>\u548c<code>offset</code>\u4fe1\u606f</p> <ul> <li>HTML strip \u2014\u2014 \u53bb\u9664html\u6807\u7b7e</li> </ul> <pre><code>POST _analyze\n{\n  \"tokenizer\":\"keyword\",\n  \"char_filter\":[\"html_strip\"],\n  \"text\": \"&lt;b&gt;hello world&lt;/b&gt;\"\n}\n</code></pre> <ul> <li>Mapping \u2014\u2014 \u5b57\u7b26\u4e32\u66ff\u6362</li> </ul> <pre><code>#\u4f7f\u7528char filter\u8fdb\u884c\u66ff\u6362\nPOST _analyze\n{\n  \"tokenizer\": \"standard\",\n  \"char_filter\": [\n      {\n        \"type\" : \"mapping\",\n        \"mappings\" : [ \"- =&gt; _\"]\n      }\n    ],\n  \"text\": \"123-456, I-test! test-990 650-555-1234\"\n}\n</code></pre> <ul> <li>Pattern replace \u2014\u2014 \u6b63\u5219\u5339\u914d\u66ff\u6362</li> </ul> <pre><code>//\u6b63\u5219\u8868\u8fbe\u5f0f\nGET _analyze\n{\n  \"tokenizer\": \"standard\",\n  \"char_filter\": [\n      {\n        \"type\" : \"pattern_replace\",\n        \"pattern\" : \"http://(.*)\",\n        \"replacement\" : \"$1\"\n      }\n    ],\n    \"text\" : \"http://www.elastic.co\"\n}\n</code></pre> <p>5\u3001Tokenizer</p> <ul> <li>\u5c06\u539f\u59cb\u7684\u6587\u672c\u6309\u7167\u4e00\u5b9a\u7684\u89c4\u5219\uff0c\u5207\u5206\u4e3a\u8bcd\uff08term or token)</li> <li>Elasticsearch\u5185\u7f6e\u7684Tokenizers<ul> <li>whitespace/standard/<code>uax_url_email</code>/pattern/keyword/path hierarchy</li> </ul> </li> </ul> <pre><code>// white space and snowball\nGET _analyze\n{\n  \"tokenizer\": \"whitespace\",\n  \"filter\": [\"stop\",\"snowball\"],\n  \"text\": [\"The gilrs in China are playing this game!\"]\n}\n</code></pre> <pre><code>// whitespace\u4e0estop\nGET _analyze\n{\n  \"tokenizer\": \"whitespace\",\n  \"filter\": [\"stop\",\"snowball\"],\n  \"text\": [\"The rain in Spain falls mainly on the plain.\"]\n}\n</code></pre> <pre><code>// path hierarchy\n\nPOST _analyze\n{\n  \"tokenizer\":\"path_hierarchy\",\n  \"text\":\"/user/ymruan/a/b/c/d/e\"\n}\n\n</code></pre> <p>6\u3001Token Filters</p> <ul> <li>\u5c06Tokenizer\u8f93\u51fa\u7684\u5355\u8bcd\uff08term)\uff0c\u8fdb\u884c\u589e\u52a0\uff0c\u4fee\u6539\uff0c\u5220\u9664</li> <li>\u81ea\u5e26\u7684Token Filters<ul> <li>Lowercase/stop/synonym\uff08\u6dfb\u52a0\u8fd1\u4e49\u8bcd\uff09</li> </ul> </li> </ul> <pre><code>//remove \u52a0\u5165lowercase\u540e\uff0cThe\u88ab\u5f53\u6210 stopword\u5220\u9664\nGET _analyze\n{\n  \"tokenizer\": \"whitespace\",\n  \"filter\": [\"lowercase\",\"stop\",\"snowball\"],\n  \"text\": [\"The gilrs in China are playing this game!\"]\n}\n</code></pre>"},{"location":"chap19/sum1_search_api/#6index-templatedynamic-template","title":"6\u3001Index Template\u548cDynamic Template","text":"<ul> <li>Index Templates \u2014\u2014 \u5e2e\u52a9\u4f60\u8bbe\u5b9aMappings\u548cSettings\uff0c\u5e76\u6309\u7167\u4e00\u5b9a\u7684\u89c4\u5219\u81ea\u52a8\u5339\u914d\u5230\u65b0\u521b\u5efa\u7684\u7d22\u5f15\u4e4b\u4e0a</li> <li>\u6a21\u7248\u4ec5\u5728\u4e00\u4e2a\u7d22\u5f15\u88ab\u65b0\u521b\u5efa\u65f6\uff0c\u624d\u4f1a\u4ea7\u751f\u4f5c\u7528\u3002\u4fee\u6539\u6a21\u7248\u4e0d\u4f1a\u5f71\u54cd\u5df2\u521b\u5efa\u7684\u7d22\u5f15</li> </ul> <pre><code>PUT template/_doc/1\n{\n    \"someNumber\":\"1\",\n    \"someDate\":\"2019/01/01\"\n}\n</code></pre> <p>\u8bbe\u5b9aMappings\u548cSettings</p> <pre><code>#Create a default template\nPUT _template/template_default\n{\n  \"index_patterns\": [\"*\"],\n  \"order\" : 0,\n  \"version\": 1,\n  \"settings\": {\n    \"number_of_shards\": 1,\n    \"number_of_replicas\":1\n  }\n}\n</code></pre> <pre><code>PUT /_template/template_test\n{\n    \"index_patterns\" : [\"test*\"],\n    \"order\" : 1,\n    \"settings\" : {\n        \"number_of_shards\": 1,\n        \"number_of_replicas\" : 2\n    },\n    \"mappings\" : {\n        \"date_detection\": false,\n        \"numeric_detection\": true\n    }\n}\n</code></pre> <ul> <li><code>\"date_detection\": false,</code></li> <li><code>\"numeric_detection\": true</code></li> </ul> <p>\u67e5\u770btemplate\u4fe1\u606f</p> <pre><code>#\u67e5\u770btemplate\u4fe1\u606f\nGET /_template/template_default\nGET /_template/temp*\n</code></pre> <pre><code>PUT testtemplate/_doc/1\n{\n    \"someNumber\":\"1\",\n    \"someDate\":\"2019/01/01\"\n}\n</code></pre> <p>Dynamic Template</p> <p>\u6839\u636eElasticsearch\u8bc6\u522b\u7684\u6570\u636e\u7c7b\u578b\uff0c\u7ed3\u5408\u5b57\u6bb5\u540d\u79f0\uff0c\u6765\u52a8\u6001\u8bbe\u5b9a\u5b57\u6bb5\u7c7b\u578b</p> <ul> <li>\u6240\u6709\u7684\u5b57\u7b26\u4e32\u7c7b\u578b\u90fd\u8bbe\u5b9a\u6210Keyword\uff0c\u6216\u8005\u5173\u95edkeyword\u5b57\u6bb5</li> <li><code>is</code>\u5f00\u5934\u7684\u5b57\u6bb5\u90fd\u8bbe\u7f6e\u6210<code>boolean</code></li> <li> <p><code>long_</code>\u5f00\u5934\u7684\u90fd\u8bbe\u7f6e\u6210<code>long</code>\u7c7b\u578b</p> </li> <li> <p>Dynamic Tempate</p> <ul> <li>Dynamic Tempate\u662f\u5b9a\u4e49\u5728\u5728\u67d0\u4e2a\u7d22\u5f15\u7684Mapping\u4e2d</li> <li>Template\u6709\u4e00\u4e2a\u540d\u79f0</li> <li>\u5339\u914d\u89c4\u5219\u662f\u4e00\u4e2a\u6570\u7ec4</li> <li>\u4e3a\u5339\u914d\u5230\u5b57\u6bb5\u8bbe\u7f6eMapping</li> </ul> </li> <li> <p>\u5339\u914d\u89c4\u5219\u53c2\u6570</p> <ul> <li><code>match_mapping_type</code>\uff1a\u5339\u914d\u81ea\u52a8\u8bc6\u522b\u7684\u5b57\u6bb5\u7c7b\u578b \u5982string, boolean\u7b49</li> <li><code>match</code>, <code>unmatch</code>\uff1a\u5339\u914d\u5b57\u6bb5\u540d</li> <li><code>path_match</code>,<code>path_unmatch</code></li> </ul> </li> </ul> <pre><code>PUT my_index\n{\n  \"mappings\": {\n    \"dynamic_templates\": [\n            {\n        \"strings_as_boolean\": {\n          \"match_mapping_type\":   \"string\",\n          \"match\":\"is*\",\n          \"mapping\": {\n            \"type\": \"boolean\"\n          }\n        }\n      },\n      {\n        \"strings_as_keywords\": {\n          \"match_mapping_type\":   \"string\",\n          \"mapping\": {\n            \"type\": \"keyword\"\n          }\n        }\n      }\n    ]\n  }\n}\n</code></pre> <ul> <li>match, unmatch\uff1a\u5339\u914d\u5b57\u6bb5\u540d</li> </ul> <pre><code>#\u7ed3\u5408\u8def\u5f84\nPUT my_index\n{\n  \"mappings\": {\n    \"dynamic_templates\": [\n      {\n        \"full_name\": {\n          \"path_match\":   \"name.*\",\n          \"path_unmatch\": \"*.middle\",\n          \"mapping\": {\n            \"type\":       \"text\",\n            \"copy_to\":    \"full_name\"\n          }\n        }\n      }\n    ]\n  }\n}\n</code></pre> <pre><code>PUT my_index/_doc/1\n{\n  \"name\": {\n    \"first\":  \"John\",\n    \"middle\": \"Winston\",\n    \"last\":   \"Lennon\"\n  }\n}\n</code></pre> <pre><code>GET my_index/_search?q=full_name:John\n</code></pre>"},{"location":"chap19/sum1_search_api/#7elasticsearch-aggregations","title":"7\u3001Elasticsearch Aggregations\u805a\u5408\u5206\u6790\u7b80\u4ecb","text":"<ul> <li>Bucket</li> </ul> <pre><code>#\u6309\u7167\u76ee\u7684\u5730\u8fdb\u884c\u5206\u6876\u7edf\u8ba1\nGET kibana_sample_data_flights/_search\n{\n    \"size\": 0,\n    \"aggs\":{\n        \"flight_dest\":{\n            \"terms\":{\n                \"field\":\"DestCountry\"\n            }\n        }\n    }\n}\n</code></pre> <ul> <li>Metrics</li> </ul> <pre><code>#\u67e5\u770b\u822a\u73ed\u76ee\u7684\u5730\u7684\u7edf\u8ba1\u4fe1\u606f\uff0c\u589e\u52a0\u5e73\u5747\uff0c\u6700\u9ad8\u6700\u4f4e\u4ef7\u683c\nGET kibana_sample_data_flights/_search\n{\n    \"size\": 0,\n    \"aggs\":{\n        \"flight_dest\":{\n            \"terms\":{\n                \"field\":\"DestCountry\"\n            },\n            \"aggs\":{\n                \"avg_price\":{\n                    \"avg\":{\n                        \"field\":\"AvgTicketPrice\"\n                    }\n                },\n                \"max_price\":{\n                    \"max\":{\n                        \"field\":\"AvgTicketPrice\"\n                    }\n                },\n                \"min_price\":{\n                    \"min\":{\n                        \"field\":\"AvgTicketPrice\"\n                    }\n                }\n            }\n        }\n    }\n}\n</code></pre> <ul> <li>\u5d4c\u5957</li> </ul> <pre><code>#\u4ef7\u683c\u7edf\u8ba1\u4fe1\u606f+\u5929\u6c14\u4fe1\u606f\nGET kibana_sample_data_flights/_search\n{\n    \"size\": 0,\n    \"aggs\":{\n        \"flight_dest\":{\n            \"terms\":{\n                \"field\":\"DestCountry\"\n            },\n            \"aggs\":{\n                \"stats_price\":{\n                    \"stats\":{\n                        \"field\":\"AvgTicketPrice\"\n                    }\n                },\n                \"wather\":{\n                  \"terms\": {\n                    \"field\": \"DestWeather\",\n                    \"size\": 5\n                  }\n                }\n\n            }\n        }\n    }\n}\n</code></pre>"},{"location":"chap19/sum2_search_dep/","title":"Elasticsearch \u6df1\u5165\u641c\u7d22\u603b\u7ed3","text":""},{"location":"chap19/sum2_search_dep/#1","title":"1\u3001\u57fa\u4e8e\u8bcd\u9879\u548c\u57fa\u4e8e\u5168\u6587\u7684\u641c\u7d22","text":"<ul> <li>\u5982\u679c\u4e0d\u9700\u8981\u7b97\u5206\uff0c\u53ef\u4ee5\u901a\u8fc7Constant Score\uff0c\u5c06\u67e5\u8be2\u8f6c\u4e3aFiltering</li> <li>\u8303\u56f4\u67e5\u8be2\u548cDate Math</li> <li>\u4f7f\u7528Exist\u67e5\u8be2\u5904\u7406\u975e\u7a7aNull\u503c</li> <li>\u7cbe\u786e\u503c\uff06\u591a\u503c\u5b57\u6bb5\u7684\u7cbe\u786e\u503c\u67e5\u627e<ul> <li>Term\u67e5\u8be2\u662f\u5305\u542b\uff0c\u4e0d\u662f\u5b8c\u5168\u76f8\u7b49\u3002\u9488\u5bf9\u591a\u503c\u5b57\u6bb5\u67e5\u8be2\u8981\u5c24\u5176\u6ce8\u610f</li> </ul> </li> </ul> <p>1-1\u3001\u57fa\u4e8eTerm\u7684\u67e5\u8be2</p> <ul> <li>Term\u662f\u8868\u8fbe\u8bed\u610f\u7684\u6700\u5c0f\u5355\u4f4d\u3002\u641c\u7d22\u548c\u5229\u7528\u7edf\u8ba1\u8bed\u8a00\u6a21\u578b\u8fdb\u884c\u81ea\u7136\u8bed\u8a00\u5904\u7406\u90fd\u9700\u8981\u5904\u7406Term</li> <li>Term Level Query:Term Query\uff0fRange Query\uff0fExists Query\uff0fPrefix Query/Wildcard Query</li> </ul> <pre><code>POST /products/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"productID\" : \"XHDK-A-1293-#fJ3\",\"desc\":\"iPhone\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"productID\" : \"KDKE-B-9947-#kL5\",\"desc\":\"iPad\" }\n{ \"index\": { \"_id\": 3 }}\n{ \"productID\" : \"JODL-X-1937-#pV7\",\"desc\":\"MBP\" }\n</code></pre> <pre><code>POST /products/_search\n{\n  \"query\": {\n    \"term\": {\n      \"desc\": {\n        \"value\": \"iphone\"   \n      }\n    }\n  }\n}\n</code></pre> <pre><code>POST /products/_search\n{\n  \"query\": {\n    \"term\": {\n      \"productID\": {\n        \"value\": \"xhdk-a-1293-#fJ3\"\n      }\n    }\n  }\n}\n</code></pre> <p>\u591a\u5b57\u6bb5Mapping\u548cTerm\u67e5\u8be2</p> <pre><code>POST /products/_search\n{\n  \"query\": {\n    \"term\": {\n      \"productID.keyword\": {\n        \"value\": \"XHDK-A-1293-#fJ3\"\n      }\n    }\n  }\n}\n</code></pre> <p>\u590d\u5408\u67e5\u8be2\u4e00Constant Score\u8f6c\u4e3aFilter</p> <ul> <li>\u5c06Query\u8f6c\u6210Filter\uff0c\u5ffd\u7565TF-IDF\u8ba1\u7b97\uff0c\u907f\u514d\u76f8\u5173\u6027\u7b97\u5206\u7684\u5f00\u9500</li> <li>Filter\u53ef\u4ee5\u6709\u6548\u5229\u7528\u7f13\u5b58</li> </ul> <pre><code>POST /products/_search\n{\n  \"explain\": true,\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"term\": {\n          \"productID.keyword\": \"XHDK-A-1293-#fJ3\"\n        }\n      }\n    }\n  }\n}\n</code></pre> <p>1-2 \u57fa\u4e8e\u5168\u6587\u7684\u67e5\u8be2</p> <ul> <li>\u57fa\u4e8e\u5168\u6587\u7684\u67e5\u8be2<ul> <li>Match Query/Match Phrase Query/Query String Query</li> </ul> </li> </ul> <p>Match Query Result</p> <pre><code>POST movies/_search\n{\n  \"query\": {\n    \"match\": {\n      \"title\": {\n        \"query\": \"Matrix reloaded\"\n      }\n    }\n  }\n}\n</code></pre> <p>Operator</p> <pre><code>POST movies/_search\n{ \n  \"profile\": true,\n  \"query\": {\n    \"match\": {\n      \"title\": {\n        \"query\": \"Matrix reloaded\",\n        \"operator\": \"AND\"\n      }\n    }\n  }\n}\n</code></pre> <p><code>Minimum_should_match</code></p> <pre><code>POST movies/_search\n{ \n  \"profile\": true,\n  \"query\": {\n    \"match\": {\n      \"title\": {\n        \"query\": \"Matrix reloaded\",\n        \"minimum_should_match\": 2\n      }\n    }\n  }\n}\n</code></pre> <p>Match Phrase Query</p> <pre><code>POST movies/_search\n{ \n  \"profile\": true,\n  \"query\": {\n    \"match_phrase\": {\n      \"title\": {\n        \"query\": \"Matrix reloaded\",\n        \"slop\": 1\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"chap19/sum2_search_dep/#2","title":"2\u3001\u7ed3\u6784\u5316\u641c\u7d22\u4ee5\u53ca\u641c\u7d22\u7684\u76f8\u5173\u6027\u7b97\u5206","text":"<p>1\u3001ES\u4e2d\u7684\u7ed3\u6784\u5316\u641c\u7d22</p> <ul> <li>\u5e03\u5c14\uff0c\u65f6\u95f4\uff0c\u65e5\u671f\u548c\u6570\u5b57\u8fd9\u7c7b\u7ed3\u6784\u5316\u6570\u636e\uff1a</li> <li>\u7ed3\u6784\u5316\u7684\u6587\u672c\u53ef\u4ee5\u505a\u7cbe\u786e\u5339\u914d\u6216\u8005\u90e8\u5206\u5339\u914d</li> <li> <p>\u7ed3\u6784\u5316\u7ed3\u679c\u53ea\u6709\u201c\u662f\u201d\u6216\u201c\u5426\u201d\u4e24\u4e2a\u503c</p> </li> <li> <p>\u5bf9\u5e03\u5c14\u503c match \u67e5\u8be2\uff0c\u6709\u7b97\u5206</p> </li> </ul> <pre><code>POST products/_search\n{\n  \"query\": {\n    \"term\": {\n      \"avaliable\": {\n        \"value\": \"false\"\n      }\n    }\n  }\n}\n\n\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"term\": {\n      \"avaliable\": true\n    }\n  }\n}\n</code></pre> <p>\u5bf9\u5e03\u5c14\u503c\uff0c\u901a\u8fc7 <code>constant score</code> \u8f6c\u6210 <code>filtering</code>\uff0c\u6ca1\u6709\u7b97\u5206</p> <pre><code>POST products/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"term\": {\n          \"avaliable\": \"false\"\n        }\n      }\n    }\n  }\n}\n</code></pre> <ul> <li>\u6570\u5b57Range<ul> <li>gt\u5927\u4e8e</li> <li>It\u5c0f\u4e8e</li> <li>gte\u5927\u4e8e\u7b49\u4e8e</li> <li>lte \u5c0f\u4e8e\u7b49\u4e8e</li> </ul> </li> </ul> <pre><code># \u6570\u5b57\u7c7b\u578b Term\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"term\": {\n      \"price\": 30\n    }\n  }\n}\n</code></pre> <ul> <li>\u65e5\u671f range</li> </ul> <pre><code>POST products/_search\n{\n    \"query\" : {\n        \"constant_score\" : {\n            \"filter\" : {\n                \"range\" : {\n                    \"date\" : {\n                      \"gte\" : \"now-2y\"\n                    }\n                }\n            }\n        }\n    }\n}\n</code></pre> <ul> <li>\u5904\u7406\u7a7a\u503c</li> </ul> <pre><code>#exists\u67e5\u8be2\nPOST products/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"exists\": {\n          \"field\": \"date\"\n        }\n      }\n    }\n  }\n}\n</code></pre> <pre><code># \"bool\": { \"must_not\" }\n\nPOST products/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"bool\": {\n          \"must_not\": {\n            \"exists\": {\n              \"field\": \"date\"\n            }\n          }\n        }\n      }\n    }\n  }\n}\n</code></pre> <ul> <li>\u5904\u7406\u591a\u503c\u5b57\u6bb5\uff0cterm \u67e5\u8be2\u662f\u5305\u542b\uff0c\u800c\u4e0d\u662f\u7b49\u4e8e</li> </ul> <pre><code>POST movies/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"term\": {\n          \"genre.keyword\": \"Comedy\"\n        }\n      }\n    }\n  }\n}\n</code></pre> <ul> <li>\u67e5\u627e\u591a\u4e2a\u7cbe\u786e\u503c</li> </ul> <pre><code>#\u6570\u5b57\u7c7b\u578b terms\nPOST products/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"terms\": {\n          \"price\": [\n            \"20\",\n            \"30\"\n          ]\n        }\n      }\n    }\n  }\n}\n</code></pre> <ul> <li>\u5b57\u7b26\u7c7b\u578b terms</li> </ul> <pre><code>#\u5b57\u7b26\u7c7b\u578b terms\nPOST products/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"terms\": {\n          \"productID.keyword\": [\n            \"QQPX-R-3956-#aD8\",\n            \"JODL-X-1937-#pV7\"\n          ]\n        }\n      }\n    }\n  }\n}\n</code></pre> <ul> <li>Term VS Match</li> </ul> <pre><code>POST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"term\": {\n          \"productID.keyword\": \"XHDK-A-1293-#fJ3\"\n        }\n      }\n    }\n  }\n}\n\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"term\": {\n      \"productID.keyword\": \"XHDK-A-1293-#fJ3\"\n    }\n  }\n}\n</code></pre> <pre><code>POST products/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"term\": {\n          \"avaliable\": \"false\"\n        }\n      }\n    }\n  }\n}\n\nPOST products/_search\n{\n  \"query\": {\n    \"term\": {\n      \"avaliable\": {\n        \"value\": \"false\"\n      }\n    }\n  }\n}\n</code></pre> <p>2\u3001\u641c\u7d22\u7684\u76f8\u5173\u6027\u7b97\u5206</p> <ul> <li>\u76f8\u5173\u6027\u548c\u76f8\u5173\u6027\u7b97\u5206</li> <li>\u8bcd\u9891TF</li> <li>\u9006\u6587\u6863\u9891\u7387IDF</li> <li>TF-IDF \u7684\u6982\u5ff5</li> <li>Boosting Relvance</li> </ul> <pre><code>POST testscore/_search\n{\n    \"query\": {\n        \"boosting\" : {\n            \"positive\" : {\n                \"term\" : {\n                    \"content\" : \"elasticsearch\"\n                }\n            },\n            \"negative\" : {\n                 \"term\" : {\n                     \"content\" : \"like\"\n                }\n            },\n            \"negative_boost\" : 0.2\n        }\n    }\n}\n</code></pre>"},{"location":"chap19/sum2_search_dep/#3-query-filtering","title":"3\u3001 Query &amp; Filtering\u4e0e\u591a\u5b57\u7b26\u4e32\u591a\u5b57\u6bb5\u67e5\u8be2","text":"<p>Elasticsearch\u4e2d\uff0c\u6709Query\u548cFilter\u4e24\u79cd\u4e0d\u540c Context</p> <ul> <li>Query Context\uff1a\u76f8\u5173\u6027\u7b97\u5206</li> <li> <p>Filter Context: \u4e0d\u9700\u8981\u7b97\u5206\uff08Yes or No) \uff0c\u53ef\u4ee5\u5229\u7528Cache\uff0c\u83b7\u5f97\u66f4\u597d\u7684\u6027\u80fd</p> </li> <li> <p>must / should =&gt; count score</p> </li> <li><code>must_not</code> / filter =&gt; not count score</li> </ul> <p>bool\u67e5\u8be2</p> <pre><code>#\u57fa\u672c\u8bed\u6cd5\nPOST /products/_search\n{\n  \"query\": {\n    \"bool\" : {\n      \"must\" : {\n        \"term\" : { \"price\" : \"30\" }\n      },\n      \"filter\": {\n        \"term\" : { \"avaliable\" : \"true\" }\n      },\n      \"must_not\" : {\n        \"range\" : {\n          \"price\" : { \"lte\" : 10 }\n        }\n      },\n      \"should\" : [\n        { \"term\" : { \"productID.keyword\" : \"JODL-X-1937-#pV7\" } },\n        { \"term\" : { \"productID.keyword\" : \"XHDK-A-1293-#fJ3\" } }\n      ],\n      \"minimum_should_match\" :1\n    }\n  }\n}\n</code></pre> <p>\u5982\u4f55\u89e3\u51b3\u7ed3\u6784\u5316\u67e5\u8be2\u4e00\u201c\u5305\u542b\u800c\u4e0d\u662f\u76f8\u7b49\u201d\u7684\u95ee\u9898</p> <pre><code>POST /movies/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"term\": {\n            \"genre.keyword\": \"Comedy\"\n        }\n      }\n    }\n  }\n}\n</code></pre> <p>\u589e\u52a0count\u5b57\u6bb5\uff0c\u4f7f\u7528bool\u67e5\u8be2\u89e3\u51b3</p> <pre><code># must\uff0c\u6709\u7b97\u5206: \"_score\" : 1.2111092,\nPOST /newmovies/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\"term\": {\"genre.keyword\": {\"value\": \"Comedy\"}}},\n        {\"term\": {\"genre_count\": {\"value\": 1}}}\n\n      ]\n    }\n  }\n }\n</code></pre> <pre><code>#Filter\u3002\u4e0d\u53c2\u4e0e\u7b97\u5206\uff0c\u7ed3\u679c\u7684score\u662f0\nPOST /newmovies/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"filter\": [\n        {\"term\": {\"genre.keyword\": {\"value\": \"Comedy\"}}},\n        {\"term\": {\"genre_count\": {\"value\": 1}}}\n        ]\n\n    }\n  }\n}\n</code></pre> <p>Filter Context\u4e00\u4e0d\u5f71\u54cd\u7b97\u5206</p> <pre><code>#Filtering Context\nPOST _search\n{\n  \"query\": {\n    \"bool\" : {\n\n      \"filter\": {\n        \"term\" : { \"avaliable\" : \"true\" }\n      },\n      \"must_not\" : {\n        \"range\" : {\n          \"price\" : { \"lte\" : 10 }\n        }\n      }\n    }\n  }\n}\n</code></pre> <p>Query Context\u4e00\u5f71\u54cd\u7b97\u5206</p> <pre><code>POST /products/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"should\": [\n        {\n          \"term\": {\n            \"productID.keyword\": {\n              \"value\": \"JODL-X-1937-#pV7\"}}\n        },\n        {\"term\": {\"avaliable\": {\"value\": true}}\n        }\n      ]\n    }\n  }\n}\n</code></pre> <p>Bool\u5d4c\u5957 \u5b9e\u73b0\u4e86should not\u7684\u903b\u8f91</p> <pre><code>POST /products/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": {\n        \"term\": {\n          \"price\": \"30\"\n        }\n      },\n      \"should\": [\n        {\n          \"bool\": {\n            \"must_not\": {\n              \"term\": {\n                \"avaliable\": \"false\"\n              }\n            }\n          }\n        }\n      ],\n      \"minimum_should_match\": 1\n    }\n  }\n}\n</code></pre> <p>Controll the Precision</p> <pre><code>POST _search\n{\n  \"query\": {\n    \"bool\" : {\n      \"must\" : {\n        \"term\" : { \"price\" : \"30\" }\n      },\n      \"filter\": {\n        \"term\" : { \"avaliable\" : \"true\" }\n      },\n      \"must_not\" : {\n        \"range\" : {\n          \"price\" : { \"lte\" : 10 }\n        }\n      },\n      \"should\" : [\n        { \"term\" : { \"productID.keyword\" : \"JODL-X-1937-#pV7\" } },\n        { \"term\" : { \"productID.keyword\" : \"XHDK-A-1293-#fJ3\" } }\n      ],\n      \"minimum_should_match\" :2\n    }\n  }\n}\n</code></pre> <p>\u67e5\u8be2\u8bed\u53e5\u7684\u7ed3\u6784\uff0c\u4f1a\u5bf9\u76f8\u5173\u5ea6\u7b97\u5206\u4ea7\u751f\u5f71\u54cd</p> <pre><code>POST /animals/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"should\": [\n        { \"term\": { \"text\": \"brown\" }},\n        { \"term\": { \"text\": \"red\" }},\n        { \"term\": { \"text\": \"quick\"   }},\n        { \"term\": { \"text\": \"dog\"   }}\n      ]\n    }\n  }\n}\n</code></pre> <pre><code>POST /animals/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"should\": [\n        { \"term\": { \"text\": \"quick\" }},\n        { \"term\": { \"text\": \"dog\"   }},\n        {\n          \"bool\":{\n            \"should\":[\n               { \"term\": { \"text\": \"brown\" }},\n                 { \"term\": { \"text\": \"brown\" }},\n            ]\n          }\n\n        }\n      ]\n    }\n  }\n</code></pre> <ul> <li>\u540c\u4e00\u5c42\u7ea7\u4e0b\u7684\u7ade\u4e89\u5b57\u6bb5\uff0c\u5177\u6709\u6709\u76f8\u540c\u7684\u6743\u91cd</li> <li>\u901a\u8fc7\u5d4c\u5957bool\u67e5\u8be2\uff0c\u53ef\u4ee5\u6539\u53d8\u5bf9\u7b97\u5206\u7684\u5f71\u54cd</li> </ul> <p>\u63a7\u5236\u5b57\u6bb5\u7684Boosting</p> <pre><code>POST blogs/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"should\": [\n        {\"match\": {\n          \"title\": {\n            \"query\": \"apple,ipad\",\n            \"boost\": 4\n          }\n        }},\n\n        {\"match\": {\n          \"content\": {\n            \"query\": \"apple,ipad\",\n            \"boost\": 1\n          }\n        }}\n      ]\n    }\n  }\n}\n</code></pre> <p>Not Quite Not</p> <pre><code>POST news/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": {\n        \"match\":{\"content\":\"apple\"}\n      }\n    }\n  }\n}\n</code></pre> <p>Boosting Query</p> <pre><code>POST news/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": {\n        \"match\":{\"content\":\"apple\"}\n      },\n      \"must_not\": {\n        \"match\":{\"content\":\"pie\"}\n      }\n    }\n  }\n</code></pre> <p>Negative Boost</p> <pre><code>POST news/_search\n{\n  \"query\": {\n    \"boosting\": {\n      \"positive\": {\n        \"match\": {\n          \"content\": \"apple\"\n        }\n      },\n      \"negative\": {\n        \"match\": {\n          \"content\": \"pie\"\n        }\n      },\n      \"negative_boost\": 0.5\n    }\n  }\n}\n</code></pre>"},{"location":"chap19/sum2_search_dep/#4","title":"4\u3001\u5355\u5b57\u7b26\u4e32\u591a\u5b57\u6bb5\u67e5\u8be2","text":"<pre><code>PUT /blogs/_doc/1\n{\n    \"title\": \"Quick brown rabbits\",\n    \"body\":  \"Brown rabbits are commonly seen.\"\n}\n\nPUT /blogs/_doc/2\n{\n    \"title\": \"Keeping pets healthy\",\n    \"body\":  \"My quick brown fox eats rabbits on a regular basis.\"\n}\n</code></pre> <p>\u5355\u5b57\u7b26\u4e32\u591a\u5b57\u6bb5\u67e5\u8be2 Dis Max Query</p> <p>\u7b97\u5206\u8fc7\u7a0b</p> <ul> <li>\u67e5\u8be2should\u8bed\u53e5\u4e2d\u7684\u4e24\u4e2a\u67e5\u8be2</li> <li>\u52a0\u548c\u4e24\u4e2a\u67e5\u8be2\u7684\u8bc4\u5206</li> <li>\u4e58\u4ee5\u5339\u914d\u8bed\u53e5\u7684\u603b\u6570</li> <li>\u9664\u4ee5\u6240\u6709\u8bed\u53e5\u7684\u603b\u6570</li> </ul> <pre><code>POST /blogs/_search\n{\n    \"query\": {\n        \"bool\": {\n            \"should\": [\n                { \"match\": { \"title\": \"Brown fox\" }},\n                { \"match\": { \"body\":  \"Brown fox\" }}\n            ]\n        }\n    }\n}\n</code></pre> <p>Disjunction Max Query\u67e5\u8be2</p> <ul> <li>\u4e0d\u5e94\u8be5\u5c06\u5206\u6570\u7b80\u5355\u5168\u52a0\u800c\u662f\u5e94\u8be5\u627e\u5230\u5355\u4e2a\u6700\u4f73\u5339\u914d\u7684\u5b57\u6bb5\u7684\u8bc4\u5206</li> <li>\u5c06\u4efb\u4f55\u4e0e\u4efb\u4e00\u67e5\u8be2\u5339\u914d\u7684\u6587\u6863\u4f5c\u4e3a\u7ed3\u679c\u8fd4\u56de\u3002\u91c7\u7528\u5b57\u6bb5\u4e0a\u6700\u5339\u914d\u7684\u8bc4\u5206\u6700\u7ec8\u8bc4\u5206\u8fd4\u56de</li> </ul> <pre><code>POST blogs/_search\n{\n    \"query\": {\n        \"dis_max\": {\n            \"queries\": [\n                { \"match\": { \"title\": \"Brown fox\" }},\n                { \"match\": { \"body\":  \"Brown fox\" }}\n            ]\n        }\n    }\n}\n</code></pre> <p>\u901a\u8fc7Tie Breaker\u53c2\u6570\u8c03\u6574</p> <pre><code>POST blogs/_search\n{\n    \"query\": {\n        \"dis_max\": {\n            \"queries\": [\n                { \"match\": { \"title\": \"Quick pets\" }},\n                { \"match\": { \"body\":  \"Quick pets\" }}\n            ],\n            \"tie_breaker\": 0.2\n        }\n    }\n}\n</code></pre> <p>Tier Breaker\u662f\u4e00\u4e2a\u4ecb\u4e8e0-1\u4e4b\u95f4\u7684\u6d6e\u70b9\u6570\u30020\u4ee3\u8868\u4f7f\u7528\u6700\u4f73\u5339\u914d\uff1b1\u4ee3\u8868\u6240\u6709\u8bed\u53e5\u540c\u7b49\u91cd\u8981.</p> <p>\u5355\u5b57\u7b26\u4e32\u591a\u5b57\u6bb5\u67e5\u8be2\uff1aMulti Match</p> <p>\u4e09\u79cd\u573a\u666f</p> <ul> <li>\u6700\u4f73\u5b57\u6bb5\uff08Best Fields)</li> <li>\u591a\u6570\u5b57\u6bb5\uff08Most Fields)</li> <li>\u6df7\u5408\u5b57\u6bb5\uff08Cross Field)</li> </ul> <p>Multi Match Query</p> <ul> <li>Best Fields\u662f\u9ed8\u8ba4\u7c7b\u578b\u53ef\u4ee5\u4e0d\u7528\u6307\u5b9a</li> <li>Minimum should match\u7b49\u53c2\u6570\u53ef\u4ee5\u4f20\u9012\u5230\u751f\u6210\u7684query\u4e2d</li> </ul> <pre><code>POST blogs/_search\n{\n    \"query\": {\n        \"dis_max\": {\n            \"queries\": [\n                { \"match\": { \"title\": \"Quick pets\" }},\n                { \"match\": { \"body\":  \"Quick pets\" }}\n            ],\n            \"tie_breaker\": 0.2\n        }\n    }\n}\n</code></pre> <p>\u4f7f\u7528\u591a\u6570\u5b57\u6bb5\u5339\u914d\u89e3\u51b3</p> <p>\u7528\u5e7f\u5ea6\u5339\u914d\u5b57\u6bb5title\u5305\u62ec\u5c3d\u53ef\u80fd\u591a\u7684\u6587\u6863\u2014\u2014\u4ee5\u63d0\u5347\u53ec\u56de\u7387\u2014\u2014\u540c\u65f6\u53c8\u4f7f\u7528\u5b57\u6bb5title.std\u4f5c\u4e3a\u4fe1\u53f7\u5c06\u76f8\u5173\u5ea6\u66f4\u9ad8\u7684\u6587\u6863\u7f6e\u4e8e\u7ed3\u679c\u9876\u90e8\u3002</p> <pre><code>GET /titles/_search\n{\n   \"query\": {\n        \"multi_match\": {\n            \"query\":  \"barking dogs\",\n            \"type\":   \"most_fields\",\n            \"fields\": [ \"title\", \"title.std\" ]\n        }\n    }\n}\n</code></pre> <ul> <li>\u6bcf\u4e2a\u5b57\u6bb5\u5bf9\u4e8e\u6700\u7ec8\u8bc4\u5206\u7684\u8d21\u732e\u53ef\u4ee5\u901a\u8fc7\u81ea\u5b9a\u4e49\u503cboost\u6765\u63a7\u5236\u3002\u6bd4\u5982\uff0c\u4f7ftitle\u5b57\u6bb5\u66f4\u4e3a\u91cd\u8981\uff0c \u8fd9\u6837\u540c\u65f6\u4e5f\u964d\u4f4e\u4e86\u5176\u4ed6\u4fe1\u53f7\u5b57\u6bb5\u7684\u4f5c\u7528\uff1a</li> </ul> <pre><code>GET /titles/_search\n{\n   \"query\": {\n        \"multi_match\": {\n            \"query\":  \"barking dogs\",\n            \"type\":   \"most_fields\",\n            \"fields\": [ \"title^10\", \"title.std\" ]\n        }\n    }\n}\n</code></pre> <p>\u8de8\u5b57\u6bb5\u641c\u7d22</p> <ul> <li>\u65e0\u6cd5\u4f7f\u7528Operator</li> <li>\u53ef\u4ee5\u7528<code>copy_to</code>\u89e3\u51b3\uff0c\u4f46\u662f\u9700\u8981\u989d\u5916\u7684\u5b58\u50a8\u7a7a\u95f4</li> </ul> <pre><code>post address/_search\n{\n    \"query\": {\n        \"multi_match\": {\n            \"query\" :  \"Poland Street W1V\",\n            \"type\" :   \"most_fields\",\n            \"fields\" : [ \"street\", \"city\", \"coutry\",  \"poscode\"]\n        }\n    }\n}\n</code></pre> <p>Cross Field</p> <pre><code>post address/_search\n{\n    \"query\": {\n        \"multi_match\": {\n            \"query\" :  \"Poland Street W1V\",\n            \"type\" :   \"cross_fields\",\n            \"operator\": \"and\", \n            \"fields\" : [ \"street\", \"city\", \"coutry\",  \"poscode\"]\n        }\n    }\n}\n</code></pre> <p>5\u3001\u591a\u8bed\u8a00\u53ca\u4e2d\u6587\u5206\u8bcd\u4e0e\u68c0\u7d22</p> <pre><code>POST _analyze\n{\n  \"analyzer\": \"hanlp_standard\",\n  \"text\": [\"\u5251\u6865\u5206\u6790\u516c\u53f8\u591a\u4f4d\u9ad8\u7ba1\u5bf9\u5367\u5e95\u8bb0\u8005\u8bf4\uff0c\u4ed6\u4eec\u786e\u4fdd\u4e86\u5510\u7eb3\u5fb7\u00b7\u7279\u6717\u666e\u5728\u603b\u7edf\u5927\u9009\u4e2d\u83b7\u80dc\"]\n} \n</code></pre> <pre><code>#Pinyin\nPUT /artists/\n{\n    \"settings\" : {\n        \"analysis\" : {\n            \"analyzer\" : {\n                \"user_name_analyzer\" : {\n                    \"tokenizer\" : \"whitespace\",\n                    \"filter\" : \"pinyin_first_letter_and_full_pinyin_filter\"\n                }\n            },\n            \"filter\" : {\n                \"pinyin_first_letter_and_full_pinyin_filter\" : {\n                    \"type\" : \"pinyin\",\n                    \"keep_first_letter\" : true,\n                    \"keep_full_pinyin\" : false,\n                    \"keep_none_chinese\" : true,\n                    \"keep_original\" : false,\n                    \"limit_first_letter_length\" : 16,\n                    \"lowercase\" : true,\n                    \"trim_whitespace\" : true,\n                    \"keep_none_chinese_in_first_letter\" : true\n                }\n            }\n        }\n    }\n}\n\n\nGET /artists/_analyze\n{\n  \"text\": [\"\u5218\u5fb7\u534e \u5f20\u5b66\u53cb \u90ed\u5bcc\u57ce \u9ece\u660e \u56db\u5927\u5929\u738b\"],\n  \"analyzer\": \"user_name_analyzer\"\n}\n</code></pre>"},{"location":"chap19/sum2_search_dep/#6-search-template-index-alias","title":"6\u3001\u4f7f\u2f64 Search Template \u548c Index Alias","text":"<p>Search Template \u2013 \u89e3\u8026\u7a0b\u5e8f &amp; \u641c\u7d22 DSL</p> <ul> <li>\u641c\u7d22\u2f2f\u7a0b\u5e08\uff1a</li> </ul> <pre><code>POST _scripts/tmdb\n{\n  \"script\": {\n    \"lang\": \"mustache\",\n    \"source\": {\n      \"_source\": [\n        \"title\",\"overview\"\n      ],\n      \"size\": 20,\n      \"query\": {\n        \"multi_match\": {\n          \"query\": \"{{q}}\",\n          \"fields\": [\"title\",\"overview\"]\n        }\n      }\n    }\n  }\n}\n</code></pre> <p>\u4f7f\u2f64 Search Template \u8fdb\u884c\u67e5\u8be2</p> <ul> <li>\u6027\u80fd\u5de5\u7a0b\u5e08</li> </ul> <pre><code>POST tmdb/_search/template\n{\n    \"id\":\"tmdb\",\n    \"params\": {\n        \"q\": \"basketball with cartoon aliens\"\n    }\n}\n</code></pre> <p>Index Alias \u5b9e\u73b0\u96f6\u505c\u673a\u8fd0\u7ef4</p> <pre><code>POST _aliases\n{\n  \"actions\": [\n    {\n      \"add\": {\n        \"index\": \"movies-2019\",\n        \"alias\": \"movies-latest\"\n      }\n    }\n  ]\n}\n</code></pre> <pre><code>POST movies-latest/_search\n{\n  \"query\": {\n    \"match_all\": {}\n  }\n}\n</code></pre> <p>\u4f7f\u7528 Alias \u521b\u5efa\u4e0d\u540c\u67e5\u8be2\u7684\u89c6\u56fe</p> <pre><code>POST _aliases\n{\n  \"actions\": [\n    {\n      \"add\": {\n        \"index\": \"movies-2019\",\n        \"alias\": \"movies-lastest-highrate\",\n        \"filter\": {\n          \"range\": {\n            \"rating\": {\n              \"gte\": 4\n            }\n          }\n        }\n      }\n    }\n  ]\n}\n</code></pre> <pre><code>POST movies-lastest-highrate/_search\n{\n  \"query\": {\n    \"match_all\": {}\n  }\n}\n</code></pre>"},{"location":"chap19/sum2_search_dep/#7-function-score-query","title":"7\u3001 \u7efc\u5408\u6392\u5e8f:Function Score Query \u4f18\u5316\u7b97\u5206","text":"<p>Function Score Query</p> <p>\u63d0\u4f9b\u4e86\u2f0f\u79cd\u9ed8\u8ba4\u7684\u8ba1\u7b97\u5206\u503c\u7684\u51fd\u6570</p> <ul> <li>Weight :\u4e3a\u6bcf\u2f00\u4e2a\u2f42\u6863\u8bbe\u7f6e\u2f00\u4e2a\u7b80\u5355\u800c\u4e0d\u88ab\u89c4\u8303\u5316\u7684\u6743\u91cd</li> <li>Field Value Factor:\u4f7f\u2f64\u7528\u8be5\u6570\u503c\u6765\u4fee\u6539 <code>_score</code>\uff0c\u4f8b\u4f8b\u5982\u5c06 \u201c\u70ed\u5ea6\u201d\u548c\u201c\u70b9\u8d5e\u6570\u201d\u4f5c\u4e3a\u7b97\u5206\u7684\u53c2\u8003\u56e0\u7d20</li> <li>Random Score:\u4e3a\u6bcf\u2f00\u4e2a\u7528\u6237\u4f7f\u2f64\u2f00\u4e2a\u4e0d\u540c\u7684\uff0c\u968f\u673a\u7b97\u5206\u7ed3\u679c</li> <li>\u8870\u51cf\u51fd\u6570: \u4ee5\u67d0\u4e2a\u5b57\u6bb5\u7684\u503c\u4e3a\u6807\u51c6\uff0c\u8ddd\u79bb\u67d0\u4e2a\u503c\u8d8a\u8fd1\uff0c\u5f97\u5206\u8d8a\u2fbc</li> <li>Script Score:\u81ea\u5b9a\u4e49\u811a\u672c\u5b8c\u5168\u63a7\u5236\u6240\u9700\u903b\u8f91 </li> </ul> <p>\u6309\u53d7\u6b22\u8fce\u5ea6\u63d0\u5347\u6743\u91cd</p> <pre><code>PUT /blogs/_doc/1\n{\n  \"title\":   \"About popularity\",\n  \"content\": \"In this post we will talk about...\",\n  \"votes\":   0\n}\n</code></pre> <pre><code>POST /blogs/_search\n{\n  \"query\": {\n    \"function_score\": {\n      \"query\": {\n        \"multi_match\": {\n          \"query\":    \"popularity\",\n          \"fields\": [ \"title\", \"content\" ]\n        }\n      },\n      \"field_value_factor\": {\n        \"field\": \"votes\"\n      }\n    }\n  }\n}\n</code></pre> <p>\u4f7f\u2f64 Modifier \u5e73\u6ed1\u66f2\u7ebf</p> <pre><code>POST /blogs/_search\n{\n  \"query\": {\n    \"function_score\": {\n      \"query\": {\n        \"multi_match\": {\n          \"query\":    \"popularity\",\n          \"fields\": [ \"title\", \"content\" ]\n        }\n      },\n      \"field_value_factor\": {\n        \"field\": \"votes\",\n        \"modifier\": \"log1p\"\n      }\n    }\n  }\n}\n</code></pre> <p>\u5f15\u2f0a Factor</p> <p><code>\u65b0\u7684\u7b97\u5206=\u2f7c\u7684\u7b97\u5206*log(1+factor*\u6295\u7968\u6570)</code></p> <pre><code>POST /blogs/_search\n{\n  \"query\": {\n    \"function_score\": {\n      \"query\": {\n        \"multi_match\": {\n          \"query\":    \"popularity\",\n          \"fields\": [ \"title\", \"content\" ]\n        }\n      },\n      \"field_value_factor\": {\n        \"field\": \"votes\",\n        \"modifier\": \"log1p\" ,\n        \"factor\": 0.1\n      }\n    }\n  }\n}\n</code></pre> <p>Boost Mode \u548c Max Boost</p> <pre><code>POST /blogs/_search\n{\n  \"query\": {\n    \"function_score\": {\n      \"query\": {\n        \"multi_match\": {\n          \"query\":    \"popularity\",\n          \"fields\": [ \"title\", \"content\" ]\n        }\n      },\n      \"field_value_factor\": {\n        \"field\": \"votes\",\n        \"modifier\": \"log1p\" ,\n        \"factor\": 0.1\n      },\n      \"boost_mode\": \"sum\",\n      \"max_boost\": 3\n    }\n  }\n}\n</code></pre> <p>\u2f00\u81f4\u6027\u968f\u673a\u51fd\u6570</p> <pre><code>POST /blogs/_search\n{\n  \"query\": {\n    \"function_score\": {\n      \"random_score\": {\n        \"seed\": 911119\n      }\n    }\n  }\n}\n</code></pre> <p>8\u3001Term &amp; Phrase Suggester</p> <p>Term Suggester</p> <ul> <li>Suggester \u5c31\u662f\u4e00\u79cd\u7279\u6b8a\u7c7b\u578b\u7684\u641c\u7d22\u3002\u201dtext\u201d \u2fa5\u662f\u8c03\u2f64\u65f6\u5019\u63d0\u4f9b\u7684\u2f42\u672c\uff0c\u901a\u5e38\u6765\u2f83\u4e8e\u2f64\u6237\u754c\u9762\u4e0a\u2f64\u7528\u6237\u8f93\u2f0a\u7684\u5185\u5bb9</li> </ul> <pre><code>PUT articles\n{\n  \"mappings\": {\n    \"properties\": {\n      \"title_completion\":{\n        \"type\": \"completion\"\n      }\n    }\n  }\n}\n</code></pre> <pre><code>POST articles/_search?pretty\n{\n  \"size\": 0,\n  \"suggest\": {\n    \"article-suggester\": {\n      \"prefix\": \"elk \",\n      \"completion\": {\n        \"field\": \"title_completion\"\n      }\n    }\n  }\n}\n</code></pre> <p>Suggester \u2013 Missing Mode</p> <p>\u51e0\u79cd Suggestion Mode</p> <ul> <li>Missing \u2013 \u5982\u7d22\u5f15\u4e2d\u5df2\u7ecf\u5b58\u5728\uff0c\u5c31\u4e0d\u63d0\u4f9b\u5efa\u8bae</li> <li>Popular \u2013 \u63a8\u8350\u51fa\u73b0\u9891\u7387\u66f4\u52a0\u2fbc\u7684\u8bcd</li> <li>Always \u2013 \u2f46\u8bba\u662f\u5426\u5b58\u5728\uff0c\u90fd\u63d0\u4f9b\u5efa\u8bae</li> </ul> <p>Term Suggester \u2013 Popular Mode</p> <p>Popular \u2013 \u63a8\u8350\u51fa\u73b0\u9891\u7387\u66f4\u52a0\u2fbc\u7684\u8bcd</p> <pre><code>POST /articles/_search\n{\n\n  \"suggest\": {\n    \"term-suggestion\": {\n      \"text\": \"lucen rock\",\n      \"term\": {\n        \"suggest_mode\": \"popular\",\n        \"field\": \"body\"\n      }\n    }\n  }\n}\n</code></pre> <p>Term Suggester \u2013 Missing Mode</p> <ul> <li>Missing \u2013 \u5982\u7d22\u5f15\u4e2d\u5df2\u7ecf\u5b58\u5728\uff0c\u5c31\u4e0d\u63d0\u4f9b\u5efa\u8bae</li> </ul> <pre><code>POST /articles/_search\n{\n  \"size\": 1,\n  \"query\": {\n    \"match\": {\n      \"body\": \"lucen rock\"\n    }\n  },\n  \"suggest\": {\n    \"term-suggestion\": {\n      \"text\": \"lucen rock\",\n      \"term\": {\n        \"suggest_mode\": \"missing\",\n        \"field\": \"body\"\n      }\n    }\n  }\n}\n</code></pre> <p>Term Suggester \u2013 Always Mode</p> <ul> <li>always \u2013 \u2f46\u8bba\u662f\u5426\u5b58\u5728\uff0c\u90fd\u63d0\u4f9b\u5efa\u8bae</li> </ul> <pre><code>POST /articles/_search\n{\n  \"suggest\": {\n    \"term-suggestion\": {\n      \"text\": \"lucen rock\",\n      \"term\": {\n        \"suggest_mode\": \"always\",\n        \"field\": \"body\"\n      }\n    }\n  }\n}\n</code></pre> <p>Sorting by Frequency &amp; Prefix Length</p> <ul> <li>\u9ed8\u8ba4\u6309\u7167 score \u6392\u5e8f\uff0c\u4e5f\u53ef\u4ee5\u6309\u7167 \u201cfrequency\u201d</li> <li>\u9ed8\u8ba4\u2fb8\u9996\u5b57\u2e9f\u4e0d\u2f00\u81f4\u5c31\u4e0d\u4f1a\u5339\u914d\u63a8\u8350\uff0c\u4f46\u662f\u5982\u679c\u5c06 <code>prefix_length</code> \u8bbe\u7f6e\u4e3a <code>0</code>\uff0c\u5c31\u4f1a\u4e3a <code>hock</code> \u5efa\u8bae <code>rock</code></li> </ul> <pre><code>POST /articles/_search\n{\n\n  \"suggest\": {\n    \"term-suggestion\": {\n      \"text\": \"lucen hocks\",\n      \"term\": {\n        \"suggest_mode\": \"always\",\n        \"field\": \"body\",\n        \"prefix_length\":0,\n        \"sort\": \"frequency\"\n      }\n    }\n  }\n}\n</code></pre> <p>Phrase Suggester</p> <ul> <li>Phrase Suggester \u5728 Term Suggester \u4e0a\u589e\u52a0\u4e86\u4e00\u4e9b\u989d\u5916\u7684\u903b\u8f91</li> <li>\u4e00\u4e9b\u53c2\u6570<ul> <li>Suggest Mode :missing, popular, always</li> <li>Max Errors:\u6700\u591a\u53ef\u4ee5\u62fc\u9519\u7684 Terms \u6570</li> <li>Confidence:\u9650\u5236\u8fd4\u56de\u7ed3\u679c\u6570\uff0c\u9ed8\u8ba4\u4e3a 1</li> </ul> </li> </ul> <pre><code>POST /articles/_search\n{\n  \"suggest\": {\n    \"my-suggestion\": {\n      \"text\": \"lucne and elasticsear rock hello world \",\n      \"phrase\": {\n        \"field\": \"body\",\n        \"max_errors\":2,\n        \"confidence\":0,\n        \"direct_generator\":[{\n          \"field\":\"body\",\n          \"suggest_mode\":\"always\"\n        }],\n        \"highlight\": {\n          \"pre_tag\": \"&lt;em&gt;\",\n          \"post_tag\": \"&lt;/em&gt;\"\n        }\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"chap19/sum2_search_dep/#9","title":"9\u3001\u2f83\u52a8\u8865\u5168\u4e0e\u57fa\u4e8e\u4e0a\u4e0b\u6587\u7684\u63d0\u793a","text":"<p>The Completion Suggester</p> <ul> <li>Completion Suggester \u63d0\u4f9b\u4e86\u4e86\u201c\u2f83\u52a8\u5b8c\u6210\u201d (Auto Complete) \u7684\u529f\u80fd\u3002\u2f64\u6237\u6bcf\u8f93\u2f0a\u5165\u2f00\u4e2a\u5b57\u7b26\uff0c\u5c31\u9700\u8981\u5373\u65f6\u53d1\u9001\u2f00\u4e2a\u67e5\u8be2\u8bf7\u6c42\u5230\u540e\u6bb5\u67e5\u627e\u5339\u914d\u9879</li> <li>\u5bf9\u6027\u80fd\u8981\u6c42\u6bd4\u8f83\u82db\u523b\u3002Elasticsearch \u91c7\u2f64\u4e86\u4e0d\u540c\u7684\u6570\u636e\u7ed3\u6784\uff0c\u5e76\u2fae\u901a\u8fc7\u5012\u6392\u7d22\u5f15\u6765\u5b8c\u6210\u3002 \u800c\u662f\u5c06 Analyze \u7684\u6570\u636e\u7f16\u7801\u6210 FST \u548c\u7d22\u5f15\u2f00\u8d77\u5b58\u653e\u3002FST \u4f1a\u88ab ES \u6574\u4e2a\u52a0\u8f7d\u8fdb\u5185\u5b58\uff0c \u901f\u5ea6\u5f88\u5feb</li> </ul> <p>\u4f7f\u2f64 Completion Suggester \u7684\u4e00\u4e9b\u6b65\u9aa4</p> <ul> <li>\u5b9a\u4e49 Mapping\uff0c\u4f7f\u2f64 \"completion\" type</li> <li>\u7d22\u5f15\u6570\u636e</li> <li>\u8fd0\u2f8f \"suggest\" \u67e5\u8be2\uff0c\u5f97\u5230\u641c\u7d22\u5efa\u8bae</li> </ul> <p>\u7d22\u5f15\u6570\u636e</p> <pre><code>PUT articles\n{\n  \"mappings\": {\n    \"properties\": {\n      \"title_completion\":{\n        \"type\": \"completion\"\n      }\n    }\n  }\n}\n</code></pre> <p>\u641c\u7d22\u6570\u636e</p> <pre><code>POST articles/_search?pretty\n{\n  \"size\": 0,\n  \"suggest\": {\n    \"article-suggester\": {\n      \"prefix\": \"el \",\n      \"completion\": {\n        \"field\": \"title_completion\"\n      }\n    }\n  }\n}\n</code></pre> <p>\u4ec0\u4e48\u662f Context Suggester</p> <p>\u5b9e\u73b0 Context Suggester \u7684\u5177\u4f53\u6b65\u9aa4</p> <ul> <li>\u5b9a\u5236\u4e00\u4e2a Mapping</li> <li>\u7d22\u5f15\u6570\u636e\uff0c\u5e76\u4e14\u4e3a\u6bcf\u4e2a\u2f42\u6863\u52a0\u2f0a Context \u4fe1\u606f</li> <li>\u7ed3\u5408 Context \u8fdb\u2f8f Suggestion \u67e5\u8be2</li> </ul> <p>\u5b9a\u4e49 Mapping</p> <p>\u589e\u52a0 Contexts</p> <ul> <li>Type</li> <li>name</li> </ul> <pre><code>PUT comments/_mapping\n{\n  \"properties\": {\n    \"comment_autocomplete\":{\n      \"type\": \"completion\",\n      \"contexts\":[{\n        \"type\":\"category\",\n        \"name\":\"comment_category\"\n      }]\n    }\n  }\n}\n</code></pre> <p>\u7d22\u5f15\u6570\u636e</p> <pre><code>POST comments/_doc\n{\n  \"comment\":\"I love the star war movies\",\n  \"comment_autocomplete\":{\n    \"input\":[\"star wars\"],\n    \"contexts\":{\n      \"comment_category\":\"movies\"\n    }\n  }\n}\n\nPOST comments/_doc\n{\n  \"comment\":\"Where can I find a Starbucks\",\n  \"comment_autocomplete\":{\n    \"input\":[\"starbucks\"],\n    \"contexts\":{\n      \"comment_category\":\"coffee\"\n    }\n  }\n}\n</code></pre> <p>\u4e0d\u540c\u7684\u4e0a\u4e0b\u2f42\uff0c\u2f83\u52a8\u63d0\u793a</p> <pre><code>POST comments/_search\n{\n  \"suggest\": {\n    \"MY_SUGGESTION\": {\n      \"prefix\": \"sta\",\n      \"completion\":{\n        \"field\":\"comment_autocomplete\",\n        \"contexts\":{\n          \"comment_category\":\"coffee\"\n        }\n      }\n    }\n  }\n}\n</code></pre> <pre><code>POST comments/_search\n{\n  \"suggest\": {\n    \"MY_SUGGESTION\": {\n      \"prefix\": \"sta\",\n      \"completion\":{\n        \"field\":\"comment_autocomplete\",\n        \"contexts\":{\n          \"comment_category\":\"movies\"\n        }\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"chap19/sum2_search_dep/#10","title":"10\u3001\u8de8\u96c6\u7fa4\u641c\u7d22","text":"<p>\u542f\u52a83\u4e2a\u96c6\u7fa4:</p> <pre><code>elasticsearch -E node.name=cluster0node -E cluster.name=cluster0 -E path.data=cluster0_data -E discovery.type=single-node -E http.port=9200 -E transport.port=9300\nelasticsearch -E node.name=cluster1node -E cluster.name=cluster1 -E path.data=cluster1_data -E discovery.type=single-node -E http.port=9201 -E transport.port=9301\nelasticsearch -E node.name=cluster2node -E cluster.name=cluster2 -E path.data=cluster2_data -E discovery.type=single-node -E http.port=9202 -E transport.port=9302\n</code></pre> <p>\u5728\u6bcf\u4e2a\u96c6\u7fa4\u4e0a\u8bbe\u7f6e\u52a8\u6001\u7684\u8bbe\u7f6e</p> <pre><code>PUT _cluster/settings\n{\n  \"persistent\": {\n    \"cluster\": {\n      \"remote\": {\n        \"cluster0\": {\n          \"seeds\": [\n            \"127.0.0.1:9300\"\n          ],\n          \"transport.ping_schedule\": \"30s\"\n        },\n        \"cluster1\": {\n          \"seeds\": [\n            \"127.0.0.1:9301\"\n          ],\n          \"transport.compress\": true,\n          \"skip_unavailable\": true\n        },\n        \"cluster2\": {\n          \"seeds\": [\n            \"127.0.0.1:9302\"\n          ]\n        }\n      }\n    }\n  }\n</code></pre> <pre><code>GET /users,cluster1:users,cluster2:users/_search\n{\n  \"query\": {\n    \"range\": {\n      \"age\": {\n        \"gte\": 20,\n        \"lte\": 40\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"chap19/sum3_cross_search/","title":"ElasticSearch \u5206\u5e03\u5f0f\u641c\u7d22","text":""},{"location":"chap19/sum3_cross_search/#1","title":"1\u3001\u5206\u2f5a\u4e0e\u96c6\u7fa4\u7684\u6545\u969c\u8f6c\u79fb","text":"<p>\u96c6\u7fa4\u5065\u5eb7\u72b6\u6001</p> <pre><code>GET /_cluster/health\n</code></pre>"},{"location":"chap19/sum3_cross_search/#2","title":"2\u3001\u5206\u2f5a\u53ca\u5176\u751f\u547d\u5468\u671f","text":"<p>\u5c06 Index buffer \u5199\u5165 Segment \u7684\u8fc7\u7a0b\u53eb Refresh\u3002</p> <p>Segment\u7684merge\u64cd\u4f5c</p> <pre><code>POST index/_forcemerge\n</code></pre>"},{"location":"chap19/sum3_cross_search/#3","title":"3\u3001\u5256\u6790\u5206\u5e03\u5f0f\u67e5\u8be2\u53ca\u76f8\u5173\u6027\u7b97\u5206","text":"<p>\u641c\u7d22\u7684URL \u4e2d\u6307\u5b9a\u53c2\u6570 <code>\u201c_search?search_type=dfs_query_then_fetch\u201d</code></p> <pre><code>PUT message\n{\n  \"settings\": {\n    \"number_of_shards\": 20\n  }\n}\n\nPOST message/_doc?routing=2\n{\n  \"content\":\"good morning\"\n}\n</code></pre> <pre><code>POST message/_search\n{\n  \"explain\": true,\n  \"query\": {\n    \"match_all\": {}\n  }\n}\n</code></pre> <p>\u4f7f\u2f64 DFS Query Then Fetch</p> <pre><code>POST message/_search?search_type=dfs_query_then_fetch\n{\n\n  \"query\": {\n    \"term\": {\n      \"content\": {\n        \"value\": \"good\"\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"chap19/sum3_cross_search/#4doc-valuesfielddata","title":"4\u3001\u6392\u5e8f\u53caDoc Values&amp;Fielddata","text":"<p>1\u3001\u6392\u5e8f</p> <ul> <li>Elasticsearch \u9ed8\u8ba4\u91c7\u2f64\u76f8\u5173\u6027\u7b97\u5206\u5bf9\u7ed3\u679c\u8fdb\u2f8f\u964d\u5e8f\u6392\u5e8f</li> <li>\u53ef\u4ee5\u901a\u8fc7\u8bbe\u5b9a sorting \u53c2\u6570\uff0c\u2f83\u2f8f\u8bbe\u5b9a\u6392\u5e8f</li> <li>\u5982\u679c\u4e0d\u6307\u5b9a<code>_score</code>\uff0c\u7b97\u5206\u4e3a Null</li> </ul> <p>\u5355\u5b57\u6bb5\u6392\u5e8f</p> <pre><code>#\u5355\u5b57\u6bb5\u6392\u5e8f\nPOST /kibana_sample_data_ecommerce/_search\n{\n  \"size\": 5,\n  \"query\": {\n    \"match_all\": {\n\n    }\n  },\n  \"sort\": [\n    {\"order_date\": {\"order\": \"desc\"}}\n  ]\n}\n</code></pre> <p>\u591a\u5b57\u6bb5\u8fdb\u884c\u6392\u5e8f</p> <pre><code>#\u591a\u5b57\u6bb5\u6392\u5e8f\nPOST /kibana_sample_data_ecommerce/_search\n{\n  \"size\": 5,\n  \"query\": {\n    \"match_all\": {\n\n    }\n  },\n  \"sort\": [\n    {\"order_date\": {\"order\": \"desc\"}},\n    {\"_doc\":{\"order\": \"asc\"}},\n    {\"_score\":{ \"order\": \"desc\"}}\n  ]\n}\n</code></pre> <p>\u5bf9 Text \u7c7b\u578b\u6392\u5e8f</p> <pre><code>#\u5bf9 text \u5b57\u6bb5\u8fdb\u884c\u6392\u5e8f\u3002\u9ed8\u8ba4\u4f1a\u62a5\u9519\uff0c\u9700\u6253\u5f00fielddata\nPOST /kibana_sample_data_ecommerce/_search\n{\n  \"size\": 5,\n  \"query\": {\n    \"match_all\": {\n\n    }\n  },\n  \"sort\": [\n    {\"customer_full_name\": {\"order\": \"desc\"}}\n  ]\n}\n</code></pre> <ul> <li>fielddata: \u9ed8\u8ba4\u5173\u95ed</li> </ul> <p>2\u3001\u6253\u5f00 text\u7684 fielddata</p> <pre><code>PUT kibana_sample_data_ecommerce/_mapping\n{\n  \"properties\": {\n    \"customer_full_name\" : {\n          \"type\" : \"text\",\n          \"fielddata\": true,\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n            }\n          }\n        }\n  }\n}\n</code></pre> <pre><code>POST /kibana_sample_data_ecommerce/_search\n{\n  \"size\": 5,\n  \"query\": {\n    \"match_all\": {\n\n    }\n  },\n  \"sort\": [\n    {\"customer_full_name\": {\"order\": \"desc\"}}\n  ]\n}\n</code></pre> <p>3\u3001\u5173\u95ed Doc Values</p> <ul> <li>\u9ed8\u8ba4\u542f\u2f64\uff0c\u53ef\u4ee5\u901a\u8fc7 Mapping \u8bbe\u7f6e\u5173\u95ed</li> <li>\u5982\u679c\u91cd\u65b0\u6253\u5f00\uff0c\u9700\u8981\u91cd\u5efa\u7d22\u5f15<ul> <li>\u4ec0\u4e48\u65f6\u5019\u9700\u8981\u5173\u95ed<ul> <li>\u660e\u786e\u4e0d\u4e0d\u9700\u8981\u505a\u6392\u5e8f\u53ca\u805a\u5408\u5206\u6790</li> </ul> </li> </ul> </li> </ul> <pre><code>PUT test_keyword/_mapping\n{\n  \"properties\": {\n    \"user_name\":{\n      \"type\": \"keyword\",\n      \"doc_values\":false\n    }\n  }\n}\n</code></pre> <p>or</p> <pre><code>PUT test_text/_mapping\n{\n  \"properties\": {\n    \"intro\":{\n      \"type\": \"text\",\n      \"doc_values\":true\n    }\n  }\n}\n</code></pre> <p>\u83b7\u53d6 Doc Values &amp; Fielddata \u4e2d\u5b58\u50a8\u7684\u5185\u5bb9</p> <pre><code>PUT temp_users/_mapping\n{\n  \"properties\": {\n    \"name\":{\"type\": \"text\",\"fielddata\": true},\n    \"desc\":{\"type\": \"text\",\"fielddata\": true}\n  }\n}\n</code></pre> <p>\u67e5\u770b <code>docvalue_fields</code> \u6570\u636e</p> <pre><code>POST  temp_users/_search\n{\n  \"docvalue_fields\": [\n    \"name\",\"desc\"\n    ]\n}\n</code></pre>"},{"location":"chap19/sum3_cross_search/#5-fromsizesearch-after-scroll-api","title":"5\u3001\u5206\u9875\u4e0e\u904d\u5386 \u2013 From\uff0cSize\uff0cSearch After &amp; Scroll API","text":"<p>From / Size</p> <pre><code>POST tmdb/_search\n{\n  \"from\": 10000,\n  \"size\": 1,\n  \"query\": {\n    \"match_all\": {\n\n    }\n  }\n}\n</code></pre> <p>Search After \u907f\u514d\u6df1\u5ea6\u5206\u9875\u7684\u95ee\u9898</p> <pre><code>POST users/_search\n{\n    \"size\": 1,\n    \"query\": {\n        \"match_all\": {}\n    },\n    \"search_after\":\n        [\n          13,\n          \"Z30JVHUBaxLQOLM-KE5P\"],\n    \"sort\": [\n        {\"age\": \"desc\"} ,\n        {\"_id\": \"asc\"}    \n    ]\n}\n</code></pre> <p>Scroll API</p> <p>\u8c03\u2f64 Scroll API, \u521b\u5efa\u2f00\u4e2a\u5feb\u7167</p> <pre><code>POST /users/_search?scroll=5m\n{\n    \"size\": 1,\n    \"query\": {\n        \"match_all\" : {\n        }\n    }\n}\n</code></pre> <pre><code>POST /_search/scroll\n{\n    \"scroll\" : \"1m\",\n    \"scroll_id\" : \"FGluY2x1ZGVfY29udGV4dF91dWlkDXF1ZXJ5QW5kRmV0Y2gBFDBuczRWSFVCUzd6ekR6aElZWHN6AAAAAAAADX4WbFRGRDZxQkNRNDYweGRXOFhGZ2FJZw==\"\n}\n</code></pre>"},{"location":"chap19/sum3_cross_search/#6","title":"6\u3001\u5904\u7406\u5e76\u53d1\u8bfb\u5199\u64cd\u4f5c","text":"<p>\u5185\u90e8\u7248\u672c\u63a7\u5236: <code>If_seq_no + If_primary_term</code></p> <pre><code>PUT products/_doc/1?if_seq_no=0&amp;if_primary_term=1\n{\n  \"title\":\"iphone\",\n  \"count\":100\n}\n</code></pre> <p>\u4f7f\u2f64\u5916\u90e8\u7248\u672c\uff1a version + <code>version_type</code>=external (\u4f7f\u2f64\u5176\u4ed6\u6570\u636e\u5e93\u4f5c\u4e3a\u4e3b\u8981\u6570\u636e\u5b58\u50a8)</p> <pre><code>PUT products/_doc/1?version=30000&amp;version_type=external\n{\n  \"title\":\"iphone\",\n  \"count\":100\n}\n</code></pre>"},{"location":"chap19/sum4_agg_search/","title":"\u6df1\u5165\u805a\u5408\u5206\u6790","text":""},{"location":"chap19/sum4_agg_search/#1bucket-metric","title":"1\u3001Bucket &amp; Metric \u805a\u5408\u5206\u6790\u53ca\u5d4c\u5957\u805a\u5408","text":"<p>Metric Aggregation</p> <ul> <li>\u5355\u503c\u5206\u6790:\u53ea\u8f93\u51fa\u2f00\u4e2a\u5206\u6790\u7ed3\u679c<ul> <li>min, max, avg, sum</li> <li>Cardinality (\u7c7b\u4f3c distinct Count)</li> </ul> </li> <li>\u591a\u503c\u5206\u6790:\u8f93\u51fa\u591a\u4e2a\u5206\u6790\u7ed3\u679c<ul> <li>stats, extended stats</li> <li>percentile, percentile rank</li> <li>top hits (\u6392\u5728\u524d\u2faf\u7684\u793a\u4f8b)</li> </ul> </li> </ul> <pre><code># Metric \u805a\u5408\uff0c\u627e\u5230\u6700\u4f4e\u7684\u5de5\u8d44\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"min_salary\": {\n      \"min\": {\n        \"field\":\"salary\"\n      }\n    }\n  }\n}\n</code></pre> <p>Metric \u805a\u5408\uff0c\u627e\u5230\u6700\u9ad8\u7684\u5de5\u8d44</p> <pre><code># Metric \u805a\u5408\uff0c\u627e\u5230\u6700\u9ad8\u7684\u5de5\u8d44\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"max_salary\": {\n      \"max\": {\n        \"field\":\"salary\"\n      }\n    }\n  }\n}\n</code></pre> <p>\u591a\u4e2a Metric \u805a\u5408\uff0c\u627e\u5230\u6700\u4f4e\u6700\u9ad8\u548c\u5e73\u5747\u5de5\u8d44</p> <pre><code>POST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"max_salary\": {\n      \"max\": {\n        \"field\": \"salary\"\n      }\n    },\n    \"min_salary\": {\n      \"min\": {\n        \"field\": \"salary\"\n      }\n    },\n    \"avg_salary\": {\n      \"avg\": {\n        \"field\": \"salary\"\n      }\n    }\n  }\n}\n</code></pre> <p>\u4e00\u4e2a\u805a\u5408\uff0c\u8f93\u51fa\u591a\u503c</p> <pre><code>POST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"stats_salary\": {\n      \"stats\": {\n        \"field\":\"salary\"\n      }\n    }\n  }\n}\n</code></pre> <p>Bucket</p> <ul> <li>Terms</li> <li>\u6570\u5b57\u7c7b\u578b<ul> <li>Range / Data Range</li> <li>Histogram / Date Histogram</li> </ul> </li> </ul> <p>Terms Aggregation</p> <ul> <li>\u5b57\u6bb5\u9700\u8981\u6253\u5f00 fielddata\uff0c\u624d\u80fd\u8fdb\u884c Terms Aggregation</li> <li><code>Keyword</code> \u9ed8\u8ba4\u652f\u6301 <code>doc_values</code></li> <li>Text \u9700\u8981\u5728 Mapping \u4e2d enable\u3002\u4f1a\u6309\u7167\u5206\u8bcd\u540e\u7684\u7ed3\u679c\u8fdb\u2f8f\u5206\u7c7b</li> </ul> <pre><code>POST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\"\n      }\n    }\n  }\n}\n</code></pre> <p>\u5bf9 Text \u5b57\u6bb5\u6253\u5f00 fielddata\uff0c\u652f\u6301terms aggregation</p> <pre><code>PUT employees/_mapping\n{\n  \"properties\" : {\n    \"job\":{\n       \"type\":     \"text\",\n       \"fielddata\": true\n    }\n  }\n}\n</code></pre> <pre><code>POST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job\"\n      }\n    }\n  }\n }\n</code></pre> <p>\u5bf9<code>job.keyword</code> \u548c <code>job</code> \u8fdb\u884c <code>terms</code> \u805a\u5408\uff0c\u5206\u6876\u7684\u603b\u6570\u5e76\u4e0d\u4e00\u6837</p> <pre><code>POST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\"\n      }\n    }\n  }\n}\n</code></pre> <p>Cardinality</p> <p>\u7c7b\u4f3c SQL \u4e2d\u7684 Distinct</p> <pre><code>POST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"cardinate\": {\n      \"cardinality\": {\n        \"field\": \"job\"\n      }\n    }\n  }\n}\n</code></pre> <pre><code>POST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"cardinate\": {\n      \"cardinality\": {\n        \"field\": \"job.keyword\"\n      }\n    }\n  }\n}\n</code></pre> <p>Bucket Size &amp; Top Hits Demo</p> <pre><code># \u5bf9 \u6027\u522b\u7684 keyword \u8fdb\u884c\u805a\u5408\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"gender\": {\n      \"terms\": {\n        \"field\":\"gender\"\n      }\n    }\n  }\n}\n</code></pre> <p>\u6307\u5b9a bucket \u7684 size</p> <pre><code>POST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"ages_5\": {\n      \"terms\": {\n        \"field\":\"age\",\n        \"size\":3\n      }\n    }\n  }\n}\n</code></pre> <p>Range &amp; Histogram \u805a\u5408</p> <pre><code>#Salary Ranges \u5206\u6876\uff0c\u53ef\u4ee5\u81ea\u5df1\u5b9a\u4e49 key\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"salary_range\": {\n      \"range\": {\n        \"field\":\"salary\",\n        \"ranges\":[\n          {\n            \"to\":10000\n          },\n          {\n            \"from\":10000,\n            \"to\":20000\n          },\n          {\n            \"key\":\"&gt;20000\",\n            \"from\":20000\n          }\n        ]\n      }\n    }\n  }\n}\n</code></pre> <p>Bucket + Metric Aggregation</p> <pre><code># \u5d4c\u5957\u805a\u54081\uff0c\u6309\u7167\u5de5\u4f5c\u7c7b\u578b\u5206\u6876\uff0c\u5e76\u7edf\u8ba1\u5de5\u8d44\u4fe1\u606f\n\n POST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"Job_salary_stats\": {\n      \"terms\": {\n        \"field\": \"job.keyword\"\n      },\n      \"aggs\": {\n        \"salary\": {\n          \"stats\": {\n            \"field\": \"salary\"\n          }\n        }\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"chap19/sum4_agg_search/#2pipeline","title":"2\u3001Pipeline \u805a\u5408\u5206\u6790","text":"<p><code>Pipeline aggregation</code> \u2014\u2014 \u5bf9\u5206\u7ec4+\u805a\u5408\u7ee7\u7eed\u518d\u505a\u5206\u7ec4+\u805a\u5408\u3002</p> <p>Pipeline</p> <p><code>Pipeline:min_bucket</code></p> <ul> <li>\u7ba1\u9053\u7684\u6982\u5ff5: \u2f40\u6301\u805a\u5408\u5206\u6790\u7684\u7ed3\u679c\uff0c\u518d\u6b21\u8fdb\u2f8f\u805a\u5408\u5206\u6790<ul> <li>Pipeline \u7684\u5206\u6790\u7ed3\u679c\u4f1a\u8f93\u51fa\u5230\u539f\u7ed3\u679c\u4e2d\uff0c\u6839\u636e\u4f4d\u7f6e\u7684\u4e0d\u540c\uff0c\u5206\u4e3a\u4e24\u7c7b</li> <li>Sibling - \u7ed3\u679c\u548c\u73b0\u6709\u5206\u6790\u7ed3\u679c\u540c\u7ea7</li> <li>Max\uff0cmin\uff0cAvg &amp; Sum Bucket</li> <li>Stats\uff0cExtended Status Bucket</li> <li>Percentiles Bucket</li> </ul> </li> <li>Parent - \u7ed3\u679c\u5185\u5d4c\u5230\u73b0\u6709\u7684\u805a\u5408\u5206\u6790\u7ed3\u679c\u4e4b\u4e2d<ul> <li>Derivative (\u6c42\u5bfc)</li> <li>Cumultive Sum (\u7d2f\u8ba1\u6c42\u548c)</li> <li>Moving Function (\u6ed1\u52a8\u7a97\u2f1d)</li> </ul> </li> </ul> <pre><code># \u5e73\u5747\u5de5\u8d44\u6700\u4f4e\u7684\u5de5\u4f5c\u7c7b\u578b\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\": \"job.keyword\",\n        \"size\": 10\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        }\n      }\n    },\n    \"min_salary_by_job\":{\n      \"min_bucket\": {\n        \"buckets_path\": \"jobs&gt;avg_salary\"\n      }\n    }\n  }\n}\n</code></pre> <p><code>max_bucket</code></p> <pre><code># \u5e73\u5747\u5de5\u8d44\u6700\u9ad8\u7684\u5de5\u4f5c\u7c7b\u578b\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\": \"job.keyword\",\n        \"size\": 10\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        }\n      }\n    },\n    \"max_salary_by_job\":{\n      \"max_bucket\": {\n        \"buckets_path\": \"jobs&gt;avg_salary\"\n      }\n    }\n  }\n}\n</code></pre> <p><code>stats_bucket</code></p> <pre><code># \u5e73\u5747\u5de5\u8d44\u7684\u7edf\u8ba1\u5206\u6790\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\": \"job.keyword\",\n        \"size\": 10\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        }\n      }\n    },\n    \"stats_salary_by_job\":{\n      \"stats_bucket\": {\n        \"buckets_path\": \"jobs&gt;avg_salary\"\n      }\n    }\n  }\n}\n</code></pre> <p><code>percentiles_bucket</code></p> <pre><code># \u5e73\u5747\u5de5\u8d44\u7684\u767e\u5206\u4f4d\u6570\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\": \"job.keyword\",\n        \"size\": 10\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        }\n      }\n    },\n    \"percentiles_salary_by_job\":{\n      \"percentiles_bucket\": {\n        \"buckets_path\": \"jobs&gt;avg_salary\"\n      }\n    }\n  }\n}\n</code></pre> <p>Parent Pipeline: Derivative</p> <ul> <li>Cumulative Sum</li> <li>Moving Function</li> </ul> <pre><code>#\u6309\u7167\u5e74\u9f84\u5bf9\u5e73\u5747\u5de5\u8d44\u6c42\u5bfc\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"age\": {\n      \"histogram\": {\n        \"field\": \"age\",\n        \"min_doc_count\": 0,\n        \"interval\": 1\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        },\n        \"derivative_avg_salary\":{\n          \"derivative\": {\n            \"buckets_path\": \"avg_salary\"\n          }\n        }\n      }\n    }\n  }\n}\n</code></pre> <p><code>Cumulative_sum</code></p> <pre><code>#Cumulative_sum\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"age\": {\n      \"histogram\": {\n        \"field\": \"age\",\n        \"min_doc_count\": 0,\n        \"interval\": 1\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        },\n        \"cumulative_salary\":{\n          \"cumulative_sum\": {\n            \"buckets_path\": \"avg_salary\"\n          }\n        }\n      }\n    }\n  }\n}\n</code></pre> <p><code>moving_fn</code></p> <pre><code>#Moving Function\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"age\": {\n      \"histogram\": {\n        \"field\": \"age\",\n        \"min_doc_count\": 0,\n        \"interval\": 1\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        },\n        \"moving_avg_salary\":{\n          \"moving_fn\": {\n            \"buckets_path\": \"avg_salary\",\n            \"window\":10,\n            \"script\": \"MovingFunctions.min(values)\"\n          }\n        }\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"chap19/sum4_agg_search/#3","title":"3\u3001\u805a\u5408\u7684\u4f5c\u2f64\u7528\u8303\u56f4\u53ca\u6392\u5e8f","text":"<p>\u540c\u65f6 ES \u8fd8\u2f40\u6301\u4ee5\u4e0b\u2f45\u5f0f\u6539\u53d8\u805a\u5408\u7684\u4f5c\u2f64\u8303\u56f4</p> <ul> <li>Filter</li> <li><code>Post_Filter</code></li> <li>Global</li> </ul> <pre><code># Query\nPOST employees/_search\n{\n  \"size\": 0,\n  \"query\": {\n    \"range\": {\n      \"age\": {\n        \"gte\": 20\n      }\n    }\n  },\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\"\n\n      }\n    }\n  }\n}\n</code></pre> <p>Filter</p> <pre><code>#Filter\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"older_person\": {\n      \"filter\":{\n        \"range\":{\n          \"age\":{\n            \"from\":35\n          }\n        }\n      },\n      \"aggs\":{\n         \"jobs\":{\n           \"terms\": {\n        \"field\":\"job.keyword\"\n      }\n      }\n    }},\n    \"all_jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\"\n\n      }\n    }\n  }\n}\n</code></pre> <p><code>Post_Filter</code></p> <p>\u662f\u5bf9\u805a\u5408\u5206\u6790\u540e\u7684\u2f42\u6863\u8fdb\u2f8f\u518d\u6b21\u8fc7\u6ee4</p> <pre><code>#Post field. \u4e00\u6761\u8bed\u53e5\uff0c\u627e\u51fa\u6240\u6709\u7684job\u7c7b\u578b\u3002\u8fd8\u80fd\u627e\u5230\u805a\u5408\u540e\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c\nPOST employees/_search\n{\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\": \"job.keyword\"\n      }\n    }\n  },\n  \"post_filter\": {\n    \"match\": {\n      \"job.keyword\": \"Dev Manager\"\n    }\n  }\n}\n</code></pre> <p>global</p> <pre><code>#global\nPOST employees/_search\n{\n  \"size\": 0,\n  \"query\": {\n    \"range\": {\n      \"age\": {\n        \"gte\": 40\n      }\n    }\n  },\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\"\n\n      }\n    },\n\n    \"all\":{\n      \"global\":{},\n      \"aggs\":{\n        \"salary_avg\":{\n          \"avg\":{\n            \"field\":\"salary\"\n          }\n        }\n      }\n    }\n  }\n}\n</code></pre> <p>\u6392\u5e8f</p> <ul> <li>\u6307\u5b9a order\uff0c \u6309\u7167 count \u548c key \u8fdb\u2f8f\u6392\u5e8f<ul> <li>\u9ed8\u8ba4\u60c5\u51b5\uff0c\u6309\u7167 count \u964d\u5e8f\u6392\u5e8f</li> <li>\u6307\u5b9a size\uff0c\u5c31\u80fd\u8fd4\u56de\u76f8\u5e94\u7684\u6876</li> </ul> </li> </ul> <pre><code>#\u6392\u5e8f order\n#count and key\nPOST employees/_search\n{\n  \"size\": 0,\n  \"query\": {\n    \"range\": {\n      \"age\": {\n        \"gte\": 20\n      }\n    }\n  },\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\",\n        \"order\":[\n          {\"_count\":\"asc\"},\n          {\"_key\":\"desc\"}\n          ]\n\n      }\n    }\n  }\n}\n</code></pre> <p>\u57fa\u4e8e\u2f26\u805a\u5408\u7684\u503c\u6392\u5e8f</p> <pre><code>#\u6392\u5e8f order\n#count and key\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\",\n        \"order\":[  {\n            \"stats_salary.min\":\"desc\"\n          }]\n\n\n      },\n    \"aggs\": {\n      \"stats_salary\": {\n        \"stats\": {\n          \"field\":\"salary\"\n        }\n      }\n    }\n    }\n  }\n}\n</code></pre>"},{"location":"chap19/sum4_agg_search/#4","title":"4\u3001 \u805a\u5408\u7684\u7cbe\u51c6\u5ea6\u95ee\u9898","text":"<p>\u5982\u4f55\u89e3\u51b3 Terms \u4e0d\u51c6\u7684\u95ee\u9898:\u63d0\u5347 shard_size \u7684\u53c2\u6570</p> <ul> <li>\u805a\u5408\u5206\u6790\u4e0d\u51c6\u7684\u539f\u56e0\uff0c\u6570\u636e\u5206\u6563\u5728\u591a\u4e2a\u5206\u7247\u4e0a\uff0c Coordinating Node \u2f46\u6cd5\u83b7\u53d6\u6570\u636e\u5168<ul> <li>\u89e3\u51b3\u2f45\u6848 1:\u5f53\u6570\u636e\u91cf\u4e0d\u5927\u65f6\uff0c\u8bbe\u7f6e Primary Shard \u4e3a 1; \u5b9e\u73b0\u51c6\u786e\u6027</li> <li>\u89e3\u51b3\u65b9\u6848 2:\u5728\u5206\u5e03\u5f0f\u6570\u636e\u4e0a\uff0c\u8bbe\u7f6e <code>shard_size</code> \u53c2\u6570\uff0c\u63d0\u2fbc\u7cbe\u786e\u5ea6</li> </ul> </li> </ul> <p>\u6253\u5f00 <code>show_term_doc_count_error</code></p> <p>\u8c03\u6574 shard size \u2f24\u5c0f\uff0c\u964d\u4f4e <code>doc_count_error_upper_bound</code>\u6765\u63d0\u5347\u51c6\u786e\u5ea6</p> <p>\u589e\u52a0\u6574\u4f53\u8ba1\u7b97\u91cf\u91cf\uff0c\u63d0\u2fbc\u4e86\u51c6\u786e\u5ea6\uff0c\u4f46\u4f1a\u964d\u4f4e\u76f8\u5e94\u65f6\u95f4</p> <p>Shard Size \u9ed8\u8ba4\u2f24\u5c0f\u8bbe\u5b9a: <code>shard size = size *1.5 +10</code></p> <p>\u56e0\u4e3a\u4eceES7\u5f00\u59cb\uff0c\u9ed8\u8ba4\u7684primary shard \u4e3a\u4e00\uff0c\u6240\u4ee5\u4e0d\u4f1a\u51fa\u73b0 Terms \u4e0d\u51c6\u7684\u95ee\u9898</p> <p>\u63d0\u9ad8 shard size \u2f24\u5c0f\uff0c\u964d\u4f4e <code>doc_count_error_upper_bound</code> \u6765\u63d0\u5347\u51c6\u786e\u5ea6</p> <p>\"shard_size\":1</p> <pre><code>GET my_flights/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"weather\": {\n      \"terms\": {\n        \"field\":\"OriginWeather\",\n        \"size\":1,\n        \"shard_size\":1,\n        \"show_term_doc_count_error\":true\n      }\n    }\n  }\n}\n</code></pre> <pre><code>GET my_flights/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"weather\": {\n      \"terms\": {\n        \"field\":\"OriginWeather\",\n        \"size\":1,\n        \"shard_size\":10,\n        \"show_term_doc_count_error\":true\n      }\n    }\n  }\n}\n</code></pre> <ul> <li>size\u662f\u6700\u7ec8\u8fd4\u56de\u591a\u5c11\u4e2abuckt\u7684\u6570\u91cf\u3002</li> <li><code>shard_size</code>\u662f\u6bcf\u4e2abucket\u5728\u4e00\u4e2ashard\u4e0a\u53d6\u56de\u7684bucket\u7684\u603b\u6570\u3002 \u7136\u540e\uff0c\u6bcf\u4e2ashard\u4e0a\u7684\u7ed3\u679c\uff0c\u4f1a\u5728coordinate\u8282\u70b9\u4e0a\u5728\u505a\u4e00\u6b21\u6c47\u603b\uff0c\u8fd4\u56de\u603b\u6570\u3002</li> </ul>"},{"location":"chap19/sum5_datamodel/","title":"\u6570\u636e\u5efa\u6a21","text":""},{"location":"chap19/sum5_datamodel/#1-nested","title":"1\u3001\u5bf9\u8c61\u53ca Nested \u5bf9\u8c61","text":"<ul> <li>\u5173\u7cfb\u578b\u6570\u636e\u5e93\uff0c\u2f00\u822c\u4f1a\u8003\u8651 Normalize \u6570\u636e; </li> <li>\u5728 Elasticsearch\uff0c\u5f80\u5f80\u8003\u8651 Denormalize \u6570\u636e</li> </ul> <p>Denormalize \u7684\u597d\u5904: \u8bfb\u7684\u901f\u5ea6\u53d8\u5feb / \u2f46\u9700\u8868\u8fde\u63a5 / \u2f46\u9700\u884c\u9501</p> <p>Elasticsearch \u5e76\u4e0d\u64c5\u2ed3\u5904\u7406\u5173\u8054\u5173\u7cfb\u3002\u6211\u4eec\u2f00\u822c\u91c7\u7528\u4ee5\u4e0b\u56db\u79cd\u2f45\u6cd5\u5904\u7406\u5173\u8054</p> <ul> <li>\u5bf9\u8c61\u7c7b\u578b</li> <li>\u5d4c\u5957\u5bf9\u8c61(Nested Object)</li> <li>\u2f57\u5b50\u5173\u8054\u5173\u7cfb(Parent / Child )</li> <li>\u5e94\u2f64\u7aef\u5173\u8054</li> </ul> <pre><code># \u67e5\u8be2 Blog \u4fe1\u606f\nPOST blog/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\"match\": {\"content\": \"Elasticsearch\"}},\n        {\"match\": {\"user.username\": \"Jack\"}}\n      ]\n    }\n  }\n}\n</code></pre> <pre><code># \u67e5\u8be2\u7535\u5f71\u4fe1\u606f\nPOST my_movies/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\"match\": {\"actors.first_name\": \"Keanu\"}},\n        {\"match\": {\"actors.last_name\": \"Hopper\"}}\n      ]\n    }\n  }\n\n}\n</code></pre> <p>Nested \u6570\u636e\u7c7b\u578b: \u5141\u8bb8\u5bf9\u8c61\u6570\u7ec4\u4e2d\u7684\u5bf9\u8c61\u88ab\u72ec\u7acb\u7d22\u5f15</p> <pre><code># \u521b\u5efa Nested \u5bf9\u8c61 Mapping\nPUT my_movies\n{\n      \"mappings\" : {\n      \"properties\" : {\n        \"actors\" : {\n          \"type\": \"nested\",\n          \"properties\" : {\n            \"first_name\" : {\"type\" : \"keyword\"},\n            \"last_name\" : {\"type\" : \"keyword\"}\n          }},\n        \"title\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\"keyword\":{\"type\":\"keyword\",\"ignore_above\":256}}\n        }\n      }\n    }\n}\n</code></pre> <p>\u5d4c\u5957\u67e5\u8be2</p> <pre><code># Nested \u67e5\u8be2\nPOST my_movies/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\"match\": {\"title\": \"Speed\"}},\n        {\n          \"nested\": {\n            \"path\": \"actors\",\n            \"query\": {\n              \"bool\": {\n                \"must\": [\n                  {\"match\": {\n                    \"actors.first_name\": \"Keanu\"\n                  }},\n\n                  {\"match\": {\n                    \"actors.last_name\": \"Hopper\"\n                  }}\n                ]\n              }\n            }\n          }\n        }\n      ]\n    }\n  }\n}\n</code></pre> <p>\u5d4c\u5957\u805a\u5408Nested Aggregation</p> <pre><code># Nested Aggregation\nPOST my_movies/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"actors\": {\n      \"nested\": {\n        \"path\": \"actors\"\n      },\n      \"aggs\": {\n        \"actor_name\": {\n          \"terms\": {\n            \"field\": \"actors.first_name\",\n            \"size\": 10\n          }\n        }\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"chap19/sum5_datamodel/#2","title":"2\u3001\u6587\u6863\u7684\u7236\u5b50\u5173\u7cfb","text":"<p>\u5bf9\u8c61\u548c Nested \u5bf9\u8c61\u7684\u5c40\u9650\u6027\uff1a \u6bcf\u6b21\u66f4\u65b0\uff0c\u9700\u8981\u91cd\u65b0\u7d22\u5f15\u6574\u4e2a\u5bf9\u8c61(\u5305\u62ec\u6839\u5bf9\u8c61\u548c\u5d4c\u5957\u5bf9\u8c61)</p> <ul> <li>ES \u63d0\u4f9b\u4e86\u7c7b\u4f3c\u5173\u7cfb\u578b\u6570\u636e\u5e93\u4e2d Join \u7684\u5b9e\u73b0\u3002\u4f7f\u7528 Join \u6570\u636e\u7c7b\u578b\u5b9e\u73b0\uff0c\u53ef\u4ee5\u901a\u8fc7\u7ef4\u62a4 Parent / Child \u7684\u5173\u7cfb\uff0c\u4ece\u2f7d\u5206\u79bb\u4e24\u4e2a\u5bf9\u8c61<ul> <li>\u2f57\u6587\u6863\u548c\u2f26\u6587\u6863\u662f\u4e24\u4e2a\u72ec\u2f74\u7684\u6587\u6863<ul> <li>\u66f4\u65b0\u2f57\u6587\u6863\u65e0\u9700\u91cd\u65b0\u7d22\u5f15\u5b50\u6587\u6863\u3002</li> <li>\u2f26\u6587\u6863\u88ab\u6dfb\u52a0\uff0c\u66f4\u65b0\u6216\u8005\u5220\u9664\u4e5f\u4e0d\u4f1a\u5f71\u54cd\u5230\u2f57\u6587\u6863\u548c\u5176\u4ed6\u7684\u2f26\u6587\u6863</li> </ul> </li> </ul> </li> </ul> <p>\u5b9a\u4e49\u2f57\u5b50\u5173\u7cfb\u7684\u2f0f\u4e2a\u6b65\u9aa4</p> <ul> <li>\u8bbe\u7f6e\u7d22\u5f15\u7684 Mapping</li> <li>\u7d22\u5f15\u2f57\u6587\u6863</li> <li>\u7d22\u5f15\u2f26\u6587\u6863</li> <li>\u6309\u9700\u67e5\u8be2\u2f42\u6863</li> </ul> <pre><code># \u8bbe\u5b9a Parent/Child Mapping\nPUT my_blogs\n{\n  \"settings\": {\n    \"number_of_shards\": 2\n  },\n  \"mappings\": {\n    \"properties\": {\n      \"blog_comments_relation\": {\n        \"type\": \"join\",\n        \"relations\": {\n          \"blog\": \"comment\"\n        }\n      },\n      \"content\": {\n        \"type\": \"text\"\n      },\n      \"title\": {\n        \"type\": \"keyword\"\n      }\n    }\n  }\n}\n</code></pre> <ul> <li>\u2f57\u6587\u6863: blog</li> <li>\u5b50\u6587\u6863\uff1acomment</li> </ul> <p>\u63d2\u5165\u7d22\u5f15\u7236\u6587\u6863</p> <pre><code>#\u7d22\u5f15\u7236\u6587\u6863\nPUT my_blogs/_doc/blog1\n{\n  \"title\":\"Learning Elasticsearch\",\n  \"content\":\"learning ELK @ geektime\",\n  \"blog_comments_relation\":{\n    \"name\":\"blog\"\n  }\n}\n</code></pre> <p>\u63d2\u5165\u7d22\u5f15\u2f26\u6587\u6863</p> <pre><code>#\u7d22\u5f15\u5b50\u6587\u6863\nPUT my_blogs/_doc/comment1?routing=blog1\n{\n  \"comment\":\"I am learning ELK\",\n  \"username\":\"Jack\",\n  \"blog_comments_relation\":{\n    \"name\":\"comment\",\n    \"parent\":\"blog1\"\n  }\n}\n</code></pre> <p>\u67e5\u8be2\u6240\u6709\u6587\u6863</p> <pre><code># \u67e5\u8be2\u6240\u6709\u6587\u6863\nPOST my_blogs/_search\n{\n\n}\n</code></pre> <p>Parent / Child \u6240\u2f40\u6301\u7684\u67e5\u8be2</p> <ul> <li>\u67e5\u8be2\u6240\u6709\u2f42\u6863</li> <li>Parent Id \u67e5\u8be2</li> <li>Has Child \u67e5\u8be2</li> <li>Has Parent \u67e5\u8be2</li> </ul> <pre><code># Has Child \u67e5\u8be2,\u8fd4\u56de\u7236\u6587\u6863\nPOST my_blogs/_search\n{\n  \"query\": {\n    \"has_child\": {\n      \"type\": \"comment\",\n      \"query\" : {\n                \"match\": {\n                    \"username\" : \"Jack\"\n                }\n            }\n    }\n  }\n</code></pre> <pre><code># Has Parent \u67e5\u8be2\uff0c\u8fd4\u56de\u76f8\u5173\u7684\u5b50\u6587\u6863\nPOST my_blogs/_search\n{\n  \"query\": {\n    \"has_parent\": {\n      \"parent_type\": \"blog\",\n      \"query\" : {\n                \"match\": {\n                    \"title\" : \"Learning Hadoop\"\n                }\n            }\n    }\n  }\n}\n</code></pre> <pre><code># Parent Id \u67e5\u8be2\nPOST my_blogs/_search\n{\n  \"query\": {\n    \"parent_id\": {\n      \"type\": \"comment\",\n      \"id\": \"blog2\"\n    }\n  }\n}\n</code></pre> <pre><code># Parent Id \u67e5\u8be2\nPOST my_blogs/_search\n{\n  \"query\": {\n    \"parent_id\": {\n      \"type\": \"comment\",\n      \"id\": \"blog2\"\n    }\n  }\n}\n</code></pre> <pre><code>#\u66f4\u65b0\u5b50\u6587\u6863\nPUT my_blogs/_doc/comment3?routing=blog2\n{\n    \"comment\": \"Hello Hadoop??\",\n    \"blog_comments_relation\": {\n      \"name\": \"comment\",\n      \"parent\": \"blog2\"\n    }\n}\n</code></pre>"},{"location":"chap19/sum5_datamodel/#3update-by-query-reindex-api","title":"3\u3001Update By Query &amp; Reindex API","text":"<p>\u4e00\u822c\u5728\u4ee5\u4e0b\u2f0f\u79cd\u60c5\u51b5\u65f6\uff0c\u6211\u4eec\u9700\u8981\u91cd\u5efa\u7d22\u5f15</p> <ul> <li>\u7d22\u5f15\u7684 Mappings \u53d1\u751f\u53d8\u66f4: \u5b57\u6bb5\u7c7b\u578b\u66f4\u6539\uff0c\u5206\u8bcd\u5668\u53ca\u5b57\u5178\u66f4\u65b0</li> <li>\u7d22\u5f15\u7684 Settings \u53d1\u751f\u53d8\u66f4:\u7d22\u5f15\u7684\u4e3b\u5206\u2f5a\u6570\u53d1\u2f63\u6539\u53d8</li> <li>\u96c6\u7fa4\u5185\uff0c\u96c6\u7fa4\u95f4\u9700\u8981\u505a\u6570\u636e\u8fc1\u79fb </li> </ul> <p>Elasticsearch \u7684\u5185\u7f6e\u63d0\u4f9b\u7684 API</p> <ul> <li>Update By Query:\u5728\u73b0\u6709\u7d22\u5f15\u4e0a\u91cd\u5efa</li> <li>Reindex:\u5728\u5176\u4ed6\u7d22\u5f15\u4e0a\u91cd\u5efa\u7d22\u5f15</li> </ul> <p>\u6848\u4f8b 1:\u4e3a\u7d22\u5f15\u589e\u52a0\u5b50\u5b57\u6bb5</p> <pre><code># \u5199\u5165\u6587\u6863\nPUT blogs/_doc/1\n{\n  \"content\":\"Hadoop is cool\",\n  \"keyword\":\"hadoop\"\n}\n\n# \u67e5\u770b Mapping\nGET blogs/_mapping\n\n# \u4fee\u6539 Mapping\uff0c\u589e\u52a0\u5b50\u5b57\u6bb5\uff0c\u4f7f\u7528\u82f1\u6587\u5206\u8bcd\u5668\nPUT blogs/_mapping\n{\n      \"properties\" : {\n        \"content\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"english\" : {\n              \"type\" : \"text\",\n              \"analyzer\":\"english\"\n            }\n          }\n        }\n      }\n    }\n\n\n# \u5199\u5165\u6587\u6863\nPUT blogs/_doc/2\n{\n  \"content\":\"Elasticsearch rocks\",\n    \"keyword\":\"elasticsearch\"\n}\n\n# \u67e5\u8be2\u65b0\u5199\u5165\u6587\u6863\nPOST blogs/_search\n{\n  \"query\": {\n    \"match\": {\n      \"content.english\": \"Elasticsearch\"\n    }\n  }\n}\n</code></pre> <p>\u6267\u2f8f Update By Query</p> <pre><code># Update\u6240\u6709\u6587\u6863\nPOST blogs/_update_by_query\n{\n\n}\n</code></pre> <p>\u6848\u4f8b 2:\u66f4\u6539\u5df2\u6709\u5b57\u6bb5\u7c7b\u578b\u7684 Mappings</p> <ul> <li>ES \u4e0d\u5141\u8bb8\u5728\u539f\u6709 Mapping \u4e0a\u5bf9\u5b57\u6bb5\u7c7b\u578b\u8fdb\u2f8f\u4fee\u6539</li> <li>\u53ea\u80fd\u521b\u5efa\u65b0\u7684\u7d22\u5f15\uff0c\u5e76\u4e14\u8bbe\u5b9a\u6b63\u786e\u7684\u5b57\u6bb5\u7c7b\u578b\uff0c\u518d\u91cd\u65b0\u5bfc\u2f0a\u6570\u636e</li> </ul> <pre><code>PUT blogs/_mapping\n{\n        \"properties\" : {\n        \"content\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"english\" : {\n              \"type\" : \"text\",\n              \"analyzer\" : \"english\"\n            }\n          }\n        },\n        \"keyword\" : {\n          \"type\" : \"keyword\"\n        }\n      }\n}\n</code></pre> <p>\"mapper [keyword] cannot be changed from type [text] to [keyword]\"</p> <p>Reindex API</p> <ul> <li>Reindex API \u2f40\u6301\u628a\u2f42\u6863\u4ece\u2f00\u4e2a\u7d22\u5f15\u62f7\u2ec9\u5230\u53e6\u5916\u2f00\u4e2a\u7d22\u5f15</li> <li>\u4f7f\u2f64 Reindex API \u7684\u2f00\u4e9b\u573a\u666f<ul> <li>\u4fee\u6539\u7d22\u5f15\u7684\u4e3b\u5206\u2f5a\u6570</li> <li>\u6539\u53d8\u5b57\u6bb5\u7684 Mapping \u4e2d\u7684\u5b57\u6bb5\u7c7b\u578b</li> <li>\u96c6\u7fa4\u5185\u6570\u636e\u8fc1\u79fb / \u8de8\u96c6\u7fa4\u7684\u6570\u636e\u8fc1\u79fb</li> </ul> </li> </ul> <p>\u521b\u5efa\u65b0\u7684\u7d22\u5f15\u5e76\u4e14\u8bbe\u5b9a\u65b0\u7684Mapping</p> <pre><code># \u521b\u5efa\u65b0\u7684\u7d22\u5f15\u5e76\u4e14\u8bbe\u5b9a\u65b0\u7684Mapping\nPUT blogs_fix/\n{\n  \"mappings\": {\n        \"properties\" : {\n        \"content\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"english\" : {\n              \"type\" : \"text\",\n              \"analyzer\" : \"english\"\n            }\n          }\n        },\n        \"keyword\" : {\n          \"type\" : \"keyword\"\n        }\n      }    \n  }\n}\n</code></pre> <pre><code># Reindx API\nPOST  _reindex\n{\n  \"source\": {\n    \"index\": \"blogs\"\n  },\n  \"dest\": {\n    \"index\": \"blogs_fix\"\n  }\n}\n</code></pre> <p>\u6d4b\u8bd5 Term Aggregation</p> <pre><code># \u6d4b\u8bd5 Term Aggregation\nPOST blogs_fix/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"blog_keyword\": {\n      \"terms\": {\n        \"field\": \"keyword\",\n        \"size\": 10\n      }\n    }\n  }\n}\n</code></pre> <p>OP Type</p> <ul> <li><code>_reindex</code> \u53ea\u4f1a\u521b\u5efa\u4e0d\u5b58\u5728\u7684\u2f42\u6863</li> <li>\u2f42\u6863\u5982\u679c\u5df2\u7ecf\u5b58\u5728\uff0c\u4f1a\u5bfc\u81f4\u7248\u672c\u51b2\u7a81</li> </ul> <pre><code># Reindx API\uff0cversion Type Internal\nPOST  _reindex\n{\n  \"source\": {\n    \"index\": \"blogs\"\n  },\n  \"dest\": {\n    \"index\": \"blogs_fix\",\n    \"op_type\": \"create\"\n  }\n}\n</code></pre> <p>\u67e5\u770b Task API</p> <p><code>GET _tasks?detailed=true&amp;actions=*reindex</code></p> <ul> <li><code>Reindx API</code>\u2f40\u6301\u5f02\u6b65\u64cd\u4f5c\uff0c\u6267\u2f8f\u53ea\u8fd4\u56deTask Id</li> <li><code>POST _reindex?wait_for_completion=false</code></li> </ul> <pre><code># Reindx API\uff0cversion Type Internal\nPOST  _reindex\n{\n  \"source\": {\n    \"index\": \"blogs\"\n  },\n  \"dest\": {\n    \"index\": \"blogs_fix\",\n    \"version_type\": \"internal\"\n  }\n}\n</code></pre> <pre><code># Reindx API\uff0cversion Type external\nPOST  _reindex\n{\n  \"source\": {\n    \"index\": \"blogs\"\n  },\n  \"dest\": {\n    \"index\": \"blogs_fix\",\n    \"version_type\": \"external\"\n  }\n}\n</code></pre> <p>Output :409 - Conflict</p> <pre><code># Reindx API\uff0cversion Type external\nPOST  _reindex\n{\n  \"source\": {\n    \"index\": \"blogs\"\n  },\n  \"dest\": {\n    \"index\": \"blogs_fix\",\n    \"version_type\": \"external\"\n  },\n  \"conflicts\": \"proceed\"\n}\n</code></pre> <p>Output: 200 - Conflict</p>"},{"location":"chap19/sum5_datamodel/#4ingest-pipeline-painless-script","title":"4\u3001Ingest Pipeline \u4e0e Painless Script","text":"<p>\u9700\u6c42:\u4fee\u590d\u4e0e\u589e\u5f3a\u5199\u2f0a\u7684\u6570\u636e</p> <p>Pipeline &amp; Processor</p> <pre><code>#Blog\u6570\u636e\uff0c\u5305\u542b3\u4e2a\u5b57\u6bb5\uff0ctags\u7528\u9017\u53f7\u95f4\u9694\nPUT tech_blogs/_doc/1\n{\n  \"title\":\"Introducing big data......\",\n  \"tags\":\"hadoop,elasticsearch,spark\",\n  \"content\":\"You konw, for big data\"\n}\n\n# \u6d4b\u8bd5split tags\nPOST _ingest/pipeline/_simulate\n{\n  \"pipeline\": {\n    \"description\": \"to split blog tags\",\n    \"processors\": [\n      {\n        \"split\": {\n          \"field\": \"tags\",\n          \"separator\": \",\"\n        }\n      }\n    ]\n  },\n  \"docs\": [\n    {\n      \"_index\": \"index\",\n      \"_id\": \"id\",\n      \"_source\": {\n        \"title\": \"Introducing big data......\",\n        \"tags\": \"hadoop,elasticsearch,spark\",\n        \"content\": \"You konw, for big data\"\n      }\n    },\n    {\n      \"_index\": \"index\",\n      \"_id\": \"idxx\",\n      \"_source\": {\n        \"title\": \"Introducing cloud computering\",\n        \"tags\": \"openstack,k8s\",\n        \"content\": \"You konw, for cloud\"\n      }\n    }\n  ]\n}\n</code></pre> <p>\u4e3a\u2f42\u6863\u589e\u52a0\u5b57\u6bb5</p> <pre><code>#\u540c\u65f6\u4e3a\u6587\u6863\uff0c\u589e\u52a0\u4e00\u4e2a\u5b57\u6bb5\u3002blog\u67e5\u770b\u91cf\nPOST _ingest/pipeline/_simulate\n{\n  \"pipeline\": {\n    \"description\": \"to split blog tags\",\n    \"processors\": [\n      {\n        \"split\": {\n          \"field\": \"tags\",\n          \"separator\": \",\"\n        }\n      },\n\n      {\n        \"set\":{\n          \"field\": \"views\",\n          \"value\": 0\n        }\n      }\n    ]\n  },\n\n  \"docs\": [\n    {\n      \"_index\":\"index\",\n      \"_id\":\"id\",\n      \"_source\":{\n        \"title\":\"Introducing big data......\",\n  \"tags\":\"hadoop,elasticsearch,spark\",\n  \"content\":\"You konw, for big data\"\n      }\n    },\n\n\n    {\n      \"_index\":\"index\",\n      \"_id\":\"idxx\",\n      \"_source\":{\n        \"title\":\"Introducing cloud computering\",\n  \"tags\":\"openstack,k8s\",\n  \"content\":\"You konw, for cloud\"\n      }\n    }\n\n    ]\n}\n</code></pre> <p>\u6dfb\u52a0 Pipeline \u5e76\u6d4b\u8bd5</p> <pre><code># \u4e3aES\u6dfb\u52a0\u4e00\u4e2a Pipeline\nPUT _ingest/pipeline/blog_pipeline\n{\n  \"description\": \"a blog pipeline\",\n  \"processors\": [\n      {\n        \"split\": {\n          \"field\": \"tags\",\n          \"separator\": \",\"\n        }\n      },\n\n      {\n        \"set\":{\n          \"field\": \"views\",\n          \"value\": 0\n        }\n      }\n    ]\n}\n</code></pre> <pre><code>#\u67e5\u770bPipleline\nGET _ingest/pipeline/blog_pipeline\n</code></pre> <p>\u6d4b\u8bd5pipeline</p> <pre><code>#\u6d4b\u8bd5pipeline\nPOST _ingest/pipeline/blog_pipeline/_simulate\n{\n  \"docs\": [\n    {\n      \"_source\": {\n        \"title\": \"Introducing cloud computering\",\n        \"tags\": \"openstack,k8s\",\n        \"content\": \"You konw, for cloud\"\n      }\n    }\n  ]\n}\n</code></pre> <p>Index &amp; Update By Query</p> <pre><code>#\u4e0d\u4f7f\u7528pipeline\u66f4\u65b0\u6570\u636e\nPUT tech_blogs/_doc/1\n{\n  \"title\":\"Introducing big data......\",\n  \"tags\":\"hadoop,elasticsearch,spark\",\n  \"content\":\"You konw, for big data\"\n}\n\n#\u4f7f\u7528pipeline\u66f4\u65b0\u6570\u636e\nPUT tech_blogs/_doc/2?pipeline=blog_pipeline\n{\n  \"title\": \"Introducing cloud computering\",\n  \"tags\": \"openstack,k8s\",\n  \"content\": \"You konw, for cloud\"\n}\n</code></pre> <pre><code>#\u67e5\u770b\u4e24\u6761\u6570\u636e\uff0c\u4e00\u6761\u88ab\u5904\u7406\uff0c\u4e00\u6761\u672a\u88ab\u5904\u7406\nPOST tech_blogs/_search\n{}\n\n#update_by_query \u4f1a\u5bfc\u81f4\u9519\u8bef\nPOST tech_blogs/_update_by_query?pipeline=blog_pipeline\n{\n}\nOutput: 400 - Bad Request\n</code></pre> <p>\u589e\u52a0<code>update_by_query</code>\u7684\u6761\u4ef6</p> <pre><code>#\u589e\u52a0update_by_query\u7684\u6761\u4ef6\nPOST tech_blogs/_update_by_query?pipeline=blog_pipeline\n{\n    \"query\": {\n        \"bool\": {\n            \"must_not\": {\n                \"exists\": {\n                    \"field\": \"views\"\n                }\n            }\n        }\n    }\n}\n\nOutput: 200-ok\n</code></pre> <p>Painless \u7684\u7528\u9014</p> <p>\u6848\u4f8b 1:Script Processor</p> <pre><code># \u589e\u52a0\u4e00\u4e2a Script Prcessor\nPOST _ingest/pipeline/_simulate\n{\n  \"pipeline\": {\n    \"description\": \"to split blog tags\",\n    \"processors\": [\n      {\n        \"split\": {\n          \"field\": \"tags\",\n          \"separator\": \",\"\n        }\n      },\n      {\n        \"script\": {\n          \"source\": \"\"\"\n          if(ctx.containsKey(\"content\")){\n            ctx.content_length = ctx.content.length();\n          }else{\n            ctx.content_length=0;\n          }\n\n\n          \"\"\"\n        }\n      },\n\n      {\n        \"set\":{\n          \"field\": \"views\",\n          \"value\": 0\n        }\n      }\n    ]\n  },\n\n  \"docs\": [\n    {\n      \"_index\":\"index\",\n      \"_id\":\"id\",\n      \"_source\":{\n        \"title\":\"Introducing big data......\",\n  \"tags\":\"hadoop,elasticsearch,spark\",\n  \"content\":\"You konw, for big data\"\n      }\n    },\n\n\n    {\n      \"_index\":\"index\",\n      \"_id\":\"idxx\",\n      \"_source\":{\n        \"title\":\"Introducing cloud computering\",\n  \"tags\":\"openstack,k8s\",\n  \"content\":\"You konw, for cloud\"\n      }\n    }\n\n    ]\n}\n</code></pre> <p>\u6848\u4f8b 2:\u2f42\u6863\u66f4\u65b0\u8ba1\u6570</p> <pre><code>DELETE tech_blogs\nPUT tech_blogs/_doc/1\n{\n  \"title\":\"Introducing big data......\",\n  \"tags\":\"hadoop,elasticsearch,spark\",\n  \"content\":\"You konw, for big data\",\n  \"views\":0\n}\n\nPOST tech_blogs/_update/1\n{\n  \"script\": {\n    \"source\": \"ctx._source.views += params.new_views\",\n    \"params\": {\n      \"new_views\":100\n    }\n  }\n}\n\n# \u67e5\u770bviews\u8ba1\u6570\nPOST tech_blogs/_search\n{\n\n}\n\n#\u4fdd\u5b58\u811a\u672c\u5728 Cluster State\nPOST _scripts/update_views\n{\n  \"script\":{\n    \"lang\": \"painless\",\n    \"source\": \"ctx._source.views += params.new_views\"\n  }\n}\n</code></pre> <p>\u6848\u4f8b 3:\u641c\u7d22\u65f6\u7684 Script \u5b57\u6bb5</p> <pre><code>GET tech_blogs/_search\n{\n  \"script_fields\": {\n    \"rnd_views\": {\n      \"script\": {\n        \"lang\": \"painless\",\n        \"source\": \"\"\"\n          java.util.Random rnd = new Random();\n          doc['views'].value+rnd.nextInt(1000);\n        \"\"\"\n      }\n    }\n  },\n  \"query\": {\n    \"match_all\": {}\n  }\n}\n</code></pre>"},{"location":"chap19/sum5_datamodel/#5elasticsearch","title":"5\u3001Elasticsearch \u6570\u636e\u5efa\u6a21\u5b9e\u4f8b","text":"<pre><code>DELETE books\n\nPUT books\n{\n      \"mappings\" : {\n      \"properties\" : {\n        \"author\" : {\"type\" : \"keyword\"},\n        \"cover_url\" : {\"type\" : \"keyword\",\"index\": false},\n        \"description\" : {\"type\" : \"text\"},\n        \"public_date\" : {\"type\" : \"date\"},\n        \"title\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 100\n            }\n          }\n        }\n      }\n    }\n}\n</code></pre> <p>Cover URL index \u8bbe\u7f6e\u6210false\uff0c\u65e0\u6cd5\u5bf9\u8be5\u5b57\u6bb5\u8fdb\u884c\u641c\u7d22</p> <pre><code>#Cover URL index \u8bbe\u7f6e\u6210false\uff0c\u65e0\u6cd5\u5bf9\u8be5\u5b57\u6bb5\u8fdb\u884c\u641c\u7d22\nPOST books/_search\n{\n  \"query\": {\n    \"term\": {\n      \"cover_url\": {\n        \"value\": \"https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg\"\n      }\n    }\n  }\n}\n\nOutput: 400 - Bad Request\n</code></pre> <p>Cover URL index \u8bbe\u7f6e\u6210false\uff0c\u4f9d\u7136\u652f\u6301\u805a\u5408\u5206\u6790</p> <pre><code>#Cover URL index \u8bbe\u7f6e\u6210false\uff0c\u4f9d\u7136\u652f\u6301\u805a\u5408\u5206\u6790\nPOST books/_search\n{\n  \"aggs\": {\n    \"cover\": {\n      \"terms\": {\n        \"field\": \"cover_url\",\n        \"size\": 10\n      }\n    }\n  }\n}\n</code></pre> <p>\u67e5\u8be2\u56fe\u4e66:\u89e3\u51b3\u5b57\u6bb5\u8fc7\u2f24\u5f15\u53d1\u7684\u6027\u80fd\u95ee\u9898</p> <pre><code>#\u641c\u7d22\uff0c\u901a\u8fc7store \u5b57\u6bb5\u663e\u793a\u6570\u636e\uff0c\u540c\u65f6\u9ad8\u4eae\u663e\u793a conent\u7684\u5185\u5bb9\nPOST books/_search\n{\n  \"stored_fields\": [\"title\",\"author\",\"public_date\"],\n  \"query\": {\n    \"match\": {\n      \"content\": \"searching\"\n    }\n  },\n\n  \"highlight\": {\n    \"fields\": {\n      \"content\":{}\n    }\n  }\n}\n</code></pre>"},{"location":"chap19/sum5_datamodel/#6elasticsearch","title":"6\u3001Elasticsearch \u6570\u636e\u5efa\u6a21\u6700\u4f73\u5b9e\u8df5","text":"<p>\u89e3\u51b3\u2f45\u6848:Nested Object &amp; Key Value</p> <p>\u4f7f\u7528 Nested \u5bf9\u8c61\uff0c\u589e\u52a0key/value</p> <pre><code>DELETE cookie_service\n\nPUT cookie_service\n{\n  \"mappings\": {\n    \"properties\": {\n      \"cookies\": {\n        \"type\": \"nested\",\n        \"properties\": {\n          \"name\": {\n            \"type\": \"keyword\"\n          },\n          \"dateValue\": {\n            \"type\": \"date\"\n          },\n          \"keywordValue\": {\n            \"type\": \"keyword\"\n          },\n          \"IntValue\": {\n            \"type\": \"integer\"\n          }\n        }\n      },\n      \"url\": {\n        \"type\": \"text\",\n        \"fields\": {\n          \"keyword\": {\n            \"type\": \"keyword\",\n            \"ignore_above\": 256\n          }\n        }\n      }\n    }\n  }\n}\n</code></pre> <p>\u5199\u5165\u6570\u636e\uff0c\u4f7f\u7528key\u548c\u5408\u9002\u7c7b\u578b\u7684value\u5b57\u6bb5</p> <pre><code>PUT cookie_service/_doc/1\n{\n \"url\":\"www.google.com\",\n \"cookies\":[\n    {\n      \"name\":\"username\",\n      \"keywordValue\":\"tom\"\n    },\n    {\n       \"name\":\"age\",\n      \"intValue\":32\n\n    }\n\n   ]\n }\n\n\nPUT cookie_service/_doc/2\n{\n \"url\":\"www.amazon.com\",\n \"cookies\":[\n    {\n      \"name\":\"login\",\n      \"dateValue\":\"2019-01-01\"\n    },\n    {\n       \"name\":\"email\",\n      \"IntValue\":32\n\n    }\n\n   ]\n }\n</code></pre> <p>\u5199\u2f0a &amp; \u67e5\u8be2</p> <p>Nested \u67e5\u8be2\uff0c\u901a\u8fc7bool\u67e5\u8be2\u8fdb\u884c\u8fc7\u6ee4</p> <pre><code>POST cookie_service/_search\n{\n  \"query\": {\n    \"nested\": {\n      \"path\": \"cookies\",\n      \"query\": {\n        \"bool\": {\n          \"filter\": [\n            {\n            \"term\": {\n              \"cookies.name\": \"age\"\n            }},\n            {\n              \"range\":{\n                \"cookies.intValue\":{\n                  \"gte\":30\n                }\n              }\n            }\n          ]\n        }\n      }\n    }\n  }\n}\n</code></pre> <pre><code># \u5728Mapping\u4e2d\u52a0\u5165\u5143\u4fe1\u606f\uff0c\u4fbf\u4e8e\u7ba1\u7406\nPUT softwares/\n{\n  \"mappings\": {\n    \"_meta\": {\n      \"software_version_mapping\": \"1.0\"\n    }\n  }\n}\n</code></pre> <pre><code>DELETE softwares\n\n# \u4f18\u5316,\u4f7f\u7528inner object\nPUT softwares/\n{\n  \"mappings\": {\n    \"_meta\": {\n      \"software_version_mapping\": \"1.1\"\n    },\n    \"properties\": {\n      \"version\": {\n        \"properties\": {\n          \"display_name\": {\n            \"type\": \"keyword\"\n          },\n          \"hot_fix\": {\n            \"type\": \"byte\"\n          },\n          \"marjor\": {\n            \"type\": \"byte\"\n          },\n          \"minor\": {\n            \"type\": \"byte\"\n          }\n        }\n      }\n    }\n  }\n}\n</code></pre> <pre><code>#\u901a\u8fc7 Inner Object \u5199\u5165\u591a\u4e2a\u6587\u6863\nPUT softwares/_doc/1\n{\n  \"version\":{\n  \"display_name\":\"7.1.0\",\n  \"marjor\":7,\n  \"minor\":1,\n  \"hot_fix\":0  \n  }\n\n}\n\nPUT softwares/_doc/2\n{\n  \"version\":{\n  \"display_name\":\"7.2.0\",\n  \"marjor\":7,\n  \"minor\":2,\n  \"hot_fix\":0  \n  }\n}\n\nPUT softwares/_doc/3\n{\n  \"version\":{\n  \"display_name\":\"7.2.1\",\n  \"marjor\":7,\n  \"minor\":2,\n  \"hot_fix\":1  \n  }\n}\n</code></pre> <pre><code># \u901a\u8fc7 bool \u67e5\u8be2\uff0c\nPOST softwares/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"filter\": [\n        {\n          \"match\":{\n            \"version.marjor\":7\n          }\n        },\n        {\n          \"match\":{\n            \"version.minor\":2\n          }\n        }\n\n      ]\n    }\n  }\n}\n</code></pre> <p>\u907f\u514d\u7a7a\u503c\u5f15\u8d77\u7684\u805a\u5408\u4e0d\u51c6</p> <pre><code>\nPUT ratings/_doc/1\n{\n \"rating\":5\n}\nPUT ratings/_doc/2\n{\n \"rating\":null\n}\n\nPOST ratings/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"avg\": {\n      \"avg\": {\n        \"field\": \"rating\"\n      }\n    }\n  }\n}\n</code></pre> <p>Not Null \u89e3\u51b3\u805a\u5408\u7684\u95ee\u9898</p> <pre><code>DELETE ratings\n\nPUT ratings\n{\n  \"mappings\": {\n      \"properties\": {\n        \"rating\": {\n          \"type\": \"float\",\n          \"null_value\": 1.0\n        }\n      }\n    }\n}\n\n\nPUT ratings/_doc/1\n{\n \"rating\":5\n}\nPUT ratings/_doc/2\n{\n \"rating\":null\n}\n</code></pre> <pre><code>POST ratings/_search\n{\n \"size\": 0,\n \"aggs\": {\n   \"avg\": {\n     \"avg\": {\n       \"field\": \"rating\"\n     }\n   }\n }\n}\n</code></pre>"},{"location":"chap19/sum6_Opt_Mgt/","title":"ElasticSearch Operation and Management","text":""},{"location":"chap19/sum6_Opt_Mgt/#1","title":"1\u3001\u6570\u636e\u4fdd\u62a4","text":""},{"location":"chap19/sum6_Opt_Mgt/#1-1","title":"1-1 \u96c6\u7fa4\u8eab\u4efd\u8ba4\u8bc1\u4e0e\u7528\u6237\u9274\u6743","text":"<p>\u4f7f\u7528 Security API \u521b\u5efa\u7528\u6237</p> <pre><code>POST /_security/user/jacob\n{\n    \"password\" : \"paas@word\",\n    \"roles\" : [\"admin\",\"other_role1\"],\n    \"full_name\" : \"Jacob Ace\",\n    \"email\" : \"jacobace@xxx.com\",\n    \"metadata\" : {\n        \"intelligence\" : 7\n    } \n}\n</code></pre> <p>\u5f00\u542f\u5e76\u914d\u7f6e X-Pack \u7684\u8ba4\u8bc1\u4e0e\u9274\u6743</p> <p>\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\uff0c\u6253\u5f00\u8ba4\u8bc1\u4e0e\u6388\u6743</p> <pre><code>bin/elasticsearch -E node.name=node0 -E cluster.name=geektime -E path.data=node0_data -E http.port=9200 -E xpack.security.enabled=true\n</code></pre> <p>\u65b0\u7248\u672c\u9700\u8981\u6253\u5f00SSL\uff1a <code>xpack.security.transport.ssl.enabled=true</code></p> <pre><code>elasticsearch -E node.name=node0 -E cluster.name=jx -E path.data=node0_data -E http.port=9200 -E xpack.security.enabled=true -E xpack.security.transport.ssl.enabled=true \n</code></pre> <ul> <li><code>xpack.security.transport.ssl.enabled=true</code></li> <li><code>xpack.security.enabled=true</code></li> </ul> <p>\u521b\u5efa\u9ed8\u8ba4\u7684\u7528\u6237\u548c\u5206\u7ec4</p> <pre><code>bin/elasticsearch-setup-passwords interactive\n</code></pre>"},{"location":"chap19/sum6_Opt_Mgt/#1-2","title":"1-2\u3001\u96c6\u7fa4\u5185\u90e8\u95f4\u7684\u5b89\u5168\u901a\u4fe1","text":"<p>\u751f\u6210\u8282\u70b9\u8bc1\u4e66</p> <ul> <li><code>bin/elasticsearch-certutil ca</code></li> <li><code>bin/elasticsearch-certutil cert --ca elastic-stack-ca.p12</code></li> </ul> <p>\u5c06\u8bc1\u4e66\u62f7\u8d1d\u5230 <code>/etc/elasticsearch/certs/</code> \u76ee\u5f55\u4e0b</p> <pre><code>cd /usr/share/elasticsearch\nmkdir /etc/elasticsearch/certs/\ncp elastic-stack-ca.p12 elastic-certificates.p12 /etc/elasticsearch/certs/\n</code></pre> <p><code>elasticsearch.yml</code> \u914d\u7f6e</p> <pre><code>xpack.security.transport.ssl.enabled: true\nxpack.security.transport.ssl.verification_mode: certificate\n\nxpack.security.transport.ssl.keystore.path: certs/elastic-certificates.p12\nxpack.security.transport.ssl.truststore.path: certs/elastic-certificates.p12\n</code></pre> <pre><code># ES \u542f\u7528 https\nelasticsearch -E node.name=node0 -E cluster.name=jx -E path.data=node0_data -E http.port=9200 -E xpack.security.enabled=true -E xpack.security.transport.ssl.enabled=true -E xpack.security.transport.ssl.verification_mode=certificate -E xpack.security.transport.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.http.ssl.enabled=true -E xpack.security.http.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.http.ssl.truststore.path=certs/elastic-certificates.p12\n\nelasticsearch -E node.name=node1 -E cluster.name=jx -E path.data=node0_data -E http.port=9201 -E xpack.security.enabled=true -E xpack.security.transport.ssl.enabled=true -E xpack.security.transport.ssl.verification_mode=certificate -E xpack.security.transport.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.http.ssl.enabled=true -E xpack.security.http.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.http.ssl.truststore.path=certs/elastic-certificates.p12\n</code></pre> <ul> <li>xpack.security.enabled=true</li> <li>xpack.security.transport.ssl.enabled=true</li> <li>xpack.security.transport.ssl.verification_mode=certificate </li> <li>xpack.security.transport.ssl.keystore.path=certs/elastic-certificates.p12</li> <li><code>xpack.security.http.ssl.enabled=true -E xpack.security.http.ssl.keystore.path=certs/elastic-certificates.p12</code></li> <li><code>xpack.security.http.ssl.truststore.path=certs/elastic-certificates.p12</code></li> </ul>"},{"location":"chap19/sum6_Opt_Mgt/#1-3","title":"1-3 \u96c6\u7fa4\u4e0e\u5916\u90e8\u95f4\u7684\u5b89\u5168\u901a\u4fe1","text":"<p>\u914d\u7f6e Elasticsearch for HTTPS</p> <pre><code>elasticsearch -E node.name=node0 -E cluster.name=jx -E path.data=node0_data -E http.port=9200 -E xpack.security.enabled=true -E xpack.security.transport.ssl.enabled=true -E xpack.security.transport.ssl.verification_mode=certificate -E xpack.security.transport.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.http.ssl.enabled=true -E xpack.security.http.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.http.ssl.truststore.path=certs/elastic-certificates.p12 -E xpack.security.authc.anonymous.username=true\n</code></pre> <ul> <li>xpack.security.authc.anonymous.username=true</li> </ul> <p>\u914d\u7f6e Kibana \u8fde\u63a5 ES HTTPS</p> <pre><code>sudo vim /usr/share/kibana/config/kibana.yml\n\n\nelasticsearch.hosts: [\"https://localhost:9200\"]\nelasticsearch.ssl.certificateAuthorities: [ \"/usr/share/kibana/config/certs/elastic-ca.pem\" ]\nelasticsearch.ssl.verificationMode: certificate\n</code></pre> <p>\u914d\u7f6e\u4f7f\u7528 HTTPS \u8bbf\u95ee Kibana</p> <pre><code># \u4e3a Kibna \u914d\u7f6e HTTPS\n# \u751f\u6210\u540e\u89e3\u538b\uff0c\u5305\u542b\u4e86instance.crt \u548c instance.key\nbin/elasticsearch-certutil ca --pem\nsudo cp instance.crt instance.key /usr/share/kibana/config/certs/\n\nsudo vim /usr/share/kibana/config/kibana.yml\n\n\nserver.ssl.enabled: true\nserver.ssl.certificate: config/certs/instance.crt\nserver.ssl.key: config/certs/instance.key\n</code></pre>"},{"location":"chap19/sum6_Opt_Mgt/#2elasticsearch","title":"2\u3001\u6c34\u5e73\u6269\u5c55Elasticsearch\u96c6\u7fa4","text":""},{"location":"chap19/sum6_Opt_Mgt/#2-1","title":"2-1 \u5e38\u89c1\u7684\u96c6\u7fa4\u90e8\u7f72\u65b9\u5f0f","text":"<p>1\u3001\u8282\u70b9\u7c7b\u578b</p> <ul> <li>Master eligible / Data / Ingest / Coordinating / Machine Learning</li> <li>\u5efa\u8bae\u8bbe\u7f6e\u5355\u4e00\u89d2\u8272\u7684\u8282\u70b9(dedicated node)</li> </ul>"},{"location":"chap19/sum6_Opt_Mgt/#2-2-hot-warm-shard-filtering","title":"2-2 Hot &amp; Warm \u67b6\u6784\u4e0e Shard Filtering","text":"<ul> <li>Hot \u8282\u70b9(\u901a\u5e38\u4f7f\u7528 SSD):\u7d22\u5f15\u6709\u4e0d\u65ad\u6709\u65b0\u6587\u6863\u5199\u5165\u3002\u901a\u5e38\u4f7f\u7528 SSD</li> <li>Warm \u8282\u70b9(\u901a\u5e38\u4f7f\u7528 HDD):\u7d22\u5f15\u4e0d\u5b58\u5728\u65b0\u6570\u636e\u7684\u5199\u5165;\u540c\u65f6\u4e5f\u4e0d\u5b58\u5728\u5927\u91cf\u7684\u6570\u636e\u67e5\u8be2</li> </ul> <p>\u6807\u8bb0\u8282\u70b9</p> <pre><code>GET /_cat/nodeattrs?\n</code></pre> <p>\u9700\u8981\u901a\u8fc7 \u201cnode.attr\u201d \u6765\u6807\u8bb0\u4e00\u4e2a\u8282\u70b9</p> <pre><code>elasticsearch  -E node.name=hotnode -E cluster.name=jx -E path.data=node0_data -E node.attr.my_node_type=hot\n\nelasticsearch  -E node.name=warmnode -E cluster.name=jx -E path.data=node1_data -E node.attr.my_node_type=warm\n</code></pre> <ul> <li><code>node.attr.my_node_type=hot</code></li> <li><code>node.attr.my_node_type=warm</code></li> </ul> <p>\u914d\u7f6e Hot \u6570\u636e</p> <pre><code># \u914d\u7f6e\u5230 Hot\u8282\u70b9\nPUT log-2020-11-02\n{\n  \"settings\":{\n    \"number_of_shards\":2,\n    \"number_of_replicas\":0,\n    \"index.routing.allocation.require.my_node_type\":\"hot\"\n  }\n}\n</code></pre> <pre><code>GET _cat/shards?v\n\nlog-2020-11-02                 1     p      STARTED     0    208b 172.16.72.169 hotnode\nlog-2020-11-02                 0     p      STARTED     0    208b 172.16.72.169 hotnode\n</code></pre> <p>\u65e7\u6570\u636e\u79fb\u52a8\u5230 Warm \u8282\u70b9</p> <p><code>Index.routing.allocation</code> \u662f\u4e00\u4e2a\u7d22\u5f15\u7ea7\u7684<code>dynamic setting</code>\uff0c\u53ef\u4ee5\u901a\u8fc7 API \u5728\u540e\u671f\u8fdb\u884c\u8bbe\u5b9a</p> <pre><code># \u914d\u7f6e\u5230 warm \u8282\u70b9\nPUT log-2020-11-02/_settings\n{  \n  \"index.routing.allocation.require.my_node_type\":\"warm\"\n}\n\n</code></pre> <p>Rack Awareness</p> <ul> <li>\u5f53\u4e00\u4e2a\u673a\u67b6\u65ad\u7535\uff0c\u53ef\u80fd\u4f1a\u540c\u65f6\u4e22\u5931\u51e0\u4e2a\u8282\u70b9</li> <li>\u5982\u679c\u4e00\u4e2a\u7d22\u5f15\u76f8\u540c\u7684\u4e3b\u5206\u7247\u548c\u526f\u672c\u5206\u7247\uff0c\u540c\u65f6\u5728\u8fd9\u4e2a\u673a\u67b6\u4e0a\uff0c\u5c31\u6709\u53ef\u80fd\u5bfc\u81f4\u6570\u636e\u7684\u4e22\u5931</li> <li>\u901a\u8fc7 Rack Awareness \u7684\u673a\u5236\uff0c \u5c31\u53ef\u4ee5\u5c3d\u53ef\u80fd\u907f\u514d\u5c06\u540c\u4e00\u4e2a\u7d22\u5f15\u7684\u4e3b\u526f\u5206\u7247\u540c\u65f6\u5206\u914d\u5728\u4e00\u4e2a\u673a\u67b6\u7684\u8282\u70b9\u4e0a</li> </ul> <p>\u6807\u8bb0 Rack \u8282\u70b9 + \u914d\u7f6e\u96c6\u7fa4</p> <p>\u6807\u8bb0\u4e00\u4e2a rack 1, rack2</p> <pre><code>elasticsearch  -E node.name=node1 -E cluster.name=jx -E path.data=node1_data -E node.attr.my_rack_id=rack1\n\nelasticsearch  -E node.name=node2 -E cluster.name=jx -E path.data=node2_data -E node.attr.my_rack_id=rack2\n\nPUT _cluster/settings\n{\n  \"persistent\": {\n    \"cluster.routing.allocation.awareness.attributes\": \"my_rack_id\"\n  }\n}\n</code></pre> <pre><code>PUT my_index1\n{\n  \"settings\":{\n    \"number_of_shards\":2,\n    \"number_of_replicas\":1\n  }\n}\n\n# \u5206\u7247\u5206\u5230node1, node2\nGET _cat/shards?v\nmy_index1                      1     r      STARTED     0    208b 172.16.72.169 node2\nmy_index1                      1     p      STARTED     0    208b 172.16.72.169 node1\nmy_index1                      0     p      STARTED     0    208b 172.16.72.169 node2\nmy_index1                      0     r      STARTED     0    208b 172.16.72.169 node1\n</code></pre> <p>Rack Awareness</p> <pre><code># Force awareness\n# \u6807\u8bb0\u4e00\u4e2a rack 1\nelasticsearch  -E node.name=node1 -E cluster.name=jx -E path.data=node1_data -E node.attr.my_rack_id=rack1\n\n# \u6807\u8bb0\u4e00\u4e2a rack 1\nelasticsearch  -E node.name=node2 -E cluster.name=jx -E path.data=node2_data -E node.attr.my_rack_id=rack1\n</code></pre> <ul> <li><code>node.attr.my_rack_id=rack1</code></li> </ul> <pre><code>PUT _cluster/settings\n{\n  \"persistent\": {\n    \"cluster.routing.allocation.awareness.attributes\": \"my_rack_id\",\n    \"cluster.routing.allocation.awareness.force.my_rack_id.values\": \"rack1,rack2\"\n  }\n}\n</code></pre> <pre><code>GET _cluster/settings\n</code></pre>"},{"location":"chap19/sum6_Opt_Mgt/#2-3","title":"2-3 \u5206\u7247\u8bbe\u5b9a\u53ca\u7ba1\u7406","text":"<p>1\u3001\u5355\u4e2a\u5206\u7247</p> <ul> <li>7.0 \u5f00\u59cb\uff0c\u65b0\u521b\u5efa\u4e00\u4e2a\u7d22\u5f15\u65f6\uff0c\u9ed8\u8ba4\u53ea\u6709\u4e00\u4e2a\u4e3b\u5206\u7247</li> <li>\u5355\u4e2a\u7d22\u5f15\uff0c\u5355\u4e2a\u5206\u7247\u65f6\u5019\uff0c\u96c6\u7fa4\u65e0\u6cd5\u5b9e\u73b0\u6c34\u5e73\u6269\u5c55</li> </ul> <p>2\u3001\u4e24\u4e2a\u5206\u7247</p> <p>\u96c6\u7fa4\u589e\u52a0\u4e00\u4e2a\u8282\u70b9\u540e\uff0cElasticsearch \u4f1a\u81ea\u52a8\u8fdb\u884c\u5206\u7247\u7684\u79fb\u52a8\uff0c\u4e5f\u53eb Shard Rebalancing</p> <p>3\u3001\u5982\u4f55\u8bbe\u8ba1\u5206\u7247\u6570</p> <ul> <li>\u591a\u5206\u7247\u7684\u597d\u5904:\u4e00\u4e2a\u7d22\u5f15\u5982\u679c\u5206\u5e03\u5728\u4e0d\u540c\u7684\u8282\u70b9\uff0c\u591a\u4e2a\u8282\u70b9\u53ef\u4ee5\u5e76\u884c\u6267\u884c</li> </ul> <p>4\u3001\u5206\u7247\u8fc7\u591a\u6240\u5e26\u6765\u7684\u526f\u4f5c\u7528</p> <ul> <li>Shard \u662f Elasticsearch \u5b9e\u73b0\u96c6\u7fa4\u6c34\u5e73\u6269\u5c55\u7684\u6700\u5c0f\u5355\u4f4d</li> <li>\u8fc7\u591a\u8bbe\u7f6e\u5206\u7247\u6570\u4f1a\u5e26\u6765\u4e00\u4e9b\u6f5c\u5728\u7684\u95ee\u9898<ul> <li>\u6bcf\u4e2a\u5206\u7247\u662f\u4e00\u4e2a Lucene \u7684 \u7d22\u5f15\uff0c\u4f1a\u4f7f\u7528\u673a\u5668\u7684\u8d44\u6e90\u3002\u8fc7\u591a\u7684\u5206\u7247\u4f1a\u5bfc\u81f4\u989d\u5916\u7684\u6027\u80fd\u5f00\u9500</li> <li>\u5206\u7247\u7684 Meta \u4fe1\u606f\u7531 Master \u8282\u70b9\u7ef4\u62a4\u3002\u8fc7\u591a\uff0c\u4f1a\u589e\u52a0\u7ba1\u7406\u7684\u8d1f\u62c5\u3002\u7ecf\u9a8c\u503c\uff0c\u63a7\u5236\u5206\u7247\u603b\u6570\u5728 10 W \u4ee5\u5185</li> </ul> </li> </ul> <p>5\u3001\u5982\u4f55\u786e\u5b9a\u4e3b\u5206\u7247\u6570</p> <ul> <li>\u65e5\u5fd7\u7c7b\u5e94\u7528\uff0c\u5355\u4e2a\u5206\u7247\u4e0d\u8981\u5927\u4e8e 50 GB</li> <li>\u641c\u7d22\u7c7b\u5e94\u7528\uff0c\u5355\u4e2a\u5206\u7247\u4e0d\u8981\u8d85\u8fc720 GB</li> </ul> <p>\u5177\u4f53\u8bbe\u7f6e\u51e0\u4e2a\u4e3b\u5206\u7247\u9700\u8981\u505a\u5bb9\u91cf\u89c4\u5212\uff0c\u4e3b\u5206\u7247\u4e00\u65e6\u8bbe\u5b9a\uff0c\u5219\u4e0d\u80fd\u968f\u610f\u4fee\u6539\uff0c\u9664\u975e\u505areindex\uff0c\u4e3b\u5206\u7247\u6570\u662f\u6587\u6863\u8def\u7531\u7684\u5173\u952e\u53c2\u6570\uff0c\u6240\u4ee5\uff0c\u4e00\u65e6\u53d8\u5316\u5fc5\u7136\u9700\u8981reindex</p>"},{"location":"chap19/sum6_Opt_Mgt/#2-4","title":"2-4 \u5982\u4f55\u5bf9\u96c6\u7fa4\u8fdb\u884c\u5bb9\u91cf\u89c4\u5212","text":"<ul> <li>\u5982\u679c\u9700\u8981\u8003\u8651\u53ef\u9760\u6027\u9ad8\u53ef\u7528\uff0c\u5efa\u8bae\u90e8\u7f72 3 \u53f0 dedicated \u7684 Master \u8282\u70b9</li> <li>\u5982\u679c\u6709\u590d\u6742\u7684\u67e5\u8be2\u548c\u805a\u5408\uff0c\u5efa\u8bae\u8bbe\u7f6e Coordinating \u8282\u70b9</li> </ul> <p>\u521b\u5efa\u57fa\u4e8e\u65f6\u95f4\u5e8f\u5217\u7684\u7d22\u5f15</p> <pre><code># POST /&lt;logs-{now/d}/_search\nPOST /%3Clogs-%7Bnow%2Fd%7D%3E/_search\n</code></pre> <p>\u5199\u5165\u65f6\u95f4\u5e8f\u5217\u7684\u6570\u636e \u2013 \u57fa\u4e8e Index Alias</p> <pre><code>POST _aliases\n{\n  \"actions\": [\n    {\n      \"add\": {\n        \"index\": \"log-2020.11.24\",\n        \"alias\": \"logs_write\"\n      }\n    },\n    {\n      \"remove\": {\n        \"index\": \"log-2020.11.23\",\n        \"alias\": \"logs_write\"\n      }\n    }\n  ]\n}\n</code></pre>"},{"location":"chap19/sum6_Opt_Mgt/#3","title":"3\u3001\u751f\u4ea7\u73af\u5883\u4e2d\u7684\u96c6\u7fa4\u8fd0\u7ef4","text":""},{"location":"chap19/sum6_Opt_Mgt/#3-1","title":"3-1 \u751f\u4ea7\u73af\u5883\u5e38\u7528\u914d\u7f6e\u548c\u4e0a\u7ebf\u6e05\u5355","text":"<ul> <li>\u5c06 \u5185\u5b58 Xms \u548c Xmx \u8bbe\u7f6e\u6210\u4e00\u6837\uff0c\u907f\u514d heap resize \u65f6\u5f15\u53d1\u505c\u987f</li> <li>Xmx \u8bbe\u7f6e\u4e0d\u8981\u8d85\u8fc7\u7269\u7406\u5185\u5b58\u7684 50%;\u5355\u4e2a\u8282\u70b9\u4e0a\uff0c\u6700\u5927\u5185\u5b58\u5efa\u8bae\u4e0d\u8981\u8d85\u8fc7 32 G \u5185\u5b58</li> <li>\u751f\u4ea7\u73af\u5883\uff0cJVM \u5fc5\u987b\u4f7f\u7528 Server \u6a21\u5f0f</li> <li>\u5173\u95ed JVM Swapping</li> </ul> <p>\u96c6\u7fa4\u7684 API \u8bbe\u5b9a</p> <ul> <li>Transient \u5728\u96c6\u7fa4\u91cd\u542f\u540e\u4f1a\u4e22\u5931</li> <li>Persistent \u5728\u96c6\u7fa4\u4e2d\u91cd\u542f\u540e\u4e0d\u4f1a\u4e22\u5931</li> </ul> <p>\u5185\u5b58\u8bbe\u5b9a\u8ba1\u7b97\u5b9e\u4f8b</p> <ul> <li>\u641c\u7d22\u7c7b\u7684\u6bd4\u4f8b\u5efa\u8bae: 1:16</li> <li>\u65e5\u5fd7\u7c7b: 1:48 - 1:96 \u4e4b\u95f4</li> </ul> <p>\u96c6\u7fa4\u8bbe\u7f6e:Throttles \u9650\u6d41</p> <p>\u4e3a Relocation \u548c Recovery \u8bbe\u7f6e\u9650\u6d41\uff0c\u907f\u514d\u8fc7\u591a\u4efb\u52a1\u5bf9\u96c6\u7fa4\u4ea7\u751f\u6027\u80fd\u5f71\u54cd</p> <ul> <li>Recovery<ul> <li><code>Cluster.routing.allocation.node_concurrent_recoveries: 2</code></li> </ul> </li> <li>Relocation    <ul> <li><code>Cluster.routing.allocation.cluster_concurrent_rebalance: 2</code></li> </ul> </li> </ul> <p>\u96c6\u7fa4\u8bbe\u7f6e:\u5173\u95ed Dynamic Indexes</p> <ul> <li>\u53ef\u4ee5\u8003\u8651\u5173\u95ed\u52a8\u6001\u7d22\u5f15\u521b\u5efa\u7684\u529f\u80fd</li> </ul> <pre><code>PUT _cluster/settings\n{\n    \"persistent\" : {\n        \"action.auto_create_index\": false\n    }\n}\n</code></pre> <ul> <li>\u6216\u8005\u901a\u8fc7\u6a21\u7248\u8bbe\u7f6e\u767d\u540d\u5355</li> </ul> <pre><code>PUT _cluster/settings\n{\n    \"persistent\" : {\n        \"action.auto_create_index\": \"logstash-*,.kibana*\"\n    }\n}\n</code></pre>"},{"location":"chap19/sum6_Opt_Mgt/#3-2-elasticsearch","title":"3-2 \u76d1\u63a7Elasticsearch\u96c6\u7fa4","text":"<p>1\u3001Elastcsearch Stats\u76f8\u5173\u7684API</p> <ul> <li>Node Stats: <code>_nodes/stats</code></li> <li>Cluster Stats: <code>_cluster/stats</code></li> <li>Index Stats: <code>index_name/_stats</code></li> </ul> <p>2\u3001Elasticsearch Task API</p> <ul> <li> <p>\u67e5\u770bTask\u76f8\u5173\u7684API</p> <ul> <li>Pending Cluster Tasks API: <code>GET _cluster/pending_tasks</code></li> <li>Task Management API: <code>GET _tasks</code>\uff08\u53ef\u4ee5\u7528\u6765Cancel\u4e00\u4e2aTask)</li> </ul> </li> <li> <p>\u76d1\u63a7Thread Pools</p> <ul> <li><code>GET _nodes/thread_pool</code></li> <li><code>GET _nodes/stats/thread_pool</code></li> <li><code>GET _cat/thread_pool?v</code></li> <li><code>GET _nodes/hot_threads</code></li> </ul> </li> </ul> <p>3\u3001The Index &amp; Query Slow Log</p> <ul> <li>\u652f\u6301\u5c06\u5206\u7247\u4e0a\uff0cSearch \u548c Fetch \u9636\u6bb5\u7684\u6162\u67e5\u8be2\u5199\u5165\u6587\u4ef6</li> <li>\u652f\u6301\u4e3a Query \u548c Fetch \u5206\u522b\u5b9a\u4e49\u9608\u503c</li> <li>\u7d22\u5f15\u7ea7\u7684\u52a8\u6001\u8bbe\u7f6e\uff0c\u53ef\u4ee5\u6309\u9700\u8bbe\u7f6e\uff0c\u6216\u8005\u901a\u8fc7 Index Template \u7edf\u4e00\u8bbe\u5b9a</li> <li>Slow log\u6587\u4ef6\u901a\u8fc7<code>log4j2.properties</code>\u914d\u7f6e</li> </ul> <pre><code>PUT /my_inde/_settings\n{\n    \"settings\" : {\n        \"index.indexing.slowlog.threshold\" : {\n            \"query:warn\" : \"10s\",\n            \"query:info\" : \"3s\",\n            \"query:debug\" : \"2s\",\n            \"query:trace\" : \"0s\",\n            \"fetch:warn\" : \"1s\",\n            \"fetch:info\" : \"600ms\",\n            \"fetch:debug\" : \"400ms\",\n            \"fetch:trace\" : \"0s\",\n        }\n    }\n}\n</code></pre> <p>stats</p> <pre><code># Node Stats\uff1a\nGET _nodes/stats\n\n\n#Cluster Stats:\nGET _cluster/stats\n\n\n# Index Stats\nGET kibana_sample_data_ecommerce/_stats\n</code></pre> <p>Pending Cluster Tasks API</p> <pre><code>#Pending Cluster Tasks API:\nGET _cluster/pending_tasks\n\n{\n  \"tasks\" : [ ]\n}\n</code></pre> <p>\u67e5\u770b\u6240\u6709\u7684 tasks\uff0c\u4e5f\u652f\u6301 cancel task</p> <pre><code># \u67e5\u770b\u6240\u6709\u7684 tasks\uff0c\u4e5f\u652f\u6301 cancel task\nGET _tasks\n</code></pre> <p><code>thread_pool</code></p> <pre><code>GET _nodes/thread_pool\nGET _nodes/stats/thread_pool\n\nGET _nodes/hot_threads\n</code></pre> <p>Index Slowlogs</p> <pre><code>PUT my_index\n\nPUT my_index/_settings\n{\n  \"index.indexing.slowlog\":{\n    \"threshold.index\":{\n      \"warn\":\"10s\",\n      \"info\": \"4s\",\n      \"debug\":\"2s\",\n      \"trace\":\"0s\"\n    },\n    \"level\":\"trace\",\n    \"source\":1000  \n  }\n}\n</code></pre>"},{"location":"chap19/sum6_Opt_Mgt/#3-3-yellow-red","title":"3-3 \u89e3\u51b3\u96c6\u7fa4 Yellow \u4e0e Red \u7684\u95ee\u9898","text":"<p>\u96c6\u7fa4\u5065\u5eb7\u5ea6</p> <ul> <li><code>GET _cluster/health</code>: \u96c6\u7fa4\u7684\u72b6\u6001(\u68c0\u67e5\u8282\u70b9\u6570\u91cf)</li> <li><code>GET _cluster/health?level=indices</code>: \u6240\u6709\u7d22\u5f15\u7684\u5065\u5eb7\u72b6\u6001 (\u67e5\u770b\u6709\u95ee\u9898\u7684\u7d22\u5f15)</li> <li><code>GET _cluster/health/my_index</code>: \u5355\u4e2a\u7d22\u5f15\u7684\u5065\u5eb7\u72b6\u6001(\u67e5\u770b\u5177\u4f53\u7684\u7d22\u5f15)</li> <li><code>GET _cluster/health?level=shards:</code> \u5206\u7247\u7ea7\u7684\u7d22\u5f15</li> <li><code>GET _cluster/allocation/explain</code>: \u8fd4\u56de\u7b2c\u4e00\u4e2a\u672a\u5206\u914d Shard \u7684\u539f\u56e0</li> </ul> <p>Explain \u53d8\u7ea2\u7684\u539f\u56e0</p> <pre><code># Explain \u53d8\u7ea2\u7684\u539f\u56e0\nGET /_cluster/allocation/explain\n</code></pre> <p>Explain \u770b hot \u4e0a\u7684 explain</p> <pre><code>PUT mytest\n{\n  \"settings\":{\n    \"number_of_shards\":2,\n    \"number_of_replicas\":1,\n    \"index.routing.allocation.require.box_type\":\"hot\"\n  }\n}\n</code></pre> <p>\u53ef\u4ee5\u6307\u5b9a Move \u6216\u8005 Reallocate \u5206\u7247</p> <pre><code>POST _cluster/reroute\n{\n    \"commands\" : {\n        \"move\" : {\n            \"index\": \"index_name\",\n            \"shard\": 0,\n            \"from_node\": \"node_name_1\",\n            \"to_node\": \"node_name_2\",\n        }\n    }\n}\n\n\nPOST _cluster/reroute?explain\n{\n    \"commands\" : {\n        \"allocate\" : {\n            \"index\": \"index_name\",\n            \"shard\": 0,\n            \"node\": \"nodename\",\n        }\n    }\n}\n</code></pre>"},{"location":"chap19/sum6_Opt_Mgt/#3-4","title":"3-4 \u96c6\u7fa4\u5199\u6027\u80fd\u4f18\u5316","text":"<p>\u4e00\u4e2a\u7d22\u5f15\u8bbe\u5b9a\u7684\u4f8b\u5b50</p> <pre><code>PUT myindex\n{\n  \"settings\": {\n    \"index\": {\n      \"refresh_interval\": \"30s\",  # 30s \u4e00\u6b21\u7684refresh\n      \"number_of_shards\": \"2\"\n    },\n    \"routing\": {\n      \"allocation\": {\n        \"total_shards_per_node\": \"3\"    #\u63a7\u5236\u5206\u7247\uff0c\u907f\u514d\u6570\u636e\u70ed\u70b9\n      }\n    },\n    \"translog\": {\n      \"sync_interval\": \"30s\",           # \u964d\u4f4e translog \u843d\u76d8\n      \"durability\": \"async\"\n    },\n    \"number_of_replicas\": 0\n  },\n  \"mappings\": {             # \u907f\u514d\u4e0d\u5fc5\u8981\u7684\u5b57\u6bb5\u7d22\u5f15\u3002 \u5fc5\u8981\u4e8b\u65f6\u53ef\u4ee5\u901a\u8fc7 update by query\u7d22\u5f15\u5fc5\u8981\u7684\u5b57\u6bb5\n    \"dynamic\": false,\n    \"properties\": {}\n  }\n}\n</code></pre>"},{"location":"chap19/sum6_Opt_Mgt/#3-5","title":"3-5 \u6bb5\u5408\u5e76\u4f18\u5316\u53ca\u6ce8\u610f\u4e8b\u9879","text":"<pre><code>POST geonames/_forcemerge?max_num_segments=1\nget _cat/segements/geonames?v\n</code></pre>"},{"location":"chap19/sum6_Opt_Mgt/#4-circuit-breaker","title":"4\u3001\u7f13\u5b58\u53ca\u4f7f\u7528 Circuit Breaker \u9650\u5236\u5185\u5b58\u4f7f\u7528","text":"<pre><code>PUT /my_index\n{\n    \"settings\" : {\n        \"index.request.cache.enable\" : false\n    }\n}\n\nGET /my_index/_search?request_cache=true\n{\n    \"size\": 0,\n    \"aggs\": {\n        \"popular_color\": {\n            \"terms\": {\n                \"field\": \"colors\"\n            }\n        }\n    }\n}\n</code></pre> <p>\u8bca\u65ad\u5185\u5b58\u72b6\u51b5</p> <p>\u67e5\u770b\u5404\u4e2a\u8282\u70b9\u7684\u5185\u5b58\u72b6\u51b5</p> <ul> <li><code>GET _cat/nodes?v</code></li> <li><code>GET _nodes/stats/indices?pretty</code></li> <li><code>GET _cat/nodes?v&amp;h=name,queryCacheMemory,queryCacheEvictions,requestCacheMemory,reques tCacheHitCount,request_cache.miss_count</code></li> <li><code>GET _cat/nodes?h=name,port,segments.memory,segments.index_writer_memory,fielddata.memo ry_size,query_cache.memory_size,request_cache.memory_size&amp;v</code></li> </ul> <p>Circuit Breaker \u7edf\u8ba1\u4fe1\u606f</p> <pre><code>GET /_nodes/stats/breaker?\n</code></pre> <pre><code>PUT /_cluster/settings\n{\n    \"persistent\" : {\n       \"indices.breaker.request.limit\" : \"90%\"\n    }\n}\n\n</code></pre>"},{"location":"chap19/sum6_Opt_Mgt/#5","title":"5\u3001\u4e00\u4e9b\u8fd0\u7ef4\u76f8\u5173\u7684\u5efa\u8bae","text":"<p>Full Restart \u7684\u6b65\u9aa4</p> <ul> <li>\u505c\u6b62\u7d22\u5f15\u6570\u636e\uff0c\u540c\u65f6\u5907\u4efd\u96c6\u7fa4</li> <li>Disable Shard Allocation (Persistent)</li> <li>\u6267\u884c Synced Flush</li> <li>\u5173\u95ed\u5e76\u66f4\u65b0\u6240\u6709\u8282\u70b9</li> <li>\u5148\u8fd0\u884c\u6240\u6709 Master \u8282\u70b9 / \u518d\u8fd0\u884c\u5176\u4ed6\u8282\u70b9</li> <li>\u7b49\u96c6\u7fa4\u53d8\u9ec4\u540e\u6253\u5f00 Shard Allocation</li> </ul> <pre><code>curl -XGET 'http://ip:9200/_cluster/health?pretty=true'\ncurl -XGET 'http://ip:9200/_cat/indices?v'\n</code></pre> <p>Disable Shard Allocation (Persistent)</p> <pre><code>curl -X PUT \"http://ip:9200/_cluster/settings\" -H 'Content-Type: application/json' -d'\n\n{\n\n   \"transient\":{\n\n      \"cluster.routing.allocation.enable\":\"none\"\n\n   }\n\n}\n'\n</code></pre> <p>\u6267\u884c Synced Flush</p> <pre><code>curl -X POST \"http://ip:9200/_flush/synced\"\n</code></pre> <p>\u7b49\u96c6\u7fa4\u53d8\u9ec4\u540e\u6253\u5f00 Shard Allocation</p> <pre><code> curl -X PUT \"http://ip:9200/_cluster/settings\" -H 'Content-Type: application/json' -d'\n\n{\n\n   \"transient\":{\n\n      \"cluster.routing.allocation.enable\":\"all\"\n\n   }\n\n}\n\n'\n</code></pre> <p>\u8fd0\u7ef4 Cheat Sheet</p> <pre><code># \u79fb\u52a8\u4e00\u4e2a\u5206\u7247\u4ece\u4e00\u4e2a\u8282\u70b9\u5230\u53e6\u5916\u4e00\u4e2a\u8282\u70b9\n\nPOST _cluster/reroute\n{\n  \"commands\": [\n    {\n      \"move\": {\n        \"index\": \"index_name\",\n        \"shard\": 0,\n        \"from_node\": \"node_name_1\",\n        \"to_node\": \"node_name_2\"\n      }\n    }\n  ]\n}\n\n\n# Fore the allocation of an unassinged shard with a reason\n\nPOST _cluster/reroute?explain\n{\n  \"commands\": [\n    {\n      \"allocate\": {\n        \"index\": \"index_name\",\n        \"shard\": 0,\n        \"node\": \"nodename\"\n      }\n    }\n  ]\n}\n\n\n# remove the nodes from cluster \nPUT _cluster/settings\n{\n  \"transient\": {\n    \"cluster.routing.allocation.exclude._ip\":\"the_IP_of_your_node\"\n  }\n}\n\n# Force a synced flush\nPOST _flush/synced\n\n\n# change the number of moving shards to balance the cluster\nPUT /_cluster/settings\n{\n  \"transient\": {\"cluster.routing.allocation.cluster_concurrent_rebalance\":2}\n}\n\n# change the number of shards being recovered simultanceously per node\nPUT _cluster/settings\n{\n  \"transient\": {\"cluster.routing.allocation.node_concurrent_recoveries\":5}\n}\n\n# Change the recovery speed\nPUT /_cluster/settings\n{\n  \"transient\": {\"indices.recovery.max_bytes_per_sec\": \"80mb\"}\n}\n\n# Change the number of concurrent streams for a recovery on a single node\nPUT _cluster/settings\n{\n  \"transient\": {\"indices.recovery.concurrent_streams\":6}\n}\n\n\n# Change the sinze of the search queue\nPUT _cluster/settings\n{\n  \"transient\": {\n    \"threadpool.search.queue_size\":2000\n  }\n}\n\n# Clear the cache on a node\nPOST _cache/clear\n\n\n#Adjust the circuit breakers\nPUT _cluster/settings\n{\n  \"persistent\": {\n    \"indices.breaker.total.limit\":\"40%\"\n  }\n}\n</code></pre>"},{"location":"chap19/sum6_Opt_Mgt/#4","title":"4\u3001\u7d22\u5f15\u751f\u547d\u5468\u671f\u7ba1\u7406","text":""},{"location":"chap19/sum6_Opt_Mgt/#4-1-shrink-rollover-api","title":"4-1 \u4f7f\u7528 Shrink \u4e0e Rollover API \u7ba1\u7406\u7d22\u5f15","text":"<ul> <li><code>Open / Close Index</code>: \u7d22\u5f15\u5173\u95ed\u540e\u65e0\u6cd5\u8fdb\u884c\u8bfb\u5199\uff0c\u4f46\u662f\u7d22\u5f15\u6570\u636e\u4e0d\u4f1a\u88ab\u5220\u9664</li> <li><code>Shrink Index</code>:\u53ef\u4ee5\u5c06\u7d22\u5f15\u7684\u4e3b\u5206\u7247\u6570\u6536\u7f29\u5230\u8f83\u5c0f\u7684\u503c</li> <li><code>Split Index</code>:\u53ef\u4ee5\u6269\u5927\u4e3b\u5206\u7247\u4e2a\u6570</li> <li><code>Rollover Index</code>:\u7c7b\u4f3c <code>**Log4J**</code> \u8bb0\u5f55\u65e5\u5fd7\u7684\u65b9\u5f0f\uff0c\u7d22\u5f15\u5c3a\u5bf8\u6216\u8005\u65f6\u95f4\u8d85\u8fc7\u4e00\u5b9a\u503c\u540e\uff0c\u521b\u5efa\u65b0\u7684</li> <li><code>Rollup Index</code>:\u5bf9\u6570\u636e\u8fdb\u884c\u5904\u7406\u540e\uff0c\u91cd\u65b0\u5199\u5165\uff0c\u51cf\u5c11\u6570\u636e\u91cf</li> </ul> <pre><code>#\u5173\u95ed\u7d22\u5f15\nPOST /test/_close\n</code></pre> <pre><code>#\u6253\u5f00\u7d22\u5f15\nPOST /test/_open\n\nPOST test/_search\n{\n  \"query\": {\n    \"match_all\": {}\n  }\n}\n</code></pre> <pre><code>POST test/_count\n</code></pre> <p>Shrink API</p> <pre><code>PUT my_source_index\n{\n \"settings\": {\n   \"number_of_shards\": 4,\n   \"number_of_replicas\": 0\n }\n}\n\nGET _cat/shards/my_source_index\n\n# \u5206\u7247\u65703\uff0c\u4f1a\u5931\u8d25\nPOST my_source_index/_shrink/my_target_index\n{\n  \"settings\": {\n    \"index.number_of_replicas\": 0,\n    \"index.number_of_shards\": 3,\n    \"index.codec\": \"best_compression\"\n  },\n  \"aliases\": {\n    \"my_search_indices\": {}\n  }\n}\n\n# \u62a5\u9519\uff0c\u56e0\u4e3a\u6ca1\u6709\u7f6e\u6210 readonly\nPOST my_source_index/_shrink/my_target_index\n{\n  \"settings\": {\n    \"index.number_of_replicas\": 0,\n    \"index.number_of_shards\": 2,\n    \"index.codec\": \"best_compression\"\n  },\n  \"aliases\": {\n    \"my_search_indices\": {}\n  }\n}\n\n# \u5c06 my_source_index \u8bbe\u7f6e\u4e3a\u53ea\u8bfb\nPUT /my_source_index/_settings\n{\n  \"settings\": {\n    \"index.blocks.write\": true\n  }\n}\n\n\n# \u62a5\u9519\uff0c\u5fc5\u987b\u90fd\u5728\u4e00\u4e2a\u8282\u70b9\nPOST my_source_index/_shrink/my_target_index\n{\n  \"settings\": {\n    \"index.number_of_replicas\": 0,\n    \"index.number_of_shards\": 2,\n    \"index.codec\": \"best_compression\"\n  },\n  \"aliases\": {\n    \"my_search_indices\": {}\n  }\n}\n</code></pre> <pre><code>## \u786e\u4fdd\u5206\u7247\u90fd\u5728 hot\nPUT my_source_index\n{\n \"settings\": {\n   \"number_of_shards\": 4,\n   \"number_of_replicas\": 0,\n   \"index.routing.allocation.include.box_type\":\"hot\"\n }\n}\n\nGET _cat/shards/my_source_index\n\n#\u8bbe\u7f6e\u4e3a\u53ea\u8bfb\nPUT /my_source_index/_settings\n{\n  \"settings\": {\n    \"index.blocks.write\": true\n  }\n}\n\nPOST my_source_index/_shrink/my_target_index\n{\n  \"settings\": {\n    \"index.number_of_replicas\": 0,\n    \"index.number_of_shards\": 2,\n    \"index.codec\": \"best_compression\"\n  },\n  \"aliases\": {\n    \"my_search_indices\": {}\n  }\n}\n</code></pre> <pre><code>GET _cat/shards/my_target_index\n</code></pre> <p>Split API</p> <pre><code>PUT my_source_index\n{\n \"settings\": {\n   \"number_of_shards\": 4,\n   \"number_of_replicas\": 0\n }\n}\n\n# \u5fc5\u987b\u662f\u500d\u6570\nPOST my_source_index/_split/my_target\n{\n  \"settings\": {\n    \"index.number_of_shards\": 10\n  }\n}\n\n# \u5fc5\u987b\u662f\u53ea\u8bfb\nPOST my_source_index/_split/my_target\n{\n  \"settings\": {\n    \"index.number_of_shards\": 8\n  }\n}\n</code></pre> <pre><code>#\u8bbe\u7f6e\u4e3a\u53ea\u8bfb\nPUT /my_source_index/_settings\n{\n  \"settings\": {\n    \"index.blocks.write\": true\n  }\n}\n\n\nPOST my_source_index/_split/my_target_index\n{\n  \"settings\": {\n    \"index.number_of_shards\": 8,\n    \"index.number_of_replicas\":0\n  }\n}\n</code></pre> <p>Rollover API</p> <p>\u5f53\u6ee1\u8db3\u4e00\u7cfb\u5217\u7684\u6761\u4ef6\uff0cRollover API \u652f\u6301\u5c06\u4e00\u4e2a Alias \u6307\u5411\u4e00\u4e2a\u65b0\u7684\u7d22\u5f15</p> <ul> <li>\u5b58\u6d3b\u7684\u65f6\u95f4</li> <li>\u6700\u5927\u6587\u6863\u6570</li> <li>\u6700\u5927\u7684\u6587\u4ef6\u5c3a\u5bf8</li> </ul> <p>\u4e00\u822c\u9700\u8981\u548c Index Lifecycle Management Policies \u7ed3\u5408\u4f7f\u7528</p> <ul> <li>\u53ea\u6709\u8c03\u7528 Rollover API \u65f6\uff0c\u624d\u4f1a\u53bb\u505a\u76f8\u5e94\u7684\u68c0\u6d4b\u3002ES \u5e76\u4e0d\u4f1a\u81ea\u52a8\u53bb\u76d1\u63a7\u8fd9\u4e9b\u7d22\u5f15</li> </ul> <pre><code># \u4e0d\u8bbe\u5b9a is_write_true\n# \u540d\u5b57\u7b26\u5408\u547d\u540d\u89c4\u8303\nPUT /nginx-logs-000001\n{\n  \"aliases\": {\n    \"nginx_logs_write\": {}\n  }\n}\n\n# \u591a\u6b21\u5199\u5165\u6587\u6863 &gt; 5\nPOST nginx_logs_write/_doc\n{\n  \"log\":\"something\"\n}\n\nPOST /nginx_logs_write/_rollover\n{\n  \"conditions\": {\n    \"max_age\":   \"1d\",\n    \"max_docs\":  5,\n    \"max_size\":  \"5gb\"\n  }\n}\n</code></pre> <p>Rollover API <code>is_write_index</code></p> <pre><code># \u8bbe\u7f6e is_write_index\nPUT apache-logs1\n{\n  \"aliases\": {\n    \"apache_logs\": {\n      \"is_write_index\":true\n    }\n  }\n}\n</code></pre> <pre><code># \u9700\u8981\u6307\u5b9a target \u7684\u540d\u5b57\nPOST /apache_logs/_rollover/apache-logs8xxxx\n{\n  \"conditions\": {\n    \"max_age\":   \"1d\",\n    \"max_docs\":  1,\n    \"max_size\":  \"5gb\"\n  }\n}\n</code></pre>"},{"location":"chap19/sum6_Opt_Mgt/#4-2","title":"4-2 \u7d22\u5f15\u5168\u751f\u547d\u5468\u671f\u7ba1\u7406\u53ca\u5de5\u5177\u4ecb\u7ecd","text":"<p>Index Lifecycle Management</p> <p>ILM\u6982\u5ff5</p> <ul> <li>Policy</li> <li>Phase</li> <li>Action</li> </ul> <pre><code># \u8bbe\u7f6e 1\u79d2\u5237\u65b01\u6b21\uff0c\u751f\u4ea7\u73af\u588310\u5206\u79cd\u5237\u65b0\u4e00\u6b21\nPUT _cluster/settings\n{\n  \"persistent\": {\n    \"indices.lifecycle.poll_interval\":\"1s\"\n  }\n}\n\nGET _cluster/settings\n\n### output\n{\n  \"persistent\" : {\n    \"indices\" : {\n      \"lifecycle\" : {\n        \"poll_interval\" : \"1s\"\n      }\n    }\n  },\n  \"transient\" : { }\n}\n\n\n# \u8bbe\u7f6e Policy\nPUT /_ilm/policy/log_ilm_policy\n{\n  \"policy\": {\n    \"phases\": {\n      \"hot\": {\n        \"actions\": {\n          \"rollover\": {\n            \"max_docs\": 5\n          }\n        }\n      },\n      \"warm\": {\n        \"min_age\": \"10s\",\n        \"actions\": {\n          \"allocate\": {\n            \"include\": {\n              \"box_type\": \"warm\"\n            }\n          }\n        }\n      },\n      \"cold\": {\n        \"min_age\": \"15s\",\n        \"actions\": {\n          \"allocate\": {\n            \"include\": {\n              \"box_type\": \"cold\"\n            }\n          }\n        }\n      },\n      \"delete\": {\n        \"min_age\": \"20s\",\n        \"actions\": {\n          \"delete\": {}\n        }\n      }\n    }\n  }\n}\n\n# \u8bbe\u7f6e\u7d22\u5f15\u6a21\u7248\nPUT /_template/log_ilm_template\n{\n  \"index_patterns\" : [\n      \"ilm_index-*\"\n    ],\n    \"settings\" : {\n      \"index\" : {\n        \"lifecycle\" : {\n          \"name\" : \"log_ilm_policy\",\n          \"rollover_alias\" : \"ilm_alias\"\n        },\n        \"routing\" : {\n          \"allocation\" : {\n            \"include\" : {\n              \"box_type\" : \"hot\"\n            }\n          }\n        },\n        \"number_of_shards\" : \"1\",\n        \"number_of_replicas\" : \"0\"\n      }\n    },\n    \"mappings\" : { },\n    \"aliases\" : { }\n}\n\nPUT ilm_index-000001\n{\n  \"settings\": {\n    \"number_of_shards\": 1,\n    \"number_of_replicas\": 0,\n    \"index.lifecycle.name\": \"log_ilm_policy\",\n    \"index.lifecycle.rollover_alias\": \"ilm_alias\",\n    \"index.routing.allocation.include.box_type\":\"hot\"\n  },\n  \"aliases\": {\n    \"ilm_alias\": {\n      \"is_write_index\": true\n    }\n  }\n}\n</code></pre>"},{"location":"chap19/sum6_Opt_Mgt/#5-backup-restore","title":"5\u3001\u96c6\u7fa4 Backup &amp; Restore","text":"<pre><code>cd /etc/elasticsearch\nvim elasticsearch.yml\n\npath.repo: [\"/home/vagrant/bak\"]\n\n# \u521b\u5efa\u4e00\u4e2a repositoty\nPUT /_snapshot/my_fs_backup\n{\n    \"type\": \"fs\",\n    \"settings\": {\n        \"location\": \"/home/vagrant/bak\",\n        \"compress\": true\n    }\n}\n\n# \u521b\u5efa\u4e00\u4e2asnapshot\nPUT /_snapshot/my_fs_backup/snapshot_1?wait_for_completion=true\n\n# \u6307\u5b9a\u7d22\u5f15\u521b\u5efa\u5feb\u7167\nPUT /_snapshot/my_fs_backup/snapshot_2?wait_for_completion=true\n{\n  \"indices\": \"my_index\",\n  \"ignore_unavailable\": true,\n  \"include_global_state\": false,\n  \"metadata\": {\n    \"taken_by\": \"jacob\",\n    \"taken_because\": \"backup before upgrading\"\n  }\n}\n\n# \u67e5\u770b\u6240\u6709\u7684\u5feb\u7167\nGET /_snapshot/my_fs_backup/_all\n\n#  \u5220\u9664\u5feb\u7167\nDELETE /_snapshot/my_fs_backup/snapshot_2\n\n#  \u56de\u590d\u5feb\u7167\nDELETE my_index\n\nPOST /_snapshot/my_fs_backup/snapshot_1/_restore\n{\n  \"indices\": \"my_index\",\n  \"index_settings\": {\n    \"index.number_of_replicas\": 5\n  },\n  \"ignore_index_settings\": [\n    \"index.refresh_interval\"\n  ]\n}\n</code></pre>"},{"location":"chap19/sum7_test/","title":"\u671f\u672b\u8003\u8bd5","text":"<p>1\u3001\u6839\u636e\u4f7f\u7528\u573a\u666f\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06Elasticsearch\u4e2d\u5b58\u50a8\u7684\u6570\u636e\u5206\u6210\u4ee5\u4e0b\u54ea\u4e24\u7c7b\uff1f </p> <ul> <li>Static data     *</li> <li>Indexed data </li> <li>Time series data    *</li> <li>Big data </li> </ul> <p>\u9898\u76ee\u89e3\u6790 </p> <p>\u4e00\u822c\u60c5\u51b5\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u5b58\u50a8\u5728Elasticsearch\u4e2d\u7684\u6570\u636e\u5206\u6210\u4e24\u5927\u7c7b\uff1aStatic data\u548cTime series data\u3002 </p> <p>Static data\u7684\u589e\u957f\u76f8\u5bf9\u7f13\u6162\uff0c\u5982\u5546\u54c1\u5206\u7c7b\u548c\u5e93\u5b58\u4fe1\u606f\u3002\u800cTime series data\u589e\u957f\u65e5\u5fd7\u4fe1\u606f\u548c\u6307\u6807\u6570\u636e\u3002 </p> <p>2\u3001\u901a\u8fc7ELK\u4ee5\u4e0b\u54ea\u4e9b\u7ec4\u4ef6\uff0c\u6211\u4eec\u53ef\u4ee5\u5b9e\u73b0\u5bf9\u670d\u52a1\u5668\u6027\u80fd\u6307\u6807\u548c\u7f51\u7edc\u6d41\u91cf\u7684\u76d1\u63a7\uff1f </p> <ul> <li>Heatbeat</li> <li>Auditbeat </li> <li>Metricbeat  *</li> <li>Package beat *</li> </ul> <p>\u7b54\u6848\uff1aCD </p> <ul> <li>Heatbeat\u4e3b\u8981\u7528\u6765\u641c\u96c6\u7f51\u7ad9\u7684uptime\u548cresponse time; </li> <li>Auditbeat\u4e3b\u8981\u7528\u6765\u5ba1\u8ba1\u7cfb\u7edf\u7528\u6237\u548c\u8fdb\u7a0b\u7684\u6d3b\u52a8\u4fe1\u606f\uff1b</li> <li>Metricbeat\u4e3b\u8981\u7528\u4e8e\u641c\u96c6\u670d\u52a1\u5668\u7684\u6307\u6807\u4fe1\u4fe1\u606f\uff1b</li> <li>Packetbeat\u53ef\u4ee5\u641c\u96c6\u7f51\u7edc\u6d41\u91cf\u4fe1\u606f\u3002 </li> </ul> <p>3\u3001Elasticsearch\u96c6\u7fa4\u4e2d\u7684\u8282\u70b9\uff0c\u76f8\u4e92\u4e4b\u95f4\u5982\u4f55\u8fdb\u884c\u901a\u4fe1\uff1f </p> <ul> <li>\u901a\u8fc79200\u7aef\u53e3\uff0c\u7528REST API\u8fdb\u884c\u901a\u4fe1 </li> <li>\u901a\u8fc79200\u7aef\u53e3\uff0c\u7528Transport\u8fdb\u884c\u901a\u4fe1 </li> <li>\u901a\u8fc79300\uff0c\u7528Transport API\u901a\u4fe1  *</li> <li>\u901a\u8fc79300\uff0c\u7528REST API\u901a\u4fe1 </li> </ul> <p>\u7b54\u6848\uff1aC </p> <p>\u9898\u76ee\u89e3\u6790</p> <ul> <li>Elasticsearh\u96c6\u7fa4\u5185\u7684\u8282\u70b9\u901a\u8fc79300\u7aef\u53e3\uff0c\u4ee5Transport API\u7684\u65b9\u5f0f\u8fdb\u884c\u8282\u70b9\u95f4\u901a\u4fe1\u3002</li> <li>\u5bf9\u5916\u5219\u901a\u8fc79200\u7aef\u53e3\uff0c\u4ee5REST API\u63d0\u4f9b\u5916\u90e8\u7a0b\u5e8f\u4e0e\u7528\u6237\u7684\u8bbf\u95ee\u3002 </li> </ul> <p>4\u3001Elasticsearch\u67e5\u8be2\u9ed8\u8ba4\u8fd4\u56de\u591a\u5c11\u6761\u7ed3\u679c\uff1f </p> <ul> <li>10   *</li> <li>20</li> <li>30 </li> <li>40 </li> </ul> <p>\u7b54\u6848\uff1aA </p> <p>\u9898\u76ee\u89e3\u6790 </p> <p>Elasticsearch\u7684\u67e5\u8be2\uff0c\u9ed8\u8ba4\u4f7f\u7528\u7b80\u5355\u610f\u4e49\u4e0a\u7684\u6d45\u5206\u9875\u3002from\u5b9a\u4e49\u4e86\u76ee\u6807\u6570\u636e\u7684\u504f\u79fb\u503c\uff0csize\u5b9a\u4e49\u5f53\u524d\u8fd4\u56de\u7684\u6570\u76ee\u3002</p> <p>\u9ed8\u8ba4from\u4e3a0, size\u4e3a10\uff0c\u5373\u6240\u6709\u7684\u67e5\u8be2\u9ed8\u8ba4\u4ec5\u4ec5\u8fd4\u56de\u524d10\u6761\u6570\u636e\u3002 </p> <p>5\u3001Analyzer\u7531\u54ea\u51e0\u4e2a\u90e8\u5206\u6784\u6210\uff1f </p> <ul> <li>character filter *</li> <li>index filter </li> <li>tokenizer *</li> <li>token filter *</li> </ul> <p>\u7b54\u6848\uff1aACD </p> <p>\u9898\u76ee\u89e3\u6790 </p> <ul> <li>\u505a\u5168\u6587\u641c\u7d22\u5c31\u9700\u8981\u5bf9\u6587\u6863\u5206\u6790\u3001\u5efa\u7d22\u5f15\u3002 </li> <li>\u4ece\u6587\u6863\u4e2d\u63d0\u53d6\u8bcd\u5143\uff08Token)\u7684\u7b97\u6cd5\u79f0\u4e3a\u5206\u8bcd\u5668\uff08Tokenizer)\uff0c\u5728\u5206\u8bcd\u524d\u9884\u5904\u7406\u7684\u7b97\u6cd5\u79f0\u4e3a\u5b57\u7b26\u8fc7\u6ee4\u5668\uff08Character Filter)\uff0c\u8fdb\u4e00\u6b65\u5904\u7406\u8bcd\u5143\u7684\u7b97\u6cd5\u79f0\u4e3a\u8bcd\u5143\u8fc7\u6ee4\u5668(Token Filter) , \u6700\u540e\u5f97\u5230\u8bcd\uff08Term)\uff0c\u6574\u4e2a\u5206\u6790\u7b97\u6cd5\u79f0\u4e3a\u5206\u6790\u5668\uff08Analyzer) </li> </ul> <p>6\u3001\u5982\u679c\u5c06\u4e00\u4e2a\u7d22\u5f15\u7684<code>number_of_shards</code>\u8bbe\u7f6e\u6210<code>4</code>\uff0c\u540c\u65f6\u5c06<code>number_of_replica</code>\u8bbe\u7f6e\u62102\uff0c\u90a3\u4e48\u8fd9\u4e2a\u7d22\u5f15\u603b\u5171\u4f1a\u6709\u591a\u5c11\u4e2a\u5206\u7247\uff1f </p> <ul> <li>6 </li> <li>8 </li> <li>12 *</li> <li>16 </li> </ul> <p>\u7b54\u6848\uff1aC  \u9898\u76ee\u89e3\u6790 </p> <p>\u7d22\u5f15\u603b\u6570\u662f<code>4+4*2=12</code></p> <p>7\u3001\u5982\u679cElasticsearch\u96c6\u7fa4\u603b\u5171\u67095\u4e2a\u8282\u70b9\uff0c\u800c\u5176\u4e2d\u67093\u4e2a<code>master-eligible</code>\u8282\u70b9\uff0c\u90a3\u6211\u4eec\u9700\u8981\u5c06<code>minimum_master_nodes</code>\u8bbe\u7f6e\u6210\u591a\u5c11\uff1f </p> <ul> <li>2         *</li> <li>3</li> <li>4</li> <li>\u65b0\u7248\u672c\u65e0\u9700\u8bbe\u7f6e *</li> </ul> <p>\u7b54\u6848\uff1aAD </p> <p>\u9898\u76ee\u89e3\u6790 </p> <p>\u5728Elasticsearch7\u4e4b\u524d\uff0c\u4e3a\u4e86\u9632\u6b62\u8111\u88c2\uff0c\u4e00\u4e2a\u57fa\u672c\u7684\u539f\u5219\u662f\uff1a </p> <p>\u9700\u8981\u5c06<code>minimum_master_nodes</code>\u8bbe\u7f6e\u6210 <code>N/2+1</code>\u3002N\u662f\u96c6\u7fa4\u4e2d<code>Master-eligible</code>\u8282\u70b9\u7684\u6570\u91cf\u3002\u5982\u679c\u5728\u96c6\u7fa4\u4e2d\u67093 Master-eligible\u8282\u70b9\u7684\u96c6\u7fa4\u4e2d\uff0c <code>minimum_master_nodes</code>\u5e94\u8be5\u88ab\u8bbe\u4e3a<code>3/2+1=2</code>(\u56db\u820d\u4e94\u5165\uff09\u3002</p> <p>\u5728\u65b0\u7248\u672c\u4e2d\uff0c\u8fd9\u4e2a\u53c2\u6570\u5df2\u7ecf\u88ab\u5e9f\u9664</p> <p>8\u3001\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cElasticsearch\u4f1a\u6839\u636e\u54ea\u4e2a\u56e0\u7d20\uff0c\u51b3\u5b9a\u5c06\u6587\u6863\u5b58\u50a8\u5230\u5177\u4f53\u54ea\u4e2a\u5206\u7247\uff1f </p> <ul> <li>\u9ed8\u8ba4\u6839\u636e\u6587\u6863\u7684\u5927\u5c0f </li> <li>\u9ed8\u8ba4\u6839\u636e\u6587\u6863\u7684ID                 *</li> <li>\u9ed8\u8ba4\u4f1a\u968f\u673a\u5206\u914d </li> <li>\u53ef\u4ee5\u901a\u8fc7\u7528\u6237\u81ea\u884c\u7684\u6570\u503c       *</li> </ul> <p>\u7b54\u6848\uff1aBD</p> <p>\u9898\u76ee\u89e3\u6790 </p> <p>\u6587\u6863\u521b\u5efa\u65f6\uff0cElasticsearch\u9700\u8981\u51b3\u5b9a\u5c06\u8fd9\u4e2a\u6587\u6863\u5b58\u50a8\u5728\u54ea\u4e00\u4e2a\u5206\u7247\u3002\u5b9e\u9645\u4e0a\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u662f\u4ee5\u4e0b\u516c\u5f0f\u51b3\u5b9a\u7684\uff1a </p> <pre><code>shard=hash(routing)%number_of_primary_shards \n</code></pre> <ul> <li>routing\u662f\u4e00\u4e2a\u53ef\u53d8\u503c\uff0c\u9ed8\u8ba4\u662f\u6587\u6863\u7684<code>_id</code>\uff0c\u4e5f\u53ef\u4ee5\u8bbe\u7f6e\u6210\u4e00\u4e2a\u81ea\u5b9a\u4e49\u7684\u503c\u3002</li> <li>routing\u901a\u8fc7hash\u51fd\u6570\u751f\u6210\u4e00\u4e2a\u6570\u5b57\uff0c\u7136\u540e\u8fd9\u4e2a\u6570\u5b57\u518d\u9664\u4ee5<code>number_of_primary_shards</code>\uff08\u4e3b\u5206\u7247\u7684\u6570\u91cf\uff09\u540e\u5f97\u5230\u4f59\u6570\u3002</li> <li>\u8fd9\u4e2a\u5206\u5e03\u57280\u5230<code>number_of_primary_shards-1</code>\u4e4b\u95f4\u7684\u4f59\u6570\uff0c\u5c31\u662f\u6211\u4eec\u6240\u5bfb\u6c42\u7684\u6587\u6863\u6240\u5728\u5206\u7247\u7684\u4f4d\u7f6e\u3002 </li> </ul> <p>9\u3001\u5f53\u96c6\u7fa4\u72b6\u6001\u53d8\u4e3a\u9ec4\u8272\uff0c\u8bf4\u660e\u96c6\u7fa4\u51fa\u73b0\u4e86\u4ec0\u4e48\u95ee\u9898\uff1f </p> <ul> <li>\u6570\u636e\u6709\u4e22\u5931\u7684\u98ce\u9669          *</li> <li>\u90e8\u5206\u6587\u6863\u5df2\u7ecf\u4e22\u5931 </li> <li>\u4e3b\u5206\u7247\u65e0\u6cd5\u5206\u914d </li> <li>\u526f\u672c\u5206\u7247\u65e0\u6cd5\u5206\u914d          *</li> </ul> <p>\u7b54\u6848\uff1aAD </p> <p>\u9898\u76ee\u89e3\u6790 \u5982\u679c\u96c6\u7fa4\u72b6\u6001\u4e3a\u9ec4\u8272\uff0c\u8bf4\u660e\uff1a </p> <ol> <li>\u5206\u914d\u4e86\u6240\u6709\u4e3b\u5206\u7247\uff0c\u4f46\u81f3\u5c11\u7f3a\u5c11\u4e00\u4e2a\u526f\u672c\u3002 </li> <li>\u6ca1\u6709\u6570\u636e\u4e22\u5931\uff0c\u4f46\u662f\u6b64\u65f6\u641c\u7d22\u7ed3\u679c\u4ecd\u5c06\u5b8c\u6574\uff0c\u6ca1\u6709\u4e22\u5931\u6570\u636e\u3002 </li> <li>\u96c6\u7fa4\u7684\u9ad8\u53ef\u7528\u6027\u5728\u67d0\u79cd\u7a0b\u5ea6\u4e0a\u4f1a\u53d7\u5230\u5f71\u54cd\uff0c\u6211\u4eec\u5e94\u8be5\u5c06\u9ec4\u8272\u89c6\u4e3a\u5e94\u8be5\u63d0\u793a\u8c03\u67e5\u7684\u8b66\u544a\u3002\u5982\u679c\u66f4\u591a\u5206\u7247\u6d88\u5931\uff0c\u96c6\u7fa4\u53d8\u7ea2\uff0c\u5c31\u53ef\u80fd\u4f1a\u4e22\u5931\u6570\u636e\u3002 </li> </ol> <p>10\u3001\u5f53\u96c6\u7fa4\u4e3b\u5206\u7247\u4e0d\u80fd\u5206\u914d\u65f6\uff0cElasticsearch\u96c6\u7fa4\u4f1a\uff1a </p> <ul> <li>\u96c6\u7fa4\u53d8\u7ea2              *</li> <li>\u96c6\u7fa4\u53d8\u9ec4 </li> <li>\u90e8\u5206\u6570\u636e\u4e0d\u518d\u53ef\u7528      *</li> <li>\u7d22\u5f15\u65e0\u6cd5\u4f7f\u7528 </li> </ul> <p>\u7b54\u6848\uff1aAC </p> <p>\u9898\u76ee\u89e3\u6790  \u5982\u679c\u96c6\u7fa4\u72b6\u6001\u4e3a\u7ea2\u8272\uff0c\u8bf4\u660e\uff1a </p> <ul> <li>\u81f3\u5c11\u4e00\u4e2a\u4e3b\u5206\u7247\u5206\u914d\u5931\u8d25\uff0c\u8fd9\u5c06\u5bfc\u81f4\u4e00\u4e9b\u6570\u636e\u4ee5\u53ca\u7d22\u5f15\u7684\u67d0\u4e9b\u90e8\u5206\u4e0d\u518d\u53ef\u7528\u3002</li> <li>\u5c3d\u7ba1\u5982\u6b64\uff0cElasticSearch\u8fd8\u662f\u5141\u8bb8\u6211\u4eec\u6267\u884c\u67e5\u8be2\uff0c\u81f3\u4e8e\u662f\u901a\u77e5\u7528\u6237\u67e5\u8be2\u7ed3\u679c\u53ef\u80fd\u4e0d\u5b8c\u6574\u8fd8\u662f\u6302\u8d77\u67e5\u8be2\uff0c\u5219\u7531\u5e94\u7528\u6784\u5efa\u8005\u81ea\u884c\u51b3\u5b9a\u3002 </li> </ul> <p>11\u3001\u4ee5\u4e0b\u90a3\u4e9b\u67e5\u8be2\u5c5e\u4e8eElasticsearch\u7684Aggregation Query? </p> <ul> <li>\u4e2d\u56fd2019\u5e74\u7684\u52a8\u4f5c\u7247\u7684\u603b\u7968\u623f\u662f\u591a\u5c11  *</li> <li>\u9644\u8fd150\u516c\u91cc\u4ee5\u5185\u7684\u7535\u5f71\u9662\u6709\u54ea\u4e9b </li> <li>\u6210\u9f99\u4e00\u5171\u6f14\u4e86\u54ea\u51e0\u672c\u7535\u5f71 </li> <li>\u6210\u9f99\u5728\u8fc7\u53bb10\u5e74\u51fa\u6f14\u7535\u5f71\u7684\u603b\u7968\u623f\u6536\u5165\u662f\u591a\u5c11   *</li> </ul> <p>\u7b54\u6848\uff1aAD  \u9898\u76ee\u89e3\u6790 </p> <ul> <li>Elasticsearch\u9664\u4e86\u5168\u6587\u68c0\u7d22\u4e4b\u5916\uff0c\u8fd8\u652f\u6301\u5404\u79cd\u805a\u5408\u7b97\u6cd5\u3002</li> <li>Aggregation\u5171\u5206\u4e3a\u4e09\u7c7b\uff1aMetric Aggregations\u3001Bucket Aggregations\u3001Pipeline Aggregations0</li> <li>\u800c\u9009\u9879B\u548cC\u5219\u662f\u901a\u8fc7Elasticsearch\u7684\u5730\u7406\u4f4d\u7f6e\u548c\u5168\u6587\u641c\u7d22\u5b9e\u73b0\u3002 </li> </ul> <p>12\u3001Elasticsearch\u67e5\u8be2\u901a\u8fc7\u54ea\u51e0\u4e2a\u53c2\u6570\u5b9e\u73b0\u5bf9\u641c\u7d22\u7ed3\u679c\u7684\u5206\u9875\uff1f </p> <ul> <li>from   *</li> <li>to                *</li> <li>scroll        *</li> <li>search_after  *</li> </ul> <p>\u7b54\u6848\uff1aABCD </p> <p>\u9898\u76ee\u89e3\u6790 </p> <p>Elasticsearch \u7684\u67e5\u8be2\u3002</p> <p>\u63d0\u4f9b\u591a\u79cd\u5206\u9875\u65b9\u5f0f\u3002\u201d\u6d45\u201c\u5206\u9875\u53ef\u4ee5\u7406\u89e3\u4e3a\u7b80\u5355\u610f\u4e49\u4e0a\u7684\u5206\u9875\u3002\u5b83\u7684\u539f\u7406\u5f88\u7b80\u5355\uff0c\u5c31\u662f\u67e5\u8be2\u524d20\u6761\u6570\u636e\uff0c\u7136\u540e\u622a\u65ad\u524d10\u6761\uff0c\u53ea\u8fd4\u56de10-20\u7684\u6570\u636e\u3002\u8fd9\u6837\u5176\u5b9e\u767d\u767d\u6d6a\u8d39\u4e86\u524d10\u6761\u6570\u636e\u3002 </p> <p>from \u5b9a\u4e49\u4e86\u76ee\u6807\u6570\u636e\u7684\u504f\u79fb\u503c\uff0csize\u5b9a\u4e49\u5f53\u524d\u8fd4\u56de\u7684\u6570\u76ee\u3002\u9ed8\u8ba4from\u4e3a0, size\u4e3a10\uff0c\u5373\u6240\u6709\u7684\u67e5\u8be2\u9ed8\u8ba4\u4ec5\u4ec5\u8fd4\u56de\u524d10 \u901a\u8fc7from\u548csize\u53ef\u4ee5\u5b9e\u73b0\u57fa\u7840\u7684\u6d45\u5206\u9875\u67e5\u8be2\u3002</p> <p>\u800cScroll API\u5219\u652f\u6301\u6211\u4eec\u68c0\u7d22\u5927\u91cf\u6570\u636e\uff08\u751a\u81f3\u5168\u90e8\u6570\u636e\uff09\u3002Scroll API\u5141\u8bb8\u6211\u4eec\u505a\u4e00\u4e2a\u521d\u59cb\u9636\u6bb5\u641c\u7d22\u5e76\u4e14\u6301\u7eed\u6279\u91cf\u4eceElasticsearch\u91cc\u62c9\u53d6\u7ed3\u679c\u76f4\u5230\u6ca1\u6709\u7ed3\u679c\u5269\u4e0b\u3002\u4f46<code>Scroll API</code>\u4e0a\u4e0b\u6587\u4ee3\u4ef7\u5f88\u9ad8\u5efa\u8bae\u4e0d\u8981\u5c06\u5176\u7528\u4e8e\u5b9e\u65f6\u7528\u6237\u8bf7\u6c42\uff0c\u800c\u5e94\u8be5\u4f7f\u7528<code>search_after</code>\u53c2\u6570\u901a\u8fc7\u63d0\u4f9b\u5b9e\u65f6\u6e38\u6807\u6765\u89e3\u51b3\u6b64\u95ee\u9898\u3002 </p> <p>13\u3001\u901a\u8fc7Elasticsearch\u63d0\u4f9b\u7684\u54ea\u4e00\u79cdAggregation\uff0c\u53ef\u4ee5\u6ee1\u8db3\u201c\u672c\u6708\u6709\u591a\u5c11\u4e2a\u4e0d\u540c\u7684\u7528\u6237\u8bbf\u95ee\u4e86\u7f51\u7ad9\u201d\u8fd9\u4e2a\u7edf\u8ba1\u9700\u6c42\uff1f </p> <ul> <li>Terms Aggregation </li> <li>Cardinality Aggregation *</li> <li>Percentile Ranks Aggregation </li> <li>Value Count Aggregation </li> </ul> <p>\u7b54\u6848\uff1aB </p> <p>\u9898\u76ee\u89e3\u6790 </p> <ul> <li>A:Terms Aggregation:\u805a\u5408\u5206\u7ec4\uff0c\u7c7b\u4f3c\u4e8esql\u4e2dgroup by\u3002\u4f8b\u5982\u53ef\u4ee5\u5c06\u65e5\u5fd7\u4fe1\u606f\u6309\u7167\u201cerror\" , \"warm\", \"info\u201d\u5206\u4e3a\u4e0d\u540c\u7684buckets</li> <li>B: Cardinality Aggregation:\u53bb\u91cd\uff0c\u7c7b\u4f3c\u4e8esql\u4e2ddistinct\uff0c\u7ed3\u679c\u4e3a\u5355\u4f4d\u6570\u91cf\uff0c\u5982\u67e5\u8be2\u5171\u6709\u591a\u5c11\u4e2a\u73ed\u7ea7\uff0c\u53ef\u4ee5\u4f7f\u7528Cadinality</li> <li>C:Percentile Ranks Aggregation\uff1a\u4e00\u4e2a<code>multi-value</code>\u6307\u6807\u805a\u5408\uff0c\u5b83\u901a\u8fc7\u4ece\u805a\u5408\u6587\u6863\u4e2d\u63d0\u53d6\u6570\u503c\u6765\u8ba1\u7b97\u4e00\u4e2a\u6216\u591a\u4e2a\u767e\u5206\u6bd4\u3002 </li> <li>D:Value count aggregation:\u67e5\u770b\u67d0\u4e2a\u5b57\u6bb5\u4e00\u5171\u6709\u591a\u5c11\u4e2a\u4e0d\u4e00\u6837\u7684\u6570\u503c\u3002 </li> </ul> <p>14\u3001\u5982\u4f55\u53ef\u4ee5\u63d0\u9ad8Terms Aggregation\u7684\u7cbe\u786e\u5ea6\uff1f </p> <ul> <li>\u589e\u52a0<code>shard_size</code>        *</li> <li>\u51cf\u5c11<code>the shard_size</code> </li> <li>\u5c06\u4e3b\u5206\u7247\u6570\u8bbe\u7f6e\u4e3a1 </li> <li>\u589e\u52a0\u4e3b\u5206\u7247\u6570 </li> </ul> <p>\u7b54\u6848\uff1aA </p> <p>\u9898\u76ee\u89e3\u6790 \u4e01erms\u805a\u5408\u5206\u6790\u4e0d\u51c6\u7684\u539f\u56e0\uff0c\u6570\u636e\u5206\u6563\u5728\u591a\u4e2a\u5206\u7247\u4e0a\uff0c\u800cCoordinating Node\u65e0\u6cd5\u83b7\u53d6\u6570\u636e\u5168\u8c8c\u3002 </p> <ul> <li>\u89e3\u51b3\u65b9\u68481:\u5f53\u6570\u636e\u91cf\u4e0d\u5927\u65f6\uff0c\u8bbe\u7f6e<code>Primary Shard</code>\u4e3a1\uff0c\u5b9e\u73b0\u51c6\u786e\u6027\u80fd\u3002 </li> <li>\u89e3\u51b3\u65b9\u68482:\u5728\u5206\u5e03\u5f0f\u6570\u9002\u5f53\u589e\u52a0<code>shard_size</code>\u53c2\u6570\uff0c\u63d0\u9ad8\u7cbe\u786e\u5ea6\u3002\u539f\u7406\uff1a\u6bcf\u6b21\u4eceShard\u4e0a\u989d\u5916\u591a\u83b7\u53d6\u6570\u636e\uff0c\u63d0\u5347\u51c6\u786e\u7387\u3002<code>Shard_Size</code>\u8bbe\u7f6e\u8fc7\u5927\uff0c\u4f1a\u8017\u8d39\u66f4\u591a\u7684\u8ba1\u7b97\u8d44\u6e90\u3002 </li> </ul> <p>15\u3001\u5982\u4f55\u8bbe\u7f6e\u7d22\u5f15\u7684Mapping\uff0c\u4f7f\u5f97\u5f53\u5199\u5165\u7684\u6587\u6863\u5305\u542b\u4e86\u672a \u5b9a\u4e49\u7684\u5b57\u6bb5\u65f6\uff0c\u5199\u5165\u4f1a\u6700\u7ec8\u5931\u8d25\uff1f </p> <ul> <li>dynamic\u8bbe\u7f6e\u4e3atrue </li> <li>dynamic\u8bbe\u7f6e\u4e3afalse </li> <li>dynamic\u8bbe\u7f6e\u4e3astrict *</li> </ul> <p>\u7b54\u6848\uff1aC </p> <p>\u9898\u76ee\u89e3\u6790 </p> <ul> <li>\u52a8\u6001\u6620\u5c04(dynamic: true): \u52a8\u6001\u6dfb\u52a0\u65b0\u7684\u5b57\u6bb5\uff08\u6216\u7f3a\u7701\uff09\u3002 </li> <li>\u9759\u6001\u6620\u5c04(dynamic: false): \u5ffd\u7565\u65b0\u7684\u5b57\u6bb5\uff0c\u5728\u539f\u6709\u7684\u6620\u5c04\u57fa\u7840\u4e0a\uff0c\u5f53\u6709\u65b0\u7684\u5b57\u6bb5\u65f6\uff0c\u4e0d\u4f1a\u4e3b\u52a8\u7684\u6dfb\u52a0\u65b0\u7684\u6620\u5c04\u5173\u7cfb\uff0c\u53ea\u4f5c\u4e3a\u67e5\u8be2\u7ed3\u679c\u51fa\u73b0\u5728\u67e5\u8be2\u4e2d\u3002</li> <li>\u4e25\u683c\u6a21\u5f0f\uff08dynamic: strict)\uff1a\u5982\u679c\u9047\u5230\u65b0\u7684\u5b57\u6bb5\uff0c\u5c31\u629b\u51fa\u5f02\u5e38\u3002 </li> </ul> <p>16\u3001\u201c\u901a\u914d\u7b26\u5339\u914d\u975e\u5e38\u5f3a\u5927\uff0c\u6240\u4ee5\u5e94\u8be5\u88ab\u5e7f\u6cdb\u4f7f\u7528\u201d\uff0c\u8bf7\u95ee\u8fd9\u4e2a\u8bf4\u6cd5\u662f\u5426\u6b63\u786e\uff1f </p> <ul> <li>\u6b63\u786e </li> <li>\u9519\u8bef        * </li> </ul> <p>\u7b54\u6848\uff1aB </p> <p>\u652f\u6301\u7684\u901a\u914d\u7b26\u662f\u201c\u201d\uff0c\u5b83\u5339\u914d\u4efb\u4f55\u5b57\u7b26\u5e8f\u5217(\u5305\u62ec\u7a7a\u5b57\u7b26\uff09\u8fd8\u6709\u201c\uff1f\u201d\uff0c\u5b83\u5339\u914d\u4efb\u4f55\u5355\u4ef7\u5b57\u7b26\u3002 \u6b64\u67e5\u8be2\u53ef\u80fd\u5f88\u6162\uff0c\u56e0\u4e3a\u5b83\u8981\u8fed\u4ee3\u591a\u4e2a\u9879\u3002\u7279\u522b\u662f\u901a\u914d\u7b26\u9879\u4e0d\u5e94\u4ee5\u901a\u914d\u7b26<code>\"\"</code>\u6216\u201c?\u201d\u5f00\u5934\u8fd9\u6837\u7684\u901a\u914d\u67e5\u8be2\u7684\u5f00\u9500\u5f88\u5927\uff0c\u4f1a\u5bf9\u751f\u4ea7\u73af\u5883\u9020\u6210\u6027\u80fd\u7684\u5f71\u54cd\u3002\u6240\u4ee5\u4e00\u5b9a\u8981\u8c28\u614e\u4f7f\u7528\u3002 </p> <p>17\u3001Elasticsearch\u7684Search template\u6709\u54ea\u4e9b\u597d\u5904\uff1f </p> <ul> <li>\u907f\u514d\u91cd\u590d\u4ee3\u7801 </li> <li>\u51cf\u5c11\u51fa\u9519\u7684\u6982\u7387 </li> <li>\u66f4\u52a0\u5bb9\u6613\u6d4b\u8bd5\u548c\u6267\u884c </li> <li>\u53ea\u5141\u8bb8\u7528\u6237\u4f7f\u7528\u4e00\u4e9b\u9884\u5b9a\u4e49\u7684\u67e5\u8be2 </li> </ul> <p>\u7b54\u6848\uff1aABCD </p> <p>\u9898\u76ee\u89e3\u6790 Elasticsearch\u7684Search Template\u5141\u8bb8\u7528\u6237\u4f7f\u7528\u53ef\u5728\u6267\u884c\u65f6\u5b9a\u4e49\u7684\u53c2\u6570\u5b9a\u4e49\u67e5\u8be2\u3002\u4f7f\u7528Search template\u80fd\u5e26\u6765\u4ee5\u4e0b\u597d\u5904\uff1a </p> <ol> <li>\u907f\u514d\u5728\u591a\u4e2a\u5730\u65b9\u91cd\u590d\u4ee3\u7801 </li> <li>\u66f4\u5bb9\u6613\u6d4b\u8bd5\u548c\u6267\u884c\u60a8\u7684\u67e5\u8be2 </li> <li>\u5728\u5e94\u7528\u7a0b\u5e8f\u95f4\u5171\u4eab\u67e5\u8be2 </li> <li>\u5141\u8bb8\u7528\u6237\u53ea\u6267\u884c\u4e00\u4e9b\u9884\u5b9a\u4e49\u7684\u67e5\u8be2 </li> <li>\u5c06\u641c\u7d22\u903b\u8f91\u4e0e\u5e94\u7528\u7a0b\u5e8f\u903b\u8f91\u5206\u79bb </li> </ol> <p>18\u3001\u5173\u4e8eElasticsearch\u7684\u7236\u5b50\u6587\u6863\u5bf9\u8c61\uff0c\u54ea\u4e9b\u9648\u8ff0\u662f\u6b63\u786e\u7684\uff1f </p> <ul> <li>\u5220\u9664child\u5bf9\u8c61\u4f1a\u4f7fparent\u5bf9\u8c61\u548c\u5176\u4ed6\u7684 siblings\u90fd\u88abreindex </li> <li>\u5b50\u6587\u6863\u5fc5\u987b\u88ab\u8def\u7531\u5230\u548c\u526f\u6587\u6863\u76f8\u540c\u7684\u5206\u7247   *</li> <li>\u5220\u9664\u4e00\u4e2a\u7236\u6587\u6863\u4f1a\u5bfc\u81f4\u6240\u6709\u7684\u5b50\u6587\u6863\u90fd\u88ab\u5220\u9664 </li> <li>\u5373\u4f7f\u7236\u6587\u6863\u5e76\u4e0d\u5b58\u5728\uff0c\u4e5f\u53ef\u4ee5\u521b\u5efa\u5b50\u6587\u6863   *</li> </ul> <p>\u7b54\u6848\uff1aBD </p> <p>\u9898\u76ee\u89e3\u6790 </p> <p>Elasticsearch\u7ef4\u62a4\u4e86\u4e00\u4e2a\u7236\u6587\u6863\u548c\u5b50\u6587\u6863\u7684\u6620\u5c04\u5173\u7cfb\uff0c\u5f97\u76ca\u4e8e\u8fd9\u4e2a\u6620\u5c04\uff0c\u7236\u3001\u5b50\u6587\u6863\u5173\u8054\u67e5\u8be2\u64cd\u4f5c\u975e\u5e38\u5feb\u3002\u4f46\u662f\u8fd9\u4e2a\u6620\u5c04\u4e5f\u5bf9\u7236\u3001\u5b50\u6587\u6863\u5173\u7cfb\u6709\u4e2a\u9650\u5236\u6761\u4ef6\uff1a\u7236\u6587\u6863\u548c\u5176\u6240\u6709\u5b50\u6587\u6863\uff0c\u90fd\u5fc5\u987b\u8981\u5b58 \u50a8\u5728\u540c\u4e00\u4e2a\u5206\u7247\u4e2d\u3002\u800cElasticsearch\u7684\u7236\u5b50\u5173\u8054\u6587\u6863\u6709\u4ee5\u4e0b\u4f18\u70b9</p> <ol> <li>\u7236\u6587\u6863\u7684\u66f4\u65b0\u4e0d\u9700\u8981\u91cd\u65b0\u4e3a\u5b50\u6587\u6863\u91cd\u5efa\u7d22\u5f15\u3002 </li> <li>\u5bf9\u5b50\u6587\u6863\u8fdb\u884c\u6dfb\u52a0\uff0c\u66f4\u6539\uff0c\u5220\u9664\u64cd\u4f5c\u5ba4\u4e0d\u4f1a\u5f71\u54cd\u7236\u6587\u6863\u6216\u8005\u5176\u4ed6\u5b50\u6587\u6863\u3002 </li> <li>\u5b50\u6587\u6863\u53ef\u4ee5\u88ab\u5f53\u505a\u67e5\u8be2\u8bf7\u6c42\u7684\u7ed3\u679c\u8fd4\u56de\u3002 </li> </ol> <p>19\u3001\u627e\u51fa\u4ee5\u4e0b\u5173\u4e8eElasticsearch\u7684\u9519\u8bef\u9648\u8ff0\uff1a </p> <ul> <li>\u5728\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u5efa\u8bae\u4e3a\u6240\u6709\u7684\u7d22\u5f15\u90fd\u521b\u5efaAlias </li> <li>\u4f7f\u7528Bulk API\u5199\u5165\u6570\u636e\uff0c\u4f1a\u6bd4\u6bcf\u6b21\u5199\u5165\u4e00\u6761\uff0c\u591a\u6b21\u5199\u5165\u66f4\u4e3a\u9ad8\u6548 </li> <li>\u5c06\u6240\u6709\u7684\u526f\u672c\u90fd\u8bbe\u7f6e\u4e3a2\u4e2a\u6216\u8005\u66f4\u591a\uff0c\u80fd\u4e3a\u96c6\u7fa4\u63d0\u4f9b\u53ef\u9760\u7684\u5907\u4efd\u673a\u5236\u4e86 *</li> <li>\u4f60\u53ef\u4ee5\u901a\u8fc7\u4e00\u6761REST\u8bf7\u6c42\uff0c\u4e3a\u96c6\u7fa4\u521b\u5efa\u4e00\u4e2a\u5feb\u7167</li> </ul> <p>\u7b54\u6848\uff1aC  \u9898\u76ee\u89e3\u6790 </p> <ul> <li>A\uff1a\u6b63\u786e\u3002 \u5728\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u6211\u4eec\u5efa\u8bae\u4e3a\u6240\u6709\u7684\u7d22\u5f15\u90fd\u521b\u5efaAlias\uff0c\u8fd9\u6837\uff0c\u5c31\u53ef\u4ee5\u5f88\u7075\u6d3b\u7684\u5bf9\u7d22\u5f15\u8fdb\u884creindex\u7b49\u53d8\u66f4\u64cd\u4f5c\uff0c\u540c\u65f6\u53c8\u4e0d\u4f1a\u5bf9\u7ebf\u4e0a\u4e1a\u52a1\u4ea7\u751f\u5f71\u54cd\u3002 </li> <li>B\uff1a\u6b63\u786e\u3002\u76f8\u6bd4\u4e0e\u6bcf\u6b21\u5355\u6761\u63d2\u5165\u6570\u636e\uff0c\u4f7f\u7528Bulk API\u80fd\u591f\u51cf\u5c11\u7f51\u7edc\u8fde\u63a5\u7684\u5f00\u9500, \u56e0\u6b64\u80fd\u63d0\u5347\u6570\u636e\u5199\u5165\u7684\u6027\u80fd\u3002 </li> <li>C\uff1a\u9519\u8bef\u3002 \u63d0\u9ad8Replica\u7684\u6570\u91cf\uff0c\u53ef\u4ee5\u63d0\u9ad8\u4e00\u4e2a\u96c6\u7fa4\u7684\u9ad8\u53ef\u7528\u6027\u3002\u4f46\u662fReplica\u5e76\u4e0d\u63d0\u4f9b\u5907\u4efd\u7684\u673a\u5236\u3002 </li> <li>D\uff1a\u6b63\u786e\u3002  Snapshot and restore\u6a21\u5757\u5141\u8bb8\u521b\u5efa\u5355\u4e2a\u7d22\u5f15\u6216\u8005\u6574\u4e2a\u96c6\u7fa4\u7684\u5feb\u7167\u5230\u8fdc\u7a0b\u4ed3\u5e93\u3002\u5728\u65e9\u671f\u7248\u672c\u91cc\u53ea\u652f\u6301\u5171\u4eab\u6587\u4ef6\u7cfb\u7edf\u7684\u4ed3\u5e93\uff0c\u4f46\u662f\u73b0\u5728\u901a\u8fc7\u5b98\u65b9\u7684\u4ed3\u5e93\u63d2\u4ef6\u53ef\u4ee5\u652f\u6301\u5404\u79cd\u5404\u6837\u7684\u540e\u53f0\u4ed3\u5e93\u3002 </li> </ul> <p>20\u3001\u627e\u51fa\u4ee5\u4e0b\u5173\u4e8eElasticsearch\u7684\u6b63\u786e\u9648\u8ff0\uff1a </p> <ul> <li>\u4f60\u53ef\u4ee5\u5c06\u7d22\u5f15\u7684\u5b57\u6bb5\u7c7b\u578b\u4ece\u201cinteger\u201d\u8f6c\u6362\u5230 \"long\"\uff0c\u56e0\u4e3a\u8fd9\u4e24\u79cd\u7c7b\u578b\u662f\u517c\u5bb9\u7684 </li> <li>\u5982\u679c\u4f60\u60f3\u68c0\u67e5\u54ea\u4e9b\u6587\u6863\u4e0d\u5305\u542b\u4e00\u4e2a\u5177\u4f53\u7684\u5b57\u6bb5\uff0c\u53ef\u4ee5\u901a\u8fc7<code>must_not</code> </li> <li>\u7d22\u5f15\u7684\u4e3b\u5206\u7247\u6570\u5728\u7d22\u7d22\u5f15\u5199\u5165\u6570\u636e\u540e\u53ef\u4ee5\u4fee\u6539\u5927\u5c0f </li> <li>\u5728\u5f88\u591a\u60c5\u51b5\u4e0b\uff0c\u4e3a\u4e00\u4e2a\u7d22\u5f15\u8bbe\u7f6e\u4e00\u4e2a\u4e3b\u5206\u7247\uff0c\u662f\u4e00\u4e2a\u597d\u7684\u8bbe\u8ba1 *</li> </ul> <p>\u7b54\u6848\uff1aD </p> <p>\u9898\u76ee\u89e3\u6790 </p> <ul> <li>A:\u9519\u8bef\u3002Intger\u548cLong\u7684\u5b57\u6bb5\u7c7b\u578b\u5e76\u4e0d\u517c\u5bb9\uff0c\u7d22\u5f15\u6709\u6587\u6863\u5199\u5165\u540e\uff0c\u4e0d\u652f\u6301\u4fee\u6539\u5b57\u6bb5\u7684\u7c7b\u578b\u3002 </li> <li>B:\u9519\u8bef\u3002\u5e94\u8be5\u4f7f\u7528exist\u67e5\u8be2\uff0c\u800c\u4e0d\u662f<code>must_not</code>\u67e5\u8be2\u3002 </li> <li>C: Elasticsearch\u4e3b\u5206\u7247\u6570\u5728\u7d22\u5f15\u521b\u5efa\u65f6\u786e\u5b9a\uff0c\u7d22\u5f15\u521b\u5efa\u540e\u4e0d\u80fd\u4fee\u6539\uff0c\u9664\u975e\u901a\u8fc7<code>reindex API</code>\u91cd\u65b0\u521b\u5efa\u3002\u6240\u4ee5\uff0c\u800c\u526f\u672c\u5206\u7247\u6570\u53ef\u4ee5\u5728\u4efb\u610f\u65f6\u95f4\u4fee\u6539\u3002</li> <li>D\uff1a\u5f88\u591a\u573a\u666f\u4e0b\uff0c\u4e3a\u4e00\u4e2a\u7d22\u5f15\u8bbe\u7f6e\u4e00\u4e2a\u4e3b\u5206\u7247\u662f\u5f88\u597d\u7684\u9009\u62e9\u3002\u7279\u522b\u662f\u7d22\u5f15\u6570\u636e\u91cf\u5c0f\u4e8e20G\u7684\u60c5\u51b5\u3002\u5355\u4e2a\u4e3b\u5206\u7247\u53ef\u4ee5\u907f\u514d\u6570\u636e\u91cf\u5c11\uff0c\u5206\u6563\u4e0d\u5747\u800c\u5bfc\u81f4\u7684\u76f8\u5173\u5ea6\u7b97\u5206\u4e0d\u51c6\u7b49\u60c5\u51b5\u3002 </li> </ul>"},{"location":"chap19/sum8_int/","title":"ElasticSearch \u9762\u8bd5","text":""},{"location":"chap19/sum8_int/#1","title":"1\u3001\u9762\u8bd5\u9898\u5256\u6790","text":"<ul> <li>\u5ba2\u6237\u7aef\u9009\u62e9\u4e00\u4e2a node \u53d1\u9001\u8bf7\u6c42\u8fc7\u53bb\uff0c\u8fd9\u4e2a node \u5c31\u662f coordinating node \uff08\u534f\u8c03\u8282\u70b9\uff09\u3002</li> <li>coordinating node \u5bf9 document \u8fdb\u884c\u8def\u7531\uff0c\u5c06\u8bf7\u6c42\u8f6c\u53d1\u7ed9\u5bf9\u5e94\u7684 node\uff08\u6709 primary shard\uff09\u3002</li> <li>\u5b9e\u9645\u7684 node \u4e0a\u7684 primary shard \u5904\u7406\u8bf7\u6c42\uff0c\u7136\u540e\u5c06\u6570\u636e\u540c\u6b65\u5230 replica node \u3002</li> <li>coordinating node \u5982\u679c\u53d1\u73b0 primary node \u548c\u6240\u6709 replica node \u90fd\u641e\u5b9a\u4e4b\u540e\uff0c\u5c31\u8fd4\u56de\u54cd\u5e94\u7ed3\u679c\u7ed9\u5ba2\u6237\u7aef\u3002</li> </ul>"},{"location":"chap19/sum8_int/#2es","title":"2\u3001es \u8bfb\u6570\u636e\u8fc7\u7a0b","text":"<p>\u53ef\u4ee5\u901a\u8fc7 doc id \u6765\u67e5\u8be2\uff0c\u4f1a\u6839\u636e doc id \u8fdb\u884c hash\uff0c\u5224\u65ad\u51fa\u6765\u5f53\u65f6\u628a doc id \u5206\u914d\u5230\u4e86\u54ea\u4e2a shard \u4e0a\u9762\u53bb\uff0c\u4ece\u90a3\u4e2a shard \u53bb\u67e5\u8be2\u3002</p> <ul> <li>\u5ba2\u6237\u7aef\u53d1\u9001\u8bf7\u6c42\u5230\u4efb\u610f\u4e00\u4e2a node\uff0c\u6210\u4e3a coordinate node \u3002</li> <li><code>coordinate node</code> \u5bf9 <code>doc id</code> \u8fdb\u884c\u54c8\u5e0c\u8def\u7531\uff0c\u5c06\u8bf7\u6c42\u8f6c\u53d1\u5230\u5bf9\u5e94\u7684 <code>node</code>\uff0c\u6b64\u65f6\u4f1a\u4f7f\u7528 <code>round-robin</code> \u968f\u673a\u8f6e\u8be2\u7b97\u6cd5\uff0c\u5728 <code>primary shard</code> \u4ee5\u53ca\u5176\u6240\u6709 <code>replica</code> \u4e2d\u968f\u673a\u9009\u62e9\u4e00\u4e2a\uff0c\u8ba9\u8bfb\u8bf7\u6c42\u8d1f\u8f7d\u5747\u8861\u3002</li> <li>\u63a5\u6536\u8bf7\u6c42\u7684 node \u8fd4\u56de document \u7ed9 coordinate node \u3002</li> <li>coordinate node \u8fd4\u56de document \u7ed9\u5ba2\u6237\u7aef\u3002</li> </ul>"},{"location":"chap19/sum8_int/#3es","title":"3\u3001es \u641c\u7d22\u6570\u636e\u8fc7\u7a0b","text":"<p>es \u6700\u5f3a\u5927\u7684\u662f\u505a\u5168\u6587\u68c0\u7d22\uff0c\u5c31\u662f\u6bd4\u5982\u4f60\u6709\u4e09\u6761\u6570\u636e\uff1a</p> <pre><code>java\u771f\u597d\u73a9\u513f\u554a\njava\u597d\u96be\u5b66\u554a\nj2ee\u7279\u522b\u725b\n</code></pre> <p>\u4f60\u6839\u636e java \u5173\u952e\u8bcd\u6765\u641c\u7d22\uff0c\u5c06\u5305\u542b java \u7684 document \u7ed9\u641c\u7d22\u51fa\u6765\u3002es \u5c31\u4f1a\u7ed9\u4f60\u8fd4\u56de\uff1ajava \u771f\u597d\u73a9\u513f\u554a\uff0cjava \u597d\u96be\u5b66\u554a\u3002</p> <ul> <li>\u5ba2\u6237\u7aef\u53d1\u9001\u8bf7\u6c42\u5230\u4e00\u4e2a coordinate node \u3002</li> <li>\u534f\u8c03\u8282\u70b9\u5c06\u641c\u7d22\u8bf7\u6c42\u8f6c\u53d1\u5230\u6240\u6709\u7684 shard \u5bf9\u5e94\u7684 primary shard \u6216 replica shard \uff0c\u90fd\u53ef\u4ee5\u3002</li> <li>query phase\uff1a\u6bcf\u4e2a shard \u5c06\u81ea\u5df1\u7684\u641c\u7d22\u7ed3\u679c\uff08\u5176\u5b9e\u5c31\u662f\u4e00\u4e9b doc id \uff09\u8fd4\u56de\u7ed9\u534f\u8c03\u8282\u70b9\uff0c\u7531\u534f\u8c03\u8282\u70b9\u8fdb\u884c\u6570\u636e\u7684\u5408\u5e76\u3001\u6392\u5e8f\u3001\u5206\u9875\u7b49\u64cd\u4f5c\uff0c\u4ea7\u51fa\u6700\u7ec8\u7ed3\u679c\u3002</li> <li>fetch phase\uff1a\u63a5\u7740\u7531\u534f\u8c03\u8282\u70b9\u6839\u636e doc id \u53bb\u5404\u4e2a\u8282\u70b9\u4e0a\u62c9\u53d6\u5b9e\u9645\u7684 document \u6570\u636e\uff0c\u6700\u7ec8\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u3002</li> </ul> <p>\u5199\u8bf7\u6c42\u662f\u5199\u5165 primary shard\uff0c\u7136\u540e\u540c\u6b65\u7ed9\u6240\u6709\u7684 replica shard\uff1b</p> <p>\u8bfb\u8bf7\u6c42\u53ef\u4ee5\u4ece primary shard \u6216 replica shard \u8bfb\u53d6\uff0c\u91c7\u7528\u7684\u662f\u968f\u673a\u8f6e\u8be2\u7b97\u6cd5\u3002</p>"},{"location":"chap19/sum8_int/#4","title":"4\u3001\u5199\u6570\u636e\u5e95\u5c42\u539f\u7406","text":"<p>\u5148\u5199\u5165\u5185\u5b58 buffer\uff0c\u5728 buffer \u91cc\u7684\u65f6\u5019\u6570\u636e\u662f\u641c\u7d22\u4e0d\u5230\u7684\uff1b\u540c\u65f6\u5c06\u6570\u636e\u5199\u5165 translog \u65e5\u5fd7\u6587\u4ef6\u3002</p> <p>\u5982\u679c buffer \u5feb\u6ee1\u4e86\uff0c\u6216\u8005\u5230\u4e00\u5b9a\u65f6\u95f4\uff0c\u5c31\u4f1a\u5c06\u5185\u5b58 buffer \u6570\u636e refresh \u5230\u4e00\u4e2a\u65b0\u7684 segment file \u4e2d\uff0c\u4f46\u662f\u6b64\u65f6\u6570\u636e\u4e0d\u662f\u76f4\u63a5\u8fdb\u5165 segment file \u78c1\u76d8\u6587\u4ef6\uff0c\u800c\u662f\u5148\u8fdb\u5165 os cache \u3002\u8fd9\u4e2a\u8fc7\u7a0b\u5c31\u662f refresh \u3002</p> <p>\u6bcf\u9694 1 \u79d2\u949f\uff0ces \u5c06 buffer \u4e2d\u7684\u6570\u636e\u5199\u5165\u4e00\u4e2a\u65b0\u7684 segment file \uff0c\u6bcf\u79d2\u949f\u4f1a\u4ea7\u751f\u4e00\u4e2a\u65b0\u7684\u78c1\u76d8\u6587\u4ef6 segment file \uff0c\u8fd9\u4e2a segment file \u4e2d\u5c31\u5b58\u50a8\u6700\u8fd1 1 \u79d2\u5185 buffer \u4e2d\u5199\u5165\u7684\u6570\u636e\u3002</p> <p>\u4f46\u662f\u5982\u679c buffer \u91cc\u9762\u6b64\u65f6\u6ca1\u6709\u6570\u636e\uff0c\u90a3\u5f53\u7136\u4e0d\u4f1a\u6267\u884c refresh \u64cd\u4f5c\uff0c\u5982\u679c buffer \u91cc\u9762\u6709\u6570\u636e\uff0c\u9ed8\u8ba4 1 \u79d2\u949f\u6267\u884c\u4e00\u6b21 refresh \u64cd\u4f5c\uff0c\u5237\u5165\u4e00\u4e2a\u65b0\u7684 segment file \u4e2d\u3002</p> <p>\u64cd\u4f5c\u7cfb\u7edf\u91cc\u9762\uff0c\u78c1\u76d8\u6587\u4ef6\u5176\u5b9e\u90fd\u6709\u4e00\u4e2a\u4e1c\u897f\uff0c\u53eb\u505a os cache \uff0c\u5373\u64cd\u4f5c\u7cfb\u7edf\u7f13\u5b58\uff0c\u5c31\u662f\u8bf4\u6570\u636e\u5199\u5165\u78c1\u76d8\u6587\u4ef6\u4e4b\u524d\uff0c\u4f1a\u5148\u8fdb\u5165 os cache \uff0c\u5148\u8fdb\u5165\u64cd\u4f5c\u7cfb\u7edf\u7ea7\u522b\u7684\u4e00\u4e2a\u5185\u5b58\u7f13\u5b58\u4e2d\u53bb\u3002\u53ea\u8981 buffer \u4e2d\u7684\u6570\u636e\u88ab refresh \u64cd\u4f5c\u5237\u5165 os cache \u4e2d\uff0c\u8fd9\u4e2a\u6570\u636e\u5c31\u53ef\u4ee5\u88ab\u641c\u7d22\u5230\u4e86\u3002</p> <p>\u4e3a\u4ec0\u4e48\u53eb es \u662f\u51c6\u5b9e\u65f6\u7684\uff1f</p> <p>NRT \uff0c\u5168\u79f0 near real-time \u3002</p> <p>\u9ed8\u8ba4\u662f\u6bcf\u9694 1 \u79d2 refresh \u4e00\u6b21\u7684\uff0c\u6240\u4ee5 es \u662f\u51c6\u5b9e\u65f6\u7684\uff0c\u56e0\u4e3a\u5199\u5165\u7684\u6570\u636e 1 \u79d2\u4e4b\u540e\u624d\u80fd\u88ab\u770b\u5230\u3002</p> <p>\u53ef\u4ee5\u901a\u8fc7 es \u7684 restful api \u6216\u8005 java api \uff0c\u624b\u52a8\u6267\u884c\u4e00\u6b21 refresh \u64cd\u4f5c\uff0c\u5c31\u662f\u624b\u52a8\u5c06 buffer \u4e2d\u7684\u6570\u636e\u5237\u5165 os cache \u4e2d\uff0c\u8ba9\u6570\u636e\u7acb\u9a6c\u5c31\u53ef\u4ee5\u88ab\u641c\u7d22\u5230\u3002\u53ea\u8981\u6570\u636e\u88ab\u8f93\u5165 os cache \u4e2d\uff0cbuffer \u5c31\u4f1a\u88ab\u6e05\u7a7a\u4e86\uff0c\u56e0\u4e3a\u4e0d\u9700\u8981\u4fdd\u7559 buffer \u4e86\uff0c\u6570\u636e\u5728 translog \u91cc\u9762\u5df2\u7ecf\u6301\u4e45\u5316\u5230\u78c1\u76d8\u53bb\u4e00\u4efd\u4e86\u3002</p> <p>\u91cd\u590d\u4e0a\u9762\u7684\u6b65\u9aa4\uff0c\u65b0\u7684\u6570\u636e\u4e0d\u65ad\u8fdb\u5165 buffer \u548c translog\uff0c\u4e0d\u65ad\u5c06 buffer \u6570\u636e\u5199\u5165\u4e00\u4e2a\u53c8\u4e00\u4e2a\u65b0\u7684 segment file \u4e2d\u53bb\uff0c\u6bcf\u6b21 refresh \u5b8c buffer \u6e05\u7a7a\uff0ctranslog \u4fdd\u7559\u3002\u968f\u7740\u8fd9\u4e2a\u8fc7\u7a0b\u63a8\u8fdb\uff0ctranslog \u4f1a\u53d8\u5f97\u8d8a\u6765\u8d8a\u5927\u3002\u5f53 translog \u8fbe\u5230\u4e00\u5b9a\u957f\u5ea6\u7684\u65f6\u5019\uff0c\u5c31\u4f1a\u89e6\u53d1 commit \u64cd\u4f5c\u3002</p> <p>commit \u64cd\u4f5c\u53d1\u751f\u7b2c\u4e00\u6b65\uff0c\u5c31\u662f\u5c06 buffer \u4e2d\u73b0\u6709\u6570\u636e refresh \u5230 os cache \u4e2d\u53bb\uff0c\u6e05\u7a7a buffer\u3002\u7136\u540e\uff0c\u5c06\u4e00\u4e2a commit point \u5199\u5165\u78c1\u76d8\u6587\u4ef6\uff0c\u91cc\u9762\u6807\u8bc6\u7740\u8fd9\u4e2a commit point \u5bf9\u5e94\u7684\u6240\u6709 segment file \uff0c\u540c\u65f6\u5f3a\u884c\u5c06 os cache \u4e2d\u76ee\u524d\u6240\u6709\u7684\u6570\u636e\u90fd fsync \u5230\u78c1\u76d8\u6587\u4ef6\u4e2d\u53bb\u3002\u6700\u540e\u6e05\u7a7a \u73b0\u6709 translog \u65e5\u5fd7\u6587\u4ef6\uff0c\u91cd\u542f\u4e00\u4e2a translog\uff0c\u6b64\u65f6 commit \u64cd\u4f5c\u5b8c\u6210\u3002</p> <p>\u8fd9\u4e2a commit \u64cd\u4f5c\u53eb\u505a flush \u3002\u9ed8\u8ba4 30 \u5206\u949f\u81ea\u52a8\u6267\u884c\u4e00\u6b21 flush \uff0c\u4f46\u5982\u679c translog \u8fc7\u5927\uff0c\u4e5f\u4f1a\u89e6\u53d1 flush \u3002flush \u64cd\u4f5c\u5c31\u5bf9\u5e94\u7740 commit \u7684\u5168\u8fc7\u7a0b\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 es api\uff0c\u624b\u52a8\u6267\u884c flush \u64cd\u4f5c\uff0c\u624b\u52a8\u5c06 os cache \u4e2d\u7684\u6570\u636e fsync \u5f3a\u5237\u5230\u78c1\u76d8\u4e0a\u53bb\u3002</p> <p>translog \u65e5\u5fd7\u6587\u4ef6\u7684\u4f5c\u7528\u662f\u4ec0\u4e48\uff1f\u4f60\u6267\u884c commit \u64cd\u4f5c\u4e4b\u524d\uff0c\u6570\u636e\u8981\u4e48\u662f\u505c\u7559\u5728 buffer \u4e2d\uff0c\u8981\u4e48\u662f\u505c\u7559\u5728 os cache \u4e2d\uff0c\u65e0\u8bba\u662f buffer \u8fd8\u662f os cache \u90fd\u662f\u5185\u5b58\uff0c\u4e00\u65e6\u8fd9\u53f0\u673a\u5668\u6b7b\u4e86\uff0c\u5185\u5b58\u4e2d\u7684\u6570\u636e\u5c31\u5168\u4e22\u4e86\u3002\u6240\u4ee5\u9700\u8981\u5c06\u6570\u636e\u5bf9\u5e94\u7684\u64cd\u4f5c\u5199\u5165\u4e00\u4e2a\u4e13\u95e8\u7684\u65e5\u5fd7\u6587\u4ef6 translog \u4e2d\uff0c\u4e00\u65e6\u6b64\u65f6\u673a\u5668\u5b95\u673a\uff0c\u518d\u6b21\u91cd\u542f\u7684\u65f6\u5019\uff0ces \u4f1a\u81ea\u52a8\u8bfb\u53d6 translog \u65e5\u5fd7\u6587\u4ef6\u4e2d\u7684\u6570\u636e\uff0c\u6062\u590d\u5230\u5185\u5b58 buffer \u548c os cache \u4e2d\u53bb\u3002</p> <p>translog \u5176\u5b9e\u4e5f\u662f\u5148\u5199\u5165 os cache \u7684\uff0c\u9ed8\u8ba4\u6bcf\u9694 5 \u79d2\u5237\u4e00\u6b21\u5230\u78c1\u76d8\u4e2d\u53bb\uff0c\u6240\u4ee5\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u53ef\u80fd\u6709 5 \u79d2\u7684\u6570\u636e\u4f1a\u4ec5\u4ec5\u505c\u7559\u5728 buffer \u6216\u8005 translog \u6587\u4ef6\u7684 os cache \u4e2d\uff0c\u5982\u679c\u6b64\u65f6\u673a\u5668\u6302\u4e86\uff0c\u4f1a\u4e22\u5931 5 \u79d2\u949f\u7684\u6570\u636e\u3002\u4f46\u662f\u8fd9\u6837\u6027\u80fd\u6bd4\u8f83\u597d\uff0c\u6700\u591a\u4e22 5 \u79d2\u7684\u6570\u636e\u3002\u4e5f\u53ef\u4ee5\u5c06 translog \u8bbe\u7f6e\u6210\u6bcf\u6b21\u5199\u64cd\u4f5c\u5fc5\u987b\u662f\u76f4\u63a5 fsync \u5230\u78c1\u76d8\uff0c\u4f46\u662f\u6027\u80fd\u4f1a\u5dee\u5f88\u591a\u3002</p> <p>\u5b9e\u9645\u4e0a\u4f60\u5728\u8fd9\u91cc\uff0c\u5982\u679c\u9762\u8bd5\u5b98\u6ca1\u6709\u95ee\u4f60 es \u4e22\u6570\u636e\u7684\u95ee\u9898\uff0c\u4f60\u53ef\u4ee5\u5728\u8fd9\u91cc\u7ed9\u9762\u8bd5\u5b98\u70ab\u4e00\u628a\uff0c\u4f60\u8bf4\uff0c\u5176\u5b9e es \u7b2c\u4e00\u662f\u51c6\u5b9e\u65f6\u7684\uff0c\u6570\u636e\u5199\u5165 1 \u79d2\u540e\u53ef\u4ee5\u641c\u7d22\u5230\uff1b\u53ef\u80fd\u4f1a\u4e22\u5931\u6570\u636e\u7684\u3002\u6709 5 \u79d2\u7684\u6570\u636e\uff0c\u505c\u7559\u5728 buffer\u3001translog os cache\u3001segment file os cache \u4e2d\uff0c\u800c\u4e0d\u5728\u78c1\u76d8\u4e0a\uff0c\u6b64\u65f6\u5982\u679c\u5b95\u673a\uff0c\u4f1a\u5bfc\u81f4 5 \u79d2\u7684\u6570\u636e\u4e22\u5931\u3002</p> <p>\u603b\u7ed3\u4e00\u4e0b\uff0c\u6570\u636e\u5148\u5199\u5165\u5185\u5b58 buffer\uff0c\u7136\u540e\u6bcf\u9694 1s\uff0c\u5c06\u6570\u636e refresh \u5230 os cache\uff0c\u5230\u4e86 os cache \u6570\u636e\u5c31\u80fd\u88ab\u641c\u7d22\u5230\uff08\u6240\u4ee5\u6211\u4eec\u624d\u8bf4 es \u4ece\u5199\u5165\u5230\u80fd\u88ab\u641c\u7d22\u5230\uff0c\u4e2d\u95f4\u6709 1s \u7684\u5ef6\u8fdf\uff09\u3002\u6bcf\u9694 5s\uff0c\u5c06\u6570\u636e\u5199\u5165 translog \u6587\u4ef6\uff08\u8fd9\u6837\u5982\u679c\u673a\u5668\u5b95\u673a\uff0c\u5185\u5b58\u6570\u636e\u5168\u6ca1\uff0c\u6700\u591a\u4f1a\u6709 5s \u7684\u6570\u636e\u4e22\u5931\uff09\uff0ctranslog \u5927\u5230\u4e00\u5b9a\u7a0b\u5ea6\uff0c\u6216\u8005\u9ed8\u8ba4\u6bcf\u9694 30mins\uff0c\u4f1a\u89e6\u53d1 commit \u64cd\u4f5c\uff0c\u5c06\u7f13\u51b2\u533a\u7684\u6570\u636e\u90fd flush \u5230 segment file \u78c1\u76d8\u6587\u4ef6\u4e2d\u3002</p> <p>\u6570\u636e\u5199\u5165 segment file \u4e4b\u540e\uff0c\u540c\u65f6\u5c31\u5efa\u7acb\u597d\u4e86\u5012\u6392\u7d22\u5f15\u3002</p>"},{"location":"chap19/sum8_int/#5","title":"5\u3001 \u5220\u9664/\u66f4\u65b0\u6570\u636e\u5e95\u5c42\u539f\u7406","text":"<p>\u5982\u679c\u662f\u5220\u9664\u64cd\u4f5c\uff0ccommit \u7684\u65f6\u5019\u4f1a\u751f\u6210\u4e00\u4e2a <code>.del</code> \u6587\u4ef6\uff0c\u91cc\u9762\u5c06\u67d0\u4e2a <code>doc</code> \u6807\u8bc6\u4e3a <code>deleted</code> \u72b6\u6001\uff0c\u90a3\u4e48\u641c\u7d22\u7684\u65f6\u5019\u6839\u636e <code>.del</code> \u6587\u4ef6\u5c31\u77e5\u9053\u8fd9\u4e2a doc \u662f\u5426\u88ab\u5220\u9664\u4e86\u3002</p> <p>buffer \u6bcf refresh \u4e00\u6b21\uff0c\u5c31\u4f1a\u4ea7\u751f\u4e00\u4e2a <code>segment file</code> \uff0c\u6240\u4ee5\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u662f 1 \u79d2\u949f\u4e00\u4e2a <code>segment file</code> \uff0c\u8fd9\u6837\u4e0b\u6765 <code>segment file</code> \u4f1a\u8d8a\u6765\u8d8a\u591a\uff0c\u6b64\u65f6\u4f1a\u5b9a\u671f\u6267\u884c <code>merge</code>\u3002</p> <p>\u6bcf\u6b21 merge \u7684\u65f6\u5019\uff0c\u4f1a\u5c06\u591a\u4e2a <code>segment file</code> \u5408\u5e76\u6210\u4e00\u4e2a\uff0c\u540c\u65f6\u8fd9\u91cc\u4f1a\u5c06\u6807\u8bc6\u4e3a <code>deleted</code> \u7684 <code>doc</code> \u7ed9\u7269\u7406\u5220\u9664\u6389\uff0c\u7136\u540e\u5c06\u65b0\u7684 <code>segment file</code> \u5199\u5165\u78c1\u76d8\uff0c\u8fd9\u91cc\u4f1a\u5199\u4e00\u4e2a <code>commit point</code> \uff0c\u6807\u8bc6\u6240\u6709\u65b0\u7684 <code>segment file</code> \uff0c\u7136\u540e\u6253\u5f00 <code>segment file</code> \u4f9b\u641c\u7d22\u4f7f\u7528\uff0c\u540c\u65f6\u5220\u9664\u65e7\u7684 <code>segment file</code> \u3002</p>"},{"location":"chap19/sum8_int/#lucene","title":"\u5e95\u5c42 lucene","text":"<p>\u7b80\u5355\u6765\u8bf4\uff0clucene \u5c31\u662f\u4e00\u4e2a jar \u5305\uff0c\u91cc\u9762\u5305\u542b\u4e86\u5c01\u88c5\u597d\u7684\u5404\u79cd\u5efa\u7acb\u5012\u6392\u7d22\u5f15\u7684\u7b97\u6cd5\u4ee3\u7801\u3002\u6211\u4eec\u7528 Java \u5f00\u53d1\u7684\u65f6\u5019\uff0c\u5f15\u5165 lucene jar\uff0c\u7136\u540e\u57fa\u4e8e lucene \u7684 api \u53bb\u5f00\u53d1\u5c31\u53ef\u4ee5\u4e86\u3002</p> <p>\u901a\u8fc7 lucene\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u5df2\u6709\u7684\u6570\u636e\u5efa\u7acb\u7d22\u5f15\uff0clucene \u4f1a\u5728\u672c\u5730\u78c1\u76d8\u4e0a\u9762\uff0c\u7ed9\u6211\u4eec\u7ec4\u7ec7\u7d22\u5f15\u7684\u6570\u636e\u7ed3\u6784\u3002</p>"},{"location":"chap19/sum8_int/#_1","title":"\u5012\u6392\u7d22\u5f15","text":"<p>\u5728\u641c\u7d22\u5f15\u64ce\u4e2d\uff0c\u6bcf\u4e2a\u6587\u6863\u90fd\u6709\u4e00\u4e2a\u5bf9\u5e94\u7684\u6587\u6863 ID\uff0c\u6587\u6863\u5185\u5bb9\u88ab\u8868\u793a\u4e3a\u4e00\u7cfb\u5217\u5173\u952e\u8bcd\u7684\u96c6\u5408\u3002\u4f8b\u5982\uff0c\u6587\u6863 1 \u7ecf\u8fc7\u5206\u8bcd\uff0c\u63d0\u53d6\u4e86 20 \u4e2a\u5173\u952e\u8bcd\uff0c\u6bcf\u4e2a\u5173\u952e\u8bcd\u90fd\u4f1a\u8bb0\u5f55\u5b83\u5728\u6587\u6863\u4e2d\u51fa\u73b0\u7684\u6b21\u6570\u548c\u51fa\u73b0\u4f4d\u7f6e\u3002</p> <p>\u90a3\u4e48\uff0c\u5012\u6392\u7d22\u5f15\u5c31\u662f\u5173\u952e\u8bcd\u5230\u6587\u6863 ID \u7684\u6620\u5c04\uff0c\u6bcf\u4e2a\u5173\u952e\u8bcd\u90fd\u5bf9\u5e94\u7740\u4e00\u7cfb\u5217\u7684\u6587\u4ef6\uff0c\u8fd9\u4e9b\u6587\u4ef6\u4e2d\u90fd\u51fa\u73b0\u4e86\u5173\u952e\u8bcd\u3002</p> <p>\u6709\u4ee5\u4e0b\u6587\u6863\uff1a</p> <p></p> <p>\u5bf9\u6587\u6863\u8fdb\u884c\u5206\u8bcd\u4e4b\u540e\uff0c\u5f97\u5230\u4ee5\u4e0b\u5012\u6392\u7d22\u5f15\u3002</p> <p></p> <p>\u53e6\u5916\uff0c\u5b9e\u7528\u7684\u5012\u6392\u7d22\u5f15\u8fd8\u53ef\u4ee5\u8bb0\u5f55\u66f4\u591a\u7684\u4fe1\u606f\uff0c\u6bd4\u5982\u6587\u6863\u9891\u7387\u4fe1\u606f\uff0c\u8868\u793a\u5728\u6587\u6863\u96c6\u5408\u4e2d\u6709\u591a\u5c11\u4e2a\u6587\u6863\u5305\u542b\u67d0\u4e2a\u5355\u8bcd\u3002</p> <p>\u90a3\u4e48\uff0c\u6709\u4e86\u5012\u6392\u7d22\u5f15\uff0c\u641c\u7d22\u5f15\u64ce\u53ef\u4ee5\u5f88\u65b9\u4fbf\u5730\u54cd\u5e94\u7528\u6237\u7684\u67e5\u8be2\u3002\u6bd4\u5982\u7528\u6237\u8f93\u5165\u67e5\u8be2 Facebook \uff0c\u641c\u7d22\u7cfb\u7edf\u67e5\u627e\u5012\u6392\u7d22\u5f15\uff0c\u4ece\u4e2d\u8bfb\u51fa\u5305\u542b\u8fd9\u4e2a\u5355\u8bcd\u7684\u6587\u6863\uff0c\u8fd9\u4e9b\u6587\u6863\u5c31\u662f\u63d0\u4f9b\u7ed9\u7528\u6237\u7684\u641c\u7d22\u7ed3\u679c\u3002</p> <p>\u8981\u6ce8\u610f\u5012\u6392\u7d22\u5f15\u7684\u4e24\u4e2a\u91cd\u8981\u7ec6\u8282\uff1a</p> <ol> <li>\u5012\u6392\u7d22\u5f15\u4e2d\u7684\u6240\u6709\u8bcd\u9879\u5bf9\u5e94\u4e00\u4e2a\u6216\u591a\u4e2a\u6587\u6863\uff1b</li> <li>\u5012\u6392\u7d22\u5f15\u4e2d\u7684\u8bcd\u9879\u6839\u636e\u5b57\u5178\u987a\u5e8f\u5347\u5e8f\u6392\u5217\u3002</li> </ol>"},{"location":"chap2/1ES_vm_install/","title":"\u7b2c\u4e00\u8282 Elasticsearch\u7684\u5b89\u88c5\u4e0e\u7b80\u5355\u914d\u7f6e","text":""},{"location":"chap2/1ES_vm_install/#1","title":"1\u3001\u672c\u8282\u77e5\u8bc6\u70b9","text":"<ul> <li>\u4e0b\u8f7d\u5e76\u8fd0\u884cElasticsearch </li> <li>Elasticsearch\u76ee\u5f55\u7ed3\u6784 </li> <li>Elasticsearch\u7684\u57fa\u672c\u914d\u7f6e\u53c2\u6570 </li> <li>\u5b66\u4e60\u5982\u4f55\u5b89\u88c5\u53ca\u67e5\u770bElasticsearch\u63d2\u4ef6 </li> <li>\u5b66\u4e60\u5728\u672c\u673a\u8fd0\u884c\u591a\u4e2aElasticsearch\u5b9e\u4f8b\uff0c\u65b9\u4fbf\u4e86\u89e3\u5206\u5e03\u5f0f\u7cfb\u7edf\u7684\u5de5\u4f5c\u673a\u5236 </li> </ul>"},{"location":"chap2/1ES_vm_install/#_1","title":"\u672c\u5730\u90e8\u7f72 &amp; \u6c34\u5e73\u6269\u5c55","text":"<ul> <li>\u5f00\u53d1\u73af\u5883\u90e8\u7f72 </li> <li>\u4e00\u4e2a\u8282\u70b9\u627f\u62c5\u591a\u79cd\u89d2\u8272 </li> <li>\u5355\u673a\u90e8\u7f72\u591a\u4e2a\u8282, \u4fbf\u4e8e\u5b66\u4e60\u4e86\u89e3\u5206\u5e03\u5f0f\u96c6\u7fa4\u7684\u5de5\u4f5c\u673a\u5236 </li> </ul>"},{"location":"chap2/1ES_vm_install/#2","title":"2\u3001\u5b89\u88c5\u6307\u5bfc","text":""},{"location":"chap2/1ES_vm_install/#2-1-java","title":"2-1 \u5b89\u88c5Java","text":"<ul> <li>\u8fd0\u884cElasticsearch\uff0c\u9700\u5b89\u88c5\u5e76\u914d\u7f6eJDK <ul> <li>\u8bbe\u7f6e<code>$JAVA_HOME</code> </li> </ul> </li> <li>\u5404\u4e2a\u7248\u672c\u5bf9Java\u7684\u4f9d\u8d56 <ul> <li>Elasticsearch 5\u9700\u8981Java 8\u4ee5\u4e0a\u7684\u7248\u672c </li> <li>Elasticsearch\u4ece6.5\u5f00\u59cb\u652f\u6301Java 11 </li> <li>https://www.elastic.co/support/matrix</li> <li>7.0\u5f00\u59cb\uff0c\u5185\u7f6e\u4e86Java\u73af\u5883 </li> </ul> </li> </ul>"},{"location":"chap2/1ES_vm_install/#2-2-elasticsearch","title":"2-2 \u83b7\u53d6 ElasticSearch \u5b89\u88c5\u5305","text":"<ul> <li>\u4e0b\u8f7d\u4e8c\u8fdb\u5236\u6587\u4ef6 https://www.elastic.co/downloads/elasticsearch </li> <li>\u652f\u6301Docker\u672c\u5730\u8fd0\u884c </li> <li>Helm chart for kubernetes </li> <li>Puppet Module </li> </ul>"},{"location":"chap2/1ES_vm_install/#2-3-elasticsearch","title":"2-3 \u5b89\u88c5\u5e76\u8fd0\u884cElasticSearch","text":""},{"location":"chap2/1ES_vm_install/#3vagrant-centos7-es7","title":"3\u3001Vagrant-Centos7 \u865a\u62df\u673a\u5b89\u88c5 ES7 \u6307\u5357","text":""},{"location":"chap2/1ES_vm_install/#3-1-vagrantfile-centos7","title":"3-1 Vagrantfile-Centos7","text":"<ul> <li>ip: <code>\"192.168.33.12\"</code></li> <li>memory:<code>\"2048\"</code></li> </ul> <pre><code>Vagrant.configure(\"2\") do |config|\n  # config.vm.box = \"ETM\"\n  config.vm.box = \"centos/7\"\n  config.vm.hostname = \"elasticsearch7\"\n  # config.vm.customize [\"modifyvm\", :id, \"--memory\", 2048]\n\n  config.vm.network :private_network, ip: \"192.168.33.12\"\n  # config.vm.network :forwarded_port, guest: 22, host: 2227, id: \"ssh\"\n\n  config.vm.provider \"vmware_desktop\" do |vb| \n    # Customize the amount of memory on the VM:\n    vb.memory = \"2048\"\n  end\nend\n</code></pre>"},{"location":"chap2/1ES_vm_install/#3-2-centos7-es7-yum","title":"3-2 Centos7 \u5b89\u88c5 ES7 \u901a\u8fc7 yum","text":"<p>https://www.elastic.co/guide/en/elasticsearch/reference/7.9/rpm.html#rpm-repos</p> <pre><code>$ sudo vim  /etc/yum.repos.d/elasticsearch.repo\n</code></pre> <pre><code>[elasticsearch]\nname=Elasticsearch repository for 7.x packages\nbaseurl=https://artifacts.elastic.co/packages/7.x/yum\ngpgcheck=1\ngpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch\nenabled=0\nautorefresh=1\ntype=rpm-md\n</code></pre> <pre><code>$ sudo yum install --enablerepo=elasticsearch elasticsearch \n$ yum info elasticsearch\nFailed to set locale, defaulting to C\nLoaded plugins: fastestmirror\nDetermining fastest mirrors\n * base: mirrors.bfsu.edu.cn\n * extras: mirrors.bfsu.edu.cn\n * updates: mirrors.163.com\nInstalled Packages\nName        : elasticsearch\nArch        : x86_64\nVersion     : 7.9.1\nRelease     : 1\nSize        : 508 M\nRepo        : installed\nFrom repo   : elasticsearch\nSummary     : Distributed RESTful search engine built for the cloud\nURL         : https://www.elastic.co/\nLicense     : Elastic License\nDescription : Reference documentation can be found at\n            :   https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html\n            :   and the 'Elasticsearch: The Definitive Guide' book can be found at\n            :   https://www.elastic.co/guide/en/elasticsearch/guide/current/index.html\n</code></pre> <pre><code>$ cd /usr/share/elasticsearch/bin\n$ ls\nelasticsearch           elasticsearch-env            elasticsearch-plugin           elasticsearch-sql-cli-7.9.1.jar  x-pack-security-env\nelasticsearch-certgen   elasticsearch-env-from-file  elasticsearch-saml-metadata    elasticsearch-syskeygen          x-pack-watcher-env\nelasticsearch-certutil  elasticsearch-keystore       elasticsearch-setup-passwords  elasticsearch-users\nelasticsearch-cli       elasticsearch-migrate        elasticsearch-shard            systemd-entrypoint\nelasticsearch-croneval  elasticsearch-node           elasticsearch-sql-cli          x-pack-env\n</code></pre> <pre><code>$ sudo vim /etc/profile.d/es.sh\n\nES_HOME=/usr/share/elasticsearch\nPATH=$ES_HOME/bin:$PATH\nexport PATH ES_HOME\nexport CLASSPATH=.\n\n$ source /etc/profile.d/es.sh\n</code></pre> <p>\u4fee\u6539\u542f\u52a8\u6240\u9700\u7684\u6587\u4ef6\u5939\u7684\u7528\u6237</p> <pre><code>$ sudo chown -R vagrant:vagrant /usr/share/elasticsearch\n$ sudo chown -R vagrant:elasticsearch /etc/sysconfig/elasticsearch\n$ sudo chown -R vagrant:elasticsearch /etc/elasticsearch\n$ sudo chown -R vagrant:elasticsearch /var/log/elasticsearch\n</code></pre> <pre><code>$ elasticsearch --help\nStarts Elasticsearch\n\nOption                Description                                               \n------                -----------                                               \n-E &lt;KeyValuePair&gt;     Configure a setting                                       \n-V, --version         Prints Elasticsearch version information and exits        \n-d, --daemonize       Starts Elasticsearch in the background                    \n-h, --help            Show help                                                 \n-p, --pidfile &lt;Path&gt;  Creates a pid file in the specified path on start         \n-q, --quiet           Turns off standard output/error streams logging in console\n-s, --silent          Show minimal output                                       \n-v, --verbose         Show verbose output\n</code></pre> <pre><code>$ elasticsearch -V\nVersion: 7.9.1, Build: default/rpm/083627f112ba94dffc1232e8b42b73492789ef91/2020-09-01T21:22:21.964974Z, JVM: 14.0.1\n</code></pre>"},{"location":"chap2/1ES_vm_install/#3-3-elasticsearch","title":"3-3 Elasticsearch \u7684\u6587\u4ef6\u76ee\u5f55\u7ed3\u6784","text":"<p>config\uff1a</p> <pre><code>$ cd /etc/elasticsearch/\n$ ls\nelasticsearch.keystore  jvm.options      jvm.options.d      role_mapping.yml  users\nelasticsearch.yml       jvm.options.bak  log4j2.properties  roles.yml         users_roles\n\n$ less elasticsearch.yml\n...\n# ----------------------------------- Paths ------------------------------------\n#\n# Path to directory where to store the data (separate multiple locations by comma):\n#\npath.data: /var/lib/elasticsearch\n#\n# Path to log files:\n#\npath.logs: /var/log/elasticsearch\n...\n</code></pre> <p>data\uff1a</p> <pre><code>$ cd /var/lib/elasticsearch\n\n$ tree .\n.\n\u2514\u2500\u2500 nodes\n    \u2514\u2500\u2500 0\n        \u251c\u2500\u2500 node.lock\n        \u2514\u2500\u2500 _state\n            \u251c\u2500\u2500 manifest-0.st\n            \u251c\u2500\u2500 node-0.st\n            \u251c\u2500\u2500 segments_13\n            \u251c\u2500\u2500 write.lock\n            \u251c\u2500\u2500 _z.cfe\n            \u251c\u2500\u2500 _z.cfs\n            \u2514\u2500\u2500 _z.si\n\n3 directories, 8 files\n</code></pre> <p>log\uff1a</p> <pre><code>$ cd /var/log/elasticsearch\n$ ls -l\ntotal 10996\n-rw-r--r--. 1 vagrant elasticsearch       0 Sep 17 07:13 elasticsearch_audit.json\n-rw-r--r--. 1 vagrant elasticsearch       0 Sep 17 07:13 elasticsearch_deprecation.json\n-rw-r--r--. 1 vagrant elasticsearch       0 Sep 17 07:13 elasticsearch_deprecation.log\n-rw-r--r--. 1 vagrant elasticsearch       0 Sep 17 07:13 elasticsearch_index_indexing_slowlog.json\n-rw-r--r--. 1 vagrant elasticsearch       0 Sep 17 07:13 elasticsearch_index_indexing_slowlog.log\n-rw-r--r--. 1 vagrant elasticsearch       0 Sep 17 07:13 elasticsearch_index_search_slowlog.json\n-rw-r--r--. 1 vagrant elasticsearch       0 Sep 17 07:13 elasticsearch_index_search_slowlog.log\n-rw-r--r--. 1 vagrant elasticsearch   33849 Sep 17 14:43 elasticsearch.log\n-rw-r--r--. 1 vagrant elasticsearch   48716 Sep 17 14:43 elasticsearch_server.json\n...\n</code></pre>"},{"location":"chap2/1ES_vm_install/#3-3-jvm","title":"3-3 JVM\u914d\u7f6e","text":"<ul> <li>\u4fee\u6539JVM - <code>config/jvm.options</code><ul> <li>7.1\u4e0b\u8f7d\u7684\u9ed8\u8ba4\u8bbe\u7f6e\u662f1GB </li> </ul> </li> <li> <p>\u914d\u7f6e\u7684\u5efa\u8bae </p> <ul> <li>Xmx\u548cXms\u8bbe\u7f6e\u6210\u4e00\u6837 </li> <li>Xmx\u4e0d\u8981\u8d85\u8fc7\u673a\u5668\u5185\u5b58\u768450% </li> <li>\u4e0d\u8981\u8d85\u8fc730GB </li> </ul> </li> <li> <p>\u6211\u4eec\u8fd9\u8fb9\u6539\u6210\u4e86512m</p> </li> </ul> <pre><code>$ cd /etc/elasticsearch/\n$ sudo vim jvm.options\n\n# Xmx\u548cXms\u8bbe\u7f6e\u6210\u4e00\u6837\n...\n# Xms represents the initial size of total heap space\n# Xmx represents the maximum size of total heap space\n\n-Xms512m\n-Xmx512m\n...\n</code></pre>"},{"location":"chap2/1ES_vm_install/#3-4-elasticsearch","title":"3-4 \u8fd0\u884c\u5355\u4e2aElasticsearch\u5b9e\u4f8b","text":"<pre><code> elasticsearch -E node.name=node0 -E cluster.name=jx -E path.data=node0_data \n</code></pre> <ul> <li>\u4e0b\u8f7d\u89e3\u538bElasticsearch\u540e\u6267\u884c <code>bin/elasticsearch</code>\uff0c\u901a\u8fc7<code>-E</code>\u8bbe\u5b9a\u5408\u9002\u7684\u53c2\u6570 </li> <li>\u8bbf\u95ee<code>http://Iocalhost:9200</code> check cluster health state </li> <li>\u901a\u8fc7<code>_cat/nodes</code>\u67e5\u770b\u8282\u70b9 </li> </ul>"},{"location":"chap2/1ES_vm_install/#3-5","title":"3-5 \u5b89\u88c5\u4e0e\u67e5\u770b\u63d2\u4ef6","text":"<p>ELasticsearch\u63d0\u4f9b\u63d2\u4ef6\u7684\u673a\u5236\u5bf9\u7cfb\u7edf\u8fdb\u884c\u6269\u5c55 </p> <ul> <li>Discovery Plugin </li> <li>Analysis Plugin </li> <li>Security Plugin </li> <li>Management Plugin </li> <li>Ingest Plugin </li> <li>Mapper Plugin </li> <li>Backup Plugin </li> </ul> <pre><code>\n$ elasticsearch-plugin -h\nA tool for managing installed elasticsearch plugins\n\nCommands\n--------\nlist - Lists installed elasticsearch plugins\ninstall - Install a plugin\nremove - removes a plugin from Elasticsearch\n\nNon-option arguments:\ncommand              \n\nOption             Description        \n------             -----------        \n-E &lt;KeyValuePair&gt;  Configure a setting\n-h, --help         Show help          \n-s, --silent       Show minimal output\n-v, --verbose      Show verbose output\n\n\nelasticsearch-plugin install analysis-icu\n\n\n$ elasticsearch-plugin install analysis-icu\n-&gt; Installing analysis-icu\n-&gt; Downloading analysis-icu from elastic\n[=================================================] 100%   \n-&gt; Installed analysis-icu\n\n$ elasticsearch-plugin list\nanalysis-icu\n</code></pre> <p>https://www.elastic.co/guide/en/elasticsearch/plugins/current/intro.html</p>"},{"location":"chap2/1ES_vm_install/#3-6-elasticsearch","title":"3-6 \u5982\u4f55\u5728\u5f00\u53d1\u673a\u4e0a\u8fd0\u884c\u591a\u4e2aElasticsearch\u5b9e\u4f8b","text":"<pre><code>$ elasticsearch -E node.name=node0 -E cluster.name=jx -E path.data=node0_data -d\n$ elasticsearch -E node.name=node1 -E cluster.name=jx -E path.data=node1_data -d\n$ elasticsearch -E node.name=node2 -E cluster.name=jx -E path.data=node2_data -d\n</code></pre> <pre><code>$ curl 127.0.0.1:9200/_cat/nodes?v\nip            heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name\n172.16.72.165           20          93   1    0.04    0.07     0.05 dilmrt    *      node1\n172.16.72.165           14          92   1    0.04    0.07     0.05 dilmrt    -      node2\n172.16.72.165           17          92   1    0.04    0.07     0.05 dilmrt    -      node0\n</code></pre> <ul> <li>\u5220\u9664\u8fdb\u7a0b</li> </ul> <pre><code>ps aux | grep elasticsearch\n\nkill pid\n</code></pre> <pre><code>$ ps -aux|grep elasticsearch | grep -v grep | awk '{print $2}'\n2499\n2518\n2681\n2700\n2880\n2910\n</code></pre> <p>Demo</p> <ul> <li>\u672c\u5730\u5b89\u88c5\u5355\u5b9e\u4f8b\u96c6\u7fa4 </li> <li>\u591a\u8282\u70b9\u96c6\u7fa4 </li> <li><code>http://localhost:9200/_cat/nodes?v</code></li> <li><code>http://localhost:9200/</code></li> </ul>"},{"location":"chap2/1ES_vm_install/#4elasticsearch","title":"4\u3001\u542f\u52a8Elasticsearch \u5b9e\u4f8b\u65f6\u9047\u5230\u7684\u95ee\u9898","text":""},{"location":"chap2/1ES_vm_install/#4-1-xmxxms","title":"4-1  Xmx\u548cXms\u8bbe\u7f6e\u6210\u4e00\u6837","text":"<pre><code>$ cd /etc/elasticsearch/\n$ sudo vim jvm.options\n\n# Xmx\u548cXms\u8bbe\u7f6e\u6210\u4e00\u6837\n...\n# Xms represents the initial size of total heap space\n# Xmx represents the maximum size of total heap space\n\n-Xms512m\n-Xmx512m\n...\n</code></pre>"},{"location":"chap2/1ES_vm_install/#4-2-file-descriptors-error","title":"4-2  File descriptors ERROR","text":"<pre><code>$ ERROR: [2] bootstrap checks failed\n[1]: max file descriptors [4096] for elasticsearch process is too low, increase to at least [65535]\n[2]: the default discovery settings are unsuitable for production use; at least one of [discovery.seed_hosts, discovery.seed_providers, cluster.initial_master_nodes] must be configured\nERROR: Elasticsearch did not exit normally - check the logs at /var/log/elasticsearch/jx.log\n</code></pre> <p>\u95ee\u9898\u7ffb\u8bd1\u8fc7\u6765\u5c31\u662f\uff1aelasticsearch\u7528\u6237\u62e5\u6709\u7684\u53ef\u521b\u5efa\u6587\u4ef6\u63cf\u8ff0\u7684\u6743\u9650\u592a\u4f4e\uff0c\u81f3\u5c11\u9700\u898165535\uff1b</p> <p>\u89e3\u51b3\uff1amax file descriptors [65535] for elasticsearch process is too low</p> <p>\u4f7f\u7528 <code>ulimit -Hn</code> \u67e5\u770b\u5f53\u524d\u503c\uff0c\u679c\u7136\u662f4096\uff0c</p> <p>\u89e3\u51b3\u529e\u6cd5\uff1a</p> <p>\u5207\u6362\u5230root\u7528\u6237\u4fee\u6539</p> <pre><code>sudo vim /etc/security/limits.conf\n\nvagrant soft nofile 65535\nvagrant hard nofile 65535\n</code></pre> <p>exit -&gt; \u91cd\u65b0\u767b\u5f55</p> <pre><code>$ ulimit -Hn\n65535\n</code></pre>"},{"location":"chap2/1ES_vm_install/#4-3-discoveryseed_hosts-must-be-configured","title":"4-3 [discovery.seed_hosts ..] must be configured","text":"<p>Problems with access to Elasticsearch form outside machine</p> <pre><code>sudo vim /etc/elasticsearch/elasticsearch.yml\n</code></pre> <pre><code># --------------------------------- Discovery ----------------------------------\n#\n# Pass an initial list of hosts to perform discovery when this node is started:\n# The default list of hosts is [\"127.0.0.1\", \"[::1]\"]\n#\n#discovery.seed_hosts: [\"host1\", \"host2\"]\ndiscovery.seed_hosts: [\"127.0.0.1\", \"[::1]\",\"192.168.33.12\"]\n</code></pre> <ul> <li>192.168.33.12: vm ip addr on vagrant</li> </ul>"},{"location":"chap2/1ES_vm_install/#4-4-curl9200","title":"4-4 \u542f\u52a8\u540e<code>curl</code>\u672c\u673a9200\u6ca1\u6709\u95ee\u9898\uff0c\u8fdc\u7a0b\u65e0\u6cd5\u6253\u5f00","text":"<pre><code>sudo vim /etc/elasticsearch/elasticsearch.yml\n</code></pre> <pre><code># ---------------------------------- Network -----------------------------------\n#\n# Set the bind address to a specific IP (IPv4 or IPv6):\n#\nnetwork.host: 0.0.0.0\n</code></pre>"},{"location":"chap2/2KB_vm_install/","title":"\u7b2c\u4e8c\u8282 Kibana\u7684\u5b89\u88c5\u4e0e\u754c\u9762\u5feb\u901f\u9884\u89c8","text":""},{"location":"chap2/2KB_vm_install/#1kibana","title":"1\u3001\u83b7\u53d6Kibana \u5b89\u88c5\u5305","text":"<ul> <li>\u4e0b\u8f7d\u4e8c\u8fdb\u5236\u6587\u4ef6\uff1a https://www.elastic.co/downloads/kibana </li> <li>Docker \u672c\u5730\u8fd0\u884c</li> <li>Helm Chart for Kubernetes</li> <li>Puppet Module</li> </ul> <pre><code>mdkir install &amp;&amp; cd install\nwget https://artifacts.elastic.co/downloads/kibana/kibana-7.9.1-linux-x86_64.tar.gz\ntar -xvf kibana-7.9.1-linux-x86_64.tar.gz\n\nsudo mkdir /usr/share/kibana\nsudo chown -R vagrant:vagrant kibana\ncp -R kibana-7.9.1-linux-x86_64/* /usr/share/kibana/\n</code></pre>"},{"location":"chap2/2KB_vm_install/#1-1-kibana","title":"1-1 \u8fd0\u884ckibana","text":"<pre><code>$ sudo vim /etc/profile.d/kb.sh\n\nKB_HOME=/usr/share/kibana\nPATH=$KB_HOME/bin:$PATH\nexport PATH KB_HOME\nexport CLASSPATH=.\n\n$ source /etc/profile.d/kb.sh\n</code></pre> <pre><code>$ kibana -h\n\n  Usage: bin/kibana [command=serve] [options]\n\n  Kibana is an open source (Apache Licensed), browser based analytics and search dashboard for Elasticsearch.\n\n  Commands:\n    serve  [options]  Run the kibana server\n    help  &lt;command&gt;   Get the help for a specific command\n\n  \"serve\" Options:\n\n    -e, --elasticsearch &lt;uri1,uri2&gt;  Elasticsearch instances\n    -c, --config &lt;path&gt;              Path to the config file, use multiple --config args to include multiple config files (default: [\"/usr/share/kibana/config/kibana.yml\"])\n    -p, --port &lt;port&gt;                The port to bind to\n    -q, --quiet                      Prevent all logging except errors\n    -Q, --silent                     Prevent all logging\n    --verbose                        Turns on verbose logging\n    -H, --host &lt;host&gt;                The host to bind to\n    -l, --log-file &lt;path&gt;            The file to log to\n    --plugin-dir &lt;path&gt;              A path to scan for plugins, this can be specified multiple times to specify multiple directories (default: [\"/usr/share/kibana/plugins\",\"/usr/share/kibana/src/legacy/core_plugins\"])\n    --plugin-path &lt;path&gt;             A path to a plugin which should be included by the server, this can be specified multiple times to specify multiple paths (default: [])\n    --plugins &lt;path&gt;                 an alias for --plugin-dir\n    --optimize                       Run the legacy plugin optimizer and then stop the server\n    -h, --help                       output usage information\n</code></pre> <pre><code>sudo vim /usr/share/kibana/config/kibana.yml\n\n...\n\n#server.host: \"localhost\"\nserver.host: \"0.0.0.0\"\n...\n</code></pre> <pre><code>kibana\n</code></pre> <p>\u540e\u53f0\u8fd0\u884c kibana</p> <pre><code>nohup kibana &amp;\n</code></pre> <pre><code>http://192.168.33.12:5601/\n</code></pre> <pre><code>$ ps -aux|grep kibana | grep -v grep | awk '{print $2}' # \u67e5\u770bes\n4034\n</code></pre> <pre><code>$ lsof -i:5601\nCOMMAND  PID    USER   FD   TYPE DEVICE SIZE/OFF NODE NAME\nnode    4034 vagrant   18u  IPv4  50509      0t0  TCP *:esmagent (LISTEN)\n</code></pre>"},{"location":"chap2/2KB_vm_install/#2sample","title":"2\u3001\u5bfc\u5165Sample \u6570\u636e","text":""},{"location":"chap2/2KB_vm_install/#2-1-dashboard","title":"2-1 \u67e5\u770bdashboard","text":""},{"location":"chap2/2KB_vm_install/#2-2-kibana-console","title":"2-2 Kibana Console","text":"<ul> <li>Dev Tool </li> <li>Search Profiler </li> <li>Help + \u4e00\u4e9b\u5feb\u6377\u952e<ul> <li>cmd+ / (\u67e5\u770bAPI\u5e2e\u52a9\u6587\u6863\uff09</li> <li>cmd+option+1</li> <li>cmd+option+0 </li> <li>cmd+option+shift+0</li> </ul> </li> </ul>"},{"location":"chap2/2KB_vm_install/#3kibana-plugins","title":"3\u3001kibana Plugins","text":"<p>https://www.elastic.co/guide/en/kibana/current/known-plugins.html</p> <p></p> <pre><code>kibana-plugin install /usr/plugin_location \nkibana-plugin list \nkibana remove \n</code></pre> <p>Demo</p> <ul> <li>\u8fd0\u884cKibana </li> <li>\u5c1d\u8bd5\u5bfc\u5165Sample\u6570\u636e\uff0c\u67e5\u770b\u56fe\u5f62\u5316\u5de5\u5177\uff0bDashboard </li> <li>Kibana Console\u5f00\u53d1\u5229\u5668    <ul> <li>\u5feb\u6377\u952e\uff0fElasticsearch REST API/Search Profiler/Grok/Debugger </li> </ul> </li> </ul> <p>https://blog.csdn.net/Bobdragery/article/details/106842984</p>"},{"location":"chap2/3ES_KB_docker/","title":"\u7b2c\u4e09\u8282 \u5728Docker\u5bb9\u5668\u4e2d\u8fd0\u884cElasticsearch Kibana\u548cCerebro","text":""},{"location":"chap2/3ES_KB_docker/#1elastic-stack-docker","title":"1\u3001Elastic Stack \u4e0e Docker\u5bb9\u5668","text":"<ul> <li>Elastic\u5b98\u65b9\u63d0\u4f9bDocker Image </li> <li>\u5982\u9700\u5b89\u88c5\u5b9a\u5236\u7684\u63d2\u4ef6\uff0c\u53ef\u4ee5\u5199Dockerfile\uff0c\u5c06\u5b98\u65b9Image\u8bbe\u4e3aBaseImage </li> <li>2018\u5e7412\u6708\u52a0\u5165CNCF\uff0c\u63d0\u4f9bhelm <ul> <li>https://github.com/helm/charts/tree/master/stable/elastic-stack </li> </ul> </li> <li>2019\u5e745\u67087.1\u7248\u672c\u53d1\u5e03\u65f6 <ul> <li>\u540c\u65f6\u53d1\u5e03ECK\u514d\u8d39\u63d0\u4f9bElastic Operator on Kubernetes </li> </ul> </li> </ul>"},{"location":"chap2/3ES_KB_docker/#2dockerelk-stackcentos-7","title":"2\u3001\u5b66\u4e60\u5728\u672c\u673aDocker\u73af\u5883\u4e2d\u8fd0\u884cELK Stack(Centos 7)","text":"<ul> <li>https://docs.docker.com/engine/install/centos/</li> <li>https://docs.docker.com/engine/install/linux-postinstall/</li> <li>https://docs.docker.com/compose/install/</li> </ul> <pre><code>$ docker version\nClient: Docker Engine - Community\n Version:           19.03.13\n API version:       1.40\n Go version:        go1.13.15\n Git commit:        4484c46d9d\n Built:             Wed Sep 16 17:03:45 2020\n OS/Arch:           linux/amd64\n Experimental:      false\n ...\n</code></pre> <pre><code>$ docker-compose --version\ndocker-compose version 1.27.3, build 4092ae5d\n</code></pre>"},{"location":"chap2/3ES_KB_docker/#3demodocker-eck-cerebro","title":"3\u3001Demo[Docker ECK + Cerebro]","text":"<ul> <li>\u8fd0\u884c<code>Docker-compose</code>\uff0c\u672c\u5730\u6784\u5efa\u66f4\u9ad8\u6548\u7684\u5f00\u53d1\u574f\u5883\u66f4\u76f4\u89c2\u5730\u4e86\u89e3Easticsesrch\u5206\u5e03\u5f0f\u7279\u80dc </li> <li>\u96c6\u6210Cerebro,\u65b9\u4fbf\u67e5\u770b\u96c6\u7fa4\u72b6\u6001 </li> </ul>"},{"location":"chap2/3ES_KB_docker/#3-1-elasticsearch-node-kibana-cerebro","title":"3-1 \u5355 ElasticSearch Node + Kibana + Cerebro","text":"<p>docker-compose.yml</p> <pre><code>version: '2.2'\nservices:\n  cerebro:\n    image: lmenezes/cerebro:0.8.3\n    container_name: cerebro\n    ports:\n      - \"9000:9000\"\n    command:\n      - -Dhosts.0.host=http://192.168.33.12:9200\n    networks:\n      - es79net\n  kibana:\n    image: docker.elastic.co/kibana/kibana:7.9.1\n    container_name: kibana79\n    environment:\n      - I18N_LOCALE=zh-CN\n      - XPACK_GRAPH_ENABLED=true\n      - TIMELION_ENABLED=true\n      - XPACK_MONITORING_COLLECTION_ENABLED=\"true\"\n    ports:\n      - \"5601:5601\"\n    networks:\n      - es79net\n  elasticsearch:\n    image: docker.elastic.co/elasticsearch/elasticsearch:7.9.1\n    container_name: es79\n    environment:\n      - cluster.name=jx\n      - node.name=es79\n      - bootstrap.memory_lock=true\n      - \"ES_JAVA_OPTS=-Xms512m -Xmx512m\"\n      - discovery.seed_hosts=es79\n      - cluster.initial_master_nodes=es79\n    ulimits:\n      memlock:\n        soft: -1\n        hard: -1\n    volumes:\n      - es79data1:/usr/share/elasticsearch/data\n    ports:\n      - 9200:9200\n    networks:\n      - es79net\n\n\nvolumes:\n  es79data1:\n    driver: local\n\nnetworks:\n  es79net:\n    driver: bridge\n</code></pre> <ul> <li>cerebro : <code>-Dhosts.0.host=http://192.168.33.12:9200</code></li> <li>elasticsearch: <code>cluster.name=jx</code></li> </ul> <pre><code>$ docker-compose up -d\nCreating network \"docker_es79net\" with driver \"bridge\"\nCreating es79   ... done\nCreating kibana79 ... done\nCreating cerebro  ... done\n</code></pre> <pre><code>#\u542f\u52a8\ndocker-compose up\n\n#\u505c\u6b62\u5bb9\u5668\ndocker-compose down\n\n#\u505c\u6b62\u5bb9\u5668\u5e76\u4e14\u79fb\u9664\u6570\u636e\ndocker-compose down -v\n\n#\u4e00\u4e9bdocker \u547d\u4ee4\ndocker ps\ndocker stop Name/ContainerId\ndocker start Name/ContainerId\n\n#\u5220\u9664\u5355\u4e2a\u5bb9\u5668\n$docker rm Name/ID\n-f, \u2013force=false; -l, \u2013link=false Remove the specified link and not the underlying container; -v, \u2013volumes=false Remove the volumes associated to the container\n\n#\u5220\u9664\u6240\u6709\u5bb9\u5668\n$docker rm `docker ps -a -q`  \n\u505c\u6b62\u3001\u542f\u52a8\u3001\u6740\u6b7b\u3001\u91cd\u542f\u4e00\u4e2a\u5bb9\u5668\n$docker stop Name/ID  \n$docker start Name/ID  \n$docker kill Name/ID  \n$docker restart name/ID\n</code></pre> <p>http://192.168.33.12:9200/_cat/health?v</p> <p></p> <p>http://192.168.33.12:9000</p> <p></p> <p></p>"},{"location":"chap2/3ES_KB_docker/#3-2-multiple-elasticsearch-nodes","title":"3-2 Multiple ElasticSearch Nodes","text":"<p>docker-compose.yml</p> <pre><code>version: '2.2'\nservices:\n  cerebro:\n    image: lmenezes/cerebro:0.8.3\n    container_name: cerebro\n    ports:\n      - \"9000:9000\"\n    command:\n      - -Dhosts.0.host=http://192.168.33.12:9200\n    networks:\n      - es79net\n  kibana:\n    image: docker.elastic.co/kibana/kibana:7.9.1\n    container_name: kibana79\n    environment:\n      - I18N_LOCALE=zh-CN\n      - XPACK_GRAPH_ENABLED=true\n      - TIMELION_ENABLED=true\n      - XPACK_MONITORING_COLLECTION_ENABLED=\"true\"\n    ports:\n      - \"5601:5601\"\n    networks:\n      - es79net\n  elasticsearch:\n    image: docker.elastic.co/elasticsearch/elasticsearch:7.9.1\n    container_name: es7_01\n    environment:\n      - cluster.name=jx\n      - node.name=es7_01\n      - bootstrap.memory_lock=true\n      - \"ES_JAVA_OPTS=-Xms256m -Xmx256m\"\n      - discovery.seed_hosts=es7_01,es7_02\n      - cluster.initial_master_nodes=es7_01,es7_02\n    ulimits:\n      memlock:\n        soft: -1\n        hard: -1\n    volumes:\n      - es79data1:/usr/share/elasticsearch/data\n    ports:\n      - 9200:9200\n    networks:\n      - es79net\n  elasticsearch2:\n    image: docker.elastic.co/elasticsearch/elasticsearch:7.9.1\n    container_name: es7_02\n    environment:\n      - cluster.name=jx\n      - node.name=es7_02\n      - bootstrap.memory_lock=true\n      - \"ES_JAVA_OPTS=-Xms256m -Xmx256m\"\n      - discovery.seed_hosts=es7_01,es7_02\n      - cluster.initial_master_nodes=es7_01,es7_02\n    ulimits:\n      memlock:\n        soft: -1\n        hard: -1\n    volumes:\n      - es79data2:/usr/share/elasticsearch/data\n    networks:\n      - es79net\n\n\nvolumes:\n  es79data1:\n    driver: local\n  es79data2:\n    driver: local\n\nnetworks:\n  es79net:\n    driver: bridge\n</code></pre> <pre><code>$ docker-compose up -d\nCreating network \"docker_es79net\" with driver \"bridge\"\nCreating es7_01   ... done\nCreating es7_02   ... done\nCreating kibana79 ... done\nCreating cerebro  ... done\n</code></pre> <p>http://192.168.33.12:9200/_cat/nodes?v</p> <p></p> <p>http://192.168.33.12:9200/_cat/health?v</p> <p></p> <p></p> <p></p>"},{"location":"chap2/4LogStash_vm_install/","title":"\u7b2c\u56db\u8282 Logstash\u5b89\u88c5\u4e0e\u5bfc\u5165\u6570\u636e","text":""},{"location":"chap2/4LogStash_vm_install/#1logstash","title":"1\u3001\u83b7\u53d6Logstash\u5b89\u88c5\u5305","text":"<ul> <li>\u4e8c\u8fdb\u5236\u6587\u4ef6\u8fd0\u884c</li> <li>Docker\u672c\u5730\u8fd0\u884c</li> </ul> <p>https://www.elastic.co/downloads/kibana</p> <p></p> <pre><code>$ wget https://artifacts.elastic.co/downloads/logstash/logstash-7.9.1.tar.gz\n$ tar -xvf logstash-7.9.1.tar.gz\n\n\n$ sudo mkdir /usr/share/logstash\n$ sudo chown -R vagrant:vagrant /usr/share/logstash\n$ cp -R logstash-7.9.1/* /usr/share/logstash\n</code></pre> <pre><code>sudo vim /etc/profile.d/logstash.sh\nLS_HOME=/usr/share/logstash\nPATH=$LS_HOME/bin:$PATH\nexport JAVA_HOME=/usr/share/elasticsearch/jdk\nexport PATH LS_HOME\nexport CLASSPATH=.\n</code></pre> <ul> <li><code>export JAVA_HOME=/usr/share/elasticsearch/jdk</code> Logstash \u9700\u8981\u542f\u52a8 JVM\uff0c\u6240\u4ee5\u9700\u5bfc\u51fa<code>JAVA_HOME</code></li> </ul> <pre><code>source /etc/profile.d/logstash.sh\n</code></pre> <pre><code>$ logstash -h\nOpenJDK 64-Bit Server VM warning: Ignoring option UseConcMarkSweepGC; support was removed in 14.0\nOpenJDK 64-Bit Server VM warning: Ignoring option CMSInitiatingOccupancyFraction; support was removed in 14.0\nOpenJDK 64-Bit Server VM warning: Ignoring option UseCMSInitiatingOccupancyOnly; support was removed in 14.0\nUsage:\n    bin/logstash [OPTIONS]\n\nOptions:\n    -n, --node.name NAME          Specify the name of this logstash instance, if no value is given\n                                  it will default to the current hostname.\n                                   (default: \"elasticsearch7\")\n    -f, --path.config CONFIG_PATH Load the logstash config from a specific file\n                                  or directory.  If a directory is given, all\n                                  files in that directory will be concatenated\n                                  in lexicographical order and then parsed as a\n                                  single config file. You can also specify\n                                  wildcards (globs) and any matched files will\n...\n</code></pre>"},{"location":"chap2/4LogStash_vm_install/#2movielens-demo","title":"2\u3001Movielens \u6d4b\u8bd5\u6570\u636e Demo","text":"<ul> <li>\u4e0b\u8f7d<code>MovieLen</code>\u6570\u636e </li> <li>\u7528<code>Logstash</code>\u5bfc\u5165<code>Elasticsearch</code></li> </ul>"},{"location":"chap2/4LogStash_vm_install/#2-1-movielens","title":"2-1 Movielens \u6d4b\u8bd5\u6570\u636e\u96c6","text":"<p>\u4e0b\u8f7d\u6700 MovieLens \u6700\u5c0f\u6d4b\u8bd5\u6570\u636e\u96c6\uff1a https://grouplens.org/datasets/movielens/</p> <p></p> <p>movies.csv</p>"},{"location":"chap2/4LogStash_vm_install/#2-2-logstashconf","title":"2-2 \u6839\u636e<code>logstash.conf</code>\u8fd0\u884c\u5e76\u5bfc\u5165\u6d4b\u8bd5\u6570\u636e","text":"<p>logstash.conf</p> <pre><code>input {\n  file {\n    path =&gt; \"/home/vagrant/logstash/movielens/ml-latest-small/movies.csv\"\n    start_position =&gt; \"beginning\"\n    sincedb_path =&gt; \"/dev/null\"\n  }\n}\nfilter {\n  csv {\n    separator =&gt; \",\"\n    columns =&gt; [\"id\",\"content\",\"genre\"]\n  }\n\n  mutate {\n    split =&gt; { \"genre\" =&gt; \"|\" }\n    remove_field =&gt; [\"path\", \"host\",\"@timestamp\",\"message\"]\n  }\n\n  mutate {\n\n    split =&gt; [\"content\", \"(\"]\n    add_field =&gt; { \"title\" =&gt; \"%{[content][0]}\"}\n    add_field =&gt; { \"year\" =&gt; \"%{[content][1]}\"}\n  }\n\n  mutate {\n    convert =&gt; {\n      \"year\" =&gt; \"integer\"\n    }\n    strip =&gt; [\"title\"]\n    remove_field =&gt; [\"path\", \"host\",\"@timestamp\",\"message\",\"content\"]\n  }\n\n}\noutput {\n   elasticsearch {\n     hosts =&gt; \"http://localhost:9200\"\n     index =&gt; \"movies\"\n     document_id =&gt; \"%{id}\"\n   }\n  stdout {}\n</code></pre> <ul> <li><code>path =&gt; \"/home/vagrant/logstash/movielens/ml-latest-small/movies.csv\"</code></li> </ul> <pre><code>$ tree .\n.\n\u251c\u2500\u2500 logstash.conf\n\u2514\u2500\u2500 ml-latest-small\n    \u2514\u2500\u2500 movies.csv\n\n1 directory, 2 files\n</code></pre> <pre><code>$  logstash -f /home/vagrant/logstash/movielens/logstash.conf\n</code></pre> <p></p>"},{"location":"chap2/4LogStash_vm_install/#2-3-logstash-es","title":"2-3 \u67e5\u770b logstash \u7684\u6570\u636e\u662f\u5426\u5bfc\u5165 ES","text":"<pre><code>http://192.168.33.12:9200/_cat/indices?v\n</code></pre> <p>cerebro: CAT APIs</p> <p></p>"},{"location":"chap3/1ES_intro/","title":"\u7b2c\u4e00\u8282 ElasticSearch \u57fa\u672c\u6982\u5ff5","text":""},{"location":"chap3/1ES_intro/#1rest-api","title":"1\u3001\u7d22\u5f15\u3001\u6587\u6863\u548cREST API","text":""},{"location":"chap3/1ES_intro/#1-1-elasticsearch","title":"1-1 Elasticsearch\u57fa\u672c\u6982\u5ff5","text":"<ul> <li>Index \u7d22\u5f15<ul> <li>Type\u7c7b\u578b </li> <li>Document\u6587\u6863 </li> </ul> </li> <li>Node \u8282\u70b9<ul> <li>Shard\u5206\u7247 </li> </ul> </li> </ul>"},{"location":"chap3/1ES_intro/#1-2-document","title":"1-2 \u6587\u6863\uff08Document)","text":"<ul> <li> <p>Elasticsearch\u662f\u9762\u5411\u6587\u6863\u7684\uff0c\u6587\u6863\u662f\u6240\u6709\u53ef\u641c\u7d22\u6570\u636e\u7684\u6700\u5c0f\u5355\u4f4d \u3002</p> <ul> <li>\u65e5\u5fd7\u6587\u4ef6\u4e2d\u7684\u65e5\u5fd7\u9879 \u3002</li> <li>\u4e00\u90e8\u7535\u5f71\u7684\u5177\u4f53\u4fe1\u606f\uff0f\u4e00\u5f20\u5531\u7247\u7684\u8be6\u7ec6\u4fe1\u606f \u3002</li> <li>MP3\u64ad\u653e\u5668\u91cc\u7684\u4e00\u9996\u6b4c\uff0f\u4e00\u7bc7PDF\u6587\u6863\u4e2d\u7684\u5177\u4f53\u5185\u5bb9 </li> </ul> </li> <li> <p>\u6587\u6863\u4f1a\u88ab\u5e8f\u5217\u5316\u6210JSON\u683c\u5f0f\uff0c\u4fdd\u5b58\u5728Elasticsearch\u4e2d </p> <ul> <li>JSON\u5bf9\u8c61\u7531\u5b57\u6bb5\u7ec4\u6210\uff0c</li> <li>\u6bcf\u4e2a\u5b57\u6bb5\u90fd\u6709\u5bf9\u5e94\u7684\u5b57\u6bb5\u7c7b\u578b\uff08\u5b57\u7b26\u4e32\uff0f\u6570\u503c\uff0f\u5e03\u5c14\uff0f\u65e5\u671f\uff0f\u4e8c\u8fdb\u5236\uff0f\u8303\u56f4\u7c7b\u578b\uff09 </li> </ul> </li> <li>\u6bcf\u4e2a\u6587\u6863\u90fd\u6709\u4e00\u4e2aUnique ID <ul> <li>\u4f60\u53ef\u4ee5\u81ea\u5df1\u6307\u5b9aID</li> <li>\u6216\u8005\u901a\u8fc7Elasticsearch\u81ea\u52a8\u751f\u6210 </li> </ul> </li> </ul>"},{"location":"chap3/1ES_intro/#1-3-json","title":"1-3 JSON\u6587\u6863","text":"<ul> <li>\u4e00\u7bc7\u6587\u6863\u5305\u542b\u4e86\u4e00\u7cfb\u5217\u7684\u5b57\u6bb5\u3002\u7c7b\u4f3c\u6570\u636e\u5e93\u8868\u4e2d\u4e00\u6761\u8bb0\u5f55 </li> <li>JSON\u6587\u6863\uff0c\u683c\u5f0f\u7075\u6d3b\uff0c\u4e0d\u9700\u8981\u9884\u5148\u5b9a\u4e49\u683c\u5f0f <ul> <li>\u5b57\u6bb5\u7684\u7c7b\u578b\u53ef\u4ee5\u6307\u5b9a\u6216\u8005\u901a\u8fc7Elasticsearch\u81ea\u52a8\u63a8\u7b97 </li> <li>\u652f\u6301\u6570\u7ec4\uff0f\u652f\u6301\u5d4c\u5957</li> </ul> </li> </ul> <pre><code>movieId,title,genres\n1,Toy Story (1995),Adventure|Animation|Children|Comedy|Fantasy\n</code></pre>"},{"location":"chap3/1ES_intro/#1-4","title":"1-4 \u6587\u6863\u7684\u5143\u6570\u636e","text":"<p>\u5143\u6570\u636e\uff0c\u7528\u4e8e\u6807\u6ce8\u6587\u6863\u7684\u76f8\u5173\u4fe1\u606f </p> <ul> <li><code>_index</code> \u2014\u2014 \u6587\u6863\u6240\u5c5e\u7684\u7d22\u5f15\u540d </li> <li><code>_type</code> \u2014\u2014 \u6587\u6863\u6240\u5c5e\u7684\u7c7b\u578b\u540d </li> <li><code>_Id</code> \u2014\u2014  \u6587\u6863\u552f\u4e00<code>Id</code> </li> <li><code>_source</code>:\u6587\u6863\u7684\u539f\u59cb<code>JSON</code>\u6570\u636e </li> <li><code>_all</code>\uff1a\u6574\u5408\u6240\u6709\u5b57\u6bb5\u5185\u5bb9\u5230\u8be5\u5b57\u6bb5\uff0c6.0\u5df2\u88ab\u5e9f\u9664 </li> <li><code>_version</code>\uff1a\u6587\u6863\u7684\u7248\u672c\u4fe1\u606f </li> <li><code>_score</code>\uff1a\u76f8\u5173\u6027\u6253\u5206 </li> <li><code>_seq_no</code> : \u6587\u6863\u7248\u672c\u53f7\uff0c\u4f5c\u7528\u540c<code>_version</code>\uff08\u76f8\u5f53\u4e8e\u5b66\u751f\u7f16\u53f7\uff0c\u6bcf\u4e2a\u73ed\u7ea7\u7684\u73ed\u4e3b\u4efb\u4e3a\u5b66\u751f\u5206\u914d\u7f16\u53f7\uff0c\u6548\u7387\u8981\u6bd4\u5b66\u6821\u6559\u52a1\u5904\u5206\u914d\u6765\u7684\u66f4\u52a0\u9ad8\u6548\uff0c\u7ba1\u7406\u8d77\u6765\u66f4\u65b9\u4fbf\uff09</li> <li><code>_primary_term</code>\uff1a\u6587\u6863\u6240\u5728\u4f4d\u7f6e\uff08\u76f8\u5f53\u4e8e\u73ed\u7ea7\uff09</li> </ul> <p>ElasticSearch \u6839\u636e<code>_seq_no</code>\u5e76\u53d1\u63a7\u5236</p> <pre><code>GET movies/_doc/1\n</code></pre> <p></p>"},{"location":"chap3/1ES_intro/#1-5","title":"1-5 \u7d22\u5f15","text":"<p>Index\u4e00\u7d22\u5f15\u662f\u6587\u6863\u7684\u5bb9\u5668\uff0c\u662f\u4e00\u7c7b\u6587\u6863\u7684\u7ed3\u5408 </p> <ul> <li>Index\u4f53\u73b0\u4e86\u903b\u8f91\u7a7a\u95f4\u7684\u6982\u5ff5\uff1a\u6bcf\u4e2a\u7d22\u5f15\u90fd\u6709\u81ea\u5df1\u7684Mapping\u5b9a\u4e49\uff0c\u7528\u4e8e\u5b9a\u4e49\u5305\u542b\u7684\u6587\u6863\u7684\u5b57\u6bb5\u540d\u548c\u5b57\u6bb5\u7c7b\u578b </li> <li>Shard\u4f53\u73b0\u4e86\u7269\u7406\u7a7a\u95f4\u7684\u6982\u5ff5\uff1a\u7d22\u5f15\u4e2d\u7684\u6570\u636e\u5206\u6563\u5728Shard\u4e0a </li> </ul> <p>\u7d22\u5f15\u7684Mapping\u4e0eSettings</p> <ul> <li>Mapping\u5b9a\u4e49\u6587\u6863\u5b57\u6bb5\u7684\u7c7b\u578b </li> <li>Setting\u5b9a\u4e49\u4e0d\u540c\u7684\u6570\u636e\u5206\u5e03 </li> </ul> <pre><code>GET movies/_settings\n</code></pre> <p></p> <pre><code>GET movies/_mapping\n</code></pre> <p></p> <p>\u7d22\u5f15\u7684\u4e0d\u540c\u8bed\u4e49</p> <ul> <li>\u540d\u8bcd\uff1a\u4e00\u4e2aElasticsearch\u96c6\u7fa4\u4e2d\uff0c\u53ef\u4ee5\u521b\u5efa\u5f88\u591a\u4e2a\u4e0d\u540c\u7684\u7d22\u5f15 </li> <li>\u52a8\u8bcd\uff1a\u4fdd\u5b58\u4e00\u4e2a\u6587\u6863\u5230Elasticsearch\u7684\u8fc7\u7a0b\u4e5f\u53eb\u7d22\u5f15\uff08indexing\uff09 <ul> <li>ES\u4e2d\uff0c\u521b\u5efa\u4e00\u4e2a\u5012\u6392\u7d22\u5f15\u7684\u8fc7\u7a0b </li> </ul> </li> <li>\u540d\u8bcd\uff1a\u4e00\u4e2aB\u6811\u7d22\u5f15\uff0c\u4e00\u4e2a\u5012\u6392\u7d22\u5f15 </li> </ul> <p></p>"},{"location":"chap3/1ES_intro/#1-5-type","title":"1-5 Type","text":"<ul> <li>\u57287.0\u4e4b\u524d\uff0c\u4e00\u4e2aIndex\u53ef\u4ee5\u8bbe\u7f6e\u591a\u4e2a Types </li> <li>6.0\u5f00\u59cb\uff0cTypes\u5df2\u7ecf\u88abDeprecated\u3002 7.0\u5f00\u59cb\uff0c \u4e00\u4e2a\u7d22\u5f15\u53ea\u80fd\u521b\u5efa\u4e00\u4e2aType \u2014\u2014<code>\"_doc\"</code></li> </ul>"},{"location":"chap3/1ES_intro/#1-6","title":"1-6 \u62bd\u8c61\u4e0e\u7c7b\u6bd4","text":"<ul> <li>\u57287.0\u4e4b\u524d\uff0c\u4e00\u4e2aIndex\u53ef\u4ee5\u8bbe\u7f6e\u591a\u4e2a Types </li> <li>6.0\u5f00\u59cb\uff0cTypes\u5df2\u7ecf\u88abDeprecated\u3002 7.0\u5f00\u59cb\uff0c \u4e00\u4e2a\u7d22\u5f15\u53ea\u80fd\u521b\u5efa\u4e00\u4e2aType \u2014\u2014<code>\"_doc\"</code></li> <li>\u4f20\u7edf\u5173\u7cfb\u578b\u6570\u636e\u5e93\u548cElasticsearch\u7684\u533a\u522b <ul> <li>Elasticsearch - Schemaless\uff0f\u76f8\u5173\u6027\uff0f\u9ad8\u6027\u80fd\u5168\u6587\u68c0\u7d22 </li> <li>RDMS\u4e00\u4e8b\u52a1\u6027\uff0fJoin </li> </ul> </li> </ul>"},{"location":"chap3/1ES_intro/#1-7-es-rest-api","title":"1-7 ES Rest API","text":"<p>\u4e00\u4e9b\u57fa\u672c\u7684API</p> <ul> <li>Indices <ul> <li>\u521b\u5efaindex <ul> <li><code>PUT Movies</code> </li> </ul> </li> </ul> </li> <li>\u67e5\u770b\u6240\u6709Index <ul> <li><code>_cat/indices</code> </li> </ul> </li> </ul> <pre><code>http://192.168.33.12:9200/_cat/indices?v\n\nhealth status index                          uuid                   pri rep docs.count docs.deleted store.size pri.store.size\ngreen  open   movies                         20OQOjCjQnes7_8KaRQ-cQ   1   1       9744            0      2.5mb          1.2mb\ngreen  open   .apm-custom-link               PG6aV6PHSiuu20nHyL34cA   1   1          0            0       416b           208b\ngreen  open   kibana_sample_data_ecommerce   ePmp_2DuRM2mG5DjzjVjAA   1   1       4675            0      8.6mb          4.2mb\ngreen  open   .kibana_task_manager_1         0yGSkLnGTRqsUEhmjxRbbQ   1   1          6         2472    885.3kb        447.3kb\ngreen  open   .kibana-event-log-7.9.1-000001 pjjQKzxCQQ20JAj7VIeneA   1   1          4            0     43.2kb         21.6kb\ngreen  open   .apm-agent-configuration       5NgEYxbLRomit_d0J06BwA   1   1          0            0       416b           208b\ngreen  open   kibana_sample_data_logs        bvpwbU64RhiOcuhkYBKahA   1   1      14074            0     18.4mb          9.2mb\ngreen  open   .kibana_1                      52ji4WVfQIOUkj77Gy3d6w   1   1        333            0     22.9mb         11.4mb\ngreen  open   kibana_sample_data_flights     23Vm4RG8Rlu8uikrNJkzlg   1   1      13059            0     11.8mb          5.9mb\n</code></pre>"},{"location":"chap3/1ES_intro/#1-8-demo","title":"1-8 Demo","text":"<ul> <li>\u67e5\u770b\u4e00\u4e9b\u4e0eindex\u7684\u76f8\u5173API </li> <li>\u8fdb\u5165Kinbana Index Management\u754c\u9762\uff0c\u63a2\u7d22Index\u76f8\u5173\u7684\u4fe1\u606f </li> </ul> <p>Setting</p> <p></p> <p>Mapping</p> <p></p> <ul> <li>\u4e3a\u4ec0\u4e48\u4e0d\u518d\u652f\u6301\u5355\u4e2aIndex\u4e0b\uff0c\u591a\u4e2aTyps https://www.elastic.co/cn/blog/moving-from-types-to-typeless-apis-in-elasticsearch-7-0</li> <li>CAT Index API https://www.elastic.co/guide/en/elasticsearch/reference/7.1/cat-indices.html</li> </ul> <pre><code>#\u67e5\u770b\u7d22\u5f15\u76f8\u5173\u4fe1\u606f\nGET kibana_sample_data_ecommerce\n\n#\u67e5\u770b\u7d22\u5f15\u7684\u6587\u6863\u603b\u6570\nGET kibana_sample_data_ecommerce/_count\n\n#\u67e5\u770b\u524d10\u6761\u6587\u6863\uff0c\u4e86\u89e3\u6587\u6863\u683c\u5f0f\nPOST kibana_sample_data_ecommerce/_search\n{\n}\n\n#_cat indices API\n#\u67e5\u770bindices\nGET /_cat/indices/kibana*?v&amp;s=index\n\n#\u67e5\u770b\u72b6\u6001\u4e3a\u7eff\u7684\u7d22\u5f15\nGET /_cat/indices?v&amp;health=green\n\n#\u6309\u7167\u6587\u6863\u4e2a\u6570\u6392\u5e8f\nGET /_cat/indices?v&amp;s=docs.count:desc\n\n#\u67e5\u770b\u5177\u4f53\u7684\u5b57\u6bb5\nGET /_cat/indices/kibana*?pri&amp;v&amp;h=health,index,pri,rep,docs.count,mt\n\n#How much memory is used per index?\nGET /_cat/indices?v&amp;h=i,tm&amp;s=tm:desc\n</code></pre> <p></p>"},{"location":"chap3/1ES_intro/#2","title":"2\u3001\u96c6\u7fa4\uff0f\u8282\u70b9\uff0f\u5206\u7247\uff0f\u526f\u672c","text":""},{"location":"chap3/1ES_intro/#2-1","title":"2-1 \u5206\u5e03\u5f0f\u7cfb\u7edf\u7684\u53ef\u7528\u6027\u4e0e\u6269\u5c55\u6027","text":"<p>\u9ad8\u53ef\u7528\u6027</p> <ul> <li>\u670d\u52a1\u53ef\u7528\u6027\u4e00\u5141\u8bb8\u6709\u8282\u70b9\u505c\u6b62\u670d\u52a1 </li> <li>\u6570\u636e\u53ef\u7528\u6027\u4e00\u90e8\u5206\u8282\u70b9\u4e22\u5931\u4e0d\u4f1a\u4e22\u5931\u6570\u636e </li> </ul> <p>\u53ef\u6269\u5c55\u6027</p> <ul> <li>\u8bf7\u6c42\u91cf\u63d0\u5347\uff0f\u6570\u636e\u7684\u4e0d\u65ad\u589e\u957f\uff08\u5c06\u6570\u636e\u5206\u5e03\u5230\u6240\u6709\u8282\u70b9\u4e0a) </li> </ul>"},{"location":"chap3/1ES_intro/#2-2","title":"2-2 \u5206\u5e03\u5f0f\u7279\u6027","text":"<ul> <li> <p>Elasticsearch\u7684\u5206\u5e03\u5f0f\u67b6\u6784\u7684\u597d\u5904 </p> <ul> <li>\u5b58\u50a8\u7684\u6c34\u5e73\u6269\u5bb9 </li> <li>\u63d0\u9ad8\u7cfb\u7edf\u7684\u53ef\u7528\u6027\u90e8\u5206\u8282\u70b9\u505c\u6b62\u670d\u52a1\u6574\u4e2a\u96c6\u7fa4\u7684\u670d\u52a1\u4e0d\u53d7\u5f71\u54cd </li> </ul> </li> <li> <p>Elasticsearch\u7684\u5206\u5e03\u5f0f\u67b6\u6784 </p> <ul> <li>\u4e0d\u540c\u7684\u96c6\u7fa4\u901a\u8fc7\u4e0d\u540c\u7684\u540d\u5b57\u6765\u533a\u5206\u9ed8\u8ba4\u540d\u5b57\"elasticsearch\" </li> <li>\u901a\u8fc7\u914d\u7f6e\u6587\u4ef6\u4fee\u6539\u6216\u8005\u5728\u547d\u4ee4\u884c\u4e2d<code>-E cluster.neme=jx</code>\u8fdb\u884c\u8bbe\u5b9a </li> <li>\u4e00\u4e2a\u96c6\u7fa4\u53ef\u4ee5\u6709\u4e00\u4e2a\u6216\u8005\u591a\u4e2a\u8282\u70b9 </li> </ul> </li> </ul>"},{"location":"chap3/1ES_intro/#2-3","title":"2-3 \u8282\u70b9","text":"<ul> <li>\u8282\u70b9\u662f\u4e00\u4e2aElasticsearch\u7684\u5b9e\u4f8b <ul> <li>\u672c\u8d28\u4e0a\u5c31\u662f\u4e00\u4e2aJAVA\u8fdb\u7a0b </li> <li>\u4e00\u53f0\u673a\u5668\u4e0a\u53ef\u4ee5\u8fd0\u884c\u591a\u4e2a\u8fdb\u7a0b\uff0c\u4f46\u662f\u751f\u4ea7\u73af\u5883\u4e00\u822c\u5efa\u8bae\u4e00\u53f0\u673a\u5668\u4e0a\u53ea\u8fd0\u884c\u4e00\u4e2aElasticsearch\u5b9e\u4f8b </li> </ul> </li> <li>\u6bcf\u4e00\u4e2a\u8282\u70b9\u90fd\u6709\u540d\u5b57\uff0c\u6bcf\u4e00\u4e2a\u8282\u70b9\u5728\u542f\u52a8\u4e4b\u540e\u901a\u8fc7\u914d\u7f6e\u6587\u4ef6\u914d\u7f6e\u6210\u8005\u542f\u52a8\u65f6\u5019<code>-E node.name=node1</code>\u6307\u5b9a </li> <li>\u4f1a\u5206\u914d\u4e00\u4e2a<code>UID</code>\u4fdd\u5b58\u5728data\u76ee\u5f55\u4e0b </li> </ul>"},{"location":"chap3/1ES_intro/#2-4-master-eligible-nodesmaster-node","title":"2-4 Master-eligible nodes\u548cMaster Node","text":"<ul> <li>\u6bcf\u4e2a\u8282\u70b9\u542f\u52a8\u540e\u9ed8\u8ba4\u5c31\u662f\u4e00\u4e2aMaster eligible\u8282\u70b9<ul> <li>\u53ef\u4ee5\u8bbe\u7f6e<code>node.master=false</code>\u7981\u6b62 </li> </ul> </li> <li><code>Master-eligible</code>\u8282\u70b9\u53ef\u4ee5\u53c2\u52a0\u9009\u4e3b\u6d41\u7a0b\u6210\u4e3a<code>Master</code>\u8282\u70b9 </li> <li>\u5f53\u7b2c\u4e00\u4e2a\u8282\u70b9\u542f\u52a8\u65f6\u5019\u5b83\u4f1a\u5c06\u81ea\u5df1\u9009\u4e3e\u6210Master\u8282\u70b9 </li> <li>\u6bcf\u4e2a\u8282\u70b9\u4e0a\u90fd\u4fdd\u5b58\u4e86\u96c6\u7fa4\u7684\u72b6\u6001\u53ea\u6709Master\u8282\u70b9\u624d\u80fd\u4fee\u6539\u96c6\u7fa4\u7684\u72b6\u6001\u4fe1\u606f \u3002<ul> <li>\u96c6\u7fa4\u72b6\u6001(Cluster State)\u7ef4\u62a4\u4e86\u4e00\u4e2a\u96c6\u7fa4\u4e2d\u5fc5\u8981\u7684\u4fe1\u606f <ul> <li>\u6240\u6709\u7684\u8282\u70b9\u4fe1\u606f </li> <li>\u6240\u6709\u7684\u7d22\u5f15\u548c\u5176\u76f8\u5173\u7684Mapping\u4e0eSetting\u4fe1\u606f </li> <li>\u5206\u7247\u7684\u8def\u7531\u4fe1\u606f </li> </ul> </li> </ul> </li> <li>\u4efb\u610f\u8282\u70b9\u90fd\u80fd\u4fee\u6539\u4fe1\u606f\u4f1a\u5bfc\u81f4\u6570\u636e\u7684\u4e0d\u4e00\u81f4\u6027 </li> </ul>"},{"location":"chap3/1ES_intro/#2-5-data-nodecoordinating-node","title":"2-5 Data Node&amp;Coordinating Node","text":"<ul> <li> <p>Data Node</p> <ul> <li>\u53ef\u4ee5\u4fdd\u5b58\u6570\u636e\u7684\u8282\u70b9\u53eb\u505a<code>Data Node</code>\u3002\u8d1f\u8d23\u4fdd\u5b58\u5206\u7247\u6570\u636e\u3002\u5728\u6570\u636e\u6269\u5c55\u4e0a\u8d77\u5230\u4e86\u81f3\u5173\u91cd\u8981\u7684\u4f5c\u7528 </li> </ul> </li> <li> <p>Coordinating Node</p> <ul> <li>\u8d1f\u8d23\u63a5\u53d7<code>Client</code>\u7684\u8bf7\u6c42\u5c06\u8bf7\u6c42\u5206\u53d1\u5230\u5408\u9002\u7684\u8282\u70b9\u6700\u7ec8\u628a\u7ed3\u679c\u6c47\u96c6\u5230\u4e00\u8d77 </li> <li>\u6bcf\u4e2a\u8282\u70b9\u9ed8\u8ba4\u90fd\u8d77\u5230\u4e86<code>Coordinating Node</code>\u7684\u804c\u8d23 </li> </ul> </li> </ul>"},{"location":"chap3/1ES_intro/#2-6","title":"2-6 \u5176\u4ed6\u7684\u8282\u70b9\u7c7b\u578b","text":"<ul> <li>Hot &amp; Warm Node <ul> <li>\u4e0d\u540c\u786c\u4ef6\u914d\u7f6e\u7684<code>Data Node</code>\u7528\u6765\u5b9e\u73b0<code>Hot &amp; Warm</code>\u67b6\u6784\u964d\u4f4e\u96c6\u7fa4\u90e8\u7f72\u7684\u6210\u672c </li> </ul> </li> <li>Machine Learning Node <ul> <li>\u8d1f\u8d23\u8dd1\u673a\u5668\u5b66\u4e60\u7684Job\u7528\u6765\u505a\u5f02\u5e38\u68c0\u6d4b </li> </ul> </li> <li>Tribe Node <ul> <li>(5.3\u5f00\u59cb\u4f7f\u7528Cross Cluster Search) Tribe Node\u8fde\u63a5\u5230\u4e0d\u540c\u7684Elasticsearoh\u96c6\u7fa4, \u5e76\u4e14\u652f\u6301\u5c06\u8fd9\u4e9b\u96c6\u7fa4\u5f53\u6210\u4e00\u4e2a\u5355\u72ec\u7684\u96c6\u7fa4\u5904\u7406 </li> </ul> </li> </ul>"},{"location":"chap3/1ES_intro/#2-7","title":"2-7 \u914d\u7f6e\u8282\u70b9\u7c7b\u578b","text":"<ul> <li>\u5f00\u53d1\u73af\u5883\u4e2d\u4e00\u4e2a\u8282\u70b9\u53ef\u4ee5\u627f\u62c5\u591a\u79cd\u89d2\u8272</li> <li>\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u5e94\u8be5\u8bbe\u7f6e\u5355\u4e00\u7684\u89d2\u8272\u7684\u8282\u70b9(dedicated node) </li> </ul>"},{"location":"chap3/1ES_intro/#2-8-primary-shardreplica-shard","title":"2-8 \u5206\u7247\uff08Primary Shard&amp;Replica Shard)","text":"<ul> <li> <p>\u4e3b\u5206\u7247\uff0c\u7528\u4ee5\u89e3\u51b3\u6570\u636e\u6c34\u5e73\u6269\u5c55\u7684\u95ee\u9898\u3002\u901a\u8fc7\u4e3b\u5206\u7247\uff0c\u53ef\u4ee5\u5c06\u6570\u636e\u5206\u5e03\u5230\u96c6\u7fa4\u5185\u7684\u6240\u6709\u8282\u70b9\u4e4b\u4e0a </p> <ul> <li>\u4e00\u4e2a\u5206\u7247\u662f\u4e00\u4e2a\u8fd0\u884c\u7684Lucene\u7684\u5b9e\u4f8b </li> <li>\u4e3b\u5206\u7247\u6570\u5728\u7d22\u5f15\u521b\u5efa\u65f6\u6307\u5b9a\uff0c\u540e\u7eed\u4e0d\u5141\u8bb8\uff0c\u4fee\u6539\u9664\u975eReindex </li> </ul> </li> <li> <p>\u526f\u672c\u7528\u4ee5\u89e3\u51b3\u6570\u636e\u9ad8\u53ef\u7528\u7684\u95ee\u9898\u5206\u7247\u3002\u662f\u4e3b\u5206\u7247\u7684\u62f7\u8d1d </p> <ul> <li>\u526f\u672c\u5206\u7247\u6570\uff0c\u53ef\u4ee5\u52a8\u6001\u9898\u8c03\u6574 </li> <li>\u589e\u52a0\u526f\u672c\u6570\uff0c\u8fd8\u53ef\u4ee5\u5728\u4e00\u5b9a\u7a0b\u5ea6\u4e0a\u63d0\u9ad8\u670d\u52a1\u7684\u53ef\u7528\u6027\uff08\u8bfb\u53d6\u7684\u541e\u5410\uff09 </li> </ul> </li> </ul>"},{"location":"chap3/1ES_intro/#2-9-primary-shardreplica-shard","title":"2-9 \u5206\u7247\uff08Primary Shard&amp;Replica Shard)","text":"<ul> <li>\u4e00\u4e2a\u4e09\u8282\u70b9\u7684\u96c6\u7fa4\u4e2d\uff0cblogs\u7d22\u5f15\u7684\u5206\u7247\u5206\u5e03\u60c5\u51b5 <ul> <li>\u601d\u8003\uff1a\u589e\u52a0\u4e00\u4e2a\u8282\u70b9\u6216\u6539\u5927\u4e3b\u5206\u7247\u6570\u5bf9\u7cfb\u7edf\u7684\u5f71\u54cd\uff1f </li> </ul> </li> </ul>"},{"location":"chap3/1ES_intro/#2-10","title":"2-10 \u5206\u7247\u7684\u8bbe\u5b9a","text":"<ul> <li>\u5bf9\u4e8e\u751f\u4ea7\u73af\u5883\u4e2d\u5206\u7247\u7684\u8bbe\u5b9a\u9700\u8981\u63d0\u524d\u505a\u597d\u5bb9\u91cf\u89c4\u5212 <ul> <li>\u5206\u7247\u6570\u8bbe\u7f6e\u8fc7\u5c0f <ul> <li>\u5bfc\u81f4\u540e\u7eed\u65e0\u6cd5\u589e\u52a0\u8282\u70b9\u5b9e\u73b0\u6c34\u5e73\u6269\u5c55 </li> <li>\u5355\u4e2a\u5206\u7247\u7684\u6570\u636e\u91cf\u592a\u5927\u5bfc\u81f4\u6570\u636e\u91cd\u65b0\u5206\u914d\u8017\u65f6 </li> </ul> </li> <li>\u5206\u7247\u6570\u8bbe\u7f6e\u8fc7\u59277.0\u5f00\u59cb\u9ed8\u8ba4\u4e3b\u5206\u7247\u8bbe\u7f6e\u6210\uff0c\u89e3\u51b3\u4e86<code>over-sharding</code>\u7684\u95ee\u9898 <ul> <li>\u5f71\u54cd\u641c\u7d22\u7ed3\u679c\u7684\u76f8\u5173\u6027\u6253\u5206\u5f71\u54cd\u7edf\u8ba1\u7ed3\u679c\u7684\u51c6\u786e\u6027 </li> <li>\u5355\u4e2a\u8282\u70b9\u4e0a\u8fc7\u591a\u7684\u5206\u7247\u4f1a\u5bfc\u81f4\u8d44\u6e90\u6d6a\u8d39\u540c\u65f6\u4e5f\u4f1a\u5f71\u54cd\u4ef6\u80fd </li> </ul> </li> </ul> </li> </ul>"},{"location":"chap3/1ES_intro/#2-11","title":"2-11 \u5206\u7247\u7684\u8bbe\u5b9a","text":"<ul> <li>Green\u2014\u2014\u4e3b\u5206\u7247\u4e0e\u526f\u672c\u90fd\u6b63\u5e38\u5206\u914d </li> <li>Yellow\u2014\u2014\u4e3b\u5206\u7247\u5168\u90e8\u6b63\u5e38\u5206\u914d\u6709\u526f\u672c\u5206\u7247\u672a\u80fd\u6b63\u5e38\u5206\u914d </li> <li>Red\u2014\u2014\u6709\u4e3b\u5206\u7247\u672a\u80fd\u5206\u914d <ul> <li>\u4f8b\u5982\u5f53\u670d\u52a1\u5668\u7684\u78c1\u76d8\u5bb9\u91cf\u8d85\u8fc755\uff05\u65f6,\u53bb\u521b\u5efa\u4e86\u4e00\u4e2a\u65b0\u7684\u7d22\u5f15 </li> </ul> </li> </ul> <pre><code>GET _cluster/health\n\n{\n  \"cluster_name\" : \"jx\",\n  \"status\" : \"green\",\n  \"timed_out\" : false,\n  \"number_of_nodes\" : 2,\n  \"number_of_data_nodes\" : 2,\n  \"active_primary_shards\" : 10,\n  \"active_shards\" : 20,\n  \"relocating_shards\" : 0,\n  \"initializing_shards\" : 0,\n  \"unassigned_shards\" : 0,\n  \"delayed_unassigned_shards\" : 0,\n  \"number_of_pending_tasks\" : 0,\n  \"number_of_in_flight_fetch\" : 0,\n  \"task_max_waiting_in_queue_millis\" : 0,\n  \"active_shards_percent_as_number\" : 100.0\n}\n</code></pre>"},{"location":"chap3/1ES_intro/#2-12-demo","title":"2-12 DEMO","text":"<ul> <li>CAT API<ul> <li>http://localhost:9200/_cat/nodes </li> <li>\u67e5\u770b\u7d22\u5f15\u548c\u5206\u7247 </li> </ul> </li> </ul> <pre><code>GET _cat/nodes\n172.22.0.4 64 96 3 0.08 0.11 0.15 dilmrt * es79\n172.22.0.5 66 96 3 0.08 0.11 0.15 dilmrt - es7_02\n\n</code></pre> <ul> <li>\u8bbe\u7f6e\u5206\u7247\u6570 </li> <li>Kibana + Cerebro\u754c\u9762\u4ecb\u7ecd </li> </ul> <pre><code>GET _cluster/health\n\nGET _cat/nodes?v\nGET /_nodes/es79,es7_02\nGET /_cat/nodes?v\nGET /_cat/nodes?v&amp;h=id,ip,port,v,m\n\nGET _cluster/health\nGET _cluster/health?level=shards\nGET /_cluster/health/kibana_sample_data_ecommerce,kibana_sample_data_flights\nGET /_cluster/health/kibana_sample_data_flights?level=shards\n\n#### cluster state The cluster state API allows access to metadata representing the state of the whole cluster. This includes information such as\nGET /_cluster/state\n\n#cluster get settings\nGET /_cluster/settings\nGET /_cluster/settings?include_defaults=true\n\nGET _cat/shards\nGET _cat/shards?h=index,shard,prirep,state,unassigned.reason\n</code></pre> <pre><code>GET _cat/nodes?v\n\nip         heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name\n172.22.0.4           52          96   5    1.11    0.47     0.31 dilmrt    *      es79\n172.22.0.5           46          96   5    1.11    0.47     0.31 dilmrt    -      es7_02\n</code></pre> <pre><code>GET /_nodes/es79,es7_02\n\n{\n  \"_nodes\" : {\n    \"total\" : 2,\n    \"successful\" : 2,\n    \"failed\" : 0\n  },\n  \"cluster_name\" : \"jx\",\n  \"nodes\" : {\n    \"lTFD6qBCQ460xdW8XFgaIg\" : {\n      \"name\" : \"es7_02\",\n      \"transport_address\" : \"172.22.0.5:9300\",\n      \"host\" : \"172.22.0.5\",\n      \"ip\" : \"172.22.0.5\",\n      \"version\" : \"7.9.1\",\n      \"build_flavor\" : \"default\",\n      \"build_type\" : \"docker\",\n      \"build_hash\" : \"083627f112ba94dffc1232e8b42b73492789ef91\",\n      \"total_indexing_buffer\" : 50331648,\n      \"roles\" : [\n        \"data\",\n        \"ingest\",\n        \"master\",\n        \"ml\",\n        \"remote_cluster_client\",\n        \"transform\"\n      ],\n      ...\n</code></pre> <pre><code>GET /_cat/nodes?v&amp;h=id,ip,port,v,m\n\nid   ip         port v     m\nL7jf 172.22.0.4 9300 7.9.1 *\nlTFD 172.22.0.5 9300 7.9.1 -\n</code></pre> <pre><code>GET _cluster/health?level=shards\n\n{\n  \"cluster_name\" : \"jx\",\n  \"status\" : \"green\",\n  \"timed_out\" : false,\n  \"number_of_nodes\" : 2,\n  \"number_of_data_nodes\" : 2,\n  \"active_primary_shards\" : 10,\n  \"active_shards\" : 20,\n  \"relocating_shards\" : 0,\n  \"initializing_shards\" : 0,\n  \"unassigned_shards\" : 0,\n  \"delayed_unassigned_shards\" : 0,\n  \"number_of_pending_tasks\" : 0,\n  \"number_of_in_flight_fetch\" : 0,\n  \"task_max_waiting_in_queue_millis\" : 0,\n  \"active_shards_percent_as_number\" : 100.0,\n  \"indices\" : {\n    \"movies\" : {\n      \"status\" : \"green\",\n      \"number_of_shards\" : 1,\n      \"number_of_replicas\" : 1,\n      \"active_primary_shards\" : 1,\n      \"active_shards\" : 2,\n      \"relocating_shards\" : 0,\n      \"initializing_shards\" : 0,\n      \"unassigned_shards\" : 0,\n      \"shards\" : {\n        \"0\" : {\n          \"status\" : \"green\",\n          \"primary_active\" : true,\n          \"active_shards\" : 2,\n          \"relocating_shards\" : 0,\n          \"initializing_shards\" : 0,\n          \"unassigned_shards\" : 0\n        }\n      }\n    },\n...\n</code></pre> <pre><code>GET /_cluster/health/kibana_sample_data_ecommerce,kibana_sample_data_flights\n\n{\n  \"cluster_name\" : \"jx\",\n  \"status\" : \"green\",\n  \"timed_out\" : false,\n  \"number_of_nodes\" : 2,\n  \"number_of_data_nodes\" : 2,\n  \"active_primary_shards\" : 2,\n  \"active_shards\" : 4,\n  \"relocating_shards\" : 0,\n  \"initializing_shards\" : 0,\n  \"unassigned_shards\" : 0,\n  \"delayed_unassigned_shards\" : 0,\n  \"number_of_pending_tasks\" : 0,\n  \"number_of_in_flight_fetch\" : 0,\n  \"task_max_waiting_in_queue_millis\" : 0,\n  \"active_shards_percent_as_number\" : 100.0\n}\n</code></pre> <pre><code>GET /_cluster/health/kibana_sample_data_flights?level=shards\n\n{\n  \"cluster_name\" : \"jx\",\n  \"status\" : \"green\",\n  \"timed_out\" : false,\n  \"number_of_nodes\" : 2,\n  \"number_of_data_nodes\" : 2,\n  \"active_primary_shards\" : 1,\n  \"active_shards\" : 2,\n  \"relocating_shards\" : 0,\n  \"initializing_shards\" : 0,\n  \"unassigned_shards\" : 0,\n  \"delayed_unassigned_shards\" : 0,\n  \"number_of_pending_tasks\" : 0,\n  \"number_of_in_flight_fetch\" : 0,\n  \"task_max_waiting_in_queue_millis\" : 0,\n  \"active_shards_percent_as_number\" : 100.0,\n  \"indices\" : {\n    \"kibana_sample_data_flights\" : {\n      \"status\" : \"green\",\n      \"number_of_shards\" : 1,\n      \"number_of_replicas\" : 1,\n      \"active_primary_shards\" : 1,\n      \"active_shards\" : 2,\n      \"relocating_shards\" : 0,\n      \"initializing_shards\" : 0,\n      \"unassigned_shards\" : 0,\n      \"shards\" : {\n        \"0\" : {\n          \"status\" : \"green\",\n          \"primary_active\" : true,\n          \"active_shards\" : 2,\n          \"relocating_shards\" : 0,\n          \"initializing_shards\" : 0,\n          \"unassigned_shards\" : 0\n        }\n      }\n    }\n  }\n}\n</code></pre> <pre><code>## cluster state The cluster state API allows access to metadata representing the state of the whole cluster. This includes information such as\n\n\nGET /_cluster/state\n\n{\n  \"cluster_name\" : \"jx\",\n  \"cluster_uuid\" : \"r-I8BtMKRTyZOuYqnnm5VQ\",\n  \"version\" : 160,\n  \"state_uuid\" : \"8oYBvskARIy0NVpgfd4tsA\",\n  \"master_node\" : \"L7jf3HA8TqOEtNY8BrU82A\",\n  \"blocks\" : { },\n  \"nodes\" : {\n    \"L7jf3HA8TqOEtNY8BrU82A\" : {\n      \"name\" : \"es79\",\n      \"ephemeral_id\" : \"N2k4LdbnRwCUbI1i8c1Rpw\",\n      \"transport_address\" : \"172.22.0.4:9300\",\n      \"attributes\" : {\n        \"ml.machine_memory\" : \"1927524352\",\n        \"xpack.installed\" : \"true\",\n        \"transform.node\" : \"true\",\n        \"ml.max_open_jobs\" : \"20\"\n      }\n    },\n...\n</code></pre> <pre><code># cluster get settings\n\nGET /_cluster/settings\n\n{\n  \"persistent\" : { },\n  \"transient\" : { }\n}\n\n\nGET /_cluster/settings?include_defaults=true\n\n{\n  \"persistent\" : { },\n  \"transient\" : { },\n  \"defaults\" : {\n    \"cluster\" : {\n      \"max_voting_config_exclusions\" : \"10\",\n      \"auto_shrink_voting_configuration\" : \"true\",\n      \"election\" : {\n        \"duration\" : \"500ms\",\n        \"initial_timeout\" : \"100ms\",\n        \"max_timeout\" : \"10s\",\n        \"back_off_time\" : \"100ms\",\n        \"strategy\" : \"supports_voting_only\"\n      },\n      \"no_master_block\" : \"write\",\n      \"persistent_tasks\" : {\n        \"allocation\" : {\n          \"enable\" : \"all\",\n          \"recheck_interval\" : \"30s\"\n        }\n      },\n...\n</code></pre> <pre><code>GET _cat/shards\n\n.kibana_1                      0 p STARTED   348  11.4mb 172.22.0.5 es7_02\n.kibana_1                      0 r STARTED   348    13mb 172.22.0.4 es79\nkibana_sample_data_logs        0 p STARTED 14074   9.2mb 172.22.0.5 es7_02\nkibana_sample_data_logs        0 r STARTED 14074   9.2mb 172.22.0.4 es79\n.apm-custom-link               0 r STARTED     0    208b 172.22.0.5 es7_02\n.apm-custom-link               0 p STARTED     0    208b 172.22.0.4 es79\n.kibana-event-log-7.9.1-000001 0 r STARTED     4  21.6kb 172.22.0.5 es7_02\n.kibana-event-log-7.9.1-000001 0 p STARTED     4  21.6kb 172.22.0.4 es79\nilm-history-2-000001           0 r STARTED               172.22.0.5 es7_02\nilm-history-2-000001           0 p STARTED               172.22.0.4 es79\n.kibana_task_manager_1         0 p STARTED     6 565.8kb 172.22.0.5 es7_02\n.kibana_task_manager_1         0 r STARTED     6 564.6kb 172.22.0.4 es79\nkibana_sample_data_ecommerce   0 p STARTED  4675   4.2mb 172.22.0.5 es7_02\nkibana_sample_data_ecommerce   0 r STARTED  4675   4.3mb 172.22.0.4 es79\nkibana_sample_data_flights     0 r STARTED 13059   5.9mb 172.22.0.5 es7_02\nkibana_sample_data_flights     0 p STARTED 13059   5.9mb 172.22.0.4 es79\nmovies                         0 p STARTED  9744   1.2mb 172.22.0.5 es7_02\nmovies                         0 r STARTED  9744   1.2mb 172.22.0.4 es79\n.apm-agent-configuration       0 r STARTED     0    208b 172.22.0.5 es7_02\n.apm-agent-configuration       0 p STARTED     0    208b 172.22.0.4 es79\n\n\nGET _cat/shards?h=index,shard,prirep,state,unassigned.reason\n.kibana_1                      0 p STARTED \n.kibana_1                      0 r STARTED \nkibana_sample_data_logs        0 p STARTED \nkibana_sample_data_logs        0 r STARTED \n.apm-custom-link               0 r STARTED \n.apm-custom-link               0 p STARTED \n.kibana-event-log-7.9.1-000001 0 r STARTED \n.kibana-event-log-7.9.1-000001 0 p STARTED \nilm-history-2-000001           0 r STARTED \nilm-history-2-000001           0 p STARTED \n.kibana_task_manager_1         0 p STARTED \n.kibana_task_manager_1         0 r STARTED \nkibana_sample_data_ecommerce   0 p STARTED \nkibana_sample_data_ecommerce   0 r STARTED \nkibana_sample_data_flights     0 r STARTED \nkibana_sample_data_flights     0 p STARTED \nmovies                         0 p STARTED \nmovies                         0 r STARTED \n.apm-agent-configuration       0 r STARTED \n.apm-agent-configuration       0 p STARTED \n</code></pre> <pre><code>$ docker stop es7_02\n</code></pre>"},{"location":"chap3/1ES_intro/#2-13","title":"2-13 \u672c\u8282\u56de\u987e","text":"<ul> <li>\u4e00\u4e2a\u8282\u70b9\u662f\u8fd0\u884cElasticsearah\u7684Java\u8fdb\u7a0b </li> <li>\u4e00\u4e2a\u96c6\u7fa4\u75311\u5230\u591a\u4e2a\u8282\u70b9\u5171\u540c\u7ec4\u6210\u6bcf\u4e2a\u8282\u70b9\u53ef\u4ee5\u627f\u62c5\u4e0d\u540c\u7684\u6700\u8272 </li> <li>\u4e00\u4efd\u4e3b\u5206\u7247\u662f\u4e00\u4e2aLucene\u7684\u5b9e\u4f8b\u7d22\u5f15\u7684\u4e00\u90e8\u5206\u6210\u5168\u90e8\u6570\u636e </li> <li>\u4e00\u4e2a\u526f\u672c\u5206\u7247\u662f\u4e00\u4e2a\u4e3b\u5206\u7247\u7684\u62f7\u8d1d </li> <li>Elasticsearch\u901a\u8fc7\u5206\u7247\u53ef\u4ee5\u5b9e\u73b0\u6c34\u5e73\u6269\u5c55\u548c\u6570\u636e\u53ef\u7528\u965b </li> <li>\u96c6\u7fa4\u7684\u4e09\u79cd\u5065\u5eb7\u72b6\u6001Shard\u7684\u4e0d\u540c\u72b6\u6001 </li> </ul>"},{"location":"chap3/1ES_intro/#reference","title":"Reference","text":"<ul> <li>CAT Nodes API https://www.elastic.co/guide/en/elasticsearch/reference/7.1/cat-nodes.html</li> <li>Cluster API https://www.elastic.co/guide/en/elasticsearch/reference/7.1/cluster.html</li> <li>CAT Shards API https://www.elastic.co/guide/en/elasticsearch/reference/7.1/cat-shards.html</li> </ul>"},{"location":"chap3/2ES_CRUD/","title":"\u7b2c\u4e8c\u8282 \u6587\u6863\u7684\u57fa\u672cCRUD\u4e0e\u6279\u91cf\u64cd\u4f5c &amp; \u8bfb\u53d6\uff06Bulk API","text":""},{"location":"chap3/2ES_CRUD/#1crud","title":"1\u3001\u6587\u6863\u7684CRUD","text":"<ul> <li><code>Type</code>\u540d\u7ea6\u5b9a\u90fd\u7528<code>_doc</code> </li> <li><code>Create</code>\u4e00\u5982\u679cID\u5df2\u7ecf\u5b58\u5728\u4f1a\u5931\u8d25 </li> <li>Index - \u5982\u679c\u65e7\u4e0d\u5b58\u5728\u521b\u5efa\u65b0\u7684\u6587\u6863\u3002\u5426\u5219\u5148\u5220\u9664\u73b0\u6709\u7684\u6587\u6863 \u518d\u521b\u5efa\u65b0\u7684\u6587\u6863\u7248\u672c\u4f1a\u589e\u52a0 </li> <li>Update - \u6587\u6863\u5fc5\u987b\u5df2\u7ecf\u5b58\u5728\u66f4\u65b0\u53ea\u4f1a\u5bf9\u76f8\u5e94\u5b57\u6bb5\u505a\u589e\u91cf\u4fee\u6539</li> </ul>"},{"location":"chap3/2ES_CRUD/#1-1-create","title":"1-1 Create \u4e00\u4e2a\u6587\u6863","text":"<ul> <li>\u652f\u6301\u81ea\u52a8\u751f\u6210\u6587\u6863<code>Id</code>\u548c\u6307\u5b9a\u6587\u6863<code>Id</code>\u4e24\u79cd\u65b9\u5f0f </li> <li>\u901a\u8fc7\u8c03\u7528<code>\"post/users/_doc\"</code><ul> <li>\u7cfb\u7edf\u4f1a\u81ea\u52a8\u751f\u6210<code>document Id</code> </li> </ul> </li> <li>\u4f7f\u7528HTTP <code>PUT user/_create/1</code>\u521b\u5efa\u65f6URI\u4e2d\u663e\u793a\u6307\u5b9a<code>_create</code>, \u6b64\u65f6\u5982\u679c\u8be5id\u7684\u6587\u6863\u5df2\u7ecf\u5b58\u5728,\u64cd\u4f5c\u5931\u8d25 </li> </ul> <pre><code>############Create Document############\n\nPOST users/_doc\n{\n    \"user\" : \"Mike\",\n    \"post_date\" : \"2019-04-15T14:12:12\",\n    \"message\" : \"trying out Kibana\"\n}\n\n\n# Output\n{\n  \"_index\" : \"users\",\n  \"_type\" : \"_doc\",\n  \"_id\" : \"zw8EtnQBiZ4B72YzK64C\",\n  \"_version\" : 1,\n  \"result\" : \"created\",\n  \"_shards\" : {\n    \"total\" : 2,\n    \"successful\" : 1,\n    \"failed\" : 0\n  },\n  \"_seq_no\" : 0,\n  \"_primary_term\" : 1\n}\n</code></pre> <pre><code># create document. \u6307\u5b9aId\u3002\u5982\u679cid\u5df2\u7ecf\u5b58\u5728\uff0c\u62a5\u9519\n\nPUT users/_doc/1?op_type=create\n{\n    \"user\" : \"Jack\",\n    \"post_date\" : \"2019-05-15T14:12:12\",\n    \"message\" : \"trying out Elasticsearch\"\n}\n# sucess \n\n# create document. \u6307\u5b9a ID \u5982\u679c\u5df2\u7ecf\u5b58\u5728\uff0c\u5c31\u62a5\u9519\nPUT users/_create/1\n{\n     \"user\" : \"Jack\",\n    \"post_date\" : \"2019-05-15T14:12:12\",\n    \"message\" : \"trying out Elasticsearch\"\n}\n\n\n# output\n{\n  \"error\" : {\n    \"root_cause\" : [\n      {\n        \"type\" : \"version_conflict_engine_exception\",\n        \"reason\" : \"[1]: version conflict, document already exists (current version [1])\",\n        \"index_uuid\" : \"7V7E9LOESKqJeeU5mH3OXw\",\n        \"shard\" : \"0\",\n        \"index\" : \"users\"\n      }\n    ],\n    \"type\" : \"version_conflict_engine_exception\",\n    \"reason\" : \"[1]: version conflict, document already exists (current version [1])\",\n    \"index_uuid\" : \"7V7E9LOESKqJeeU5mH3OXw\",\n    \"shard\" : \"0\",\n    \"index\" : \"users\"\n  },\n  \"status\" : 409\n}\n</code></pre>"},{"location":"chap3/2ES_CRUD/#1-2-get","title":"1-2 Get \u4e00\u4e2a\u6587\u6863","text":"<ul> <li>\u627e\u5230\u6587\u6863\u8fd4\u56de HTTP 200 <ul> <li>\u6587\u6863\u5143\u4fe1\u606f </li> <li><code>_index / _type /</code></li> <li>\u7248\u672c\u4fe1\u606f, \u540c\u4e00\u4e2aId\u7684\u6587\u6863,  \u5373\u4f7f\u88ab\u5220\u9664\uff0c<code>Version</code>\u53f7\u4e5f\u4f1a\u4e0d\u65ad\u589e\u52a0 </li> <li><code>_source</code> \u4e2d\u9ed8\u8ba4\u5305\u542b\u4e86\u6587\u6863\u7684\u6240\u6709\u539f\u59cb\u4fe1\u606f </li> </ul> </li> <li>\u627e\u4e0d\u5230\u6587\u6863, \u8fd4\u56de<code>HTTP 404</code></li> </ul> <pre><code>### Get Document by ID\n\nGET users/_doc/1\n\n### Output\n{\n  \"_index\" : \"users\",\n  \"_type\" : \"_doc\",\n  \"_id\" : \"1\",\n  \"_version\" : 1,\n  \"_seq_no\" : 1,\n  \"_primary_term\" : 1,\n  \"found\" : true,\n  \"_source\" : {\n    \"user\" : \"Jack\",\n    \"post_date\" : \"2019-05-15T14:12:12\",\n    \"message\" : \"trying out Elasticsearch\"\n  }\n}\n</code></pre>"},{"location":"chap3/2ES_CRUD/#1-3-index","title":"1-3 Index\u6587\u6863","text":"<ul> <li><code>Index</code>\u548c<code>Create</code>\u4e0d\u4e00\u6837\u7684\u5730\u65b9\u5982\u679c\u6587\u6863\u4e0d\u5b58\u5728\u5c31\u7d22\u5f15\u65b0\u7684\u6587\u6863\u3002</li> <li>\u5426\u5219\u73b0\u6709\u6587\u6863\u4f1a\u88ab\u5220\u9664\u65b0\u7684\u6587\u6863\u88ab\u7d22\u5f15\u7248\u672c\u4fe1\u606f+1</li> </ul> <pre><code>#Update \u6307\u5b9a ID  (\u5148\u5220\u9664\uff0c\u5728\u5199\u5165)\nPUT users/_doc/1\n{\n    \"user\" : \"Mike\"\n\n}\n\n\n\n# output\n{\n  \"_index\" : \"users\",\n  \"_type\" : \"_doc\",\n  \"_id\" : \"1\",\n  \"_version\" : 2,\n  \"result\" : \"updated\",\n  \"_shards\" : {\n    \"total\" : 2,\n    \"successful\" : 2,\n    \"failed\" : 0\n  },\n  \"_seq_no\" : 1,\n  \"_primary_term\" : 1\n}\n</code></pre> <p><code>\"_version\" : 2</code></p> <pre><code>GET users/_doc/1\n\n{\n  \"_index\" : \"users\",\n  \"_type\" : \"_doc\",\n  \"_id\" : \"1\",\n  \"_version\" : 2,\n  \"_seq_no\" : 1,\n  \"_primary_term\" : 1,\n  \"found\" : true,\n  \"_source\" : {\n    \"user\" : \"Mike\"\n  }\n}\n</code></pre> <ul> <li><code>\"_version\" : 2</code></li> <li><code>\"_primary_term\" : 1</code></li> </ul>"},{"location":"chap3/2ES_CRUD/#1-4-update","title":"1-4 Update \u6587\u6863","text":"<ul> <li>Updete\u65b9\u6cd5\u4e0d\u4f1a\u5220\u9664\u539f\u6765\u7684\u6587\u6863\u800c\u662f\u5b9e\u73b0\u771f\u6b63\u7684\u6570\u636e\u66f4\u65b0 </li> <li><code>Post</code>\u65b9\u6cd5/ <code>Payload</code>\u9700\u8981\u5305\u542b\u5728<code>\"doc\"</code>\u4e2d </li> </ul> <pre><code>POST users/_update/1/\n{\n    \"doc\":{\n        \"post_date\" : \"2019-05-15T14:12:12\",\n        \"message\" : \"trying out Elasticsearch\"\n    }\n}\n</code></pre> <ul> <li>output</li> </ul> <pre><code>{\n  \"_index\" : \"users\",\n  \"_type\" : \"_doc\",\n  \"_id\" : \"1\",\n  \"_version\" : 5,\n  \"result\" : \"noop\",\n  \"_shards\" : {\n    \"total\" : 0,\n    \"successful\" : 0,\n    \"failed\" : 0\n  },\n  \"_seq_no\" : 7,\n  \"_primary_term\" : 1\n}\n</code></pre>"},{"location":"chap3/2ES_CRUD/#1-5","title":"1-5 \u5220\u9664\u6587\u6863","text":"<pre><code>### Delete by Id\n# \u5220\u9664\u6587\u6863\nDELETE users/_doc/1\n</code></pre> <ul> <li>Output</li> </ul> <pre><code>{\n  \"_index\" : \"users\",\n  \"_type\" : \"_doc\",\n  \"_id\" : \"1\",\n  \"_version\" : 6,\n  \"result\" : \"deleted\",\n  \"_shards\" : {\n    \"total\" : 2,\n    \"successful\" : 2,\n    \"failed\" : 0\n  },\n  \"_seq_no\" : 8,\n  \"_primary_term\" : 1\n}\n</code></pre> <pre><code>GET users/_doc/1\n\n# 404 \n{\n  \"_index\" : \"users\",\n  \"_type\" : \"_doc\",\n  \"_id\" : \"1\",\n  \"found\" : false\n}\n</code></pre>"},{"location":"chap3/2ES_CRUD/#2bulk-api","title":"2\u3001Bulk API","text":"<ul> <li>\u652f\u6301\u5728\u4e00\u6b21API\u8c03\u7528\u4e2d\u5bf9\u4e0d\u540c\u7684\u7d22\u5f15\u8fdb\u884c\u64cd\u4f5c </li> <li>\u652f\u6301\u56db\u79cd\u7c7b\u578b\u64cd\u4f5c <ul> <li>Index </li> <li>Create</li> <li>Updete </li> <li>Delete </li> </ul> </li> <li>\u53ef\u4ee5\u518dURI\u4e2d\u6307\u5b9aIndex\u4e5f\u53ef\u4ee5\u5728\u8bf7\u6c42\u7684Payload\u4e2d\u8fdb\u884c </li> <li>\u64cd\u4f5c\u4e2d\u5355\u6761\u64cd\u4f5c\u5931\u8d25\uff0c\u5e76\u4e0d\u4f1a\u5f71\u54cd\u5176\u4ed6\u64cd\u4f5c</li> <li>\u8fd4\u56de\u7ed3\u679c\u5305\u62ec\u4e86\u6ca1\u4e00\u6761\u64cd\u4f5c\u6267\u884c\u7684\u7ed3\u679c </li> </ul>"},{"location":"chap3/2ES_CRUD/#2-1-bulk","title":"2-1 Bulk \u64cd\u4f5c","text":"<pre><code>#\u6267\u884c\u4e24\u6b21\uff0c\u67e5\u770b\u6bcf\u6b21\u7684\u7ed3\u679c\n\n#\u6267\u884c\u7b2c1\u6b21\nPOST _bulk\n{ \"index\" : { \"_index\" : \"test\", \"_id\" : \"1\" } }\n{ \"field1\" : \"value1\" }\n{ \"delete\" : { \"_index\" : \"test\", \"_id\" : \"2\" } }\n{ \"create\" : { \"_index\" : \"test2\", \"_id\" : \"3\" } }\n{ \"field1\" : \"value3\" }\n{ \"update\" : {\"_id\" : \"1\", \"_index\" : \"test\"} }\n{ \"doc\" : {\"field2\" : \"value2\"} }\n</code></pre> <ul> <li>Output</li> </ul> <pre><code>{\n  \"took\" : 2659,\n  \"errors\" : false,\n  \"items\" : [\n    {\n      \"index\" : {\n        \"_index\" : \"test\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"1\",\n        \"_version\" : 1,\n        \"result\" : \"created\",\n        \"_shards\" : {\n          \"total\" : 2,\n          \"successful\" : 2,\n          \"failed\" : 0\n        },\n        \"_seq_no\" : 0,\n        \"_primary_term\" : 1,\n        \"status\" : 201\n      }\n    },\n    {\n      \"delete\" : {\n        \"_index\" : \"test\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"2\",\n        \"_version\" : 1,\n        \"result\" : \"not_found\",\n        \"_shards\" : {\n          \"total\" : 2,\n          \"successful\" : 2,\n          \"failed\" : 0\n        },\n        \"_seq_no\" : 1,\n        \"_primary_term\" : 1,\n        \"status\" : 404\n      }\n    },\n    {\n      \"create\" : {\n        \"_index\" : \"test2\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"3\",\n        \"_version\" : 1,\n        \"result\" : \"created\",\n        \"_shards\" : {\n          \"total\" : 2,\n          \"successful\" : 2,\n          \"failed\" : 0\n        },\n        \"_seq_no\" : 0,\n        \"_primary_term\" : 1,\n        \"status\" : 201\n      }\n    },\n    {\n      \"update\" : {\n        \"_index\" : \"test\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"1\",\n        \"_version\" : 2,\n        \"result\" : \"updated\",\n        \"_shards\" : {\n          \"total\" : 2,\n          \"successful\" : 2,\n          \"failed\" : 0\n        },\n        \"_seq_no\" : 2,\n        \"_primary_term\" : 1,\n        \"status\" : 200\n      }\n    }\n</code></pre> <ul> <li><code>{ \"delete\" : { \"_index\" : \"test\", \"_id\" : \"2\" } }</code> =&gt;  <code>\"result\" : \"not_found\",</code></li> </ul> <pre><code>#\u6267\u884c\u7b2c2\u6b21\nPOST _bulk\n{ \"index\" : { \"_index\" : \"test\", \"_id\" : \"1\" } }\n{ \"field1\" : \"value1\" }\n{ \"delete\" : { \"_index\" : \"test\", \"_id\" : \"2\" } }\n{ \"create\" : { \"_index\" : \"test2\", \"_id\" : \"3\" } }\n{ \"field1\" : \"value3\" }\n{ \"update\" : {\"_id\" : \"1\", \"_index\" : \"test\"} }\n{ \"doc\" : {\"field2\" : \"value2\"} }\n</code></pre> <pre><code>{\n  \"took\" : 22,\n  \"errors\" : true,\n  \"items\" : [\n    {\n      \"index\" : {\n        \"_index\" : \"test\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"1\",\n        \"_version\" : 3,\n        \"result\" : \"updated\",\n        \"_shards\" : {\n          \"total\" : 2,\n          \"successful\" : 2,\n          \"failed\" : 0\n        },\n        \"_seq_no\" : 3,\n        \"_primary_term\" : 1,\n        \"status\" : 200\n      }\n    },\n    {\n      \"delete\" : {\n        \"_index\" : \"test\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"2\",\n        \"_version\" : 1,\n        \"result\" : \"not_found\",\n        \"_shards\" : {\n          \"total\" : 2,\n          \"successful\" : 2,\n          \"failed\" : 0\n        },\n        \"_seq_no\" : 4,\n        \"_primary_term\" : 1,\n        \"status\" : 404\n      }\n    },\n    {\n      \"create\" : {\n        \"_index\" : \"test2\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"3\",\n        \"status\" : 409,\n        \"error\" : {\n          \"type\" : \"version_conflict_engine_exception\",\n          \"reason\" : \"[3]: version conflict, document already exists (current version [1])\",\n          \"index_uuid\" : \"M_XnRwHERy6F4N26wR2VQQ\",\n          \"shard\" : \"0\",\n          \"index\" : \"test2\"\n        }\n      }\n    },\n    {\n      \"update\" : {\n        \"_index\" : \"test\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"1\",\n        \"_version\" : 4,\n        \"result\" : \"updated\",\n        \"_shards\" : {\n          \"total\" : 2,\n          \"successful\" : 2,\n          \"failed\" : 0\n        },\n        \"_seq_no\" : 5,\n        \"_primary_term\" : 1,\n        \"status\" : 200\n      }\n    }\n  ]\n}\n</code></pre> <ul> <li><code>{ \"create\" : { \"_index\" : \"test2\", \"_id\" : \"3\" } }</code> =&gt; <code>\"reason\" : \"[3]: version conflict, document already exists (current version [1])\",</code></li> </ul>"},{"location":"chap3/2ES_CRUD/#2-1-mget","title":"2-1 \u6279\u91cf\u8bfb\u53d6\u4e00mget","text":"<ul> <li>\u6279\u91cf\u64cd\u4f5c\u53ef\u4ee5\u51cf\u5c11\u7f51\u7edc\u8fde\u63a5\u6240\u4ea7\u751f\u7684\u5f00\u9500 </li> <li>\u63d0\u9ad8\u6027\u80fd </li> </ul> <pre><code>### mget \u64cd\u4f5c\nGET /_mget\n{\n    \"docs\" : [\n        {\n            \"_index\" : \"test\",\n            \"_id\" : \"1\"\n        },\n        {\n            \"_index\" : \"test\",\n            \"_id\" : \"2\"\n        }\n    ]\n}\n</code></pre> <ul> <li>Output</li> </ul> <pre><code>{\n  \"docs\" : [\n    {\n      \"_index\" : \"test\",\n      \"_type\" : \"_doc\",\n      \"_id\" : \"1\",\n      \"_version\" : 4,\n      \"_seq_no\" : 5,\n      \"_primary_term\" : 1,\n      \"found\" : true,\n      \"_source\" : {\n        \"field1\" : \"value1\",\n        \"field2\" : \"value2\"\n      }\n    },\n    {\n      \"_index\" : \"test\",\n      \"_type\" : \"_doc\",\n      \"_id\" : \"2\",\n      \"found\" : false\n    }\n  ]\n}\n</code></pre> <ul> <li>URI\u4e2d\u6307\u5b9aindex</li> </ul> <pre><code>\nGET /test/_mget\n{\n    \"docs\" : [\n        {\n\n            \"_id\" : \"1\"\n        },\n        {\n\n            \"_id\" : \"2\"\n        }\n    ]\n}\n</code></pre> <p>Output</p> <pre><code>{\n  \"docs\" : [\n    {\n      \"_index\" : \"test\",\n      \"_type\" : \"_doc\",\n      \"_id\" : \"1\",\n      \"_version\" : 4,\n      \"_seq_no\" : 5,\n      \"_primary_term\" : 1,\n      \"found\" : true,\n      \"_source\" : {\n        \"field1\" : \"value1\",\n        \"field2\" : \"value2\"\n      }\n    },\n    {\n      \"_index\" : \"test\",\n      \"_type\" : \"_doc\",\n      \"_id\" : \"2\",\n      \"found\" : false\n    }\n  ]\n}\n</code></pre>"},{"location":"chap3/2ES_CRUD/#2-2-msearch","title":"2-2 \u6279\u91cf\u67e5\u8be2\u4e00msearch","text":"<pre><code>GET /_mget\n{\n    \"docs\" : [\n        {\n            \"_index\" : \"test\",\n            \"_id\" : \"1\",\n            \"_source\" : false\n        },\n        {\n            \"_index\" : \"test\",\n            \"_id\" : \"2\",\n            \"_source\" : [\"field3\", \"field4\"]\n        },\n        {\n            \"_index\" : \"test\",\n            \"_id\" : \"3\",\n            \"_source\" : {\n                \"include\": [\"user\"],\n                \"exclude\": [\"user.location\"]\n            }\n        }\n    ]\n}\n</code></pre> <p>Output</p> <pre><code>{\n  \"docs\" : [\n    {\n      \"_index\" : \"test\",\n      \"_type\" : \"_doc\",\n      \"_id\" : \"1\",\n      \"_version\" : 4,\n      \"_seq_no\" : 5,\n      \"_primary_term\" : 1,\n      \"found\" : true\n    },\n    {\n      \"_index\" : \"test\",\n      \"_type\" : \"_doc\",\n      \"_id\" : \"2\",\n      \"found\" : false\n    },\n    {\n      \"_index\" : \"test\",\n      \"_type\" : \"_doc\",\n      \"_id\" : \"3\",\n      \"found\" : false\n    }\n  ]\n}\n</code></pre> <ul> <li>URI\u4e2d\u6307\u5b9aindex</li> </ul> <pre><code>GET /test/_mget\n{\n    \"docs\" : [\n        {\n\n            \"_id\" : \"1\"\n        },\n        {\n\n            \"_id\" : \"2\"\n        }\n    ]\n}\n</code></pre> <p>Output</p> <pre><code>{\n  \"docs\" : [\n    {\n      \"_index\" : \"test\",\n      \"_type\" : \"_doc\",\n      \"_id\" : \"1\",\n      \"_version\" : 4,\n      \"_seq_no\" : 5,\n      \"_primary_term\" : 1,\n      \"found\" : true,\n      \"_source\" : {\n        \"field1\" : \"value1\",\n        \"field2\" : \"value2\"\n      }\n    },\n    {\n      \"_index\" : \"test\",\n      \"_type\" : \"_doc\",\n      \"_id\" : \"2\",\n      \"found\" : false\n    }\n  ]\n}\n</code></pre>"},{"location":"chap3/2ES_CRUD/#2-3-msearch","title":"2-3 msearch \u64cd\u4f5c","text":"<pre><code>POST kibana_sample_data_ecommerce/_msearch\n{}\n{\"query\" : {\"match_all\" : {}},\"size\":1}\n{\"index\" : \"kibana_sample_data_flights\"}\n{\"query\" : {\"match_all\" : {}},\"size\":2}\n</code></pre> <p>Output</p> <pre><code>{\n  \"took\" : 98,\n  \"responses\" : [\n    {\n      \"took\" : 20,\n      \"timed_out\" : false,\n      \"_shards\" : {\n        \"total\" : 1,\n        \"successful\" : 1,\n        \"skipped\" : 0,\n        \"failed\" : 0\n      },\n      \"hits\" : {\n        \"total\" : {\n          \"value\" : 4675,\n          \"relation\" : \"eq\"\n        },\n        \"max_score\" : 1.0,\n        \"hits\" : [\n          {\n            \"_index\" : \"kibana_sample_data_ecommerce\",\n            \"_type\" : \"_doc\",\n            \"_id\" : \"kw_fsnQBiZ4B72YzxCce\",\n            \"_score\" : 1.0,\n            \"_source\" : {\n              \"category\" : [\n                \"Men's Clothing\"\n              ],\n              ...\n</code></pre>"},{"location":"chap3/2ES_CRUD/#2-3","title":"2-3 \u5e38\u89c1\u9519\u8bef\u8fd4\u56de","text":""},{"location":"chap3/2ES_CRUD/#2-4","title":"2-4 \u672c\u8282\u56de\u987e","text":"<ul> <li>\u57fa\u672c\u7684\u6587\u6863CRUD\u64cd\u4f5c </li> <li>\u6bcf\u4e2a\u6587\u6863\u90fd\u6709\u4e00\u4e2a\u7248\u672c\u53f7\u53ef\u7528\u5e72\u5e76\u53d1\u63a7\u5236\u907f\u514d\u51b2\u7a81 </li> <li><code>_mget</code>\u548c<code>bulk API</code>\u53ef\u4ee5\u51cf\u5c11\u5efa\u7acb\u7f51\u7edc\u8fde\u63a5\u6240\u4ea7\u751f\u7684\u5f00\u9500 </li> <li><code>bulk API</code>\u6bcf\u884c\u9700\u8981\u6307\u5b9a<code>index</code>\u4fe1\u606f\u4e5f\u53ef\u4ee5\u5728<code>URI</code>\u4e2d\u6307\u5b9a\u30027\u5f00\u59cb\u4e0d\u9700\u8981\u6307\u5b9a<code>Type</code></li> <li>\u5355\u6b21\u6279\u91cf\u64cd\u4f5c\u6570\u636e\u91cf\u4e0d\u5b9c\u8fc7\u5927\u4ee5\u514d\u5f15\u53d1\u6027\u80fd\u95ee\u9898 </li> </ul>"},{"location":"chap3/3ES_ReverseIndex/","title":"\u7b2c\u4e09\u8282 \u5012\u6392\u7d22\u5f15","text":""},{"location":"chap3/3ES_ReverseIndex/#1","title":"1\u3001\u5012\u6392\u7d22\u5f15\u5165\u95e8","text":""},{"location":"chap3/3ES_ReverseIndex/#1-1","title":"1-1 \u6b63\u6392\u4e0e\u5012\u6392\u7d22\u5f15","text":"<ul> <li>\u76ee\u5f55 - \u6b63\u6392</li> </ul> <p>\u5feb\u901f\u67e5\u627e\u201cbenchmarking\u201d\u6240\u5728\u7684\u9875\u9762 </p> <ul> <li>\u7d22\u5f15\u9875 - \u5012\u6392</li> </ul> <p></p>"},{"location":"chap3/3ES_ReverseIndex/#1-2","title":"1-2 \u56fe\u4e66\u548c\u641c\u7d22\u5f15\u64ce\u7684\u7c7b\u6bd4","text":"<ul> <li>\u56fe\u4e66 <ul> <li>\u6b63\u6392\u7d22\u5f15\u4e00\u76ee\u5f55\u9875 </li> <li>\u5012\u6392\u7d22\u5f15\u4e00\u7d22\u5f15\u9875 </li> </ul> </li> <li>\u641c\u7d22\u5f15\u64ce<ul> <li>\u6b63\u6392\u7d22\u5f15\u4e00\u6587\u6863Id\u5230\u6587\u6863\u5185\u5bb9\u548c\u5355\u8bcd\u7684\u5173\u8054 </li> <li>\u5012\u6392\u7d22\u5f15\u4e00\u5355\u8bcd\u5230\u6587\u6863Id\u7684\u5173\u7cfb </li> </ul> </li> </ul>"},{"location":"chap3/3ES_ReverseIndex/#1-3","title":"1-3 \u6b63\u6392\u7d22\u5f15\u548c\u5012\u6392\u7d22\u5f15","text":""},{"location":"chap3/3ES_ReverseIndex/#1-4","title":"1-4 \u5012\u6392\u7d22\u5f15\u7684\u6838\u5fc3\u7ec4\u6210","text":"<p>\u5012\u6392\u7d22\u5f15\u5305\u542b\u4e24\u4e2a\u90e8\u5206 </p> <ul> <li>\u5355\u8bcd\u8bcd\u5178(Term Dictionay\uff09\u8bb0\u5f55\u6240\u6709\u6587\u6863\u7684\u5355\u8bcd\uff0c\u8bb0\u5f55\u5355\u8bcd\u5230\u5012\u6392\u5217\u8868\u7684\u5173\u8054\u5173\u7cfb<ul> <li>\u5355\u8bcd\u8bcd\u5178\u822c\u6bd4\u8f83\u5927\uff0c\u53ef\u4ee5\u9047\u8fc7B\uff0b\u6811\u6216\u54c8\u5e0c\u62c9\u94fe\u6cd5\u5b9e\u73b0 \uff0c \u4ee5\u6ee1\u8db3\u9ad8\u6027\u80fd\u7684\u63d2\u5165\u4e0e\u67e5\u8be2</li> </ul> </li> <li>\u5012\u6392\u5217\u8868(Posting List) - \u8bb0\u5f55\u4e86\u5355\u8bcd\u5bf9\u5e94\u7684\u6587\u6863\u7ed3\u5408, \u7531\u5012\u6392\u7d22\u5f15\u9879\u7ec4\u6210  <ul> <li>\u5012\u6392\u7d22\u5f15\u9879(Posting)<ul> <li>\u6587\u6863ID </li> <li>\u8bcd\u9891TF - \u8be5\u5355\u8bcd\u5728\u6587\u6863\u4e2d\u51fa\u73b0\u7684\u6b21\u6570\uff0c\u7528\u4e8e\u76f8\u5173\u80dc\u8bc4\u5206 </li> <li>\u4f4d\u7f6e\uff08Position) - \u5355\u8bcd\u5728\u6587\u6863\u4e2d\u5206\u8bcd\u7684\u4f4d\u7f6e\u3002\u7528\u4e8e\u8bed\u53e5\u641c\u7d22(phrase query) </li> <li>\u504f\u79fb (Offset) - \u8bb0\u5f55\u5355\u8bcd\u7684\u5f00\u59cb\u7ed3\u675f\u4f4d\u7f6e\u5b9e\u73b0\u9ad8\u4eae\u663e\u793a </li> </ul> </li> </ul> </li> </ul> <p></p>"},{"location":"chap3/3ES_ReverseIndex/#1-5-elasticsearch","title":"1-5 Elasticsearch\u7684\u5012\u6392\u7d22\u5f15","text":"<ul> <li>Elasticserach\u7684JSON\u6587\u6863\u4e2d\u7684\u6bcf\u4e2a\u5b57\u6bb5, \u90fd\u6709\u81ea\u5df1\u7684\u5012\u6392\u7d22\u5f15 <ul> <li>\u53ef\u4ee5\u6307\u5b9a\u5bf9\u67d0\u4e9b\u5b57\u6bb5\u4e0d\u505a\u7d22\u5f15 <ul> <li>\u4f18\u70b9\uff1a \u8282\u7701\u5b58\u50a8\u7a7a\u95f4</li> <li>\u7f3a\u70b9\uff1a\u5b57\u6bb5\u65e0\u6cd5\u641c\u7d22</li> </ul> </li> </ul> </li> </ul> <pre><code>POST _analyze\n{\n  \"analyzer\": \"standard\",\n  \"text\": \"Mastering Elasticsearch\"\n}\n\nPOST _analyze\n{\n  \"analyzer\": \"standard\",\n  \"text\": \"Elasticsearch Server\"\n}\n\nPOST _analyze\n{\n  \"analyzer\": \"standard\",\n  \"text\": \"Elasticsearch Essentials\"\n}\n</code></pre>"},{"location":"chap3/4ES_Analyzer/","title":"\u7b2c\u56db\u8282 \u4f7f\u7528\u5206\u6790\u5668\u8fdb\u884c\u5206\u8bcd","text":""},{"location":"chap3/4ES_Analyzer/#1analysisanalyzer","title":"1\u3001Analysis\u4e0eAnalyzer","text":"<ul> <li><code>Analysis</code> - \u6587\u672c\u5206\u6790\u662f\u628a\u5168\u6587\u672c\u8f6c\u6362\u4e00\u7cfb\u5217\u5355\u8bcd\uff08<code>term / token</code>) \u7684\u8fc7\u7a0b\uff0c\u4e5f\u53eb\u5206\u8bcd </li> <li><code>Analysis</code>\u662f\u901a\u8fc7<code>Analyzer</code>\u6765\u5b9e\u73b0\u7684 <ul> <li>\u53ef\u4f7f\u7528<code>Elasticsearch</code>\u5185\u7f6e\u7684\u5206\u6790\u5668\uff0f\u6216\u8005\u6309\u9700\u5b9a\u5236\u5316\u5206\u6790\u5668 </li> </ul> </li> <li>\u9664\u4e86\u5728\u6570\u636e\u5199\u5165\u65f6\u8f6c\u6362\u8bcd\u6761\uff0c\u5339\u914d<code>Query</code>\u8bed\u53e5\u65f6\u5019\u4e5f\u9700\u8981\u7528\u76f8\u540c\u7684\u5206\u6790\u5668\u5bf9\u67e5\u8be2\u8bed\u53e5\u8fdb\u884c\u5206\u6790 </li> </ul>"},{"location":"chap3/4ES_Analyzer/#2analyzer","title":"2\u3001Analyzer\u7684\u7ec4\u6210","text":"<p>\u5206\u8bcd\u5668\u662f\u4e13\u95e8\u5904\u7406\u5206\u8bcd\u7684\u7ec4\u4ef6\uff0cAnalyzer\u7531\u4e09\u90e8\u5206\u7ec4\u6210 </p> <ul> <li><code>Character Filters</code>\uff08\u9488\u5bf9\u539f\u59cb\u6587\u672c\u5904\u7406\u4f8b\u5982\u53bb\u9664html) </li> <li><code>Tokenizer</code> (\u6309\u7167\u89c4\u5219\u5207\u5206\u4e3a\u5355\u8bcd\uff09</li> <li><code>Token Filter</code>\uff08\u5c06\u5207\u5206\u7684\u7684\u5355\u8bcd\u8fdb\u884c\u52a0\u5de5\uff0c\u5c0f\u5199\uff0c\u5220\u9664stopwords,\u589e\u52a0\u540c\u4e49\u8bcd\uff09 </li> </ul> <p></p>"},{"location":"chap3/4ES_Analyzer/#3elasticsearch","title":"3\u3001Elasticsearch\u7684\u5185\u7f6e\u5206\u8bcd\u5668","text":"<ul> <li>Standard Analyzer\u9ed8\u8ba4\u5206\u8bcd\u5668\u6309\u8bcd\u5207\u5206\u5c0f\u5199\u5904\u7406 </li> <li>Simple Analyzer\u4e00\u6309\u7167\u975e\u5b57\u6bcd\u5207\u5206\uff08\u7b26\u53f7\u88ab\u8fc7\u6ee4\uff09\u5c0f\u5199\u5904\u7406 </li> <li>Stop Analyzer\u4e00\u5c0f\u5199\u5904\u7406\u505c\u7528\u8bcd\u8fc7\u6ee4(the, a, is\uff09 </li> <li>Whitespace Analyzer\u6309\u7167\u7a7a\u683c\u5207\u5206\u4e0d\u8f6c\u5c0f\u5199 </li> <li>Keyword Analyzer \u4e0d\u5206\u8bcd\u76f4\u63a5\u5c06\u8f93\u5165\u5f53\u4f5c\u8f93\u51fa </li> <li>Pattern Analyzer\u6b63\u5219\u8868\u8fbe\u5f0f\u9ed8\u8ba4<code>\\W+</code>\uff08\u975e\u5b57\u7b26\u5206\u9694\uff09 </li> <li>Language\u63d0\u4f9b\u4e8630\u591a\u79cd\u5e38\u89c1\u8bed\u8a00\u7684\u5206\u8bcd\u5668 </li> <li>Customer Analyzer\u81ea\u5b9a\u4e49\u5206\u8bcd\u5668 </li> </ul>"},{"location":"chap3/4ES_Analyzer/#4_analyzer-api","title":"4\u3001\u4f7f\u7528<code>_analyzer API</code>","text":"<ul> <li>\u76f4\u63a5\u6307\u5b9aAnalyzer\u8fdb\u884c\u6d4b\u8bd5 </li> <li>\u6307\u5b9a\u7d22\u5f15\u7684\u5b57\u6bb5\u8fdb\u884c\u6d4b\u8bd5 </li> <li>\u81ea\u5b9a\u4e49\u5206\u8bcd\u8d77\u8fdb\u884c\u6d4b\u8bd5 </li> </ul> <pre><code>GET _analyze\n{\n  \"analyzer\": \"standard\",\n  \"text\": \"2 running Quick brown-foxes leap over lazy dogs in the summer evening.\"\n}\n</code></pre> <pre><code>{\n  \"tokens\" : [\n    {\n      \"token\" : \"2\",\n      \"start_offset\" : 0,\n      \"end_offset\" : 1,\n      \"type\" : \"&lt;NUM&gt;\",\n      \"position\" : 0\n    },\n    {\n      \"token\" : \"running\",\n      \"start_offset\" : 2,\n      \"end_offset\" : 9,\n      \"type\" : \"&lt;ALPHANUM&gt;\",\n      \"position\" : 1\n    },\n    {\n      \"token\" : \"quick\",\n      \"start_offset\" : 10,\n      \"end_offset\" : 15,\n      \"type\" : \"&lt;ALPHANUM&gt;\",\n      \"position\" : 2\n    },\n    {\n      \"token\" : \"brown\",\n      \"start_offset\" : 16,\n      \"end_offset\" : 21,\n      \"type\" : \"&lt;ALPHANUM&gt;\",\n      \"position\" : 3\n    },\n        ...\n}\n</code></pre>"},{"location":"chap3/4ES_Analyzer/#5standard-analyzer","title":"5\u3001Standard Analyzer","text":"<ul> <li>\u9ed8\u8ba4\u5206\u8bcd\u5668 </li> <li>\u6309\u8bcd\u5207\u5206 </li> <li>\u5c0f\u5199\u5904\u7406 </li> </ul>"},{"location":"chap3/4ES_Analyzer/#6simple-analyzer","title":"6\u3001Simple Analyzer","text":"<ul> <li>\u6309\u7167\u975e\u5b57\u6bcd\u5207\u5206\u975e\u5b57\u6bcd\u7684\u90fd\u88ab\u53bb\u9664 </li> <li>\u5c0f\u5199\u5904\u7406 </li> </ul> <pre><code>#simpe\nGET _analyze\n{\n  \"analyzer\": \"simple\",\n  \"text\": \"2 running Quick brown-foxes leap over lazy dogs in the summer evening.\"\n}\n</code></pre> <pre><code>...\n{\n      \"token\" : \"quick\",\n      \"start_offset\" : 10,\n      \"end_offset\" : 15,\n      \"type\" : \"word\",\n      \"position\" : 1\n    },\n...\n</code></pre>"},{"location":"chap3/4ES_Analyzer/#7white-analyzer","title":"7\u3001White Analyzer","text":"<ul> <li>\u6309\u7167\u7a7a\u683c\u5207\u5206 </li> </ul> <pre><code>#whitespace\nGET _analyze\n{\n  \"analyzer\": \"whitespace\",\n  \"text\": \"2 running Quick brown-foxes leap over lazy dogs in the summer evening.\"\n}\n</code></pre> <pre><code>  {\n      \"token\" : \"brown-foxes\",\n      \"start_offset\" : 16,\n      \"end_offset\" : 27,\n      \"type\" : \"word\",\n      \"position\" : 3\n    },\n</code></pre>"},{"location":"chap3/4ES_Analyzer/#8stop-analyzer","title":"8\u3001Stop Analyzer","text":"<ul> <li>\u76f8\u6bd4Simple Analyzer </li> <li>\u591a\u4e86stop filter <ul> <li>\u4f1a\u628athe, a, is\u7b49\u4fee\u9970\u6027\u8c03\u8bed\u53bb\u9664 </li> </ul> </li> </ul> <pre><code>GET _analyze\n{\n  \"analyzer\": \"stop\",\n  \"text\": \"2 running Quick brown-foxes leap over lazy dogs in the summer evening.\"\n}\n</code></pre> <pre><code>...\n{\n      \"token\" : \"dogs\",\n      \"start_offset\" : 43,\n      \"end_offset\" : 47,\n      \"type\" : \"word\",\n      \"position\" : 7\n    },\n    {\n      \"token\" : \"summer\",\n      \"start_offset\" : 55,\n      \"end_offset\" : 61,\n      \"type\" : \"word\",\n      \"position\" : 10\n    },\n    {\n      \"token\" : \"evening\",\n      \"start_offset\" : 62,\n      \"end_offset\" : 69,\n      \"type\" : \"word\",\n      \"position\" : 11\n    }\n...\n</code></pre> <ul> <li>dogs / summer / evening</li> </ul>"},{"location":"chap3/4ES_Analyzer/#9keyword-analyzer","title":"9\u3001Keyword Analyzer","text":"<ul> <li>\u4e0d\u5206\u8bcd\u76f4\u63a5\u5c06\u8f93\u5165\u5f53\u4e00\u4e2aterm\u8f93\u51fa </li> </ul> <pre><code>#keyword\nGET _analyze\n{\n  \"analyzer\": \"keyword\",\n  \"text\": \"2 running Quick brown-foxes leap over lazy dogs in the summer evening.\"\n}\n</code></pre> <pre><code>{\n  \"tokens\" : [\n    {\n      \"token\" : \"2 running Quick brown-foxes leap over lazy dogs in the summer evening.\",\n      \"start_offset\" : 0,\n      \"end_offset\" : 70,\n      \"type\" : \"word\",\n      \"position\" : 0\n    }\n  ]\n}\n</code></pre>"},{"location":"chap3/4ES_Analyzer/#10pattern-analyzer","title":"10\u3001Pattern Analyzer","text":"<ul> <li>\u901a\u8fc7\u6b63\u5219\u8868\u8fbe\u5f0f\u8fdb\u884c\u5206\u8bcd </li> <li>\u9ed8\u8ba4\u662f<code>\\W+</code>\u975e\u5b57\u7b26\u7684\u7b26\u53f7\u8fdb\u884c\u5206\u9694 </li> </ul> <pre><code>GET _analyze\n{\n  \"analyzer\": \"pattern\",\n  \"text\": \"2 running Quick brown-foxes leap over lazy dogs in the summer evening.\"\n}\n</code></pre>"},{"location":"chap3/4ES_Analyzer/#11language-analyzer","title":"11\u3001Language Analyzer","text":"<pre><code>#english\nGET _analyze\n{\n  \"analyzer\": \"english\",\n  \"text\": \"2 running Quick brown-foxes leap over lazy dogs in the summer evening.\"\n}\n</code></pre>"},{"location":"chap3/4ES_Analyzer/#12","title":"12\u3001\u4e2d\u6587\u5206\u8bcd\u7684\u96be\u70b9","text":"<ul> <li>\u4e2d\u6587\u53e5\u5b50\u5207\u5206\u6210\u4e00\u4e2a\u4e00\u4e2a\u8bcd\uff08\u4e0d\u662f\u4e00\u4e2a\u4e2a\u5b57\uff09 </li> <li>\u82f1\u6587\u4e2d\u5355\u8bcd\u6709\u81ea\u7136\u7684\u7a7a\u683c\u4f5c\u4e3a\u5206\u9694 </li> <li>\u4e00\u53e5\u4e2d\u6587\u5728\u4e0d\u540c\u7684\u4e0a\u4e0b\u6587\u6709\u4e0d\u901a\u7684\u7406\u89e3 <ul> <li>\u8fd9\u4e2a\u82f9\u679c\uff0c\u4e0d\u5927\u597d\u5403\uff0f\u8fd9\u4e2a\u82f9\u679c\uff0c\u4e0d\u5927\uff0c\u597d\u5403 </li> </ul> </li> <li>\u4e00\u4e9b\u4f8b\u5b50 <ul> <li>\u4ed6\u8bf4\u7684\u786e\u5b9e\u5728\u7406\uff0f\u8fd9\u4e8b\u7684\u786e\u5b9a\u4e0d\u4e0b\u6765 </li> </ul> </li> </ul> <ul> <li>\u9700\u8981\u5b89\u88c5Plugin<ul> <li><code>Elasticsearch-plugin install analysis-icu</code> </li> </ul> </li> <li>\u63d0\u4f9b\u4e86Unicode\u7684\u652f\u6301\u66f4\u597d\u7684\u652f\u6301\u4e9a\u6d32\u8bed\u8a00 </li> </ul> <p>Docker\u4e2d\u5b89\u88c5icu-plugin</p> <pre><code>$ docker exec -it es7_01 bash\n# pwd\n/usr/share/elasticsearch\n\n# bin/elasticsearch-plugin install analysis-icu\n-&gt; Installing analysis-icu\n-&gt; Downloading analysis-icu from elastic\n[=================================================] 100%?? \n-&gt; Installed analysis-icu\n\n$ docker exec -it es7_02 bash\n# bin/elasticsearch-plugin install analysis-icu\n-&gt; Installing analysis-icu\n-&gt; Downloading analysis-icu from elastic\n[=================================================] 100%?? \n-&gt; Installed analysis-icu \n</code></pre> <pre><code>docker restart es7_01\ndocker restart es7_02\n</code></pre> <pre><code>http://192.168.33.12:9200/_cat/plugins\nes79   analysis-icu 7.9.1\nes7_02 analysis-icu 7.9.1\n</code></pre> <p>icu_analyzer</p> <pre><code>POST _analyze\n{\n  \"analyzer\": \"icu_analyzer\",\n  \"text\": \"\u4ed6\u8bf4\u7684\u786e\u5b9e\u5728\u7406\u201d\"\n}\n</code></pre> <pre><code>{\n  \"tokens\" : [\n    {\n      \"token\" : \"\u4ed6\",\n      \"start_offset\" : 0,\n      \"end_offset\" : 1,\n      \"type\" : \"&lt;IDEOGRAPHIC&gt;\",\n      \"position\" : 0\n    },\n    {\n      \"token\" : \"\u8bf4\u7684\",\n      \"start_offset\" : 1,\n      \"end_offset\" : 3,\n      \"type\" : \"&lt;IDEOGRAPHIC&gt;\",\n      \"position\" : 1\n    },\n    {\n      \"token\" : \"\u786e\u5b9e\",\n      \"start_offset\" : 3,\n      \"end_offset\" : 5,\n      \"type\" : \"&lt;IDEOGRAPHIC&gt;\",\n      \"position\" : 2\n    },\n    {\n      \"token\" : \"\u5728\",\n      \"start_offset\" : 5,\n      \"end_offset\" : 6,\n      \"type\" : \"&lt;IDEOGRAPHIC&gt;\",\n      \"position\" : 3\n    },\n    {\n      \"token\" : \"\u7406\",\n      \"start_offset\" : 6,\n      \"end_offset\" : 7,\n      \"type\" : \"&lt;IDEOGRAPHIC&gt;\",\n      \"position\" : 4\n    }\n  ]\n}\n</code></pre> <pre><code>\"\u4ed6\",\"\u8bf4\u7684\",\"\u786e\u5b9e\",\"\u5728\",\"\u7406\"\n</code></pre>"},{"location":"chap3/4ES_Analyzer/#13","title":"13\u3001\u66f4\u591a\u7684\u4e2d\u6587\u5206\u8bcd\u5668","text":"<p>IK</p> <ul> <li>\u652f\u6301\u81ea\u5b9a\u4e49\u8c03\u5e93\u652f\u6301\u70ed\u66f4\u65b0\u5206\u8bcd\u5b87\u5178 </li> </ul> <p>https://github.com/medcl/elasticsearch-analysis-ik</p> <p>THULAC</p> <p>http://thulac.thunlp.org/</p> <p>ik\u5206\u6790\u5668\u5b89\u88c5\uff1a</p> <pre><code>bin/elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.9.1/elasticsearch-analysis-ik-7.9.1.zip\n</code></pre> <pre><code> bin/elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.9.1/elasticsearch-analysis-ik-7.9.1.zip\n-&gt; Installing https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.9.1/elasticsearch-analysis-ik-7.9.1.zip\n-&gt; Downloading https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.9.1/elasticsearch-analysis-ik-7.9.1.zip\n[=================================================] 100%?? \n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n@     WARNING: plugin requires additional permissions     @\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n* java.net.SocketPermission * connect,resolve\nSee http://docs.oracle.com/javase/8/docs/technotes/guides/security/permissions.html\nfor descriptions of what these permissions allow and the associated risks.\n\nContinue with installation? [y/N]y\n-&gt; Installed analysis-ik\n</code></pre> <pre><code>docker restart es7_01\ndocker restart es7_02\n</code></pre> <pre><code>es7_02 analysis-icu 7.9.1\nes7_02 analysis-ik  7.9.1\nes79   analysis-icu 7.9.1\nes79   analysis-ik  7.9.1\n</code></pre> <ul> <li><code>ik_smart</code>: \u4f1a\u505a\u6700\u7c97\u7c92\u5ea6\u7684\u62c6\u5206\uff0c\u6bd4\u5982\u4f1a\u5c06\u201c\u4e2d\u534e\u4eba\u6c11\u5171\u548c\u56fd\u56fd\u6b4c\u201d\u62c6\u5206\u4e3a\u201c\u4e2d\u534e\u4eba\u6c11\u5171\u548c\u56fd,\u56fd\u6b4c\u201d\uff0c\u9002\u5408 Phrase \u67e5\u8be2</li> <li><code>ik_max_word:</code> \u4f1a\u5c06\u6587\u672c\u505a\u6700\u7ec6\u7c92\u5ea6\u7684\u62c6\u5206\uff0c\u6bd4\u5982\u4f1a\u5c06\u201c\u4e2d\u534e\u4eba\u6c11\u5171\u548c\u56fd\u56fd\u6b4c\u201d\u62c6\u5206\u4e3a\u201c\u4e2d\u534e\u4eba\u6c11\u5171\u548c\u56fd,\u4e2d\u534e\u4eba\u6c11,\u4e2d\u534e,\u534e\u4eba,\u4eba\u6c11\u5171\u548c\u56fd,\u4eba\u6c11,\u4eba,\u6c11,\u5171\u548c\u56fd,\u5171\u548c,\u548c,\u56fd\u56fd,\u56fd\u6b4c\u201d\uff0c\u4f1a\u7a77\u5c3d\u5404\u79cd\u53ef\u80fd\u7684\u7ec4\u5408\uff0c\u9002\u5408 Term Query\uff1b</li> <li>\u751f\u6210\u7d22\u5f15\u65f6\u5019\u53ef\u4ee5\u4f7f\u7528<code>ik_max_word</code>\uff0c\u67e5\u8be2\u7684\u65f6\u5019\u4f7f\u7528<code>ik_smart</code></li> </ul> <pre><code>POST _analyze\n{\n  \"analyzer\": \"ik_smart\",\n  \"text\": \"\u4e2d\u534e\u4eba\u6c11\u5171\u548c\u56fd\u56fd\u6b4c\"\n}\n</code></pre> <pre><code>{\n  \"tokens\" : [\n    {\n      \"token\" : \"\u4e2d\u534e\u4eba\u6c11\u5171\u548c\u56fd\",\n      \"start_offset\" : 0,\n      \"end_offset\" : 7,\n      \"type\" : \"CN_WORD\",\n      \"position\" : 0\n    },\n    {\n      \"token\" : \"\u56fd\u6b4c\",\n      \"start_offset\" : 7,\n      \"end_offset\" : 9,\n      \"type\" : \"CN_WORD\",\n      \"position\" : 1\n    }\n  ]\n}\n</code></pre> <pre><code>POST _analyze\n{\n  \"analyzer\": \"ik_max_word\",\n  \"text\": \"\u4e2d\u534e\u4eba\u6c11\u5171\u548c\u56fd\u56fd\u6b4c\"\n}\n\n</code></pre> <pre><code>{\n  \"tokens\" : [\n    {\n      \"token\" : \"\u4e2d\u534e\u4eba\u6c11\u5171\u548c\u56fd\",\n      \"start_offset\" : 0,\n      \"end_offset\" : 7,\n      \"type\" : \"CN_WORD\",\n      \"position\" : 0\n    },\n    {\n      \"token\" : \"\u4e2d\u534e\u4eba\u6c11\",\n      \"start_offset\" : 0,\n      \"end_offset\" : 4,\n      \"type\" : \"CN_WORD\",\n      \"position\" : 1\n    },\n    {\n      \"token\" : \"\u4e2d\u534e\",\n      \"start_offset\" : 0,\n      \"end_offset\" : 2,\n      \"type\" : \"CN_WORD\",\n      \"position\" : 2\n    },\n    {\n      \"token\" : \"\u534e\u4eba\",\n      \"start_offset\" : 1,\n      \"end_offset\" : 3,\n      \"type\" : \"CN_WORD\",\n      \"position\" : 3\n    },\n    {\n      \"token\" : \"\u4eba\u6c11\u5171\u548c\u56fd\",\n      \"start_offset\" : 2,\n      \"end_offset\" : 7,\n      \"type\" : \"CN_WORD\",\n      \"position\" : 4\n    },\n    {\n      \"token\" : \"\u4eba\u6c11\",\n      \"start_offset\" : 2,\n      \"end_offset\" : 4,\n      \"type\" : \"CN_WORD\",\n      \"position\" : 5\n    },\n    {\n      \"token\" : \"\u5171\u548c\u56fd\",\n      \"start_offset\" : 4,\n      \"end_offset\" : 7,\n      \"type\" : \"CN_WORD\",\n      \"position\" : 6\n    },\n    {\n      \"token\" : \"\u5171\u548c\",\n      \"start_offset\" : 4,\n      \"end_offset\" : 6,\n      \"type\" : \"CN_WORD\",\n      \"position\" : 7\n    },\n    {\n      \"token\" : \"\u56fd\",\n      \"start_offset\" : 6,\n      \"end_offset\" : 7,\n      \"type\" : \"CN_CHAR\",\n      \"position\" : 8\n    },\n    {\n      \"token\" : \"\u56fd\u6b4c\",\n      \"start_offset\" : 7,\n      \"end_offset\" : 9,\n      \"type\" : \"CN_WORD\",\n      \"position\" : 9\n    }\n  ]\n}\n</code></pre>"},{"location":"chap3/5ES_Search/","title":"\u7b2c\u4e94\u8282 ElasticSearch Search\u8bed\u53e5","text":""},{"location":"chap3/5ES_Search/#1search-api","title":"1\u3001Search API \u6982\u89c8","text":"<ul> <li>URI Search<ul> <li>\u5728URL\u4e2d\u4f7f\u7528\u67e5\u8be2\u53c2\u6570 </li> </ul> </li> <li>Request Body Search<ul> <li>\u4f7f\u7528<code>Elasticsearch</code>\u63d0\u4f9b\u7684\uff0c\u57fa\u4e8e<code>JSON</code>\u683c\u5f0f\u7684\u66f4\u52a0\u5b8c\u5907\u7684<code>Query Domain Specific Language (DSL)</code></li> </ul> </li> </ul>"},{"location":"chap3/5ES_Search/#1-1","title":"1-1\u3001\u6307\u5b9a\u67e5\u8be2\u7684\u7d22\u5f15","text":""},{"location":"chap3/5ES_Search/#1-2uri","title":"1-2\u3001URI\u67e5\u8be2","text":"<ul> <li>\u4f7f\u7528\"q\", \u6307\u5b9a\u67e5\u8be2\u5b57\u7b26\u4e32</li> <li>\"query string syntex\", <code>KV</code>\u952e\u503c\u5bf9 </li> </ul> <pre><code>GET kibana_sample_data_ecommerce/_search?q=customer_first_name:Eddie\n</code></pre> <p>Output</p> <pre><code>{\n  \"took\" : 114,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 1,\n    \"successful\" : 1,\n    \"skipped\" : 0,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : {\n      \"value\" : 100,\n      \"relation\" : \"eq\"\n    },\n    \"max_score\" : 4.016948,\n    \"hits\" : [\n      {\n        \"_index\" : \"kibana_sample_data_ecommerce\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"kw_fsnQBiZ4B72YzxCce\",\n        \"_score\" : 4.016948,\n        \"_source\" : {\n          \"category\" : [\n            \"Men's Clothing\"\n          ],\n          \"currency\" : \"EUR\",\n          \"customer_first_name\" : \"Eddie\",\n          \"customer_full_name\" : \"Eddie Underwood\",\n          \"customer_gender\" : \"MALE\",\n          \"customer_id\" : 38,\n...\n</code></pre> <pre><code>GET kibana*/_search?q=customer_first_name:Eddie\n</code></pre> <pre><code>{\n  \"took\" : 6,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 3,\n    \"successful\" : 3,\n    \"skipped\" : 0,\n    \"failed\" : 0\n  },\n ...\n</code></pre> <pre><code>GET /_all/_search?q=customer_first_name:Eddie\n</code></pre> <pre><code>{\n  \"took\" : 76,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 13,\n    \"successful\" : 13,\n    \"skipped\" : 0,\n    \"failed\" : 0\n  },\n  \"hits\n...\n</code></pre>"},{"location":"chap3/5ES_Search/#1-3request-body","title":"1-3\u3001Request Body","text":"<pre><code>#REQUEST Body\nPOST kibana_sample_data_ecommerce/_search\n{\n    \"profile\": true,\n    \"query\": {\n        \"match_all\": {}\n    }\n}\n</code></pre> <pre><code>{\n  \"took\" : 76,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 13,\n    \"successful\" : 13,\n    \"skipped\" : 0,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : {\n      \"value\" : 100,\n      \"relation\" : \"eq\"\n    },\n    \"max_score\" : 4.016948,\n    \"hits\" : [\n      {\n        \"_index\" : \"kibana_sample_data_ecommerce\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"kw_fsnQBiZ4B72YzxCce\",\n        \"_score\" : 4.016948,\n...\n</code></pre> <p>\u641c\u7d22\u7684Reponse</p> <p></p>"},{"location":"chap3/5ES_Search/#1-4relevance","title":"1-4\u3001\u641c\u7d22\u7684\u76f8\u5173\u6027Relevance","text":"<ul> <li>\u641c\u7d22\u662f\u7528\u6237\u548c\u641c\u7d22\u5f15\u64ce\u7684\u5bf9\u8bdd </li> <li>\u7528\u6237\u5173\u5fc3\u7684\u662f\u641c\u7d22\u7ed3\u679c\u7684\u76f8\u5173\u6027 <ul> <li>\u662f\u5426\u53ef\u4ee5\u627e\u5230\u6240\u6709\u76f8\u5173\u7684\u5185\u5bb9 </li> <li>\u6709\u591a\u5c11\u4e0d\u76f8\u5173\u7684\u5185\u5bb9\u88ab\u8fd4\u56de\u4e86 </li> <li>\u6587\u6863\u7684\u6253\u5206\u662f\u5426\u5408\u7406 </li> <li>\u7ed3\u5408\u4e1a\u52a1\u9700\u6c42\uff0c\u5e73\u8861\u7ed3\u679c\u6392\u540d </li> </ul> </li> </ul>"},{"location":"chap3/5ES_Search/#1-5web","title":"1-5\u3001Web\u641c\u7d22","text":"<ul> <li>Page Rank\u7b97\u6cd5 <ul> <li>\u4e0d\u4ec5\u4ec5\u662f\u5185\u5bb9 </li> <li>\u66f4\u91cd\u8981\u7684\u662f\u5185\u5bb9\u7684\u53ef\u4fe1\u5ea6 </li> </ul> </li> </ul> <p>\u7535\u5546\u641c\u7d22</p> <p>\u641c\u7d22\u5f15\u64ce\u626e\u6f14\u4e00\u9500\u552e\u7684\u89d2\u8272 </p> <ul> <li>\u63d0\u9ad8\u7528\u6237\u8d2d\u7269\u4f53\u9a8c </li> <li>\u63d0\u5347\u7f51\u7ad9\u9500\u552e\u4e1a\u7ee9 </li> <li>\u53bb\u5e93\u5b58 </li> </ul>"},{"location":"chap3/5ES_Search/#1-6","title":"1-6\u3001\u8861\u91cf\u76f8\u5173\u6027","text":"<ul> <li>Information Retrieval<ul> <li>Precision\uff08\u67e5\u51c6\u7387\uff09\u4e00\u5c3d\u53ef\u80fd\u8fd4\u56de\u8f83\u5c11\u7684\u65e0\u5173\u6587\u6863 </li> <li>Recall\uff08\u67e5\u5168\u7387\uff09\u4e00\u5c3d\u91cf\u8fd4\u56de\u8f83\u591a\u7684\u76f8\u5173\u6587\u6863 </li> <li>Ranking\u4e00\u662f\u5426\u80fd\u591f\u6309\u7167\u76f8\u5173\u5ea6\u8fdb\u884c\u6392\u5e8f\uff1f </li> </ul> </li> </ul>"},{"location":"chap3/5ES_Search/#1-7precisionrecall","title":"1-7\u3001Precision&amp;Recall","text":"<ul> <li>Precision\u4e00True Positive \uff0f\u5168\u90e8\u8fd4\u56de\u7684\u7ed3\u679c\uff08True and False Positives) </li> <li>Recall\u4e00True Positive/ \u6240\u6709\u5e94\u8be5\u8fd4\u56de\u7684\u7ed3\u679c (True positives+false Negtives)</li> </ul> <p>\u4f7f\u7528Elasticsearch\u7684\u67e5\u8be2\u548c\u76f8\u5173\u7684\u53c2\u6570\u6539\u5584\u641c\u7d22\u7684Precision\u548cRecall</p> <p></p>"},{"location":"chap3/5ES_Search/#2uri-search","title":"2\u3001URI Search\u8be6\u89e3","text":""},{"location":"chap3/5ES_Search/#2-1-uri-searchuri-query","title":"2-1 URI Search\u2014\u2014\u901a\u8fc7<code>URI query</code>\u5b9e\u73b0\u641c\u7d22","text":"<ul> <li><code>q</code> \u6307\u5b9a\u67e5\u8be2\u8bed\u53e5\uff0c\u4f7f\u7528<code>Query String Syntax</code> </li> <li><code>df</code>\u9ed8\u8ba4\u5b57\u6bb5\uff0c\u4e0d\u6307\u5b9a\u65f6 </li> <li><code>Sort</code>\u6392\u5e8f / <code>from</code>\u548c<code>size</code>\u7528\u4e8e\u5206\u9875 </li> <li><code>Profile</code>\u53ef\u4ee5\u67e5\u770b\u67e5\u8be2\u662f\u5982\u4f55\u88ab\u6267\u884c\u7684 </li> </ul> <pre><code>#\u57fa\u672c\u67e5\u8be2\nGET /movies/_search?q=2012&amp;df=title&amp;sort=year:desc&amp;from=0&amp;size=10&amp;timeout=1s\n</code></pre> <pre><code>{\n  \"took\" : 172,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 1,\n    \"successful\" : 1,\n    \"skipped\" : 0,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : {\n      \"value\" : 2,\n      \"relation\" : \"eq\"\n    },\n    \"max_score\" : null,\n    \"hits\" : [\n      {\n        \"_index\" : \"movies\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"105254\",\n        \"_score\" : null,\n        \"_source\" : {\n          \"genre\" : [\n            \"Adventure\",\n            \"Comedy\"\n          ],\n          \"title\" : \"Crystal Fairy &amp; the Magical Cactus and 2012\",\n          \"year\" : 2013,\n          \"id\" : \"105254\",\n          \"@version\" : \"1\"\n        },\n        \"sort\" : [\n          2013\n        ]\n      },\n      {\n        \"_index\" : \"movies\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"72378\",\n        \"_score\" : null,\n        \"_source\" : {\n          \"genre\" : [\n            \"Action\",\n            \"Drama\",\n            \"Sci-Fi\",\n            \"Thriller\"\n          ],\n          \"title\" : \"2012\",\n          \"year\" : 2009,\n          \"id\" : \"72378\",\n          \"@version\" : \"1\"\n        },\n        \"sort\" : [\n          2009\n        ]\n      }\n    ]\n  }\n}\n</code></pre>"},{"location":"chap3/5ES_Search/#profile","title":"\u5e26profile","text":"<pre><code>GET /movies/_search?q=2012&amp;df=title\n{\n    \"profile\":\"true\"\n}\n</code></pre>"},{"location":"chap3/5ES_Search/#2-2-query-string-syntax","title":"2-2 Query String Syntax","text":""},{"location":"chap3/5ES_Search/#2-2-1-vs","title":"2-2-1 \u6307\u5b9a\u5b57\u6bb5 v.s. \u6cdb\u67e5\u8be2","text":"<pre><code>* `q=title:2012/q=2O12`\n</code></pre> <pre><code>#\u6cdb\u67e5\u8be2\uff0c\u6b63\u5bf9_all,\u6240\u6709\u5b57\u6bb5\nGET /movies/_search?q=2012\n{\n    \"profile\":\"true\"\n}\n</code></pre> <pre><code>#\u6307\u5b9a\u5b57\u6bb5\nGET /movies/_search?q=title:2012&amp;sort=year:desc&amp;from=0&amp;size=10&amp;timeout=1s\n{\n    \"profile\":\"true\"\n}\n</code></pre> <pre><code># \u6cdb\u67e5\u8be2\nGET /movies/_search?q=title:2012\n{\n    \"profile\":\"true\"\n}\n</code></pre>"},{"location":"chap3/5ES_Search/#2-2-2-term-vs-phrase","title":"2-2-2 Term vs Phrase","text":"<ul> <li><code>Beautifual Mind</code>\u7b49\u6548\u4e8e<code>Beautiful OR Mind</code> </li> <li><code>\"Beautifual Mind\"</code>\u7b49\u6548\u4e8e<code>Beautiful AND Mind</code>, <code>Phrase</code>\u67e5\u8be2\u8fd8\u8981\u6c42\u524d\u540e\u987a\u5e8f\u4fdd\u5f85\u4e00\u81f4 </li> </ul> <pre><code># \u67e5\u627e\u7f8e\u4e3d\u5fc3\u7075, Mind\u4e3a\u6cdb\u67e5\u8be2\nGET /movies/_search?q=title:Beautiful Mind\n{\n    \"profile\":\"true\"\n}\n</code></pre>"},{"location":"chap3/5ES_Search/#2-2-3","title":"2-2-3 \u5206\u7ec4\u4e0e\u5f15\u53f7","text":"<ul> <li><code>title:(Beautiful AND Mind)</code></li> <li><code>title=\"Beautifual Mind\"</code></li> </ul> <pre><code>#\u4f7f\u7528\u5f15\u53f7\uff0cPhrase\u67e5\u8be2\nGET /movies/_search?q=title:\"Beautiful Mind\"\n{\n    \"profile\":\"true\"\n}\n</code></pre> <pre><code>#\u5206\u7ec4\uff0cBool\u67e5\u8be2\nGET /movies/_search?q=title:(Beautiful Mind)\n{\n    \"profile\":\"true\"\n}\n</code></pre>"},{"location":"chap3/5ES_Search/#2-2-4","title":"2-2-4 \u5e03\u5c14\u64cd\u4f5c","text":"<ul> <li><code>AND/OR/NOT</code> \u6216\u8005 <code>&amp;&amp; / || / !</code> <ul> <li>\u5fc5\u987b\u5927\u5199 </li> <li><code>title:(matrix NOT reloaded)</code> </li> </ul> </li> </ul> <pre><code>#\u5e03\u5c14\u64cd\u4f5c\u7b26\n# \u67e5\u627e\u7f8e\u4e3d\u5fc3\u7075\nGET /movies/_search?q=title:(Beautiful AND Mind)\n{\n    \"profile\":\"true\"\n}\n</code></pre> <pre><code># \u67e5\u627e\u7f8e\u4e3d\u5fc3\u7075\nGET /movies/_search?q=title:(Beautiful NOT Mind)\n{\n    \"profile\":\"true\"\n}\n</code></pre> <pre><code># \u67e5\u627e\u7f8e\u4e3d\u5fc3\u7075\nGET /movies/_search?q=title:(Beautiful %2BMind)\n{\n    \"profile\":\"true\"\n}\n</code></pre>"},{"location":"chap3/5ES_Search/#2-2-5","title":"2-2-5 \u5206\u7ec4","text":"<ul> <li>\u8868\u793a<code>must</code></li> <li>\u8868\u793a<code>must_not</code> </li> <li><code>title:(+matrix -reloaded)</code> </li> </ul>"},{"location":"chap3/5ES_Search/#2-2-6","title":"2-2-6 \u8303\u56f4\u67e5\u8be2","text":"<ul> <li> <p>\u533a\u95f4\u8868\u793a\uff1a<code>[]</code> \u95ed\u533a\u95f4,<code>{}</code>\u5f00\u533a\u95f4</p> <ul> <li><code>year:{2019 TO 2018]</code></li> <li><code>year:[\uff0a TO 2018]</code> </li> </ul> </li> <li> <p>\u7b97\u6570\u7b26\u53f7 </p> <ul> <li><code>year:&gt;2010</code> </li> <li><code>year:(&gt;2010 &amp;&amp; &lt;=2018)</code> </li> <li><code>year: (+&gt;2010 +&lt;=2018)</code></li> </ul> </li> </ul> <pre><code>#\u8303\u56f4\u67e5\u8be2 ,\u533a\u95f4\u5199\u6cd5\nGET /movies/_search?q=title:beautiful AND year:[2002 TO 2018%7D\n{\n    \"profile\":\"true\"\n}\n\n</code></pre> <p></p>"},{"location":"chap3/5ES_Search/#2-2-7","title":"2-2-7 \u901a\u914d\u7b26\u67e5\u8be2\uff08\u901a\u914d\u7b26\u67e5\u8be2\u6548\u7387\u4f4e, \u5360\u7528\u5185\u5b58\u5927,\u4e0d\u5efa\u8bae\u4f7f\u7528\u3002\u7279\u522b\u662f\u653e\u5728\u6700\u524d\u9762\uff09","text":"<ul> <li>?\u4ee3\u88681\u4e2a\u5b87\u7b26\uff0c\uff0a\u4ee3\u88680\u6216\u591a\u4e2a\u5b87\u7b26 <ul> <li><code>title:mi?d</code> </li> <li><code>title:be*</code> </li> </ul> </li> </ul> <pre><code>#\u901a\u914d\u7b26\u67e5\u8be2\nGET /movies/_search?q=title:b*\n{\n    \"profile\":\"true\"\n}\n</code></pre> <ul> <li> <p>\u6b63\u5219\u8868\u8fbe</p> <ul> <li><code>title:[bt]oy</code></li> </ul> </li> <li> <p>\u6a21\u7cca\u5339\u914d\u4e0e\u8fd1\u4f3c\u67e5\u8be2</p> <ul> <li><code>title:befutifl~1</code></li> <li><code>title:\"lord rings\"~2</code></li> </ul> </li> </ul> <pre><code>//\u6a21\u7cca\u5339\u914d&amp;\u8fd1\u4f3c\u5ea6\u5339\u914d\nGET /movies/_search?q=title:beautifl~1\n{\n    \"profile\":\"true\"\n}\n</code></pre> <p></p> <pre><code>GET /movies/_search?q=title:\"Lord Rings\"~2\n{\n    \"profile\":\"true\"\n}\n</code></pre> <p></p> <ul> <li>https://www.elastic.co/guide/en/elasticsearch/reference/7.0/search-uri-request.html</li> <li>https://www.elastic.co/guide/en/elasticsearch/reference/7.0/search-search.html</li> </ul>"},{"location":"chap3/5ES_Search/#3request-body-query-dsl","title":"3\u3001Request Body &amp; Query DSL\u4ecb\u7ecd","text":""},{"location":"chap3/5ES_Search/#3-1-request-body-search","title":"3-1 Request Body Search","text":"<ul> <li>\u5c06\u67e5\u8be2\u8bed\u53e5\u901a\u8fc7 HTTP Requedt Body\u53d1\u9001\u7ed9Elasticsearch </li> <li>Query DSL </li> </ul> <pre><code>#\u67e5\u8be2movies\u5206\u9875\nPOST /movies,404_idx/_search?ignore_unavailable=true\n{\n  \"profile\": true,\n    \"query\": {\n        \"match_all\": {}\n    }\n}\n</code></pre> <ul> <li><code>ignore_unavailable=true</code>\uff0c\u53ef\u4ee5\u5ffd\u7565\u5c1d\u8bd5\u8bbf\u95ee\u4e0d\u5b58\u5728\u7684\u7d22\u5f15<code>\u201c404_idx\u201d</code>\u5bfc\u81f4\u7684\u62a5\u9519</li> </ul>"},{"location":"chap3/5ES_Search/#3-1-1","title":"3-1-1\u5206\u9875","text":"<ul> <li>From\u4ece0\u5f00\u59cb\uff0c\u9ed8\u8ba4\u8fd4\u56de10\u4e2a\u7ed3\u679c </li> <li>\u83b7\u53d6\u9760\u540e\u7684\u7ffb\u9875\u6210\u672c\u8f83\u9ad8 </li> </ul> <pre><code>POST /kibana_sample_data_ecommerce/_search\n{\n  \"from\":10,\n  \"size\":20,\n  \"query\":{\n    \"match_all\": {}\n  }\n}\n</code></pre>"},{"location":"chap3/5ES_Search/#3-1-2","title":"3-1-2 \u6392\u5e8f","text":"<ol> <li>\u6700\u597d\u5728\u201c\u6570\u5b57\u578b\u201d\u4e0e\"\u65e5\u671f\u578b\"\u5b57\u6bb5\u4e0a\u6392\u5e8f </li> <li>\u56e0\u4e3a\u5bf9\u4e8e\u591a\u503c\u7c7b\u578b\u6216\u5206\u6790\u8fc7\u7684\u5b57\u6bb5\u6392\u5e8f\uff0c\u7cfb\u7edf\u4f1a\u9009\u4e00\u4e2a\u503c\uff0c\u65e0\u6cd5\u5f97\u77e5\u8be5\u503c </li> </ol> <pre><code>#\u5bf9\u65e5\u671f\u6392\u5e8f\nPOST kibana_sample_data_ecommerce/_search\n{\n  \"sort\":[{\"order_date\":\"desc\"}],\n  \"query\":{\n    \"match_all\": {}\n  }\n\n}\n</code></pre> <p><code>\"sort\":[{\"order_date\":\"desc\"}],</code></p> <pre><code>...\n\"order_date\" : \"2020-10-10T23:45:36+00:00\",\n...\n\"order_date\" : \"2020-10-10T23:31:12+00:00\",\n...\n\"order_date\" : \"2020-10-10T23:22:34+00:00\",\n...\n\"order_date\" : \"2020-10-10T23:15:22+00:00\",\n</code></pre>"},{"location":"chap3/5ES_Search/#3-1-3-_source-filerting","title":"3-1-3 <code>_source filerting</code>","text":"<ul> <li>\u5982\u679c <code>_source</code>\u6ca1\u6709\u5b58\u50a8 \uff0c\u90a3\u5c31\u53ea\u8fd4\u56de\u5339\u914d\u7684\u6587\u6863\u7684\u5143\u6570\u636e </li> <li><code>_source</code>\u652f\u6301\u4f7f\u7528\u901a\u914d\u7b26\uff0c <code>_source[\"name*\",\"desc*\"]</code></li> </ul> <pre><code>#source filtering\nPOST kibana_sample_data_ecommerce/_search\n{\n  \"_source\":[\"order_date\"],\n  \"query\":{\n    \"match_all\": {}\n  }\n}\n</code></pre> <p><code>\"_source\":[\"order_date\"],</code></p> <pre><code>{\n  \"took\" : 28,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 1,\n    \"successful\" : 1,\n    \"skipped\" : 0,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : {\n      \"value\" : 4675,\n      \"relation\" : \"eq\"\n    },\n    \"max_score\" : 1.0,\n    \"hits\" : [\n      {\n        \"_index\" : \"kibana_sample_data_ecommerce\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"kw_fsnQBiZ4B72YzxCce\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"order_date\" : \"2020-10-05T09:28:48+00:00\"\n        }\n      },\n      {\n        \"_index\" : \"kibana_sample_data_ecommerce\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"lA_fsnQBiZ4B72YzxCce\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"order_date\" : \"2020-10-04T21:59:02+00:00\"\n        }\n      },\n      {\n        \"_index\" : \"kibana_sample_data_ecommerce\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"lQ_fsnQBiZ4B72YzxCce\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"order_date\" : \"2020-10-04T22:32:10+00:00\"\n        }\n      },\n      {\n        \"_index\" : \"kibana_sample_data_ecommerce\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"lg_fsnQBiZ4B72YzxCce\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"order_date\" : \"2020-10-04T22:58:05+00:00\"\n        }\n      },\n      {\n        \"_index\" : \"kibana_sample_data_ecommerce\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"lw_fsnQBiZ4B72YzxCce\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"order_date\" : \"2020-09-28T03:48:58+00:00\"\n        }\n      },\n      {\n        \"_index\" : \"kibana_sample_data_ecommerce\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"mA_fsnQBiZ4B72YzxCce\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"order_date\" : \"2020-09-27T21:44:38+00:00\"\n        }\n      },\n      {\n        \"_index\" : \"kibana_sample_data_ecommerce\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"mQ_fsnQBiZ4B72YzxCce\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"order_date\" : \"2020-09-21T09:27:22+00:00\"\n        }\n      },\n      {\n        \"_index\" : \"kibana_sample_data_ecommerce\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"mg_fsnQBiZ4B72YzxCce\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"order_date\" : \"2020-10-05T02:19:41+00:00\"\n        }\n      },\n      {\n        \"_index\" : \"kibana_sample_data_ecommerce\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"mw_fsnQBiZ4B72YzxCce\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"order_date\" : \"2020-09-27T00:59:02+00:00\"\n        }\n      },\n      {\n        \"_index\" : \"kibana_sample_data_ecommerce\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"nA_fsnQBiZ4B72YzxCce\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"order_date\" : \"2020-10-05T03:41:46+00:00\"\n        }\n      }\n    ]\n  }\n}\n</code></pre>"},{"location":"chap3/5ES_Search/#3-1-4","title":"3-1-4 \u811a\u672c\u5b57\u6bb5","text":"<p>\u7528\u4f8b\uff1a\u8ba2\u5355\u4e2d\u6709\u4e0d\u540c\u7684\u6c47\u7387\uff0c \u9700\u8981\u7ed3\u5408\u6c47\u7387\u5bf9\uff0c\u8ba2\u5355\u4ef7\u683c\u8fdb\u884c\u6392\u5e8f </p> <pre><code>#\u811a\u672c\u5b57\u6bb5\nGET kibana_sample_data_ecommerce/_search\n{\n  \"script_fields\": {\n    \"new_field\": {\n      \"script\": {\n        \"lang\": \"painless\",\n        \"source\": \"doc['order_date'].value+'hello'\"\n      }\n    }\n  },\n  \"query\": {\n    \"match_all\": {}\n  }\n}\n</code></pre> <p></p> <p></p>"},{"location":"chap3/5ES_Search/#3-1-5-match","title":"3-1-5 \u4f7f\u7528\u67e5\u8be2\u8868\u8fbe\u5f0f\u4e00Match","text":"<pre><code>POST movies/_search\n{\n  \"query\": {\n    \"match\": {\n      \"title\": {\n        \"query\": \"last christmas\",\n        \"operator\": \"and\"\n      }\n    }\n  }\n}\n</code></pre> <p>Output: <code>last christmas</code>\u8fde\u5728\u4e00\u8d77\u8f93\u51fa</p> <pre><code>   \"hits\" : [\n      {\n        \"_index\" : \"movies\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"147372\",\n        \"_score\" : 8.835976,\n        \"_source\" : {\n          \"genre\" : [\n            \"Adventure\",\n            \"Drama\",\n            \"Fantasy\",\n            \"Sci-Fi\"\n          ],\n          \"title\" : \"Doctor Who: Last Christmas\",\n          \"year\" : 2014,\n          \"id\" : \"147372\",\n          \"@version\" : \"1\"\n        }\n      }\n    ]\n</code></pre> <pre><code>POST movies/_search\n{\n  \"query\": {\n    \"match_phrase\": {\n      \"title\":{\n        \"query\": \"one love\"\n\n      }\n    }\n  }\n}\n</code></pre> <p>Output: <code>one love</code>\u8fde\u5728\u4e00\u8d77\u8f93\u51fa</p> <pre><code>{\n  \"took\" : 43,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 1,\n    \"successful\" : 1,\n    \"skipped\" : 0,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : {\n      \"value\" : 0,\n      \"relation\" : \"eq\"\n    },\n    \"max_score\" : null,\n    \"hits\" : [ ]\n  }\n}\n</code></pre> <pre><code>POST movies/_search\n{\n  \"query\": {\n    \"match_phrase\": {\n      \"title\":{\n        \"query\": \"one love\",\n        \"slop\": 1\n\n      }\n    }\n  }\n}\n</code></pre> <p><code>\"slop\": 1</code>: \u4e2d\u95f4\u53ef\u6709\u4e00\u4e2a\u63d2\u5165\u5355\u8bcd</p> <p>Output: <code>one love</code>\u4e2d\u95f4\u53ef\u6709\u4e00\u4e2a\u63d2\u5165\u5355\u8bcd</p> <pre><code>   \"max_score\" : 5.3235893,\n    \"hits\" : [\n      {\n        \"_index\" : \"movies\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"113829\",\n        \"_score\" : 5.3235893,\n        \"_source\" : {\n          \"genre\" : [\n            \"Comedy\",\n            \"Drama\",\n            \"Romance\"\n          ],\n          \"title\" : \"One I Love, The\",\n          \"year\" : 2014,\n          \"id\" : \"113829\",\n          \"@version\" : \"1\"\n        }\n      }\n    ]\n</code></pre>"},{"location":"chap3/5ES_Search/#4query-stringsimple-query-string","title":"4\u3001Query String&amp;Simple Query String\u67e5\u8be2","text":"<ul> <li>Query String</li> <li>Simple Query String</li> </ul> <pre><code>PUT /users/_doc/1\n{\n  \"name\":\"Xi Jacob\",\n  \"about\":\"java, golang, node, swift, elasticsearch\"\n}\n\nPUT /users/_doc/2\n{\n  \"name\":\"John Jacob\",\n  \"about\":\"Hadoop\"\n}\n</code></pre> <p>Output:</p> <pre><code>{\n  \"_index\" : \"users\",\n  \"_type\" : \"_doc\",\n  \"_id\" : \"2\",\n  \"_version\" : 1,\n  \"result\" : \"created\",\n  \"_shards\" : {\n    \"total\" : 2,\n    \"successful\" : 2,\n    \"failed\" : 0\n  },\n  \"_seq_no\" : 14,\n  \"_primary_term\" : 4\n}\n</code></pre>"},{"location":"chap3/5ES_Search/#4-1-query-string-query","title":"4-1 Query String Query","text":"<ul> <li>\u7c7b\u4f3cURI Query </li> </ul> <pre><code>POST users/_search\n{\n  \"query\": {\n    \"query_string\": {\n      \"default_field\": \"name\",\n      \"query\": \"Xi AND Jacob\"\n    }\n  }\n}\n</code></pre> <pre><code>POST users/_search\n{\n  \"query\": {\n    \"query_string\": {\n      \"fields\":[\"name\",\"about\"],\n      \"query\": \"(Xi AND Jacob) OR (Java AND Elasticsearch)\"\n    }\n  }\n}\n</code></pre> <p>Output:</p> <pre><code>\"hits\" : [\n      {\n        \"_index\" : \"users\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"1\",\n        \"_score\" : 0.8754687,\n        \"_source\" : {\n          \"name\" : \"Xi Jacob\",\n          \"about\" : \"java, golang, node, swift, elasticsearch\"\n        }\n      }\n    ]\n</code></pre>"},{"location":"chap3/5ES_Search/#4-1-simple-query-string-query","title":"4-1 Simple Query String Query","text":"<ul> <li>\u7c7b\u4f3cQuery String\uff0c\u4f46\u662f\u4f1a\u5ffd\u7565\u9519\u8bef\u7684\u8bed\u6cd5\uff0c \u540c\u65f6\u53ea\u652f\u6301\u90e8\u5206\u67e5\u8be2\u8bed\u6cd5 </li> <li>\u4e0d\u652f\u6301<code>AND OR NOT</code>\uff0c\u4f1a\u5f53\u4f5c\u5b57\u7b26\u4e32\u5904\u7406 </li> <li><code>Term</code>\u4e4b\u95f4\u9ed8\u8ba4\u7684\u5173\u7cfb\u662f<code>OR</code>\uff0c\u53ef\u4ee5\u6307\u5b9a <code>Operator</code> </li> <li>\u652f\u6301 \u90e8\u5206\u903b\u8f91 <ul> <li><code>\uff0b</code>\u66ff\u4ee3<code>AND</code> </li> <li><code>|</code>\u66ff\u4ee3<code>OR</code></li> <li><code>-</code>\u66ff\u4ee3<code>NOT</code></li> </ul> </li> </ul> <pre><code>#Simple Query \u9ed8\u8ba4\u7684operator\u662f Or\nPOST users/_search\n{\n  \"query\": {\n    \"simple_query_string\": {\n      \"query\": \"Xi AND Jacob\",\n      \"fields\": [\"name\"]\n    }\n  }\n}\n</code></pre> <ul> <li>Simple Query \u9ed8\u8ba4\u7684operator\u662f Or</li> <li>And\uff1a\u5e76\u6ca1\u6709\u8d77\u5230\u4f5c\u7528</li> </ul> <pre><code> \"max_score\" : 0.8754687,\n    \"hits\" : [\n      {\n        \"_index\" : \"users\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"1\",\n        \"_score\" : 0.8754687,\n        \"_source\" : {\n          \"name\" : \"Xi Jacob\",\n          \"about\" : \"java, golang, node, swift, elasticsearch\"\n        }\n      },\n      {\n        \"_index\" : \"users\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"2\",\n        \"_score\" : 0.18232156,\n        \"_source\" : {\n          \"name\" : \"John Jacob\",\n          \"about\" : \"Hadoop\"\n        }\n      }\n    ]\n</code></pre> <pre><code>POST users/_search\n{\n  \"query\": {\n    \"simple_query_string\": {\n      \"query\": \"Xi Jacob\",\n      \"fields\": [\"name\"],\n      \"default_operator\": \"AND\"\n    }\n  }\n}\n</code></pre> <p><code>\"default_operator\": \"AND\"</code>: AND \u8d77\u5230\u4e86\u4f5c\u7528</p> <pre><code>\"hits\" : {\n    \"total\" : {\n      \"value\" : 1,\n      \"relation\" : \"eq\"\n    },\n    \"max_score\" : 0.8754687,\n    \"hits\" : [\n      {\n        \"_index\" : \"users\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"1\",\n        \"_score\" : 0.8754687,\n        \"_source\" : {\n          \"name\" : \"Xi Jacob\",\n          \"about\" : \"java, golang, node, swift, elasticsearch\"\n        }\n      }\n    ]\n</code></pre> <p></p>"},{"location":"chap3/5ES_Search/#4-2-query-stringsimple-query-string-on-movies","title":"4-2 Query String&amp;Simple Query String on Movies","text":""},{"location":"chap3/5ES_Search/#4-2-1-single-field-query-string","title":"4-2-1 Single field Query String","text":"<pre><code>GET /movies/_search\n{\n    \"profile\": true,\n    \"query\":{\n        \"query_string\":{\n            \"default_field\": \"title\",\n            \"query\": \"Beafiful AND Mind\"\n        }\n    }\n}\n</code></pre>"},{"location":"chap3/5ES_Search/#4-2-2-multiple-simple-query-string","title":"4-2-2 Multiple Simple Query String","text":"<pre><code># \u591afields\nGET /movies/_search\n{\n    \"profile\": true,\n    \"query\":{\n        \"query_string\":{\n            \"fields\":[\n                \"title\",\n                \"year\"\n            ],\n            \"query\": \"2012\"\n        }\n    }\n}\n</code></pre>"},{"location":"chap3/5ES_Search/#4-2-3-simple-query-string","title":"4-2-3  Simple Query String","text":"<pre><code>GET /movies/_search\n{\n    \"profile\":true,\n    \"query\":{\n        \"simple_query_string\":{\n            \"query\":\"Beautiful +mind\",\n            \"fields\":[\"title\"]\n        }\n    }\n}\n</code></pre>"},{"location":"chap3/5ES_Search/#5es-query","title":"5\u3001ES Query \u672c\u7ae0\u603b\u7ed3","text":""},{"location":"chap3/5ES_Search/#5-1-es-query","title":"5-1 ES Query \u5206\u7c7b:","text":"<ul> <li>URI\u67e5\u8be2</li> <li>DSL\u67e5\u8be2</li> </ul>"},{"location":"chap3/5ES_Search/#5-2","title":"5-2 \u4e09\u79cd\u67e5\u8be2\u7684\u533a\u522b","text":"<ul> <li><code>query</code> \u529f\u80fd\u5f3a\u5927\u6613\u51fa\u9519</li> <li><code>query_string</code> \u529f\u80fd\u7b80\u5355\u7075\u6d3b\u6027\u4f4e</li> <li><code>simple_query_string</code> \u529f\u80fd\u7b80\u5355\u7075\u6d3b\u6027\u4f4e</li> </ul>"},{"location":"chap3/6ES_Mapping/","title":"\u7b2c\u516d\u8282 ElasticSearch Mapping \u4ecb\u7ecd","text":""},{"location":"chap3/6ES_Mapping/#1dynamic-mapping","title":"1\u3001Dynamic Mapping\u548c\u5e38\u89c1\u5b57\u6bb5\u7c7b\u578b","text":"<p>\u672c\u8282\u77e5\u8bc6\u70b9</p> <ul> <li>Mapping&amp;Dynamic Mapping </li> <li>\u5b57\u6bb5\u7c7b\u578b\u81ea\u52a8\u8bc6\u522b </li> <li>\u63a7\u5236Mapping\u7684Dynamic\u5c5e\u6027</li> </ul>"},{"location":"chap3/6ES_Mapping/#1-1-mapping","title":"1-1 \u4ec0\u4e48\u662fMapping","text":"<ul> <li>Mapping\u7c7b\u4f3c\u6570\u636e\u5e93\u4e2d\u7684schema\u7684\u5b9a\u4e49\uff0c\u4f5c\u7528\u5982\u4e0b <ul> <li>\u5b9a\u4e49\u7d22\u5f15\u4e2d\u7684\u5b57\u6bb5\u7684\u540d\u79f0 </li> <li>\u5b9a\u4e49\u5b57\u6bb5\u7684\u6570\u636e\u7c7b\u578b\uff0c\u4f8b\u5982\u5b57\u7b26\u4e32\uff0c\u6570\u5b57\uff0c\u5e03\u5c14\u2026\u2026 </li> <li>\u5b57\u6bb5\uff0c\u5012\u6392\u7d22\u5f15\u7684\u76f8\u5173\u914d\u7f6e\uff0c(Analyzed or Not Analyzed Analyzer)</li> </ul> </li> <li>Mapping\u4f1a\u628aJSON\u6587\u6863\u6620\u5c04\u6210Lucene\u6240\u9700\u8981\u7684\u6241\u5e73\u683c\u5f0f </li> <li>\u4e00\u4e2aMapping\u5c5e\u4e8e\u4e00\u4e2a\u7d22\u5f15\u7684Type <ul> <li>\u6bcf\u4e2a\u6587\u6863\u90fd\u5c5e\u4e8e\u4e00\u4e2aType </li> <li>\u4e00\u4e2aType\u6709\u4e00\u4e2aMapping\u5b9a\u4e49 </li> <li>7.0\u5f00\u59cb\uff0c\u4e0d\u9700\u8981\u5728Mapping\u5b9a\u4e49\u4e2d\u6307\u5b9atype\u4fe1\u606f </li> </ul> </li> </ul> <p>Mapping\u4e2d\u7684\u5b57\u6bb5\u4e00\u65e6\u8bbe\u5b9a\u540e\uff0c\u7981\u6b62\u76f4\u63a5\u4fee\u6539\u3002\u56e0\u4e3a\u5012\u6392\u7d22\u5f15\u751f\u6210\u540e\u4e0d\u5141\u8bb8\u76f4\u63a5\u4fee\u6539\u3002\u9700\u8981\u91cd\u65b0\u5efa\u7acb\u65b0\u7684\u7d22\u5f15\uff0c\u505areindex\u64cd\u4f5c\u3002</p> <p>\u7c7b\u4f3c\u6570\u636e\u5e93\u4e2d\u7684\u8868\u7ed3\u6784\u5b9a\u4e49\uff0c\u4e3b\u8981\u4f5c\u7528</p> <ul> <li>\u5b9a\u4e49\u6240\u4ee5\u4e0b\u7684\u5b57\u6bb5\u540d\u5b57</li> <li>\u5b9a\u4e49\u5b57\u6bb5\u7684\u7c7b\u578b</li> <li>\u5b9a\u4e49\u5012\u6392\u7d22\u5f15\u76f8\u5173\u7684\u914d\u7f6e\uff08\u662f\u5426\u88ab\u7d22\u5f15\uff1f\u91c7\u7528\u7684Analyzer\uff09</li> </ul> <p>\u5bf9\u65b0\u589e\u5b57\u6bb5\u7684\u5904\u7406 true false strict</p> <p>\u5728object\u4e0b\uff0c\u652f\u6301\u505adynamic\u7684\u5c5e\u6027\u7684\u5b9a\u4e49</p>"},{"location":"chap3/6ES_Mapping/#1-2","title":"1-2 \u5b57\u6bb5\u7684\u6570\u636e\u7c7b\u578b","text":"<ul> <li> <p>\u7b80\u5355\u7c7b\u578b</p> <ul> <li>Text/Keyword </li> <li>Date</li> <li>Integer/Floating </li> <li>Boolean </li> <li>IPv4&amp;IPv6 </li> </ul> </li> <li> <p>\u590d\u6742\u7c7b\u578b\u4e00\u5bf9\u8c61\u548c\u5d4c\u5957\u5bf9\u8c61</p> <ul> <li>\u5bf9\u8c61\u7c7b\u578b\uff0f\u5d4c\u5957\u7c7b\u578b </li> </ul> </li> <li> <p>\u7279\u6b8a\u7c7b\u578b</p> <ul> <li><code>geo_point</code>&amp;<code>geo_shape</code>/<code>percolator</code></li> </ul> </li> </ul>"},{"location":"chap3/6ES_Mapping/#1-3-dynamic-mapping","title":"1-3 \u4ec0\u4e48\u662fDynamic Mapping","text":"<ul> <li>\u5728\u5199\u5165\u6587\u6863\u65f6\u5019\uff0c\u5982\u679c\u7d22\u5f15\u4e0d\u5b58\u5728\uff0c\u4f1a\u81ea\u52a8\u521b\u5efa\u7d22\u5f15 </li> <li>Dynamic Mapping\u7684\u673a\u5236\uff0c\u4f7f\u5f97\u6211\u4eec\u65e0\u9700\u624b\u52a8\u5b9a\u4e49Mappings</li> <li>Elasticsearch\u4f1a\u81ea\u52a8\u6839\u636e\u6587\u6863\u4fe1\u606f\uff0c\u63a8\u7b97\u51fa\u5b57\u6bb5\u7684\u7c7b\u578b </li> <li>\u4f46\u662f\u6709\u65f6\u5019\u4f1a\u63a8\u7b97\u7684\u4e0d\u5bf9\uff0c\u4f8b\u5982\u5730\u7406\u4f4d\u7f6e\u4fe1\u606f </li> <li>\u5f53\u7c7b\u578b\u5982\u679c\u8bbe\u7f6e\u4e0d\u5bf9\u65f6\uff0c\u4f1a\u5bfc\u81f4\u4e00\u4e9b\u529f\u80fd\u65e0\u6cd5\u6b63\u5e38\u8fd0\u884c\uff0c\u4f8b\u5982 Range\u67e5\u8be2 </li> </ul>"},{"location":"chap3/6ES_Mapping/#1-4","title":"1-4 \u7c7b\u578b\u7684\u81ea\u52a8\u8bc6\u522b","text":"<p>Demo</p> <ul> <li>\u5199\u5165\u6587\u6863\uff0c\u770bElasticsearch\u4f1a\u5982\u4f55\u63a8\u5bfc\u6570\u636e\u7c7b\u578b <ul> <li>\u6570\u5b57\u7528\u5f15\u53f7\uff0c\u9ed8\u8ba4\u5f53\u4e0bTEXT</li> <li>\u65e5\u671f\u683c\u5f0f\u4f1a\u63a8\u5bfc\u6210Date </li> </ul> </li> <li>\u6709\u4e00\u4e9b\u7c7b\u578b\u4f1a\u63a8\u5bfc\u51fa\u9519\uff0c\u4f8b\u5982\u5730\u7406\u4f4d\u7f6e\u4fe1\u606f\u3002 </li> </ul>"},{"location":"chap3/6ES_Mapping/#mapping","title":"\u5199\u5165\u6587\u6863\uff0c\u67e5\u770b Mapping","text":"<pre><code>#\u5199\u5165\u6587\u6863\uff0c\u67e5\u770b Mapping\nPUT mapping_test/_doc/1\n{\n  \"firstName\":\"Chan\",\n  \"lastName\": \"Jackie\",\n  \"loginDate\":\"2018-07-24T10:29:48.103Z\"\n}\n</code></pre> <p>Output</p> <pre><code>{\n  \"_index\" : \"mapping_test\",\n  \"_type\" : \"_doc\",\n  \"_id\" : \"1\",\n  \"_version\" : 1,\n  \"result\" : \"created\",\n  \"_shards\" : {\n    \"total\" : 2,\n    \"successful\" : 1,\n    \"failed\" : 0\n  },\n  \"_seq_no\" : 0,\n  \"_primary_term\" : 1\n}\n</code></pre>"},{"location":"chap3/6ES_Mapping/#mapping_1","title":"\u67e5\u770b Mapping\u6587\u4ef6","text":"<pre><code>#\u67e5\u770b Mapping\u6587\u4ef6\nGET mapping_test/_mapping\n</code></pre> <p>Output</p> <pre><code>{\n  \"mapping_test\" : {\n    \"mappings\" : {\n      \"properties\" : {\n        \"firstName\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n            }\n          }\n        },\n        \"lastName\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n            }\n          }\n        },\n        \"loginDate\" : {\n          \"type\" : \"date\"\n        }\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"chap3/6ES_Mapping/#delete-index","title":"Delete index","text":"<pre><code>DELETE mapping_test\n</code></pre> <pre><code>{\n  \"acknowledged\" : true\n}\n</code></pre>"},{"location":"chap3/6ES_Mapping/#dynamic-mapping","title":"dynamic mapping\uff0c\u63a8\u65ad\u5b57\u6bb5\u7684\u7c7b\u578b","text":"<pre><code>PUT mapping_test/_doc/1\n{\n    \"uid\" : \"123\",\n    \"isVip\" : false,\n    \"isAdmin\": \"true\",\n    \"age\":19,\n    \"heigh\":180\n}\n</code></pre> <pre><code>{\n  \"_index\" : \"mapping_test\",\n  \"_type\" : \"_doc\",\n  \"_id\" : \"1\",\n  \"_version\" : 1,\n  \"result\" : \"created\",\n  \"_shards\" : {\n    \"total\" : 2,\n    \"successful\" : 2,\n    \"failed\" : 0\n  },\n  \"_seq_no\" : 0,\n  \"_primary_term\" : 1\n}\n</code></pre> <pre><code>#\u67e5\u770b Dynamic\nGET mapping_test/_mapping\n\n{\n  \"mapping_test\" : {\n    \"mappings\" : {\n      \"properties\" : {\n        \"age\" : {\n          \"type\" : \"long\"\n        },\n        \"heigh\" : {\n          \"type\" : \"long\"\n        },\n        \"isAdmin\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n            }\n          }\n        },\n        \"isVip\" : {\n          \"type\" : \"boolean\"\n        },\n        \"uid\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n            }\n          }\n        }\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"chap3/6ES_Mapping/#1-5-mapping","title":"1-5 \u80fd\u5426\u66f4\u6539Mapping\u7684\u5b57\u6bb5\u7c7b\u578b","text":"<p>\u4e24\u79cd\u60c5\u51b5 </p> <ul> <li>\u65b0\u589e\u52a0\u5b57\u6bb5 <ul> <li>Dynamic\u8bbe\u4e3atrue\u65f6\uff0c\u4e00\u65e6\u6709\u65b0\u589e\u5b57\u6bb5\u7684\u6587\u6863\u5199\u5165\uff0cMapping\u4e5f\u540c\u65f6\u88ab\u66f4\u65b0 </li> <li>Dynamic\u8bbe\u4e3afalse, Mapping\u4e0d\u4f1a\u88ab\u66f4\u65b0\uff0c\u65b0\u589e\u5b57\u6bb5\u7684\u6570\u636e\u65e0\u6cd5\u88ab\u7d22\u5f15 ,\u4f46\u662f\u4fe1\u606f\u4f1a\u51fa\u73b0\u5728<code>_source</code>\u4e2d </li> <li>Dynamic\u8bbe\u7f6e\u6210Strict\uff0c\u6587\u6863\u5199\u5165\u5931\u8d25 </li> </ul> </li> <li>\u5bf9\u5df2\u6709\u5b57\u6bb5\uff0c\u4e00\u65e6\u5df2\u7ecf\u6709\u6570\u636e\u5199\u5165\uff0c\u5c31\u4e0d\u518d\u652f\u6301\u4fee\u6539\u5b57\u6bb5\u5b9a\u4e49 <ul> <li>Lucene\u5b9e\u73b0\u7684\u5012\u6392\u7d22\u5f15\uff0c\u4e00\u65e6\u751f\u6210\u540e\uff0c\u5c31\u4e0d\u5141\u8bb8\u4fee\u6539 </li> </ul> </li> <li>\u5982\u679c\u5e0c\u671b\u6539\u53d8\u5b57\u6bb5\u7c7b\u578b\uff0c\u5fc5\u987bReindex API\uff0c\u91cd\u5efa\u7d22\u5f15 </li> </ul> <p>\u539f\u56e0 </p> <ul> <li>\u5982\u679c\u4fee\u6539\u4e86\u5b57\u6bb5\u7684\u6570\u636e\u7c7b\u578b\uff0c\u4f1a\u5bfc\u81f4\u5df2\u88ab\u7d22\u5f15\u7684\u5c5e\u4e8e\u65e0\u6cd5\u88ab\u641c\u7d22 </li> <li>\u4f46\u662f\u5982\u679c\u662f\u589e\u52a0\u65b0\u7684\u5b57\u6bb5\uff0c\u5c31\u4e0d\u4f1a\u6709\u8fd9\u6837\u7684\u5f71\u54cd </li> </ul>"},{"location":"chap3/6ES_Mapping/#1-6-dynamic-mappings","title":"1-6 \u63a7\u5236Dynamic Mappings","text":"<ul> <li>\u5f53dynamic\u88ab\u8bbe\u7f6e\u6210false\u65f6\u5019\uff0c\u5b58\u5728\u65b0\u589e\u5b57\u6bb5\u7684\u6570\u636e\u5199\u5165\uff0c\u8be5\u6570\u636e\u53ef\u4ee5\u88ab\u7d22\u5f15\u4f46\u662f\u65b0\u589e\u5b57\u6bb5\u88ab\u4e22\u5f03 </li> <li>\u5f53\u8bbe\u7f6e\u6210Strict\u6a21\u5f0f\u65f6\u5019\uff0c\u6570\u636e\u5199\u5165\u76f4\u63a5\u51fa\u9519 </li> </ul>"},{"location":"chap3/6ES_Mapping/#mappingdynamic","title":"\u9ed8\u8ba4Mapping\u652f\u6301dynamic\uff0c\u5199\u5165\u7684\u6587\u6863\u4e2d\u52a0\u5165\u65b0\u7684\u5b57\u6bb5","text":"<pre><code>PUT dynamic_mapping_test/_doc/1\n{\n  \"newField\":\"someValue\"\n}\n</code></pre> <pre><code>GET dynamic_mapping_test/_mapping\n\n{\n  \"dynamic_mapping_test\" : {\n    \"mappings\" : {\n      \"properties\" : {\n        \"newField\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n            }\n          }\n        }\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"chap3/6ES_Mapping/#_source","title":"\u8be5\u5b57\u6bb5\u53ef\u4ee5\u88ab\u641c\u7d22\uff0c\u6570\u636e\u4e5f\u5728<code>_source</code>\u4e2d\u51fa\u73b0","text":"<pre><code>POST dynamic_mapping_test/_search\n{\n  \"query\":{\n    \"match\":{\n      \"newField\":\"someValue\"\n    }\n  }\n}\n</code></pre> <p>Output</p> <pre><code>\"hits\" : [\n      {\n        \"_index\" : \"dynamic_mapping_test\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"1\",\n        \"_score\" : 0.2876821,\n        \"_source\" : {\n          \"newField\" : \"someValue\"\n        }\n      }\n    ]\n</code></pre>"},{"location":"chap3/6ES_Mapping/#dynamic-false","title":"\u4fee\u6539\u4e3adynamic false","text":"<pre><code>PUT dynamic_mapping_test/_mapping\n{\n  \"dynamic\": false\n}\n</code></pre> <pre><code>{\n  \"acknowledged\" : true\n}\n</code></pre>"},{"location":"chap3/6ES_Mapping/#anotherfield","title":"\u65b0\u589e anotherField","text":"<pre><code>PUT dynamic_mapping_test/_doc/10\n{\n  \"anotherField\":\"someValue\"\n}\n</code></pre> <p><code>\"dynamic\": false</code>: \u53ef\u4ee5\u63d2\u5165\uff0c\u65e0\u6cd5\u88ab\u641c\u7d22\u5230</p> <pre><code>POST dynamic_mapping_test/_search\n{\n  \"query\":{\n    \"match\":{\n      \"anotherField\":\"someValue\"\n    }\n  }\n}\n</code></pre>"},{"location":"chap3/6ES_Mapping/#dynamicfalse","title":"\u8be5\u5b57\u6bb5\u4e0d\u53ef\u4ee5\u88ab\u641c\u7d22\uff0c\u56e0\u4e3adynamic\u5df2\u7ecf\u88ab\u8bbe\u7f6e\u4e3afalse","text":"<pre><code>{\n  \"took\" : 168,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 1,\n    \"successful\" : 1,\n    \"skipped\" : 0,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : {\n      \"value\" : 0,\n      \"relation\" : \"eq\"\n    },\n    \"max_score\" : null,\n    \"hits\" : [ ]\n  }\n}\n</code></pre> <pre><code>GET dynamic_mapping_test/_doc/10\n</code></pre> <pre><code>{\n  \"_index\" : \"dynamic_mapping_test\",\n  \"_type\" : \"_doc\",\n  \"_id\" : \"10\",\n  \"_version\" : 1,\n  \"_seq_no\" : 1,\n  \"_primary_term\" : 1,\n  \"found\" : true,\n  \"_source\" : {\n    \"anotherField\" : \"someValue\"\n  }\n}\n</code></pre>"},{"location":"chap3/6ES_Mapping/#strict","title":"\u4fee\u6539\u4e3astrict","text":"<pre><code>PUT dynamic_mapping_test/_mapping\n{\n  \"dynamic\": \"strict\"\n}\n</code></pre> <pre><code>{\n  \"acknowledged\" : true\n}\n</code></pre>"},{"location":"chap3/6ES_Mapping/#http-code-400","title":"\u5199\u5165\u6570\u636e\u51fa\u9519\uff0cHTTP Code 400","text":"<pre><code>PUT dynamic_mapping_test/_doc/12\n{\n  \"lastField\":\"value\"\n}\n</code></pre> <pre><code>{\n  \"error\" : {\n    \"root_cause\" : [\n      {\n        \"type\" : \"strict_dynamic_mapping_exception\",\n        \"reason\" : \"mapping set to strict, dynamic introduction of [lastField] within [_doc] is not allowed\"\n      }\n    ],\n    \"type\" : \"strict_dynamic_mapping_exception\",\n    \"reason\" : \"mapping set to strict, dynamic introduction of [lastField] within [_doc] is not allowed\"\n  },\n  \"status\" : 400\n}\n</code></pre> <pre><code>GET dynamic_mapping_test/_doc/12\n\n{\n  \"_index\" : \"dynamic_mapping_test\",\n  \"_type\" : \"_doc\",\n  \"_id\" : \"12\",\n  \"found\" : false\n}\n</code></pre>"},{"location":"chap3/6ES_Mapping/#2mapping","title":"2\u3001\u663e\u5f0fMapping\u8bbe\u7f6e\u4e0e\u5e38\u89c1\u53c2\u6570\u4ecb\u7ecd","text":""},{"location":"chap3/6ES_Mapping/#2-1-mapping","title":"2-1 \u5982\u4f55\u663e\u793a\u5b9a\u4e49\u4e00\u4e2aMapping","text":""},{"location":"chap3/6ES_Mapping/#2-2-mapping","title":"2-2 \u81ea\u5b9a\u4e49Mapping\u7684\u4e00\u4e9b\u5efa\u8bae","text":"<ul> <li>\u53ef\u4ee5\u53c2\u8003API\u624b\u518c\uff0c\u7eaf\u624b\u5199 </li> <li>\u4e3a\u4e86\u51cf\u5c11\u8f93\u5165\u7684\u5de5\u4f5c\u91cf\uff0c\u51cf\u5c11\u51fa\u9519\u6982\u7387\uff0c\u53ef\u4ee5\u4f9d\u7167\u4ee5\u4e0b\u6b65\u9aa4 <ul> <li>\u521b\u5efa\u4e00\u4e2a\u4e34\u65f6\u7684index\uff0c\u5199\u5165\u4e00\u4e9b\u6837\u672c\u6570\u636e </li> <li>\u901a\u8fc7\u8bbf\u95eeMapping API\u83b7\u5f97\u8be5\u4e34\u65f6\u6587\u4ef6\u7684\u52a8\u6001Mapping\u5b9a\u4e49 </li> <li>\u4fee\u6539\u540e\u7528\uff0c\u4f7f\u7528\u8be5\u914d\u7f6e\u521b\u5efa\u4f60\u7684\u7d22\u5f15 </li> <li>\u5220\u9664\u4e34\u65f6\u7d22\u5f15 </li> </ul> </li> </ul> <pre><code>#\u8bbe\u7f6e Mobile index \u4e3a false\nDELETE users\n\n\nPUT users\n{\n    \"mappings\" : {\n      \"properties\" : {\n        \"firstName\" : {\n          \"type\" : \"text\"\n        },\n        \"lastName\" : {\n          \"type\" : \"text\"\n        },\n        \"mobile\" : {\n          \"type\" : \"text\",\n          \"index\": false\n        }\n      }\n    }\n}\n</code></pre> <p>Output :</p> <pre><code>{\n  \"acknowledged\" : true,\n  \"shards_acknowledged\" : true,\n  \"index\" : \"users\"\n}\n</code></pre> <pre><code>PUT users/_doc/1\n{\n  \"firstName\":\"Jacob\",\n  \"lastName\": \"Xi\",\n  \"mobile\": \"12345678\"\n}\n</code></pre> <pre><code>POST /users/_search\n{\n  \"query\": {\n    \"match\": {\n      \"mobile\":\"12345678\"\n    }\n  }\n}\n</code></pre> <p></p>"},{"location":"chap3/6ES_Mapping/#2-3-index-options","title":"2-3 Index Options","text":"<ul> <li>\u56db\u79cd\u4e0d\u540c\u7ea7\u522b\u7684Index Options\u914d\u7f6e\uff0c\u53ef\u4ee5\u63a7\u5236\u5012\u6392\u7d22\u5f15\u8bb0\u5f55\u7684\u5185\u5bb9 <ul> <li>docs\u2014\u2014\u8bb0\u5f55<code>doc id</code></li> <li>freqs\u2014\u2014\u8bb0\u5f55<code>doc id</code>\u548c<code>term frequencies</code> </li> <li>positions\u4e00\u8bb0\u5f55<code>doc id</code> / <code>term frequencies</code> / <code>term position</code> </li> <li>offsets\u4e00<code>doc id</code>/<code>term frequencies</code>/<code>term posistion</code>/<code>character offects</code> </li> </ul> </li> <li>Text\u7c7b\u578b\u9ed8\u8ba4\u8bb0\u5f55postions\uff0c\u5176\u4ed6\u9ed8\u8ba4\u4e3adocs </li> <li>\u8bb0\u5f55\u5185\u5bb9\u8d8a\u591a\uff0c\u5360\u7528\u5b58\u50a8\u7a7a\u95f4\u8d8a\u5927 </li> </ul>"},{"location":"chap3/6ES_Mapping/#2-4-null_values","title":"2-4 null_values","text":"<ul> <li>\u9700\u8981\u5bf9Null\u503c\u5b9e\u73b0\u641c\u7d22 </li> <li>\u53ea\u6709Keyword\u7c7b\u578b\u652f\u6301\u8bbe\u5b9a<code>null_value</code></li> </ul> <pre><code>#\u8bbe\u5b9aNull_value\nDELETE users\n\n\nPUT users\n{\n    \"mappings\" : {\n      \"properties\" : {\n        \"firstName\" : {\n          \"type\" : \"text\"\n        },\n        \"lastName\" : {\n          \"type\" : \"text\"\n        },\n        \"mobile\" : {\n          \"type\" : \"keyword\",\n          \"null_value\": \"NULL\"\n        }\n\n      }\n    }\n}\n</code></pre> <p>Output</p> <pre><code>{\n  \"acknowledged\" : true,\n  \"shards_acknowledged\" : true,\n  \"index\" : \"users\"\n}\n</code></pre> <pre><code>PUT users/_doc/1\n{\n  \"firstName\":\"Jacob\",\n  \"lastName\": \"Xi\",\n  \"mobile\": null\n}\n</code></pre> <pre><code>PUT users/_doc/2\n{\n  \"firstName\":\"Jacob2\",\n  \"lastName\": \"xi2\"\n\n}\n</code></pre> <pre><code>GET users/_search\n{\n  \"query\": {\n    \"match\": {\n      \"mobile\":\"NULL\"\n    }\n  }\n\n}\n\nGET users/_search?q=mobile:NULL\n</code></pre> <p></p>"},{"location":"chap3/6ES_Mapping/#2-5-copy_to","title":"2-5 copy_to \u8bbe\u7f6e","text":"<ul> <li><code>_all</code>\u57287\u4e2d\u88ab<code>copy_to</code>\u6240\u66ff\u4ee3 </li> <li>\u6ee1\u8db3\u4e00\u4e9b\u7279\u5b9a\u7684\u641c\u7d22\u9700\u6c42 </li> <li><code>copy_to</code>\u5c06\u5b57\u6bb5\u7684\u6570\u503c\u62f7\u8d1d\u5230\u76ee\u6807\u5b57\u6bb5\uff0c\u5b9e\u73b0\u7c7b\u4f3c<code>_all</code>\u7684\u4f5c\u7528 </li> <li><code>copy_to</code>\u7684\u76ee\u6807\u5b57\u6bb5\u4e0d\u51fa\u73b0\u5728<code>_source</code>\u4e2d </li> </ul> <pre><code>#\u8bbe\u7f6e Copy to\nDELETE users\nPUT users\n{\n  \"mappings\": {\n    \"properties\": {\n      \"firstName\":{\n        \"type\": \"text\",\n        \"copy_to\": \"fullName\"\n      },\n      \"lastName\":{\n        \"type\": \"text\",\n        \"copy_to\": \"fullName\"\n      }\n    }\n  }\n}\n</code></pre> <pre><code>PUT users/_doc/1\n{\n  \"firstName\":\"Jacob\",\n  \"lastName\": \"Xi\"\n}\n</code></pre> <pre><code>GET users/_search?q=fullName:(Jacob Xi)\n</code></pre> <pre><code>POST users/_search\n{\n  \"query\": {\n    \"match\": {\n       \"fullName\":{\n        \"query\": \"Jacob Xi\",\n        \"operator\": \"and\"\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"chap3/6ES_Mapping/#2-6","title":"2-6 \u6570\u7ec4\u7c7b\u578b","text":"<ul> <li>Elasticsearch\u4e2d\u4e0d\u63d0\u4f9b\u4e13\u95e8\u7684\u6570\u7ec4\u7c7b\u578b\u3002\u4f46\u662f\u4efb\u4f55\u5b57\u6bb5\uff0c\u90fd\u53ef\u4ee5\u5305\u542b\u591a\u4e2a\u76f8\u540c\u7c7b\u7c7b\u578b\u7684\u6570\u503c </li> </ul> <pre><code>#\u6570\u7ec4\u7c7b\u578b\nPUT users/_doc/1\n{\n  \"name\":\"onebird\",\n  \"interests\":\"reading\"\n}\n\nPUT users/_doc/1\n{\n  \"name\":\"twobirds\",\n  \"interests\":[\"reading\",\"music\"]\n}\n</code></pre> <pre><code>POST users/_search\n{\n  \"query\": {\n        \"match_all\": {}\n    }\n}\n</code></pre> <pre><code>GET users/_mapping\n\n{\n  \"users\" : {\n    \"mappings\" : {\n      \"properties\" : {\n        \"firstName\" : {\n          \"type\" : \"text\",\n          \"copy_to\" : [\n            \"fullName\"\n          ]\n        },\n        \"fullName\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n            }\n          }\n        },\n        \"interests\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n            }\n          }\n        },\n        \"lastName\" : {\n          \"type\" : \"text\",\n          \"copy_to\" : [\n            \"fullName\"\n          ]\n        },\n        \"name\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n            }\n          }\n        }\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"chap3/6ES_Mapping/#3mappinganalyzer","title":"3\u3001\u591a\u5b57\u6bb5\u7279\u6027\u53caMapping\u4e2d\u914d\u7f6e\u81ea\u5b9a\u4e49Analyzer","text":""},{"location":"chap3/6ES_Mapping/#3-1","title":"3-1 \u591a\u5b57\u6bb5\u7c7b\u578b","text":"<ul> <li>\u591a\u5b57\u6bb5\u7279\u6027 <ul> <li>\u5382\u5546\u540d\u5b57\u5b9e\u73b0\u7cbe\u786e\u5339\u914d <ul> <li>\u589e\u52a0\u4e00\u4e2akeyword\u5b57\u6bb5 </li> </ul> </li> <li>\u4f7f\u7528\u4e0d\u540c\u7684analyzer <ul> <li>\u4e0d\u540c\u8bed\u8a00 </li> <li>pinyin\u5b57\u6bb5\u7684\u641c\u7d22 </li> <li>\u8fd8\u652f\u6301\u4e3a\u641c\u7d22\u548c\u7d22\u5f15\u6307\u5b9a\u4e0d\u540c\u7684analyzer </li> </ul> </li> </ul> </li> </ul>"},{"location":"chap3/6ES_Mapping/#3-2-exact-values-vs-full-text","title":"3-2 Exact Values v.s Full Text","text":"<ul> <li>Exact Values v.s Full Text <ul> <li>Exact Value:\u5305\u62ec\u6570\u5b57\uff0f\u65e5\u671f\uff0f\u5177\u4f53\u4e00\u4e2a\u5b57\u7b26\u4e32\uff08\u4f8b\u5982\"Apple Store\") <ul> <li>Elasticseach\u4e2d\u7684keyword </li> </ul> </li> <li>\u5168\u6587\u672c\uff0c\u975e\u7ed3\u6784\u5316\u7684\u6587\u672c\u6570\u636e <ul> <li>Elasticsearch\u4e2d\u7684text </li> </ul> </li> </ul> </li> </ul>"},{"location":"chap3/6ES_Mapping/#3-3-exact-values","title":"3-3 Exact Values\u4e0d\u9700\u8981\u88ab\u5206\u8bcd","text":"<ul> <li>Elasticsearch\u4e3a\u6bcf\u4e00\u4e2a\u5b57\u6bb5\u521b\u5efa\u4e00\u4e2a\u5012\u6392\u7d22\u5f15 <ul> <li><code>Exact Value</code>\u5728\u7d22\u5f15\u65f6\uff0c\u4e0d\u9700\u8981\u505a\u7279\u6b8a\u7684\u5206\u8bcd\u5904\u7406 </li> </ul> </li> </ul> <pre><code>PUT logs/_doc/1\n{\"level\":\"DEBUG\"}\n\nGET /logs/_mapping\n</code></pre> <p>Output</p> <pre><code>{\n  \"logs\" : {\n    \"mappings\" : {\n      \"properties\" : {\n        \"level\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n            }\n          }\n        }\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"chap3/6ES_Mapping/#3-4","title":"3-4 \u81ea\u5b9a\u4e49\u5206\u8bcd","text":"<ul> <li>\u5f53Elasticsearch\u81ea\u5e26\u7684\u5206\u8bcd\u5668\u65e0\u6cd5\u6ee1\u8db3\u65f6\uff0c\u53ef\u4ee5\u81ea\u5b9a\u4e49\u5206\u8bcd\u5668\u3002\u901a\u8fc7\u81ea\u7ec4\u5408\u4e0d\u540c\u7684\u7ec4\u4ef6\u5b9e\u73b0 <ul> <li>Character Filter </li> <li>Tokenizer </li> <li>Token Filter</li> </ul> </li> </ul>"},{"location":"chap3/6ES_Mapping/#3-5-character-filters","title":"3-5 Character Filters","text":"<ul> <li>\u5728Tokenizer\u4e4b\u524d\u5bf9\u6587\u672c\u8fdb\u884c\u5904\u7406\uff0c\u4f8b\u5982\u589e\u52a0\u5220\u9664\u53ca\u66ff\u6362\u5b57\u7b26\u3002\u53ef\u4ee5\u914d\u7f6e\u591a\u4e2a<code>Character Filters</code>\u3002\u4f1a\u5f71\u54cd<code>Tokenizer</code>\u7684<code>position</code>\u548c<code>offset</code>\u4fe1\u606f </li> <li>\u4e00\u4e9b\u81ea\u5e26\u7684<code>Character Filters</code><ul> <li>HTML strip \u2014\u2014 \u53bb\u9664html\u6807\u7b7e </li> <li>Mapping \u2014\u2014 \u5b57\u7b26\u4e32\u66ff\u6362 </li> <li>Pattern replace \u2014\u2014 \u6b63\u5219\u5339\u914d\u66ff\u6362 </li> </ul> </li> </ul>"},{"location":"chap3/6ES_Mapping/#3-5-1-html-strip-html","title":"3-5-1 HTML strip \u2014\u2014 \u53bb\u9664html\u6807\u7b7e","text":"<pre><code>POST _analyze\n{\n  \"tokenizer\":\"keyword\",\n  \"char_filter\":[\"html_strip\"],\n  \"text\": \"&lt;b&gt;hello world&lt;/b&gt;\"\n}\n</code></pre> <pre><code>{\n  \"tokens\" : [\n    {\n      \"token\" : \"hello world\",\n      \"start_offset\" : 3,\n      \"end_offset\" : 18,\n      \"type\" : \"word\",\n      \"position\" : 0\n    }\n  ]\n}\n</code></pre>"},{"location":"chap3/6ES_Mapping/#3-5-2-mapping","title":"3-5-2 Mapping \u2014\u2014 \u5b57\u7b26\u4e32\u66ff\u6362","text":"<pre><code>#\u4f7f\u7528char filter\u8fdb\u884c\u66ff\u6362\nPOST _analyze\n{\n  \"tokenizer\": \"standard\",\n  \"char_filter\": [\n      {\n        \"type\" : \"mapping\",\n        \"mappings\" : [ \"- =&gt; _\"]\n      }\n    ],\n  \"text\": \"123-456, I-test! test-990 650-555-1234\"\n}\n</code></pre> <p>Output :</p> <pre><code>{\n  \"tokens\" : [\n    {\n      \"token\" : \"123_456\",\n      \"start_offset\" : 0,\n      \"end_offset\" : 7,\n      \"type\" : \"&lt;NUM&gt;\",\n      \"position\" : 0\n    },\n    {\n      \"token\" : \"I_test\",\n      \"start_offset\" : 9,\n      \"end_offset\" : 15,\n      \"type\" : \"&lt;ALPHANUM&gt;\",\n      \"position\" : 1\n    },\n    {\n      \"token\" : \"test_990\",\n      \"start_offset\" : 17,\n      \"end_offset\" : 25,\n      \"type\" : \"&lt;ALPHANUM&gt;\",\n      \"position\" : 2\n    },\n    {\n      \"token\" : \"650_555_1234\",\n      \"start_offset\" : 26,\n      \"end_offset\" : 38,\n      \"type\" : \"&lt;NUM&gt;\",\n      \"position\" : 3\n    }\n  ]\n}\n</code></pre> <pre><code>//char filter \u66ff\u6362\u8868\u60c5\u7b26\u53f7\nPOST _analyze\n{\n  \"tokenizer\": \"standard\",\n  \"char_filter\": [\n      {\n        \"type\" : \"mapping\",\n        \"mappings\" : [ \":) =&gt; happy\", \":( =&gt; sad\"]\n      }\n    ],\n    \"text\": [\"I am felling :)\", \"Feeling :( today\"]\n}\n</code></pre> <p>Output :</p> <pre><code>...\n {\n      \"token\" : \"felling\",\n      \"start_offset\" : 5,\n      \"end_offset\" : 12,\n      \"type\" : \"&lt;ALPHANUM&gt;\",\n      \"position\" : 2\n    },\n    {\n      \"token\" : \"happy\",\n      \"start_offset\" : 13,\n      \"end_offset\" : 15,\n      \"type\" : \"&lt;ALPHANUM&gt;\",\n      \"position\" : 3\n    },\n    {\n      \"token\" : \"Feeling\",\n      \"start_offset\" : 16,\n      \"end_offset\" : 23,\n      \"type\" : \"&lt;ALPHANUM&gt;\",\n      \"position\" : 104\n    },\n    {\n      \"token\" : \"sad\",\n      \"start_offset\" : 24,\n      \"end_offset\" : 26,\n      \"type\" : \"&lt;ALPHANUM&gt;\",\n      \"position\" : 105\n    },\n ...\n</code></pre> <ul> <li><code>felling</code>  \\ <code>happy</code> \\ <code>Feeling</code> \\ <code>sad</code></li> </ul>"},{"location":"chap3/6ES_Mapping/#3-5-3-pattern-replace","title":"3-5-3 Pattern replace \u2014\u2014 \u6b63\u5219\u5339\u914d\u66ff\u6362","text":"<pre><code>//\u6b63\u5219\u8868\u8fbe\u5f0f\nGET _analyze\n{\n  \"tokenizer\": \"standard\",\n  \"char_filter\": [\n      {\n        \"type\" : \"pattern_replace\",\n        \"pattern\" : \"http://(.*)\",\n        \"replacement\" : \"$1\"\n      }\n    ],\n    \"text\" : \"http://www.elastic.co\"\n}\n</code></pre> <p>Output</p> <pre><code>{\n  \"tokens\" : [\n    {\n      \"token\" : \"www.elastic.co\",\n      \"start_offset\" : 0,\n      \"end_offset\" : 21,\n      \"type\" : \"&lt;ALPHANUM&gt;\",\n      \"position\" : 0\n    }\n  ]\n}\n</code></pre>"},{"location":"chap3/6ES_Mapping/#3-6-tokenizer","title":"3-6 Tokenizer","text":"<ul> <li>\u5c06\u539f\u59cb\u7684\u6587\u672c\u6309\u7167\u4e00\u5b9a\u7684\u89c4\u5219\uff0c\u5207\u5206\u4e3a\u8bcd\uff08term or token) </li> <li>Elasticsearch\u5185\u7f6e\u7684Tokenizers <ul> <li>whitespace/standard/<code>uax_url_email</code>/pattern/keyword/path hierarchy </li> </ul> </li> <li>\u53ef\u4ee5\u7528Java\u5f00\u53d1\u63d2\u4ef6\uff0c\u5b9e\u73b0\u81ea\u5df1\u7684Tokenizer </li> </ul>"},{"location":"chap3/6ES_Mapping/#3-6-1-whitespace","title":"3-6-1 whitespace","text":"<pre><code>// white space and snowball\nGET _analyze\n{\n  \"tokenizer\": \"whitespace\",\n  \"filter\": [\"stop\",\"snowball\"],\n  \"text\": [\"The gilrs in China are playing this game!\"]\n}\n</code></pre> <pre><code>{\n  \"tokens\" : [\n    {\n      \"token\" : \"The\",\n      \"start_offset\" : 0,\n      \"end_offset\" : 3,\n      \"type\" : \"word\",\n      \"position\" : 0\n    },\n    {\n      \"token\" : \"gilr\",\n      \"start_offset\" : 4,\n      \"end_offset\" : 9,\n      \"type\" : \"word\",\n      \"position\" : 1\n    },\n    {\n      \"token\" : \"China\",\n      \"start_offset\" : 13,\n      \"end_offset\" : 18,\n      \"type\" : \"word\",\n      \"position\" : 3\n    },\n...\n</code></pre> <ul> <li>The \\ gilr \\ China \\ play \\ game!</li> </ul> <pre><code>// whitespace\u4e0estop\nGET _analyze\n{\n  \"tokenizer\": \"whitespace\",\n  \"filter\": [\"stop\",\"snowball\"],\n  \"text\": [\"The rain in Spain falls mainly on the plain.\"]\n}\n</code></pre> <ul> <li>The  \\ rain \\ Spain \\ falls  \\ mainly \\  plain</li> </ul>"},{"location":"chap3/6ES_Mapping/#3-6-2-path-hierarchy","title":"3-6-2 <code>path hierarchy</code>","text":"<pre><code>POST _analyze\n{\n  \"tokenizer\":\"path_hierarchy\",\n  \"text\":\"/user/ymruan/a/b/c/d/e\"\n}\n</code></pre>"},{"location":"chap3/6ES_Mapping/#3-7-token-filters","title":"3-7 Token Filters","text":"<ul> <li>\u5c06Tokenizer\u8f93\u51fa\u7684\u5355\u8bcd\uff08term)\uff0c\u8fdb\u884c\u589e\u52a0\uff0c\u4fee\u6539\uff0c\u5220\u9664 </li> <li>\u81ea\u5e26\u7684<code>Token Filters</code> <ul> <li><code>Lowercase</code>/<code>stop</code>/<code>synonym</code>\uff08\u6dfb\u52a0\u8fd1\u4e49\u8bcd\uff09 </li> </ul> </li> </ul> <pre><code>//remove \u52a0\u5165lowercase\u540e\uff0cThe\u88ab\u5f53\u6210 stopword\u5220\u9664\nGET _analyze\n{\n  \"tokenizer\": \"whitespace\",\n  \"filter\": [\"lowercase\",\"stop\",\"snowball\"],\n  \"text\": [\"The gilrs in China are playing this game!\"]\n}\n</code></pre> <ul> <li>gilr \\ china \\ play \\ game</li> </ul>"},{"location":"chap3/6ES_Mapping/#3-8-custom-analyzer","title":"3-8 \u8bbe\u7f6e\u4e00\u4e2aCustom Analyzer","text":""},{"location":"chap3/7ES_Index/","title":"\u7b2c\u4e03\u8282 Index Template\u548cDynamic Template","text":""},{"location":"chap3/7ES_Index/#1","title":"1\u3001\u7ba1\u7406\u5f88\u591a\u7684\u7d22\u5f15","text":"<ul> <li>\u96c6\u7fa4\u4e0a\u7684\u7d22\u5f15\u4f1a\u8d8a\u6765\u8d8a\u591a\uff0c\u4f8b\u5982\uff0c\u4f60\u4f1a\u4e3a\u4f60\u7684\u65e5\u5fd7\u6bcf\u5929\u521b\u5efa\u4e00\u4e2a\u7d22\u5f15 <ul> <li>\u4f7f\u7528\u591a\u4e2a\u7d22\u5f15\u53ef\u4ee5\u8ba9\u4f60\u66f4\u597d\u7684\u7ba1\u7406\u4f60\u7684\u6570\u636e\uff0c\u63d0\u9ad8\u6027\u80fd </li> <li>logs-2019-05-01 </li> <li>logs-2019-05-02 </li> <li>logs-2019-05-03 </li> </ul> </li> </ul>"},{"location":"chap3/7ES_Index/#2index-template","title":"2\u3001\u4ec0\u4e48\u662fIndex Template","text":"<ul> <li>Index Templates \u2014\u2014 \u5e2e\u52a9\u4f60\u8bbe\u5b9aMappings\u548cSettings\uff0c\u5e76\u6309\u7167\u4e00\u5b9a\u7684\u89c4\u5219\u81ea\u52a8\u5339\u914d\u5230\u65b0\u521b\u5efa\u7684\u7d22\u5f15\u4e4b\u4e0a <ul> <li>\u6a21\u7248\u4ec5\u5728\u4e00\u4e2a\u7d22\u5f15\u88ab\u65b0\u521b\u5efa\u65f6\uff0c\u624d\u4f1a\u4ea7\u751f\u4f5c\u7528\u3002\u4fee\u6539\u6a21\u7248\u4e0d\u4f1a\u5f71\u54cd\u5df2\u521b\u5efa\u7684\u7d22\u5f15 </li> <li>\u4f60\u53ef\u4ee5\u8bbe\u5b9a\u591a\u4e2a\u7d22\u5f15\u6a21\u7248\uff0c\u8fd9\u4e9b\u8bbe\u7f6e\u4f1a\u88ab<code>\"merge\"</code>\u5728\u4e00\u8d77 </li> <li>\u4f60\u53ef\u4ee5\u6307\u5b9a<code>\"order\"</code>\u7684\u6570\u503c\uff0c\u63a7\u5236<code>\"merging\"</code>\u7684\u8fc7\u7a0b </li> </ul> </li> </ul>"},{"location":"chap3/7ES_Index/#2-1-index-templates","title":"2-1 \u4e24\u4e2aIndex Templates","text":""},{"location":"chap3/7ES_Index/#2-1-1-mappingssettings","title":"2-1-1 \u6ca1\u6709\u8bbe\u5b9aMappings\u548cSettings","text":"<pre><code>PUT template/_doc/1\n{\n    \"someNumber\":\"1\",\n    \"someDate\":\"2019/01/01\"\n}\n</code></pre> <p>Output :</p> <pre><code>{\n  \"template\" : {\n    \"mappings\" : {\n      \"properties\" : {\n        \"someDate\" : {\n          \"type\" : \"date\",\n          \"format\" : \"yyyy/MM/dd HH:mm:ss||yyyy/MM/dd||epoch_millis\"\n        },\n        \"someNumber\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n...\n</code></pre>"},{"location":"chap3/7ES_Index/#2-2-index-template","title":"2-2 Index Template\u7684\u5de5\u4f5c\u65b9\u5f0f","text":"<ul> <li>\u5f53\u4e00\u4e2a\u7d22\u5f15\u88ab\u65b0\u521b\u5efa\u65f6 <ul> <li><code>Elasticsearch</code>\u9ed8\u8ba4\u7684<code>settings</code>\u548c<code>mappings</code> </li> <li>\u5e94\u7528<code>order</code>\u6570\u503c\u4f4e\u7684<code>Index Template</code>\u4e2d\u7684\u8bbe\u5b9a </li> <li>\u5e94\u7528<code>order</code>\u9ad8\u7684<code>Index Template</code>\u4e2d\u7684\u8bbe\u5b9a\uff0c\u4e4b\u524d\u7684\u8bbe\u5b9a\u4f1a\u88ab\u8986\u76d6</li> <li>\u5e94\u7528\u521b\u5efa\u7d22\u5f15\u65f6\uff0c\u7528\u6237\u6240\u6307\u5b9a\u7684Settings\u548cMappings\uff0c\u5e76\u8986\u76d6\u4e4b\u524d\u6a21\u7248\u4e2d\u7684\u8bbe\u5b9a </li> </ul> </li> </ul> <p>Demo</p> <ul> <li>\u521b\u5efa<code>2</code>\u4e2a<code>Index Templates</code> </li> <li>\u67e5\u770b\u6839\u636e\u540d\u5b57\u67e5\u770b<code>Templates</code> </li> <li>\u67e5\u770b\u6240\u6709templates, <code>_template/*</code> </li> <li>\u521b\u5efa\u4e00\u4e2a\u4e34\u65f6\u7d22\u5f15\uff0c\u67e5\u770breplica\u548c\u6570\u636e\u7c7b\u578b\u63a8\u65ad </li> <li>\u5c06\u7d22\u5f15\u540d\u5b57\u8bbe\u4e3a\u80fdIndex Template\u5339\u914d\u65f6\uff0c\u67e5\u770b\u6240\u751f\u6210\u7684Index\u7684mappings\u548cSettings </li> </ul>"},{"location":"chap3/7ES_Index/#2-3-mappingssettings","title":"2-3 \u8bbe\u5b9aMappings\u548cSettings","text":"<pre><code>#Create a default template\nPUT _template/template_default\n{\n  \"index_patterns\": [\"*\"],\n  \"order\" : 0,\n  \"version\": 1,\n  \"settings\": {\n    \"number_of_shards\": 1,\n    \"number_of_replicas\":1\n  }\n}\n</code></pre> <pre><code>PUT /_template/template_test\n{\n    \"index_patterns\" : [\"test*\"],\n    \"order\" : 1,\n    \"settings\" : {\n        \"number_of_shards\": 1,\n        \"number_of_replicas\" : 2\n    },\n    \"mappings\" : {\n        \"date_detection\": false,\n        \"numeric_detection\": true\n    }\n}\n</code></pre> <p>\u67e5\u770btemplate\u4fe1\u606f</p> <pre><code>#\u67e5\u770btemplate\u4fe1\u606f\nGET /_template/template_default\nGET /_template/temp*\n</code></pre> <p>Output :</p> <pre><code>GET /_template/template_default\n\n{\n  \"template_default\" : {\n    \"order\" : 0,\n    \"version\" : 1,\n    \"index_patterns\" : [\n      \"*\"\n    ],\n    \"settings\" : {\n      \"index\" : {\n        \"number_of_shards\" : \"1\",\n        \"number_of_replicas\" : \"1\"\n      }\n    },\n    \"mappings\" : { },\n    \"aliases\" : { }\n  }\n}\n\n</code></pre> <pre><code>GET /_template/temp*\n\n{\n  \"template_test\" : {\n    \"order\" : 1,\n    \"index_patterns\" : [\n      \"test*\"\n    ],\n    \"settings\" : {\n      \"index\" : {\n        \"number_of_shards\" : \"1\",\n        \"number_of_replicas\" : \"2\"\n      }\n    },\n    \"mappings\" : {\n      \"numeric_detection\" : true,\n      \"date_detection\" : false\n    },\n    \"aliases\" : { }\n  },\n  \"template_default\" : {\n    \"order\" : 0,\n    \"version\" : 1,\n    \"index_patterns\" : [\n      \"*\"\n    ],\n    \"settings\" : {\n      \"index\" : {\n        \"number_of_shards\" : \"1\",\n        \"number_of_replicas\" : \"1\"\n      }\n    },\n    \"mappings\" : { },\n    \"aliases\" : { }\n  }\n}\n</code></pre>"},{"location":"chap3/7ES_Index/#indextest","title":"\u5199\u5165\u65b0\u7684\u6570\u636e\uff0cindex\u4ee5<code>test</code>\u5f00\u5934","text":"<pre><code>PUT testtemplate/_doc/1\n{\n    \"someNumber\":\"1\",\n    \"someDate\":\"2019/01/01\"\n}\n</code></pre> <p>Output :</p> <pre><code>GET testtemplate/_mapping\n</code></pre> <p></p> <pre><code>GET testtemplate/_settings\n</code></pre> <p></p> <pre><code>PUT testmy\n{\n    \"settings\":{\n        \"number_of_replicas\":5\n    }\n}\n</code></pre> <p></p> <pre><code>PUT testmy/_doc/1\n{\n  \"key\":\"value\"\n}\n</code></pre> <pre><code>GET testmy/_settings\n</code></pre> <p></p> <pre><code>DELETE testmy\nDELETE /_template/template_default\nDELETE /_template/template_test\n</code></pre>"},{"location":"chap3/7ES_Index/#3dynamic-template","title":"3\u3001\u4ec0\u4e48\u662fDynamic Template","text":"<ul> <li>\u6839\u636eElasticsearch\u8bc6\u522b\u7684\u6570\u636e\u7c7b\u578b\uff0c\u7ed3\u5408\u5b57\u6bb5\u540d\u79f0\uff0c\u6765\u52a8\u6001\u8bbe\u5b9a\u5b57\u6bb5\u7c7b\u578b <ul> <li>\u6240\u6709\u7684\u5b57\u7b26\u4e32\u7c7b\u578b\u90fd\u8bbe\u5b9a\u6210Keyword\uff0c\u6216\u8005\u5173\u95edkeyword\u5b57\u6bb5 </li> <li>is\u5f00\u5934\u7684\u5b57\u6bb5\u90fd\u8bbe\u7f6e\u6210boolean </li> <li><code>long_</code>\u5f00\u5934\u7684\u90fd\u8bbe\u7f6e\u6210<code>long</code>\u7c7b\u578b </li> </ul> </li> </ul>"},{"location":"chap3/7ES_Index/#3-1-dynamic-tempate","title":"3-1 Dynamic Tempate","text":"<ul> <li>Dynamic Tempate\u662f\u5b9a\u4e49\u5728\u5728\u67d0\u4e2a\u7d22\u5f15\u7684Mapping\u4e2d </li> <li>Template\u6709\u4e00\u4e2a\u540d\u79f0 </li> <li>\u5339\u914d\u89c4\u5219\u662f\u4e00\u4e2a\u6570\u7ec4 </li> <li>\u4e3a\u5339\u914d\u5230\u5b57\u6bb5\u8bbe\u7f6eMapping </li> </ul>"},{"location":"chap3/7ES_Index/#3-2","title":"3-2 \u5339\u914d\u89c4\u5219\u53c2\u6570","text":"<ul> <li><code>match_mapping_type</code>\uff1a\u5339\u914d\u81ea\u52a8\u8bc6\u522b\u7684\u5b57\u6bb5\u7c7b\u578b \u5982string, boolean\u7b49 </li> <li><code>match</code>, <code>unmatch</code>\uff1a\u5339\u914d\u5b57\u6bb5\u540d </li> <li><code>path_match</code>,<code>path_unmatch</code></li> </ul>"},{"location":"chap3/7ES_Index/#3-3-dynaminc-mapping-demo","title":"3-3 Dynaminc Mapping \u6839\u636e\u7c7b\u578b\u548c\u5b57\u6bb5\u540d DEMO","text":"<pre><code>#Dynaminc Mapping \u6839\u636e\u7c7b\u578b\u548c\u5b57\u6bb5\u540d\nDELETE my_index\n\n\nPUT my_index/_doc/1\n{\n  \"firstName\":\"Jacob\",\n  \"isVIP\":\"true\"\n}\n\nGET my_index/_mapping\n</code></pre> <pre><code>{\n  \"my_index\" : {\n    \"mappings\" : {\n      \"properties\" : {\n        \"firstName\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n            }\n          }\n        },\n        \"isVIP\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n</code></pre> <ul> <li>firstName:  <code>\"type\" : \"text\",</code></li> <li>isVIP : <code>\"type\" : \"text\",</code></li> </ul> <pre><code>PUT my_index\n{\n  \"mappings\": {\n    \"dynamic_templates\": [\n            {\n        \"strings_as_boolean\": {\n          \"match_mapping_type\":   \"string\",\n          \"match\":\"is*\",\n          \"mapping\": {\n            \"type\": \"boolean\"\n          }\n        }\n      },\n      {\n        \"strings_as_keywords\": {\n          \"match_mapping_type\":   \"string\",\n          \"mapping\": {\n            \"type\": \"keyword\"\n          }\n        }\n      }\n    ]\n  }\n}\n</code></pre> <p>Outout</p> <pre><code>{\n  \"acknowledged\" : true,\n  \"shards_acknowledged\" : true,\n  \"index\" : \"my_index\"\n}\n</code></pre> <pre><code>DELETE my_index\n</code></pre> <p><code>match</code>, <code>unmatch</code>\uff1a\u5339\u914d\u5b57\u6bb5\u540d</p> <pre><code>#\u7ed3\u5408\u8def\u5f84\nPUT my_index\n{\n  \"mappings\": {\n    \"dynamic_templates\": [\n      {\n        \"full_name\": {\n          \"path_match\":   \"name.*\",\n          \"path_unmatch\": \"*.middle\",\n          \"mapping\": {\n            \"type\":       \"text\",\n            \"copy_to\":    \"full_name\"\n          }\n        }\n      }\n    ]\n  }\n}\n</code></pre> <pre><code>{\n  \"acknowledged\" : true,\n  \"shards_acknowledged\" : true,\n  \"index\" : \"my_index\"\n}\n</code></pre> <pre><code>PUT my_index/_doc/1\n{\n  \"name\": {\n    \"first\":  \"John\",\n    \"middle\": \"Winston\",\n    \"last\":   \"Lennon\"\n  }\n}\n</code></pre> <pre><code>GET my_index/_search?q=full_name:John\n</code></pre> <p><code>_search?q=full_name:John</code></p> <p></p> <p>\u76f8\u5173\u9605\u8bfb</p> <ul> <li>Index Templates https://www.elastic.co/guide/en/elasticsearch/reference/7.1/indices-templates.html</li> <li>Dynamic Template https://www.elastic.co/guide/en/elasticsearch/reference/7.1/dynamic-mapping.html</li> </ul>"},{"location":"chap3/8ES_Aggr/","title":"\u7b2c\u516b\u8282 Elasticsearch Aggregations\u805a\u5408\u5206\u6790\u7b80\u4ecb","text":""},{"location":"chap3/8ES_Aggr/#1aggregation","title":"1\u3001\u4ec0\u4e48\u662f\u805a\u5408\uff08Aggregation)","text":"<ul> <li> <p>Elasticsearch\u9664\u641c\u7d22\u4ee5\u5916\uff0c\u63d0\u4f9b\u7684\u9488\u5bf9ES\u6570\u636e\u8fdb\u884c\u7edf\u8ba1\u5206\u6790\u7684\u529f\u80fd </p> <ul> <li>\u5b9e\u65f6\u6027\u9ad8 </li> <li>Hadoop(T+1) </li> </ul> </li> <li> <p>\u901a\u8fc7\u805a\u5408\uff0c\u6211\u4eec\u4f1a\u5f97\u5230\u4e00\u4e2a\u6570\u636e\u7684\u6982\u89c8\uff0c\u662f\u5206\u6790\u548c\u603b\u7ed3\u5168\u5957\u7684\u6570\u636e\uff0c\u800c\u4e0d\u662f\u5bfb\u627e\u5355\u4e2a\u6587\u6863 </p> <ul> <li>\u5c16\u6c99\u5480\u548c\u9999\u6e2f\u5c9b\u7684\u5ba2\u623f\u6570\u91cf </li> <li>\u4e0d\u540c\u7684\u4ef7\u683c\u533a\u95f4\uff0c\u53ef\u9884\u5b9a\u7684\u7ecf\u6d4e\u578b\u9152\u5e97\u548c\u4e94\u661f\u7ea7\u9152\u5e97\u7684\u6570\u91cf </li> </ul> </li> <li>\u9ad8\u6027\u80fd\uff0c\u53ea\u9700\u8981\u4e00\u6761\u8bed\u53e5\uff0c\u5c31\u53ef\u4ee5\u4eceElasticsearch\u5f97\u5230\u5206\u6790\u7ed3\u679c <ul> <li>\u65e0\u9700\u5728\u5ba2\u6237\u7aef\u81ea\u5df1\u53bb\u5b9e\u73b0\u5206\u6790\u903b\u8f91 </li> </ul> </li> </ul>"},{"location":"chap3/8ES_Aggr/#1-1-kibana","title":"1-1 Kibana\u53ef\u89c6\u5316\u62a5\u8868\u4e00\u805a\u5408\u5206\u6790","text":"<ul> <li>\u516c\u53f8\u7a0b\u5e8f\u5458\u7684\u5de5\u4f5c\u5c97\u4f4d\u5206\u5e03 </li> <li>\u516c\u53f8\u91c7\u7528\u7684\u7f16\u7a0b\u6846\u67b6\u5206\u5e03 </li> <li>\u516c\u53f8\u5458\u5de5\u85aa\u6c34\u5206\u5e03 </li> <li>\u5ba2\u6237\u7684\u5730\u7406\u4f4d\u7f6e\u5206\u5e03 </li> <li>\u8ba2\u5355\u7684\u589e\u957f\u60c5\u51b5 </li> <li>\u7b49\u7b49</li> </ul>"},{"location":"chap3/8ES_Aggr/#1-2","title":"1-2 \u96c6\u5408\u7684\u5206\u7c7b","text":"<ul> <li>Bucket Aggregation\uff0d\u4e00\u4e9b\u5217\u6ee1\u8db3\u7279\u5b9a\u6761\u4ef6\u7684\u6587\u6863\u7684\u96c6\u5408 </li> <li>Metric Aggregation\uff0d\u4e00\u4e9b\u6570\u5b66\u8fd0\u7b97\uff0c\u53ef\u4ee5\u5bf9\u6587\u6863\u5b57\u6bb5\u8fdb\u884c\u7edf\u8ba1\u5206\u6790 </li> <li>Pipeline Aggregation\u4e00\u5bf9\u5176\u4ed6\u7684\u805a\u5408\u7ed3\u679c\u8fdb\u884c\u4e8c\u6b21\u805a\u5408 </li> <li>Matrix Aggregration\u4e00\u652f\u6301\u5bf9\u591a\u4e2a\u5b57\u6bb5\u7684\u64cd\u4f5c\u5e76\u63d0\u4f9b\u4e00\u4e2a\u7ed3\u679c\u77e9\u9635 </li> </ul>"},{"location":"chap3/8ES_Aggr/#1-2-bucket-metric","title":"1-2 Bucket &amp; Metric","text":"<ul> <li>Metric\u4e00\u4e00\u4e9b\u7cfb\u5217\u7684\u7edf\u8ba1\u65b9\u6cd5 </li> <li>Bucket\u4e00\u4e00\u7ec4\u6ee1\u8db3\u6761\u4ef6\u7684\u6587\u6863 </li> </ul>"},{"location":"chap3/8ES_Aggr/#1-3-bucket","title":"1-3 Bucket","text":"<ul> <li>\u4e00\u4e9b\u4f8b\u5b50<ul> <li>\u676d\u5dde\u5c5e\u4e8e\u6d59\u6c5f\uff0f\u4e00\u4e2a\u6f14\u5458\u5c5e\u4e8e \u7537\u6216\u5973\u6027</li> <li>\u5d4c\u5957\u5173\u7cfb\u4e00\u676d\u5dde\u5c5e\u4e8e\u6d59\u6c5f\u5c5e\u4e8e\u4e2d\u56fd\u5c5e\u4e8e\u4e9a\u6d32 </li> </ul> </li> <li>Elasticsearch\u63d0\u4f9b\u4e86\u5f88\u591a\u7c7b\u578b\u7684Bucket\uff0c\u5e2e\u52a9\u4f60\u7528\u591a\u79cd\u65b9\u5f0f\u5212\u5206\u6587\u6863 <ul> <li>Term&amp;Range\uff08\u65f6\u95f4\uff0f\u5e74\u9f84\u533a\u95f4\uff0f\u5730\u7406\u4f4d\u7f6e\uff09 </li> </ul> </li> </ul>"},{"location":"chap3/8ES_Aggr/#1-4-metric","title":"1-4 Metric","text":"<ul> <li>Metric\u4f1a\u57fa\u4e8e\u6570\u636e\u96c6\u8ba1\u7b97\u7ed3\u679c\uff0c\u9664\u4e86\u652f\u6301\u5728\u5b57\u6bb5\u4e0a\u8fdb\u884c\u8ba1\u7b97\uff0c\u540c\u6837\u4e5f\u652f\u6301\u5728\u811a\u672c(painless script\uff09\u4ea7\u751f\u7684\u7ed3\u679c\u4e4b\u4e0a\u8fdb\u884c\u8ba1\u7b97 </li> <li>\u5927\u591a\u6570Metric\u662f\u6570\u5b66\u8ba1\u7b97\uff0c\u4ec5\u8f93\u51fa\u4e00\u4e2a\u503c <ul> <li><code>min</code>/<code>max</code>/<code>sum</code>/<code>avg</code>/<code>cardinality</code> </li> </ul> </li> <li>\u90e8\u5206metric\u652f\u6301\u8f93\u51fa\u591a\u4e2a\u6570\u503c <ul> <li><code>stats</code>/<code>percentiles</code>/<code>percentile_ranks</code> </li> </ul> </li> </ul>"},{"location":"chap3/8ES_Aggr/#1-5-bucket","title":"1-5 \u4e00\u4e2aBucket\u7684\u4f8b\u5b50","text":"<pre><code>#\u6309\u7167\u76ee\u7684\u5730\u8fdb\u884c\u5206\u6876\u7edf\u8ba1\nGET kibana_sample_data_flights/_search\n{\n    \"size\": 0,\n    \"aggs\":{\n        \"flight_dest\":{\n            \"terms\":{\n                \"field\":\"DestCountry\"\n            }\n        }\n    }\n}\n</code></pre>"},{"location":"chap3/8ES_Aggr/#1-6-metrics","title":"1-6 \u52a0\u5165Metrics","text":"<p>\u67e5\u770b\u822a\u73ed\u76ee\u7684\u5730\u7684\u7edf\u8ba1\u4fe1\u606f\uff0c\u589e\u52a0\u5747\u4ef7\uff0c\u6700\u9ad8\u6700\u4f4e\u4ef7\u683c </p> <p></p> <pre><code>#\u67e5\u770b\u822a\u73ed\u76ee\u7684\u5730\u7684\u7edf\u8ba1\u4fe1\u606f\uff0c\u589e\u52a0\u5e73\u5747\uff0c\u6700\u9ad8\u6700\u4f4e\u4ef7\u683c\nGET kibana_sample_data_flights/_search\n{\n    \"size\": 0,\n    \"aggs\":{\n        \"flight_dest\":{\n            \"terms\":{\n                \"field\":\"DestCountry\"\n            },\n            \"aggs\":{\n                \"avg_price\":{\n                    \"avg\":{\n                        \"field\":\"AvgTicketPrice\"\n                    }\n                },\n                \"max_price\":{\n                    \"max\":{\n                        \"field\":\"AvgTicketPrice\"\n                    }\n                },\n                \"min_price\":{\n                    \"min\":{\n                        \"field\":\"AvgTicketPrice\"\n                    }\n                }\n            }\n        }\n    }\n}\n</code></pre> <p>output :</p> <pre><code>{\n          \"key\" : \"CN\",\n          \"doc_count\" : 1096,\n          \"max_price\" : {\n            \"value\" : 1198.4901123046875\n          },\n          \"min_price\" : {\n            \"value\" : 102.90382385253906\n          },\n          \"avg_price\" : {\n            \"value\" : 640.7101617033464\n          }\n        },\n</code></pre>"},{"location":"chap3/8ES_Aggr/#1-7","title":"1-7 \u5d4c\u5957","text":"<p>\u67e5\u770b\u822a\u73ed\u76ee\u7684\u5730\u7684\u7edf\u8ba1\u4fe1\u606f\uff0c\u5e73\u5747\u7968\u4ef7\uff0c\u4ee5\u53ca\u5929\u6c14\u72b6\u51b5 </p> <p></p> <pre><code>#\u4ef7\u683c\u7edf\u8ba1\u4fe1\u606f+\u5929\u6c14\u4fe1\u606f\nGET kibana_sample_data_flights/_search\n{\n    \"size\": 0,\n    \"aggs\":{\n        \"flight_dest\":{\n            \"terms\":{\n                \"field\":\"DestCountry\"\n            },\n            \"aggs\":{\n                \"stats_price\":{\n                    \"stats\":{\n                        \"field\":\"AvgTicketPrice\"\n                    }\n                },\n                \"wather\":{\n                  \"terms\": {\n                    \"field\": \"DestWeather\",\n                    \"size\": 5\n                  }\n                }\n\n            }\n        }\n    }\n}\n</code></pre> <p></p>"},{"location":"chap3/8ES_Aggr/#1-8","title":"1-8 \u672c\u8282\u56de\u987e","text":"<ul> <li>Bucket\u4e00\u6ee1\u8db3\u4e00\u5b9a\u6761\u4ef6\u7684\u6587\u6863\u96c6\u5408 </li> <li>Metric\u4e00\u5bf9\u6570\u636e\u96c6\u8fdb\u884c\u8ba1\u7b97 </li> <li>\u901a\u8fc7Elasticsearch\u7684\u805a\u5408\u529f\u80fd\uff0c\u53ef\u4ee5\u5b9e\u73b0\u5bf9\u6570\u636e\u8fdb\u884c\u7edf\u8ba1\u5206\u6790 <ul> <li>Bucket Aggregation\u4e00Terms&amp;Range </li> <li>Metrics Aggregation\u4e00max, min,avg </li> </ul> </li> <li>\u805a\u5408\u652f\u6301\u5d4c\u5957 </li> </ul>"},{"location":"chap3/9ES_SUM/","title":"\u7b2c\u4e5d\u8282 Elasticsearch \u5165\u95e8\u603b\u7ed3 &amp; \u6d4b\u8bd5","text":""},{"location":"chap3/9ES_SUM/#1","title":"1\u3001\u4ea7\u54c1\u4e0e\u4f7f\u7528\u573a\u666f","text":"<ul> <li>Elasticsearch\u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u5206\u5e03\u5f0f\u641c\u7d22\u4e0e\u5206\u6790\u5f15\u64ce\uff0c\u63d0\u4f9b\u4e86\u8fd1\u5b9e\u65f6\u641c\u7d22\u548c\u805a\u5408\u4e24\u5927\u529f\u80fd</li> <li>Elastic Stack\u5305\u62ecElasticsearch, Kibana, Logstash, Beats\u7b49\u4e00\u7cfb\u5217\u4ea7\u54c1\u3002</li> <li>Elasticsearch\u662f\u6838\u5fc3\u5f15\u64ce\uff0c\u63d0\u4f9b\u4e86\u6d77\u91cf\u6570\u636e\u5b58\u50a8\uff0c\u641c\u7d22\u548c\u805a\u5408\u7684\u80fd\u529b\u3002Beats\u662f\u8f7b\u91cf\u7684 \u6570\u636e\u91c7\u96c6\u5668\uff0cLogstash\u7528\u6765\u505a\u6570\u636e\u8f6c\u6362\uff0cKibana\u5219\u63d0\u4f9b\u4e86\u4e30\u5bcc\u7684\u53ef\u89c6\u5316\u5c55\u73b0\u4e0e\u5206\u6790\u7684\u529f \u80fd\u3002</li> <li>Elastic Stack\u4e3b\u8981\u88ab\u5e7f\u6cdb\u4f7f\u7528\u4e8e\uff1a\u641c\u7d22\uff0c\u65e5\u5fd7\u7ba1\u7406\uff0c\u5b89\u5168\u5206\u6790\uff0c\u6307\u6807\u5206\u6790\uff0c\u4e1a\u52a1\u5206\u6790\uff0c\u5e94\u7528\u6027\u80fd\u76d1\u63a7\u7b49\u591a\u4e2a\u9886\u57df </li> <li>Elastic Stack\u5f00\u6e90\u4e86X-Pack\u5728\u5185\u7684\u76f8\u5173\u4ee3\u7801\u3002\u4f5c\u4e3a\u5546\u4e1a\u89e3\u51b3\u65b9\u6848\uff0cX-Pack\u7684\u90e8\u5206\u529f\u80fd\u9700\u8981\u6536\u8d39\u3002Elastic\u516c\u53f8\u4ece6.8\u548c7.1\u5f00\u59cb\uff0cSecurity\u529f\u80fd\u4e5f\u53ef\u4ee5\u514d\u8d39\u4f7f\u7528 </li> <li>\u76f8\u6bd4\u5173\u7cfb\u578b\u6570\u636e\u5e93\uff0cElasticsearch\u63d0\u4f9b\u4e86\u5982\u6a21\u7cca\u67e5\u8be2\uff0c\u641c\u7d22\u6761\u4ef6\u7684\u7b97\u5206\u7b2c\u7b49\u5173\u7cfb\u578b\u6570\u636e\u5e93\u6240\u4e0d\u64c5\u957f\u7684\u529f\u80fd\uff0c\u4f46\u662f\u5728\u4e8b\u52a1\u6027\u7b49\u65b9\u9762\uff0c\u4e5f\u4e0d\u5982\u5173\u7cfb\u578b\u6570\u636e\u5e93\u6765\u7684\u5f3a\u5927\u3002\u56e0\u6b64\uff0c\u5728\u5b9e\u9645\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u9700\u8981\u8003\u8651\u5177\u4f53\u4e1a\u52a1\u8981\u6c42\uff0c\u7efc\u5408\u4f7f\u7528</li> </ul>"},{"location":"chap3/9ES_SUM/#2","title":"2\u3001\u57fa\u672c\u6982\u5ff5","text":"<ul> <li>\u4e00\u4e2aElasticsearch\u96c6\u7fa4\u53ef\u4ee5\u8fd0\u884c\u5728\u5355\u8282\u70b9\u4e0a\uff0c\u4e5f\u652f\u6301\u8fd0\u884c\u5728\u591a\u4e2a\u670d\u52a1\u5668\u4e0a\uff0c\u5b9e\u73b0\u6570\u636e\u548c\u670d\u52a1\u7684\u6c34\u5e73\u6269\u5c55 </li> <li>\u4ece\u903b\u8f91\u89d2\u5ea6\u770b\uff0c\u7d22\u5f15\u662f\u4e00\u4e9b\u5177\u6709\u76f8\u4f3c\u7ed3\u6784\u7684\u6587\u6863\u7684\u96c6\u5408 </li> <li>\u7269\u7406\u89d2\u5ea6\u770b\uff0c\u5206\u7247\u662f\u4e00\u4e2aLucene\u7684\u5b9e\u4f8b\u3002\u5206\u7247\u5b58\u50a8\u4e86\u7d22\u5f15\u7684\u5177\u4f53\u6570\u636e\uff0c\u5206\u7247\u53ef\u4ee5\u5206\u5e03\u5728\u4e0d\u540c\u7684\u8282\u70b9\u4e4b\u4e0a\u3002\u526f\u672c\u5206\u7247\u9664\u4e86\u63d0\u9ad8\u6570\u636e\u7684\u53ef\u9760\u6027\uff0c\u8fd8\u80fd\u4e00\u5b9a\u7a0b\u5ea6\u63d0\u5347\u96c6\u7fa4\u67e5\u8be2\u7684\u6027\u80fd </li> <li>Elasticsearch\u7684\u6587\u6863\u53ef\u4ee5\u662f\u4efb\u610f\u7684JSON\u683c\u5f0f\u7684\u6570\u636e </li> <li>\u5c06\u6587\u6863\u5199\u8fdbElasticseach\u7684\u8fc7\u7a0b\u53eb\u7d22\u5f15(indexing)</li> <li>Elasticsearch\u63d0\u4f9b\u4e86REST API\u548cTransport API\u4e24\u79cd\u65b9\u5f0f\uff0c\u5efa\u8bae\u4f7f\u7528REST API </li> </ul>"},{"location":"chap3/9ES_SUM/#3aggregation","title":"3\u3001\u641c\u7d22\u548cAggregation","text":"<ul> <li>Precision \u6307\u9664\u4e86\u76f8\u5173\u7684\u7ed3\u679c\uff0c\u8fd8\u8fd4\u56de\u4e86\u591a\u5c11\u4e0d\u76f8\u5173\u7684\u7ed3\u679c </li> <li>Recall \u2014\u2014 \u8861\u91cf\u6709\u591a\u5c11\u76f8\u5173\u7684\u7ed3\u679c\uff0c\u5b9e\u9645\u4e0a\u5e76\u6ca1\u6709\u8fd4\u56de </li> <li>\u7cbe\u786e\u503c\u5305\u62ec\uff1a\u6570\u5b57\uff0c\u65e5\u671f\u548c\u67d0\u4e9b\u5177\u4f53\u7684\u5b57\u7b26\u4e32 </li> <li>\u5168\u6587\u672c\uff1a\u662f\u9700\u8981\u88ab\u68c0\u7d22\u7684\u975e\u7ed3\u6784\u6587\u672c(Analyzer) </li> <li>Analyis\uff1a\u662f\u5c06\u6587\u672c\u8f6c\u6362\u6210\u5012\u6392\u7d22\u5f15\u4e2d\u7684Terms\u7684\u8fc7\u7a0b </li> <li>Elasticsearch\u7684<code>Analyzer</code>\u662f<code>Char_filter -&gt; Tokenizer -&gt; Token Filter</code>\u7684\u8fc7\u7a0b</li> <li>\u8981\u5584\u4e8e\u5229\u7528<code>_analyze API</code>\u53bb\u6d4b\u8bd5<code>Analyzer</code> </li> <li><code>Elasticsearch</code>\u641c\u7d22\u652f\u6301<code>URI Search</code>\u548c<code>REST Body</code>\u4e24\u79cd\u65b9\u5f0f </li> <li><code>Elasticsearch</code>\u63d0\u4f9b\u4e86<code>Bucket/Metric/Pipeline/Matrix</code>\u56db\u79cd\u65b9\u5f0f\u7684\u805a\u5408 </li> </ul>"},{"location":"chap3/9ES_SUM/#4crudindex-mapping","title":"4\u3001\u6587\u6863CRUD\u4e0eIndex Mapping","text":"<ul> <li>\u9664\u4e86CRUD\u64cd\u4f5c\u5916\uff0cElasticsearch\u8fd8\u63d0\u4f9b\u4e86<code>bulk</code>, <code>mget</code>\u548c<code>mseach</code>\u7b49\u64cd\u4f5c\u3002\u4ece\u6027\u80fd\u7684\u89d2\u5ea6\u4e0a\u8bf4\uff0c\u5efa\u8bae\u4f7f\u7528\uff0c\u4ee5\u63d0\u5347\u6027\u80fd\u3002\u4f46\u662f\uff0c\u5355\u6b21\u64cd\u4f5c\u7684\u6570\u636e\u91cf\u4e0d\u8981\u8fc7\u5927\uff0c\u4ee5\u514d\u5f15\u53d1\u6027\u80fd\u95ee\u9898 </li> <li>\u6bcf\u4e2a\u7d22\u5f15\u90fd\u6709\u4e00\u4e2a<code>Mapping</code>\u5b9a\u4e49\u3002\u5305\u542b\u6587\u6863\u7684\u5b57\u6bb5\u53ca\u7c7b\u578b\uff0c\u5b57\u6bb5\u7684<code>Analyzer</code>\u7684\u76f8\u5173\u914d\u7f6e</li> <li><code>Mapping</code>\u53ef\u4ee5\u88ab\u52a8\u6001\u7684\u521b\u5efa\uff0c\u4e3a\u4e86\u907f\u514d\u4e00\u4e9b\u9519\u8bef\u7684\u7c7b\u578b\u63a8\u7b97\u6216\u8005\u6ee1\u8db3\u4f60\u7279\u5b9a\u7684\u9700\u6c42\uff0c\u53ef\u4ee5\u663e\u793a \u7684\u5b9a\u4e49<code>Mapping</code> </li> <li><code>Mapping</code>\u53ef\u4ee5\u52a8\u6001\u521b\u5efa\uff0c\u4e5f\u53ef\u4ee5\u663e\u793a\u5b9a\u4e49\u3002\u4f60\u53ef\u4ee5\u5728<code>Mapping</code>\u4e2d\u5b9a\u5236<code>Analyzer</code> </li> <li>\u4f60\u53ef\u4ee5\u4e3a\u5b57\u6bb5\u6307\u5b9a\u5b9a\u5236\u5316\u7684<code>analyzer</code>\uff0c\u4e5f\u53ef\u4ee5\u4e3a\u67e5\u8be2\u5b57\u7b26\u4e32\u6307\u5b9a<code>search_analyzer</code></li> <li><code>Index Template</code>\u53ef\u4ee5\u5b9a\u4e49<code>Mapping</code>\u548c<code>Settings</code>\uff0c\u5e76\u81ea\u52a8\u7684\u5e94\u7528\u5230\u65b0\u521b\u5efa\u7684\u7d22\u5f15\u4e4b\u4e0a\uff0c\u5efa\u8bae\u8981\u5408\u7406\u7684\u4f7f\u7528Index Template </li> <li>Dynamic Template\u652f\u6301\u5728\u5177\u4f53\u7684\u7d22\u5f15\u4e0a\u6307\u5b9a\u89c4\u5219\uff0c\u4e3a\u65b0\u589e\u52a0\u7684\u5b57\u6bb5\u6307\u5b9a\u76f8\u5e94\u7684Mappings </li> </ul>"},{"location":"chap3/9ES_SUM/#5","title":"5\u3001\u6d4b\u8bd5","text":"<ul> <li>1.\u5224\u65ad\u9898\uff1aES\u652f\u6301\u4f7f\u7528HTTP PUT\u5199\u5165\u65b0\u6587\u6863\uff0c\u5e76\u901a\u8fc7Elasticsearch\u751f\u6210\u6587\u6863Id </li> </ul> <p>1\uff0e\u9519\uff0c\u9700\u8981\u7528POST\u547d\u4ee4\u521b\u5efa\u3002 </p> <ul> <li>2.\u5224\u65ad\u9898\uff1aUpdate\u4e00\u4e2a\u6587\u6863\uff0c\u9700\u8981\u4f7f\u7528HTTP PUT</li> </ul> <p>\u9519\uff0cUpdate\u6587\u6863\uff0c\u4f7f\u7528Pos\u4e0b\uff0cPUT\u53ea\u80fd\u7528\u6765\u505aIndex\u6216\u8005Create </p> <ul> <li>3.\u5224\u65ad\u9898\uff1aIndex\u4e00\u4e2a\u5df2\u5b58\u5728\u7684\u6587\u6863\uff0c\u65e7\u7684\u6587\u6863\u4f1a\u5148\u88ab\u5220\u9664\uff0c\u65b0\u7684\u6587\u6863\u518d\u88ab\u5199\u5165\uff0c\u540c\u65f6\u7248\u672c\u53f7\u52a01 </li> </ul> <p>\u5bf9</p> <ul> <li>4\uff0e\u5c1d\u8bd5\u63cf\u8ff0\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u6587\u6863\u5230\u4e00\u4e2a\u4e0d\u5b58\u5728\u7684\u7d22\u5f15\u4e2d\uff0c\u80cc\u540e\u4f1a\u53d1\u751f\u4e00\u4e9b\u4ec0\u4e48\uff1f </li> </ul> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4f1a\u521b\u5efa\u76f8\u5e94\u7684\u7d22\u5f15\uff0c\u5e76\u4e14\u81ea\u5df1\u8bbe\u7f6eMapping\uff0c\u5f53\u7136\uff0c\u5b9e\u9645\u60c5\u51b5\u8fd8\u662f\u8981\u770b\u662f\u5426\u6709\u5408\u9002\u7684Index Template  </p> <ul> <li>5.ES7\u4e2d\u7684\u5408\u6cd5\u7684type\u662f\u4ec0\u4e48\uff1f </li> </ul> <p>_doc </p> <ul> <li>6.\u7cbe\u786e\u503c\u548c\u5168\u6587\u7684\u672c\u8d28\u533a\u522b\u662f\u4ec0\u4e48\uff1f </li> </ul> <p>\u7cbe\u786e\u503c\u4e0d\u4f1a\u88abAnalyzer\u5206\u8bcd\uff0c\u5168\u6587\u672c\u4f1a </p> <ul> <li>7.Analyzer\u7531\u54ea\u51e0\u4e2a\u90e8\u5206\u7ec4\u6210\uff1f </li> </ul> <p>\u4e09\u90e8\u5206: Character Filter + Tokenizer + Token Filter</p> <ul> <li>8.\u5c1d\u8bd5\u63cf\u8ff0<code>match</code>\u548c<code>match_phrase</code>\u7684\u533a\u522b </li> </ul> <p><code>Match</code>\u4e2d\u7684<code>terms</code>\u4e4b\u95f4\u662f<code>or</code>\u7684\u5173\u7cfb\uff0c<code>Match Phrase</code>\u7684<code>terms</code>\u4e4b\u95f4\u662f<code>and</code>\u7684\u5173\u7cfb  \u5e76\u4e14<code>term</code>\u4e4b\u95f4\u4f4d\u7f6e\u5173\u7cfb\u4e5f\u5f71\u54cd\u641c\u7d22\u7684\u7ed3\u679c</p> <ul> <li>9.\u5982\u679c\u4f60\u5e0c\u671b<code>match_phrase</code>\u5339\u914d\u5230\u66f4\u591a\u7ed3\u679c\uff0c\u4f60\u5e94\u8be5\u914d\u7f6e\u67e5\u8be2\u4e2d\u4ec0\u4e48\u53c2\u6570\uff1f</li> </ul> <p>slop </p> <ul> <li>10.\u5982\u679c<code>Mapping</code>\u7684<code>dynamic</code>\u8bbe\u7f6e\u6210<code>\u201cstrict\"</code>\uff0c\u7d22\u5f15\u4e00\u4e2a\u5305\u542b\u65b0\u589e\u5b57\u6bb5\u7684\u6587\u6863\u65f6\u4f1a\u53d1\u751f\u4ec0\u4e48\uff1f </li> </ul> <p>\u76f4\u63a5\u62a5\u9519 </p> <ul> <li>11.\u5982\u679c<code>Mapping</code>\u7684<code>dynamic</code>\u8bbe\u7f6e\u6210<code>\u201cfalse\"</code>\uff0c\u7d22\u5f15\u4e00\u4e2a\u5305\u542b\u65b0\u589e\u5b57\u6bb5\u7684\u6587\u6863\u65f6\u4f1a\u53d1\u751f\u4ec0\u4e48\uff1f </li> </ul> <p>\u6587\u6863\u88ab\u7d22\u5f15\uff0c\u65b0\u7684\u5b57\u6bb5\u5728<code>_source</code>\u4e2d\u53ef\u89c1\u3002\u4f46\u662f\u8be5\u5b57\u6bb5\u65e0\u6cd5\u88ab\u641c\u7d22</p> <ul> <li>12.\u5224\u65ad\uff1a\u53ef\u4ee5\u628a\u4e00\u4e2a\u5b57\u6bb5\u7684\u7c7b\u578b\u4ece<code>\u201cinteger\u201d</code>\u6539\u6210<code>\u201clong\"</code>\uff0c\u56e0\u4e3a\u8fd9\u4e24\u4e2a\u7c7b\u578b\u662f\u517c\u5bb9\u7684 </li> </ul> <p>\u9519\u3002\u5b57\u6bb5\u7c7b\u578b\u4fee\u6539\uff0c\u9700\u8981\u91cd\u65b0reindex </p> <ul> <li>13\uff0e\u5224\u65ad\uff1a\u4f60\u53ef\u4ee5\u5728<code>Mapping</code>\u6587\u4ef6\u4e2d\u4e3a<code>indexing</code>\u548c<code>searching</code>\u6307\u5b9a\u4e0d\u540c\u7684<code>analyzer</code> </li> </ul> <p>\u5bf9\u3002\u53ef\u4ee5\u5728<code>Mapping</code>\u4e2d\u4e3a<code>index</code>\u548c<code>search</code>\u6307\u5b9a\u4e0d\u540c\u7684<code>analyizer</code></p> <ul> <li>14\uff0e\u5224\u65ad\uff1a\u5b57\u6bb5\u7c7b\u578b\u4e3aText\u7684\u5b57\u6bb5\uff0c\u4e00\u5b9a\u53ef\u4ee5\u88ab\u5168\u6587\u641c\u7d22 </li> </ul> <p>\u9519\u3002\u53ef\u4ee5\u901a\u8fc7\u4e3atext\u7c7b\u578b\u7684\u5b57\u6bb5\u6307\u5b9a<code>Not Indexed</code>\uff0c\u4f7f\u5176\u65e0\u6cd5\u88ab\u641c\u7d22 </p>"},{"location":"chap4/10ES_Autocomplete/","title":"\u7b2c\u5341\u8282 \u2f83\u52a8\u8865\u5168\u4e0e\u57fa\u4e8e\u4e0a\u4e0b\u6587\u7684\u63d0\u793a","text":""},{"location":"chap4/10ES_Autocomplete/#1the-completion-suggester","title":"1\u3001The Completion Suggester","text":"<ul> <li><code>Completion Suggester</code> \u63d0\u4f9b\u4e86\u201c\u2f83\u52a8\u5b8c\u6210\u201d (Auto Complete) \u7684\u529f\u80fd\u3002\u2f64\u6237\u6bcf\u8f93\u2f0a\u2f00\u4e2a\u5b57\u7b26\uff0c\u5c31\u9700\u8981\u5373\u65f6\u53d1\u9001\u2f00\u4e2a\u67e5\u8be2\u8bf7\u6c42\u5230\u540e\u6bb5\u67e5\u627e\u5339\u914d\u9879</li> <li>\u5bf9\u6027\u80fd\u8981\u6c42\u6bd4\u8f83\u82db\u523b\u3002Elasticsearch \u91c7\u2f64\u4e86\u4e0d\u540c\u7684\u6570\u636e\u7ed3\u6784\uff0c\u5e76\u2fae\u901a\u8fc7\u5012\u6392\u7d22\u5f15\u6765\u5b8c\u6210\u3002 \u800c\u662f\u5c06 Analyze \u7684\u6570\u636e\u7f16\u7801\u6210 FST \u548c\u7d22\u5f15\u2f00\u8d77\u5b58\u653e\u3002FST \u4f1a\u88ab ES \u6574\u4e2a\u52a0\u8f7d\u8fdb\u5185\u5b58\uff0c \u901f\u5ea6\u5f88\u5feb</li> <li>FST \u53ea\u80fd\u2f64\u4e8e\u524d\u7f00\u67e5\u627e</li> </ul>"},{"location":"chap4/10ES_Autocomplete/#2-completion-suggester","title":"2\u3001\u4f7f\u2f64 Completion Suggester \u7684\u4e00\u4e9b\u6b65\u9aa4","text":"<ul> <li>\u5b9a\u4e49 Mapping\uff0c\u4f7f\u2f64 \"completion\" type</li> <li>\u7d22\u5f15\u6570\u636e</li> <li>\u8fd0\u2f8f \"suggest\" \u67e5\u8be2\uff0c\u5f97\u5230\u641c\u7d22\u5efa\u8bae</li> </ul>"},{"location":"chap4/10ES_Autocomplete/#2-1","title":"2-1 \u7d22\u5f15\u6570\u636e","text":"<pre><code>DELETE articles\nPUT articles\n{\n  \"mappings\": {\n    \"properties\": {\n      \"title_completion\":{\n        \"type\": \"completion\"\n      }\n    }\n  }\n}\n</code></pre> <ul> <li><code>\"type\": \"completion\"</code></li> </ul>"},{"location":"chap4/10ES_Autocomplete/#2-2","title":"2-2 \u641c\u7d22\u6570\u636e","text":"<pre><code>POST articles/_search?pretty\n{\n  \"size\": 0,\n  \"suggest\": {\n    \"article-suggester\": {\n      \"prefix\": \"el \",\n      \"completion\": {\n        \"field\": \"title_completion\"\n      }\n    }\n  }\n}\n</code></pre> <p>Output</p> <pre><code>\"suggest\" : {\n    \"article-suggester\" : [\n      {\n        \"text\" : \"el \",\n        \"offset\" : 0,\n        \"length\" : 3,\n        \"options\" : [\n          {\n            \"text\" : \"Elasticsearch builds on top of lucene\",\n            \"_index\" : \"articles\",\n            \"_type\" : \"_doc\",\n            \"_id\" : \"Jv2OSXUBjbV1yvhlSMxj\",\n            \"_score\" : 1.0,\n            \"_source\" : {\n              \"title_completion\" : \"Elasticsearch builds on top of lucene\"\n            }\n          },\n...\n</code></pre>"},{"location":"chap4/10ES_Autocomplete/#3-context-suggester","title":"3\u3001\u4ec0\u4e48\u662f Context Suggester","text":"<ul> <li>Completion Suggester \u7684\u6269\u5c55</li> <li>\u53ef\u4ee5\u5728\u641c\u7d22\u4e2d\u52a0\u2f0a\u66f4\u591a\u7684\u4e0a\u4e0b\u2f42\u4fe1\u606f\uff0c\u4f8b\u5982\uff0c\u8f93\u5165 \u201cstar\u201d<ul> <li>\u5496\u5561\u76f8\u5173:\u5efa\u8bae \u201cStarbucks\u201d</li> <li>\u7535\u5f71\u76f8\u5173:\u201dstar wars\u201d</li> </ul> </li> </ul>"},{"location":"chap4/10ES_Autocomplete/#3-1-context-suggester","title":"3-1 \u5b9e\u73b0 Context Suggester","text":"<ul> <li>\u53ef\u4ee5\u5b9a\u4e49\u4e24\u79cd\u7c7b\u578b\u7684 Context<ul> <li>Category \u2013 \u4efb\u610f\u7684\u5b57\u7b26\u4e32</li> <li>Geo \u2013 \u5730\u7406\u7406\u4f4d\u7f6e\u4fe1\u606f</li> </ul> </li> <li>\u5b9e\u73b0 Context Suggester \u7684\u5177\u4f53\u6b65\u9aa4<ul> <li>\u5b9a\u5236\u4e00\u4e2a Mapping</li> <li>\u7d22\u5f15\u6570\u636e\uff0c\u5e76\u4e14\u4e3a\u6bcf\u4e2a\u2f42\u6863\u52a0\u2f0a Context \u4fe1\u606f</li> <li>\u7ed3\u5408 Context \u8fdb\u2f8f Suggestion \u67e5\u8be2</li> </ul> </li> </ul>"},{"location":"chap4/10ES_Autocomplete/#3-2-mapping","title":"3-2 \u5b9a\u4e49 Mapping","text":"<ul> <li>\u589e\u52a0 Contexts <ul> <li>Type</li> <li>name</li> </ul> </li> </ul> <pre><code>DELETE comments\nPUT comments\nPUT comments/_mapping\n{\n  \"properties\": {\n    \"comment_autocomplete\":{\n      \"type\": \"completion\",\n      \"contexts\":[{\n        \"type\":\"category\",\n        \"name\":\"comment_category\"\n      }]\n    }\n  }\n}\n</code></pre>"},{"location":"chap4/10ES_Autocomplete/#3-3","title":"3-3 \u7d22\u5f15\u6570\u636e","text":"<pre><code>POST comments/_doc\n{\n  \"comment\":\"I love the star war movies\",\n  \"comment_autocomplete\":{\n    \"input\":[\"star wars\"],\n    \"contexts\":{\n      \"comment_category\":\"movies\"\n    }\n  }\n}\n\nPOST comments/_doc\n{\n  \"comment\":\"Where can I find a Starbucks\",\n  \"comment_autocomplete\":{\n    \"input\":[\"starbucks\"],\n    \"contexts\":{\n      \"comment_category\":\"coffee\"\n    }\n  }\n}\n</code></pre>"},{"location":"chap4/10ES_Autocomplete/#3-4","title":"3-4 \u4e0d\u540c\u7684\u4e0a\u4e0b\u2f42\uff0c\u2f83\u52a8\u63d0\u793a","text":"<pre><code>POST comments/_search\n{\n  \"suggest\": {\n    \"MY_SUGGESTION\": {\n      \"prefix\": \"sta\",\n      \"completion\":{\n        \"field\":\"comment_autocomplete\",\n        \"contexts\":{\n          \"comment_category\":\"coffee\"\n        }\n      }\n    }\n  }\n}\n</code></pre> <p>Output :</p> <pre><code>\"suggest\" : {\n    \"MY_SUGGESTION\" : [\n      {\n        \"text\" : \"sta\",\n        \"offset\" : 0,\n        \"length\" : 3,\n        \"options\" : [\n          {\n            \"text\" : \"starbucks\",\n            \"_index\" : \"comments\",\n            \"_type\" : \"_doc\",\n            \"_id\" : \"Sv27SXUBjbV1yvhlJMyP\",\n            \"_score\" : 1.0,\n            \"_source\" : {\n              \"comment\" : \"Where can I find a Starbucks\",\n              \"comment_autocomplete\" : {\n                \"input\" : [\n                  \"starbucks\"\n                ],\n                \"contexts\" : {\n                  \"comment_category\" : \"coffee\"\n                }\n              }\n            },\n            \"contexts\" : {\n              \"comment_category\" : [\n                \"coffee\"\n              ]\n            }\n          }\n        ]\n</code></pre> <pre><code>POST comments/_search\n{\n  \"suggest\": {\n    \"MY_SUGGESTION\": {\n      \"prefix\": \"sta\",\n      \"completion\":{\n        \"field\":\"comment_autocomplete\",\n        \"contexts\":{\n          \"comment_category\":\"movies\"\n        }\n      }\n    }\n  }\n}\n</code></pre> <p>Output :</p> <pre><code>suggest\" : {\n    \"MY_SUGGESTION\" : [\n      {\n        \"text\" : \"sta\",\n        \"offset\" : 0,\n        \"length\" : 3,\n        \"options\" : [\n          {\n            \"text\" : \"star wars\",\n            \"_index\" : \"comments\",\n            \"_type\" : \"_doc\",\n            \"_id\" : \"Sf27SXUBjbV1yvhlG8zu\",\n            \"_score\" : 1.0,\n            \"_source\" : {\n              \"comment\" : \"I love the star war movies\",\n              \"comment_autocomplete\" : {\n                \"input\" : [\n                  \"star wars\"\n                ],\n                \"contexts\" : {\n                  \"comment_category\" : \"movies\"\n                }\n              }\n            },\n            \"contexts\" : {\n              \"comment_category\" : [\n                \"movies\"\n              ]\n            }\n          }\n        ]\n      }\n</code></pre>"},{"location":"chap4/10ES_Autocomplete/#3-5","title":"3-5 \u7cbe\u51c6\u5ea6\u548c\u53ec\u56de\u7387","text":"<ul> <li>\u7cbe\u51c6\u5ea6<ul> <li>Completion &gt; Phrase &gt; Term</li> </ul> </li> <li>\u53ec\u56de\u7387<ul> <li>Term &gt; Phrase &gt; Completion</li> </ul> </li> <li>\u6027\u80fd<ul> <li>Completion &gt; Phrase &gt; Term</li> </ul> </li> </ul>"},{"location":"chap4/10ES_Autocomplete/#4","title":"4\u3001\u672c\u8282\u77e5\u8bc6\u70b9\u56de\u987e","text":"<ul> <li>Completion Suggester\uff0c\u5bf9\u6027\u80fd\u8981\u6c42\u2f50\u8f83\u82db\u523b\u3002\u91c7\u2f64\u4e86\u4e0d\u540c\u7684\u6570\u636e\u7ed3\u6784\uff0c\u5e76\u2fae\u901a\u8fc7\u5012\u6392\u7d22\u5f15\u6765\u5b8c\u6210\u3002\u2f7d\u662f\u5c06 Analyze \u7684\u6570\u636e\u7f16\u7801\u6210 FST \u548c\u7d22\u5f15\u2f00\u8d77\u5b58\u653e\u3002FST \u4f1a\u88ab ES \u6574\u4e2a\u52a0\u8f7d\u8fdb\u5185\u5b58\uff0c\u901f\u5ea6\u5f88\u5feb</li> <li>\u9700\u8981\u8bbe\u7f6e\u7279\u5b9a\u7684 Mapping</li> <li>Context Completion Suggester \u2f40\u6301\u7ed3\u5408\u4e0d\u540c\u7684\u4e0a\u4e0b\u6587\uff0c\u7ed9\u51fa\u63a8\u8350</li> </ul>"},{"location":"chap4/11ES_CrossSearch/","title":"\u7b2c\u5341\u4e00\u8282 \u8de8\u96c6\u7fa4\u641c\u7d22","text":""},{"location":"chap4/11ES_CrossSearch/#1","title":"1\u3001\u6c34\u5e73\u6269\u5c55\u7684\u75db\u70b9","text":"<ul> <li>\u5355\u96c6\u7fa4 \u2013 \u5f53\u2f54\u5e73\u6269\u5c55\u65f6\uff0c\u8282\u70b9\u6570\u4e0d\u80fd\u2f46\u9650\u589e\u52a0<ul> <li>\u96c6\u7fa4\u7684 meta \u4fe1\u606f(\u8282\u70b9\uff0c\u7d22\u5f15\uff0c\u96c6\u7fa4\u72b6\u6001)\u8fc7\u591a\uff0c\u4f1a\u5bfc\u81f4\u66f4\u65b0\u538b\u529b\u53d8\u2f24\uff0c\u5355\u4e2a Active Master \u4f1a\u6210\u4e3a\u6027\u80fd\u74f6\u9888\uff0c\u5bfc\u81f4\u6574\u4e2a\u96c6\u7fa4\u2f46\u6cd5\u6b63\u5e38\u2f2f\u4f5c\u3001</li> </ul> </li> <li>\u65e9\u671f\u7248\u672c\uff0c\u901a\u8fc7 Tribe Node \u53ef\u4ee5\u5b9e\u73b0\u591a\u96c6\u7fa4\u8bbf\u95ee\u7684\u9700\u6c42\uff0c\u4f46\u662f\u8fd8\u5b58\u5728\u2f00\u5b9a\u7684\u95ee\u9898<ul> <li>Tribe Node \u4f1a\u4ee5 Client Node \u7684\u2f45\u5f0f\u52a0\u2f0a\u6bcf\u4e2a\u96c6\u7fa4\u3002 \u96c6\u7fa4\u4e2d Master \u8282\u70b9\u7684\u4efb\u52a1\u53d8\u66f4\u9700\u8981 Tribe Node \u7684\u56de\u5e94\u624d\u80fd\u7ee7\u7eed</li> <li>Tribe Node \u4e0d\u4fdd\u5b58 Cluster State \u4fe1\u606f\uff0c\u2f00\u65e6\u91cd\u542f\uff0c\u521d\u59cb\u5316\u5f88\u6162</li> <li>\u5f53\u591a\u4e2a\u96c6\u7fa4\u5b58\u5728\u7d22\u5f15\u91cd\u540d\u7684\u60c5\u51b5\u65f6\uff0c\u53ea\u80fd\u8bbe\u7f6e\u2f00\u79cd Prefer \u89c4\u5219</li> </ul> </li> </ul>"},{"location":"chap4/11ES_CrossSearch/#2-cross-cluster-search","title":"2\u3001\u8de8\u96c6\u7fa4\u641c\u7d22 - Cross Cluster Search","text":"<ul> <li>\u65e9\u671f Tribe Node \u7684\u2f45\u6848\u5b58\u5728\u2f00\u5b9a\u7684\u95ee\u9898\uff0c\u73b0\u5df2\u88ab Deprecated</li> <li>Elasticsearch 5.3 \u5f15\u2f0a\u4e86\u4e86\u8de8\u96c6\u7fa4\u641c\u7d22\u7684\u529f\u80fd(Cross Cluster Search)\uff0c\u63a8\u8350\u4f7f\u2f64<ul> <li>\u5141\u8bb8\u4efb\u4f55\u8282\u70b9\u626e\u6f14 federated \u8282\u70b9\uff0c\u4ee5\u8f7b\u91cf\u7684\u2f45\u5f0f\uff0c\u5c06\u641c\u7d22\u8bf7\u6c42\u8fdb\u884c\u4ee3\u7406</li> <li>\u4e0d\u9700\u8981\u4ee5 Client Node \u7684\u5f62\u5f0f\u52a0\u2f0a\u5176\u4ed6\u96c6\u7fa4</li> </ul> </li> </ul>"},{"location":"chap4/11ES_CrossSearch/#2-1","title":"2-1 \u914d\u7f6e\u53ca\u67e5\u8be2","text":"<p>\u542f\u52a83\u4e2a\u96c6\u7fa4:</p> <pre><code>elasticsearch -E node.name=cluster0node -E cluster.name=cluster0 -E path.data=cluster0_data -E discovery.type=single-node -E http.port=9200 -E transport.port=9300\nelasticsearch -E node.name=cluster1node -E cluster.name=cluster1 -E path.data=cluster1_data -E discovery.type=single-node -E http.port=9201 -E transport.port=9301\nelasticsearch -E node.name=cluster2node -E cluster.name=cluster2 -E path.data=cluster2_data -E discovery.type=single-node -E http.port=9202 -E transport.port=9302\n</code></pre> <p>\u5728\u6bcf\u4e2a\u96c6\u7fa4\u4e0a\u8bbe\u7f6e\u52a8\u6001\u7684\u8bbe\u7f6e</p> <pre><code>\nPUT _cluster/settings\n{\n  \"persistent\": {\n    \"cluster\": {\n      \"remote\": {\n        \"cluster0\": {\n          \"seeds\": [\n            \"127.0.0.1:9300\"\n          ],\n          \"transport.ping_schedule\": \"30s\"\n        },\n        \"cluster1\": {\n          \"seeds\": [\n            \"127.0.0.1:9301\"\n          ],\n          \"transport.compress\": true,\n          \"skip_unavailable\": true\n        },\n        \"cluster2\": {\n          \"seeds\": [\n            \"127.0.0.1:9302\"\n          ]\n        }\n      }\n    }\n  }\n</code></pre> <p>CURL:</p> <pre><code>curl -XPUT \"http://localhost:9200/_cluster/settings\" -H 'Content-Type: application/json' -d'\n{\"persistent\":{\"cluster\":{\"remote\":{\"cluster0\":{\"seeds\":[\"127.0.0.1:9300\"],\"transport.ping_schedule\":\"30s\"},\"cluster1\":{\"seeds\":[\"127.0.0.1:9301\"],\"transport.compress\":true,\"skip_unavailable\":true},\"cluster2\":{\"seeds\":[\"127.0.0.1:9302\"]}}}}}'\n\ncurl -XPUT \"http://localhost:9201/_cluster/settings\" -H 'Content-Type: application/json' -d'\n{\"persistent\":{\"cluster\":{\"remote\":{\"cluster0\":{\"seeds\":[\"127.0.0.1:9300\"],\"transport.ping_schedule\":\"30s\"},\"cluster1\":{\"seeds\":[\"127.0.0.1:9301\"],\"transport.compress\":true,\"skip_unavailable\":true},\"cluster2\":{\"seeds\":[\"127.0.0.1:9302\"]}}}}}'\n\ncurl -XPUT \"http://localhost:9202/_cluster/settings\" -H 'Content-Type: application/json' -d'\n{\"persistent\":{\"cluster\":{\"remote\":{\"cluster0\":{\"seeds\":[\"127.0.0.1:9300\"],\"transport.ping_schedule\":\"30s\"},\"cluster1\":{\"seeds\":[\"127.0.0.1:9301\"],\"transport.compress\":true,\"skip_unavailable\":true},\"cluster2\":{\"seeds\":[\"127.0.0.1:9302\"]}}}}}'\n</code></pre> <p>\u521b\u5efa\u6d4b\u8bd5\u6570\u636e</p> <pre><code>curl -XPOST \"http://localhost:9200/users/_doc\" -H 'Content-Type: application/json' -d'\n{\"name\":\"user1\",\"age\":10}'\n\ncurl -XPOST \"http://localhost:9201/users/_doc\" -H 'Content-Type: application/json' -d'\n{\"name\":\"user2\",\"age\":20}'\n\ncurl -XPOST \"http://localhost:9202/users/_doc\" -H 'Content-Type: application/json' -d'\n{\"name\":\"user3\",\"age\":30}'\n</code></pre> <pre><code>{\n   \"took\":439,\n   \"timed_out\":false,\n   \"num_reduce_phases\":4,\n   \"_shards\":{\n      \"total\":3,\n      \"successful\":3,\n      \"skipped\":0,\n      \"failed\":0\n   },\n   \"_clusters\":{\n      \"total\":3,\n      \"successful\":3,\n      \"skipped\":0\n   },\n   \"hits\":{\n      \"total\":{\n         \"value\":2,\n         \"relation\":\"eq\"\n      },\n      \"max_score\":1.0,\n      \"hits\":[\n         {\n            \"_index\":\"cluster2:users\",\n            \"_type\":\"_doc\",\n            \"_id\":\"CG8XSnUBeZ4GOW5EkMpk\",\n            \"_score\":1.0,\n            \"_source\":{\n               \"name\":\"user3\",\n               \"age\":30\n            }\n         },\n         {\n            \"_index\":\"cluster1:users\",\n            \"_type\":\"_doc\",\n            \"_id\":\"NO4XSnUBuZtUD0itPVYH\",\n            \"_score\":1.0,\n            \"_source\":{\n               \"name\":\"user2\",\n               \"age\":20\n            }\n         }\n      ]\n   }\n}\n</code></pre> <ul> <li>http://192.168.33.12:9200/_cat/nodes</li> <li>http://192.168.33.12:9201/_cat/nodes</li> <li>http://192.168.33.12:9202/_cat/nodes</li> </ul> <p> </p> <ul> <li>http://192.168.33.12:9202/_cat/indices</li> <li>http://192.168.33.12:9201/_cat/indices</li> <li>http://192.168.33.12:9200/_cat/indices</li> </ul> <p> </p> <p>\u67e5\u8be2</p> <pre><code>GET /users,cluster1:users,cluster2:users/_search\n{\n  \"query\": {\n    \"range\": {\n      \"age\": {\n        \"gte\": 20,\n        \"lte\": 40\n      }\n    }\n  }\n}\n</code></pre> <p>\u67e5\u8be2CURL</p> <pre><code>curl -XGET \"http://localhost:9200/users,cluster1:users,cluster2:users/_search\" -H 'Content-Type: application/json' -d'{ \"query\": {\"range\": { \"age\": {  \"gte\": 20,\"lte\": 40 } } } }'\n</code></pre> <pre><code>{\n   \"took\":439,\n   \"timed_out\":false,\n   \"num_reduce_phases\":4,\n   \"_shards\":{\n      \"total\":3,\n      \"successful\":3,\n      \"skipped\":0,\n      \"failed\":0\n   },\n   \"_clusters\":{\n      \"total\":3,\n      \"successful\":3,\n      \"skipped\":0\n   },\n   \"hits\":{\n      \"total\":{\n         \"value\":2,\n         \"relation\":\"eq\"\n      },\n      \"max_score\":1.0,\n      \"hits\":[\n         {\n            \"_index\":\"cluster2:users\",\n            \"_type\":\"_doc\",\n            \"_id\":\"CG8XSnUBeZ4GOW5EkMpk\",\n            \"_score\":1.0,\n            \"_source\":{\n               \"name\":\"user3\",\n               \"age\":30\n            }\n         },\n         {\n            \"_index\":\"cluster1:users\",\n            \"_type\":\"_doc\",\n            \"_id\":\"NO4XSnUBuZtUD0itPVYH\",\n            \"_score\":1.0,\n            \"_source\":{\n               \"name\":\"user2\",\n               \"age\":20\n            }\n         }\n      ]\n   }\n}\n</code></pre>"},{"location":"chap4/11ES_CrossSearch/#3demo","title":"3\u3001Demo","text":"<ul> <li>\u914d\u7f6e\u8de8\u96c6\u7fa4\u641c\u7d22</li> <li>\u6bcf\u4e2a\u96c6\u7fa4\u521b\u5efa\u76f8\u540c\u7684\u7d22\u5f15\u540d\uff0c\u5e76\u5199\u2f0a\u5165\u6570\u636e</li> <li>\u8de8\u96c6\u7fa4\u641c\u7d22</li> <li>\u5728 Kibana \u7684 Index Pattern \u4e2d\u914d\u7f6e\u8de8\u96c6\u7fa4\u641c\u7d22</li> </ul>"},{"location":"chap4/11ES_CrossSearch/#4","title":"4\u3001\u672c\u8282\u77e5\u8bc6\u70b9\u56de\u987e","text":"<ul> <li>\u5f53\u96c6\u7fa4\u2f46\u6cd5\u2f54\u5e73\u6269\u5c55\uff0c\u6216\u8005\u9700\u8981\u5c06\u4e0d\u540c\u7684\u96c6\u7fa4\u6570\u636e\u5b9e\u73b0\u6570\u636e\u7684 Federation\uff0c\u53ef\u4ee5\u91c7\u2f64\u8de8\u96c6\u7fa4\u641c\u7d22(CCS)</li> <li><code>Tribe Node</code> \u548c <code>Cross Cluster Search</code> \u7684\u6bd4\u8f83\uff0c\u63a8\u8350\u5728\u65b0\u7248\u672c\u4e2d\u4f7f\u7528 <code>CCS</code></li> <li>\u5982\u4f55\u914d\u7f6e\u5e76\u4f7f\u2f64\u7528 <code>Cross Cluster Search</code> \u67e5\u8be2\u6570\u636e</li> </ul>"},{"location":"chap4/1ES_search/","title":"\u7b2c\u4e00\u8282 \u57fa\u4e8e\u8bcd\u9879\u548c\u57fa\u4e8e\u5168\u6587\u7684\u641c\u7d22","text":""},{"location":"chap4/1ES_search/#1term","title":"1\u3001\u57fa\u4e8eTerm\u7684\u67e5\u8be2","text":"<ul> <li>Term\u7684\u91cd\u8981\u6027<ul> <li>Term\u662f\u8868\u8fbe\u8bed\u610f\u7684\u6700\u5c0f\u5355\u4f4d\u3002\u641c\u7d22\u548c\u5229\u7528\u7edf\u8ba1\u8bed\u8a00\u6a21\u578b\u8fdb\u884c\u81ea\u7136\u8bed\u8a00\u5904\u7406\u90fd\u9700\u8981\u5904\u7406Term </li> </ul> </li> <li>\u7279\u70b9<ul> <li>Term Level Query:<code>Term Query</code>\uff0f<code>Range Query</code>\uff0f<code>Exists Query</code>\uff0f<code>Prefix Query</code>/<code>Wildcard Query</code> </li> <li>\u5728ES\u4e2d\uff0cTerm\u67e5\u8be2\uff0c\u5bf9\u8f93\u5165\u4e0d\u505a\u5206\u8bcd\u3002\u4f1a\u5c06\u8f93\u5165\u4f5c\u4e3a\u4e00\u4e2a\u6574\u4f53\uff0c\u5728\u5012\u6392\u7d22\u5f15\u4e2d\u67e5\u627e\u51c6\u786e\u7684\u8bcd\u9879\uff0c\u5e76\u4e14\u4f7f\u7528\u76f8\u5173\u5ea6\u7b97\u5206\u516c\u5f0f\u4e3a\u6bcf\u4e2a\u5305\u542b\u8be5\u8bcd\u9879\u7684\u6587\u6863\u8fdb\u884c\u76f8\u5173\u5ea6\u7b97\u5206\u4e00\u4f8b\u5982\u201cApple Store\" </li> <li>\u53ef\u4ee5\u901a\u8fc7<code>Constant Score</code>\u5c06\u67e5\u8be2\u8f6c\u6362\u6210\u4e00\u4e2aFiltering,\u907f\u514d\u7b97\u5206\uff0c\u5e76\u5229\u7528\u7f13\u5b58\uff0c\u63d0\u9ad8\u6027\u80fd </li> </ul> </li> </ul>"},{"location":"chap4/1ES_search/#1-1-term","title":"1-1 \u5173\u4e8e<code>Term</code>\u7684\u67e5\u8be2\u4f8b\u5b50","text":"<pre><code>DELETE products\n\nPUT products\n{\n  \"settings\": {\n    \"number_of_shards\": 1\n  }\n}\n</code></pre> <pre><code>{\n  \"acknowledged\" : true,\n  \"shards_acknowledged\" : true,\n  \"index\" : \"products\"\n}\n</code></pre> <p>\u51e0\u4e2a\u601d\u8003\u9898</p> <ul> <li>\u51e0\u4e2a\u67e5\u8be2\u7684\u7ed3\u679c\u5206\u522b\u662f\u4ec0\u4e48\uff1f </li> <li>\u5982\u679c\u641c\u4e0d\u5230\uff0c\u4e3a\u4ec0\u4e48\uff1f </li> <li>\u5e94\u8be5\u5982\u4f55\u89e3\u51b3 </li> </ul> <pre><code>POST /products/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"productID\" : \"XHDK-A-1293-#fJ3\",\"desc\":\"iPhone\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"productID\" : \"KDKE-B-9947-#kL5\",\"desc\":\"iPad\" }\n{ \"index\": { \"_id\": 3 }}\n{ \"productID\" : \"JODL-X-1937-#pV7\",\"desc\":\"MBP\" }\n</code></pre> <pre><code>...\n{\n  \"took\" : 818,\n  \"errors\" : false,\n  \"items\" : [\n    {\n      \"index\" : {\n        \"_index\" : \"products\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"1\",\n        \"_version\" : 1,\n        \"result\" : \"created\",\n        \"_shards\" : {\n          \"total\" : 2,\n          \"successful\" : 2,\n          \"failed\" : 0\n        },\n        \"_seq_no\" : 0,\n        \"_primary_term\" : 1,\n        \"status\" : 201\n      }\n    },\n...\n</code></pre> <pre><code>GET /products\n</code></pre> <p></p> <p>\u5206\u8bcd\u5668\u4f1a\u81ea\u52a8 \u2014\u2014 \u5c0f\u5199\u5316</p> <pre><code>POST /products/_search\n{\n  \"query\": {\n    \"term\": {\n      \"desc\": {\n        \"value\": \"iPhone\"\n      }\n    }\n  }\n}\n</code></pre> <p></p> <pre><code>POST /products/_search\n{\n  \"query\": {\n    \"term\": {\n      \"desc\": {\n        \"value\": \"iphone\"   \n      }\n    }\n  }\n}\n</code></pre> <p></p> <pre><code>POST /products/_search\n{\n  \"query\": {\n    \"term\": {\n      \"productID\": {\n        \"value\": \"XHDK-A-1293-#fJ3\"\n      }\n    }\n  }\n}\n</code></pre> <p>output</p> <pre><code>\"hits\" : {\n    \"total\" : {\n      \"value\" : 0,\n      \"relation\" : \"eq\"\n    },\n</code></pre> <ul> <li><code>\"value\": \"XHDK-A-1293-#fJ3\"</code></li> <li><code>\"value\": \"xhdk-a-1293-#fJ3\"</code></li> <li><code>\"value\": \"xhdk\"</code></li> </ul> <pre><code>POST /products/_search\n{\n  \"query\": {\n    \"term\": {\n      \"productID\": {\n        \"value\": \"xhdk-a-1293-#fJ3\"\n      }\n    }\n  }\n}\n</code></pre> <p>output</p> <pre><code>\"hits\" : {\n    \"total\" : {\n      \"value\" : 0,\n      \"relation\" : \"eq\"\n    },\n</code></pre> <pre><code>POST /products/_search\n{\n  \"query\": {\n    \"term\": {\n      \"productID\": {\n        \"value\": \"xhdk\"\n      }\n    }\n  }\n}\n</code></pre> <p></p>"},{"location":"chap4/1ES_search/#1-2-mappingterm","title":"1-2 \u591a\u5b57\u6bb5Mapping\u548cTerm\u67e5\u8be2","text":"<pre><code>GET /products/_mapping\n</code></pre> <p>Output :</p> <pre><code>{\n  \"products\" : {\n    \"mappings\" : {\n      \"properties\" : {\n        \"desc\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n            }\n          }\n        },\n        \"productID\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 251_6\n            }\n          }\n        }\n      }\n    }\n  }\n}\n</code></pre> <pre><code>POST /products/_search\n{\n  \"query\": {\n    \"term\": {\n      \"productID.keyword\": {\n        \"value\": \"XHDK-A-1293-#fJ3\"\n      }\n    }\n  }\n}\n</code></pre> <ul> <li><code>\"productID.keyword\"</code></li> </ul> <p></p> <pre><code>POST /products/_search\n{\n  \"explain\": true,\n  \"query\": {\n    \"term\": {\n      \"productID.keyword\": {\n        \"value\": \"XHDK-A-1293-#fJ3\"\n      }\n    }\n  }\n}\n</code></pre> <ul> <li><code>\"explain\": true,</code></li> </ul> <pre><code>\"hits\" : [\n      {\n        \"_shard\" : \"[products][0]\",\n        \"_node\" : \"lTFD6qBCQ460xdW8XFgaIg\",\n        \"_index\" : \"products\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"1\",\n        \"_score\" : 0.9808291,\n        \"_source\" : {\n          \"productID\" : \"XHDK-A-1293-#fJ3\",\n          \"desc\" : \"iPhone\"\n        },\n        \"_explanation\" : {\n          \"value\" : 0.9808291,\n          \"description\" : \"weight(productID.keyword:XHDK-A-1293-#fJ3 in 0) [PerFieldSimilarity], result of:\",\n          \"details\" : [\n            {\n              \"value\" : 0.9808291,\n              \"description\" : \"score(freq=1.0), computed as boost * idf * tf from:\",\n              \"details\" : [\n                {\n                  \"value\" : 2.2,\n                  \"description\" : \"boost\",\n                  \"details\" : [ ]\n                },\n                {\n                  \"value\" : 0.98082924,\n                  \"description\" : \"idf, computed as log(1 + (N - n + 0.5) / (n + 0.5)) from:\",\n                  \"details\" : [\n                    {\n                      \"value\" : 1,\n                      \"description\" : \"n, number of documents containing term\",\n                      \"details\" : [ ]\n                    },\n                    {\n                      \"value\" : 3,\n                      \"description\" : \"N, total number of documents with field\",\n                      \"details\" : [ ]\n                    }\n                  ]\n                },\n                {\n                  \"value\" : 0.45454544,\n                  \"description\" : \"tf, computed as freq / (freq + k1 * (1 - b + b * dl / avgdl)) from:\",\n                  \"details\" : [\n                    {\n                      \"value\" : 1.0,\n                      \"description\" : \"freq, occurrences of term within document\",\n                      \"details\" : [ ]\n                    },\n                    {\n                      \"value\" : 1.2,\n                      \"description\" : \"k1, term saturation parameter\",\n                      \"details\" : [ ]\n                    },\n                    {\n                      \"value\" : 0.75,\n                      \"description\" : \"b, length normalization parameter\",\n                      \"details\" : [ ]\n                    },\n                    {\n                      \"value\" : 1.0,\n                      \"description\" : \"dl, length of field\",\n                      \"details\" : [ ]\n                    },\n                    {\n                      \"value\" : 1.0,\n                      \"description\" : \"avgdl, average length of field\",\n                      \"details\" : [ ]\n                    }\n                  ]\n</code></pre>"},{"location":"chap4/1ES_search/#1-3-constant-scorefilter","title":"1-3 \u590d\u5408\u67e5\u8be2\u4e00<code>Constant Score</code>\u8f6c\u4e3a<code>Filter</code>","text":"<ul> <li>\u5c06Query\u8f6c\u6210Filter\uff0c\u5ffd\u7565<code>TF-IDF</code>\u8ba1\u7b97\uff0c\u907f\u514d\u76f8\u5173\u6027\u7b97\u5206\u7684\u5f00\u9500 </li> <li>Filter\u53ef\u4ee5\u6709\u6548\u5229\u7528\u7f13\u5b58 </li> </ul> <p>Demo</p> <ul> <li>Term\u67e5\u8be2\u67e5\u770b\u7b97\u5206 </li> <li>Constant Score Filter </li> </ul> <pre><code>POST /products/_search\n{\n  \"explain\": true,\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"term\": {\n          \"productID.keyword\": \"XHDK-A-1293-#fJ3\"\n        }\n      }\n    }\n  }\n}\n</code></pre> <p><code>\"productID.keyword\": \"XHDK-A-1293-#fJ3\"</code></p> <p></p>"},{"location":"chap4/1ES_search/#2","title":"2\u3001\u57fa\u4e8e\u5168\u6587\u7684\u67e5\u8be2","text":"<ul> <li>\u57fa\u4e8e\u5168\u6587\u7684\u67e5\u8be2<ul> <li><code>Match Query/Match Phrase Query/Query String Query</code></li> </ul> </li> <li>\u7279\u70b9 <ul> <li>\u7d22\u5f15\u548c\u641c\u7d22\u65f6\u90fd\u4f1a\u8fdb\u884c\u5206\u8bcd\uff0c\u67e5\u8be2\u5b57\u7b26\u4e32\u5148\u4f20\u9012\u5230\u4e00\u4e2a\u5408\u9002\u7684\u5206\u8bcd\u5668\uff0c\u7136\u540e\u751f\u6210\u4e00\u4e2a\u4f9b\u67e5\u8be2\u7684\u8bcd\u9879\u5217\u8868 </li> <li>\u67e5\u8be2\u65f6\u5019\uff0c\u5148\u4f1a\u5bf9\u8f93\u5165\u7684\u67e5\u8be2\u8fdb\u884c\u5206\u8bcd\uff0c\u7136\u540e\u6bcf\u4e2a\u8bcd\u9879\u9010\u4e2a\u8fdb\u884c\u5e95\u5c42\u7684\u67e5\u8be2\uff0c\u6700\u7ec8\u5c06\u7ed3\u679c\u8fdb\u884c\u5408<code>Matrix</code>\u6216\u8005<code>reload</code>\u5408\u5e76\u3002\u5e76\u4e3a\u6bcf\u4e2a\u6587\u6863\u751f\u6210\u4e00\u4e2a\u7b97\u5206\u3002\u2014\u2014\u4f8b\u5982\u67e5\u201cMatrix reloaded\"\uff0c\u4f1a\u67e5\u5230\u5305\u62ec\u7684\u6240\u6709\u7ed3\u679c\u3002 </li> </ul> </li> </ul>"},{"location":"chap4/1ES_search/#2-1-match-query-result","title":"2-1 Match Query Result","text":"<pre><code>POST movies/_search\n{\n  \"query\": {\n    \"match\": {\n      \"title\": {\n        \"query\": \"Matrix reloaded\"\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"chap4/1ES_search/#2-2-operator","title":"2-2 Operator","text":"<pre><code>POST movies/_search\n{ \n  \"profile\": true,\n  \"query\": {\n    \"match\": {\n      \"title\": {\n        \"query\": \"Matrix reloaded\",\n        \"operator\": \"AND\"\n      }\n    }\n  }\n}\n</code></pre> <ul> <li><code>\"operator\": \"AND\"</code></li> </ul>"},{"location":"chap4/1ES_search/#2-3-minimum_should_match","title":"2-3 <code>Minimum_should_match</code>","text":"<pre><code>POST movies/_search\n{ \n  \"profile\": true,\n  \"query\": {\n    \"match\": {\n      \"title\": {\n        \"query\": \"Matrix reloaded\",\n        \"minimum_should_match\": 2\n      }\n    }\n  }\n}\n</code></pre> <ul> <li><code>\"minimum_should_match\": 2</code></li> </ul>"},{"location":"chap4/1ES_search/#2-4-match-phrase-query","title":"2-4 Match Phrase Query","text":"<pre><code>POST movies/_search\n{ \n  \"profile\": true,\n  \"query\": {\n    \"match_phrase\": {\n      \"title\": {\n        \"query\": \"Matrix reloaded\",\n        \"slop\": 1\n      }\n    }\n  }\n}\n</code></pre> <ul> <li><code>\"query\": \"Matrix reloaded\"</code></li> <li><code>\"slop\": 1</code></li> </ul>"},{"location":"chap4/1ES_search/#2-5-match-query","title":"2-5 Match Query\u67e5\u8be2\u8fc7\u7a0b","text":"<ul> <li> <p>\u57fa\u4e8e\u5168\u6587\u7684\u67e5\u8be2</p> <ul> <li><code>Match Query/Match Phrase Query/Query String Query</code></li> </ul> </li> <li> <p>\u57fa\u4e8e\u5168\u6587\u7684\u67e5\u8be2\u7684\u7279\u70b9 </p> <ul> <li>\u7d22\u5f15\u548c\u641c\u7d22\u65f6\u90fd\u4f1a\u8fdb\u884c\u5206\u8bcd\uff0c\u67e5\u8be2\u5b57\u7b26\u4e32\u5148\u4f20\u9012\u5230\u4e00\u4e2a\u5408\u9002\u7684\u5206\u8bcd\u5668\uff0c\u7136\u540e\u751f\u6210\u4e00\u4e2a\u4f9b\u67e5\u8be2\u7684\u8bcd\u9879\u5217\u8868 </li> <li>\u67e5\u8be2\u65f6\u5019\uff0c\u5148\u4f1a\u5bf9\u8f93\u5165\u7684\u67e5\u8be2\u8fdb\u884c\u5206\u8bcd\uff0c\u7136\u540e\u6bcf\u4e2a\u8bcd\u9879\u9010\u4e2a\u8fdb\u884c\u5e95\u5c42\u7684\u67e5\u8be2\uff0c\u5e76\u4e3a\u6bcf\u4e2a\u6587\u6863\u751f\u6210\u4e00\u4e2a\u7b97\u5206</li> </ul> </li> </ul> <p></p>"},{"location":"chap4/1ES_search/#3","title":"3\u3001\u672c\u8282\u77e5\u8bc6\u70b9\u56de\u987e","text":"<ul> <li>\u57fa\u4e8e\u8bcd\u9879\u7684\u67e5\u627evs\u57fa\u4e8e\u5168\u6587\u7684\u67e5\u627e </li> <li>\u901a\u8fc7\u5b57\u6bb5Mapping\u63a7\u5236\u5b57\u6bb5\u7684\u5206\u8bcd <ul> <li>\"Text\" vs \"Keyword\" </li> </ul> </li> <li>\u901a\u8fc7\u53c2\u6570\u63a7\u5236\u67e5\u8be2\u7684Precision&amp;Recall </li> <li>\u590d\u5408\u67e5\u8be2\u4e00<code>Constant Score</code>\u67e5\u8be2 <ul> <li>\u5373\u4fbf\u662f\u5bf9<code>Keyword</code>\u8fdb\u884c<code>term</code>\u67e5\u8be2\uff0c\u540c\u6837\u4f1a\u8fdb\u884c\u7b97\u5206 </li> <li>\u53ef\u4ee5\u5c06\u67e5\u8be2\u8f6c\u4e3a<code>Filtering</code>\uff0c\u53d6\u6d88\u76f8\u5173\u6027\u7b97\u5206\u7684\u73af\u8282\uff0c\u4ee5\u63d0\u5347\u6027\u80fd </li> </ul> </li> </ul> <pre><code>#\u8bbe\u7f6e position_increment_gap\nDELETE groups\nPUT groups\n{\n  \"mappings\": {\n    \"properties\": {\n      \"names\":{\n        \"type\": \"text\",\n        \"position_increment_gap\": 0\n      }\n    }\n  }\n</code></pre> <pre><code>{\n  \"acknowledged\" : true,\n  \"shards_acknowledged\" : true,\n  \"index\" : \"groups\"\n}\n</code></pre> <pre><code>GET groups/_mapping\n</code></pre> <p>output :</p> <pre><code>{\n  \"groups\" : {\n    \"mappings\" : {\n      \"properties\" : {\n        \"names\" : {\n          \"type\" : \"text\",\n          \"position_increment_gap\" : 0\n        }\n      }\n    }\n  }\n}\n</code></pre> <pre><code>POST groups/_doc\n{\n  \"names\": [ \"John Water\", \"Water Smith\"]\n}\n</code></pre> <pre><code>POST groups/_search\n{\n  \"query\": {\n    \"match_phrase\": {\n      \"names\": {\n        \"query\": \"Water Water\",\n        \"slop\": 100\n      }\n    }\n  }\n}\n</code></pre> <p></p> <pre><code>POST groups/_search\n{\n  \"profile\": true,\n  \"query\": {\n    \"match_phrase\": {\n      \"names\": \"Water Smith\"\n    }\n  }\n</code></pre> <pre><code>...\ndescription\" : \"names:\\\"water smith\\\"\",\n</code></pre>"},{"location":"chap4/2ES_search_str_score/","title":"\u7b2c\u4e8c\u8282 \u7ed3\u6784\u5316\u641c\u7d22\u4ee5\u53ca\u641c\u7d22\u7684\u76f8\u5173\u6027\u7b97\u5206","text":""},{"location":"chap4/2ES_search_str_score/#1","title":"1\u3001\u7ed3\u6784\u5316\u641c\u7d22","text":""},{"location":"chap4/2ES_search_str_score/#1-1","title":"1-1 \u7ed3\u6784\u5316\u6570\u636e","text":"<ul> <li>\u7ed3\u6784\u5316\u641c\u7d22\uff08<code>Structured search</code>)\u662f\u6307\u5bf9\u7ed3\u6784\u5316\u6570\u636e\u7684\u641c\u7d22 <ul> <li>\u65e5\u671f\uff0c\u5e03\u5c14\u7c7b\u578b\u548c\u6570\u5b57\u90fd\u662f\u7ed3\u6784\u5316\u7684 </li> </ul> </li> <li>\u6587\u672c\u4e5f\u53ef\u4ee5\u662f\u7ed3\u6784\u5316\u7684\u3002 <ul> <li>\u5982\u5f69\u8272\u7b14\u53ef\u4ee5\u6709\u79bb\u6563\u7684\u989c\u8272\u96c6\u5408\uff1a\u7ea2\uff08red)\u3001\u7eff\uff08green)\u3001\u84dd\uff08blue) </li> <li>\u4e00\u4e2a\u535a\u5ba2\u53ef\u80fd\u88ab\u6807\u8bb0\u4e86\u6807\u7b7e\uff0c\u4f8b\u5982\uff0c\u5206\u5e03\u5f0f\uff08distributed)\u548c\u641c\u7d22\uff08search) </li> <li>\u7535\u5546\u7f51\u7ad9\u4e0a\u7684\u5546\u54c1\u90fd\u6709UPCs\uff08\u901a\u7528\u4ea7\u54c1\u7801Universal Product Codes)\u6216\u5176\u4ed6\u7684\u552f\u4e00\u6807\u8bc6\uff0c\u5b83\u4eec\u90fd\u9700\u8981\u9075\u4ece\u4e25\u683c\u89c4\u5b9a\u7684\u3001\u7ed3\u6784\u5316\u7684\u683c\u5f0f\u3002 </li> </ul> </li> </ul>"},{"location":"chap4/2ES_search_str_score/#1-2-es","title":"1-2 ES\u4e2d\u7684\u7ed3\u6784\u5316\u641c\u7d22","text":"<ul> <li>\u5e03\u5c14\uff0c\u65f6\u95f4\uff0c\u65e5\u671f\u548c\u6570\u5b57\u8fd9\u7c7b\u7ed3\u6784\u5316\u6570\u636e\uff1a\u6709\u7cbe\u786e\u7684\u683c\u5f0f\uff0c\u6211\u4eec\u53ef\u4ee5\u5bf9\u8fd9\u4e9b\u683c\u5f0f\u8fdb\u884c\u903b\u8f91\u64cd\u4f5c\u3002\u5305\u62ec\u6bd4\u8f83\u6570\u5b57\u6216\u65f6\u95f4\u7684\u8303\u56f4\uff0c\u6216\u5224\u5b9a\u4e24\u4e2a\u503c\u7684\u5927\u5c0f\u3002 </li> <li>\u7ed3\u6784\u5316\u7684\u6587\u672c\u53ef\u4ee5\u505a\u7cbe\u786e\u5339\u914d\u6216\u8005\u90e8\u5206\u5339\u914d <ul> <li>Term\u67e5\u8be2\uff0fPrefix\u524d\u7f00\u67e5\u8be2 </li> </ul> </li> <li>\u7ed3\u6784\u5316\u7ed3\u679c\u53ea\u6709\u201c\u662f\u201d\u6216\u201c\u5426\u201d\u4e24\u4e2a\u503c <ul> <li>\u6839\u636e\u573a\u666f\u9700\u8981\uff0c\u53ef\u4ee5\u51b3\u5b9a\u7ed3\u6784\u5316\u641c\u7d22\u662f\u5426\u9700\u8981\u6253\u5206 </li> </ul> </li> </ul> <pre><code>#\u7ed3\u6784\u5316\u641c\u7d22\uff0c\u7cbe\u786e\u5339\u914d\nDELETE products\n\nPOST /products/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"price\" : 10,\"avaliable\":true,\"date\":\"2018-01-01\", \"productID\" : \"XHDK-A-1293-#fJ3\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"price\" : 20,\"avaliable\":true,\"date\":\"2019-01-01\", \"productID\" : \"KDKE-B-9947-#kL5\" }\n{ \"index\": { \"_id\": 3 }}\n{ \"price\" : 30,\"avaliable\":true, \"productID\" : \"JODL-X-1937-#pV7\" }\n{ \"index\": { \"_id\": 4 }}\n{ \"price\" : 30,\"avaliable\":false, \"productID\" : \"QQPX-R-3956-#aD8\" }\n\nGET products/_mapping\n</code></pre> <p>Output :</p> <pre><code>{\n  \"products\" : {\n    \"mappings\" : {\n      \"properties\" : {\n        \"avaliable\" : {\n          \"type\" : \"boolean\"\n        },\n        \"date\" : {\n          \"type\" : \"date\"\n        },\n        \"price\" : {\n          \"type\" : \"long\"\n        },\n        \"productID\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n            }\n          }\n        }\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"chap4/2ES_search_str_score/#1-3","title":"1-3 \u5e03\u5c14\u503c","text":"<p>\u5bf9\u5e03\u5c14\u503c match \u67e5\u8be2\uff0c\u6709\u7b97\u5206</p> <pre><code>POST products/_search\n{\n  \"query\": {\n    \"term\": {\n      \"avaliable\": {\n        \"value\": \"false\"\n      }\n    }\n  }\n}\n</code></pre> <p>Output :</p> <pre><code>\"max_score\" : 1.2039728,\n    \"hits\" : [\n      {\n        \"_index\" : \"products\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"4\",\n        \"_score\" : 1.2039728,\n        \"_source\" : {\n          \"price\" : 30,\n          \"avaliable\" : false,\n          \"productID\" : \"QQPX-R-3956-#aD8\"\n        }\n      }\n    ]\n  }\n</code></pre> <p><code>\"_score\" : 1.2039728,</code></p> <pre><code>\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"term\": {\n      \"avaliable\": true\n    }\n  }\n}\n</code></pre> <p>\u5bf9\u5e03\u5c14\u503c\uff0c\u901a\u8fc7<code>constant score</code> \u8f6c\u6210 <code>filtering</code>\uff0c\u6ca1\u6709\u7b97\u5206</p> <pre><code>POST products/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"term\": {\n          \"avaliable\": \"false\"\n        }\n      }\n    }\n  }\n}\n</code></pre> <p>Output :</p> <pre><code>\"max_score\" : 1.0,\n    \"hits\" : [\n      {\n        \"_index\" : \"products\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"4\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"price\" : 30,\n          \"avaliable\" : false,\n          \"productID\" : \"QQPX-R-3956-#aD8\"\n        }\n      }\n    ]\n</code></pre> <pre><code>POST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"term\": {\n          \"avaliable\": true\n        }\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"chap4/2ES_search_str_score/#1-4-range","title":"1-4 \u6570\u5b57Range","text":"<ul> <li>gt\u5927\u4e8e </li> <li>It\u5c0f\u4e8e </li> <li>gte\u5927\u4e8e\u7b49\u4e8e </li> <li>lte \u5c0f\u4e8e\u7b49\u4e8e </li> </ul> <p>\u6570\u5b57\u7c7b\u578b Term:</p> <pre><code># \u6570\u5b57\u7c7b\u578b Term\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"term\": {\n      \"price\": 30\n    }\n  }\n}\n</code></pre> <p>Output</p> <pre><code>\"hits\" : [\n      {\n        \"_index\" : \"products\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"3\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"price\" : 30,\n          \"avaliable\" : true,\n          \"productID\" : \"JODL-X-1937-#pV7\"\n        }\n      },\n      {\n        \"_index\" : \"products\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"4\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"price\" : 30,\n          \"avaliable\" : false,\n          \"productID\" : \"QQPX-R-3956-#aD8\"\n        }\n      }\n    ]\n</code></pre>"},{"location":"chap4/2ES_search_str_score/#1-5-range","title":"1-5 \u65e5\u671f range","text":"<ul> <li>Date Math Expressions <ul> <li><code>2014-01-01 00:00:00||+1M</code></li> </ul> </li> </ul> <pre><code>POST products/_search\n{\n    \"query\" : {\n        \"constant_score\" : {\n            \"filter\" : {\n                \"range\" : {\n                    \"date\" : {\n                      \"gte\" : \"now-2y\"\n                    }\n                }\n            }\n        }\n    }\n}\n</code></pre> <p>Output :</p> <pre><code>\"max_score\" : 1.0,\n    \"hits\" : [\n      {\n        \"_index\" : \"products\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"2\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"price\" : 20,\n          \"avaliable\" : true,\n          \"date\" : \"2019-01-01\",\n          \"productID\" : \"KDKE-B-9947-#kL5\"\n        }\n      }\n    ]\n</code></pre>"},{"location":"chap4/2ES_search_str_score/#1-6","title":"1-6 \u5904\u7406\u7a7a\u503c","text":"<p>exists\u67e5\u8be2</p> <pre><code>#exists\u67e5\u8be2\nPOST products/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"exists\": {\n          \"field\": \"date\"\n        }\n      }\n    }\n  }\n}\n</code></pre> <p>output :</p> <pre><code>hits\" : [\n      {\n        \"_index\" : \"products\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"1\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"price\" : 10,\n          \"avaliable\" : true,\n          \"date\" : \"2018-01-01\",\n          \"productID\" : \"XHDK-A-1293-#fJ3\"\n        }\n      },\n      {\n        \"_index\" : \"products\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"2\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"price\" : 20,\n          \"avaliable\" : true,\n          \"date\" : \"2019-01-01\",\n          \"productID\" : \"KDKE-B-9947-#kL5\"\n        }\n      }\n    ]\n</code></pre> <ul> <li>\"bool\": { \"must_not\" }</li> </ul> <pre><code>POST products/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"bool\": {\n          \"must_not\": {\n            \"exists\": {\n              \"field\": \"date\"\n            }\n          }\n        }\n      }\n    }\n  }\n}\n</code></pre> <p>Output:</p> <pre><code> \"hits\" : [\n      {\n        \"_index\" : \"products\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"3\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"price\" : 30,\n          \"avaliable\" : true,\n          \"productID\" : \"JODL-X-1937-#pV7\"\n        }\n      },\n      {\n        \"_index\" : \"products\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"4\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"price\" : 30,\n          \"avaliable\" : false,\n          \"productID\" : \"QQPX-R-3956-#aD8\"\n        }\n      }\n    ]\n</code></pre>"},{"location":"chap4/2ES_search_str_score/#1-7","title":"1-7 \u5904\u7406\u591a\u503c\u5b57\u6bb5","text":"<pre><code>POST /movies/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"title\" : \"Father of the Bridge Part II\",\"year\":1995, \"genre\":\"Comedy\"}\n{ \"index\": { \"_id\": 2 }}\n{ \"title\" : \"Dave\",\"year\":1993,\"genre\":[\"Comedy\",\"Romance\"] }\n</code></pre> <p>\u5904\u7406\u591a\u503c\u5b57\u6bb5\uff0cterm \u67e5\u8be2\u662f\u5305\u542b\uff0c\u800c\u4e0d\u662f\u7b49\u4e8e</p> <pre><code>POST movies/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"term\": {\n          \"genre.keyword\": \"Comedy\"\n        }\n      }\n    }\n  }\n}\n</code></pre> <ul> <li>\u89e3\u51b3\u65b9\u6848\uff1a\u589e\u52a0\u4e00\u4e2a<code>genre_count</code>\u5b57\u6bb5\u8fdb\u884c\u8ba1\u6570\u3002\u4f1a\u5728\u7ec4\u5408<code>bool query</code>\u7ed9\u51fa\u89e3\u51b3\u65b9\u6cd5 </li> </ul> <p></p>"},{"location":"chap4/2ES_search_str_score/#1-8","title":"1-8 \u67e5\u627e\u591a\u4e2a\u7cbe\u786e\u503c","text":"<pre><code>#\u6570\u5b57\u7c7b\u578b terms\nPOST products/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"terms\": {\n          \"price\": [\n            \"20\",\n            \"30\"\n          ]\n        }\n      }\n    }\n  }\n}\n</code></pre> <p>Output :</p> <pre><code>\"max_score\" : 1.0,\n    \"hits\" : [\n      {\n        \"_index\" : \"products\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"2\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"price\" : 20,\n          \"avaliable\" : true,\n          \"date\" : \"2019-01-01\",\n          \"productID\" : \"KDKE-B-9947-#kL5\"\n        }\n      },\n      {\n        \"_index\" : \"products\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"3\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"price\" : 30,\n          \"avaliable\" : true,\n          \"productID\" : \"JODL-X-1937-#pV7\"\n        }\n      },\n      {\n        \"_index\" : \"products\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"4\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"price\" : 30,\n          \"avaliable\" : false,\n          \"productID\" : \"QQPX-R-3956-#aD8\"\n        }\n      }\n    ]\n</code></pre> <ul> <li>\u5b57\u7b26\u7c7b\u578b terms</li> </ul> <pre><code>#\u5b57\u7b26\u7c7b\u578b terms\nPOST products/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"terms\": {\n          \"productID.keyword\": [\n            \"QQPX-R-3956-#aD8\",\n            \"JODL-X-1937-#pV7\"\n          ]\n        }\n      }\n    }\n  }\n}\n</code></pre> <p>Output :</p> <pre><code>\"hits\" : [\n      {\n        \"_index\" : \"products\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"3\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"price\" : 30,\n          \"avaliable\" : true,\n          \"productID\" : \"JODL-X-1937-#pV7\"\n        }\n      },\n      {\n        \"_index\" : \"products\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"4\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"price\" : 30,\n          \"avaliable\" : false,\n          \"productID\" : \"QQPX-R-3956-#aD8\"\n        }\n      }\n    ]\n</code></pre>"},{"location":"chap4/2ES_search_str_score/#1-9-term-vs-match","title":"1-9 Term VS Match","text":"<pre><code>POST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"term\": {\n      \"date\": \"2019-01-01\"\n    }\n  }\n}\n\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"match\": {\n      \"date\": \"2019-01-01\"\n    }\n  }\n}\n</code></pre> <pre><code>POST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"term\": {\n          \"productID.keyword\": \"XHDK-A-1293-#fJ3\"\n        }\n      }\n    }\n  }\n}\n\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"term\": {\n      \"productID.keyword\": \"XHDK-A-1293-#fJ3\"\n    }\n  }\n}\n</code></pre> <ul> <li><code>\"_score\" : 1.0,</code></li> <li><code>\"_score\" : 1.2039728,</code></li> </ul> <p>\u5bf9\u5e03\u5c14\u6570\u503c</p> <pre><code>POST products/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"term\": {\n          \"avaliable\": \"false\"\n        }\n      }\n    }\n  }\n}\n\nPOST products/_search\n{\n  \"query\": {\n    \"term\": {\n      \"avaliable\": {\n        \"value\": \"false\"\n      }\n    }\n  }\n}\n</code></pre> <ul> <li><code>\"_score\" : 1.0,</code></li> <li><code>\"_score\" : 1.2039728,</code></li> </ul> <pre><code>POST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"term\": {\n      \"price\": {\n        \"value\": \"20\"\n      }\n    }\n  }\n}\n\nPOST products/_search\n{\n  \"profile\": \"true\",\n  \"explain\": true,\n  \"query\": {\n    \"match\": {\n      \"price\": \"20\"\n    }\n   }\n }\n</code></pre>"},{"location":"chap4/2ES_search_str_score/#1-10","title":"1-10 \u672c\u8282\u77e5\u8bc6\u70b9\u56de\u987e","text":"<ul> <li>\u7ed3\u6784\u5316\u6570\u636e\uff06\u7ed3\u6784\u5316\u641c\u7d22 <ul> <li>\u5982\u679c\u4e0d\u9700\u8981\u7b97\u5206\uff0c\u53ef\u4ee5\u901a\u8fc7Constant Score\uff0c\u5c06\u67e5\u8be2\u8f6c\u4e3aFiltering </li> </ul> </li> <li>\u8303\u56f4\u67e5\u8be2\u548cDate Math </li> <li>\u4f7f\u7528Exist\u67e5\u8be2\u5904\u7406\u975e\u7a7aNull\u503c</li> <li>\u7cbe\u786e\u503c\uff06\u591a\u503c\u5b57\u6bb5\u7684\u7cbe\u786e\u503c\u67e5\u627e <ul> <li>Term\u67e5\u8be2\u662f\u5305\u542b\uff0c\u4e0d\u662f\u5b8c\u5168\u76f8\u7b49\u3002\u9488\u5bf9\u591a\u503c\u5b57\u6bb5\u67e5\u8be2\u8981\u5c24\u5176\u6ce8\u610f </li> </ul> </li> </ul>"},{"location":"chap4/2ES_search_str_score/#2","title":"2\u3001\u641c\u7d22\u7684\u76f8\u5173\u6027\u7b97\u5206","text":""},{"location":"chap4/2ES_search_str_score/#2-1","title":"2-1 \u76f8\u5173\u6027\u548c\u76f8\u5173\u6027\u7b97\u5206","text":"<ul> <li>\u76f8\u5173\u6027\u4e00Relevance <ul> <li>\u641c\u7d22\u7684\u76f8\u5173\u6027\u7b97\u5206\uff0c\u63cf\u8ff0\u4e86\u4e00\u4e2a\u6587\u6863\u548c\u67e5\u8be2\u8bed\u53e5\u5339\u914d\u7684\u7a0b\u5ea6\u3002ES\u4f1a\u5bf9\u6bcf\u4e2a\u5339\u914d\u67e5\u8be2\u6761\u4ef6\u7684\u7ed3  \u679c\u8fdb\u884c\u7b97\u5206<code>_score</code> </li> </ul> </li> <li>\u6253\u5206\u7684\u672c\u8d28\u662f\u6392\u5e8f\uff0c\u9700\u8981\u628a\u6700\u7b26\u5408\u7528\u6237\u9700\u6c42\u7684\u6587\u6863\u6392\u5728\u524d\u9762\u3002ES5\u4e4b\u524d\uff0c\u9ed8\u8ba4\u7684\u76f8\u5173\u6027\u7b97\u5206\u91c7\u7528<code>TF-IDF</code>\uff0c\u73b0\u5728\u91c7\u7528BM25 </li> </ul>"},{"location":"chap4/2ES_search_str_score/#2-2-tf","title":"2-2 \u8bcd\u9891TF","text":"<ul> <li><code>Term Frequency</code>:\u68c0\u7d22\u8bcd\u5728\u4e00\u7bc7\u6587\u6863\u4e2d\u51fa\u73b0\u7684\u9891\u7387 <ul> <li>\u68c0\u7d22\u8bcd\u51fa\u73b0\u7684\u6b21\u6570\u9664\u4ee5\u6587\u6863\u7684\u603b\u5b57\u6570 </li> </ul> </li> <li>\u5ea6\u91cf\u4e00\u6761\u67e5\u8be2\u548c\u7ed3\u679c\u6587\u6863\u76f8\u5173\u6027\u7684\u7b80\u5355\u65b9\u6cd5\uff1a\u7b80\u5355\u5c06\u641c\u7d22\u4e2d\u6bcf\u4e00\u4e2a\u8bcd\u7684TF\u8fdb\u884c\u76f8\u52a0 <ul> <li>TF(\u533a\u5757\u94fe\uff09\uff0bTF(\u7684\uff09\uff0bTF(\u5e94\u7528\uff09 </li> </ul> </li> <li>Stop Word <ul> <li>\u201c\u7684\u201d\u5728\u6587\u6863\u4e2d\u51fa\u73b0\u4e86\u5f88\u591a\u6b21\uff0c\u4f46\u662f\u5bf9\u8d21\u732e\u76f8\u5173\u5ea6\u51e0\u4e4e\u6ca1\u6709\u7528\u5904\uff0c\u4e0d\u5e94\u8be5\u8003\u8651\u4ed6\u4eec\u7684TF </li> </ul> </li> </ul>"},{"location":"chap4/2ES_search_str_score/#2-3-idf","title":"2-3 \u9006\u6587\u6863\u9891\u7387IDF","text":"<ul> <li> <p>DF: \u68c0\u7d22\u8bcd\u5728\u6240\u6709\u6587\u6863\u4e2d\u51fa\u73b0\u7684\u9891\u7387 </p> <ul> <li>\u201c\u533a\u5757\u94fe\u201d\u5728\u76f8\u5bf9\u6bd4\u8f83\u5c11\u7684\u6587\u6863\u4e2d\u51fa\u73b0 </li> <li>\u201c\u5e94\u7528\u201d\u5728\u76f8\u5bf9\u6bd4\u8f83\u591a\u7684\u6587\u6863\u4e2d\u51fa\u73b0 </li> <li>\"Stop Word\u201d\u5728\u5927\u91cf\u7684\u6587\u6863\u4e2d\u51fa\u73b0 </li> </ul> </li> <li> <p><code>Inverse Document Frequency</code>\uff1a\u7b80\u5355\u8bf4\uff1dlog\uff08\u5168\u90e8\u6587\u6863\u6570\uff0f\u68c0\u7d22\u8bcd\u51fa\u73b0\u8fc7\u7684\u6587\u6863\u603b\u6570\uff09 </p> </li> <li><code>TF-IDF</code>\u672c\u8d28\u4e0a\u5c31\u662f\u5c06\u4e0bF\u6c42\u548c\u53d8\u6210\u4e86\u52a0\u6743\u6c42\u548c <ul> <li><code>TF\uff08\u533a\u5757\u94fe)*IDF(\u533a\u5757\u94fe\uff09+ TF\uff08\u7684\uff09*IDF(\u7684\uff09+ TF(\u5e94\u7528\uff09* IDF(\u5e94\u7528\uff09</code> </li> </ul> </li> </ul> <p></p>"},{"location":"chap4/2ES_search_str_score/#2-4-tf-idf","title":"2-4 TF-IDF \u7684\u6982\u5ff5","text":"<ul> <li><code>TF-IDF</code>\u88ab\u516c\u8ba4\u4e3a\u662f\u4fe1\u606f\u68c0\u7d22\u9886\u57df\u6700\u91cd\u8981\u7684\u53d1\u660e </li> <li>\u9664\u4e86\u5728\u4fe1\u606f\u68c0\u7d22\uff0c\u5728\u6587\u732e\u5206\u7c7b\u548c\u5176\u4ed6\u76f8\u5173\u9886\u57df\u6709\u7740\u975e\u5e38\u5e7f\u6cdb\u7684\u5e94\u7528 </li> <li>IDF\u7684\u6982\u5ff5\uff0c\u6700\u65e9\u662f\u5251\u6865\u5927\u5b66\u7684\"\u65af\u5df4\u514b.\u743c\u65af\u201d\u63d0\u51fa <ul> <li>1972\u5e74\u4e00\u201c\u5173\u952e\u8bcd\u7279\u6b8a\u6027\u7684\u7edf\u8ba1\u89e3\u91ca\u548c\u5b83\u5728\u6587\u732e\u68c0\u7d22\u4e2d\u7684\u5e94\u7528\u201d </li> <li>\u4f46\u662f\u6ca1\u6709\u4ece\u7406\u8bba\u4e0a\u89e3\u91caIDF\u5e94\u8be5\u662f\u7528log\uff08\u5168\u90e8\u6587\u6863\u6570\uff0f\u68c0\u7d22\u8bcd\u51fa\u73b0\u8fc7\u7684\u6587\u6863\u603b\u6570\uff09\uff0c\u800c\u4e0d\u662f\u5176\u4ed6\u51fd\u6570\u3002\u4e5f\u6ca1\u6709\u505a\u8fdb\u4e00\u6b65\u7684\u7814\u7a76 </li> </ul> </li> <li>1970, 1980\u5e74\u4ee3\u8428\u5c14\u987f\u548c\u7f57\u5bbe\u900a\uff0c\u8fdb\u884c\u4e86\u8fdb\u4e00\u6b65\u7684\u8bc1\u660e\u548c\u7814\u7a76\uff0c\u5e76\u7528\u9999\u519c\u4fe1\u606f\u8bba\u505a\u4e86\u8bc1\u660e </li> <li>\u73b0\u4ee3\u641c\u7d22\u5f15\u64ce\uff0c\u5bf9\u4e0b<code>TF-IDF</code>\u8fdb\u884c\u4e86\u5927\u91cf\u7ec6\u5fae\u7684\u4f18\u5316 </li> </ul>"},{"location":"chap4/2ES_search_str_score/#2-5-lucenetf-idf","title":"2-5 Lucene\u4e2d\u7684TF-IDF\u8bc4\u5206\u516c\u5f0f","text":""},{"location":"chap4/2ES_search_str_score/#2-6-bm-25","title":"2-6 BM 25","text":"<ul> <li>\u4eceES 5\u5f00\u59cb\uff0c\u9ed8\u8ba4\u7b97\u6cd5\u6539\u4e3aBM25 </li> <li>\u548c\u7ecf\u5178\u7684<code>TF-IDF</code>\u76f8\u6bd4\uff0c\u5f53<code>TF</code>\u65e0\u9650\u589e\u52a0\u65f6, <code>BM25</code>\u7b97\u5206\u4f1a\u8d8b\u4e8e\u4e00\u4e2a\u6570\u503c </li> </ul>"},{"location":"chap4/2ES_search_str_score/#2-7-similarity","title":"2-7 \u5b9a\u5236Similarity","text":"<ul> <li>K\u9ed8\u8ba4\u503c\u662f1.2\uff0c\u6570\u503c\u8d8a\u5c0f\uff0c\u9971\u548c\u5ea6\u8d8a\u9ad8\uff0cb\u9ed8\u8ba4\u503c\u662f0.75\uff08\u53d6\u503c\u8303\u56f40-1),0\u4ee3\u8868\u7981\u6b62<code>Normalization</code> </li> </ul> <pre><code>PUT testscore\n{\n  \"settings\": {\n    \"number_of_shards\": 1\n  },\n  \"mappings\": {\n    \"properties\": {\n      \"content\": {\n        \"type\": \"text\"\n      }\n    }\n  }\n}\n</code></pre> <p>Output :</p> <pre><code>{\n  \"acknowledged\" : true,\n  \"shards_acknowledged\" : true,\n  \"index\" : \"testscore\"\n}\n</code></pre> <p></p>"},{"location":"chap4/2ES_search_str_score/#2-8-explain-apitf-idf","title":"2-8 \u901a\u8fc7Explain API\u67e5\u770bTF-IDF","text":"<ul> <li>4\u7bc7\u6587\u6863\uff0b4\u4e2aTerm\u67e5\u8be2 </li> <li>\u601d\u8003\u4e00\u4e0b <ul> <li>\u67e5\u8be2\u4e2d\u7684TF\u548cIDF\uff1f </li> <li>\u7ed3\u679c\u5982\u4f55\u6392\u5e8f\uff1f </li> <li>\u6587\u6863\u957f\u77ed\uff0fTF / IDF \u5bf9\u76f8\u5173\u5ea6\u7b97\u5206\u7684\u5f71\u54cd </li> </ul> </li> </ul> <pre><code>PUT testscore/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"content\":\"we use Elasticsearch to power the search\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"content\":\"we like elasticsearch\" }\n{ \"index\": { \"_id\": 3 }}\n{ \"content\":\"The scoring of documents is caculated by the scoring formula\" }\n{ \"index\": { \"_id\": 4 }}\n{ \"content\":\"you know, for search\" }\n</code></pre> <p>Output :</p> <pre><code>...\n      \"index\" : {\n        \"_index\" : \"testscore\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"1\",\n        \"_version\" : 1,\n        \"result\" : \"created\",\n        \"_shards\" : {\n          \"total\" : 2,\n          \"successful\" : 2,\n          \"failed\" : 0\n        },\n        \"_seq_no\" : 0,\n        \"_primary_term\" : 1,\n        \"status\" : 201\n      }\n    },\n</code></pre> <pre><code>POST /testscore/_search\n{\n  //\"explain\": true,\n  \"query\": {\n    \"match\": {\n      \"content\":\"you\"\n      //\"content\": \"elasticsearch\"\n      //\"content\":\"the\"\n      //\"content\": \"the elasticsearch\"\n    }\n  }\n}\n</code></pre> <p>Output :</p> <pre><code>\"max_score\" : 1.3940738,\n    \"hits\" : [\n      {\n        \"_index\" : \"testscore\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"4\",\n        \"_score\" : 1.3940738,\n        \"_source\" : {\n          \"content\" : \"you know, for search\"\n        }\n      }\n    ]\n</code></pre> <ul> <li><code>\"_score\" : 1.3940738,</code></li> </ul> <pre><code>POST /testscore/_search\n{\n  //\"explain\": true,\n  \"query\": {\n    \"match\": {\n      // \"content\":\"you\"\n      \"content\": \"elasticsearch\"\n      //\"content\":\"the\"\n      //\"content\": \"the elasticsearch\"\n    }\n  }\n}\n</code></pre> <p>Output :</p> <p></p>"},{"location":"chap4/2ES_search_str_score/#2-9-boosting-relvance","title":"2-9 Boosting Relvance","text":"<ul> <li>Boosting\u662f\u63a7\u5236\u76f8\u5173\u5ea6\u7684\u4e00\u79cd\u624b\u6bb5 <ul> <li>\u7d22\u5f15\uff0c\u5b57\u6bb5\u6216\u67e5\u8be2\u5b50\u6761\u4ef6 </li> </ul> </li> <li>\u53c2\u6570boost\u7684\u542b\u4e49 <ul> <li>\u5f53<code>boost&gt;1</code>\u65f6\uff0c\u6253\u5206\u7684\u76f8\u5173\u5ea6\u76f8\u5bf9\u6027\u63d0\u5347 </li> <li>\u5f53<code>0&lt;boost&lt;1</code>\u65f6\uff0c\u6253\u5206\u7684\u6743\u91cd\u76f8\u5bf9\u6027\u964d\u4f4e </li> <li>\u5f53<code>boost&lt;0</code>\u65f6\uff0c\u8d21\u732e\u8d1f\u5206 </li> </ul> </li> </ul> <pre><code>POST testscore/_search\n{\n    \"query\": {\n        \"boosting\" : {\n            \"positive\" : {\n                \"term\" : {\n                    \"content\" : \"elasticsearch\"\n                }\n            },\n            \"negative\" : {\n                 \"term\" : {\n                     \"content\" : \"like\"\n                }\n            },\n            \"negative_boost\" : 0.2\n        }\n    }\n}\n</code></pre> <pre><code>POST tmdb/_search\n{\n  \"_source\": [\"title\",\"overview\"],\n  \"query\": {\n    \"more_like_this\": {\n      \"fields\": [\n        \"title^10\",\"overview\"\n      ],\n      \"like\": [{\"_id\":\"14191\"}],\n      \"min_term_freq\": 1,\n      \"max_query_terms\": 12\n    }\n  }\n}\n</code></pre>"},{"location":"chap4/2ES_search_str_score/#2-10","title":"2-10 \u672c\u8282\u77e5\u8bc6\u70b9\u56de\u987e","text":"<ul> <li>\u4ec0\u4e48\u662f\u76f8\u5173\u6027\uff06\u76f8\u5173\u6027\u7b97\u5206\u4ecb\u7ecd <ul> <li>TF-IDF\uff0fBM25 </li> </ul> </li> <li>\u5728Elasticsearch\u4e2d\u5b9a\u5236\u76f8\u5173\u5ea6\u7b97\u6cd5\u7684\u53c2\u6570 </li> <li>ES\u4e2d\u53ef\u4ee5\u5bf9\u7d22\u5f15\uff0c\u5b57\u6bb5\u5206\u522b\u8bbe\u7f6eBoosting\u53c2\u6570 </li> </ul>"},{"location":"chap4/3ES_query_filter/","title":"\u7b2c\u4e09\u8282 Query &amp; Filtering\u4e0e\u591a\u5b57\u7b26\u4e32\u591a\u5b57\u6bb5\u67e5\u8be2","text":""},{"location":"chap4/3ES_query_filter/#1query-context-filter-context","title":"1\u3001Query Context &amp; Filter Context","text":"<ul> <li>\u9ad8\u7ea7\u641c\u7d22\u7684\u529f\u80fd\uff1a\u652f\u6301\u591a\u9879\u6587\u672c\u8f93\u5165\uff0c\u9488\u5bf9\u591a\u4e2a\u5b57\u6bb5\u8fdb\u884c\u641c\u7d22\u3002 </li> <li>\u641c\u7d22\u5f15\u64ce\u4e00\u822c\u4e5f\u63d0\u4f9b\u57fa\u4e8e\u65f6\u95f4\uff0c\u4ef7\u683c\u7b49\u6761\u4ef6\u7684\u8fc7\u6ee4 </li> <li>Elasticsearch\u4e2d\uff0c\u6709Query\u548cFilter\u4e24\u79cd\u4e0d\u540c Context <ul> <li>Query Context\uff1a\u76f8\u5173\u6027\u7b97\u5206 </li> <li>Filter Context: \u4e0d\u9700\u8981\u7b97\u5206\uff08Yes or No) \uff0c\u53ef\u4ee5\u5229\u7528Cache\uff0c\u83b7\u5f97\u66f4\u597d\u7684\u6027\u80fd </li> </ul> </li> </ul>"},{"location":"chap4/3ES_query_filter/#2","title":"2\u3001\u6761\u4ef6\u7ec4\u5408","text":"<ul> <li>\u5047\u8bbe\u8981\u641c\u7d22\u4e00\u672c\u7535\u5f71\uff0c\u5305\u542b\u4e86\u4ee5\u4e0b\u4e00\u4e9b\u6761\u4ef6 <ul> <li>\u8bc4\u8bba\u4e2d\u5305\u542b\u4e86Guitar\uff0c\u7528\u6237\u6253\u5206\u9ad8\u4e8e3\u5206\uff0c\u540c\u65f6\u4e0a\u6620\u65e5\u671f\u8981\u57281993\u4e0e2000\u5e74\u4e4b\u95f4 </li> </ul> </li> <li>\u8fd9\u4e2a\u641c\u7d22\u5176\u5b9e\u5305\u542b\u4e863\u6bb5\u903b\u8f91\uff0c\u9488\u5bf9\u4e0d\u540c\u7684\u5b57\u6bb5 <ul> <li>\u8bc4\u8bba\u5b57\u6bb5\u4e2d\u8981\u5305\u542b<code>Guitar</code>\uff0f\u7528\u6237\u8bc4\u5206\u5927\u4e8e3\uff0f\u4e0a\u6620\u65e5\u671f\u65e5\u671f\u9700\u8981\u5728\u7ed9\u5b9a\u7684\u8303\u56f4 </li> </ul> </li> <li>\u540c\u65f6\u5305\u542b\u8fd9\u4e09\u4e2a\u903b\u8f91\uff0c\u5e76\u4e14\u6709\u6bd4\u8f83\u597d\u7684\u6027\u80fd\uff1f <ul> <li>\u590d\u5408\u67e5\u8be2\uff1a<code>bool Query</code> </li> </ul> </li> </ul>"},{"location":"chap4/3ES_query_filter/#3bool","title":"3\u3001bool\u67e5\u8be2","text":"<ul> <li>\u4e00\u4e2abool\u67e5\u8be2\uff0c\u662f\u4e00\u4e2a\u6216\u8005\u591a\u4e2a\u67e5\u8be2\u5b50\u53e5\u7684\u7ec4\u5408 <ul> <li>\u603b\u5171\u5305\u62ec4\u79cd\u5b50\u53e5\u3002\u5176\u4e2d2\u79cd\u4f1a\u5f71\u54cd\u7b97\u5206\uff0c2\u79cd\u4e0d\u5f71\u54cd\u7b97\u5206 </li> <li>\u76f8\u5173\u6027\u5e76\u4e0d\u53ea\u662f\u5168\u6587\u672c\u68c0\u7d22\u7684\u4e13\u5229\u3002\u4e5f\u9002\u7528\u4e8e<code>yes | no</code>\u7684\u5b50\u53e5\uff0c\u5339\u914d\u7684\u5b50\u53e5\u8d8a\u591a\uff0c\u76f8\u5173\u6027\u8bc4\u5206\u8d8a\u9ad8\u3002</li> <li>\u5982\u679c\u591a\u6761\u67e5\u8be2\u5b50\u53e5\u88ab\u5408\u5e76\u4e3a\u4e00\u6761\u590d\u5408\u67e5\u8be2\u8bed\u53e5\uff0c\u6bd4\u5982<code>bool</code>\u67e5\u8be2\uff0c\u5219\u6bcf\u4e2a\u67e5\u8be2\u5b50\u53e5\u8ba1\u7b97\u5f97\u51fa\u7684\u8bc4\u5206\u4f1a\u88ab\u5408\u5e76\u5230\u603b\u7684\u76f8\u5173\u6027\u8bc4\u5206\u4e2d\u3002 </li> </ul> </li> </ul> <pre><code>POST /products/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"price\" : 10,\"avaliable\":true,\"date\":\"2018-01-01\", \"productID\" : \"XHDK-A-1293-#fJ3\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"price\" : 20,\"avaliable\":true,\"date\":\"2019-01-01\", \"productID\" : \"KDKE-B-9947-#kL5\" }\n{ \"index\": { \"_id\": 3 }}\n{ \"price\" : 30,\"avaliable\":true, \"productID\" : \"JODL-X-1937-#pV7\" }\n{ \"index\": { \"_id\": 4 }}\n{ \"price\" : 30,\"avaliable\":false, \"productID\" : \"QQPX-R-3956-#aD8\" }\n</code></pre> <pre><code>GET products/_mapping\n\n{\n  \"products\" : {\n    \"mappings\" : {\n      \"properties\" : {\n        \"avaliable\" : {\n          \"type\" : \"boolean\"\n        },\n        \"date\" : {\n          \"type\" : \"date\"\n        },\n        \"price\" : {\n          \"type\" : \"long\"\n        },\n        \"productID\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n            }\n          }\n        }\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"chap4/3ES_query_filter/#3-1-bool","title":"3-1 bool\u67e5\u8be2\u8bed\u53e5","text":"<ul> <li>\u5b50\u67e5\u8be2\u53ef\u4ee5\u4efb\u610f\u987a\u5e8f\u51fa\u73b0 </li> <li>\u53ef\u4ee5\u5d4c\u5957\u591a\u4e2a\u67e5\u8be2 </li> <li>\u5982\u679c\u4f60\u7684<code>bool</code>\u67e5\u8be2\u4e2d\uff0c\u6ca1\u6709<code>must</code>\u6761\u4ef6,<code>should</code>\u4e2d\u5fc5\u987b\u81f3\u5c11\u6ee1\u8db3\u4e00\u6761\u67e5\u8be2 </li> </ul> <pre><code>#\u57fa\u672c\u8bed\u6cd5\nPOST /products/_search\n{\n  \"query\": {\n    \"bool\" : {\n      \"must\" : {\n        \"term\" : { \"price\" : \"30\" }\n      },\n      \"filter\": {\n        \"term\" : { \"avaliable\" : \"true\" }\n      },\n      \"must_not\" : {\n        \"range\" : {\n          \"price\" : { \"lte\" : 10 }\n        }\n      },\n      \"should\" : [\n        { \"term\" : { \"productID.keyword\" : \"JODL-X-1937-#pV7\" } },\n        { \"term\" : { \"productID.keyword\" : \"XHDK-A-1293-#fJ3\" } }\n      ],\n      \"minimum_should_match\" :1\n    }\n  }\n}\n</code></pre> <p>Output :</p> <pre><code>\"max_score\" : 2.2039728,\n    \"hits\" : [\n      {\n        \"_index\" : \"products\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"3\",\n        \"_score\" : 2.2039728,\n        \"_source\" : {\n          \"price\" : 30,\n          \"avaliable\" : true,\n          \"productID\" : \"JODL-X-1937-#pV7\"\n        }\n      }\n    ]\n</code></pre> <ul> <li><code>\"_score\" : 2.2039728,</code> : Must , should \u7b97\u5206</li> </ul>"},{"location":"chap4/3ES_query_filter/#3-2","title":"3-2 \u5982\u4f55\u89e3\u51b3\u7ed3\u6784\u5316\u67e5\u8be2\u4e00\u201c\u5305\u542b\u800c\u4e0d\u662f\u76f8\u7b49\u201d\u7684\u95ee\u9898","text":"<pre><code>POST /movies/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"term\": {\n            \"genre.keyword\": \"Comedy\"\n        }\n      }\n    }\n  }\n}\n</code></pre> <p>Output :</p> <p></p> <ul> <li>\u6539\u53d8\u6570\u636e\u6a21\u578b\uff0c\u589e\u52a0\u5b57\u6bb5\u3002\u89e3\u51b3\u6570\u7ec4\u5305\u542b\u800c\u4e0d\u662f\u7cbe\u786e\u5339\u914d\u7684\u95ee\u9898</li> </ul> <p>\u89e3\u51b3\u65b9\u6848\uff1a\u589e\u52a0\u4e00\u4e2a<code>genre count</code>\u5b57\u6bb5\u8fdb\u884c\u8ba1\u6570 </p>"},{"location":"chap4/3ES_query_filter/#3-3-countbool","title":"3-3 \u589e\u52a0count\u5b57\u6bb5\uff0c\u4f7f\u7528bool\u67e5\u8be2\u89e3\u51b3","text":"<p>\u4ece\u4e1a\u52a1\u89d2\u5ea6\uff0c\u6309\u9700\u6539\u8fdbElasticsearch\u6570\u636e\u6a21\u578b </p> <pre><code># \u6539\u53d8\u6570\u636e\u6a21\u578b\uff0c\u589e\u52a0\u5b57\u6bb5\u3002\u89e3\u51b3\u6570\u7ec4\u5305\u542b\u800c\u4e0d\u662f\u7cbe\u786e\u5339\u914d\u7684\u95ee\u9898\nPOST /newmovies/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"title\" : \"Father of the Bridge Part II\",\"year\":1995, \"genre\":\"Comedy\",\"genre_count\":1 }\n{ \"index\": { \"_id\": 2 }}\n{ \"title\" : \"Dave\",\"year\":1993,\"genre\":[\"Comedy\",\"Romance\"],\"genre_count\":2 }\n</code></pre> <pre><code>POST /newmovies/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\"term\": {\"genre.keyword\": {\"value\": \"Comedy\"}}},\n        {\"term\": {\"genre_count\": {\"value\": 1}}}\n\n      ]\n    }\n  }\n }\n</code></pre> <p><code>{\"term\": {\"genre_count\": {\"value\": 1}}}</code></p> <pre><code>\"max_score\" : 1.2111092,\n    \"hits\" : [\n      {\n        \"_index\" : \"newmovies\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"1\",\n        \"_score\" : 1.2111092,\n        \"_source\" : {\n          \"title\" : \"Father of the Bridge Part II\",\n          \"year\" : 1995,\n          \"genre\" : \"Comedy\",\n          \"genre_count\" : 1\n        }\n      }\n    ]\n</code></pre> <p>must\uff0c\u6709\u7b97\u5206: <code>\"_score\" : 1.2111092,</code></p> <pre><code>#Filter\u3002\u4e0d\u53c2\u4e0e\u7b97\u5206\uff0c\u7ed3\u679c\u7684score\u662f0\nPOST /newmovies/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"filter\": [\n        {\"term\": {\"genre.keyword\": {\"value\": \"Comedy\"}}},\n        {\"term\": {\"genre_count\": {\"value\": 1}}}\n        ]\n\n    }\n  }\n}\n</code></pre> <p></p>"},{"location":"chap4/3ES_query_filter/#3-4-filter-context","title":"3-4 Filter Context\u4e00\u4e0d\u5f71\u54cd\u7b97\u5206","text":"<pre><code>#Filtering Context\nPOST _search\n{\n  \"query\": {\n    \"bool\" : {\n\n      \"filter\": {\n        \"term\" : { \"avaliable\" : \"true\" }\n      },\n      \"must_not\" : {\n        \"range\" : {\n          \"price\" : { \"lte\" : 10 }\n        }\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"chap4/3ES_query_filter/#3-5-query-context","title":"3-5 Query Context\u4e00\u5f71\u54cd\u7b97\u5206","text":"<pre><code>#Query Context\nPOST /products/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"price\" : 10,\"avaliable\":true,\"date\":\"2018-01-01\", \"productID\" : \"XHDK-A-1293-#fJ3\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"price\" : 20,\"avaliable\":true,\"date\":\"2019-01-01\", \"productID\" : \"KDKE-B-9947-#kL5\" }\n{ \"index\": { \"_id\": 3 }}\n{ \"price\" : 30,\"avaliable\":true, \"productID\" : \"JODL-X-1937-#pV7\" }\n{ \"index\": { \"_id\": 4 }}\n{ \"price\" : 30,\"avaliable\":false, \"productID\" : \"QQPX-R-3956-#aD8\" }\n</code></pre> <pre><code>POST /products/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"should\": [\n        {\n          \"term\": {\n            \"productID.keyword\": {\n              \"value\": \"JODL-X-1937-#pV7\"}}\n        },\n        {\"term\": {\"avaliable\": {\"value\": true}}\n        }\n      ]\n    }\n  }\n}\n</code></pre>"},{"location":"chap4/3ES_query_filter/#3-6-bool","title":"3-6 Bool\u5d4c\u5957","text":"<p>\u5b9e\u73b0\u4e86should not\u7684\u903b\u8f91</p> <p></p> <pre><code>POST /products/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": {\n        \"term\": {\n          \"price\": \"30\"\n        }\n      },\n      \"should\": [\n        {\n          \"bool\": {\n            \"must_not\": {\n              \"term\": {\n                \"avaliable\": \"false\"\n              }\n            }\n          }\n        }\n      ],\n      \"minimum_should_match\": 1\n    }\n  }\n}\n</code></pre> <p>Output</p> <pre><code>\"max_score\" : 1.0,\n    \"hits\" : [\n      {\n        \"_index\" : \"products\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"3\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"price\" : 30,\n          \"avaliable\" : true,\n          \"productID\" : \"JODL-X-1937-#pV7\"\n        }\n      }\n    ]\n</code></pre>"},{"location":"chap4/3ES_query_filter/#3-7-controll-the-precision","title":"3-7 Controll the Precision","text":"<pre><code>POST _search\n{\n  \"query\": {\n    \"bool\" : {\n      \"must\" : {\n        \"term\" : { \"price\" : \"30\" }\n      },\n      \"filter\": {\n        \"term\" : { \"avaliable\" : \"true\" }\n      },\n      \"must_not\" : {\n        \"range\" : {\n          \"price\" : { \"lte\" : 10 }\n        }\n      },\n      \"should\" : [\n        { \"term\" : { \"productID.keyword\" : \"JODL-X-1937-#pV7\" } },\n        { \"term\" : { \"productID.keyword\" : \"XHDK-A-1293-#fJ3\" } }\n      ],\n      \"minimum_should_match\" :2\n    }\n  }\n}\n</code></pre>"},{"location":"chap4/3ES_query_filter/#3-8","title":"3-8 \u67e5\u8be2\u8bed\u53e5\u7684\u7ed3\u6784\uff0c\u4f1a\u5bf9\u76f8\u5173\u5ea6\u7b97\u5206\u4ea7\u751f\u5f71\u54cd","text":"<pre><code>POST /animals/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"should\": [\n        { \"term\": { \"text\": \"brown\" }},\n        { \"term\": { \"text\": \"red\" }},\n        { \"term\": { \"text\": \"quick\"   }},\n        { \"term\": { \"text\": \"dog\"   }}\n      ]\n    }\n  }\n}\n</code></pre> <pre><code>POST /animals/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"should\": [\n        { \"term\": { \"text\": \"quick\" }},\n        { \"term\": { \"text\": \"dog\"   }},\n        {\n          \"bool\":{\n            \"should\":[\n               { \"term\": { \"text\": \"brown\" }},\n                 { \"term\": { \"text\": \"brown\" }},\n            ]\n          }\n\n        }\n      ]\n    }\n  }\n}\n</code></pre> <ul> <li>\u540c\u4e00\u5c42\u7ea7\u4e0b\u7684\u7ade\u4e89\u5b57\u6bb5\uff0c\u5177\u6709\u6709\u76f8\u540c\u7684\u6743\u91cd </li> <li>\u901a\u8fc7\u5d4c\u5957bool\u67e5\u8be2\uff0c\u53ef\u4ee5\u6539\u53d8\u5bf9\u7b97\u5206\u7684\u5f71\u54cd </li> </ul>"},{"location":"chap4/3ES_query_filter/#3-9-boosting","title":"3-9 \u63a7\u5236\u5b57\u6bb5\u7684Boosting","text":"<pre><code>DELETE blogs\nPOST /blogs/_bulk\n{ \"index\": { \"_id\": 1 }}\n{\"title\":\"Apple iPad\", \"content\":\"Apple iPad,Apple iPad\" }\n{ \"index\": { \"_id\": 2 }}\n{\"title\":\"Apple iPad,Apple iPad\", \"content\":\"Apple iPad\" }\n</code></pre> <ul> <li><code>Boosting</code>\u662f\u63a7\u5236\u76f8\u5173\u5ea6\u7684\u4e00\u79cd\u624b\u6bb5 <ul> <li>\u7d22\u5f15\uff0c\u5b57\u6bb5\u6216\u67e5\u8be2\u5b50\u6761\u4ef6 </li> </ul> </li> <li>\u53c2\u6570<code>boost</code>\u7684\u542b\u4e49 <ul> <li>\u5f53<code>boost&gt;1</code>\u65f6\uff0c\u6253\u5206\u7684\u76f8\u5173\u5ea6\u76f8\u5bf9\u6027\u63d0\u5347 </li> <li>\u5f53<code>0&lt;boost&lt;1</code>\u65f6\uff0c\u6253\u5206\u7684\u6743\u91cd\u76f8\u5bf9\u6027\u964d\u4f4e </li> <li>\u5f53<code>boost&lt;0</code>\u65f6\uff0c\u8d21\u732e\u8d1f\u5206 </li> </ul> </li> </ul> <pre><code>POST blogs/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"should\": [\n        {\"match\": {\n          \"title\": {\n            \"query\": \"apple,ipad\",\n            \"boost\": 4\n          }\n        }},\n\n        {\"match\": {\n          \"content\": {\n            \"query\": \"apple,ipad\",\n            \"boost\": 1\n          }\n        }}\n      ]\n    }\n  }\n}\n</code></pre>"},{"location":"chap4/3ES_query_filter/#3-10-not-qulte-not","title":"3-10 Not Qulte Not","text":"<p>\u8981\u6c42\u82f9\u679c\u516c\u53f8\u7684\u4ea7\u54c1\u4fe1\u606f\u4f18\u5148 </p> <pre><code>DELETE news\nPOST /news/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"content\":\"Apple Mac\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"content\":\"Apple iPad\" }\n{ \"index\": { \"_id\": 3 }}\n{ \"content\":\"Apple employee like Apple Pie and Apple Juice\" }\n</code></pre> <pre><code>POST news/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": {\n        \"match\":{\"content\":\"apple\"}\n      }\n    }\n  }\n}\n</code></pre> <p></p>"},{"location":"chap4/3ES_query_filter/#3-11-boosting-query","title":"3-11 Boosting Query","text":"<pre><code>POST news/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": {\n        \"match\":{\"content\":\"apple\"}\n      },\n      \"must_not\": {\n        \"match\":{\"content\":\"pie\"}\n      }\n    }\n  }\n</code></pre> <p>Output</p> <pre><code>\"max_score\" : 0.16786805,\n    \"hits\" : [\n      {\n        \"_index\" : \"news\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"1\",\n        \"_score\" : 0.16786805,\n        \"_source\" : {\n          \"content\" : \"Apple Mac\"\n        }\n      },\n      {\n        \"_index\" : \"news\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"2\",\n        \"_score\" : 0.16786805,\n        \"_source\" : {\n          \"content\" : \"Apple iPad\"\n        }\n      }\n    ]\n</code></pre>"},{"location":"chap4/3ES_query_filter/#3-11-negative-boost","title":"3-11 Negative Boost","text":"<pre><code>POST news/_search\n{\n  \"query\": {\n    \"boosting\": {\n      \"positive\": {\n        \"match\": {\n          \"content\": \"apple\"\n        }\n      },\n      \"negative\": {\n        \"match\": {\n          \"content\": \"pie\"\n        }\n      },\n      \"negative_boost\": 0.5\n    }\n  }\n}\n</code></pre>"},{"location":"chap4/3ES_query_filter/#4","title":"4\u3001\u672c\u8282\u77e5\u8bc6\u70b9\u56de\u987e","text":"<ul> <li>Query Context vs.Filter Context </li> <li>Bool Query\u4e00\u66f4\u591a\u7684\u6761\u4ef6\u7ec4\u5408 </li> <li>\u67e5\u8be2\u7ed3\u6784\u4e0e\u76f8\u5173\u6027\u7b97\u5206 </li> <li>\u5982\u4f55\u63a7\u5236\u67e5\u8be2\u7684\u7cbe\u786e\u5ea6 <ul> <li>Boosting&amp;Boosting Query </li> </ul> </li> </ul>"},{"location":"chap4/4ES_sin_mul_search/","title":"\u7b2c\u56db\u8282 \u5355\u5b57\u7b26\u4e32\u591a\u5b57\u6bb5\u67e5\u8be2","text":""},{"location":"chap4/4ES_sin_mul_search/#1-dis-max-query","title":"1\u3001\u5355\u5b57\u7b26\u4e32\u591a\u5b57\u6bb5\u67e5\u8be2  Dis Max Query","text":""},{"location":"chap4/4ES_sin_mul_search/#1-1","title":"1-1 \u5355\u5b57\u7b26\u4e32\u67e5\u8be2","text":"<ul> <li>\u5355\u5b57\u7b26\u4e32\u67e5\u8be2 <ul> <li>Google\u53ea\u63d0\u4f9b\u4e00\u4e2a\u8f93\u5165\u6846\uff0c\u67e5\u8be2\u76f8\u5173\u7684\u591a\u4e2a\u5b57\u6bb5 </li> <li>\u652f\u6301\u6309\u7167\u4ef7\u683c\uff0c\u65f6\u95f4\u7b49\u8fdb\u884c\u8fc7\u6ee4 </li> </ul> </li> </ul>"},{"location":"chap4/4ES_sin_mul_search/#1-2","title":"1-2 \u5355\u5b57\u7b26\u4e32\u67e5\u8be2\u7684\u5b9e\u4f8b","text":"<ul> <li>\u535a\u5ba2\u6807\u9898 <ul> <li>\u6587\u68631\u4e2d\u51fa\u73b0 \"Brown\" </li> </ul> </li> <li>\u535a\u5ba2\u5185\u5bb9 <ul> <li>\u6587\u68631\u4e2d\u51fa\u73b0\u4e86  \"Brown\" </li> <li>\"Brown fox\"\uff0e\u5728\u6587\u68632\u4e2d\u5168\u90e8\u51fa\u73b0\uff0c\u5e76\u4e14\u4fdd\u6301\u548c\u67e5\u8be2\u4e00\u81f4\u7684\u987a\u5e8f \uff08\u76ee\u6d4b\u76f8\u5173\u6027\u6700\u9ad8\uff09</li> </ul> </li> </ul> <pre><code>PUT /blogs/_doc/1\n{\n    \"title\": \"Quick brown rabbits\",\n    \"body\":  \"Brown rabbits are commonly seen.\"\n}\n\nPUT /blogs/_doc/2\n{\n    \"title\": \"Keeping pets healthy\",\n    \"body\":  \"My quick brown fox eats rabbits on a regular basis.\"\n}\n</code></pre>"},{"location":"chap4/4ES_sin_mul_search/#1-3","title":"1-3 \u7b97\u5206\u8fc7\u7a0b","text":"<ul> <li>\u67e5\u8be2<code>should</code>\u8bed\u53e5\u4e2d\u7684\u4e24\u4e2a\u67e5\u8be2</li> <li>\u52a0\u548c\u4e24\u4e2a\u67e5\u8be2\u7684\u8bc4\u5206 </li> <li>\u4e58\u4ee5\u5339\u914d\u8bed\u53e5\u7684\u603b\u6570 </li> <li>\u9664\u4ee5\u6240\u6709\u8bed\u53e5\u7684\u603b\u6570 </li> </ul> <p>\u67e5\u8be2\u7ed3\u679c\u53ca\u5206\u6790</p> <pre><code>POST /blogs/_search\n{\n    \"query\": {\n        \"bool\": {\n            \"should\": [\n                { \"match\": { \"title\": \"Brown fox\" }},\n                { \"match\": { \"body\":  \"Brown fox\" }}\n            ]\n        }\n    }\n}\n</code></pre> <pre><code>\"hits\" : [\n      {\n        \"_index\" : \"blogs\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"1\",\n        \"_score\" : 0.90425634,\n        \"_source\" : {\n          \"title\" : \"Quick brown rabbits\",\n          \"body\" : \"Brown rabbits are commonly seen.\"\n        }\n      },\n      {\n        \"_index\" : \"blogs\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"2\",\n        \"_score\" : 0.77041256,\n        \"_source\" : {\n          \"title\" : \"Keeping pets healthy\",\n          \"body\" : \"My quick brown fox eats rabbits on a regular basis.\"\n        }\n      }\n    ]\n</code></pre> <p><code>\"_score\" : 0.90425634,</code></p> <ul> <li><code>\"_id\" : \"1\"</code>\u7684\u5206\u6570\u5927\u7ea6<code>\"_id\" : \"2\"</code>\u6b64\u65f6\u662f\u4e0d\u5bf9\u7684</li> </ul> <p></p> <p></p>"},{"location":"chap4/4ES_sin_mul_search/#1-4-disjunction-max-query","title":"1-4 Disjunction Max Query\u67e5\u8be2","text":"<ul> <li>\u4e0a\u4f8b\u4e2d\uff0ctitle\u548cbody\u76f8\u4e92\u7ade\u4e89 <ul> <li>\u4e0d\u5e94\u8be5\u5c06\u5206\u6570\u7b80\u5355\u5168\u52a0\u800c\u662f\u5e94\u8be5\u627e\u5230\u5355\u4e2a\u6700\u4f73\u5339\u914d\u7684\u5b57\u6bb5\u7684\u8bc4\u5206 </li> </ul> </li> <li>Disjunction Max Query <ul> <li>\u5c06\u4efb\u4f55\u4e0e\u4efb\u4e00\u67e5\u8be2\u5339\u914d\u7684\u6587\u6863\u4f5c\u4e3a\u7ed3\u679c\u8fd4\u56de\u3002\u91c7\u7528\u5b57\u6bb5\u4e0a\u6700\u5339\u914d\u7684\u8bc4\u5206\u6700\u7ec8\u8bc4\u5206\u8fd4\u56de</li> </ul> </li> </ul> <pre><code>POST blogs/_search\n{\n    \"query\": {\n        \"dis_max\": {\n            \"queries\": [\n                { \"match\": { \"title\": \"Brown fox\" }},\n                { \"match\": { \"body\":  \"Brown fox\" }}\n            ]\n        }\n    }\n}\n</code></pre> <pre><code> \"hits\" : [\n      {\n        \"_index\" : \"blogs\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"2\",\n        \"_score\" : 0.77041256,\n        \"_source\" : {\n          \"title\" : \"Keeping pets healthy\",\n          \"body\" : \"My quick brown fox eats rabbits on a regular basis.\"\n        }\n      },\n      {\n        \"_index\" : \"blogs\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"1\",\n        \"_score\" : 0.6931471,\n        \"_source\" : {\n          \"title\" : \"Quick brown rabbits\",\n          \"body\" : \"Brown rabbits are commonly seen.\"\n        }\n      }\n    ]\n</code></pre> <ul> <li><code>\"_id\" : \"2\"</code> :  <code>\"_score\" : 0.77041256,</code></li> <li><code>\"_id\" : \"1\",</code>: <code>\"_score\" : 0.6931471,</code></li> </ul>"},{"location":"chap4/4ES_sin_mul_search/#1-5","title":"1-5 \u6700\u4f73\u5b57\u6bb5\u8c03\u4f18","text":"<pre><code>POST blogs/_search\n{\n    \"query\": {\n        \"dis_max\": {\n            \"queries\": [\n                { \"match\": { \"title\": \"Quick pets\" }},\n                { \"match\": { \"body\":  \"Quick pets\" }}\n            ]\n        }\n    }\n}\n</code></pre> <ul> <li>\u6709\u4e00\u4e9b\u60c5\u51b5\u4e0b\uff0c\u540c\u65f6\u5339\u914d<code>title</code>\u548c<code>body</code>\u5b57\u6bb5\u7684\u6587\u6863\u6bd4\u53ea\u4e0e\u4e00\u4e2a\u5b57\u6bb5\u5339\u914d\u7684\u6587\u6863\u7684\u76f8\u5173\u5ea6\u66f4\u9ad8 </li> <li>\u4f46<code>disjunction max query</code>\u67e5\u8be2\u53ea\u4f1a\u7b80\u5355\u5730\u4f7f\u7528\u5355\u4e2a\u6700\u4f73\u5339\u914d\u8bed\u53e5\u7684\u8bc4\u5206<code>_score</code>\u4f5c\u4e3a\u6574\u4f53\u8bc4\u5206\u3002\u600e\u4e48\u529e\uff1f </li> </ul>"},{"location":"chap4/4ES_sin_mul_search/#1-6-tie-breaker","title":"1-6 \u901a\u8fc7Tie Breaker\u53c2\u6570\u8c03\u6574","text":"<pre><code>POST blogs/_search\n{\n    \"query\": {\n        \"dis_max\": {\n            \"queries\": [\n                { \"match\": { \"title\": \"Quick pets\" }},\n                { \"match\": { \"body\":  \"Quick pets\" }}\n            ],\n            \"tie_breaker\": 0.2\n        }\n    }\n}\n</code></pre> <ul> <li>\u83b7\u5f97\u6700\u4f73\u5339\u914d\u8bed\u53e5\u7684\u8bc4\u5206<code>_score</code></li> <li>\u5c06\u5176\u4ed6\u5339\u914d\u8bed\u53e5\u7684\u8bc4\u5206\u4e0e<code>tie_breaker</code>\u76f8\u4e58 </li> <li>\u5bf9\u4ee5\u4e0a\u8bc4\u5206\u6c42\u548c\u5e76\u89c4\u8303\u5316 </li> <li>Tier Breaker\u662f\u4e00\u4e2a\u4ecb\u4e8e<code>0-1</code>\u4e4b\u95f4\u7684\u6d6e\u70b9\u6570\u3002<code>0</code>\u4ee3\u8868\u4f7f\u7528\u6700\u4f73\u5339\u914d\uff1b<code>1</code>\u4ee3\u8868\u6240\u6709\u8bed\u53e5\u540c\u7b49\u91cd\u8981.</li> </ul>"},{"location":"chap4/4ES_sin_mul_search/#1-7","title":"1-7 \u672c\u8282\u56de\u987e","text":"<ul> <li>\u4f7f\u7528bool\u67e5\u8be2\u5b9e\u73b0\u5355\u5b57\u7b26\u4e32\u591a\u5b57\u6bb5\u67e5\u8be2 </li> <li>\u5355\u5b57\u7b26\u4e32\u591a\u5b57\u6bb5\u67e5\u8be2\u65f6\uff0c\u5982\u4f55\u5728\u591a\u4e2a\u5b57\u6bb5\u4e0a\u8fdb\u884c\u7b97\u5206 </li> <li>\u590d\u5408\u67e5\u8be2\uff1aDisjunction Max Query <ul> <li>\u5c06\u8bc4\u5206\u6700\u9ad8\u7684\u5b57\u6bb5\u8bc4\u5206\u4f5c\u4e3a\u7ed3\u679c\u8fd4\u56de\u6ee1\u8db3\u4e24\u4e2a\u5b57\u6bb5\u662f\u7ade\u4e89\u5173\u7cfb\u7684\u573a\u666f </li> </ul> </li> <li>\u5bf9\u6700\u4f73\u5b57\u6bb5\u67e5\u8be2\u8fdb\u884c\u8c03\u4f18\uff1a\u901a\u8fc7\u63a7\u5236Tie Breaker\u53c2\u6570\u5f15\u5165\u5176\u4ed6\u5b57\u6bb5\u5bf9\u7b97\u5206\u7684\u4e00\u4e9b\u5f71\u54cd </li> </ul>"},{"location":"chap4/4ES_sin_mul_search/#2multi-match","title":"2\u3001\u5355\u5b57\u7b26\u4e32\u591a\u5b57\u6bb5\u67e5\u8be2\uff1aMulti Match","text":""},{"location":"chap4/4ES_sin_mul_search/#2-1","title":"2-1 \u4e09\u79cd\u573a\u666f","text":"<ul> <li>\u6700\u4f73\u5b57\u6bb5\uff08Best Fields) <ul> <li>\u5f53\u5b57\u6bb5\u4e4b\u95f4\u76f8\u4e92\u7ade\u4e89\u53c8\u76f8\u4e92\u5173\u8054\u3002\u4f8b\u5982<code>title</code>\u548c<code>body</code>\u8fd9\u6837\u7684\u5b57\u6bb5\u3002\u8bc4\u5206\u6765\u81ea\u6700\u5339\u914d\u5b57\u6bb5 </li> </ul> </li> <li>\u591a\u6570\u5b57\u6bb5\uff08Most Fields) <ul> <li>\u5904\u7406\u82f1\u6587\u5185\u5bb9\u65f6\uff1a\u4e00\u79cd\u5e38\u89c1\u7684\u624b\u6bb5\u662f\u5728\u4e3b\u5b57\u6bb5\uff08<code>English Analyzer</code>)\u62bd\u53d6\u8bcd\u5e72\u52a0\u5165\u540c\u4e49\u8bcd\uff0c\u4ee5\u5339\u914d\u66f4\u591a\u7684\u6587\u6863\u3002\u76f8\u540c\u7684\u6587\u672c\uff0c\u52a0\u5165\u5b50\u5b57\u6bb5(<code>Standard Analyzer</code>)\uff0c\u4ee5\u63d0\u4f9b\u66f4\u52a0\u7cbe\u786e\u7684\u5339\u914d\u3002\u5176\u4ed6\u5b57\u6bb5\u4f5c\u4e3a\u5339\u914d\u6587\u6863\u63d0\u9ad8\u76f8\u5173\u5ea6\u7684\u4fe1\u53f7\u3002\u5339\u914d\u5b57\u6bb5\u8d8a\u591a\u5219\u8d8a\u597d </li> </ul> </li> <li>\u6df7\u5408\u5b57\u6bb5\uff08Cross Field) <ul> <li>\u5bf9\u4e8e\u67d0\u4e9b\u5b9e\u4f53\u4f8b\u5982\u4eba\u540d\u5730\u5740\u56fe\u4e66\u4fe1\u606f\u3002\u9700\u8981\u5728\u591a\u4e2a\u5b57\u6bb5\u4e2d\u786e\u5b9a\u4fe1\u606f\u5355\u4e2a\u5b57\u6bb5\u53ea\u80fd\u4f5c\u4e3a\u6574\u4f53  \u7684\u4e00\u90e8\u5206\u3002\u5e0c\u671b\u5728\u4efb\u4f55\u8fd9\u4e9b\u5217\u51fa\u7684\u5b57\u6bb5\u4e2d\u627e\u5230\u5c3d\u53ef\u80fd\u591a\u7684\u8bcd </li> </ul> </li> </ul>"},{"location":"chap4/4ES_sin_mul_search/#2-2-multi-match-query","title":"2-2 Multi Match Query","text":"<ul> <li><code>Best Fields</code>\u662f\u9ed8\u8ba4\u7c7b\u578b\u53ef\u4ee5\u4e0d\u7528\u6307\u5b9a </li> <li><code>Minimum should match</code>\u7b49\u53c2\u6570\u53ef\u4ee5\u4f20\u9012\u5230\u751f\u6210\u7684query\u4e2d </li> </ul> <pre><code>POST blogs/_search\n{\n    \"query\": {\n        \"dis_max\": {\n            \"queries\": [\n                { \"match\": { \"title\": \"Quick pets\" }},\n                { \"match\": { \"body\":  \"Quick pets\" }}\n            ],\n            \"tie_breaker\": 0.2\n        }\n    }\n}\n</code></pre>"},{"location":"chap4/4ES_sin_mul_search/#2-3","title":"2-3 \u4e00\u4e2a\u67e5\u8be2\u6848\u4f8b","text":"<p>\u82f1\u6587\u5206\u8bcd\u5668\uff0c\u5bfc\u81f4\u7cbe\u786e\u5ea6\u964d\u4f4e\uff0c\u65f6\u6001\u4fe1\u606f\u4e22\u5931 </p> <pre><code>PUT /titles\n{\n  \"mappings\": {\n    \"properties\": {\n      \"title\": {\n        \"type\": \"text\",\n        \"analyzer\": \"english\"\n      }\n    }\n  }\n</code></pre> <p>output</p> <pre><code>{\n  \"acknowledged\" : true,\n  \"shards_acknowledged\" : true,\n  \"index\" : \"titles\"\n}\n</code></pre> <pre><code>POST titles/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"title\": \"My dog barks\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"title\": \"I see a lot of barking dogs on the road \" }\n</code></pre> <pre><code>GET titles/_search\n{\n  \"query\": {\n    \"match\": {\n      \"title\": \"barking dogs\"\n    }\n  }\n}\n</code></pre> <p></p> <p><code>I see a lot of barking dogs on the road</code>, <code>id 2</code> \u5e94\u8be5\u6392\u5728\u66f4\u9ad8\uff0c \u4f46\u662f<code>\"analyzer\": \"english\"</code> \u5206\u8bcd\u5668\u5c06<code>barking dogs</code>\u6253\u6563\u6210<code>barking</code>\u548c<code>dogs</code> \u6240\u4ee5 dogs \u5728 \u66f4\u77ed\u7684<code>Id: 1</code> \u6392\u540d\u66f4\u9ad8</p>"},{"location":"chap4/4ES_sin_mul_search/#2-4","title":"2-4 \u4f7f\u7528\u591a\u6570\u5b57\u6bb5\u5339\u914d\u89e3\u51b3","text":"<ul> <li> <p>\u7528\u5e7f\u5ea6\u5339\u914d\u5b57\u6bb5title\u5305\u62ec\u5c3d\u53ef\u80fd\u591a\u7684\u6587\u6863\u2014\u2014\u4ee5\u63d0\u5347\u53ec\u56de\u7387\u2014\u2014\u540c\u65f6\u53c8\u4f7f\u7528\u5b57\u6bb5<code>title.std</code>\u4f5c\u4e3a\u4fe1\u53f7\u5c06\u76f8\u5173\u5ea6\u66f4\u9ad8\u7684\u6587\u6863\u7f6e\u4e8e\u7ed3\u679c\u9876\u90e8\u3002 </p> <ul> <li>English analyzer  + standard analyzer</li> <li>\u591a\u6570\u5b57\u6bb5\uff08Most Fields) </li> </ul> </li> </ul> <pre><code>DELETE /titles\nPUT /titles\n{\n  \"mappings\": {\n    \"properties\": {\n      \"title\": {\n        \"type\": \"text\",\n        \"analyzer\": \"english\",\n        \"fields\": {\"std\": {\"type\": \"text\",\"analyzer\": \"standard\"}}\n      }\n    }\n  }\n}\n\nPOST titles/_bulk\n{ \"index\": { \"_id\": 1 }}\n{ \"title\": \"My dog barks\" }\n{ \"index\": { \"_id\": 2 }}\n{ \"title\": \"I see a lot of barking dogs on the road \" }\n</code></pre> <pre><code>GET /titles/_search\n{\n   \"query\": {\n        \"multi_match\": {\n            \"query\":  \"barking dogs\",\n            \"type\":   \"most_fields\",\n            \"fields\": [ \"title\", \"title.std\" ]\n        }\n    }\n}\n</code></pre> <p></p> <ul> <li>\u6bcf\u4e2a\u5b57\u6bb5\u5bf9\u4e8e\u6700\u7ec8\u8bc4\u5206\u7684\u8d21\u732e\u53ef\u4ee5\u901a\u8fc7\u81ea\u5b9a\u4e49\u503c<code>boost</code>\u6765\u63a7\u5236\u3002\u6bd4\u5982\uff0c\u4f7f<code>title</code>\u5b57\u6bb5\u66f4\u4e3a\u91cd\u8981\uff0c \u8fd9\u6837\u540c\u65f6\u4e5f\u964d\u4f4e\u4e86\u5176\u4ed6\u4fe1\u53f7\u5b57\u6bb5\u7684\u4f5c\u7528\uff1a </li> </ul> <pre><code>GET /titles/_search\n{\n   \"query\": {\n        \"multi_match\": {\n            \"query\":  \"barking dogs\",\n            \"type\":   \"most_fields\",\n            \"fields\": [ \"title^10\", \"title.std\" ]\n        }\n    }\n}\n</code></pre> <p>Output</p> <pre><code> \"hits\" : [\n      {\n        \"_index\" : \"titles\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"2\",\n        \"_score\" : 4.3449063,\n        \"_source\" : {\n          \"title\" : \"I see a lot of barking dogs on the road \"\n        }\n      },\n      {\n        \"_index\" : \"titles\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"1\",\n        \"_score\" : 4.222184,\n        \"_source\" : {\n          \"title\" : \"My dog barks\"\n        }\n      }\n    ]\n</code></pre>"},{"location":"chap4/4ES_sin_mul_search/#2-5","title":"2-5 \u8de8\u5b57\u6bb5\u641c\u7d22","text":"<ul> <li>\u65e0\u6cd5\u4f7f\u7528<code>Operator</code> </li> <li>\u53ef\u4ee5\u7528<code>copy_to</code>\u89e3\u51b3\uff0c\u4f46\u662f\u9700\u8981\u989d\u5916\u7684\u5b58\u50a8\u7a7a\u95f4 </li> </ul> <pre><code>PUT address/_doc/1\n{\n    \"street\" : \"5 Poland Street\",\n    \"city\" : \"London\",\n    \"coutry\" : \"United Kingdom\",\n    \"poscode\" : \"W1V 3DG\"\n}\n</code></pre> <pre><code>post address/_search\n{\n    \"query\": {\n        \"multi_match\": {\n            \"query\" :  \"Poland Street W1V\",\n         // \"operator\"  : \"and\",\n            \"type\" :   \"most_fields\",\n            \"fields\" : [ \"street\", \"city\", \"coutry\",  \"poscode\"]\n        }\n    }\n}\n</code></pre> <p>Output</p> <pre><code>\"hits\" : {\n    \"total\" : {\n      \"value\" : 0,\n      \"relation\" : \"eq\"\n    },\n    \"max_score\" : null,\n    \"hits\" : [ ]\n  }\n</code></pre>"},{"location":"chap4/4ES_sin_mul_search/#2-6-cross-field","title":"2-6 Cross Field","text":"<pre><code>post address/_search\n{\n    \"query\": {\n        \"multi_match\": {\n            \"query\" :  \"Poland Street W1V\",\n            \"type\" :   \"cross_fields\",\n            \"operator\": \"and\", \n            \"fields\" : [ \"street\", \"city\", \"coutry\",  \"poscode\"]\n        }\n    }\n}\n</code></pre> <p>Output</p> <pre><code>\"max_score\" : 0.8630463,\n    \"hits\" : [\n      {\n        \"_index\" : \"address\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"1\",\n        \"_score\" : 0.8630463,\n        \"_source\" : {\n          \"street\" : \"5 Poland Street\",\n          \"city\" : \"London\",\n          \"coutry\" : \"United Kingdom\",\n          \"poscode\" : \"W1V 3DG\"\n        }\n      }\n    ]\n</code></pre>"},{"location":"chap4/4ES_sin_mul_search/#2-7","title":"2-7  \u672c\u8282\u77e5\u8bc6\u70b9\u56de\u987e","text":"<ul> <li>Multi Match\u67e5\u8be2\u7684\u57fa\u672c\u8bed\u6cd5 </li> <li>\u67e5\u8be2\u7684\u7c7b\u578b <ul> <li>\u6700\u4f73\u5b57\u6bb5\uff0f\u591a\u6570\u5b57\u6bb5\uff0f\u8de8\u5b57\u6bb5 </li> </ul> </li> <li>Boosting </li> <li>\u63a7\u5236Precision <ul> <li>\u4ee5\u53ca\u4f7f\u7528\u5b50\u5b57\u6bb5\u591a\u6570\u5b57\u6bb5\u7b97\u5206\uff0c\u63a7\u5236 </li> <li>\u4f7f\u7528Operator </li> </ul> </li> </ul>"},{"location":"chap4/5ES_multi_lag_ana/","title":"\u7b2c\u4e94\u8282 \u591a\u8bed\u8a00\u53ca\u4e2d\u6587\u5206\u8bcd\u4e0e\u68c0\u7d22","text":""},{"location":"chap4/5ES_multi_lag_ana/#1recall","title":"1\u3001\u81ea\u7136\u8bed\u8a00\u4e0e\u67e5\u8be2Recall","text":"<ul> <li>\u5f53\u5904\u7406\u4eba\u7c7b\u767d\u7136\u8bed\u8a00\u65f6\uff0c\u6709\u4e9b\u60c5\u51b5\uff0c\u5c3d\u7ba1\u641c\u7d22\u548c\u539f\u6587\u4e0d\u5b8c\u5168\u5339\u914d\uff0c\u4f46\u662f\u5e0c\u671b\u641c\u5230\u4e00\u4e9b\u5185\u5bb9 <ul> <li><code>Quick browrn fox</code>\u548c<code>fast brown fox</code> / <code>Jumping fox</code>\u548c<code>Jumped foxes</code> </li> </ul> </li> <li>\u4e00\u4e9b\u53ef\u91c7\u53d6\u7684\u4f18\u5316 <ul> <li>\u5f52\u4e00\u5316\u8c03\u5143\u6e05\u9664\u53d8\u97f3\u7b26\u53f7\u5982<code>r\u00f4le</code>\u7684\u65f6\u5019\u4e5f\u4f1a\u5339\u914d<code>role</code> </li> <li>\u62bd\u53d6\u8bcd\u6839\uff1a\u6e05\u9664\u5355\u590d\u6570\u548c\u65f6\u6001\u7684\u5dee\u5f02 </li> <li>\u5305\u542b\u540c\u4e49\u8bcd </li> <li>\u62fc\u5199\u9519\u8bef\uff1a\u62fc\u5199\u9519\u8bef\u6216\u8005\u540c\u97f3\u5f02\u5f62\u8c03 </li> </ul> </li> </ul>"},{"location":"chap4/5ES_multi_lag_ana/#2","title":"2\u3001\u6df7\u5408\u591a\u8bed\u8a00\u7684\u6311\u6218","text":"<ul> <li>\u4e00\u4e9b\u5177\u4f53\u7684\u591a\u8bed\u8a00\u573a\u666f <ul> <li>\u4e0d\u540c\u7684\u7d22\u5f15\u4f7f\u7528\u4e0d\u540c\u7684\u8bed</li> <li>\u540c\u4e00\u4e2a\u7d22\u5f15\u4e2d\uff0c\u4e0d\u540c\u7684\u5b57\u6bb5\u4f7f\u7528\u4e0d\u540c\u7684\u8bed\u8a00</li> <li>\u4e00\u4e2a\u6587\u6863\u7684\u4e00\u4e2a\u5b57\u6bb5\u5185\u6df7\u5408\u4e0d\u540c\u7684\u8bed\u8a00 </li> </ul> </li> <li>\u6df7\u5408\u8bed\u8a00\u5b58\u5728\u7684\u4e00\u4e9b\u6311\u6218 <ul> <li>\u8bcd\u5e72\u63d0\u53d6\uff1a\u4ee5\u8272\u5217\u6587\u6863\uff0c\u5305\u542b\u4e86\u5e0c\u4f2f\u6765\u8bed\uff0c\u963f\u62c9\u4f2f\u8bed\uff0c\u4fc4\u8bed\u548c\u82f1\u6587 </li> <li>\u4e0d\u6b63\u786e\u7684\u6587\u6863\u9891\u7387\u2014\u2014\u82f1\u6587\u4e3a\u4e3b\u7684\u6587\u7ae0\u4e2d\uff0c\u5fb7\u6587\u7b97\u5206\u9ad8\uff08\u7a00\u6709\uff09 </li> <li>\u9700\u8981\u5224\u65ad\u7528\u6237\u641c\u7d22\u65f6\u4f7f\u7528\u7684\u8bed\u8a00\u8bed\u8a00\u8bc6\u522b\uff08Compact Language Detector) <ul> <li>\u4f8b\u5982\u6839\u636e\u8bed\u8a00\u67e5\u8be2\u4e0d\u540c\u7684\u7d22\u5f15 </li> </ul> </li> </ul> </li> </ul>"},{"location":"chap4/5ES_multi_lag_ana/#3","title":"3\u3001\u5206\u8bcd\u7684\u6311\u6218","text":"<ul> <li>\u82f1\u6587\u5206\u8bcd\uff1a\u00b7You\u2019re\u00b7\u5206\u6210\u4e00\u4e2a\u8fd8\u662f\u591a\u4e2a\uff1f<code>Half-baked</code> </li> <li>\u4e2d\u6587\u5206\u8bcd <ul> <li>\u5206\u8bcd\u6807\u51c6\uff1a\u54c8\u5de5\u5927\u6807\u51c6\u4e2d\u59d3\u548c\u540d\u5206\u5f00\u3002<code>HanLP</code>\u662f\u5728\u4e00\u8d77\u7684\u3002\u5177\u4f53\u60c5\u51b5\u9700\u5236\u5b9a\u4e0d\u540c\u7684\u6807\u51c6 </li> <li>\u6b67\u4e49\uff08\u7ec4\u5408\u578b\u6b67\u4e49\uff0c\u4ea4\u96c6\u578b\u6b67\u4e49\uff0c\u771f\u6b67\u4e49\uff09 <ul> <li>\u4e2d\u534e\u4eba\u6c11\u5171\u548c\u56fd\uff0f\u7f8e\u56fd\u4f1a\u901a\u8fc7\u5bf9\u53f0\u552e\u6b66\u6cd5\u6848\uff0f\u4e0a\u6d77\u4ec1\u548c\u670d\u88c5\u5382 </li> </ul> </li> </ul> </li> </ul>"},{"location":"chap4/5ES_multi_lag_ana/#4","title":"4\u3001\u4e2d\u6587\u5206\u8bcd\u65b9\u6cd5\u7684\u6f14\u53d8\u2014\u2014\u5b57\u5178\u6cd5","text":"<ul> <li>\u67e5\u5b57\u5178\u6700\u5bb9\u6613\u60f3\u5230\u7684\u5206\u8bcd\u65b9\u6cd5\uff08\u5317\u4eac\u822a\u7a7a\u5927\u5b66\u7684\u6881\u5357\u5143\u6559\u6388\u63d0\u51fa\uff09 <ul> <li>\u4e00\u4e2a\u53e5\u5b50\u4ece\u5de6\u5230\u53f3\u626b\u63cf\u4e00\u904d\u3002\u9047\u5230\u6709\u7684\u8c03\u5c31\u6807\u793a\u51fa\u6765\u3002\u627e\u5230\u590d\u5408\u8bcd\uff0c\u5c31\u627e\u6700\u957f\u7684 </li> <li>\u4e0d\u8ba4\u8bc6\u7684\u5b57\u4e32\u5c31\u5206\u5272\u6210\u5355\u5b57\u8bcd </li> </ul> </li> <li>\u6700\u5c0f\u8bcd\u6570\u7684\u5206\u8bcd\u7406\u8bba\u2014\u2014\u54c8\u5de5\u5927\u738b\u6653\u9f99\u535a\u58eb\u628a\u67e5\u5b57\u5178\u7684\u65b9\u6cd5\u7406\u8bba\u5316 <ul> <li>\u4e00\u53e5\u8bdd\u5e94\u8be5\u5206\u6210\u6570\u91cf\u6700\u5c11\u7684\u8bcd\u4e32 </li> <li>\u9047\u5230\u4e8c\u5f02\u6027\uff0c\u65e0\u80fd\u4e3a\u529b\uff08\u4f8b\u5982\uff1a\u201c\u53d1\u5c55\u4e2d\u56fd\u5bb6\u5382\u201d/ \u201c\u4e0a\u6d77\u5927\u5b66\u57ce\u4e66\u5e97\u201d\uff09</li> <li>\u7528\u5404\u79cd\u6587\u5316\u89c4\u5219\u6765\u89e3\u51b3\u4e8c\u4e49\u6027\u90fd\u5e76\u4e0d\u6210\u529f </li> </ul> </li> </ul>"},{"location":"chap4/5ES_multi_lag_ana/#5","title":"5\u3001\u4e2d\u6587\u5206\u8bcd\u65b9\u6cd5\u7684\u6f14\u53d8\u2014\u2014\u57fa\u4e8e\u7edf\u8ba1\u6cd5\u7684\u673a\u5668\u5b66\u4e60\u7b97\u6cd5\u5907","text":"<ul> <li>\u7edf\u8ba1\u8bed\u8a00\u6a21\u578b\u4e001990\u5e74\u524d\u540e\u6e05\u534e\u5927\u5b66\u7535\u5b50\u5de5\u7a0b\u7cfb\u90ed\u8fdb\u535a\u58eb <ul> <li>\u89e3\u51b3\u4e86\u4e8c\u4e49\u6027\u95ee\u9898\u5c06\u4e2d\u6587\u5206\u8bcd\u7684\u9519\u8bef\u7387\u964d\u4f4e\u4e86\u4e00\u4e2a\u6570\u91cf\u7ea7\u3002\u6982\u7387\u95ee\u9898\u52a8\u6001\u89c4\u5212+\u5229\u7528\u7ef4\u7279\u6bd4\u7b97 \u6cd5\u51b3\u901f\u627e\u5230\u6700\u4f73\u5206\u8c03 </li> </ul> </li> <li>\u57fa\u4e8e\u7edf\u8ba1\u7684\u673a\u5668\u5b66\u4e60\u7b97\u6cd5<ul> <li>\u8fd9\u7c7b\u76ee\u524d\u5e38\u7528\u7684\u662f\u7b97\u6cd5\u662f<code>HMM, CRF, SVM</code>,\u6df1\u5ea6\u5b66\u4e60\u7b49\u7b97\u6cd5\u3002\u6bd4\u5982<code>Hanlp</code>\u5206\u8bcd\u5de5\u5177\u662f\u57fa\u4e8e<code>CRF</code>\u7b97\u6cd5\u4ee5<code>CRF</code>\u4e3a\u4f8b\uff0c\u57fa\u672c\u601d\u8def\u662f\u5bf9\u6c49\u5b87\u8fdb\u884c\u6807\u6ce8\u8bad\u7ec3\uff0c\u4e0d\u4ec5\u8003\u8651\u4e86\u8c03\u8bed\u51fa\u73b0\u7684\u9891\u7387\uff0c\u8fd8\u8003\u8651\u4e0a\u4e0b\u6587\uff0c\u5177\u5404\u8f6c\u597d\u7684\u5b66\u4e60\u80fd\u529b\uff0c\u56e0\u6b64\u771f\u5bf9\u6b67\u4e49\u8c03\u548c\u672a\u767b\u5f55\u8bcd\u7684\u8bc6\u522b\u90fd\u5177\u6709\u826f\u597d\u7684\u6548\u679c\uff0e </li> <li>\u968f\u7740\u6df1\u5ea6\u5b66\u4e60\u7684\u5174\u8d77\uff0c\u4e5f\u51fa\u73b0\u4e86\u57fa\u4e8e\u795e\u7ecf\u7f51\u7edc\u7684\u5206\u8c03\u5668\u6709\u4eba\u5c1d\u8bd5\u4f7f\u7528\u53cc\u5411<code>LSTM+CRF</code>\u5b9e\u73b0\u5206\u8c03\u5668\uff0c\u5176\u672c\u8d28\u4e0a\u662f\u5e8f\u5217\u6807\u6ce8\uff0c\u636e\u62a5\u9053\u5176\u5206\u8bcd\u5668\u5b57\u7b26\u51c6\u786e\u7387\u53ef\u9ad8\u8fbe97.5% </li> </ul> </li> </ul>"},{"location":"chap4/5ES_multi_lag_ana/#6","title":"6\u3001\u4e2d\u6587\u5206\u8bcd\u5668\u73b0\u72b6","text":"<ul> <li>\u4e2d\u6587\u5206\u8bcd\u5668\u4ee5\u7edf\u8ba1\u8bed\u8a00\u6a21\u578b\u4e3a\u57fa\u7840\uff0c\u7ecf\u8fc7\u51e0\u5341\u5e74\u7684\u53d1\u5c55\uff0c\u4eca\u5929\u57fa\u672c\u5df2\u7ecf\u53ef\u4ee5\u770b\u4f5c\u662f\u4e00\u4e2a\u5df2\u7ecf\u89e3\u51b3\u7684\u95ee\u9898 </li> <li>\u4e0d\u540c\u5206\u8bcd\u5668\u7684\u597d\u574f\u4e3b\u8981\u7684\u5dee\u522b\u5728\u4e8e\u6570\u636e\u7684\u4f7f\u7528\u548c\u5de5\u7a0b\u4f7f\u7528\u7684\u7cbe\u5ea6 </li> <li>\u5e38\u89c1\u7684\u5206\u8bcd\u5668\u90fd\u662f\u4f7f\u7528\u673a\u5668\u5b66\u4e60\u7b97\u6cd5\u548c\u8bcd\u5178\u76f8\u7ed3\u5408\uff0c\u4e00\u65b9\u9762\u80fd\u591f\u63d0\u9ad8\u5206\u8bcd\u51c6\u786e\u7387\uff0c\u53e6\u4e00\u65b9\u9762\u80fd\u591f\u6539\u5584\u9886\u57df\u9002\u5e94\u6027</li> </ul>"},{"location":"chap4/5ES_multi_lag_ana/#7","title":"7\u3001\u4e00\u4e9b\u4e2d\u6587\u5206\u8bcd\u5668","text":"<ul> <li>HanLP\u4e00\u9762\u5411\u751f\u4ea7\u73af\u5883\u7684\u81ea\u7136\u8bed\u8a00\u5904\u7406\u5de5\u5177\u5305 <ul> <li>http://hanlp.com/</li> <li>https://github.com/KennFalcon/elasticsearch-analysis-hanlp</li> </ul> </li> <li>IK\u5206\u8bcd\u5668<ul> <li>https://github.com/medcl/elasticsearch-analysis-ik</li> </ul> </li> </ul>"},{"location":"chap4/5ES_multi_lag_ana/#8hanlp-analysis","title":"8\u3001HanLP  Analysis","text":"<ul> <li>HanLP </li> </ul> <pre><code>./elasticsearch-plugin install https://github.com/KennFalcon/elasticsearch-analysis-hanlp/releases/download/v7.9.1/elasticsearch-analysis-hanlp-7.9.1.zip\n</code></pre>"},{"location":"chap4/5ES_multi_lag_ana/#9ik-analysis","title":"9\u3001IK Analysis","text":""},{"location":"chap4/5ES_multi_lag_ana/#pinyin","title":"Pinyin","text":"<pre><code>./elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-pinyin/releases/download/v7.9.1/elasticsearch-analysis-pinyin-7.9.1.zip\n</code></pre>"},{"location":"chap4/5ES_multi_lag_ana/#10-demo","title":"10\u3001\u4e2d\u2f42\u6587\u5206\u8bcd Demo","text":"<ul> <li>\u4f7f\u2f64\u7528\u4e0d\u4e0d\u540c\u7684\u5206\u8bcd\u5668\u5668\u6d4b\u8bd5\u6548\u679c</li> <li>\u7d22\u5f15\u65f6\uff0c\u5c3d\u91cf\u91cf\u5207\u5206\u7684\u77ed\uff0c\u67e5\u8be2\u7684\u65f6\u5019\uff0c\u5c3d\u91cf\u91cf\u2f64\u7528\u2ed3\u957f\u7684\u8bcd </li> <li>\u62fc\u2fb3\u97f3\u5206\u8bcd\u5668\u5668</li> </ul> <pre><code>#stop word\n\nDELETE my_index\nPUT /my_index/_doc/1\n{ \"title\": \"I'm happy for this fox\" }\n\nPUT /my_index/_doc/2\n{ \"title\": \"I'm not happy about my fox problem\"}\n</code></pre> <pre><code>POST my_index/_search\n{\n  \"query\": {\n    \"match\": {\n      \"title\": \"not happy fox\"\n    }\n  }\n}\n</code></pre> <p>Output</p> <pre><code> \"max_score\" : 0.9902718,\n    \"hits\" : [\n      {\n        \"_index\" : \"my_index\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"2\",\n        \"_score\" : 0.9902718,\n        \"_source\" : {\n          \"title\" : \"I'm not happy about my fox problem\"\n        }\n      },\n      {\n        \"_index\" : \"my_index\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"1\",\n        \"_score\" : 0.39132434,\n        \"_source\" : {\n          \"title\" : \"I'm happy for this fox\"\n        }\n      }\n    ]\n</code></pre> <p>\u867d\u7136\u901a\u8fc7\u4f7f\u7528 english \uff08\u82f1\u8bed\uff09\u5206\u6790\u5668\uff0c\u4f7f\u5f97\u5339\u914d\u89c4\u5219\u66f4\u52a0\u5bbd\u677e\uff0c\u6211\u4eec\u4e5f\u56e0\u6b64\u63d0\u9ad8\u4e86\u53ec\u56de\u7387\uff0c\u4f46\u5374\u964d\u4f4e\u4e86\u7cbe\u51c6\u5339\u914d\u6587\u6863\u7684\u80fd\u529b\u3002\u4e3a\u4e86\u83b7\u5f97\u4e24\u65b9\u9762\u7684\u4f18\u52bf\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528multifields\uff08\u591a\u5b57\u6bb5\uff09\u5bf9 title \u5b57\u6bb5\u5efa\u7acb\u4e24\u6b21\u7d22\u5f15\uff1a \u4e00\u6b21\u4f7f\u7528 <code>english</code>\uff08\u82f1\u8bed\uff09\u5206\u6790\u5668\uff0c\u53e6\u4e00\u6b21\u4f7f\u7528 <code>standard</code>\uff08\u6807\u51c6\uff09\u5206\u6790\u5668:</p> <pre><code>PUT /my_index\n{\n  \"mappings\": {\n    \"blog\": {\n      \"properties\": {\n        \"title\": {\n          \"type\": \"string\",\n          \"analyzer\": \"english\"\n        }\n      }\n    }\n  }\n}\n</code></pre> <p>Error :</p> <pre><code>\"caused_by\" : {\n      \"type\" : \"mapper_parsing_exception\",\n      \"reason\" : \"Root mapping definition has unsupported parameters:  [blog : {properties={title={analyzer=english, type=string}}}]\"\n    }\n   },\n \"status\" : 400\n</code></pre> <ol> <li>\u53bb\u6389<code>mappings</code>\u4e0b\u9762\u7684<code>blog</code>\uff0c\u5728<code>put</code>\u65f6\u5df2\u6307\u5b9a<code>my_index</code></li> <li><code>\"type\": \"string\",</code>\u6ca1\u6709\u8fd9\u4e2a\u7c7b\u578b</li> </ol> <pre><code>PUT /my_index\n{\n  \"mappings\": {\n      \"properties\": {\n        \"title\": {\n          \"type\": \"text\",\n          \"fields\": {\n            \"english\": {\n              \"type\":     \"text\",\n              \"analyzer\": \"english\"\n          }\n        }\n      }\n    }\n  }\n}\n\nPUT /my_index/_doc/1\n{ \"title\": \"I'm happy for this fox\" }\n\nPUT /my_index/_doc/2\n{ \"title\": \"I'm not happy about my fox problem\" }\n\n\nGET /my_index/_search\n{\n  \"query\": {\n    \"multi_match\": {\n      \"type\":     \"most_fields\",\n      \"query\":    \"not happy foxes\",\n      \"fields\": [ \"title\", \"title.english\" ]\n    }\n  }\n}\n</code></pre> <p>Output</p> <pre><code>\"max_score\" : 1.1404738,\n\"hits\" : [\n      {\n        \"_index\" : \"my_index\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"2\",\n        \"_score\" : 1.1404738,\n        \"_source\" : {\n          \"title\" : \"I'm not happy about my fox problem\"\n        }\n      },\n      {\n        \"_index\" : \"my_index\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"1\",\n        \"_score\" : 0.6178806,\n        \"_source\" : {\n          \"title\" : \"I'm happy for this fox\"\n        }\n      }\n    ]\n</code></pre> <p>\u5b89\u88c5\u63d2\u4ef6</p> <pre><code>docker exec -it es7_01 bash\ndocker exec -it es7_02 bash\n\n\nbin/elasticsearch-plugin install https://github.com/KennFalcon/elasticsearch-analysis-hanlp/releases/download/v7.9.1/elasticsearch-analysis-hanlp-7.9.1.zip\nbin/elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-pinyin/releases/download/v7.9.1/elasticsearch-analysis-pinyin-7.9.1.zip\n\n\nbin/elasticsearch-plugin list\nanalysis-pinyin\n</code></pre> <pre><code>docker restart es7_01\ndocker restart es7_02\n\nhttp://192.168.33.12:9200/_cat/plugins\nes79   analysis-icu    7.9.1\nes79   analysis-pinyin 7.9.1\nes7_02 analysis-icu    7.9.1\nes7_02 analysis-ik     7.9.1\nes7_02 analysis-pinyin 7.9.1\n</code></pre> <pre><code>#ik_max_word\n#ik_smart\n#hanlp: hanlp\u9ed8\u8ba4\u5206\u8bcd\n#hanlp_standard: \u6807\u51c6\u5206\u8bcd\n#hanlp_index: \u7d22\u5f15\u5206\u8bcd\n#hanlp_nlp: NLP\u5206\u8bcd\n#hanlp_n_short: N-\u6700\u77ed\u8def\u5206\u8bcd\n#hanlp_dijkstra: \u6700\u77ed\u8def\u5206\u8bcd\n#hanlp_crf: CRF\u5206\u8bcd\uff08\u5728hanlp 1.6.6\u5df2\u5f00\u59cb\u5e9f\u5f03\uff09\n#hanlp_speed: \u6781\u901f\u8bcd\u5178\u5206\u8bcd\n\nPOST _analyze\n{\n  \"analyzer\": \"hanlp_standard\",\n  \"text\": [\"\u5251\u6865\u5206\u6790\u516c\u53f8\u591a\u4f4d\u9ad8\u7ba1\u5bf9\u5367\u5e95\u8bb0\u8005\u8bf4\uff0c\u4ed6\u4eec\u786e\u4fdd\u4e86\u5510\u7eb3\u5fb7\u00b7\u7279\u6717\u666e\u5728\u603b\u7edf\u5927\u9009\u4e2d\u83b7\u80dc\"]\n\n} \n</code></pre> <pre><code>#Pinyin\nPUT /artists/\n{\n    \"settings\" : {\n        \"analysis\" : {\n            \"analyzer\" : {\n                \"user_name_analyzer\" : {\n                    \"tokenizer\" : \"whitespace\",\n                    \"filter\" : \"pinyin_first_letter_and_full_pinyin_filter\"\n                }\n            },\n            \"filter\" : {\n                \"pinyin_first_letter_and_full_pinyin_filter\" : {\n                    \"type\" : \"pinyin\",\n                    \"keep_first_letter\" : true,\n                    \"keep_full_pinyin\" : false,\n                    \"keep_none_chinese\" : true,\n                    \"keep_original\" : false,\n                    \"limit_first_letter_length\" : 16,\n                    \"lowercase\" : true,\n                    \"trim_whitespace\" : true,\n                    \"keep_none_chinese_in_first_letter\" : true\n                }\n            }\n        }\n    }\n}\n\n\nGET /artists/_analyze\n{\n  \"text\": [\"\u5218\u5fb7\u534e \u5f20\u5b66\u53cb \u90ed\u5bcc\u57ce \u9ece\u660e \u56db\u5927\u5929\u738b\"],\n  \"analyzer\": \"user_name_analyzer\"\n}\n\n</code></pre> <p>Output :</p> <pre><code>{\n  \"tokens\" : [\n    {\n      \"token\" : \"ldh\",\n      \"start_offset\" : 0,\n      \"end_offset\" : 3,\n      \"type\" : \"word\",\n      \"position\" : 0\n    },\n    {\n      \"token\" : \"zxy\",\n      \"start_offset\" : 4,\n      \"end_offset\" : 7,\n      \"type\" : \"word\",\n      \"position\" : 1\n    },\n    {\n      \"token\" : \"gfc\",\n      \"start_offset\" : 8,\n      \"end_offset\" : 11,\n      \"type\" : \"word\",\n      \"position\" : 2\n    },\n    {\n      \"token\" : \"lm\",\n      \"start_offset\" : 12,\n      \"end_offset\" : 14,\n      \"type\" : \"word\",\n      \"position\" : 3\n    },\n    {\n      \"token\" : \"sdtw\",\n      \"start_offset\" : 15,\n      \"end_offset\" : 19,\n      \"type\" : \"word\",\n      \"position\" : 4\n    }\n  ]\n}\n</code></pre>"},{"location":"chap4/5ES_multi_lag_ana/#11","title":"11\u3001\u76f8\u5173\u8d44\u6e90","text":"<ul> <li>Elasticsearch IK\u5206\u8bcd\u63d2\u4ef6 https://github.com/medcl/elasticsearch-analysis-ik/releases</li> <li>Elasticsearch hanlp \u5206\u8bcd\u63d2\u4ef6 https://github.com/KennFalcon/elasticsearch-analysis-hanlp</li> <li>\u5206\u8bcd\u7b97\u6cd5\u7efc\u8ff0 https://zhuanlan.zhihu.com/p/50444885</li> </ul>"},{"location":"chap4/6ES_pra_tmdb/","title":"\u7b2c\u516d\u8282 Space Jam\uff0c\u4e00\u6b21\u5168\u6587\u641c\u7d22\u7684\u5b9e\u4f8b","text":""},{"location":"chap4/6ES_pra_tmdb/#1-1","title":"1-1 \u76ee\u7684","text":"<ul> <li>\u76ee\u6807:\u2f64\u8fc7\u2f00\u4e2a\u5177\u4f53\u6848\u4f8b\u4f8b\uff0c\u5e2e\u52a9\u4f60\u4e86\u89e3\u5e76\u5de9\u56fa\u6240\u5b66\u7684\u77e5\u8bc6\u70b9 <ul> <li>\u5199\u2f0a\u6570\u636e / \u8bbe\u7f6e <code>Mapping</code>\uff0c\u8bbe\u7f6e <code>Analysis</code></li> <li>\u67e5\u8be2\u5e76\u2fbc\u4eae\u663e\u793a\u7ed3\u679c</li> <li>\u5206\u6790\u67e5\u8be2\u7ed3\u679c\uff0c\u901a\u8fc7\u4fee\u6539\u914d\u7f6e\u548c\u67e5\u8be2\uff0c\u4f18\u5316\u641c\u7d22\u7684\u76f8\u5173\u6027</li> </ul> </li> <li>\u5206\u6790\u95ee\u9898\uff0c\u7ed3\u5408\u539f\u7406\uff0c\u5206\u6790\u601d\u8003\u5e76\u52a0\u4ee5\u5b9e\u8df5</li> </ul>"},{"location":"chap4/6ES_pra_tmdb/#1-2-tmdb","title":"1-2 TMDB \u6570\u636e\u5e93","text":"<ul> <li>\u521b\u5efa\u4e8e 2008 \u5e74\u5e74\uff0c\u7535\u5f71\u7684 Meta Data \u5e93<ul> <li>46 \u4e07\u672c\u7535\u5f71 / 12\u4e07\u672c\u7535\u89c6\u5267 / 230\u4e07\u5f20\u56fe\u7247 / \u6bcf\u5468 20\u4e07\u6b21\u7f16\u8f91</li> </ul> </li> <li>\u63d0\u4f9b API\u3002\u603b\u5171\u6709\u8d85\u8fc720\u4e07\u5f00\u53d1\u2f08\u4eba\u5458\u548c\u516c\u53f8\u5728\u4f7f\u2f64</li> </ul>"},{"location":"chap4/6ES_pra_tmdb/#1-3","title":"1-3 \u6570\u636e\u5bfc\u5165","text":"<ul> <li>\u6570\u636e\u7279\u5f81 \u2013 \u6807\u9898\u4fe1\u606f\u8f83\u77ed / \u6982\u8ff0\u76f8\u5bf9\u8f83\u2ed3</li> <li>\u901a\u8fc7 <code>TDMB Search API</code></li> <li>\u5c06\u67e5\u8be2\u6570\u636e\u4fdd\u5b58\u5728\u672c\u5730 CSV \u2f42\u6587\u4ef6\u4e2d</li> <li>\u4f7f\u2f64 <code>Python</code> \u5bfc\u5165\u53ca\u67e5\u8be2\u6570\u636e</li> <li>\u7d22\u5f15\u7684\u4e3b\u5206\u7247\u6570\u8bbe\u7f6e\u4e3a <code>1</code>\uff0c\u4f7f\u2f64\u9ed8\u8ba4 <code>Dynamic Mapping</code></li> </ul> <pre><code>curl \"https://bootstrap.pypa.io/get-pip.py\" -o \"get-pip.py\"\npython get-pip.py\npip install -r requirements.txt\n</code></pre> <pre><code> tree tmdb-search\ntmdb-search\n\u251c\u2500\u2500 ingest_tmdb_from_file.py\n\u251c\u2500\u2500 ingest_tmdb_to_appserarch.py\n\u251c\u2500\u2500 mapping\n\u2502   \u251c\u2500\u2500 english_analyzer.json\n\u2502   \u2514\u2500\u2500 english_english_3_shards.json\n\u251c\u2500\u2500 query\n\u2502   \u251c\u2500\u2500 query_space_jam.json\n\u2502   \u251c\u2500\u2500 query_space_jam_improved.json\n\u2502   \u2514\u2500\u2500 query_space_jam_most_fields.json\n\u251c\u2500\u2500 query_tmdb.py\n\u251c\u2500\u2500 requirements.txt\n\u2514\u2500\u2500 tmdb.json\n\n2 directories, 10 files\n</code></pre> <pre><code>$ python ingest_tmdb_from_file.py \n\n&gt;&gt; Please select the mapping file. Choose 0 for empty mapping\n\n[0] empty mapping. It will use dynamic mapping with default settings\n[1] english_analyzer.json\n[2] english_english_3_shards.json\n0\nreturn empty\nsettings:\n{}\nResponse for createing the index with the settings and mappings. {\"acknowledged\":true,\"shards_acknowledged\":true,\"index\":\"tmdb\"}\nStart ingesting data......\nDone for ingesting TMDB data into Elasticsearch\n</code></pre>"},{"location":"chap4/6ES_pra_tmdb/#1-4-use-case-space-jam","title":"1-4 Use Case \u2013 \u67e5\u627e Space Jam","text":"<ul> <li>\u7a7a\u4e2d\u2f24\u5927\u704c\u7bee (Space JAM)<ul> <li>\u534e\u7eb3\u516c\u53f8\u52a8\u753b\u660e\u661f / \u7bee\u7403\u5de8\u661f\u4e54\u4e39 / \u5916\u661f\u5c0f\u602a\u7269</li> </ul> </li> <li>\u6848\u4f8b:\u2f64\u6237\u4e0d\u8bb0\u5f97\u7535\u5f71\u540d\uff0c\u2f7d\u5e0c\u671b\u901a\u8fc7\u2f00\u4e9b\u5173\u952e\u5b57\uff0c\u641c\u7d22\u5230\u7535\u5f71\u7684\u8be6\u7ec6\u4fe1\u606f</li> <li>\u641c\u7d22\u5173\u952e\u5b57:\u201cBasketball with Cartoon Aliens\u201d</li> </ul> <p>\u6d4b\u8bd5\u6570\u636e\u53ca\u4ee3\u7801</p> <p><code>query_space_jam.json</code></p> <pre><code>{\n      \"_source\": [\"title\",\"overview\"],\n      \"size\":20,\n      \"query\": {\n          \"multi_match\": {\n              \"query\": \"basketball with cartoon aliens\",\n              \"fields\": [\"title^10\",\"overview\"]\n          }\n      },\n      \"highlight\" : {\n            \"fields\" : {\n                \"overview\" : { \"pre_tags\" : [\"&lt;em&gt;\"], \"post_tags\" : [\"&lt;/em&gt;\"] },\n                \"title\" : { \"pre_tags\" : [\"&lt;em&gt;\"], \"post_tags\" : [\"&lt;/em&gt;\"] }\n            }\n        }\n\n  }\n</code></pre> <pre><code>python query_tmdb.py\n</code></pre> <p> </p> <p><code>query_space_jam_most_fields.json</code></p> <pre><code>{\n      \"_source\": [\"title\",\"overview\"],\n      \"size\":20,\n      \"query\": {\n          \"multi_match\": {\n              \"type\": \"most_fields\",\n              \"query\": \"basketball with cartoon aliens\",\n              \"fields\": [\"title\",\"overview\"]\n          }\n      },\n      \"highlight\" : {\n            \"fields\" : {\n              \"overview\" : { \"pre_tags\" : [\"&lt;em&gt;\"], \"post_tags\" : [\"&lt;/em&gt;\"] },\n              \"title\" : { \"pre_tags\" : [\"&lt;em&gt;\"], \"post_tags\" : [\"&lt;/em&gt;\"] }\n            }\n        }\n  }\n</code></pre> <ul> <li><code>\"type\": \"most_fields\",</code></li> </ul> <p> </p> <p><code>query_space_jam_improved.json</code></p> <pre><code>POST tmdb/_search\n{\n      \"_source\": [\"title\",\"overview\"],\n      \"size\":20,\n      \"query\": {\n          \"multi_match\": {\n              \"query\": \"basketball with cartoon aliens\",\n              \"fields\": [\"title\",\"overview\"]\n          }\n      },\n      \"highlight\" : {\n            \"fields\" : {\n              \"overview\" : { \"pre_tags\" : [\"&lt;em&gt;\"], \"post_tags\" : [\"&lt;/em&gt;\"] },\n              \"title\" : { \"pre_tags\" : [\"&lt;em&gt;\"], \"post_tags\" : [\"&lt;/em&gt;\"] }\n            }\n        }\n  }\n</code></pre> <p> </p>"},{"location":"chap4/6ES_pra_tmdb/#1-5","title":"1-5 \u601d\u8003\u4e0e\u5206\u6790","text":"<ul> <li>\u201c\u7cbe\u786e\u503c\u201d \u8fd8\u662f \u201c\u5168\u2f42\u201d?</li> <li>\u641c\u7d22\u662f\u600e\u4e48\u6837\u7684?\u4e0d\u540c\u7684\u5b57\u6bb5\u9700\u8981\u914d\u7f6e\u600e\u4e48\u6837\u7684\u5206\u8bcd\u5668</li> <li>\u6d4b\u8bd5\u4e0d\u540c\u7684\u7684\u9009\u9879<ul> <li>\u5206\u8bcd\u671f / \u591a\u5b57\u6bb5\u5c5e\u6027 / \u662f\u5426\u8981 g-grams / what are some critical synonyms / \u4e3a\u5b57\u6bb5\u8bbe\u7f6e\u4e0d\u540c\u7684\u6743\u91cd</li> <li>\u6d4b\u8bd5\u4e0d\u540c\u7684\u9009\u9879\uff0c\u6d4b\u8bd5\u4e0d\u540c\u7684\u641c\u7d22\u6761\u4ef6</li> </ul> </li> </ul>"},{"location":"chap4/6ES_pra_tmdb/#1-6","title":"1-6 \u6d4b\u8bd5\u76f8\u5173\u6027 \u2013 \u7406\u7406\u89e3\u539f\u7406\u7406 + \u591a\u5206\u6790 + \u591a\u8c03\u6574\u6d4b\u8bd5","text":"<ul> <li>\u6280\u672f\u5206\u4e3a\u9053\u548c\u672f\u4e24\u79cd<ul> <li>\u9053 \u2013 \u539f\u7406\u548c\u539f\u5219</li> <li>\u672f \u2013 \u5177\u4f53\u7684\u505a\u6cd5\uff0c\u5177\u4f53\u7684\u89e3\u6cd5</li> </ul> </li> <li>\u5173\u4e8e\u641c\u7d22\uff0c\u4e3a\u4e86\u6709\u2f00\u4e2a\u597d\u7684\u641c\u7d22\u7ed3\u679c\u3002\u9664\u4e86\u771f\u6b63\u7406\u89e3\u80cc\u540e\u7684\u539f\u7406\uff0c\u66f4\u9700\u8981\u591a\u52a0\u5b9e\u8df5\u4e0e\u5206\u6790<ul> <li>\u5355\u7eaf\u8ffd\u6c42\u201c\u672f\u201d\uff0c\u4f1a\u2f00\u76f4\u5f88\u2f9f\u82e6\u3002\u53ea\u6709\u638c\u63e1\u4e86\u672c\u8d28\u548c\u7cbe\u9ad3\u4e4b\u201c\u9053\u201d\uff0c\u505a\u4e8b\u624d\u80fd\u6e38\u5203\u6709\u4f59</li> <li>\u8981\u505a\u597d\u641c\u7d22\uff0c\u9664\u4e86\u4e86\u7406\u89e3\u539f\u7406\uff0c\u4e5f\u9700\u8981\u575a\u6301\u53bb\u5206\u6790\u2f00\u4e9b\u4e0d\u597d\u7684\u641c\u7d22\u7ed3\u679c\u3002\u53ea\u6709\u901a\u8fc7\u2f00\u5b9a\u65f6\u95f4\u7684\u79ef\u7d2f\uff0c \u624d\u80fd\u771f\u6b63\u6709\u6240\u611f\u89c9</li> <li>\u603b\u5e0c\u671b\u2f00\u4e2a\u6a21\u578b\uff0c\u2f00\u4e2a\u7b97\u6cd5\uff0c\u5c31\u80fd\u6bd5\u5176\u529f\u4e8e\u2f00\u5f79\uff0c\u662f\u4e0d\u73b0\u5b9e\u7684</li> </ul> </li> </ul>"},{"location":"chap4/6ES_pra_tmdb/#1-7","title":"1-7 \u76d1\u63a7\u5e76\u4e14\u7406\u89e3\u2f64\u6237\u2f8f\u4e3a","text":"<ul> <li>\u4e0d\u8981\u8fc7\u5ea6\u8c03\u8bd5\u76f8\u5173\u5ea6</li> <li>\u800c\u8981\u76d1\u63a7\u641c\u7d22\u7ed3\u679c\uff0c\u76d1\u63a7\u7528\u6237\u70b9\u51fb\u6700\u9876\u7aef\u7ed3\u679c\u7684\u9891\u6b21</li> <li>\u5c06\u641c\u7d22\u7ed3\u679c\u63d0\u2fbc\u5230\u6781\u2fbc\u6c34\u5e73\uff0c\u552f\u2f00\u9014\u5f84\u5c31\u662f<ul> <li>\u9700\u8981\u5177\u6709\u5ea6\u91cf\u7528\u6237\u2f8f\u4e3a\u7684\u5f3a\u2f24\u80fd\u2f12</li> <li>\u53ef\u4ee5\u5728\u540e\u53f0\u5b9e\u73b0\u7edf\u8ba1\u6570\u636e\uff0c\u2f50\u5982\uff0c\u2f64\u6237\u7684\u67e5\u8be2\u548c\u7ed3\u679c\uff0c\u6709\u591a\u5c11\u88ab\u70b9\u51fb\u4e86</li> <li>\u54ea\u4e9b\u641c\u7d22\uff0c\u6ca1\u6709\u8fd4\u56de\u7ed3\u679c   </li> </ul> </li> </ul>"},{"location":"chap4/7ES_ST_IA/","title":"\u7b2c\u4e03\u8282 \u4f7f\u7528 Search Template \u548c Index Alias","text":""},{"location":"chap4/7ES_ST_IA/#1search-template-dsl","title":"1\u3001Search Template \u2013 \u89e3\u8026\u7a0b\u5e8f &amp; \u641c\u7d22 DSL","text":"<ul> <li>Elasticsearch \u7684\u67e5\u8be2\u8bed\u53e5\u53e5<ul> <li>\u5bf9\u76f8\u5173\u6027\u7b97\u5206 / \u67e5\u8be2\u6027\u80fd\u90fd\u2f84\u5173\u91cd\u8981</li> </ul> </li> <li>\u5728\u5f00\u53d1\u521d\u671f\uff0c\u867d\u7136\u53ef\u4ee5\u660e\u786e\u67e5\u8be2\u53c2\u6570\uff0c\u4f46\u662f\u5f80\u5f80\u8fd8\u4e0d\u80fd\u6700\u7ec8\u5b9a\u4e49\u67e5\u8be2\u7684DSL\u7684\u5177\u4f53\u7ed3\u6784<ul> <li>\u901a\u8fc7<code>Search Template</code> \u5b9a\u4e49\u2f00\u4e2a <code>Contract</code></li> </ul> </li> <li>\u5404\u53f8\u5176\u804c\uff0c\u89e3\u8026<ul> <li>\u5f00\u53d1\u2f08\u5458 / \u641c\u7d22\u2f2f\u7a0b\u5e08 / \u6027\u80fd\u5de5\u7a0b\u5e08</li> </ul> </li> </ul> <p>\u641c\u7d22\u2f2f\u7a0b\u5e08</p> <pre><code>POST _scripts/tmdb\n{\n  \"script\": {\n    \"lang\": \"mustache\",\n    \"source\": {\n      \"_source\": [\n        \"title\",\"overview\"\n      ],\n      \"size\": 20,\n      \"query\": {\n        \"multi_match\": {\n          \"query\": \"{{q}}\",\n          \"fields\": [\"title\",\"overview\"]\n        }\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"chap4/7ES_ST_IA/#1-1-search-template","title":"1-1 \u4f7f\u2f64 Search Template \u8fdb\u884c\u67e5\u8be2","text":"<p>\u6027\u80fd\u5de5\u7a0b\u5e08</p> <pre><code>POST tmdb/_search/template\n{\n    \"id\":\"tmdb\",\n    \"params\": {\n        \"q\": \"basketball with cartoon aliens\"\n    }\n}\n</code></pre> <pre><code>DELETE _scripts/tmdb\n\nGET _scripts/tmdb\n</code></pre>"},{"location":"chap4/7ES_ST_IA/#2index-alias","title":"2\u3001Index Alias \u5b9e\u73b0\u96f6\u505c\u673a\u8fd0\u7ef4","text":""},{"location":"chap4/7ES_ST_IA/#2-1-alias","title":"2-1 \u4f7f\u2f64 Alias \u521b\u5efa\u4e0d\u4e0d\u540c\u67e5\u8be2\u7684\u89c6\u56fe","text":"<pre><code>PUT movies-2019/_doc/1\n{\n  \"name\":\"the matrix\",\n  \"rating\":5\n}\n\nPUT movies-2019/_doc/2\n{\n  \"name\":\"Speed\",\n  \"rating\":3\n}\n</code></pre> <pre><code>POST _aliases\n{\n  \"actions\": [\n    {\n      \"add\": {\n        \"index\": \"movies-2019\",\n        \"alias\": \"movies-latest\"\n      }\n    }\n  ]\n}\n</code></pre> <pre><code>POST movies-latest/_search\n{\n  \"query\": {\n    \"match_all\": {}\n  }\n}\n</code></pre> <p>Ouput:</p> <pre><code>\"max_score\" : 1.0,\n    \"hits\" : [\n      {\n        \"_index\" : \"movies-2019\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"1\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"name\" : \"the matrix\",\n          \"rating\" : 5\n        }\n      },\n      {\n        \"_index\" : \"movies-2019\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"2\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"name\" : \"Speed\",\n          \"rating\" : 3\n        }\n      }\n    ]\n</code></pre>"},{"location":"chap4/7ES_ST_IA/#2-2-alias","title":"2-2 \u4f7f\u2f64 Alias \u521b\u5efa\u4e0d\u540c\u67e5\u8be2\u7684\u89c6\u56fe","text":"<pre><code>POST _aliases\n{\n  \"actions\": [\n    {\n      \"add\": {\n        \"index\": \"movies-2019\",\n        \"alias\": \"movies-lastest-highrate\",\n        \"filter\": {\n          \"range\": {\n            \"rating\": {\n              \"gte\": 4\n            }\n          }\n        }\n      }\n    }\n  ]\n}\n</code></pre> <pre><code>POST movies-lastest-highrate/_search\n{\n  \"query\": {\n    \"match_all\": {}\n  }\n}\n</code></pre> <p>Output</p> <pre><code> \"max_score\" : 1.0,\n    \"hits\" : [\n      {\n        \"_index\" : \"movies-2019\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"1\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"name\" : \"the matrix\",\n          \"rating\" : 5\n        }\n      }\n    ]\n</code></pre>"},{"location":"chap4/7ES_ST_IA/#3","title":"3\u3001\u672c\u8282\u77e5\u8bc6\u70b9\u56de\u987e","text":"<ul> <li>Search Template \u7684\u4f7f\u2f64\u573a\u666f<ul> <li>\u5982\u679c\u901a\u8fc7 Mocha \u8bed\u6cd5\u5b9a\u4e49\u4e00\u4e2a Search Template</li> </ul> </li> <li>Index Alias \u7684\u4f7f\u2f64\u7528\u573a\u666f</li> <li>\u5982\u4f55\u521b\u5efa\u4e0e\u4f7f\u7528 Index Alias</li> <li>\u901a\u8fc7 Index Alias \u521b\u5efa\u4e0d\u540c\u7684\u67e5\u8be2\u89c6\u56fe</li> </ul>"},{"location":"chap4/8ES_FUNC_SCORE/","title":"\u7b2c\u516b\u8282 \u7efc\u5408\u6392\u5e8f:Function Score Query \u4f18\u5316\u7b97\u5206","text":""},{"location":"chap4/8ES_FUNC_SCORE/#1","title":"1\u3001\u7b97\u5206\u4e0e\u6392\u5e8f","text":"<ul> <li>Elasticsearch \u9ed8\u8ba4\u4f1a\u4ee5\u6587\u6863\u7684\u76f8\u5173\u5ea6\u7b97\u5206\u8fdb\u2f8f\u6392\u5e8f </li> <li>\u53ef\u4ee5\u901a\u8fc7\u6307\u5b9a\u2f00\u4e2a\u6216\u8005\u591a\u4e2a\u5b57\u6bb5\u8fdb\u2f8f\u6392\u5e8f</li> <li>\u4f7f\u2f64\u76f8\u5173\u5ea6\u7b97\u5206(score)\u6392\u5e8f\uff0c\u4e0d\u80fd\u6ee1\u8db3\u67d0\u4e9b\u7279\u5b9a\u6761\u4ef6<ul> <li>\u2f46\u6cd5\u9488\u5bf9\u76f8\u5173\u5ea6\uff0c\u5bf9\u6392\u5e8f\u5b9e\u73b0\u66f4\u591a\u7684\u63a7\u5236</li> </ul> </li> </ul>"},{"location":"chap4/8ES_FUNC_SCORE/#2function-score-query","title":"2\u3001Function Score Query","text":""},{"location":"chap4/8ES_FUNC_SCORE/#2-1-function-score-query","title":"2-1 Function Score Query","text":"<ul> <li>\u53ef\u4ee5\u5728\u67e5\u8be2\u7ed3\u675f\u540e\uff0c\u5bf9\u6bcf\u2f00\u4e2a\u5339\u914d\u7684\u2f42\u6587\u6863\u8fdb\u2f8f\u2f00\u7cfb\u5217\u5217\u7684\u91cd\u65b0\u7b97\u5206\uff0c\u6839\u636e\u65b0\u2f63\u6210\u7684\u5206\u6570\u8fdb\u884c\u6392\u5e8f\u3002</li> </ul>"},{"location":"chap4/8ES_FUNC_SCORE/#2-2","title":"2-2 \u63d0\u4f9b\u4e86\u2f0f\u79cd\u9ed8\u8ba4\u7684\u8ba1\u7b97\u5206\u503c\u7684\u51fd\u6570","text":"<ul> <li>Weight :\u4e3a\u6bcf\u2f00\u4e2a\u2f42\u6863\u8bbe\u7f6e\u2f00\u4e2a\u7b80\u5355\u800c\u4e0d\u88ab\u89c4\u8303\u5316\u7684\u6743\u91cd</li> <li>Field Value Factor:\u4f7f\u2f64\u7528\u8be5\u6570\u503c\u6765\u4fee\u6539 <code>_score</code>\uff0c\u4f8b\u4f8b\u5982\u5c06 \u201c\u70ed\u5ea6\u201d\u548c\u201c\u70b9\u8d5e\u6570\u201d\u4f5c\u4e3a\u7b97\u5206\u7684\u53c2\u8003\u56e0\u7d20</li> <li>Random Score:\u4e3a\u6bcf\u2f00\u4e2a\u7528\u6237\u4f7f\u2f64\u2f00\u4e2a\u4e0d\u540c\u7684\uff0c\u968f\u673a\u7b97\u5206\u7ed3\u679c</li> <li>\u8870\u51cf\u51fd\u6570: \u4ee5\u67d0\u4e2a\u5b57\u6bb5\u7684\u503c\u4e3a\u6807\u51c6\uff0c\u8ddd\u79bb\u67d0\u4e2a\u503c\u8d8a\u8fd1\uff0c\u5f97\u5206\u8d8a\u2fbc</li> <li>Script Score:\u81ea\u5b9a\u4e49\u811a\u672c\u5b8c\u5168\u63a7\u5236\u6240\u9700\u903b\u8f91</li> </ul> <pre><code>DELETE blogs\n\nPUT /blogs/_doc/1\n{\n  \"title\":   \"About popularity\",\n  \"content\": \"In this post we will talk about...\",\n  \"votes\":   0\n}\n\nPUT /blogs/_doc/2\n{\n  \"title\":   \"About popularity\",\n  \"content\": \"In this post we will talk about...\",\n  \"votes\":   100\n}\n\nPUT /blogs/_doc/3\n{\n  \"title\":   \"About popularity\",\n  \"content\": \"In this post we will talk about...\",\n  \"votes\":   1000000\n}\n</code></pre>"},{"location":"chap4/8ES_FUNC_SCORE/#3","title":"3\u3001\u6309\u53d7\u6b22\u8fce\u5ea6\u63d0\u5347\u6743\u91cd","text":"<p>\u5e0c\u671b\u80fd\u591f\u5c06\u70b9\u8d5e\u591a\u7684 blog\uff0c\u653e\u5728\u641c\u7d22\u5217\u8868 \u5bf9\u9760\u524d\u7684\u4f4d\u7f6e\u3002\u540c\u65f6\u641c\u7d22\u7684\u8bc4\u5206\uff0c\u8fd8\u662f\u8981\u4f5c\u4e3a\u6392\u5e8f\u7684\u4e3b\u8981\u4f9d\u636e</p> <p>\u65b0\u7684\u7b97\u5206 = \u2f7c\u7684\u7b97\u5206 * \u6295\u7968\u6570</p> <ul> <li>\u6295\u7968\u6570\u4e3a0</li> <li>\u6295\u7968\u6570\u5f88\u5927\u65f6</li> </ul> <p> </p> <pre><code>POST /blogs/_search\n{\n  \"query\": {\n    \"function_score\": {\n      \"query\": {\n        \"multi_match\": {\n          \"query\":    \"popularity\",\n          \"fields\": [ \"title\", \"content\" ]\n        }\n      },\n      \"field_value_factor\": {\n        \"field\": \"votes\"\n      }\n    }\n  }\n}\n</code></pre> <ul> <li>\"<code>multi_match</code>\"</li> <li>\"<code>field_value_factor</code>\"</li> </ul> <p>Output :</p> <pre><code>\"max_score\" : 133531.39,\n    \"hits\" : [\n      {\n        \"_index\" : \"blogs\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"3\",\n        \"_score\" : 133531.39,\n        \"_source\" : {\n          \"title\" : \"About popularity\",\n          \"content\" : \"In this post we will talk about...\",\n          \"votes\" : 1000000\n        }\n      },\n      {\n        \"_index\" : \"blogs\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"2\",\n        \"_score\" : 13.353139,\n        \"_source\" : {\n          \"title\" : \"About popularity\",\n          \"content\" : \"In this post we will talk about...\",\n          \"votes\" : 100\n        }\n      },\n      {\n        \"_index\" : \"blogs\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"1\",\n        \"_score\" : 0.0,\n        \"_source\" : {\n          \"title\" : \"About popularity\",\n          \"content\" : \"In this post we will talk about...\",\n          \"votes\" : 0\n        }\n      }\n    ]\n</code></pre> <ul> <li><code>\"_id\" : \"3\",  \"_score\" : 133531.39,  \"votes\" : 1000000</code></li> <li><code>\"_id\" : \"2\", \"_score\" : 13.353139,  \"votes\" : 100</code></li> <li><code>\"_id\" : \"1\", \"_score\" : 0.0,  \"votes\" : 0</code></li> </ul>"},{"location":"chap4/8ES_FUNC_SCORE/#4-modifier","title":"4\u3001 \u4f7f\u2f64 Modifier \u5e73\u6ed1\u66f2\u7ebf","text":"<ul> <li><code>\u65b0\u7684\u7b97\u5206=\u2f7c\u7684\u7b97\u5206*log(1+\u6295\u7968\u6570)</code></li> </ul> <pre><code>POST /blogs/_search\n{\n  \"query\": {\n    \"function_score\": {\n      \"query\": {\n        \"multi_match\": {\n          \"query\":    \"popularity\",\n          \"fields\": [ \"title\", \"content\" ]\n        }\n      },\n      \"field_value_factor\": {\n        \"field\": \"votes\",\n        \"modifier\": \"log1p\"\n      }\n    }\n  }\n}\n</code></pre> <p>Output :</p> <ul> <li><code>\"_score\" : 0.8011884,</code></li> <li><code>\"_score\" : 0.26763982,</code></li> <li><code>\"_score\" : 0.0,</code></li> </ul>"},{"location":"chap4/8ES_FUNC_SCORE/#5-factor","title":"5\u3001 \u5f15\u2f0a Factor","text":"<ul> <li><code>\u65b0\u7684\u7b97\u5206=\u2f7c\u7684\u7b97\u5206*log(1+factor*\u6295\u7968\u6570)</code></li> </ul> <pre><code>POST /blogs/_search\n{\n  \"query\": {\n    \"function_score\": {\n      \"query\": {\n        \"multi_match\": {\n          \"query\":    \"popularity\",\n          \"fields\": [ \"title\", \"content\" ]\n        }\n      },\n      \"field_value_factor\": {\n        \"field\": \"votes\",\n        \"modifier\": \"log1p\" ,\n        \"factor\": 0.1\n      }\n    }\n  }\n}\n</code></pre> <p>Output :</p> <ul> <li><code>\"_score\" : 0.66765755,</code></li> <li><code>\"_score\" : 0.13905862,</code></li> <li><code>\"_score\" : 0.0,</code></li> </ul> <p> </p>"},{"location":"chap4/8ES_FUNC_SCORE/#6-boost-mode-max-boost","title":"6\u3001 Boost Mode \u548c Max Boost","text":"<ul> <li>Boost Mode<ul> <li>Multiply:\u7b97\u5206\u4e0e\u51fd\u6570\u503c\u7684\u4e58\u79ef</li> <li>Sum:\u7b97\u5206\u4e0e\u51fd\u6570\u7684\u548c</li> <li>Min / Max:\u7b97\u5206\u4e0e\u51fd\u6570\u53d6\u6700\u2f29/ \u6700\u2f24\u503c</li> <li>Replace:\u4f7f\u2f64\u7528\u51fd\u6570\u503c\u53d6\u4ee3\u7b97\u5206</li> </ul> </li> <li>Max Boost \u53ef\u4ee5\u5c06\u7b97\u5206\u63a7\u5236\u5728\u2f00\u4e2a\u6700\u2f24\u503c</li> </ul> <pre><code>POST /blogs/_search\n{\n  \"query\": {\n    \"function_score\": {\n      \"query\": {\n        \"multi_match\": {\n          \"query\":    \"popularity\",\n          \"fields\": [ \"title\", \"content\" ]\n        }\n      },\n      \"field_value_factor\": {\n        \"field\": \"votes\",\n        \"modifier\": \"log1p\" ,\n        \"factor\": 0.1\n      },\n      \"boost_mode\": \"sum\",\n      \"max_boost\": 3\n    }\n  }\n}\n</code></pre> <p>Output :</p>"},{"location":"chap4/8ES_FUNC_SCORE/#6-1-max-boost","title":"6-1 Max Boost \u53ef\u4ee5\u5c06\u7b97\u5206\u63a7\u5236\u5728\u2f00\u4e2a\u6700\u2f24\u503c","text":"<ul> <li><code>\"_score\" : 3.1335313,</code></li> <li><code>\"_score\" : 1.1749241,</code></li> <li><code>\"_score\" : 0.13353139,</code></li> </ul>"},{"location":"chap4/8ES_FUNC_SCORE/#7","title":"7\u3001\u2f00\u81f4\u6027\u968f\u673a\u51fd\u6570","text":"<ul> <li>\u4f7f\u2f64\u7528\u573a\u666f:\u2f79\u7ad9\u7684\u2f34\u544a\u9700\u8981\u63d0\u2fbc\u5c55\u73b0\u7387</li> <li>\u5177\u4f53\u9700\u6c42:\u8ba9\u6bcf\u4e2a\u2f64\u6237\u80fd\u770b\u5230\u4e0d\u540c\u7684\u968f\u673a\u6392\u540d\uff0c\u4f46\u662f\u4e5f\u5e0c\u671b\u540c\u2f00\u4e2a\u2f64\u6237\u8bbf\u95ee\u65f6\uff0c\u7ed3\u679c\u7684\u76f8\u5bf9\u987a\u5e8f\uff0c\u4fdd\u6301\u2f00\u81f4 (Consistently Random)</li> </ul> <pre><code>POST /blogs/_search\n{\n  \"query\": {\n    \"function_score\": {\n      \"random_score\": {\n        \"seed\": 911119\n      }\n    }\n  }\n}\n</code></pre> <p>Output :</p> <p>1 -&gt; 3 -&gt; 2</p> <pre><code>POST /blogs/_search\n{\n  \"query\": {\n    \"function_score\": {\n      \"random_score\": {\n        \"seed\": 888\n      }\n    }\n  }\n}\n</code></pre> <p>Output :</p> <p>2-&gt; 1 -&gt; 3</p>"},{"location":"chap4/8ES_FUNC_SCORE/#8","title":"8\u3001\u672c\u8282\u77e5\u8bc6\u70b9\u56de\u987e","text":"<ul> <li>\u590d\u5408\u67e5\u8be2:Function Score Query<ul> <li>\u63d0\u4f9b\u4e86\u4e86\u591a\u79cd\u51fd\u6570\uff0c\u2f83\u5b9a\u4e49\u811a\u672c\uff0c\u5b8c\u5168\u63a7\u5236\u7b97\u5206</li> </ul> </li> <li>Field Value Factor:\u641c\u7d22\u7684\u76f8\u5173\u5ea6\uff0c\u80fd\u591f\u7ed3\u5408\u6295\u7968\u7684\u6570\u91cf\u8fdb\u2f8f\u91cd\u7b97\u3002\u901a\u8fc7\u2f00\u4e9b\u53c2\u6570\u7684\u8bbe\u5b9a\uff0c\u5bf9\u7b97\u5206\u8fdb\u2f8f\u63a7\u5236</li> <li>\u968f\u673a\u51fd\u6570:\u2f64\u6237\u63d0\u4f9b Seed\uff0c\u8fd4\u56de\u2f00\u4e2a\u968f\u673a\u2f00\u81f4\u6027\u7684\u6392\u5e8f\u7ed3\u679c</li> </ul>"},{"location":"chap4/9ES_suggester/","title":"\u7b2c\u4e5d\u8282 Term &amp; Phrase Suggester","text":""},{"location":"chap4/9ES_suggester/#1","title":"1\u3001\u4ec0\u4e48\u662f\u641c\u7d22\u5efa\u8bae","text":"<ul> <li>\u73b0\u4ee3\u7684\u641c\u7d22\u5f15\u64ce\uff0c\u2f00\u822c\u90fd\u4f1a\u63d0\u4f9b Suggest as you type \u7684\u529f\u80fd</li> <li>\u5e2e\u52a9\u2f64\u6237\u5728\u8f93\u5165\u641c\u7d22\u7684\u8fc7\u7a0b\u4e2d\uff0c\u8fdb\u2f8f\u2f83\u52a8\u8865\u5168\u6216\u8005\u7ea0\u9519\u3002\u901a\u8fc7\u534f\u52a9\u2f64\u6237\u8f93\u5165\u66f4\u52a0\u7cbe\u51c6\u7684\u5173\u952e\u8bcd\uff0c\u63d0\u2fbc\u540e\u7eed\u641c\u7d22\u9636\u6bb5\u2f42\u6863\u5339\u914d\u7684\u7a0b\u5ea6</li> <li>\u5728 google\u4e0a\u641c\u7d22\uff0c\u2f00\u5f00\u59cb\u4f1a\u2f83\u52a8\u8865\u5168\u3002\u5f53\u8f93\u2f0a\u5230\u4e00\u5b9a\u957f\u5ea6\uff0c\u5982\u56e0\u4e3a\u5355\u8bcd\u62fc\u5199\u9519\u8bef\u65e0\u6cd5\u8865\u5168\uff0c \u5c31\u4f1a\u5f00\u59cb\u63d0\u793a\u76f8\u4f3c\u7684\u8bcd\u6216\u8005\u53e5\u5b50</li> </ul>"},{"location":"chap4/9ES_suggester/#2elasticsearch-suggester-api","title":"2\u3001Elasticsearch Suggester API","text":"<ul> <li>\u641c\u7d22\u5f15\u64ce\u4e2d\u7c7b\u4f3c\u7684\u529f\u80fd\uff0c\u5728 Elasticsearch \u4e2d\u662f\u901a\u8fc7 Suggester API \u5b9e\u73b0\u7684</li> <li>\u539f\u7406: \u5c06\u8f93\u5165\u7684\u2f42\u672c\u5206\u89e3\u4e3a Token\uff0c\u7136\u540e\u5728\u7d22\u5f15\u7684\u5b57\u5178\u2fa5\u67e5\u627e\u76f8\u4f3c\u7684 Term \u5e76\u8fd4\u56de</li> <li>\u6839\u636e\u4e0d\u540c\u7684\u4f7f\u2f64\u7528\u573a\u666f\uff0cElasticsearch \u8bbe\u8ba1\u4e86\u4e86 4 \u79cd\u7c7b\u522b\u7684 Suggesters<ul> <li>Term &amp; Phrase Suggester</li> <li>Complete &amp; Context Suggester</li> </ul> </li> </ul>"},{"location":"chap4/9ES_suggester/#3term-suggester","title":"3\u3001Term Suggester","text":"<ul> <li>Suggester \u5c31\u662f\u4e00\u79cd\u7279\u6b8a\u7c7b\u578b\u7684\u641c\u7d22\u3002\u201dtext\u201d \u2fa5\u662f\u8c03\u2f64\u65f6\u5019\u63d0\u4f9b\u7684\u2f42\u672c\uff0c\u901a\u5e38\u6765\u2f83\u4e8e\u2f64\u6237\u754c\u9762\u4e0a\u2f64\u7528\u6237\u8f93\u2f0a\u7684\u5185\u5bb9</li> <li>\u2f64\u6237\u8f93\u2f0a\u7684 <code>\u201clucen\u201d</code> \u662f\u2f00\u4e2a\u9519\u8bef\u7684\u62fc\u5199</li> <li>\u4f1a\u5230\u6307\u5b9a\u7684\u5b57\u6bb5<code>\u201cbody\u201d</code> \u4e0a\u641c\u7d22\uff0c\u5f53\u2f46\u65e0\u6cd5\u641c\u7d22\u5230\u7ed3\u679c\u65f6 (<code>missing</code>)\uff0c\u8fd4\u56de\u5efa\u8bae\u7684\u8bcd</li> </ul> <p>\u81ea\u52a8\u8865\u5168\u4e0e\u57fa\u4e8e\u4e0a\u4e0b\u6587\u7684\u63d0\u793a</p>"},{"location":"chap4/9ES_suggester/#3-1","title":"3-1 \u4e00\u4e9b\u6d4b\u8bd5\u6570\u636e","text":"<pre><code>DELETE articles\nPUT articles\n{\n  \"mappings\": {\n    \"properties\": {\n      \"title_completion\":{\n        \"type\": \"completion\"\n      }\n    }\n  }\n}\n\n\nPOST articles/_bulk\n{ \"index\" : { } }\n{ \"title_completion\": \"lucene is very cool\"}\n{ \"index\" : { } }\n{ \"title_completion\": \"Elasticsearch builds on top of lucene\"}\n{ \"index\" : { } }\n{ \"title_completion\": \"Elasticsearch rocks\"}\n{ \"index\" : { } }\n{ \"title_completion\": \"elastic is the company behind ELK stack\"}\n{ \"index\" : { } }\n{ \"title_completion\": \"Elk stack rocks\"}\n{ \"index\" : {} }\n</code></pre> <p>\u9ed8\u8ba4\u4f7f\u2f64\u7528 standard \u5206\u8bcd\u5668\u5668 </p> <ul> <li>\u5927\u5199\u8f6c\u2f29\u5199</li> <li>rocks \u548c rock \u662f\u4e24\u4e2a\u8bcd</li> </ul> <pre><code>POST articles/_search?pretty\n{\n  \"size\": 0,\n  \"suggest\": {\n    \"article-suggester\": {\n      \"prefix\": \"elk \",\n      \"completion\": {\n        \"field\": \"title_completion\"\n      }\n    }\n  }\n}\n</code></pre> <p>Output :</p> <pre><code>\"suggest\" : {\n    \"article-suggester\" : [\n      {\n        \"text\" : \"elk \",\n        \"offset\" : 0,\n        \"length\" : 4,\n        \"options\" : [\n          {\n            \"text\" : \"Elk stack rocks\",\n            \"_index\" : \"articles\",\n            \"_type\" : \"_doc\",\n            \"_id\" : \"5f0KR3UBjbV1yvhlSMnd\",\n            \"_score\" : 1.0,\n            \"_source\" : {\n              \"title_completion\" : \"Elk stack rocks\"\n            }\n          },\n          {\n            \"text\" : \"Elk stack rocks\",\n            \"_index\" : \"articles\",\n            \"_type\" : \"_doc\",\n            \"_id\" : \"6v0MR3UBjbV1yvhlR8mF\",\n            \"_score\" : 1.0,\n            \"_source\" : {\n              \"title_completion\" : \"Elk stack rocks\"\n            }\n          }\n        ]\n</code></pre>"},{"location":"chap4/9ES_suggester/#3-2-suggester-missing-mode","title":"3-2 Suggester \u2013 Missing Mode","text":"<ul> <li>\u641c\u7d22 \u201clucen rock\u201d:</li> </ul> <p>\u6bcf\u4e2a\u5efa\u8bae\u90fd\u5305\u542b\u4e86\u2f00\u4e2a\u7b97\u5206\uff0c\u76f8\u4f3c\u6027\u662f\u901a\u8fc7 <code>Levenshtein Edit Distance</code> \u7684\u7b97\u6cd5\u5b9e\u73b0\u7684\u3002</p> <p>\u6838\u2f3c\u601d\u60f3\u5c31\u662f\u2f00\u4e2a\u8bcd\u6539\u52a8 \u591a\u5c11\u5b57\u7b26\u5c31\u53ef\u4ee5\u548c\u53e6\u5916\u2f00\u4e2a\u8bcd\u2f00\u81f4\u3002 \u63d0\u4f9b\u4e86\u4e86\u5f88\u591a\u53ef\u9009\u53c2\u6570\u6765\u63a7\u5236\u76f8\u4f3c\u6027\u7684\u6a21\u7cca\u7a0b\u5ea6\u3002\u4f8b\u4f8b\u5982 \u201cmax_edits\u201d</p> <ul> <li>\u51e0\u79cd Suggestion Mode<ul> <li>Missing \u2013 \u5982\u7d22\u5f15\u4e2d\u5df2\u7ecf\u5b58\u5728\uff0c\u5c31\u4e0d\u63d0\u4f9b\u5efa\u8bae</li> <li>Popular \u2013 \u63a8\u8350\u51fa\u73b0\u9891\u7387\u66f4\u52a0\u2fbc\u7684\u8bcd</li> <li>Always \u2013 \u2f46\u8bba\u662f\u5426\u5b58\u5728\uff0c\u90fd\u63d0\u4f9b\u5efa\u8bae</li> </ul> </li> </ul> <p> </p> <pre><code>DELETE articles\n\nPOST articles/_bulk\n{ \"index\" : { } }\n{ \"body\": \"lucene is very cool\"}\n{ \"index\" : { } }\n{ \"body\": \"Elasticsearch builds on top of lucene\"}\n{ \"index\" : { } }\n{ \"body\": \"Elasticsearch rocks\"}\n{ \"index\" : { } }\n{ \"body\": \"elastic is the company behind ELK stack\"}\n{ \"index\" : { } }\n{ \"body\": \"Elk stack rocks\"}\n{ \"index\" : {} }\n{  \"body\": \"elasticsearch is rock solid\"}\n\n\nPOST _analyze\n{\n  \"analyzer\": \"standard\",\n  \"text\": [\"Elk stack  rocks rock\"]\n}\n</code></pre> <p>Output</p> <pre><code>{\n  \"tokens\" : [\n    {\n      \"token\" : \"elk\",\n      \"start_offset\" : 0,\n      \"end_offset\" : 3,\n      \"type\" : \"&lt;ALPHANUM&gt;\",\n      \"position\" : 0\n    },\n    {\n      \"token\" : \"stack\",\n      \"start_offset\" : 4,\n      \"end_offset\" : 9,\n      \"type\" : \"&lt;ALPHANUM&gt;\",\n      \"position\" : 1\n    },\n    {\n      \"token\" : \"rocks\",\n      \"start_offset\" : 11,\n      \"end_offset\" : 16,\n      \"type\" : \"&lt;ALPHANUM&gt;\",\n      \"position\" : 2\n    },\n    {\n      \"token\" : \"rock\",\n      \"start_offset\" : 17,\n      \"end_offset\" : 21,\n      \"type\" : \"&lt;ALPHANUM&gt;\",\n      \"position\" : 3\n    }\n  ]\n}\n</code></pre>"},{"location":"chap4/9ES_suggester/#3-3-term-suggester-popular-mode","title":"3-3 Term Suggester \u2013 Popular Mode","text":"<p>Popular \u2013 \u63a8\u8350\u51fa\u73b0\u9891\u7387\u66f4\u52a0\u2fbc\u7684\u8bcd</p> <pre><code>POST /articles/_search\n{\n\n  \"suggest\": {\n    \"term-suggestion\": {\n      \"text\": \"lucen rock\",\n      \"term\": {\n        \"suggest_mode\": \"popular\",\n        \"field\": \"body\"\n      }\n    }\n  }\n}\n</code></pre> <ul> <li><code>\"suggest_mode\": \"popular\",</code></li> </ul> <pre><code>\"suggest\" : {\n    \"term-suggestion\" : [\n      {\n        \"text\" : \"lucen\",\n        \"offset\" : 0,\n        \"length\" : 5,\n        \"options\" : [\n          {\n            \"text\" : \"lucene\",\n            \"score\" : 0.8,\n            \"freq\" : 2\n          }\n        ]\n      },\n      {\n        \"text\" : \"rock\",\n        \"offset\" : 6,\n        \"length\" : 4,\n        \"options\" : [\n          {\n            \"text\" : \"rocks\",\n            \"score\" : 0.75,\n            \"freq\" : 2\n          }\n        ]\n      }\n    ]\n</code></pre> <ul> <li><code>\"text\" : \"lucene\",   \"score\" : 0.8,</code></li> <li><code>\"text\" : \"rocks\", \"score\" : 0.75,</code></li> </ul>"},{"location":"chap4/9ES_suggester/#3-4-term-suggester-missing-mode","title":"3-4 Term Suggester \u2013 Missing Mode","text":"<p>Missing \u2013 \u5982\u7d22\u5f15\u4e2d\u5df2\u7ecf\u5b58\u5728\uff0c\u5c31\u4e0d\u63d0\u4f9b\u5efa\u8bae</p> <pre><code>POST /articles/_search\n{\n  \"size\": 1,\n  \"query\": {\n    \"match\": {\n      \"body\": \"lucen rock\"\n    }\n  },\n  \"suggest\": {\n    \"term-suggestion\": {\n      \"text\": \"lucen rock\",\n      \"term\": {\n        \"suggest_mode\": \"missing\",\n        \"field\": \"body\"\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"chap4/9ES_suggester/#3-5-term-suggester-always-mode","title":"3-5 Term Suggester \u2013 Always Mode","text":"<p>always \u2013 \u2f46\u8bba\u662f\u5426\u5b58\u5728\uff0c\u90fd\u63d0\u4f9b\u5efa\u8bae</p> <pre><code>POST /articles/_search\n{\n  \"suggest\": {\n    \"term-suggestion\": {\n      \"text\": \"lucen rock\",\n      \"term\": {\n        \"suggest_mode\": \"always\",\n        \"field\": \"body\"\n      }\n    }\n  }\n}\n</code></pre> <ul> <li><code>\"text\" : \"lucene\",   \"score\" : 0.8,</code></li> <li><code>\"text\" : \"rocks\", \"score\" : 0.75,</code></li> </ul>"},{"location":"chap4/9ES_suggester/#3-6-sorting-by-frequency-prefix-length","title":"3-6 Sorting by Frequency &amp; Prefix Length","text":"<ul> <li>\u9ed8\u8ba4\u6309\u7167 score \u6392\u5e8f\uff0c\u4e5f\u53ef\u4ee5\u6309\u7167 \u201cfrequency\u201d</li> <li>\u9ed8\u8ba4\u2fb8\u9996\u5b57\u2e9f\u4e0d\u2f00\u81f4\u5c31\u4e0d\u4f1a\u5339\u914d\u63a8\u8350\uff0c\u4f46\u662f\u5982\u679c\u5c06 <code>prefix_length</code> \u8bbe\u7f6e\u4e3a <code>0</code>\uff0c\u5c31\u4f1a\u4e3a <code>hock</code> \u5efa\u8bae <code>rock</code></li> </ul> <pre><code>POST /articles/_search\n{\n\n  \"suggest\": {\n    \"term-suggestion\": {\n      \"text\": \"lucen hocks\",\n      \"term\": {\n        \"suggest_mode\": \"always\",\n        \"field\": \"body\",\n        \"prefix_length\":0,\n        \"sort\": \"frequency\"\n      }\n    }\n  }\n}\n</code></pre> <p>Output</p> <pre><code> \"suggest\" : {\n    \"term-suggestion\" : [\n      {\n        \"text\" : \"lucen\",\n        \"offset\" : 0,\n        \"length\" : 5,\n        \"options\" : [\n          {\n            \"text\" : \"lucene\",\n            \"score\" : 0.8,\n            \"freq\" : 2\n          }\n        ]\n      },\n      {\n        \"text\" : \"hocks\",\n        \"offset\" : 6,\n        \"length\" : 5,\n        \"options\" : [\n          {\n            \"text\" : \"rocks\",\n            \"score\" : 0.8,\n            \"freq\" : 2\n          }\n        ]\n      }\n    ]\n</code></pre>"},{"location":"chap4/9ES_suggester/#4phrase-suggester","title":"4\u3001Phrase Suggester","text":"<ul> <li> <p><code>Phrase Suggester</code> \u5728 <code>Term Suggester</code> \u4e0a\u589e\u52a0\u4e86\u4e00\u4e9b\u989d\u5916\u7684\u903b\u8f91</p> </li> <li> <p>\u4e00\u4e9b\u53c2\u6570</p> <ul> <li>Suggest Mode :missing, popular, always</li> <li>Max Errors:\u6700\u591a\u53ef\u4ee5\u62fc\u9519\u7684 Terms \u6570</li> <li>Confidence:\u9650\u5236\u8fd4\u56de\u7ed3\u679c\u6570\uff0c\u9ed8\u8ba4\u4e3a 1</li> </ul> </li> </ul> <pre><code>POST /articles/_search\n{\n  \"suggest\": {\n    \"my-suggestion\": {\n      \"text\": \"lucne and elasticsear rock hello world \",\n      \"phrase\": {\n        \"field\": \"body\",\n        \"max_errors\":2,\n        \"confidence\":0,\n        \"direct_generator\":[{\n          \"field\":\"body\",\n          \"suggest_mode\":\"always\"\n        }],\n        \"highlight\": {\n          \"pre_tag\": \"&lt;em&gt;\",\n          \"post_tag\": \"&lt;/em&gt;\"\n        }\n      }\n    }\n  }\n}\n</code></pre> <ul> <li><code>phrase</code></li> <li><code>\"max_errors\":2,</code></li> <li><code>\"confidence\":0,</code></li> </ul> <p>Output</p> <pre><code>suggest\" : {\n    \"my-suggestion\" : [\n      {\n        \"text\" : \"lucne and elasticsear rock hello world \",\n        \"offset\" : 0,\n        \"length\" : 39,\n        \"options\" : [\n          {\n            \"text\" : \"lucene and elasticsearch rock hello world\",\n            \"highlighted\" : \"&lt;em&gt;lucene&lt;/em&gt; and &lt;em&gt;elasticsearch&lt;/em&gt; rock hello world\",\n            \"score\" : 1.5788074E-4\n          },\n          {\n            \"text\" : \"lucne and elasticsearch rocks hello world\",\n            \"highlighted\" : \"lucne and &lt;em&gt;elasticsearch rocks&lt;/em&gt; hello world\",\n            \"score\" : 1.136111E-4\n          },\n          {\n            \"text\" : \"lucne and elasticsearch rock hello world\",\n            \"highlighted\" : \"lucne and &lt;em&gt;elasticsearch&lt;/em&gt; rock hello world\",\n            \"score\" : 1.05567684E-4\n          },\n          {\n            \"text\" : \"lucene and elasticsear rocks hello world\",\n            \"highlighted\" : \"&lt;em&gt;lucene&lt;/em&gt; and elasticsear &lt;em&gt;rocks&lt;/em&gt; hello world\",\n            \"score\" : 9.929376E-5\n          },\n          {\n            \"text\" : \"lucene and elasticsear rock hello world\",\n            \"highlighted\" : \"&lt;em&gt;lucene&lt;/em&gt; and elasticsear rock hello world\",\n            \"score\" : 9.2263974E-5\n          }\n        ]\n      }\n    ]\n</code></pre>"},{"location":"chap4/9ES_suggester/#5","title":"5\u3001\u672c\u8282\u77e5\u8bc6\u70b9\u56de\u987e","text":"<ul> <li>Term Suggester \u548c Phrase Suggester \u5206\u522b\u6709\u4e09\u79cd\u4e0d\u4e0d\u540c\u7c7b\u578b\u7684 Suggestion Mode<ul> <li>Missing / Popular / Always</li> <li>\u901a\u8fc7\u4f7f\u2f64 Suggestion Phrase \u53ef\u4ee5\u63d0\u2fbc\u641c\u7d22\u7684 Precision \u548c Recall</li> </ul> </li> </ul>"},{"location":"chap5/1ES_cluster/","title":"\u7b2c\u4e00\u8282 \u96c6\u7fa4\u5206\u5e03\u5f0f\u6a21\u578b\u53ca\u9009\u4e3b\u4e0e\u8111\u88c2\u95ee\u9898","text":""},{"location":"chap5/1ES_cluster/#1","title":"1\u3001\u5206\u5e03\u5f0f\u7279\u6027","text":"<ul> <li>Elasticsearch \u7684\u5206\u5e03\u5f0f\u67b6\u6784\u5e26\u6765\u7684\u597d\u5904<ul> <li>\u5b58\u50a8\u7684\u6c34\u5e73\u6269\u5bb9\uff0c\u2f40\u6301 PB \u7ea7\u6570\u636e</li> <li>\u63d0\u2fbc\u7cfb\u7edf\u7684\u53ef\u2f64\u6027\uff0c\u90e8\u5206\u8282\u70b9\u505c\u6b62\u670d\u52a1\uff0c\u6574\u4e2a\u96c6\u7fa4\u7684\u670d\u52a1\u4e0d\u53d7\u5f71\u54cd</li> </ul> </li> <li>Elasticsearch \u7684\u5206\u5e03\u5f0f\u67b6\u6784<ul> <li>\u4e0d\u540c\u7684\u96c6\u7fa4\u901a\u8fc7\u4e0d\u540c\u7684\u540d\u5b57\u6765\u533a\u5206\uff0c\u9ed8\u8ba4\u540d\u5b57 <code>\u201celasticsearch\u201d</code></li> <li>\u901a\u8fc7\u914d\u7f6e\u2f42\u4ef6\u4fee\u6539\uff0c\u6216\u8005\u5728\u547d\u4ee4\u884c\u4e2d <code>-E cluster.name=jx</code> \u8fdb\u2f8f\u884c\u884c\u8bbe\u5b9a</li> </ul> </li> </ul> <pre><code>bin/elasticsearch -E node.name=node1 -E cluster.name=jx -E path.data=node1_data\nbin/elasticsearch -E node.name=node2 -E cluster.name=jx -E path.data=node2_data\nbin/elasticsearch -E node.name=node3 -E cluster.name=jx -E path.data=node3_data\n</code></pre>"},{"location":"chap5/1ES_cluster/#2","title":"2\u3001\u8282\u70b9","text":"<ul> <li>\u8282\u70b9\u662f\u2f00\u4e2a Elasticsearch \u7684\u5b9e\u4f8b<ul> <li>\u5176\u672c\u8d28\u4e0a\u5c31\u662f\u2f00\u4e2a JAVA \u8fdb\u7a0b</li> <li>\u2f00\u53f0\u673a\u5668\u5668\u4e0a\u53ef\u4ee5\u8fd0\u2f8f\u591a\u4e2a Elasticsearch \u8fdb\u7a0b\uff0c\u4f46\u662f\u2f63\u4ea7\u73af\u5883\u2f00\u822c\u5efa\u8bae\u2f00\u53f0\u673a\u5668\u5668\u4e0a\u5c31\u8fd0\u2f8f\u2f00\u4e2a Elasticsearch \u5b9e\u4f8b</li> </ul> </li> <li>\u6bcf\u2f00\u4e2a\u8282\u70b9\u90fd\u6709\u540d\u5b57\uff0c\u901a\u8fc7\u914d\u7f6e\u6587\u4ef6\u914d\u7f6e\uff0c\u6216\u8005\u542f\u52a8\u65f6\u5019 <code>-E node.name=jx</code> \u6307\u5b9a</li> <li>\u6bcf\u2f00\u4e2a\u8282\u70b9\u5728\u542f\u52a8\u4e4b\u540e\uff0c\u4f1a\u5206\u914d\u2f00\u4e2a UID\uff0c\u4fdd\u5b58\u5728 data \u2f6c\u5f55\u4e0b</li> </ul>"},{"location":"chap5/1ES_cluster/#3coordinating-node","title":"3\u3001Coordinating Node","text":"<ul> <li>\u5904\u7406\u8bf7\u6c42\u7684\u8282\u70b9\uff0c\u53eb <code>Coordinating Node</code><ul> <li>\u8def\u7531\u8bf7\u6c42\u5230\u6b63\u786e\u7684\u8282\u70b9\uff0c\u4f8b\u5982\u521b\u5efa\u7d22\u5f15\u7684\u8bf7\u6c42\uff0c\u9700\u8981\u8def\u8def\u7531\u5230 Master\u8282\u70b9</li> </ul> </li> <li>\u6240\u6709\u8282\u70b9\u9ed8\u8ba4\u90fd\u662f Coordinating Node</li> <li>\u901a\u8fc7\u5c06\u5176\u4ed6\u7c7b\u578b\u8bbe\u7f6e\u6210 False\uff0c\u4f7f\u5176\u6210\u4e3a Dedicated Coordinating Node</li> </ul>"},{"location":"chap5/1ES_cluster/#3-1-demo-cerebro","title":"3-1 Demo \u2013 \u542f\u52a8\u8282\u70b9\uff0cCerebro \u4ecb\u7ecd","text":"<ul> <li>\u542f\u52a8\u2f00\u4e2a\u8282\u70b9\u7684</li> </ul> <pre><code>bin/elasticsearch -E node.name=node1 -E cluster.name=jx -E path.data=node1_data -E http.port=9200\n</code></pre> <p>https://github.com/lmenezes/cerebro/releases</p> <ul> <li>Overview /Filter by node / index</li> <li>Nodes</li> <li>REST / More</li> <li>Health Status</li> </ul> <p>Demo - \u521b\u5efa\u2f00\u4e2a\u65b0\u7684\u7d22\u5f15</p> <p>\u53d1\u9001\u521b\u5efa\u7d22\u5f15\u7684\u8bf7\u6c42</p> <ul> <li>Settings 3 Primary \u548c 1 \u4e2a Replica</li> <li>\u8bf7\u6c42\u53ef\u4ee5\u53d1\u9001\u5230\u4efb\u4f55\u7684\u8282\u70b9\uff0c\u5904\u7406\u7406\u4f60\u8bf7\u6c42\u7684\u8282\u70b9\uff0c\u53eb\u505a Coordinating Node</li> <li>\u521b\u5efa / \u5220\u9664\u7d22\u5f15\u7684\u8bf7\u6c42\uff0c\u53ea\u80fd\u88ab Master \u8282\u70b9\u5904\u7406</li> </ul>"},{"location":"chap5/1ES_cluster/#4data-node","title":"4\u3001Data Node","text":"<ul> <li>\u53ef\u4ee5\u4fdd\u5b58\u6570\u636e\u7684\u8282\u70b9\uff0c\u53eb\u505a Data Node<ul> <li>\u8282\u70b9\u542f\u52a8\u540e\uff0c\u9ed8\u8ba4\u5c31\u662f\u6570\u636e\u8282\u70b9\u3002\u53ef\u4ee5\u8bbe\u7f6e <code>node.data: false</code> \u7981\u2f4c</li> </ul> </li> <li>Data Node\u7684\u804c\u8d23<ul> <li>\u4fdd\u5b58\u5206\u2f5a\u6570\u636e\u3002\u5728\u6570\u636e\u6269\u5c55\u4e0a\u8d77\u5230\u4e86\u2f84\u5173\u91cd\u8981\u7684\u4f5c\u7528(\u7531 <code>Master Node</code> \u51b3\u5b9a\u5982\u4f55\u628a\u5206\u2f5a\u5206\u53d1\u5230\u6570\u636e\u8282\u70b9\u4e0a)</li> </ul> </li> <li>\u901a\u8fc7\u589e\u52a0\u6570\u636e\u8282\u70b9<ul> <li>\u53ef\u4ee5\u89e3\u51b3\u6570\u636e\u2f54\u6c34\u5e73\u6269\u5c55\u548c\u89e3\u51b3\u6570\u636e\u5355\u70b9\u95ee\u9898</li> </ul> </li> </ul>"},{"location":"chap5/1ES_cluster/#5master-node","title":"5\u3001Master Node","text":"<p>5-1 Master Node \u7684\u804c\u8d23</p> <ul> <li>\u5904\u7406\u521b\u5efa\uff0c\u5220\u9664\u7d22\u5f15\u7b49\u8bf7\u6c42 /\u51b3\u5b9a\u5206\u2f5a\u88ab\u5206\u914d\u5230\u54ea\u4e2a\u8282\u70b9 / \u8d1f\u8d23\u7d22\u5f15\u7684\u521b\u5efa\u4e0e\u5220\u9664</li> <li>\u7ef4\u62a4\u5e76\u4e14\u66f4\u65b0 Cluster State</li> </ul> <p>5-2 Master Node \u7684\u6700\u4f73\u5b9e\u8df5</p> <ul> <li>Master \u8282\u70b9\u2fae\u5e38\u91cd\u8981\uff0c\u5728\u90e8\u7f72\u4e0a\u9700\u8981\u8003\u8651\u89e3\u51b3\u5355\u70b9\u7684\u95ee\u9898</li> <li>\u4e3a\u2f00\u4e2a\u96c6\u7fa4\u8bbe\u7f6e\u591a\u4e2a Master \u8282\u70b9 / \u6bcf\u4e2a\u8282\u70b9\u53ea\u627f\u62c5 Master \u7684\u5355\u2f00\u2ec6\u2f8a</li> </ul>"},{"location":"chap5/1ES_cluster/#6master-eligible-nodes","title":"6\u3001Master Eligible Nodes &amp; \u9009\u4e3b\u6d41\u7a0b","text":"<ul> <li>\u4e00\u4e2a\u96c6\u7fa4\uff0c\u2f40\u6301\u914d\u7f6e\u591a\u4e2a <code>Master Eligible</code> \u8282\u70b9\u3002\u8fd9\u4e9b\u8282\u70b9\u53ef\u4ee5\u5728\u5fc5\u8981\u65f6(\u5982 <code>Master</code>\u8282\u70b9\u51fa\u73b0\u6545\u969c\uff0c\u2f79\u7edc\u6545\u969c\u65f6)\u53c2\u4e0e\u9009\u4e3b\u6d41\u7a0b\uff0c\u6210\u4e3a <code>Master</code> \u8282\u70b9</li> <li>\u6bcf\u4e2a\u8282\u70b9\u542f\u52a8\u540e\uff0c\u9ed8\u8ba4\u5c31\u662f\u2f00\u4e2a <code>Master eligible</code> \u8282\u70b9<ul> <li>\u53ef\u4ee5\u8bbe\u7f6e <code>node.master: false</code> \u7981\u2f4c</li> </ul> </li> <li>\u5f53\u96c6\u7fa4\u5185\u7b2c\u2f00\u4e2a <code>Master eligible</code>  \u8282\u70b9\u542f\u52a8\u65f6\u5019\uff0c\u5b83\u4f1a\u5c06\u2f83\u5df1\u9009\u4e3e\u6210 <code>Master</code>\u8282\u70b9</li> </ul>"},{"location":"chap5/1ES_cluster/#7","title":"7\u3001\u96c6\u7fa4\u72b6\u6001","text":"<ul> <li>\u96c6\u7fa4\u72b6\u6001\u4fe1\u606f(Cluster State)\uff0c\u7ef4\u62a4\u4e86\u2f00\u4e2a\u96c6\u7fa4\u4e2d\uff0c\u5fc5\u8981\u7684\u4fe1\u606f<ul> <li>\u6240\u6709\u7684\u8282\u70b9\u4fe1\u606f</li> <li>\u6240\u6709\u7684\u7d22\u5f15\u548c\u5176\u76f8\u5173\u7684 Mapping \u4e0e Setting \u4fe1\u606f</li> <li>\u5206\u7247\u7684\u8def\u7531\u4fe1\u606f</li> </ul> </li> <li>\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u90fd\u4fdd\u5b58\u4e86\u96c6\u7fa4\u7684\u72b6\u6001\u4fe1\u606f</li> <li>\u4f46\u662f\uff0c\u53ea\u6709 Master \u8282\u70b9\u624d\u80fd\u4fee\u6539\u96c6\u7fa4\u7684\u72b6\u6001\u4fe1\u606f\uff0c\u5e76\u8d1f\u8d23\u540c\u6b65\u7ed9\u5176\u4ed6\u8282\u70b9<ul> <li>\u56e0\u4e3a\uff0c\u4efb\u610f\u8282\u70b9\u90fd\u80fd\u4fee\u6539\u4fe1\u606f\u4f1a\u5bfc\u81f4<code>Cluster State</code> \u4fe1\u606f\u7684\u4e0d\u4e00\u81f4</li> </ul> </li> </ul>"},{"location":"chap5/1ES_cluster/#7-1-demo","title":"7-1 Demo \u2013 \u589e\u52a0\u2f00\u4e2a\u65b0\u7684\u8282\u70b9","text":"<ul> <li><code>bin/elasticsearch -E node.name=node2 -E cluster.name=jx -E path.data=node2_data -E http.port=9201</code></li> <li>Nodes API \u770b\u5230\u65b0\u589e\u8282\u70b9</li> <li>\u53d1\u73b0 Replica \u88ab\u5206\u914d</li> </ul>"},{"location":"chap5/1ES_cluster/#8master-eligible-nodes","title":"8\u3001Master Eligible Nodes &amp; \u9009\u4e3b\u7684\u8fc7\u7a0b","text":"<ul> <li>\u4e92\u76f8 Ping \u5bf9\u65b9\uff0cNode Id \u4f4e\u7684\u4f1a\u6210\u4e3a\u88ab\u9009\u4e3e\u7684\u8282\u70b9</li> <li>\u5176\u4ed6\u8282\u70b9\u4f1a\u52a0\u2f0a\u96c6\u7fa4\uff0c\u4f46\u662f\u4e0d\u627f\u62c5 Master \u8282\u70b9\u7684\u2ec6\u8272\u3002\u2f00\u65e6\u53d1\u73b0\u88ab\u9009\u4e2d\u7684\u4e3b\u8282\u70b9\u4e22\u5931\uff0c \u5c31\u4f1a\u9009\u4e3e\u51fa\u65b0\u7684 Master \u8282\u70b9</li> </ul>"},{"location":"chap5/1ES_cluster/#9","title":"9\u3001\u8111\u88c2\u95ee\u9898","text":"<ul> <li><code>Split-Brain</code>\uff0c\u5206\u5e03\u5f0f\u7cfb\u7edf\u7684\u7ecf\u5178\u2f79\u7edc\u95ee\u9898\uff0c\u5f53\u51fa\u73b0\u7f51\u7edc\u95ee\u9898\uff0c\u2f00\u4e2a\u8282\u70b9\u548c\u5176\u4ed6\u8282\u70b9\u2f46\u6cd5\u8fde\u63a5<ul> <li>Node 2 \u548c Node 3 \u4f1a\u91cd\u65b0\u9009\u4e3e Master</li> <li>Node 1 \u2f83\u2f30\u8fd8\u662f\u4f5c\u4e3a Master\uff0c\u7ec4\u6210\u2f00\u4e2a\u96c6\u7fa4\uff0c\u540c\u65f6\u66f4\u65b0 Cluster State</li> <li>\u5bfc\u81f4 2 \u4e2a master\uff0c\u7ef4\u62a4\u4e0d\u540c\u7684 cluster state\u3002\u5f53\u2f79\u7edc\u6062\u590d\u65f6\uff0c\u2f46\u6cd5\u9009\u62e9\u6b63\u786e\u6062\u590d</li> </ul> </li> </ul>"},{"location":"chap5/1ES_cluster/#10","title":"10\u3001\u5982\u4f55\u907f\u514d\u8111\u88c2\u95ee\u9898","text":"<ul> <li> <p>\u9650\u5b9a\u2f00\u4e2a\u9009\u4e3e\u6761\u4ef6\uff0c\u8bbe\u7f6e quorum(\u4ef2\u88c1)\uff0c\u53ea\u6709\u5728 Master eligible \u8282\u70b9\u6570\u2f24\u4e8e quorum \u65f6\uff0c\u624d\u80fd\u8fdb\u2f8f\u9009\u4e3e</p> <ul> <li><code>Quorum = (master \u8282\u70b9\u603b\u6570 /2) + 1</code></li> <li>\u5f53 <code>3</code> \u4e2a <code>master eligible</code>\u65f6\uff0c\u8bbe\u7f6e <code>discovery.zen.minimum_master_nodes</code> \u4e3a <code>2</code>\uff0c\u5373\u53ef\u907f\u514d\u8111\u88c2</li> </ul> </li> <li> <p>\u4ece 7.0 \u5f00\u59cb\uff0c\u2f46\u9700\u8fd9\u4e2a\u914d\u7f6e</p> <ul> <li>\u79fb\u9664 <code>minimum_master_nodes</code> \u53c2\u6570\uff0c\u8ba9<code>Elasticsearch</code>\u2f83\u5df1\u9009\u62e9\u53ef\u4ee5\u5f62\u6210\u4ef2\u88c1\u7684\u8282\u70b9\u3002</li> <li>\u5178\u578b\u7684\u4e3b\u8282\u70b9\u9009\u4e3e\u73b0\u5728\u53ea\u9700\u8981\u5f88\u77ed\u7684\u65f6\u95f4\u5c31\u53ef\u4ee5\u5b8c\u6210\u3002\u96c6\u7fa4\u7684\u4f38\u7f29\u53d8\u5f97\u66f4\u5b89\u5168\u3001\u66f4\u5bb9\u6613\uff0c\u5e76\u4e14\u53ef\u80fd\u9020\u6210\u4e22\u5931\u6570\u636e\u7684\u7cfb\u7edf\u914d\u7f6e\u9009\u9879\u66f4\u5c11\u4e86</li> <li>\u8282\u70b9\u66f4\u6e05\u695a\u5730\u8bb0\u5f55\u5b83\u4eec\u7684\u72b6\u6001\uff0c\u6709\u52a9\u4e8e\u8bca\u65ad\u4e3a\u4ec0\u4e48\u5b83\u4eec\u4e0d\u80fd\u52a0\u2f0a\u96c6\u7fa4\u6216\u4e3a\u4ec0\u4e48\u2f46\u6cd5\u9009\u4e3e\u51fa\u4e3b\u8282\u70b9</li> </ul> </li> </ul>"},{"location":"chap5/1ES_cluster/#11","title":"11\u3001\u914d\u7f6e\u8282\u70b9\u7c7b\u578b","text":"<p>\u2f00\u4e2a\u8282\u70b9\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u662f\u2f00\u4e2a Master eligible\uff0cdata and ingest node:</p> <p> </p>"},{"location":"chap5/1ES_cluster/#12","title":"12\u3001\u672c\u8282\u77e5\u8bc6\u70b9\u56de\u987e","text":"<ul> <li>Elasticsearch \u5929\u2f63\u7684\u5206\u5e03\u5f0f\u67b6\u6784\u3002\u4e3a\u4e86\u5b9e\u73b0\u5b9e\u73b0\u6570\u636e\u53ef\u2f64\u7528\u6027<ul> <li>\u90e8\u7f72\u591a\u53f0 Data Nodes\uff0c\u53ef\u4ee5\u5b9e\u73b0\u6570\u636e\u5b58\u50a8\u7684\u2f54\u5e73\u6269\u5c55</li> </ul> </li> <li>\u63d0\u2fbc\u670d\u52a1\u53ef\u7528\u6027<ul> <li>Master \u8282\u70b9\u2fae\u5e38\u91cd\u8981\u3002\u8bbe\u7f6e\u591a\u53f0 Master Eligible Nodes\uff0c\u540c\u65f6\u8bbe\u7f6e\u5408\u7406\u7684 quorum \u6570\uff0c\u907f\u514d\u8111\u88c2\u95ee\u9898</li> <li>\u8bbe\u7f6e\u591a\u53f0 Coordinating Node\uff0c\u63d0\u5347\u67e5\u8be2\u7684\u53ef\u2f64\u6027\u548c\u6027\u80fd</li> </ul> </li> </ul>"},{"location":"chap5/2ES_shard/","title":"\u7b2c\u4e8c\u8282 \u5206\u2f5a\u4e0e\u96c6\u7fa4\u7684\u6545\u969c\u8f6c\u79fb","text":""},{"location":"chap5/2ES_shard/#1primary-shard-","title":"1\u3001Primary Shard - \u63d0\u5347\u7cfb\u7edf\u5b58\u50a8\u5bb9\u91cf","text":"<ul> <li>\u5206\u2f5a\u662f Elasticsearch \u5206\u5e03\u5f0f\u5b58\u50a8\u7684\u57fa\u2f6f<ul> <li>\u4e3b\u5206\u7247 / \u526f\u672c\u5206\u2f5a</li> </ul> </li> <li>\u901a\u8fc7\u4e3b\u5206\u7247\uff0c\u5c06\u6570\u636e\u5206\u5e03\u5728\u6240\u6709\u8282\u70b9\u4e0a<ul> <li>Primary Shard\uff0c\u53ef\u4ee5\u5c06\u2f00\u4efd\u7d22\u5f15\u7684\u6570\u636e\uff0c\u5206\u6563\u5728\u591a\u4e2a Data Node \u4e0a\uff0c\u5b9e\u73b0\u5b58\u50a8\u7684\u2f54\u5e73\u6269\u5c55</li> <li>\u4e3b\u5206\u7247(Primary Shard)\u6570\u5728\u7d22\u5f15\u521b\u5efa\u65f6\u5019\u6307\u5b9a\uff0c\u540e\u7eed\u9ed8\u8ba4\u4e0d\u80fd\u4fee\u6539\uff0c\u5982\u8981\u4fee\u6539\uff0c\u9700\u91cd\u5efa\u7d22\u5f15</li> </ul> </li> </ul>"},{"location":"chap5/2ES_shard/#2replica-shard-","title":"2\u3001Replica Shard - \u63d0\u9ad8\u6570\u636e\u53ef\u2f64\u6027","text":""},{"location":"chap5/2ES_shard/#2-1","title":"2-1 \u6570\u636e\u53ef\u7528\u6027","text":"<ul> <li>\u901a\u8fc7\u5f15\u2f0a\u526f\u672c\u5206\u2f5a (Replica Shard) \u63d0\u2fbc\u6570\u636e\u7684\u53ef\u2f64\u6027</li> <li>\u2f00\u65e6\u4e3b\u5206\u2f5a\u4e22\u5931\uff0c\u526f\u672c\u5206\u2f5a\u53ef\u4ee5 Promote \u6210\u4e3b\u5206\u7247\u3002</li> <li>\u526f\u672c\u5206\u2f5a\u6570\u53ef\u4ee5\u52a8\u6001\u8c03\u6574\u3002</li> <li>\u6bcf\u4e2a\u8282\u70b9\u4e0a\u90fd\u6709\u5b8c\u5907\u7684\u6570\u636e\u3002\u5982\u679c\u4e0d\u8bbe\u7f6e\u526f\u672c\u5206\u2f5a\uff0c\u2f00\u65e6\u51fa\u73b0\u8282\u70b9\u786c\u4ef6\u6545\u969c\uff0c\u5c31\u6709\u53ef\u80fd\u9020\u6210\u6570\u636e\u4e22\u5931</li> </ul>"},{"location":"chap5/2ES_shard/#2-2","title":"2-2 \u63d0\u5347\u7cfb\u7edf\u7684\u8bfb\u53d6\u6027\u80fd","text":"<ul> <li>\u526f\u672c\u5206\u2f5a\u7531\u4e3b\u5206\u7247(<code>Primary Shard</code>)\u540c\u6b65\u3002\u901a\u8fc7\u2f40\u6301\u589e\u52a0 <code>Replica</code> \u4e2a\u6570\uff0c\u2f00\u5b9a\u7a0b\u5ea6\u53ef\u4ee5\u63d0\u9ad8\u8bfb\u53d6\u7684\u541e\u5410\u91cf</li> </ul>"},{"location":"chap5/2ES_shard/#3","title":"3\u3001\u5206\u2f5a\u6570\u7684\u8bbe\u5b9a","text":"<ul> <li>\u5982\u4f55\u89c4\u5212\u2f00\u4e2a\u7d22\u5f15\u7684\u4e3b\u5206\u2f5a\u6570\u548c\u526f\u672c\u5206\u2f5a\u6570<ul> <li>\u4e3b\u5206\u7247\u6570\u8fc7\u2f29:  \u4f8b\u5982\u521b\u5efa\u4e86 1 \u4e2a Primary Shard \u7684 Index </li> </ul> </li> <li>\u4e3b\u5206\u2f5a\u6570\u8bbe\u7f6e\u8fc7\u2f24:   \u5bfc\u81f4\u5355\u4e2a Shard \u5bb9\u91cf\u5f88\u5c0f\uff0c\u5f15\u53d1\u2f00\u4e2a\u8282\u70b9\u4e0a\u6709\u8fc7\u591a\u5206\u7247\uff0c\u5f71\u54cd\u6027\u80fd</li> <li>\u526f\u672c\u5206\u2f5a\u6570\u8bbe\u7f6e\u8fc7\u591a\uff0c\u4f1a\u964d\u4f4e\u96c6\u7fa4\u6574\u4f53\u7684\u5199\u5165\u6027\u80fd</li> </ul>"},{"location":"chap5/2ES_shard/#4","title":"4\u3001\u5355\u8282\u70b9\u96c6\u7fa4","text":"<p>\u526f\u672c\u2f46\u6cd5\u5206\u7247\uff0c\u96c6\u7fa4\u72b6\u6001\u2ee9\u8272</p> <p> </p> <p> </p>"},{"location":"chap5/2ES_shard/#5","title":"5\u3001\u589e\u52a0\u2f00\u4e2a\u6570\u636e\u8282\u70b9","text":"<ul> <li>\u96c6\u7fa4\u72b6\u6001\u8f6c\u4e3a\u7eff\u8272</li> <li>\u96c6\u7fa4\u5177\u5907\u6545\u969c\u8f6c\u79fb\u80fd\u2f12</li> <li>\u5c1d\u8bd5\u7740\u5c06 Replica \u8bbe\u7f6e\u6210 2 \u548c 3\uff0c \u67e5\u770b\u96c6\u7fa4\u7684\u72b6\u51b5</li> </ul>"},{"location":"chap5/2ES_shard/#6","title":"6\u3001\u518d\u589e\u52a0\u2f00\u4e2a\u6570\u636e\u8282\u70b9","text":"<ul> <li>\u96c6\u7fa4\u5177\u5907\u6545\u969c\u8f6c\u79fb\u80fd\u2f12</li> <li>Master \u8282\u70b9\u4f1a\u51b3\u5b9a\u5206\u2f5a\u5206\u914d\u5230\u54ea\u4e2a\u8282\u70b9</li> <li>\u901a\u8fc7\u589e\u52a0\u8282\u70b9\uff0c\u63d0\u2fbc\u96c6\u7fa4\u7684\u8ba1\u7b97\u80fd\u2f12</li> </ul>"},{"location":"chap5/2ES_shard/#7","title":"7\u3001\u6545\u969c\u8f6c\u79fb","text":"<ul> <li>3 \u4e2a\u8282\u70b9\u5171\u540c\u7ec4\u6210\u3002\u5305\u542b\u4e86 1 \u4e2a\u7d22\u5f15\uff0c\u7d22\u5f15\u8bbe\u7f6e\u4e86 3 \u4e2a Primary Shard \u548c 1 \u4e2a Replica</li> <li>\u8282\u70b9 1 \u662f Master \u8282\u70b9\uff0c\u8282\u70b9\u610f\u5916\u51fa\u73b0\u6545\u969c\u3002\u96c6\u7fa4\u91cd\u65b0\u9009\u4e3e Master \u8282\u70b9</li> <li>Node 3 \u4e0a\u7684 R0 \u63d0\u5347\u6210 P0\uff0c\u96c6\u7fa4\u53d8\u2ee9</li> <li>R0 \u548c R1 \u5206\u914d\uff0c\u96c6\u7fa4\u53d8\u7eff</li> </ul>"},{"location":"chap5/2ES_shard/#8","title":"8\u3001\u96c6\u7fa4\u5065\u5eb7\u72b6\u6001","text":"<ul> <li>Green: \u5065\u5eb7\u72b6\u6001\uff0c\u6240\u6709\u7684\u4e3b\u5206\u2f5a\u548c\u526f\u672c\u5206\u2f5a\u90fd\u53ef\u2f64 </li> <li>Yellow:\u4e9a\u5065\u5eb7\uff0c\u6240\u6709\u7684\u4e3b\u5206\u2f5a\u53ef\u7528\uff0c\u90e8\u5206\u526f\u672c\u5206\u2f5a\u4e0d\u53ef\u2f64 </li> <li>Red:\u4e0d\u5065\u5eb7\u72b6\u6001\uff0c\u90e8\u5206\u4e3b\u5206\u2f5a\u4e0d\u53ef\u2f64</li> </ul> <pre><code>GET /_cluster/health\n</code></pre>"},{"location":"chap5/2ES_shard/#9demo","title":"9\u3001Demo","text":"<ul> <li>\u542f\u52a8\u2f00\u4e2a\u8282\u70b9\uff0c3 \u4e2a Primary shard\uff0c\u2f00\u4e2a Replica\uff0c\u96c6\u7fa4\u2ee9\u8272\uff0c\u56e0\u4e3a\u2f46\u6cd5\u5206\u914d Replica</li> <li>\u542f\u52a8\u4e09\u4e2a\u8282\u70b9\uff0c1 \u4e2a\u7d22\u5f15\u4e0a\u5305\u542b 3 \u4e2a Primary Shard\uff0c\u2f00\u4e2a Replica</li> <li>\u5173\u95ed Node 1(Master)</li> <li>\u67e5\u770b Master Node \u91cd\u65b0\u9009\u4e3e</li> <li>\u96c6\u7fa4\u53d8\u2ee9\uff0c\u7136\u540e\u91cd\u65b0\u5206\u914d</li> </ul>"},{"location":"chap5/2ES_shard/#9","title":"9\u3001\u672c\u8282\u77e5\u8bc6\u70b9\u56de\u987e","text":"<p>\u4e3b\u5206\u2f5a\uff0c\u526f\u672c\u5206\u7247\u7684\u4f5c\u2f64</p> <ul> <li>\u4e3b\u5206\u2f5a\u7684\u5206\u2f5a\u6570\uff0c\u8bbe\u7f6e\u540e\u4e0d\u80fd\u4fee\u6539\uff0c\u9664\u2fae\u91cd\u65b0\u7d22\u5f15\u6570\u636e</li> <li>\u526f\u672c\u5206\u7247\u53ef\u4ee5\u968f\u65f6\u4fee\u6539</li> </ul> <p>\u96c6\u7fa4\u7684\u6545\u969c\u8f6c\u79fb</p> <ul> <li>\u9700\u8981\u96c6\u7fa4\u5177\u5907\u6545\u969c\u8f6c\u79fb\u7684\u80fd\u2f12\uff0c\u5fc5\u987b\u5c06\u7d22\u5f15\u7684\u526f\u672c\u5206\u2f5a\u6570\u8bbe\u7f6e\u4e3a 1\uff0c\u5426\u5219\uff0c\u2f00\u70b9\u6709\u8282\u70b9\u5c31\u662f\uff0c\u5c31\u4f1a\u9020\u6210\u6570\u636e\u4e22\u5931</li> </ul>"},{"location":"chap5/3ES_doc_shard/","title":"\u7b2c\u4e09\u8282 \u2f42\u6863\u5206\u5e03\u5f0f\u5b58\u50a8","text":""},{"location":"chap5/3ES_doc_shard/#1","title":"1\u3001\u6587\u6863\u5b58\u50a8\u5728\u5206\u7247\u4e0a","text":"<ul> <li>\u6587\u6863\u4f1a\u5b58\u50a8\u5728\u5177\u4f53\u7684\u67d0\u4e2a\u4e3b\u5206\u2f5a\u548c\u526f\u672c\u5206\u2f5a\u4e0a: <ul> <li>\u4f8b\u5982\u6587\u6863 1\uff0c \u4f1a\u5b58\u50a8\u5728 P0 \u548c R0 \u5206\u7247\u4e0a</li> </ul> </li> <li>\u6587\u6863\u5230\u5206\u2f5a\u7684\u6620\u5c04\u7b97\u6cd5<ul> <li>\u786e\u4fdd\u6587\u6863\u80fd\u5747\u5300\u5206\u5e03\u5728\u6240\u2f64\u5206\u7247\u4e0a\uff0c\u5145\u5206\u5229\u2f64\u786c\u4ef6\u8d44\u6e90\uff0c\u907f\u514d\u90e8\u5206\u673a\u5668\u5668\u7a7a\u95f2\uff0c\u90e8\u5206\u673a\u5668\u5668\u7e41\u5fd9 </li> <li>\u6f5c\u5728\u7684\u7b97\u6cd5<ul> <li>\u968f\u673a / Round Robin\u3002\u5f53\u67e5\u8be2\u2f42\u6863 1\uff0c\u5206\u2f5a\u6570\u5f88\u591a\uff0c\u9700\u8981\u591a\u6b21\u67e5\u8be2\u624d\u53ef\u80fd\u67e5\u5230\u6587\u6863 1</li> <li>\u7ef4\u62a4\u2f42\u6863\u5230\u5206\u2f5a\u7684\u6620\u5c04\u5173\u7cfb\uff0c\u5f53\u2f42\u6863\u6570\u636e\u91cf\u5927\u7684\u65f6\u5019\uff0c\u7ef4\u62a4\u6210\u672c\u2fbc</li> <li>\u5b9e\u65f6\u8ba1\u7b97\uff0c\u901a\u8fc7\u6587\u6863 1\uff0c\u2f83\u52a8\u7b97\u51fa\uff0c\u9700\u8981\u53bb\u90a3\u4e2a\u5206\u2f5a\u4e0a\u83b7\u53d6\u2f42\u6863</li> </ul> </li> </ul> </li> </ul>"},{"location":"chap5/3ES_doc_shard/#2","title":"2\u3001\u2f42\u6863\u5230\u5206\u7247\u7684\u8def\u7531\u7b97\u6cd5","text":"<ul> <li><code>shard = hash(_routing) % number_of_primary_shards</code><ul> <li>Hash \u7b97\u6cd5\u786e\u4fdd\u6587\u6863\u5747\u5300\u5206\u6563\u5230\u5206\u2f5a\u4e2d</li> <li>\u9ed8\u8ba4\u7684 <code>_routing</code> \u503c\u662f\u2f42\u6863 id</li> <li>\u53ef\u4ee5\u2f83\u2f8f\u5236\u5b9a routing\u6570\u503c\uff0c\u4f8b\u5982\u2f64\u76f8\u540c\u56fd\u5bb6\u7684\u5546\u54c1\uff0c\u90fd\u5206\u914d\u5230\u6307\u5b9a\u7684 shard</li> <li>\u8bbe\u7f6e Index Settings \u540e\uff0cPrimary \u6570\uff0c\u4e0d\u80fd\u968f\u610f\u4fee\u6539\u7684\u6839\u672c\u539f\u56e0\uff0c\u8981\u4fee\u6539\u662f\u9700\u8981\u91cd\u5efa\u7d22\u5f15</li> </ul> </li> </ul>"},{"location":"chap5/3ES_doc_shard/#3","title":"3\u3001\u66f4\u65b0\u4e00\u4e2a\u2f42\u6863","text":"<ol> <li>\u7528\u6237\u53d1\u9001\u8bf7\u6c42\u5230\u4e00\u4e2a\u8282\u70b9\uff0c\u63a5\u53d7\u8bf7\u6c42\u7684\u8282\u70b9\u626e\u6f14Coordinator\u7684\u89d2\u8272</li> <li>\u901a\u8fc7Hash\u7b97\u6cd5\u5224\u65ad\u8bf7\u6c42\u88ab\u8def\u7531\u5230\u54ea\u4e00\u4e2a\u5206\u7247</li> <li>\u8bf7\u6c42\u88ab\u8def\u7531\u5176\u4ed6\u8282\u70b9\u7684\u5206\u7247\u4e0a</li> <li>Es\u5bf9\u6587\u6863\u7684\u66f4\u65b0\u5b9e\u9645\u4e0a\u5bf9\u6587\u6863\u7684\u5220\u9664</li> <li>\u7136\u540e\u518d\u521b\u5efa\u51fa\u6765\u65b0\u7684\u6587\u6863</li> <li>\u521b\u5efa\u6210\u529f\uff0c\u6210\u529f\u4fe1\u606f\u53d1\u7ed9Coordinator node</li> <li>\u6700\u7ec8\u7ed3\u679c\u8fd4\u56de\u7ed9\u7528\u6237</li> </ol>"},{"location":"chap5/3ES_doc_shard/#4","title":"4\u3001\u5220\u9664\u2f00\u4e2a\u2f42\u6863","text":"<ol> <li>\u7528\u6237\u53d1\u9001\u5220\u9664\u8bf7\u6c42\u5230\u4e00\u4e2a\u8282\u70b9\uff0c\u63a5\u53d7\u8bf7\u6c42\u7684\u8282\u70b9\u626e\u6f14Coordinator\u7684\u89d2\u8272</li> <li>\u901a\u8fc7Hash\u7b97\u6cd5\u5224\u65ad\u8bf7\u6c42\u88ab\u8def\u7531\u5230\u54ea\u4e00\u4e2a\u5206\u7247\uff0c\u5e76\u8bf7\u6c42\u88ab\u8def\u7531\u5176\u4ed6\u8282\u70b9\u7684\u5206\u7247\u4e0a</li> <li>\u8282\u70b9\u4e0a\u5bf9\u5206\u7247\u8fdb\u884c\u5220\u9664</li> <li>\u5220\u9664replica\u7684\u8bf7\u6c42\u53d1\u9001\u5230\u5176\u4ed6\u7684replica node\u4e0a\uff0c\u8def\u7531\u4fe1\u606f\u901a\u8fc7cluster state\u6765\u83b7\u53d6</li> <li>replica\u5220\u9664\u4f1a\u5c06\u4fe1\u606f\u53d1\u56de\u7ed9primary shared</li> <li>primary shared\u5c06\u5220\u9664\u4fe1\u606f\u53d1\u56de\u5230Coordinator node</li> <li>\u6700\u7ec8\u5c06\u4fe1\u606f\u53d1\u56de\u5230\u7528\u6237</li> </ol>"},{"location":"chap5/3ES_doc_shard/#5","title":"5\u3001\u672c\u8282\u77e5\u8bc6\u70b9\u56de\u987e","text":"<ol> <li>\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e Index Settings\uff0c\u63a7\u5236\u6570\u636e\u7684\u5206\u2f5a</li> <li>Primary Shard \u7684\u503c\u4e0d\u80fd\u4fee\u6539\uff0c\u4fee\u6539\u9700\u8981\u91cd\u65b0 Index\u3002\u9ed8\u8ba4\u503c\u662f 5\uff0c \u4ece 7 \u5f00\u59cb\uff0c\u9ed8\u8ba4\u503c\u6539\u4e3a 1</li> <li>\u7d22\u5f15\u5199\u5165\u6570\u636e\u540e\uff0cReplica \u7684\u503c\u53ef\u4ee5\u4fee\u6539\u3002\u589e\u52a0\u526f\u672c\uff0c\u53ef\u63d0\u9ad8\u5927\u5e76\u53d1\u4e0b\u7684\u8bfb\u53d6\u6027\u80fd</li> <li>\u901a\u8fc7\u63a7\u5236\u96c6\u7fa4\u7684\u8282\u70b9\u6570\uff0c\u8bbe\u7f6e Primary Shard \u6570\uff0c\u5b9e\u73b0\u2f54\u5e73\u6269\u5c55</li> </ol>"},{"location":"chap5/4ES_shared_lifecycle/","title":"\u7b2c\u56db\u8282 \u5206\u2f5a\u53ca\u5176\u751f\u547d\u5468\u671f","text":""},{"location":"chap5/4ES_shared_lifecycle/#1","title":"1\u3001\u5206\u2f5a\u7684\u5185\u90e8\u539f\u7406","text":""},{"location":"chap5/4ES_shared_lifecycle/#1-1-es","title":"1-1 \u4ec0\u4e48\u662f ES \u7684\u5206\u2f5a","text":"<ul> <li>ES \u4e2d\u6700\u5c0f\u7684\u5de5\u4f5c\u5355\u5143 </li> <li>\u662f\u4e00\u4e2a Lucene \u7684 Index</li> </ul>"},{"location":"chap5/4ES_shared_lifecycle/#1-2","title":"1-2 \u4e00\u4e9b\u95ee\u9898:","text":"<ul> <li>\u4e3a\u4ec0\u4e48 ES \u7684\u641c\u7d22\u662f\u8fd1\u5b9e\u65f6\u7684(1 \u79d2\u540e\u88ab\u641c\u5230)</li> <li>ES \u5982\u4f55\u4fdd\u8bc1\u5728\u65ad\u7535\u65f6\u6570\u636e\u4e5f\u4e0d\u4f1a\u4e22\u5931</li> <li>\u4e3a\u4ec0\u4e48\u5220\u9664\u6587\u6863\uff0c\u5e76\u4e0d\u4f1a\u7acb\u523b\u91ca\u653e\u7a7a\u95f4</li> </ul>"},{"location":"chap5/4ES_shared_lifecycle/#2","title":"2\u3001\u5012\u6392\u7d22\u5f15\u4e0d\u53ef\u53d8\u6027","text":"<ul> <li>\u5012\u6392\u7d22\u5f15\u91c7\u7528 Immutable Design\uff0c\u2f00\u65e6\u751f\u6210\uff0c\u4e0d\u53ef\u66f4\u6539</li> <li>\u4e0d\u53ef\u53d8\u6027\uff0c\u5e26\u6765\u4e86\u7684\u597d\u5904\u5982\u4e0b<ul> <li>\u2f46\u9700\u8003\u8651\u5e76\u53d1\u5199\u6587\u4ef6\u7684\u95ee\u9898\uff0c\u907f\u514d\u4e86\u4e86\u9501\u673a\u5236\u5e26\u6765\u7684\u6027\u80fd\u95ee\u9898 </li> <li>\u2f00\u65e6\u8bfb\u5165\u5185\u6838\u7684\u6587\u4ef6\u7cfb\u7edf\u7f13\u5b58\uff0c\u4fbf\u7559\u5728\u54ea\u2fa5\u3002 \u53ea\u8981\u6587\u4ef6\u7cfb\u7edf\u5b58\u6709\u8db3\u591f\u7684\u7a7a\u95f4\uff0c\u2f24\u90e8\u5206\u8bf7\u6c42\u5c31\u4f1a\u76f4\u63a5\u8bf7\u6c42\u5185\u5b58\uff0c\u4e0d\u4f1a\u547d\u4e2d\u78c1\u76d8\uff0c\u63d0\u5347\u4e86\u4e86\u5f88\u2f24\u7684\u6027\u80fd</li> <li>\u7f13\u5b58\u5bb9\u6613\u751f\u6210\u548c\u7ef4\u62a4 / \u6570\u636e\u53ef\u4ee5\u88ab\u538b\u7f29</li> </ul> </li> <li>\u4e0d\u53ef\u53d8\u66f4\u6027\uff0c\u5e26\u6765\u4e86\u7684\u6311\u6218: \u5982\u679c\u9700\u8981\u8ba9\u2f00\u4e2a\u65b0\u7684\u6587\u6863\u53ef\u4ee5\u88ab\u641c\u7d22\uff0c\u9700\u8981\u91cd\u5efa\u6574\u4e2a\u7d22\u5f15\u3002</li> </ul>"},{"location":"chap5/4ES_shared_lifecycle/#3lucene-index","title":"3\u3001Lucene Index","text":"<ul> <li>\u5728 Lucene \u4e2d\uff0c\u5355\u4e2a\u5012\u6392\u7d22\u5f15\u6587\u4ef6\u88ab\u79f0\u4e3a Segment\u3002Segment \u662f\u81ea\u5305\u542b\u7684\uff0c\u4e0d\u53ef\u53d8\u66f4\u7684\u3002 \u591a\u4e2a Segments \u6c47\u603b\u5728\u2f00\u8d77\uff0c\u79f0\u4e3a Lucene \u7684 Index\uff0c\u5176\u5bf9\u5e94\u7684\u5c31\u662f ES \u4e2d\u7684 Shard</li> <li>\u5f53\u6709\u65b0\u2f42\u6863\u5199\u2f0a\u65f6\uff0c\u4f1a\u2f63\u6210\u65b0 Segment\uff0c\u67e5\u8be2\u65f6\u4f1a\u540c\u65f6\u67e5\u8be2\u6240\u6709 Segments\uff0c\u5e76\u4e14\u5bf9\u7ed3\u679c\u6c47\u603b\u3002Lucene \u4e2d\u6709\u2f00\u4e2a\u2f42\u4ef6\uff0c\u7528\u6765\u8bb0\u5f55\u6240\u6709 Segments \u4fe1\u606f\uff0c\u53eb\u505a Commit Point</li> <li>\u5220\u9664\u7684\u6587\u6863\u4fe1\u606f\uff0c\u4fdd\u5b58\u5728<code>\u201c.del\u201d</code>\u2f42\u4ef6\u4e2d</li> </ul>"},{"location":"chap5/4ES_shared_lifecycle/#4-refresh","title":"4\u3001\u4ec0\u4e48\u662f Refresh","text":"<ul> <li>\u5c06 Index buffer \u5199\u5165 Segment \u7684\u8fc7\u7a0b\u53eb Refresh\u3002Refresh \u4e0d\u6267\u2f8f fsync \u64cd\u4f5c</li> <li>Refresh \u9891\u7387: \u9ed8\u8ba4 1 \u79d2\u53d1\u2f63\u4e00\u6b21\uff0c\u53ef\u901a\u8fc7 <code>index.refresh_interval</code> \u914d\u7f6e\u3002<code>Refresh</code> \u540e\uff0c \u6570\u636e\u5c31\u53ef\u4ee5\u88ab\u641c\u7d22\u5230\u4e86\u3002\u8fd9\u4e5f\u662f\u4e3a\u4ec0\u4e48 <code>Elasticsearch</code> \u88ab\u79f0\u4e3a\u8fd1\u5b9e\u65f6\u641c\u7d22</li> <li>\u5982\u679c\u7cfb\u7edf\u6709\u2f24\u91cf\u7684\u6570\u636e\u5199\u5165\uff0c\u90a3\u5c31\u4f1a\u4ea7\u2f63\u5f88\u591a\u7684 Segment</li> <li><code>Index Buffer</code> \u88ab\u5360\u6ee1\u65f6\uff0c\u4f1a\u89e6\u53d1 <code>Refresh</code>\uff0c\u9ed8\u8ba4\u503c\u662f <code>JVM</code> \u7684 10%</li> </ul>"},{"location":"chap5/4ES_shared_lifecycle/#5-transaction-log","title":"5\u3001\u4ec0\u4e48\u662f Transaction Log","text":"<ul> <li>Segment \u5199\u2f0a\u78c1\u76d8\u7684\u8fc7\u7a0b\u76f8\u5bf9\u8017\u65f6\uff0c\u501f\u52a9\u6587\u4ef6\u7cfb\u7edf\u7f13\u5b58\uff0cRefresh \u65f6\uff0c\u5148\u5c06 Segment \u5199\u5165\u7f13\u5b58\u4ee5\u5f00\u653e\u67e5\u8be2</li> <li>\u4e3a\u4e86\u4fdd\u8bc1\u6570\u636e\u4e0d\u4f1a\u4e22\u5931\u3002\u6240\u4ee5\u5728 Index \u2f42\u6863\u65f6\uff0c\u540c\u65f6\u5199 Transaction Log\uff0c\u2fbc\u7248\u672c\u5f00\u59cb\uff0cTransaction Log \u9ed8\u8ba4\u843d\u76d8\u3002\u6bcf\u4e2a\u5206\u2f5a\u6709\u4e00\u4e2a Transaction Log</li> <li>\u5728 ES Refresh \u65f6\uff0cIndex Buffer \u88ab\u6e05\u7a7a\uff0c Transaction log \u4e0d\u4f1a\u6e05\u7a7a</li> </ul>"},{"location":"chap5/4ES_shared_lifecycle/#6-flush","title":"6\u3001\u4ec0\u4e48\u662f Flush","text":"<ul> <li>ES Flush &amp; Lucene Commit<ul> <li>\u8c03\u2f64 Refresh\uff0cIndex Buffer \u6e05\u7a7a\u5e76\u4e14 Refresh</li> <li>\u8c03\u2f64 fsync\uff0c\u5c06\u7f13\u5b58\u4e2d\u7684 Segments \u5199\u5165\u78c1\u76d8</li> <li>\u6e05\u7a7a(\u5220\u9664)Transaction Log</li> <li>\u9ed8\u8ba4 30 \u5206\u949f\u8c03\u2f64\u7528\u2f00\u6b21</li> <li>Transaction Log \u6ee1 (\u9ed8\u8ba4 512 MB)</li> </ul> </li> </ul>"},{"location":"chap5/4ES_shared_lifecycle/#7merge","title":"7\u3001Merge","text":"<ul> <li>Segment \u5f88\u591a\uff0c\u9700\u8981\u88ab\u5b9a\u671f\u88ab\u5408\u5e76<ul> <li>\u51cf\u5c11 Segments / \u5220\u9664\u5df2\u7ecf\u5220\u9664\u7684\u6587\u6863</li> </ul> </li> <li>ES \u548c Lucene \u4f1a\u2f83\u52a8\u8fdb\u2f8f Merge \u64cd\u4f5c<ul> <li><code>POST my_index/_forcemerge</code></li> </ul> </li> </ul>"},{"location":"chap5/4ES_shared_lifecycle/#8","title":"8\u3001\u672c\u8282\u77e5\u8bc6\u70b9\u56de\u987e","text":"<p>Shard \u548c Lucene Index</p> <ul> <li>Index Buffer / Segment / Transaction Log</li> </ul> <p>Refresh &amp; Flush</p> <p>Merge</p>"},{"location":"chap5/4ES_shared_lifecycle/#9","title":"9\u3001\u4e09&amp;\u56db\u8282\u77e5\u8bc6\u603b\u7ed3","text":"<ol> <li>\u5ba2\u6237\u7aef\u53d1\u8d77\u6570\u636e\u5199\u5165\u8bf7\u6c42\uff0c\u5bf9\u4f60\u5199\u7684\u8fd9\u6761\u6570\u636e\u6839\u636e<code>_routing</code>\u89c4\u5219\u9009\u62e9\u53d1\u7ed9\u54ea\u4e2a<code>Shard</code>\u3002<ul> <li>\u786e\u8ba4<code>Index Request</code>\u4e2d\u662f\u5426\u8bbe\u7f6e\u4e86\u4f7f\u7528\u54ea\u4e2a<code>Filed</code>\u7684\u503c\u4f5c\u4e3a\u8def\u7531\u53c2\u6570\uff0c\u5982\u679c\u6ca1\u6709\u8bbe\u7f6e\uff0c\u5219\u4f7f\u7528Mapping\u4e2d\u7684\u914d\u7f6e</li> <li>\u5982\u679cmapping\u4e2d\u4e5f\u6ca1\u6709\u914d\u7f6e\uff0c\u5219\u4f7f\u7528<code>_id</code>\u4f5c\u4e3a\u8def\u7531\u53c2\u6570\uff0c\u7136\u540e\u901a\u8fc7<code>_routing</code>\u7684<code>Hash</code>\u503c\u9009\u62e9\u51fa<code>Shard</code>\uff0c\u6700\u540e\u4ece\u96c6\u7fa4\u7684<code>Meta</code>\u4e2d\u627e\u51fa\u8be5<code>Shard</code>\u7684<code>Primary</code>\u8282\u70b9 </li> </ul> </li> <li>\u5199\u5165\u8bf7\u6c42\u5230\u8fbeShard\u540e\uff0c\u5148\u628a\u6570\u636e\u5199\u5165\u5230\u5185\u5b58\uff08buffer\uff09\u4e2d\uff0c\u540c\u65f6\u4f1a\u5199\u5165\u4e00\u6761\u65e5\u5fd7\u5230Transaction Log\u65e5\u5fd7\u6587\u4ef6\u4e2d\u53bb\u3002<ul> <li>\u5f53\u5199\u5165\u8bf7\u6c42\u5230shard\u540e\uff0c\u9996\u5148\u662f\u5199Lucene\uff0c\u5176\u5b9e\u5c31\u662f\u521b\u5efa\u7d22\u5f15\u3002</li> <li>\u7d22\u5f15\u521b\u5efa\u597d\u540e\u5e76\u4e0d\u662f\u9a6c\u4e0a\u751f\u6210segment\uff0c\u8fd9\u4e2a\u65f6\u5019\u7d22\u5f15\u6570\u636e\u8fd8\u5728\u7f13\u5b58\u4e2d\uff0c\u8fd9\u91cc\u7684\u7f13\u5b58\u662flucene\u7684\u7f13\u5b58\uff0c\u5e76\u975eElasticsearch\u7f13\u5b58\uff0clucene\u7f13\u5b58\u4e2d\u7684\u6570\u636e\u662f\u4e0d\u53ef\u88ab\u67e5\u8be2\u7684\u3002</li> </ul> </li> <li>\u6267\u884crefresh\u64cd\u4f5c\uff1a\u4ece\u5185\u5b58<code>buffer</code>\u4e2d\u5c06\u6570\u636e\u5199\u5165<code>os cache</code>(\u64cd\u4f5c\u7cfb\u7edf\u7684\u5185\u5b58)\uff0c\u4ea7\u751f\u4e00\u4e2a<code>segment file</code>\u6587\u4ef6\uff0cbuffer\u6e05\u7a7a\u3002\u5199\u5165os cache\u7684\u540c\u65f6\uff0c\u5efa\u7acb\u5012\u6392\u7d22\u5f15\uff0c\u8fd9\u65f6\u6570\u636e\u5c31\u53ef\u4ee5\u4f9b\u5ba2\u6237\u7aef\u8fdb\u884c\u8bbf\u95ee\u4e86\u3002<ul> <li>\u9ed8\u8ba4\u662f\u6bcf\u96941\u79d2refresh\u4e00\u6b21\u7684\uff0c\u6240\u4ee5<code>es</code>\u662f\u51c6\u5b9e\u65f6\u7684\uff0c\u56e0\u4e3a\u5199\u5165\u7684\u6570\u636e1\u79d2\u4e4b\u540e\u624d\u80fd\u88ab\u770b\u5230\u3002</li> <li><code>buffer</code>\u5185\u5b58\u5360\u6ee1\u7684\u65f6\u5019\u4e5f\u4f1a\u6267\u884c<code>refresh</code>\u64cd\u4f5c\uff0c<code>buffer</code>\u9ed8\u8ba4\u503c\u662f<code>JVM</code>\u5185\u5b58\u768410%\u3002</li> <li>\u901a\u8fc7<code>es</code>\u7684<code>restful api</code>\u6216\u8005<code>java api</code>\uff0c\u624b\u52a8\u6267\u884c\u4e00\u6b21<code>refresh</code>\u64cd\u4f5c\uff0c\u5c31\u662f\u624b\u52a8\u5c06<code>buffer</code>\u4e2d\u7684\u6570\u636e\u5237\u5165<code>os cache</code>\u4e2d\uff0c\u8ba9\u6570\u636e\u7acb\u9a6c\u5c31\u53ef\u4ee5\u88ab\u641c\u7d22\u5230\u3002</li> <li>\u82e5\u8981\u4f18\u5316\u7d22\u5f15\u901f\u5ea6, \u800c\u4e0d\u6ce8\u91cd\u5b9e\u65f6\u6027, \u53ef\u4ee5\u964d\u4f4e\u5237\u65b0\u9891\u7387\u3002</li> </ul> </li> <li><code>translog</code>\u4f1a\u6bcf\u96945\u79d2\u6216\u8005\u5728\u4e00\u4e2a\u53d8\u66f4\u8bf7\u6c42\u5b8c\u6210\u4e4b\u540e\uff0c\u5c06<code>translog</code>\u4ece\u7f13\u5b58\u5237\u5165\u78c1\u76d8\u3002<ul> <li>translog\u662f\u5b58\u50a8\u5728os cache\u4e2d\uff0c\u6bcf\u4e2a\u5206\u7247\u6709\u4e00\u4e2a\uff0c\u5982\u679c\u8282\u70b9\u5b95\u673a\u4f1a\u67095\u79d2\u6570\u636e\u4e22\u5931\uff0c\u4f46\u662f\u6027\u80fd\u6bd4\u8f83\u597d\uff0c\u6700\u591a\u4e225\u79d2\u7684\u6570\u636e\u3002</li> <li>\u53ef\u4ee5\u5c06translog\u8bbe\u7f6e\u6210\u6bcf\u6b21\u5199\u64cd\u4f5c\u5fc5\u987b\u662f\u76f4\u63a5fsync\u5230\u78c1\u76d8\uff0c\u4f46\u662f\u6027\u80fd\u4f1a\u5dee\u5f88\u591a\u3002</li> <li>\u53ef\u4ee5\u901a\u8fc7\u914d\u7f6e\u589e\u52a0transLog\u5237\u78c1\u76d8\u7684\u9891\u7387\u6765\u589e\u52a0\u6570\u636e\u53ef\u9760\u6027\uff0c\u6700\u5c0f\u53ef\u914d\u7f6e100ms\uff0c\u4f46\u4e0d\u5efa\u8bae\u8fd9\u4e48\u505a\uff0c\u56e0\u4e3a\u8fd9\u4f1a\u5bf9\u6027\u80fd\u6709\u975e\u5e38\u5927\u7684\u5f71\u54cd\u3002</li> </ul> </li> <li>\u6bcf30\u5206\u949f\u6216\u8005\u5f53tanslog\u7684\u5927\u5c0f\u8fbe\u5230512M\u65f6\u5019\uff0c\u5c31\u4f1a\u6267\u884c<code>commit</code>\u64cd\u4f5c\uff08<code>flush</code>\u64cd\u4f5c\uff09\uff0c\u5c06os cache\u4e2d\u6240\u6709\u7684\u6570\u636e\u5168\u4ee5segment file\u7684\u5f62\u5f0f\uff0c\u6301\u4e45\u5230\u78c1\u76d8\u4e0a\u53bb\u3002<ul> <li>\u7b2c\u4e00\u6b65\uff0c\u5c31\u662f\u5c06<code>buffer</code>\u4e2d\u73b0\u6709\u6570\u636e<code>refresh</code>\u5230<code>os cache</code>\u4e2d\u53bb\u3002</li> <li>\u6e05\u7a7a<code>buffer</code> \u7136\u540e\u5f3a\u884c\u5c06<code>os cache</code>\u4e2d\u6240\u6709\u7684\u6570\u636e\u5168\u90fd\u4e00\u4e2a\u4e00\u4e2a\u7684\u901a\u8fc7<code>segmentfile</code>\u7684\u5f62\u5f0f\uff0c\u6301\u4e45\u5230\u78c1\u76d8\u4e0a\u53bb\u3002</li> <li>\u5c06<code>commit point</code>\u8fd9\u4e2a\u6587\u4ef6\u66f4\u65b0\u5230\u78c1\u76d8\u4e2d\uff0c\u6bcf\u4e2a<code>Shard</code>\u90fd\u6709\u4e00\u4e2a\u63d0\u4ea4\u70b9(<code>commit point</code>), \u5176\u4e2d\u4fdd\u5b58\u4e86\u5f53\u524dShard\u6210\u529f\u5199\u5165\u78c1\u76d8\u7684\u6240\u6709segment\u3002</li> <li>\u628atranslog\u6587\u4ef6\u5220\u6389\u6e05\u7a7a\uff0c\u518d\u5f00\u4e00\u4e2a\u7a7a\u7684translog\u6587\u4ef6\u3002</li> <li>flush\u53c2\u6570\u8bbe\u7f6e\uff1a<ul> <li><code>index.translog.flush_threshold_period</code>:</li> <li><code>index.translog.flush_threshold_size</code>:</li> <li><code>#\u63a7\u5236\u6bcf\u6536\u5230\u591a\u5c11\u6761\u6570\u636e\u540eflush\u4e00\u6b21</code></li> <li><code>index.translog.flush_threshold_ops</code>:</li> </ul> </li> </ul> </li> <li>Segment\u7684merge\u64cd\u4f5c\uff1a<ul> <li>\u968f\u7740\u65f6\u95f4\uff0c\u78c1\u76d8\u4e0a\u7684segment\u8d8a\u6765\u8d8a\u591a\uff0c\u9700\u8981\u5b9a\u671f\u8fdb\u884c\u5408\u5e76\u3002</li> <li>Es\u548cLucene \u4f1a\u81ea\u52a8\u8fdb\u884cmerge\u64cd\u4f5c\uff0c\u5408\u5e76segment\u548c\u5220\u9664\u5df2\u7ecf\u5220\u9664\u7684\u6587\u6863\u3002</li> <li>\u6211\u4eec\u53ef\u4ee5\u624b\u52a8\u8fdb\u884cmerge\uff1a<code>POST index/_forcemerge</code>\u3002\u4e00\u822c\u4e0d\u9700\u8981\uff0c\u8fd9\u662f\u4e00\u4e2a\u6bd4\u8f83\u6d88\u8017\u8d44\u6e90\u7684\u64cd\u4f5c\u3002</li> <li>\u5f53\u6570\u636e\u4ecehot\u79fb\u52a8\u5230warm\uff0c\u5b98\u65b9\u5efa\u8bae\u624b\u5de5\u6267\u884c\u4e00\u4e0b<code>_forcemerge</code></li> </ul> </li> </ol>"},{"location":"chap5/5ES_SE_Score/","title":"\u7b2c\u4e94\u8282 \u5256\u6790\u5206\u5e03\u5f0f\u67e5\u8be2\u53ca\u76f8\u5173\u6027\u7b97\u5206","text":""},{"location":"chap5/5ES_SE_Score/#1","title":"1\u3001\u5206\u5e03\u5f0f\u641c\u7d22\u7684\u8fd0\u2f8f\u673a\u5236","text":"<ul> <li>Elasticsearch \u7684\u641c\u7d22\uff0c\u4f1a\u5206\u4e24\u9636\u6bb5\u8fdb\u2f8f<ul> <li>\u7b2c\u2f00\u9636\u6bb5 - Query </li> <li>\u7b2c\u2f06\u9636\u6bb5 - Fetch</li> </ul> </li> <li><code>Query-then-Fetch</code></li> </ul>"},{"location":"chap5/5ES_SE_Score/#2query","title":"2\u3001Query \u9636\u6bb5","text":"<ul> <li>\u2f64\u6237\u53d1\u51fa\u641c\u7d22\u8bf7\u6c42\u5230 ES \u8282\u70b9\u3002\u8282\u70b9\u6536\u5230\u8bf7\u6c42\u540e\uff0c \u4f1a\u4ee5 Coordinating \u8282\u70b9\u7684\u8eab\u4efd\uff0c\u5728 6 \u4e2a \u4e3b\u526f\u5206\u2f5a\u4e2d\u968f\u673a\u9009\u62e9 3 \u4e2a\u5206\u7247\uff0c\u53d1\u9001\u67e5\u8be2\u8bf7\u6c42</li> <li>\u88ab\u9009\u4e2d\u7684\u5206\u2f5a\u6267\u2f8f\u67e5\u8be2\uff0c\u8fdb\u2f8f\u6392\u5e8f\u3002\u7136\u540e\uff0c\u6bcf\u4e2a\u5206\u2f5a\u90fd\u4f1a\u8fd4\u56de From + Size \u4e2a\u6392\u5e8f\u540e\u7684\u2f42\u6863 Id \u548c\u6392\u5e8f\u503c\u7ed9 Coordinating \u8282\u70b9</li> </ul>"},{"location":"chap5/5ES_SE_Score/#3fetch","title":"3\u3001Fetch \u9636\u6bb5","text":"<ul> <li>Coordinating Node \u4f1a\u5c06 Query \u9636\u6bb5\uff0c\u4ece\u6bcf\u4e2a\u5206\u2f5a\u83b7\u53d6\u7684\u6392\u5e8f\u540e\u7684\u6587\u6863 Id \u5217\u8868\uff0c \u91cd\u65b0\u8fdb\u2f8f\u6392\u5e8f\u3002\u9009\u53d6 From \u5230 From + Size \u4e2a\u2f42\u6863\u7684 Id</li> <li>\u4ee5 multi get \u8bf7\u6c42\u7684\u2f45\u5f0f\uff0c\u5230\u76f8\u5e94\u7684\u5206\u7247\u83b7\u53d6\u8be6\u7ec6\u7684\u2f42\u6863\u6570\u636e</li> </ul>"},{"location":"chap5/5ES_SE_Score/#4query-then-fetch","title":"4\u3001Query Then Fetch \u6f5c\u5728\u7684\u95ee\u9898","text":"<ul> <li>\u6027\u80fd\u95ee\u9898<ul> <li>\u6bcf\u4e2a\u5206\u2f5a\u4e0a\u9700\u8981\u67e5\u7684\u2f42\u6863\u4e2a\u6570 = from + size</li> <li>\u6700\u7ec8\u534f\u8c03\u8282\u70b9\u9700\u8981\u5904\u7406: <code>number_of_shard * ( from+size )</code></li> <li>\u6df1\u5ea6\u5206\u2eda</li> </ul> </li> <li>\u76f8\u5173\u6027\u7b97\u5206<ul> <li>\u6bcf\u4e2a\u5206\u2f5a\u90fd\u57fa\u4e8e\u2f83\u5df1\u7684\u5206\u2f5a\u4e0a\u7684\u6570\u636e\u8fdb\u2f8f\u76f8\u5173\u5ea6\u8ba1\u7b97\u3002\u8fd9\u4f1a\u5bfc\u81f4\u6253\u5206\u504f\u79bb\u7684\u60c5\u51b5\uff0c\u7279\u522b\u662f\u6570\u636e\u91cf\u5f88\u5c11\u65f6\u3002\u76f8\u5173\u6027\u7b97\u5206\u5728\u5206\u2f5a\u4e4b\u95f4\u662f\u76f8\u4e92\u72ec\u7acb\u3002\u5f53\u2f42\u6863\u603b\u6570\u5f88\u5c11\u7684\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u4e3b\u5206\u7247\u2f24\u4e8e 1\uff0c\u4e3b\u5206\u2f5a\u6570\u8d8a\u591a \uff0c\u76f8\u5173\u6027\u7b97\u5206\u4f1a\u8d8a\u4e0d\u51c6</li> </ul> </li> </ul>"},{"location":"chap5/5ES_SE_Score/#5","title":"5\u3001\u89e3\u51b3\u7b97\u5206\u4e0d\u51c6\u7684\u2f45\u6cd5","text":"<p>\u6570\u636e\u91cf\u4e0d\u2f24\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u5c06\u4e3b\u5206\u2f5a\u6570\u8bbe\u7f6e\u4e3a 1</p> <ul> <li>\u5f53\u6570\u636e\u91cf\u2f9c\u591f\u2f24\u65f6\u5019\uff0c\u53ea\u8981\u4fdd\u8bc1\u2f42\u6863\u5747\u5300\u5206\u6563\u5728\u5404\u4e2a\u5206\u7247\u4e0a\uff0c\u7ed3\u679c\u4e00\u822c\u5c31\u4e0d\u4f1a\u51fa\u73b0\u504f\u5dee</li> </ul> <p>\u4f7f\u2f64 DFS Query Then Fetch</p> <ul> <li>\u641c\u7d22\u7684URL \u4e2d\u6307\u5b9a\u53c2\u6570 <code>\u201c_search?search_type=dfs_query_then_fetch\u201d</code></li> <li>\u5230\u6bcf\u4e2a\u5206\u2f5a\u628a\u5404\u5206\u2f5a\u7684\u8bcd\u9891\u548c\u2f42\u6863\u9891\u7387\u8fdb\u2f8f\u641c\u96c6\uff0c\u7136\u540e\u5b8c\u6574\u7684\u8fdb\u2f8f\u2f00\u6b21\u76f8\u5173\u6027\u7b97\u5206\uff0c \u8017\u8d39\u66f4\u52a0\u591a\u7684 CPU \u548c\u5185\u5b58\uff0c\u6267\u2f8f\u6027\u80fd\u4f4e\u4e0b\uff0c\u2f00\u822c\u4e0d\u5efa\u8bae\u4f7f\u2f64</li> </ul>"},{"location":"chap5/5ES_SE_Score/#6-demo","title":"6\u3001\u76f8\u5173\u6027\u7b97\u5206\u95ee\u9898 Demo","text":"<ul> <li>\u5199\u2f0a 3 \u6761\u8bb0\u5f55 \u201cGood\u201d / \u201cGood morning\u201d / \u201cgood morning everyone\u201d</li> <li>\u4f7f\u2f64 1 \u4e2a\u4e3b\u5206\u2f5a\u6d4b\u8bd5\uff0c Good \u5e94\u8be5\u6392\u5728\u7b2c\u2f00\uff0cGood DF \u6570\u503c\u5e94\u8be5\u662f 3</li> <li>\u548c 20 \u4e2a\u4e3b\u5206\u2f5a\uff0c\u6d4b\u8bd5</li> <li>\u5f53 \u591a\u4e2a\u4e3b\u5206\u2f5a\u65f6\uff0c3 \u4e2a\u2f42\u6863\u7684\u7b97\u5206\u90fd\u2f00\u6837\u3002 \u53ef\u4ee5\u901a\u8fc7 Explain API \u8fdb\u2f8f\u5206\u6790</li> <li>\u5728 3 \u4e2a\u4e3b\u5206\u7247\u4e0a \u6267\u2f8f DFS Query Then Fetch\uff0c\u7ed3\u679c\u548c\u2f00\u4e2a\u5206\u2f5a\u4e0a\u2f00\u81f4</li> </ul> <pre><code>DELETE message\nPUT message\n{\n  \"settings\": {\n    \"number_of_shards\": 20\n  }\n}\n</code></pre> <pre><code>{\n  \"acknowledged\" : true,\n  \"shards_acknowledged\" : true,\n  \"index\" : \"message\"\n}\n</code></pre> <pre><code>GET message\n</code></pre> <p>Output</p> <pre><code>{\n  \"message\" : {\n    \"aliases\" : { },\n    \"mappings\" : {\n      \"properties\" : {\n        \"content\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n            }\n          }\n        }\n      }\n    },\n    \"settings\" : {\n      \"index\" : {\n        \"creation_date\" : \"1603408677309\",\n        \"number_of_shards\" : \"20\",\n        \"number_of_replicas\" : \"1\",\n        \"uuid\" : \"QKfnIdUsR9Gj8giWp7Kr0g\",\n        \"version\" : {\n          \"created\" : \"7090199\"\n        },\n        \"provided_name\" : \"message\"\n      }\n    }\n  }\n}\n</code></pre> <p>\u5199\u5165\u6570\u636e</p> <pre><code>POST message/_doc?routing=1\n{\n  \"content\":\"good\"\n}\n\nPOST message/_doc?routing=2\n{\n  \"content\":\"good morning\"\n}\n\nPOST message/_doc?routing=3\n{\n  \"content\":\"good morning everyone\"\n}\n</code></pre> <pre><code>POST message/_search\n{\n  \"explain\": true,\n  \"query\": {\n    \"match_all\": {}\n  }\n}\n</code></pre> <p>Ouput</p> <pre><code>\"_shard\" : \"[message][2]\",\n\"_score\" : 1.0,\n\"_routing\" : \"3\",\n\"_source\" : {\n          \"content\" : \"good morning everyone\"\n        },\n...\n\"_shard\" : \"[message][14]\",\n\"_score\" : 1.0,\n\"_routing\" : \"2\",\n \"_source\" : {\n          \"content\" : \"good morning\"\n },\n ...\n\"_shard\" : \"[message][17]\",\n\"_score\" : 1.0,\n        \"_routing\" : \"1\",\n        \"_source\" : {\n          \"content\" : \"good\"\n        },\n</code></pre> <p>\u5f53\u2f42\u6863\u603b\u6570\u5f88\u5c11\u7684\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u4e3b\u5206\u7247\u2f24\u4e8e 1\uff0c\u4e3b\u5206\u2f5a\u6570\u8d8a\u591a \uff0c\u76f8\u5173\u6027\u7b97\u5206\u4f1a\u8d8a\u4e0d\u51c6</p> <pre><code>POST message/_search\n{\n  \"explain\": true,\n  \"query\": {\n    \"term\": {\n      \"content\": {\n        \"value\": \"good\"\n      }\n    }\n  }\n}\n</code></pre> <p>Ouput :</p> <pre><code>\"_score\" : 0.2876821,\n\"_source\" : {\n          \"content\" : \"good morning everyone\"\n        },\n...\n\"_score\" : 0.2876821,\n\n\"_source\" : {\n          \"content\" : \"good morning\"\n        }, \n...\n\"_score\" : 0.2876821,\n\"_source\" : {\n          \"content\" : \"good\"\n        },\n</code></pre> <p>\u4f7f\u2f64 DFS Query Then Fetch</p> <pre><code>\nPOST message/_search?search_type=dfs_query_then_fetch\n{\n\n  \"query\": {\n    \"term\": {\n      \"content\": {\n        \"value\": \"good\"\n      }\n    }\n  }\n}\n</code></pre> <p>Ouput :</p> <pre><code>\"hits\" : [\n      {\n        \"_index\" : \"message\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"rX2gUnUBaxLQOLM-iUzd\",\n        \"_score\" : 0.16786805,\n        \"_routing\" : \"1\",\n        \"_source\" : {\n          \"content\" : \"good\"\n        }\n      },\n      {\n        \"_index\" : \"message\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"sH2gUnUBaxLQOLM-p0xC\",\n        \"_score\" : 0.13353139,\n        \"_routing\" : \"2\",\n        \"_source\" : {\n          \"content\" : \"good morning\"\n        }\n      },\n      {\n        \"_index\" : \"message\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"tX2gUnUBaxLQOLM-vkyS\",\n        \"_score\" : 0.110856235,\n        \"_routing\" : \"3\",\n        \"_source\" : {\n          \"content\" : \"good morning everyone\"\n        }\n      }\n    ]\n</code></pre>"},{"location":"chap5/6ES_Sort_query/","title":"\u7b2c\u516d\u8282 \u6392\u5e8f\u53caDoc Values&amp;Fielddata","text":""},{"location":"chap5/6ES_Sort_query/#1","title":"1\u3001\u6392\u5e8f","text":"<ul> <li>Elasticsearch \u9ed8\u8ba4\u91c7\u2f64\u76f8\u5173\u6027\u7b97\u5206\u5bf9\u7ed3\u679c\u8fdb\u2f8f\u964d\u5e8f\u6392\u5e8f</li> <li>\u53ef\u4ee5\u901a\u8fc7\u8bbe\u5b9a sorting \u53c2\u6570\uff0c\u2f83\u2f8f\u8bbe\u5b9a\u6392\u5e8f</li> <li>\u5982\u679c\u4e0d\u6307\u5b9a<code>_score</code>\uff0c\u7b97\u5206\u4e3a Null</li> </ul>"},{"location":"chap5/6ES_Sort_query/#1-1","title":"1-1 \u5355\u5b57\u6bb5\u6392\u5e8f","text":"<pre><code>#\u5355\u5b57\u6bb5\u6392\u5e8f\nPOST /kibana_sample_data_ecommerce/_search\n{\n  \"size\": 5,\n  \"query\": {\n    \"match_all\": {\n\n    }\n  },\n  \"sort\": [\n    {\"order_date\": {\"order\": \"desc\"}}\n  ]\n}\n</code></pre> <pre><code>\"_score\" : null,\n \"order_date\" : \"2020-10-10T23:45:36+00:00\", \n.....\n \"order_date\" : \"2020-10-10T23:31:12+00:00\",\n ...\n</code></pre>"},{"location":"chap5/6ES_Sort_query/#1-2","title":"1-2 \u591a\u5b57\u6bb5\u8fdb\u884c\u6392\u5e8f","text":"<ul> <li>\u7ec4\u5408\u591a\u4e2a\u6761\u4ef6</li> <li>\u4f18\u5148\u8003\u8651\u5199\u5728\u524d\u2faf\u7684\u6392\u5e8f</li> <li>\u2f40\u6301\u5bf9\u76f8\u5173\u6027\u7b97\u5206\u8fdb\u2f8f\u6392\u5e8f </li> </ul> <pre><code>#\u591a\u5b57\u6bb5\u6392\u5e8f\nPOST /kibana_sample_data_ecommerce/_search\n{\n  \"size\": 5,\n  \"query\": {\n    \"match_all\": {\n\n    }\n  },\n  \"sort\": [\n    {\"order_date\": {\"order\": \"desc\"}},\n    {\"_doc\":{\"order\": \"asc\"}},\n    {\"_score\":{ \"order\": \"desc\"}}\n  ]\n}\n</code></pre>"},{"location":"chap5/6ES_Sort_query/#2-text","title":"2\u3001\u5bf9 Text \u7c7b\u578b\u6392\u5e8f","text":"<pre><code>GET kibana_sample_data_ecommerce/_mapping\n</code></pre> <p>fielddata: \u9ed8\u8ba4\u5173\u95ed</p> <pre><code>#\u5bf9 text \u5b57\u6bb5\u8fdb\u884c\u6392\u5e8f\u3002\u9ed8\u8ba4\u4f1a\u62a5\u9519\uff0c\u9700\u6253\u5f00fielddata\nPOST /kibana_sample_data_ecommerce/_search\n{\n  \"size\": 5,\n  \"query\": {\n    \"match_all\": {\n\n    }\n  },\n  \"sort\": [\n    {\"customer_full_name\": {\"order\": \"desc\"}}\n  ]\n}\n</code></pre> <p> </p> <p>400 - Bad Request</p> <pre><code> {\n  \"error\" : {\n    \"root_cause\" : [\n      {\n        \"type\" : \"illegal_argument_exception\",\n        \"reason\" : \"Text fields are not optimised for operations that require per-document field data like aggregations and sorting, so these operations are disabled by default. Please use a keyword field instead. Alternatively, set fielddata=true on [customer_full_name] in order to load field data by uninverting the inverted index. Note that this can use significant memory.\"\n      }\n    ],\n...\n</code></pre>"},{"location":"chap5/6ES_Sort_query/#3","title":"3\u3001\u6392\u5e8f\u7684\u8fc7\u7a0b","text":"<ul> <li>\u6392\u5e8f\u662f\u9488\u5bf9\u5b57\u6bb5\u539f\u59cb\u5185\u5bb9\u8fdb\u884c\u7684\u3002 \u5012\u6392\u7d22\u5f15\u2f46\u6cd5\u53d1\u6325\u4f5c\u2f64</li> <li>\u9700\u8981\u2f64\u5230\u6b63\u6392\u7d22\u5f15\u3002\u901a\u8fc7\u2f42\u6863 Id \u548c\u5b57\u6bb5\u5feb\u901f\u5f97\u5230\u5b57\u6bb5\u539f\u59cb\u5185\u5bb9</li> <li>Elasticsearch \u6709\u4e24\u79cd\u5b9e\u73b0\u2f45\u6cd5<ul> <li>Fielddata</li> <li>Doc Values (\u5217\u5f0f\u5b58\u50a8\uff0c\u5bf9 Text \u7c7b\u578b\u2f46\u6548)</li> </ul> </li> </ul>"},{"location":"chap5/6ES_Sort_query/#3-1-doc-values-vs-field-data","title":"3-1 Doc Values vs Field Data","text":"<p>Demo</p> <ul> <li>\u5355\u5b57\u6bb5\u591a\u5b57\u6bb5\u6392\u5e8f</li> <li>\u5bf9 Text \u548c Keyword \u7c7b\u578b\u8fdb\u884c\u6392\u5e8f</li> </ul>"},{"location":"chap5/6ES_Sort_query/#4-fielddata","title":"4\u3001\u6253\u5f00 Fielddata","text":"<ul> <li>\u9ed8\u8ba4\u5173\u95ed\uff0c\u53ef\u4ee5\u901a\u8fc7 Mapping \u8bbe\u7f6e\u6253\u5f00\u3002\u4fee\u6539\u8bbe\u7f6e\u540e\uff0c\u5373\u65f6\u2f63\u6548\uff0c\u2f46\u9700\u91cd\u5efa\u7d22\u5f15</li> <li>\u5176\u4ed6\u5b57\u6bb5\u7c7b\u578b\u4e0d\u4e0d\u2f40\u652f\u6301\uff0c\u53ea\u652f\u6301\u5bf9 Text \u8fdb\u2f8f\u8bbe\u5b9a</li> <li>\u6253\u5f00\u540e\uff0c\u53ef\u4ee5\u5bf9 Text \u5b57\u6bb5\u8fdb\u2f8f\u6392\u5e8f\u3002\u4f46\u662f\u662f\u5bf9\u5206\u8bcd\u540e\u7684 term \u6392\u5e8f\uff0c\u6240\u4ee5\uff0c\u7ed3\u679c\u5f80\u5f80\u2f46\u6cd5\u6ee1\u8db3\u9884\u671f\uff0c\u4e0d\u5efa\u8bae\u4f7f\u2f64</li> <li>\u90e8\u5206\u60c5\u51b5\u4e0b\u6253\u5f00\uff0c\u6ee1\u2f9c\u2f00\u4e9b\u805a\u5408\u5206\u6790\u7684\u7279\u5b9a\u9700\u6c42</li> </ul> <p>\u6253\u5f00 text\u7684 fielddata</p> <pre><code>PUT kibana_sample_data_ecommerce/_mapping\n{\n  \"properties\": {\n    \"customer_full_name\" : {\n          \"type\" : \"text\",\n          \"fielddata\": true,\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n            }\n          }\n        }\n  }\n}\n</code></pre> <pre><code>POST /kibana_sample_data_ecommerce/_search\n{\n  \"size\": 5,\n  \"query\": {\n    \"match_all\": {\n\n    }\n  },\n  \"sort\": [\n    {\"customer_full_name\": {\"order\": \"desc\"}}\n  ]\n}\n</code></pre> <p>Output</p> <pre><code>\"customer_full_name\" : \"Yuri Foster\",\n\"customer_full_name\" : \"Yuri Roberson\",\n\"customer_full_name\" : \"Yuri Greer\",\n\"customer_full_name\" : \"Yuri Duncan\",\n</code></pre>"},{"location":"chap5/6ES_Sort_query/#5-doc-values","title":"5\u3001\u5173\u95ed Doc Values","text":"<ul> <li>\u9ed8\u8ba4\u542f\u2f64\uff0c\u53ef\u4ee5\u901a\u8fc7 Mapping \u8bbe\u7f6e\u5173\u95ed<ul> <li>\u589e\u52a0\u7d22\u5f15\u7684\u901f\u5ea6 / \u51cf\u5c11\u78c1\u76d8\u7a7a\u95f4</li> </ul> </li> <li>\u5982\u679c\u91cd\u65b0\u6253\u5f00\uff0c\u9700\u8981\u91cd\u5efa\u7d22\u5f15<ul> <li>\u4ec0\u4e48\u65f6\u5019\u9700\u8981\u5173\u95ed<ul> <li>\u660e\u786e\u4e0d\u4e0d\u9700\u8981\u505a\u6392\u5e8f\u53ca\u805a\u5408\u5206\u6790</li> </ul> </li> </ul> </li> </ul> <p>doc values\u662f\u5728\u521b\u5efa\u65f6\u6240\u4ea7\u751f\uff0c\u9ed8\u8ba4\u6253\u5f00\uff0c\u5173\u95ed\u540e\u53ef\u4ee5\u5bf9\u8001\u7684\u6570\u636e\u8fdb\u884c<code>query then update</code>\u7684\u64cd\u4f5c\uff0c\u66f4\u65b0\u7d22\u5f15</p> <p> </p> <pre><code>#\u5173\u95ed keyword\u7684 doc values\nPUT test_keyword\nPUT test_keyword/_mapping\n{\n  \"properties\": {\n    \"user_name\":{\n      \"type\": \"keyword\",\n      \"doc_values\":false\n    }\n  }\n}\n\nDELETE test_keyword\n</code></pre> <pre><code>PUT test_text\nPUT test_text/_mapping\n{\n  \"properties\": {\n    \"intro\":{\n      \"type\": \"text\",\n      \"doc_values\":true\n    }\n  }\n}\n\nDELETE test_text\n</code></pre>"},{"location":"chap5/6ES_Sort_query/#6-doc-values-fielddata","title":"6\u3001\u83b7\u53d6 Doc Values &amp; Fielddata \u4e2d\u5b58\u50a8\u7684\u5185\u5bb9","text":"<ul> <li>Text \u7c7b\u578b\u7684\u4e0d\u652f\u6301 Doc Values</li> <li>Text \u7c7b\u578b\u6253\u5f00 Fielddata\u540e\uff0c\u53ef\u4ee5\u67e5\u770b\u5206\u8bcd\u540e\u7684\u6570\u636e</li> </ul> <p>\u4f7f\u2f64 <code>docvalue_fields</code> \u67e5\u770b\u5b58\u50a8\u7684\u4fe1\u606f</p> <pre><code>DELETE temp_users\nPUT temp_users\nPUT temp_users/_mapping\n{\n  \"properties\": {\n    \"name\":{\"type\": \"text\",\"fielddata\": true},\n    \"desc\":{\"type\": \"text\",\"fielddata\": true}\n  }\n}\n</code></pre> <pre><code>POST temp_users/_doc\n{\"name\":\"Jack\",\"desc\":\"Jack is a good boy!\",\"age\":10}\n</code></pre>"},{"location":"chap5/6ES_Sort_query/#6-1-docvalue_fields","title":"6-1 \u67e5\u770b <code>docvalue_fields</code>\u6570\u636e","text":"<p>\u6253\u5f00fielddata \u540e\uff0c\u67e5\u770b <code>docvalue_fields</code>\u6570\u636e</p> <pre><code>POST  temp_users/_search\n{\n  \"docvalue_fields\": [\n    \"name\",\"desc\"\n    ]\n}\n</code></pre> <pre><code> \"hits\" : [\n      {\n        \"_index\" : \"temp_users\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"AX25U3UBaxLQOLM-FE5T\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"name\" : \"Jack\",\n          \"desc\" : \"Jack is a good boy!\",\n          \"age\" : 10\n        },\n        \"fields\" : {\n          \"name\" : [\n            \"jack\"\n          ],\n          \"desc\" : [\n            \"a\",\n            \"boy\",\n            \"good\",\n            \"is\",\n            \"jack\"\n          ]\n        }\n      }\n    ]\n</code></pre> <p>\u67e5\u770b\u6574\u578b\u5b57\u6bb5\u7684docvalues</p> <pre><code>POST  temp_users/_search\n{\n  \"docvalue_fields\": [\n    \"age\"\n    ]\n}\n</code></pre> <p>\u67e5\u770b\u6574\u578b\u5b57\u6bb5\u7684docvalues</p> <pre><code>\"hits\" : [\n      {\n        \"_index\" : \"temp_users\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"AX25U3UBaxLQOLM-FE5T\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"name\" : \"Jack\",\n          \"desc\" : \"Jack is a good boy!\",\n          \"age\" : 10\n        },\n        \"fields\" : {\n          \"age\" : [\n            10\n          ]\n        }\n      }\n    ]\n</code></pre>"},{"location":"chap5/6ES_Sort_query/#7","title":"7\u3001\u672c\u8282\u77e5\u8bc6\u70b9\u56de\u987e","text":"<ul> <li>Elasticsearch \u2f40\u6301\u2f83\u5b9a\u4e49\u6392\u5e8f</li> <li>Doc Values \u548c Fielddata \u7684\u5bf9\u2f50</li> <li>\u5982\u4f55\u8bbe\u7f6e <code>Doc Values</code> \u548c <code>Fielddata</code></li> </ul>"},{"location":"chap5/7ES_Pages_Traverse/","title":"\u7b2c\u4e03\u8282 \u5206\u9875\u4e0e\u904d\u5386 \u2013 From\uff0cSize\uff0cSearch After &amp; Scroll API","text":""},{"location":"chap5/7ES_Pages_Traverse/#1from-size","title":"1\u3001From / Size","text":"<ul> <li>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u67e5\u8be2\u6309\u7167\u76f8\u5173\u5ea6\u7b97\u5206\u6392\u5e8f\uff0c\u8fd4\u56de\u524d 10 \u6761\u8bb0\u5f55</li> <li>\u5bb9\u6613\u7406\u89e3\u7684\u5206\u9875\u65b9\u6848<ul> <li>From:\u5f00\u59cb\u4f4d\u7f6e</li> <li>Size:\u671f\u671b\u83b7\u53d6\u6587\u6863\u7684\u603b\u6570</li> </ul> </li> </ul>"},{"location":"chap5/7ES_Pages_Traverse/#2","title":"2\u3001\u5206\u5e03\u5f0f\u7cfb\u7edf\u4e2d\u6df1\u5ea6\u5206\u2eda\u7684\u95ee\u9898","text":"<ul> <li>ES \u5929\u2f63\u5c31\u662f\u5206\u5e03\u5f0f\u7684\u3002\u67e5\u8be2\u4fe1\u606f\uff0c\u4f46\u662f\u6570\u636e\u5206\u522b\u4fdd\u5b58\u5728\u591a\u4e2a\u5206\u7247\uff0c\u591a\u53f0\u673a\u5668\u4e0a\uff0cES \u5929\u751f\u5c31\u9700\u8981\u6ee1\u2f9c\u6392\u5e8f\u7684\u9700\u8981(\u6309\u7167\u76f8\u5173\u6027\u7b97\u5206)</li> <li>\u5f53\u2f00\u4e2a\u67e5\u8be2: From = 990\uff0c Size =10<ul> <li>\u4f1a\u5728\u6bcf\u4e2a\u5206\u7247\u4e0a\u5148\u90fd\u83b7\u53d6 1000 \u4e2a\u6587\u6863\u3002\u7136\u540e\uff0c \u901a\u8fc7 Coordinating Node \u805a\u5408\u6240\u6709\u7ed3\u679c\u3002\u6700\u540e \u518d\u901a\u8fc7\u6392\u5e8f\u9009\u53d6\u524d 1000 \u4e2a\u2f42\u6863</li> <li>\u2eda\u6570\u8d8a\u6df1\uff0c\u5360\u7528\u5185\u5b58\u8d8a\u591a\u3002\u4e3a\u4e86\u907f\u514d\u6df1\u5ea6\u5206\u9875\u5e26\u6765\u7684\u5185\u5b58\u5f00\u9500\u3002ES \u6709\u4e00\u4e2a\u8bbe\u5b9a\uff0c\u9ed8\u8ba4\u9650\u5b9a\u5230 10000 \u4e2a\u6587\u6863</li> <li><code>Index.max_result_window</code></li> </ul> </li> </ul> <pre><code>POST tmdb/_search\n{\n  \"from\": 10000,\n  \"size\": 1,\n  \"query\": {\n    \"match_all\": {\n\n    }\n  }\n}\n</code></pre> <pre><code>POST tmdb/_search\n{\n  \"from\": 0,\n  \"size\": 10001,\n  \"query\": {\n    \"match_all\": {\n\n    }\n  }\n}\n</code></pre>"},{"location":"chap5/7ES_Pages_Traverse/#3search-after","title":"3\u3001Search After \u907f\u514d\u6df1\u5ea6\u5206\u9875\u7684\u95ee\u9898","text":"<ul> <li> <p>\u907f\u514d\u6df1\u5ea6\u5206\u2eda\u9875\u7684\u6027\u80fd\u95ee\u9898\uff0c\u53ef\u4ee5\u5b9e\u65f6\u83b7\u53d6\u4e0b\u2f00\u2eda\u2f42\u6863\u4fe1\u606f</p> <ul> <li>\u4e0d\u652f\u6301\u6307\u5b9a\u9875\u6570(From)</li> <li>\u53ea\u80fd\u5f80\u4e0b\u7ffb</li> </ul> </li> <li> <p>\u7b2c\u2f00\u6b65\u641c\u7d22\u9700\u8981\u6307\u5b9a sort\uff0c\u5e76\u4e14\u4fdd\u8bc1\u503c\u662f\u552f\u4e00\u7684(\u53ef\u4ee5\u901a\u8fc7\u52a0\u2f0a <code>_id</code> \u4fdd\u8bc1\u552f\u2f00\u6027)</p> </li> <li>\u7136\u540e\u4f7f\u7528\u4e0a\u2f00\u6b21\uff0c\u6700\u540e\u2f00\u4e2a\u2f42\u6863\u7684 sort \u503c\u8fdb\u2f8f\u67e5\u8be2</li> </ul> <p> </p>"},{"location":"chap5/7ES_Pages_Traverse/#demo-for-search-after","title":"Demo for Search After","text":"<p>\u907f\u514d\u6df1\u5ea6\u5206\u9875\u7684\u6027\u80fd\u95ee\u9898\uff0c\u53ef\u4ee5\u5b9e\u65f6\u83b7\u53d6\u4e0b\u4e00\u2eda\u6587\u6863\u4fe1\u606f</p> <ul> <li>\u4e0d\u2f40\u6301\u6307\u5b9a\u2eda\u6570(From)</li> <li>\u53ea\u80fd\u5f80\u4e0b\u7ffb</li> </ul> <p>Search After</p> <pre><code>DELETE users\n\nPOST users/_doc\n{\"name\":\"user1\",\"age\":10}\n\nPOST users/_doc\n{\"name\":\"user2\",\"age\":11}\n\n\nPOST users/_doc\n{\"name\":\"user2\",\"age\":12}\n\nPOST users/_doc\n{\"name\":\"user2\",\"age\":13}\n\nPOST users/_count\n\n# output\n{\n  \"count\" : 4,\n  \"_shards\" : {\n    \"total\" : 1,\n    \"successful\" : 1,\n    \"skipped\" : 0,\n    \"failed\" : 0\n  }\n}\n</code></pre> <p>Output :</p> <pre><code>\"hits\" : [\n      {\n        \"_index\" : \"users\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"Z30JVHUBaxLQOLM-KE5P\",\n        \"_score\" : null,\n        \"_source\" : {\n          \"name\" : \"user2\",\n          \"age\" : 13\n        },\n        \"sort\" : [\n          13,\n          \"Z30JVHUBaxLQOLM-KE5P\"\n        ]\n      }\n    ]\n</code></pre> <ul> <li>13</li> <li><code>\"Z30JVHUBaxLQOLM-KE5P\"</code></li> </ul> <p>\u5f80\u4e0b\u7ffb</p> <pre><code>POST users/_search\n{\n    \"size\": 1,\n    \"query\": {\n        \"match_all\": {}\n    },\n    \"search_after\":\n        [\n          13,\n          \"Z30JVHUBaxLQOLM-KE5P\"],\n    \"sort\": [\n        {\"age\": \"desc\"} ,\n        {\"_id\": \"asc\"}    \n    ]\n}\n</code></pre> <p>Output</p> <pre><code>\"hits\" : [\n      {\n        \"_index\" : \"users\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"ZX0JVHUBaxLQOLM-CE4d\",\n        \"_score\" : null,\n        \"_source\" : {\n          \"name\" : \"user2\",\n          \"age\" : 11\n        },\n        \"sort\" : [\n          11,\n          \"ZX0JVHUBaxLQOLM-CE4d\"\n        ]\n      }\n    ]\n</code></pre> <ul> <li>user2, 12,   Zn0JVHUBaxLQOLM-Ek6e</li> <li>user2 11, ZX0JVHUBaxLQOLM-CE4d</li> <li>user1, 10, Y30IVHUBaxLQOLM-906J</li> <li>\"hits\" : [ ]</li> </ul>"},{"location":"chap5/7ES_Pages_Traverse/#4search-after","title":"4\u3001Search After \u662f\u5982\u4f55\u89e3\u51b3\u6df1\u5ea6\u5206\u9875\u7684\u95ee\u9898","text":"<ul> <li>\u5047\u5b9aSize\u662f10</li> <li>\u5f53\u67e5\u8be2 990 \u2013 1000</li> <li>\u901a\u8fc7\u552f\u2f00\u6392\u5e8f\u503c\u5b9a\u4f4d\uff0c\u5c06\u6bcf\u6b21\u8981\u5904\u7406\u7684\u6587\u6863\u6570\u90fd\u63a7\u5236\u5728 10</li> </ul>"},{"location":"chap5/7ES_Pages_Traverse/#5scroll-api","title":"5\u3001Scroll API","text":"<ul> <li>\u521b\u5efa\u2f00\u4e2a\u5feb\u7167\uff0c\u6709\u65b0\u7684\u6570\u636e\u5199\u5165\u4ee5\u540e\uff0c\u2f46\u6cd5\u88ab\u67e5\u5230</li> <li>\u6bcf\u6b21\u67e5\u8be2\u540e\uff0c\u8f93\u2f0a\u4e0a\u2f00\u6b21\u7684 Scroll Id</li> </ul>"},{"location":"chap5/7ES_Pages_Traverse/#5-1-demo-for-scroll-api","title":"5-1 Demo for Scroll API","text":"<p>\u63d2\u2f0a4\u6761\u8bb0\u5f55</p> <pre><code>#Scroll API\nDELETE users\nPOST users/_doc\n{\"name\":\"user1\",\"age\":10}\n\nPOST users/_doc\n{\"name\":\"user2\",\"age\":20}\n\nPOST users/_doc\n{\"name\":\"user3\",\"age\":30}\n\nPOST users/_doc\n{\"name\":\"user4\",\"age\":40}\n</code></pre> <p>\u8c03\u2f64 Scroll API, \u521b\u5efa\u2f00\u4e2a\u5feb\u7167</p> <pre><code>POST /users/_search?scroll=5m\n{\n    \"size\": 1,\n    \"query\": {\n        \"match_all\" : {\n        }\n    }\n}\n</code></pre> <p><code>scroll=5m</code>: \u6700\u597d\u8bbe\u7f6e\u7684\u4e0d\u8981\u8fc7\u5927\uff0c\u5728\u4e00\u5206\u949f\u62165\u5206\u949f\u540e\u4f1a\u5931\u6548\u7684\u610f\u601d</p> <pre><code>...\n\"max_score\" : 1.0,\n    \"hits\" : [\n      {\n        \"_index\" : \"users\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"i30sVHUBaxLQOLM-706K\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"name\" : \"user1\",\n          \"age\" : 10\n        }\n      }\n    ]\n</code></pre> <ul> <li><code>\"_scroll_id\" : \"FGluY2x1ZGVfY29udGV4dF91dWlkDXF1ZXJ5QW5kRmV0Y2gBFDBuczRWSFVCUzd6ekR6aElZWHN6AAAAAAAADX4WbFRGRDZxQkNRNDYweGRXOFhGZ2FJZw==\"</code></li> </ul> <p>\u63d2\u2f0a\u2f00\u6761\u65b0\u7684\u8bb0\u5f55</p> <pre><code>POST users/_doc\n{\"name\":\"user5\",\"age\":50}\n</code></pre> <p>\u53d1\u73b0\u53ea\u80fd\u67e5\u5230 4 \u6761\u6570\u636e</p> <pre><code>POST /_search/scroll\n{\n    \"scroll\" : \"1m\",\n    \"scroll_id\" : \"FGluY2x1ZGVfY29udGV4dF91dWlkDXF1ZXJ5QW5kRmV0Y2gBFDBuczRWSFVCUzd6ekR6aElZWHN6AAAAAAAADX4WbFRGRDZxQkNRNDYweGRXOFhGZ2FJZw==\"\n}\n</code></pre>"},{"location":"chap5/7ES_Pages_Traverse/#6","title":"6\u3001\u4e0d\u540c\u7684\u641c\u7d22\u7c7b\u578b\u548c\u4f7f\u2f64\u573a\u666f","text":"<ul> <li>Regular<ul> <li>\u9700\u8981\u5b9e\u65f6\u83b7\u53d6\u9876\u90e8\u7684\u90e8\u5206\u6587\u6863\u3002\u4f8b\u5982\u67e5\u8be2\u6700\u65b0\u7684\u8ba2\u5355</li> </ul> </li> <li>Scroll<ul> <li>\u9700\u8981\u5168\u90e8\u2f42\u6863\uff0c\u4f8b\u5982\u5bfc\u51fa\u5168\u90e8\u6570\u636e</li> </ul> </li> <li>Pagination<ul> <li>From \u548c Size</li> <li>\u5982\u679c\u9700\u8981\u6df1\u5ea6\u5206\u9875\uff0c\u5219\u9009\u2f64 Search After</li> </ul> </li> </ul>"},{"location":"chap5/7ES_Pages_Traverse/#7","title":"7\u3001\u672c\u8282\u77e5\u8bc6\u70b9\u56de\u987e","text":"<ul> <li>Elasticsearch \u9ed8\u8ba4\u8fd4\u56de 10 \u4e2a\u7ed3\u679c</li> <li>\u4e3a\u4e86\u83b7\u53d6\u66f4\u591a\u7684\u7ed3\u679c\uff0c\u63d0\u4f9b 3 \u79cd\u2f45\u5f0f\u89e3\u51b3\u5206\u2eda\u4e0e\u904d\u5386<ul> <li>From / Size \u7684\u2f64\u6cd5\uff0c\u6df1\u5ea6\u5206\u9875\u6240\u5b58\u5728\u7684\u95ee\u9898</li> <li>Search After \u89e3\u51b3\u6df1\u5ea6\u5206\u9875\u7684\u95ee\u9898</li> <li>Scroll API\uff0c\u901a\u8fc7\u5feb\u7167\uff0c\u904d\u5386\u6570\u636e</li> </ul> </li> </ul>"},{"location":"chap5/8ES_Concurrent_process/","title":"\u7b2c\u516b\u8282 \u5904\u7406\u5e76\u53d1\u8bfb\u5199\u64cd\u4f5c","text":""},{"location":"chap5/8ES_Concurrent_process/#1","title":"1\u3001\u5e76\u53d1\u63a7\u5236\u7684\u5fc5\u8981\u6027","text":"<ul> <li>\u4e24\u4e2a Web \u7a0b\u5e8f\u540c\u65f6\u66f4\u65b0\u67d0\u4e2a\u2f42\u6863\uff0c\u5982\u679c\u7f3a\u4e4f\u6709\u6548\u7684\u5e76\u53d1\uff0c\u4f1a\u5bfc\u81f4\u66f4\u6539\u7684\u6570\u636e\u4e22\u5931</li> <li>\u60b2\u89c2\u5e76\u53d1\u63a7\u5236<ul> <li>\u5047\u5b9a\u6709\u53d8\u66f4\u51b2\u7a81\u7684\u53ef\u80fd\u3002\u4f1a\u5bf9\u8d44\u6e90\u52a0\u9501\uff0c\u9632\u6b62\u51b2\u7a81\u3002\u4f8b\u5982\u6570\u636e\u5e93\u2f8f\u9501 </li> </ul> </li> <li>\u4e50\u89c2\u5e76\u53d1\u63a7\u5236<ul> <li>\u5047\u5b9a\u51b2\u7a81\u662f\u4e0d\u4f1a\u53d1\u2f63\u7684\uff0c\u4e0d\u4f1a\u963b\u585e\u6b63\u5728\u5c1d\u8bd5\u7684\u64cd\u4f5c\u3002\u5982\u679c\u6570\u636e\u5728\u8bfb\u5199\u4e2d\u88ab\u4fee\u6539\uff0c\u66f4\u65b0\u5c06\u4f1a\u5931\u8d25\u3002 \u5e94\u2f64\u7a0b\u5e8f\u51b3\u5b9a\u5982\u4f55\u89e3\u51b3\u51b2\u7a81\uff0c\u4f8b\u5982\u91cd\u8bd5\u66f4\u65b0\uff0c\u4f7f\u2f64\u65b0\u7684\u6570\u636e\uff0c\u6216\u8005\u5c06\u9519\u8bef\u62a5\u544a\u7ed9\u2f64\u6237</li> <li>ES \u91c7\u2f64\u7684\u662f\u4e50\u89c2\u5e76\u53d1\u63a7\u5236</li> </ul> </li> </ul>"},{"location":"chap5/8ES_Concurrent_process/#2es","title":"2\u3001ES \u7684\u4e50\u89c2\u5e76\u53d1\u63a7\u5236","text":"<ul> <li>ES \u4e2d\u7684\u2f42\u6863\u662f\u4e0d\u53ef\u53d8\u66f4\u7684\u3002\u5982\u679c\u4f60\u66f4\u65b0\u2f00\u4e2a\u2f42\u6863\uff0c\u4f1a\u5c06\u5c31\u6587\u6863\u6807\u8bb0\u4e3a\u5220\u9664\uff0c\u540c\u65f6\u589e\u52a0\u4e00\u4e2a\u5168\u65b0\u7684\u2f42\u6863\u3002\u540c\u65f6\u2f42\u6863 \u7684 version \u5b57\u6bb5\u52a0 1</li> <li>\u5185\u90e8\u7248\u672c\u63a7\u5236<ul> <li><code>If_seq_no + If_primary_term</code></li> </ul> </li> <li>\u4f7f\u2f64\u5916\u90e8\u7248\u672c(\u4f7f\u2f64\u5176\u4ed6\u6570\u636e\u5e93\u4f5c\u4e3a\u4e3b\u8981\u6570\u636e\u5b58\u50a8)<ul> <li><code>version + version_type=external</code></li> </ul> </li> </ul> <pre><code>DELETE products\nPUT products\n</code></pre> <p>Output</p> <pre><code>{\n  \"acknowledged\" : true,\n  \"shards_acknowledged\" : true,\n  \"index\" : \"products\"\n}\n</code></pre> <pre><code>GET products/_doc/1\n</code></pre> <pre><code>{\n  \"_index\" : \"products\",\n  \"_type\" : \"_doc\",\n  \"_id\" : \"1\",\n  \"_version\" : 1,\n  \"_seq_no\" : 0,\n  \"_primary_term\" : 1,\n  \"found\" : true,\n  \"_source\" : {\n    \"title\" : \"iphone\",\n    \"count\" : 100\n  }\n}\n</code></pre>"},{"location":"chap5/8ES_Concurrent_process/#2-1-if_seq_no-if_primary_term","title":"2-1 \u5185\u90e8\u7248\u672c\u63a7\u5236:  <code>If_seq_no + If_primary_term</code>","text":"<pre><code>PUT products/_doc/1?if_seq_no=0&amp;if_primary_term=1\n{\n  \"title\":\"iphone\",\n  \"count\":100\n}\n</code></pre> <p>Output:</p> <pre><code>{\n  \"_index\" : \"products\",\n  \"_type\" : \"_doc\",\n  \"_id\" : \"1\",\n  \"_version\" : 2,\n  \"result\" : \"updated\",\n  \"_shards\" : {\n    \"total\" : 2,\n    \"successful\" : 2,\n    \"failed\" : 0\n  },\n  \"_seq_no\" : 1,\n  \"_primary_term\" : 1\n}\n</code></pre> <ul> <li><code>if_seq_no=0&amp;if_primary_term=1</code></li> <li>\u6539\u53d8 count \u5230 99</li> </ul> <pre><code>PUT products/_doc/1?if_seq_no=0&amp;if_primary_term=1\n{\n  \"title\":\"iphone\",\n  \"count\":99\n}\n</code></pre> <p>Output: 409 - Conflict</p> <pre><code>{\n  \"error\" : {\n    \"root_cause\" : [\n      {\n        \"type\" : \"version_conflict_engine_exception\",\n        \"reason\" : \"[1]: version conflict, required seqNo [0], primary term [1]. current document has seqNo [1] and primary term [1]\",\n        \"index_uuid\" : \"YrNla_cjTweku9BxzjH2Ig\",\n        \"shard\" : \"0\",\n        \"index\" : \"products\"\n      }\n    ],\n    \"type\" : \"version_conflict_engine_exception\",\n    \"reason\" : \"[1]: version conflict, required seqNo [0], primary term [1]. current document has seqNo [1] and primary term [1]\",\n    \"index_uuid\" : \"YrNla_cjTweku9BxzjH2Ig\",\n    \"shard\" : \"0\",\n    \"index\" : \"products\"\n  },\n  \"status\" : 409\n}\n</code></pre>"},{"location":"chap5/8ES_Concurrent_process/#2-2-version-version_typeexternal","title":"2-2 \u4f7f\u2f64\u5916\u90e8\u7248\u672c\uff1a  <code>version + version_type=external</code>","text":"<pre><code>PUT products/_doc/1?version=30000&amp;version_type=external\n{\n  \"title\":\"iphone\",\n  \"count\":100\n}\n</code></pre> <p>Output</p> <pre><code>{\n  \"_index\" : \"products\",\n  \"_type\" : \"_doc\",\n  \"_id\" : \"1\",\n  \"_version\" : 30000,\n  \"result\" : \"updated\",\n  \"_shards\" : {\n    \"total\" : 2,\n    \"successful\" : 2,\n    \"failed\" : 0\n  },\n  \"_seq_no\" : 2,\n  \"_primary_term\" : 1\n}\n</code></pre> <ul> <li><code>\"_version\" : 30000</code></li> <li>\u6539\u53d8 count \u5230 99</li> </ul> <pre><code>PUT products/_doc/1?version=30000&amp;version_type=external\n{\n  \"title\":\"iphone\",\n  \"count\":99\n}\n</code></pre> <p>Output: 409 - Conflict</p> <pre><code>{\n  \"error\" : {\n    \"root_cause\" : [\n      {\n        \"type\" : \"version_conflict_engine_exception\",\n        \"reason\" : \"[1]: version conflict, current version [30000] is higher or equal to the one provided [30000]\",\n        \"index_uuid\" : \"YrNla_cjTweku9BxzjH2Ig\",\n        \"shard\" : \"0\",\n        \"index\" : \"products\"\n      }\n    ],\n    \"type\" : \"version_conflict_engine_exception\",\n    \"reason\" : \"[1]: version conflict, current version [30000] is higher or equal to the one provided [30000]\",\n    \"index_uuid\" : \"YrNla_cjTweku9BxzjH2Ig\",\n    \"shard\" : \"0\",\n    \"index\" : \"products\"\n  },\n  \"status\" : 409\n}\n\n</code></pre>"},{"location":"chap6/1chap6_bucket_metrics/","title":"\u7b2c\u4e00\u8282 Bucket &amp; Metric \u805a\u5408\u5206\u6790\u53ca\u5d4c\u5957\u805a\u5408","text":""},{"location":"chap6/1chap6_bucket_metrics/#1bucket-metric-aggregation","title":"1\u3001Bucket &amp; Metric Aggregation","text":"<ul> <li>Metric \u2014\u2014 \u2f00\u4e9b\u7cfb\u5217\u7684\u7edf\u8ba1\u2f45\u6cd5</li> <li>Bucket \u2014\u2014 \u2f00\u7ec4\u6ee1\u8db3\u6761\u4ef6\u7684\u6587\u6863</li> </ul>"},{"location":"chap6/1chap6_bucket_metrics/#2aggregation","title":"2\u3001Aggregation \u7684\u8bed\u6cd5","text":"<p>Aggregation \u5c5e\u4e8e Search \u7684 \u4e00\u90e8\u5206\u3002\u4e00\u822c\u60c5\u51b5\u4e0b\uff0c\u5efa\u8bae\u5c06\u5176 Size \u6307\u5b9a\u4e3a 0</p> <p></p>"},{"location":"chap6/1chap6_bucket_metrics/#3","title":"3\u3001\u2f00\u4e2a\u4f8b\u5b50:\u2f2f\u8d44\u7edf\u8ba1\u4fe1\u606f","text":""},{"location":"chap6/1chap6_bucket_metrics/#4metric-aggregation","title":"4\u3001Metric Aggregation","text":""},{"location":"chap6/1chap6_bucket_metrics/#4-1","title":"4-1 \u5355\u503c\u5206\u6790:\u53ea\u8f93\u51fa\u2f00\u4e2a\u5206\u6790\u7ed3\u679c","text":"<ul> <li>min, max, avg, sum</li> <li>Cardinality (\u7c7b\u4f3c distinct Count)</li> </ul>"},{"location":"chap6/1chap6_bucket_metrics/#4-2","title":"4-2 \u591a\u503c\u5206\u6790:\u8f93\u51fa\u591a\u4e2a\u5206\u6790\u7ed3\u679c","text":"<ul> <li>stats, extended stats</li> <li>percentile, percentile rank</li> <li>top hits (\u6392\u5728\u524d\u2faf\u7684\u793a\u4f8b)</li> </ul>"},{"location":"chap6/1chap6_bucket_metrics/#5metric-demo","title":"5\u3001Metric \u805a\u5408\u7684\u5177\u4f53 Demo","text":"<ul> <li>\u67e5\u770b\u6700\u4f4e\u2f2f\u8d44</li> <li>\u67e5\u770b\u6700\u2fbc\u2f2f\u8d44</li> <li>\u2f00\u4e2a\u805a\u5408\u8f93\u51fa\u591a\u4e2a\u503c</li> <li>\u4e00\u6b21\u67e5\u8be2\u5305\u542b\u591a\u4e2a\u805a\u5408<ul> <li>\u540c\u65f6\u67e5\u770b\u6700\u4f4e\uff0c\u6700\u2fbc\u548c\u5e73\u5747\u5de5\u8d44</li> </ul> </li> </ul> <pre><code>DELETE /employees\n\nPUT /employees/\n{\n  \"mappings\" : {\n      \"properties\" : {\n        \"age\" : {\n          \"type\" : \"integer\"\n        },\n        \"gender\" : {\n          \"type\" : \"keyword\"\n        },\n        \"job\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 50\n            }\n          }\n        },\n        \"name\" : {\n          \"type\" : \"keyword\"\n        },\n        \"salary\" : {\n          \"type\" : \"integer\"\n        }\n      }\n    }\n}\n</code></pre> <ul> <li>job: text<ul> <li><code>keyword: keyword</code></li> </ul> </li> <li>name: keyword</li> </ul> <p>Output:</p> <pre><code>{\n  \"acknowledged\" : true,\n  \"shards_acknowledged\" : true,\n  \"index\" : \"employees\"\n}\n</code></pre> <pre><code>PUT /employees/_bulk\n{ \"index\" : {  \"_id\" : \"1\" } }\n{ \"name\" : \"Emma\",\"age\":32,\"job\":\"Product Manager\",\"gender\":\"female\",\"salary\":35000 }\n{ \"index\" : {  \"_id\" : \"2\" } }\n{ \"name\" : \"Underwood\",\"age\":41,\"job\":\"Dev Manager\",\"gender\":\"male\",\"salary\": 50000}\n{ \"index\" : {  \"_id\" : \"3\" } }\n{ \"name\" : \"Tran\",\"age\":25,\"job\":\"Web Designer\",\"gender\":\"male\",\"salary\":18000 }\n{ \"index\" : {  \"_id\" : \"4\" } }\n{ \"name\" : \"Rivera\",\"age\":26,\"job\":\"Web Designer\",\"gender\":\"female\",\"salary\": 22000}\n{ \"index\" : {  \"_id\" : \"5\" } }\n{ \"name\" : \"Rose\",\"age\":25,\"job\":\"QA\",\"gender\":\"female\",\"salary\":18000 }\n{ \"index\" : {  \"_id\" : \"6\" } }\n{ \"name\" : \"Lucy\",\"age\":31,\"job\":\"QA\",\"gender\":\"female\",\"salary\": 25000}\n{ \"index\" : {  \"_id\" : \"7\" } }\n{ \"name\" : \"Byrd\",\"age\":27,\"job\":\"QA\",\"gender\":\"male\",\"salary\":20000 }\n{ \"index\" : {  \"_id\" : \"8\" } }\n{ \"name\" : \"Foster\",\"age\":27,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 20000}\n{ \"index\" : {  \"_id\" : \"9\" } }\n{ \"name\" : \"Gregory\",\"age\":32,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\":22000 }\n{ \"index\" : {  \"_id\" : \"10\" } }\n{ \"name\" : \"Bryant\",\"age\":20,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 9000}\n{ \"index\" : {  \"_id\" : \"11\" } }\n{ \"name\" : \"Jenny\",\"age\":36,\"job\":\"Java Programmer\",\"gender\":\"female\",\"salary\":38000 }\n{ \"index\" : {  \"_id\" : \"12\" } }\n{ \"name\" : \"Mcdonald\",\"age\":31,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 32000}\n{ \"index\" : {  \"_id\" : \"13\" } }\n{ \"name\" : \"Jonthna\",\"age\":30,\"job\":\"Java Programmer\",\"gender\":\"female\",\"salary\":30000 }\n{ \"index\" : {  \"_id\" : \"14\" } }\n{ \"name\" : \"Marshall\",\"age\":32,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 25000}\n{ \"index\" : {  \"_id\" : \"15\" } }\n{ \"name\" : \"King\",\"age\":33,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\":28000 }\n{ \"index\" : {  \"_id\" : \"16\" } }\n{ \"name\" : \"Mccarthy\",\"age\":21,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 16000}\n{ \"index\" : {  \"_id\" : \"17\" } }\n{ \"name\" : \"Goodwin\",\"age\":25,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 16000}\n{ \"index\" : {  \"_id\" : \"18\" } }\n{ \"name\" : \"Catherine\",\"age\":29,\"job\":\"Javascript Programmer\",\"gender\":\"female\",\"salary\": 20000}\n{ \"index\" : {  \"_id\" : \"19\" } }\n{ \"name\" : \"Boone\",\"age\":30,\"job\":\"DBA\",\"gender\":\"male\",\"salary\": 30000}\n{ \"index\" : {  \"_id\" : \"20\" } }\n{ \"name\" : \"Kathy\",\"age\":29,\"job\":\"DBA\",\"gender\":\"female\",\"salary\": 20000}\n</code></pre> <p>Output:</p> <pre><code>{\n  \"took\" : 110,\n  \"errors\" : false,\n  \"items\" : [\n    {\n      \"index\" : {\n        \"_index\" : \"employees\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"1\",\n        \"_version\" : 1,\n        \"result\" : \"created\",\n        \"_shards\" : {\n          \"total\" : 2,\n          \"successful\" : 2,\n          \"failed\" : 0\n        },\n        \"_seq_no\" : 0,\n        \"_primary_term\" : 1,\n        \"status\" : 201\n      }\n    },\n ...\n</code></pre>"},{"location":"chap6/1chap6_bucket_metrics/#5-1-metric","title":"5-1 Metric \u805a\u5408\uff0c\u627e\u5230\u6700\u4f4e\u7684\u5de5\u8d44","text":"<pre><code># Metric \u805a\u5408\uff0c\u627e\u5230\u6700\u4f4e\u7684\u5de5\u8d44\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"min_salary\": {\n      \"min\": {\n        \"field\":\"salary\"\n      }\n    }\n  }\n}\n</code></pre> <p>Output</p> <pre><code>\"hits\" : {\n    \"total\" : {\n      \"value\" : 20,\n      \"relation\" : \"eq\"\n    },\n    \"max_score\" : null,\n    \"hits\" : [ ]\n  },\n  \"aggregations\" : {\n    \"min_salary\" : {\n      \"value\" : 9000.0\n    }\n  }\n</code></pre>"},{"location":"chap6/1chap6_bucket_metrics/#5-2-metric","title":"5-2 Metric \u805a\u5408\uff0c\u627e\u5230\u6700\u9ad8\u7684\u5de5\u8d44","text":"<pre><code># Metric \u805a\u5408\uff0c\u627e\u5230\u6700\u9ad8\u7684\u5de5\u8d44\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"max_salary\": {\n      \"max\": {\n        \"field\":\"salary\"\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"chap6/1chap6_bucket_metrics/#5-3-metric","title":"5-3 \u591a\u4e2a Metric \u805a\u5408\uff0c\u627e\u5230\u6700\u4f4e\u6700\u9ad8\u548c\u5e73\u5747\u5de5\u8d44","text":"<pre><code>POST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"max_salary\": {\n      \"max\": {\n        \"field\": \"salary\"\n      }\n    },\n    \"min_salary\": {\n      \"min\": {\n        \"field\": \"salary\"\n      }\n    },\n    \"avg_salary\": {\n      \"avg\": {\n        \"field\": \"salary\"\n      }\n    }\n  }\n}\n</code></pre> <p>Output</p> <pre><code>\"aggregations\" : {\n    \"max_salary\" : {\n      \"value\" : 50000.0\n    },\n    \"avg_salary\" : {\n      \"value\" : 24700.0\n    },\n    \"min_salary\" : {\n      \"value\" : 9000.0\n    }\n  }\n</code></pre>"},{"location":"chap6/1chap6_bucket_metrics/#5-4","title":"5-4 \u4e00\u4e2a\u805a\u5408\uff0c\u8f93\u51fa\u591a\u503c","text":"<pre><code>POST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"stats_salary\": {\n      \"stats\": {\n        \"field\":\"salary\"\n      }\n    }\n  }\n}\n</code></pre> <p>Output:</p> <pre><code>\"aggregations\" : {\n    \"stats_salary\" : {\n      \"count\" : 20,\n      \"min\" : 9000.0,\n      \"max\" : 50000.0,\n      \"avg\" : 24700.0,\n      \"sum\" : 494000.0\n    }\n  }\n</code></pre>"},{"location":"chap6/1chap6_bucket_metrics/#6bucket","title":"6\u3001Bucket","text":"<ul> <li>\u6309\u7167\u2f00\u5b9a\u7684\u89c4\u5219\uff0c\u5c06\u2f42\u6863\u5206\u914d\u5230\u4e0d\u540c\u7684\u6876\u4e2d\uff0c\u4ece\u2f7d\u8fbe\u5230\u5206\u7c7b\u7684\u2f6c\u7684\u3002ES \u63d0\u4f9b\u7684\u4e00\u4e9b\u5e38\u89c1\u7684 Bucket Aggregation<ul> <li>Terms</li> <li>\u6570\u5b57\u7c7b\u578b<ul> <li>Range / Data Range</li> <li>Histogram / Date Histogram</li> </ul> </li> </ul> </li> <li>\u652f\u6301\u5d4c\u5957:\u4e5f\u5c31\u5728\u6876\u91cc\u518d\u505a\u5206\u6876</li> </ul>"},{"location":"chap6/1chap6_bucket_metrics/#7terms-aggregation","title":"7\u3001Terms Aggregation","text":"<ul> <li> <p>\u5b57\u6bb5\u9700\u8981\u6253\u5f00 fielddata\uff0c\u624d\u80fd\u8fdb\u884c Terms Aggregation</p> <ul> <li>Keyword \u9ed8\u8ba4\u652f\u6301 <code>doc_values</code></li> <li>Text \u9700\u8981\u5728 Mapping \u4e2d enable\u3002\u4f1a\u6309\u7167\u5206\u8bcd\u540e\u7684\u7ed3\u679c\u8fdb\u2f8f\u5206\u7c7b</li> </ul> </li> <li> <p>Demo</p> <ul> <li>\u5bf9 <code>job</code> \u548c <code>job.keyword</code> \u8fdb\u2f8f\u805a\u5408</li> <li>\u5bf9\u6027\u522b\u8fdb\u2f8f Terms \u805a\u5408</li> <li>\u6307\u5b9a bucket size</li> </ul> </li> </ul>"},{"location":"chap6/1chap6_bucket_metrics/#7-1-keword","title":"7-1 \u5bf9keword \u8fdb\u884c\u805a\u5408","text":"<pre><code>POST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\"\n      }\n    }\n  }\n}\n</code></pre> <p><code>\"field\":\"job.keyword\"</code></p> <pre><code>\"aggregations\" : {\n    \"jobs\" : {\n      \"doc_count_error_upper_bound\" : 0,\n      \"sum_other_doc_count\" : 0,\n      \"buckets\" : [\n        {\n          \"key\" : \"Java Programmer\",\n          \"doc_count\" : 7\n        },\n        {\n          \"key\" : \"Javascript Programmer\",\n          \"doc_count\" : 4\n        },\n        {\n          \"key\" : \"QA\",\n          \"doc_count\" : 3\n        },\n        {\n          \"key\" : \"DBA\",\n          \"doc_count\" : 2\n        },\n        {\n          \"key\" : \"Web Designer\",\n          \"doc_count\" : 2\n        },\n        {\n          \"key\" : \"Dev Manager\",\n          \"doc_count\" : 1\n        },\n        {\n          \"key\" : \"Product Manager\",\n          \"doc_count\" : 1\n        }\n      ]\n    }\n  }\n</code></pre> <ul> <li>Java Programmer, Javascript Programmer, QA, DBA, Web Designer, Dev Manager, Product Manager</li> </ul>"},{"location":"chap6/1chap6_bucket_metrics/#7-2-text-terms","title":"7-2 \u5bf9 Text \u5b57\u6bb5\u8fdb\u884c terms \u805a\u5408\u67e5\u8be2\uff0c\u5931\u8d25","text":"<pre><code># \u5bf9 Text \u5b57\u6bb5\u8fdb\u884c terms \u805a\u5408\u67e5\u8be2\uff0c\u5931\u8d25\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job\"\n      }\n    }\n  }\n }\n</code></pre> <p>Output</p> <pre><code>{\n  \"error\" : {\n    \"root_cause\" : [\n      {\n        \"type\" : \"illegal_argument_exception\",\n        \"reason\" : \"Text fields are not optimised for operations that require per-document field data like aggregations and sorting, so these operations are disabled by default. Please use a keyword field instead. Alternatively, set fielddata=true on [job] in order to load field data by uninverting the inverted index. Note that this can use significant memory.\"\n      }\n    ],\n    \"type\" : \"search_phase_execution_exception\",\n    \"reason\" : \"all shards failed\",\n    \"phase\" : \"query\",\n    \"grouped\" : true,\n    \"failed_shards\" : [\n      {\n        \"shard\" : 0,\n        \"index\" : \"employees\",\n        \"node\" : \"L7jf3HA8TqOEtNY8BrU82A\",\n</code></pre> <p>\u5bf9 Text \u5b57\u6bb5\u6253\u5f00 fielddata\uff0c\u652f\u6301terms aggregation</p> <pre><code>PUT employees/_mapping\n{\n  \"properties\" : {\n    \"job\":{\n       \"type\":     \"text\",\n       \"fielddata\": true\n    }\n  }\n}\n</code></pre> <p>\u5bf9 Text \u5b57\u6bb5\u8fdb\u884c terms \u5206\u8bcd\u3002\u5206\u8bcd\u540e\u7684terms</p> <pre><code>POST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job\"\n      }\n    }\n  }\n}\n</code></pre> <p>Output</p> <pre><code>\"aggregations\" : {\n    \"jobs\" : {\n      \"doc_count_error_upper_bound\" : 0,\n      \"sum_other_doc_count\" : 0,\n      \"buckets\" : [\n        {\n          \"key\" : \"programmer\",\n          \"doc_count\" : 11\n        },\n        {\n          \"key\" : \"java\",\n          \"doc_count\" : 7\n        },\n        {\n          \"key\" : \"javascript\",\n          \"doc_count\" : 4\n        },\n        {\n          \"key\" : \"qa\",\n          \"doc_count\" : 3\n        },\n        {\n          \"key\" : \"dba\",\n          \"doc_count\" : 2\n        },\n        {\n          \"key\" : \"designer\",\n          \"doc_count\" : 2\n        },\n        {\n          \"key\" : \"manager\",\n          \"doc_count\" : 2\n        },\n        {\n          \"key\" : \"web\",\n          \"doc_count\" : 2\n        },\n        {\n          \"key\" : \"dev\",\n          \"doc_count\" : 1\n        },\n        {\n          \"key\" : \"product\",\n          \"doc_count\" : 1\n        }\n      ]\n    }\n  }\n</code></pre>"},{"location":"chap6/1chap6_bucket_metrics/#7-3-jobkeyword-job-terms","title":"7-3 \u5bf9<code>job.keyword</code> \u548c <code>job</code> \u8fdb\u884c <code>terms</code> \u805a\u5408\uff0c\u5206\u6876\u7684\u603b\u6570\u5e76\u4e0d\u4e00\u6837","text":"<pre><code>POST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\"\n      }\n    }\n  }\n}\n</code></pre> <p>Output:</p> <pre><code>\"buckets\" : [\n        {\n          \"key\" : \"Java Programmer\",\n          \"doc_count\" : 7\n        },\n        {\n          \"key\" : \"Javascript Programmer\",\n          \"doc_count\" : 4\n        },\n        {\n          \"key\" : \"QA\",\n          \"doc_count\" : 3\n        },\n        {\n...\n</code></pre>"},{"location":"chap6/1chap6_bucket_metrics/#8-cardinality","title":"8\u3001 Cardinality","text":"<p>\u7c7b\u4f3c SQL \u4e2d\u7684 Distinct</p> <p>\u5bf9 <code>job.keyword</code> \u548c <code>job</code> \u8fdb\u884c <code>terms</code> \u805a\u5408\uff0c\u5206\u6876\u7684\u603b\u6570\u5e76\u4e0d\u4e00\u6837</p>"},{"location":"chap6/1chap6_bucket_metrics/#8-1-field-job","title":"8-1  <code>\"field\": \"job\"</code>","text":"<pre><code>POST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"cardinate\": {\n      \"cardinality\": {\n        \"field\": \"job\"\n      }\n    }\n  }\n}\n</code></pre> <p>Output:</p> <pre><code>\"aggregations\" : {\n    \"cardinate\" : {\n      \"value\" : 10\n    }\n  }\n}\n</code></pre>"},{"location":"chap6/1chap6_bucket_metrics/#8-2-field-jobkeyword","title":"8-2 <code>\"field\": \"job.keyword\"</code>","text":"<pre><code>POST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"cardinate\": {\n      \"cardinality\": {\n        \"field\": \"job.keyword\"\n      }\n    }\n  }\n}\n</code></pre> <p>Output:</p> <pre><code>\"aggregations\" : {\n    \"cardinate\" : {\n      \"value\" : 7\n    }\n  }\n</code></pre>"},{"location":"chap6/1chap6_bucket_metrics/#9bucket-size-top-hits-demo","title":"9\u3001Bucket Size &amp; Top Hits Demo","text":"<ul> <li>\u5e94\u2f64\u573a\u666f:\u5f53\u83b7\u53d6\u5206\u6876\u540e\uff0c\u6876\u5185\u6700\u5339\u914d\u7684\u9876\u90e8\u2f42\u6863\u5217\u5217\u8868 </li> <li>Size:\u6309\u5e74\u9f84\u5206\u6876\uff0c\u627e\u51fa\u6307\u5b9a\u6570\u636e\u91cf\u7684\u5206\u6876\u4fe1\u606f</li> <li>Top Hits:\u67e5\u770b\u5404\u4e2a\u2f2f\u79cd\u4e2d\uff0c\u5e74\u7eaa\u6700\u2f24\u7684 3 \u540d\u5458\u5de5</li> </ul> <pre><code># \u5bf9 \u6027\u522b\u7684 keyword \u8fdb\u884c\u805a\u5408\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"gender\": {\n      \"terms\": {\n        \"field\":\"gender\"\n      }\n    }\n  }\n}\n</code></pre> <p>Output</p> <pre><code>\"aggregations\" : {\n    \"gender\" : {\n      \"doc_count_error_upper_bound\" : 0,\n      \"sum_other_doc_count\" : 0,\n      \"buckets\" : [\n        {\n          \"key\" : \"male\",\n          \"doc_count\" : 12\n        },\n        {\n          \"key\" : \"female\",\n          \"doc_count\" : 8\n        }\n      ]\n    }\n  }\n</code></pre>"},{"location":"chap6/1chap6_bucket_metrics/#9-1-bucket-size","title":"9-1 \u6307\u5b9a bucket \u7684 size","text":"<pre><code>POST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"ages_5\": {\n      \"terms\": {\n        \"field\":\"age\",\n        \"size\":3\n      }\n    }\n  }\n}\n</code></pre> <p>Output</p> <pre><code>\"aggregations\" : {\n    \"ages_5\" : {\n      \"doc_count_error_upper_bound\" : 0,\n      \"sum_other_doc_count\" : 12,\n      \"buckets\" : [\n        {\n          \"key\" : 25,\n          \"doc_count\" : 3\n        },\n        {\n          \"key\" : 32,\n          \"doc_count\" : 3\n        },\n        {\n          \"key\" : 27,\n          \"doc_count\" : 2\n        }\n      ]\n    }\n  }\n</code></pre>"},{"location":"chap6/1chap6_bucket_metrics/#9-2-terms","title":"9-2 \u4f18\u5316 Terms \u805a\u5408\u7684\u6027\u80fd","text":"<p>https://www.elastic.co/guide/en/elasticsearch/reference/7.1/tune-for-search-speed.html</p> <p>\u6307\u5b9asize\uff0c\u4e0d\u540c\u5de5\u79cd\u4e2d\uff0c\u5e74\u7eaa\u6700\u5927\u76843\u4e2a\u5458\u5de5\u7684\u5177\u4f53\u4fe1\u606f</p> <pre><code>POST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\"\n      },\n      \"aggs\":{\n        \"old_employee\":{\n          \"top_hits\":{\n            \"size\":3,\n            \"sort\":[\n              {\n                \"age\":{\n                  \"order\":\"desc\"\n                }\n              }\n            ]\n          }\n        }\n      }\n    }\n  }\n}\n</code></pre> <p>Output</p> <pre><code>\"aggregations\" : {\n    \"jobs\" : {\n      \"doc_count_error_upper_bound\" : 0,\n      \"sum_other_doc_count\" : 0,\n      \"buckets\" : [\n        {\n          \"key\" : \"Java Programmer\",\n          \"doc_count\" : 7,\n          \"old_employee\" : {\n            \"hits\" : {\n              \"total\" : {\n                \"value\" : 7,\n                \"relation\" : \"eq\"\n              },\n              \"max_score\" : null,\n              \"hits\" : [\n                {\n                  \"_index\" : \"employees\",\n                  \"_type\" : \"_doc\",\n                  \"_id\" : \"11\",\n                  \"_score\" : null,\n                  \"_source\" : {\n                    \"name\" : \"Jenny\",\n                    \"age\" : 36,\n                    \"job\" : \"Java Programmer\",\n                    \"gender\" : \"female\",\n                    \"salary\" : 38000\n                  },\n                  \"sort\" : [\n                    36\n                  ]\n                },\n ...\n</code></pre>"},{"location":"chap6/1chap6_bucket_metrics/#10range-histogram","title":"10\u3001Range &amp; Histogram \u805a\u5408","text":"<ul> <li>\u6309\u7167\u6570\u5b57\u7684\u8303\u56f4\uff0c\u8fdb\u2f8f\u5206\u6876</li> <li>\u5728 Range Aggregation \u4e2d\uff0c\u53ef\u4ee5\u2f83\u5b9a\u4e49 Key</li> <li>Demo:<ul> <li>\u6309\u7167\u5de5\u8d44\u7684 Range \u5206\u6876</li> <li>\u6309\u7167\u2f2f\u8d44\u7684\u95f4\u9694(Histogram)\u5206\u6876</li> </ul> </li> </ul> <pre><code>#Salary Ranges \u5206\u6876\uff0c\u53ef\u4ee5\u81ea\u5df1\u5b9a\u4e49 key\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"salary_range\": {\n      \"range\": {\n        \"field\":\"salary\",\n        \"ranges\":[\n          {\n            \"to\":10000\n          },\n          {\n            \"from\":10000,\n            \"to\":20000\n          },\n          {\n            \"key\":\"&gt;20000\",\n            \"from\":20000\n          }\n        ]\n      }\n    }\n  }\n}\n</code></pre> <p>Output</p> <pre><code>\"aggregations\" : {\n    \"salary_range\" : {\n      \"buckets\" : [\n        {\n          \"key\" : \"*-10000.0\",\n          \"to\" : 10000.0,\n          \"doc_count\" : 1\n        },\n        {\n          \"key\" : \"10000.0-20000.0\",\n          \"from\" : 10000.0,\n          \"to\" : 20000.0,\n          \"doc_count\" : 4\n        },\n        {\n          \"key\" : \"&gt;20000\",\n          \"from\" : 20000.0,\n          \"doc_count\" : 15\n        }\n      ]\n    }\n  }\n</code></pre> <pre><code>#Salary Histogram,\u5de5\u8d440\u523010\u4e07\uff0c\u4ee5 5000\u4e00\u4e2a\u533a\u95f4\u8fdb\u884c\u5206\u6876\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"salary_histrogram\": {\n      \"histogram\": {\n        \"field\":\"salary\",\n        \"interval\":5000,\n        \"extended_bounds\":{\n          \"min\":0,\n          \"max\":100000\n\n        }\n      }\n    }\n  }\n}\n</code></pre> <p>Output:</p> <pre><code>\"aggregations\" : {\n    \"salary_histrogram\" : {\n      \"buckets\" : [\n        {\n          \"key\" : 0.0,\n          \"doc_count\" : 0\n        },\n        {\n          \"key\" : 5000.0,\n          \"doc_count\" : 1\n        },\n        {\n          \"key\" : 10000.0,\n          \"doc_count\" : 0\n        },\n        {\n          \"key\" : 15000.0,\n          \"doc_count\" : 4\n        },\n        {\n          \"key\" : 20000.0,\n          \"doc_count\" : 6\n        },\n...\n</code></pre>"},{"location":"chap6/1chap6_bucket_metrics/#10bucket-metric-aggregation","title":"10\u3001Bucket + Metric Aggregation","text":"<ul> <li>Bucket \u805a\u5408\u5206\u6790\u5141\u8bb8\u901a\u8fc7\u6dfb\u52a0\u2f26\u805a\u5408\u5206\u6790\u6765\u8fdb\u2f00\u6b65\u5206\u6790\uff0c\u5b50\u805a\u5408\u5206\u6790\u53ef\u4ee5\u662f<ul> <li>Bucket</li> <li>Metric</li> </ul> </li> </ul> <p>Demo</p> <ul> <li>\u6309\u7167\u2f2f\u4f5c\u7c7b\u578b\u8fdb\u2f8f\u5206\u6876\uff0c\u5e76\u7edf\u8ba1\u2f2f\u8d44\u4fe1\u606f</li> <li>\u5148\u6309\u7167\u2f2f\u4f5c\u7c7b\u578b\u5206\u6876\uff0c\u7136\u540e\u6309\u6027\u522b\u5206\u6876\uff0c\u5e76\u7edf\u8ba1\u5de5\u8d44\u4fe1\u606f</li> </ul> <pre><code># \u5d4c\u5957\u805a\u54081\uff0c\u6309\u7167\u5de5\u4f5c\u7c7b\u578b\u5206\u6876\uff0c\u5e76\u7edf\u8ba1\u5de5\u8d44\u4fe1\u606f\n\n POST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"Job_salary_stats\": {\n      \"terms\": {\n        \"field\": \"job.keyword\"\n      },\n      \"aggs\": {\n        \"salary\": {\n          \"stats\": {\n            \"field\": \"salary\"\n          }\n        }\n      }\n    }\n  }\n}\n</code></pre> <p>Output</p> <pre><code>\"aggregations\" : {\n    \"Job_salary_stats\" : {\n      \"doc_count_error_upper_bound\" : 0,\n      \"sum_other_doc_count\" : 0,\n      \"buckets\" : [\n        {\n          \"key\" : \"Java Programmer\",\n          \"doc_count\" : 7,\n          \"salary\" : {\n            \"count\" : 7,\n            \"min\" : 9000.0,\n            \"max\" : 38000.0,\n            \"avg\" : 25571.428571428572,\n            \"sum\" : 179000.0\n          }\n        },\n        {\n          \"key\" : \"Javascript Programmer\",\n          \"doc_count\" : 4,\n          \"salary\" : {\n            \"count\" : 4,\n            \"min\" : 16000.0,\n            \"max\" : 25000.0,\n            \"avg\" : 19250.0,\n            \"sum\" : 77000.0\n          }\n        },\n</code></pre> <p>\u591a\u6b21\u5d4c\u5957\u3002\u6839\u636e\u5de5\u4f5c\u7c7b\u578b\u5206\u6876\uff0c\u7136\u540e\u6309\u7167\u6027\u522b\u5206\u6876\uff0c\u8ba1\u7b97\u5de5\u8d44\u7684\u7edf\u8ba1\u4fe1\u606f</p> <pre><code>POST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"Job_gender_stats\": {\n      \"terms\": {\n        \"field\": \"job.keyword\"\n      },\n      \"aggs\": {\n        \"gender_stats\": {\n          \"terms\": {\n            \"field\": \"gender\"\n          },\n          \"aggs\": {\n            \"salary_stats\": {\n              \"stats\": {\n                \"field\": \"salary\"\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}\n</code></pre> <p>Output</p> <pre><code>\"aggregations\" : {\n    \"Job_gender_stats\" : {\n      \"doc_count_error_upper_bound\" : 0,\n      \"sum_other_doc_count\" : 0,\n      \"buckets\" : [\n        {\n          \"key\" : \"Java Programmer\",\n          \"doc_count\" : 7,\n          \"gender_stats\" : {\n            \"doc_count_error_upper_bound\" : 0,\n            \"sum_other_doc_count\" : 0,\n            \"buckets\" : [\n              {\n                \"key\" : \"male\",\n                \"doc_count\" : 5,\n                \"salary_stats\" : {\n                  \"count\" : 5,\n                  \"min\" : 9000.0,\n                  \"max\" : 32000.0,\n                  \"avg\" : 22200.0,\n                  \"sum\" : 111000.0\n                }\n              },\n              {\n                \"key\" : \"female\",\n                \"doc_count\" : 2,\n                \"salary_stats\" : {\n                  \"count\" : 2,\n                  \"min\" : 30000.0,\n                  \"max\" : 38000.0,\n                  \"avg\" : 34000.0,\n                  \"sum\" : 68000.0\n                }\n              }\n            ]\n          }\n        },\n</code></pre>"},{"location":"chap6/1chap6_bucket_metrics/#11","title":"11\u3001\u672c\u8282\u77e5\u8bc6\u70b9","text":"<ul> <li>\u805a\u5408\u5206\u6790\u7684\u5177\u4f53\u8bed\u6cd5<ul> <li>\u4e00\u4e2a\u805a\u5408\u67e5\u8be2\u4e2d\u53ef\u4ee5\u5305\u542b\u591a\u4e2a\u805a\u5408; \u6bcf\u4e2a Bucket \u805a\u5408\u53ef\u4ee5\u5305\u542b\u5b50\u805a\u5408</li> </ul> </li> <li>Metrix<ul> <li>\u5355\u503c\u8f93\u51fa &amp; \u591a\u503c\u8f93\u51fa</li> </ul> </li> <li>Bucket<ul> <li>Terms&amp;\u6570\u5b57\u8303\u56f4</li> </ul> </li> </ul>"},{"location":"chap6/2chap6_pipeline_metrics/","title":"\u7b2c\u4e8c\u8282 Pipeline \u805a\u5408\u5206\u6790","text":"<p>Pipeline aggregation\u2014\u2014\u5bf9\u5206\u7ec4+\u805a\u5408\u7ee7\u7eed\u518d\u505a\u5206\u7ec4+\u805a\u5408\u3002</p>"},{"location":"chap6/2chap6_pipeline_metrics/#1pipelinemin_bucket","title":"1\u3001\u4e00\u4e2a\u4f8b\u5b50:<code>Pipeline:min_bucket</code>","text":"<ul> <li>\u5728\u5458\u2f2f\u6570\u6700\u591a\u7684\u2f2f\u79cd\u91cc\uff0c\u627e\u51fa\u5e73\u5747\u5de5\u8d44\u6700\u4f4e\u7684\u5de5\u79cd</li> </ul>"},{"location":"chap6/2chap6_pipeline_metrics/#2pipeline","title":"2\u3001Pipeline","text":"<ul> <li>\u7ba1\u9053\u7684\u6982\u5ff5: \u2f40\u6301\u805a\u5408\u5206\u6790\u7684\u7ed3\u679c\uff0c\u518d\u6b21\u8fdb\u2f8f\u805a\u5408\u5206\u6790</li> <li>Pipeline \u7684\u5206\u6790\u7ed3\u679c\u4f1a\u8f93\u51fa\u5230\u539f\u7ed3\u679c\u4e2d\uff0c\u6839\u636e\u4f4d\u7f6e\u7684\u4e0d\u540c\uff0c\u5206\u4e3a\u4e24\u7c7b<ul> <li>Sibling - \u7ed3\u679c\u548c\u73b0\u6709\u5206\u6790\u7ed3\u679c\u540c\u7ea7<ul> <li>Max\uff0cmin\uff0cAvg &amp; Sum Bucket</li> <li>Stats\uff0cExtended Status Bucket</li> <li>Percentiles Bucket</li> </ul> </li> <li>Parent - \u7ed3\u679c\u5185\u5d4c\u5230\u73b0\u6709\u7684\u805a\u5408\u5206\u6790\u7ed3\u679c\u4e4b\u4e2d<ul> <li>Derivative (\u6c42\u5bfc)</li> <li>Cumultive Sum (\u7d2f\u8ba1\u6c42\u548c)</li> <li>Moving Function (\u6ed1\u52a8\u7a97\u2f1d)</li> </ul> </li> </ul> </li> </ul>"},{"location":"chap6/2chap6_pipeline_metrics/#3sibling-pipeline","title":"3\u3001Sibling Pipeline \u7684\u4f8b\u5b50","text":"<ul> <li> <p>\u5bf9\u4e0d\u540c\u7c7b\u578b\u2f2f\u4f5c\u7684\uff0c\u5e73\u5747\u5de5\u8d44</p> </li> <li> <p>\u6c42\u6700\u2f24</p> </li> <li>\u5e73\u5747</li> <li>\u7edf\u8ba1\u4fe1\u606f </li> <li>\u767e\u5206\u4f4d\u6570</li> </ul> <pre><code>DELETE employees\nPUT /employees/_bulk\n{ \"index\" : {  \"_id\" : \"1\" } }\n{ \"name\" : \"Emma\",\"age\":32,\"job\":\"Product Manager\",\"gender\":\"female\",\"salary\":35000 }\n{ \"index\" : {  \"_id\" : \"2\" } }\n{ \"name\" : \"Underwood\",\"age\":41,\"job\":\"Dev Manager\",\"gender\":\"male\",\"salary\": 50000}\n{ \"index\" : {  \"_id\" : \"3\" } }\n{ \"name\" : \"Tran\",\"age\":25,\"job\":\"Web Designer\",\"gender\":\"male\",\"salary\":18000 }\n{ \"index\" : {  \"_id\" : \"4\" } }\n{ \"name\" : \"Rivera\",\"age\":26,\"job\":\"Web Designer\",\"gender\":\"female\",\"salary\": 22000}\n{ \"index\" : {  \"_id\" : \"5\" } }\n{ \"name\" : \"Rose\",\"age\":25,\"job\":\"QA\",\"gender\":\"female\",\"salary\":18000 }\n{ \"index\" : {  \"_id\" : \"6\" } }\n{ \"name\" : \"Lucy\",\"age\":31,\"job\":\"QA\",\"gender\":\"female\",\"salary\": 25000}\n{ \"index\" : {  \"_id\" : \"7\" } }\n{ \"name\" : \"Byrd\",\"age\":27,\"job\":\"QA\",\"gender\":\"male\",\"salary\":20000 }\n{ \"index\" : {  \"_id\" : \"8\" } }\n{ \"name\" : \"Foster\",\"age\":27,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 20000}\n{ \"index\" : {  \"_id\" : \"9\" } }\n{ \"name\" : \"Gregory\",\"age\":32,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\":22000 }\n{ \"index\" : {  \"_id\" : \"10\" } }\n{ \"name\" : \"Bryant\",\"age\":20,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 9000}\n{ \"index\" : {  \"_id\" : \"11\" } }\n{ \"name\" : \"Jenny\",\"age\":36,\"job\":\"Java Programmer\",\"gender\":\"female\",\"salary\":38000 }\n{ \"index\" : {  \"_id\" : \"12\" } }\n{ \"name\" : \"Mcdonald\",\"age\":31,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 32000}\n{ \"index\" : {  \"_id\" : \"13\" } }\n{ \"name\" : \"Jonthna\",\"age\":30,\"job\":\"Java Programmer\",\"gender\":\"female\",\"salary\":30000 }\n{ \"index\" : {  \"_id\" : \"14\" } }\n{ \"name\" : \"Marshall\",\"age\":32,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 25000}\n{ \"index\" : {  \"_id\" : \"15\" } }\n{ \"name\" : \"King\",\"age\":33,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\":28000 }\n{ \"index\" : {  \"_id\" : \"16\" } }\n{ \"name\" : \"Mccarthy\",\"age\":21,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 16000}\n{ \"index\" : {  \"_id\" : \"17\" } }\n{ \"name\" : \"Goodwin\",\"age\":25,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 16000}\n{ \"index\" : {  \"_id\" : \"18\" } }\n{ \"name\" : \"Catherine\",\"age\":29,\"job\":\"Javascript Programmer\",\"gender\":\"female\",\"salary\": 20000}\n{ \"index\" : {  \"_id\" : \"19\" } }\n{ \"name\" : \"Boone\",\"age\":30,\"job\":\"DBA\",\"gender\":\"male\",\"salary\": 30000}\n{ \"index\" : {  \"_id\" : \"20\" } }\n{ \"name\" : \"Kathy\",\"age\":29,\"job\":\"DBA\",\"gender\":\"female\",\"salary\": 20000}\n</code></pre>"},{"location":"chap6/2chap6_pipeline_metrics/#3-1-min_bucket","title":"3-1 <code>min_bucket</code>","text":"<p>\u5e73\u5747\u5de5\u8d44\u6700\u4f4e\u7684\u5de5\u4f5c\u7c7b\u578b</p> <pre><code># \u5e73\u5747\u5de5\u8d44\u6700\u4f4e\u7684\u5de5\u4f5c\u7c7b\u578b\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\": \"job.keyword\",\n        \"size\": 10\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        }\n      }\n    },\n    \"min_salary_by_job\":{\n      \"min_bucket\": {\n        \"buckets_path\": \"jobs&gt;avg_salary\"\n      }\n    }\n  }\n}\n</code></pre> <ul> <li><code>min_bucket</code></li> <li><code>jobs&gt;avg_salary</code></li> </ul> <p>Output</p> <pre><code>aggregations\" : {\n    \"jobs\" : {\n      \"doc_count_error_upper_bound\" : 0,\n      \"sum_other_doc_count\" : 0,\n      \"buckets\" : [\n        {\n          \"key\" : \"Java Programmer\",\n          \"doc_count\" : 7,\n          \"avg_salary\" : {\n            \"value\" : 25571.428571428572\n          }\n        },\n        {\n          \"key\" : \"Javascript Programmer\",\n          \"doc_count\" : 4,\n          \"avg_salary\" : {\n            \"value\" : 19250.0\n          }\n        },\n        {\n          \"key\" : \"QA\",\n          \"doc_count\" : 3,\n          \"avg_salary\" : {\n            \"value\" : 21000.0\n          }\n        },\n        {\n          \"key\" : \"DBA\",\n          \"doc_count\" : 2,\n          \"avg_salary\" : {\n            \"value\" : 25000.0\n          }\n        },\n        {\n          \"key\" : \"Web Designer\",\n          \"doc_count\" : 2,\n          \"avg_salary\" : {\n            \"value\" : 20000.0\n          }\n        },\n        {\n          \"key\" : \"Dev Manager\",\n          \"doc_count\" : 1,\n          \"avg_salary\" : {\n            \"value\" : 50000.0\n          }\n        },\n        {\n          \"key\" : \"Product Manager\",\n          \"doc_count\" : 1,\n          \"avg_salary\" : {\n            \"value\" : 35000.0\n          }\n        }\n      ]\n    },\n    \"min_salary_by_job\" : {\n      \"value\" : 19250.0,\n      \"keys\" : [\n        \"Javascript Programmer\"\n      ]\n    }\n  }\n</code></pre>"},{"location":"chap6/2chap6_pipeline_metrics/#3-2-max_bucket","title":"3-2 <code>max_bucket</code>","text":"<pre><code># \u5e73\u5747\u5de5\u8d44\u6700\u9ad8\u7684\u5de5\u4f5c\u7c7b\u578b\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\": \"job.keyword\",\n        \"size\": 10\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        }\n      }\n    },\n    \"max_salary_by_job\":{\n      \"max_bucket\": {\n        \"buckets_path\": \"jobs&gt;avg_salary\"\n      }\n    }\n  }\n}\n</code></pre> <p>Output :</p> <pre><code>...\n\"max_salary_by_job\" : {\n      \"value\" : 50000.0,\n      \"keys\" : [\n        \"Dev Manager\"\n      ]\n    }\n  }\n</code></pre>"},{"location":"chap6/2chap6_pipeline_metrics/#3-3-stats_bucket","title":"3-3 <code>stats_bucket</code>","text":"<pre><code># \u5e73\u5747\u5de5\u8d44\u7684\u7edf\u8ba1\u5206\u6790\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\": \"job.keyword\",\n        \"size\": 10\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        }\n      }\n    },\n    \"stats_salary_by_job\":{\n      \"stats_bucket\": {\n        \"buckets_path\": \"jobs&gt;avg_salary\"\n      }\n    }\n  }\n}\n</code></pre> <p>Output</p> <pre><code>...\n\"stats_salary_by_job\" : {\n      \"count\" : 7,\n      \"min\" : 19250.0,\n      \"max\" : 50000.0,\n      \"avg\" : 27974.48979591837,\n      \"sum\" : 195821.42857142858\n    }\n</code></pre>"},{"location":"chap6/2chap6_pipeline_metrics/#3-4-percentiles_bucket","title":"3-4 <code>percentiles_bucket</code>","text":"<pre><code># \u5e73\u5747\u5de5\u8d44\u7684\u767e\u5206\u4f4d\u6570\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\": \"job.keyword\",\n        \"size\": 10\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        }\n      }\n    },\n    \"percentiles_salary_by_job\":{\n      \"percentiles_bucket\": {\n        \"buckets_path\": \"jobs&gt;avg_salary\"\n      }\n    }\n  }\n}\n</code></pre> <p>Output :</p> <pre><code> \"percentiles_salary_by_job\" : {\n      \"values\" : {\n        \"1.0\" : 19250.0,\n        \"5.0\" : 19250.0,\n        \"25.0\" : 21000.0,\n        \"50.0\" : 25000.0,\n        \"75.0\" : 35000.0,\n        \"95.0\" : 50000.0,\n        \"99.0\" : 50000.0\n      }\n    }\n  }\n</code></pre>"},{"location":"chap6/2chap6_pipeline_metrics/#4parent-pipelinederivative","title":"4\u3001Parent Pipeline:Derivative","text":"<ul> <li>\u6309\u7167\u5e74\u9f84\uff0c\u5bf9\u2f2f\u8d44\u8fdb\u2f8f\u6c42\u5bfc(\u770b\u2f2f\u8d44\u53d1\u5c55\u7684\u8d8b\u52bf)</li> </ul>"},{"location":"chap6/2chap6_pipeline_metrics/#5parent-pipeline","title":"5\u3001Parent Pipeline \u7684\u4f8b\u5b50","text":"<ul> <li>\u5e74\u9f84\u76f4\u2f45\u56fe\u5212\u5206\u7684\u5e73\u5747\u5de5\u8d44<ul> <li>Cumulative Sum</li> <li>Moving Function</li> </ul> </li> </ul>"},{"location":"chap6/2chap6_pipeline_metrics/#5-1-derivative","title":"5-1 derivative","text":"<pre><code>#\u6309\u7167\u5e74\u9f84\u5bf9\u5e73\u5747\u5de5\u8d44\u6c42\u5bfc\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"age\": {\n      \"histogram\": {\n        \"field\": \"age\",\n        \"min_doc_count\": 0,\n        \"interval\": 1\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        },\n        \"derivative_avg_salary\":{\n          \"derivative\": {\n            \"buckets_path\": \"avg_salary\"\n          }\n        }\n      }\n    }\n  }\n}\n</code></pre> <p>Output</p> <pre><code>\"aggregations\" : {\n    \"age\" : {\n      \"buckets\" : [\n        {\n          \"key\" : 20.0,\n          \"doc_count\" : 1,\n          \"avg_salary\" : {\n            \"value\" : 9000.0\n          }\n        },\n        {\n          \"key\" : 21.0,\n          \"doc_count\" : 1,\n          \"avg_salary\" : {\n            \"value\" : 16000.0\n          },\n          \"derivative_avg_salary\" : {\n            \"value\" : 7000.0\n          }\n        },\n ...\n</code></pre>"},{"location":"chap6/2chap6_pipeline_metrics/#5-2-cumulative_sum","title":"5-2 <code>Cumulative_sum</code>","text":"<pre><code>#Cumulative_sum\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"age\": {\n      \"histogram\": {\n        \"field\": \"age\",\n        \"min_doc_count\": 0,\n        \"interval\": 1\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        },\n        \"cumulative_salary\":{\n          \"cumulative_sum\": {\n            \"buckets_path\": \"avg_salary\"\n          }\n        }\n      }\n    }\n  }\n}\n</code></pre> <p>Output :</p> <pre><code>  \"aggregations\" : {\n    \"age\" : {\n      \"buckets\" : [\n        {\n          \"key\" : 20.0,\n          \"doc_count\" : 1,\n          \"avg_salary\" : {\n            \"value\" : 9000.0\n          },\n          \"cumulative_salary\" : {\n            \"value\" : 9000.0\n          }\n        },\n        {\n          \"key\" : 21.0,\n          \"doc_count\" : 1,\n          \"avg_salary\" : {\n            \"value\" : 16000.0\n          },\n          \"cumulative_salary\" : {\n            \"value\" : 25000.0\n          }\n        },\n        {\n          \"key\" : 22.0,\n          \"doc_count\" : 0,\n          \"avg_salary\" : {\n            \"value\" : null\n          },\n          \"cumulative_salary\" : {\n            \"value\" : 25000.0\n          }\n        },\n        ...\n</code></pre>"},{"location":"chap6/2chap6_pipeline_metrics/#5-3-moving_fn","title":"5-3 <code>moving_fn</code>","text":"<p><code>Moving Function</code>\u4e5f\u662f\u4e00\u4e2a<code>Parent Pipeline Agg</code>\u3002\u5b83\u8868\u793a\u5bf9\u4e8e\u4e00\u4e2a\u4e00\u5b9a\u987a\u5e8f\u7684\u96c6\u5408\uff0c\u7ef4\u62a4\u4e00\u4e2a\u7a97\u53e3\u5927\u5c0f N\uff08\u5f53\u524d Bucket \u5f80\u524d\u7684 N \u4e2aBuckets\uff0c\u652f\u6301\u7528\u6237\u81ea\u5b9a\u4e49\uff0c\u9ed8\u8ba4\u4e0d\u786e\u5b9a\uff0c\u5f85\u770b\uff0c\u8fd9\u91cc\u6307\u5b9a\u4e86\u662f10\uff09\uff0c\u7136\u540e\u5bf9\u8fd9 N \u4e2a Buckets \u8fdb\u884c\u4e00\u4e2a Function \u6c42\u89e3\uff08\u9ed8\u8ba4\u503c\u4e0d\u786e\u5b9a\uff0c\u5f85\u770b\uff0c\u652f\u6301\u7528\u6237\u81ea\u5b9a\u4e49\uff0c\u8fd9\u91cc\u6211\u4eec\u5b9a\u4e49\u4e86\u4e00\u4e2a\"script\"\u7c7b\u578b\u7684 Function\uff1a\"MovingFunctions.min(values)\" \uff1a\u8868\u793a\u5bf9 <code>\"avg_salary\"</code>\u7684\u7ed3\u679c\"value\"\u6c42\u6700\u5c0f\u503c\uff0c\u4e5f\u5c31\u662f\u6c42\u7a97\u53e3\u4e4b\u5185\u7684 Bucket \u7684 Metric \u6700\u5c0f\u503c\uff09\u3002</p> <pre><code>#Moving Function\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"age\": {\n      \"histogram\": {\n        \"field\": \"age\",\n        \"min_doc_count\": 0,\n        \"interval\": 1\n      },\n      \"aggs\": {\n        \"avg_salary\": {\n          \"avg\": {\n            \"field\": \"salary\"\n          }\n        },\n        \"moving_avg_salary\":{\n          \"moving_fn\": {\n            \"buckets_path\": \"avg_salary\",\n            \"window\":10,\n            \"script\": \"MovingFunctions.min(values)\"\n          }\n        }\n      }\n    }\n  }\n}\n</code></pre> <p>Ourtput</p> <pre><code>\"aggregations\" : {\n    \"age\" : {\n      \"buckets\" : [\n        {\n          \"key\" : 20.0,\n          \"doc_count\" : 1,\n          \"avg_salary\" : {\n            \"value\" : 9000.0\n          },\n          \"moving_avg_salary\" : {\n            \"value\" : null\n          }\n        },\n        {\n          \"key\" : 21.0,\n          \"doc_count\" : 1,\n          \"avg_salary\" : {\n            \"value\" : 16000.0\n          },\n          \"moving_avg_salary\" : {\n            \"value\" : 9000.0\n          }\n        },\n        {\n          \"key\" : 22.0,\n          \"doc_count\" : 0,\n          \"avg_salary\" : {\n            \"value\" : null\n          }\n        },\n        ...\n        \"moving_avg_salary\" : {\n            \"value\" : 16000.0\n          }\n</code></pre>"},{"location":"chap6/3chap6_aggragate_scope_order/","title":"\u7b2c\u4e09\u8282 \u805a\u5408\u7684\u4f5c\u2f64\u8303\u56f4\u53ca\u6392\u5e8f","text":""},{"location":"chap6/3chap6_aggragate_scope_order/#1","title":"1\u3001\u805a\u5408\u7684\u4f5c\u2f64\u8303\u56f4","text":"<ul> <li>ES \u805a\u5408\u5206\u6790\u7684\u9ed8\u8ba4\u4f5c\u2f64\u8303\u56f4\u662f query \u7684\u67e5\u8be2\u7ed3\u679c\u96c6</li> <li> <p>\u540c\u65f6 ES \u8fd8\u2f40\u6301\u4ee5\u4e0b\u2f45\u5f0f\u6539\u53d8\u805a\u5408\u7684\u4f5c\u2f64\u8303\u56f4</p> <ul> <li>Filter</li> <li><code>Post_Filter</code></li> <li>Global</li> </ul> </li> <li> <p><code>global</code>\u7684\u4f5c\u7528\u662f\u8986\u76d6\u6389query\u7684\u67e5\u8be2\u4f5c\u7528</p> </li> </ul> <p></p> <pre><code>DELETE /employees\n\nPUT /employees/\n{\n  \"mappings\" : {\n      \"properties\" : {\n        \"age\" : {\n          \"type\" : \"integer\"\n        },\n        \"gender\" : {\n          \"type\" : \"keyword\"\n        },\n        \"job\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 50\n            }\n          }\n        },\n        \"name\" : {\n          \"type\" : \"keyword\"\n        },\n        \"salary\" : {\n          \"type\" : \"integer\"\n        }\n      }\n    }\n}\n</code></pre> <pre><code>PUT /employees/_bulk\n{ \"index\" : {  \"_id\" : \"1\" } }\n{ \"name\" : \"Emma\",\"age\":32,\"job\":\"Product Manager\",\"gender\":\"female\",\"salary\":35000 }\n{ \"index\" : {  \"_id\" : \"2\" } }\n{ \"name\" : \"Underwood\",\"age\":41,\"job\":\"Dev Manager\",\"gender\":\"male\",\"salary\": 50000}\n{ \"index\" : {  \"_id\" : \"3\" } }\n{ \"name\" : \"Tran\",\"age\":25,\"job\":\"Web Designer\",\"gender\":\"male\",\"salary\":18000 }\n{ \"index\" : {  \"_id\" : \"4\" } }\n{ \"name\" : \"Rivera\",\"age\":26,\"job\":\"Web Designer\",\"gender\":\"female\",\"salary\": 22000}\n{ \"index\" : {  \"_id\" : \"5\" } }\n{ \"name\" : \"Rose\",\"age\":25,\"job\":\"QA\",\"gender\":\"female\",\"salary\":18000 }\n{ \"index\" : {  \"_id\" : \"6\" } }\n{ \"name\" : \"Lucy\",\"age\":31,\"job\":\"QA\",\"gender\":\"female\",\"salary\": 25000}\n{ \"index\" : {  \"_id\" : \"7\" } }\n{ \"name\" : \"Byrd\",\"age\":27,\"job\":\"QA\",\"gender\":\"male\",\"salary\":20000 }\n{ \"index\" : {  \"_id\" : \"8\" } }\n{ \"name\" : \"Foster\",\"age\":27,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 20000}\n{ \"index\" : {  \"_id\" : \"9\" } }\n{ \"name\" : \"Gregory\",\"age\":32,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\":22000 }\n{ \"index\" : {  \"_id\" : \"10\" } }\n{ \"name\" : \"Bryant\",\"age\":20,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 9000}\n{ \"index\" : {  \"_id\" : \"11\" } }\n{ \"name\" : \"Jenny\",\"age\":36,\"job\":\"Java Programmer\",\"gender\":\"female\",\"salary\":38000 }\n{ \"index\" : {  \"_id\" : \"12\" } }\n{ \"name\" : \"Mcdonald\",\"age\":31,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\": 32000}\n{ \"index\" : {  \"_id\" : \"13\" } }\n{ \"name\" : \"Jonthna\",\"age\":30,\"job\":\"Java Programmer\",\"gender\":\"female\",\"salary\":30000 }\n{ \"index\" : {  \"_id\" : \"14\" } }\n{ \"name\" : \"Marshall\",\"age\":32,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 25000}\n{ \"index\" : {  \"_id\" : \"15\" } }\n{ \"name\" : \"King\",\"age\":33,\"job\":\"Java Programmer\",\"gender\":\"male\",\"salary\":28000 }\n{ \"index\" : {  \"_id\" : \"16\" } }\n{ \"name\" : \"Mccarthy\",\"age\":21,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 16000}\n{ \"index\" : {  \"_id\" : \"17\" } }\n{ \"name\" : \"Goodwin\",\"age\":25,\"job\":\"Javascript Programmer\",\"gender\":\"male\",\"salary\": 16000}\n{ \"index\" : {  \"_id\" : \"18\" } }\n{ \"name\" : \"Catherine\",\"age\":29,\"job\":\"Javascript Programmer\",\"gender\":\"female\",\"salary\": 20000}\n{ \"index\" : {  \"_id\" : \"19\" } }\n{ \"name\" : \"Boone\",\"age\":30,\"job\":\"DBA\",\"gender\":\"male\",\"salary\": 30000}\n{ \"index\" : {  \"_id\" : \"20\" } }\n{ \"name\" : \"Kathy\",\"age\":29,\"job\":\"DBA\",\"gender\":\"female\",\"salary\": 20000}\n</code></pre> <pre><code># Query\nPOST employees/_search\n{\n  \"size\": 0,\n  \"query\": {\n    \"range\": {\n      \"age\": {\n        \"gte\": 20\n      }\n    }\n  },\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\"\n\n      }\n    }\n  }\n}\n</code></pre> <p>Output:</p> <pre><code>aggregations\" : {\n    \"jobs\" : {\n      \"doc_count_error_upper_bound\" : 0,\n      \"sum_other_doc_count\" : 0,\n      \"buckets\" : [\n        {\n          \"key\" : \"Java Programmer\",\n          \"doc_count\" : 7\n        },\n        {\n          \"key\" : \"Javascript Programmer\",\n          \"doc_count\" : 4\n        },\n        {\n          \"key\" : \"QA\",\n          \"doc_count\" : 3\n        },\n        {\n          \"key\" : \"DBA\",\n          \"doc_count\" : 2\n        },\n...\n</code></pre>"},{"location":"chap6/3chap6_aggragate_scope_order/#1-1-filter","title":"1-1 Filter","text":"<p><code>query</code>\u548c<code>filter</code>\uff0c\u662f\u5148\u9009\u5b9a\u6570\u636e\u8303\u56f4\uff0c\u5728\u805a\u5408\u6876\uff1b</p> <p></p> <pre><code>#Filter\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"older_person\": {\n      \"filter\":{\n        \"range\":{\n          \"age\":{\n            \"from\":35\n          }\n        }\n      },\n      \"aggs\":{\n         \"jobs\":{\n           \"terms\": {\n        \"field\":\"job.keyword\"\n      }\n      }\n    }},\n    \"all_jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\"\n\n      }\n    }\n  }\n}\n</code></pre> <p>Output :</p> <pre><code> \"aggregations\" : {\n    \"older_person\" : {\n      \"doc_count\" : 2,\n      \"jobs\" : {\n        \"doc_count_error_upper_bound\" : 0,\n        \"sum_other_doc_count\" : 0,\n        \"buckets\" : [\n          {\n            \"key\" : \"Dev Manager\",\n            \"doc_count\" : 1\n          },\n          {\n            \"key\" : \"Java Programmer\",\n            \"doc_count\" : 1\n          }\n        ]\n      }\n    },\n    },\n    \"all_jobs\" : {\n      \"doc_count_error_upper_bound\" : 0,\n      \"sum_other_doc_count\" : 0,\n      \"buckets\" : [\n        {\n          \"key\" : \"Java Programmer\",\n          \"doc_count\" : 7\n        },\n        {\n          \"key\" : \"Javascript Programmer\",\n          \"doc_count\" : 4\n        },\n        {\n          \"key\" : \"QA\",\n          \"doc_count\" : 3\n        },\n       ... \n</code></pre>"},{"location":"chap6/3chap6_aggragate_scope_order/#1-2-post_filter","title":"1-2 <code>Post_Filter</code>","text":"<ul> <li>\u662f\u5bf9\u805a\u5408\u5206\u6790\u540e\u7684\u2f42\u6863\u8fdb\u2f8f\u518d\u6b21\u8fc7\u6ee4</li> <li>Size \u2f46\u9700\u8bbe\u7f6e\u4e3a 0</li> <li>\u4f7f\u2f64\u573a\u666f<ul> <li>\u4e00\u6761\u8bed\u53e5\uff0c\u83b7\u53d6\u805a\u5408\u4fe1\u606f + \u83b7\u53d6\u7b26\u5408\u6761\u4ef6\u7684\u6587\u6863</li> </ul> </li> </ul> <p><code>post_filter</code>\u5bf9\u805a\u5408\u6876\u6ca1\u5f71\u54cd\uff0c\u6876\u662f\u5168\u90e8\u8fd4\u56de\uff0c\u53ea\u5bf9\u67e5\u8be2\u7ed3\u679c\u8fdb\u884c\u8fc7\u6ee4\u8fd4\u56de</p> <pre><code>#Post field. \u4e00\u6761\u8bed\u53e5\uff0c\u627e\u51fa\u6240\u6709\u7684job\u7c7b\u578b\u3002\u8fd8\u80fd\u627e\u5230\u805a\u5408\u540e\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c\nPOST employees/_search\n{\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\": \"job.keyword\"\n      }\n    }\n  },\n  \"post_filter\": {\n    \"match\": {\n      \"job.keyword\": \"Dev Manager\"\n    }\n  }\n}\n</code></pre> <p>Output :</p> <pre><code>\"hits\" : [\n      {\n        \"_index\" : \"employees\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"2\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"name\" : \"Underwood\",\n          \"age\" : 41,\n          \"job\" : \"Dev Manager\",\n          \"gender\" : \"male\",\n          \"salary\" : 50000\n        }\n      }\n    ]\n  },\n  \"aggregations\" : {\n    \"jobs\" : {\n      \"doc_count_error_upper_bound\" : 0,\n      \"sum_other_doc_count\" : 0,\n      \"buckets\" : [\n        {\n          \"key\" : \"Java Programmer\",\n          \"doc_count\" : 7\n        },\n        {\n          \"key\" : \"Javascript Programmer\",\n          \"doc_count\" : 4\n        },\n        {\n          \"key\" : \"QA\",\n          \"doc_count\" : 3\n        },\n        ...\n\n</code></pre>"},{"location":"chap6/3chap6_aggragate_scope_order/#1-3-global","title":"1-3 <code>global</code>","text":"<p><code>global</code>\u7684\u4f5c\u7528\u662f\u8986\u76d6\u6389<code>query</code>\u7684\u67e5\u8be2\u4f5c\u7528</p> <p></p> <pre><code>#global\nPOST employees/_search\n{\n  \"size\": 0,\n  \"query\": {\n    \"range\": {\n      \"age\": {\n        \"gte\": 40\n      }\n    }\n  },\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\"\n\n      }\n    },\n\n    \"all\":{\n      \"global\":{},\n      \"aggs\":{\n        \"salary_avg\":{\n          \"avg\":{\n            \"field\":\"salary\"\n          }\n        }\n      }\n    }\n  }\n}\n</code></pre> <p>Output :</p> <pre><code>\"hits\" : {\n    \"total\" : {\n      \"value\" : 1,\n      \"relation\" : \"eq\"\n    },\n    \"max_score\" : null,\n    \"hits\" : [ ]\n  },\n  \"aggregations\" : {\n    \"all\" : {\n      \"doc_count\" : 20,\n      \"salary_avg\" : {\n        \"value\" : 24700.0\n      }\n    },\n    \"jobs\" : {\n      \"doc_count_error_upper_bound\" : 0,\n      \"sum_other_doc_count\" : 0,\n      \"buckets\" : [\n        {\n          \"key\" : \"Dev Manager\",\n          \"doc_count\" : 1\n        }\n      ]\n    }\n  }\n</code></pre>"},{"location":"chap6/3chap6_aggragate_scope_order/#2","title":"2\u3001\u6392\u5e8f","text":"<ul> <li>\u6307\u5b9a order\uff0c \u6309\u7167 count \u548c key \u8fdb\u2f8f\u6392\u5e8f<ul> <li>\u9ed8\u8ba4\u60c5\u51b5\uff0c\u6309\u7167 count \u964d\u5e8f\u6392\u5e8f</li> <li>\u6307\u5b9a size\uff0c\u5c31\u80fd\u8fd4\u56de\u76f8\u5e94\u7684\u6876</li> </ul> </li> </ul> <pre><code>#\u6392\u5e8f order\n#count and key\nPOST employees/_search\n{\n  \"size\": 0,\n  \"query\": {\n    \"range\": {\n      \"age\": {\n        \"gte\": 20\n      }\n    }\n  },\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\",\n        \"order\":[\n          {\"_count\":\"asc\"},\n          {\"_key\":\"desc\"}\n          ]\n\n      }\n    }\n  }\n}\n</code></pre> <ul> <li><code>_count</code>: asc</li> <li>\u5982\u679c<code>_count</code>\u4e00\u81f4\uff0c<code>_key</code> : desc </li> </ul> <pre><code>#\u6392\u5e8f order\n#count and key\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\",\n        \"order\":[  {\n            \"avg_salary\":\"desc\"\n          }]\n\n\n      },\n    \"aggs\": {\n      \"avg_salary\": {\n        \"avg\": {\n          \"field\":\"salary\"\n        }\n      }\n    }\n    }\n  }\n}\n</code></pre> <p>Output :</p> <pre><code> \"aggregations\" : {\n    \"jobs\" : {\n      \"doc_count_error_upper_bound\" : 0,\n      \"sum_other_doc_count\" : 0,\n      \"buckets\" : [\n        {\n          \"key\" : \"Dev Manager\",\n          \"doc_count\" : 1,\n          \"avg_salary\" : {\n            \"value\" : 50000.0\n          }\n        },\n        {\n          \"key\" : \"Product Manager\",\n          \"doc_count\" : 1,\n          \"avg_salary\" : {\n            \"value\" : 35000.0\n          }\n        },\n        {\n          \"key\" : \"Java Programmer\",\n          \"doc_count\" : 7,\n          \"avg_salary\" : {\n            \"value\" : 25571.428571428572\n          }\n        },\n        {\n          \"key\" : \"DBA\",\n          \"doc_count\" : 2,\n          \"avg_salary\" : {\n            \"value\" : 25000.0\n          }\n        },\n        {\n          \"key\" : \"QA\",\n          \"doc_count\" : 3,\n          \"avg_salary\" : {\n            \"value\" : 21000.0\n          }\n        },\n        {\n          \"key\" : \"Web Designer\",\n          \"doc_count\" : 2,\n          \"avg_salary\" : {\n            \"value\" : 20000.0\n          }\n        },\n        {\n          \"key\" : \"Javascript Programmer\",\n          \"doc_count\" : 4,\n          \"avg_salary\" : {\n            \"value\" : 19250.0\n          }\n        }\n      ]\n    }\n</code></pre>"},{"location":"chap6/3chap6_aggragate_scope_order/#2-1","title":"2-1 \u57fa\u4e8e\u2f26\u805a\u5408\u7684\u503c\u6392\u5e8f","text":"<ul> <li>\u57fa\u4e8e\u5b50\u805a\u5408\u7684\u6570\u503c\u8fdb\u2f8f\u6392\u5e8f</li> <li>\u4f7f\u2f64\u2f26\u805a\u5408\uff0cAggregation name</li> </ul> <pre><code>#\u6392\u5e8f order\n#count and key\nPOST employees/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"jobs\": {\n      \"terms\": {\n        \"field\":\"job.keyword\",\n        \"order\":[  {\n            \"stats_salary.min\":\"desc\"\n          }]\n\n\n      },\n    \"aggs\": {\n      \"stats_salary\": {\n        \"stats\": {\n          \"field\":\"salary\"\n        }\n      }\n    }\n    }\n  }\n}\n</code></pre> <p>Output :</p> <pre><code>\"aggregations\" : {\n    \"jobs\" : {\n      \"doc_count_error_upper_bound\" : 0,\n      \"sum_other_doc_count\" : 0,\n      \"buckets\" : [\n        {\n          \"key\" : \"Dev Manager\",\n          \"doc_count\" : 1,\n          \"stats_salary\" : {\n            \"count\" : 1,\n            \"min\" : 50000.0,\n            \"max\" : 50000.0,\n            \"avg\" : 50000.0,\n            \"sum\" : 50000.0\n          }\n        },\n        {\n          \"key\" : \"Product Manager\",\n          \"doc_count\" : 1,\n          \"stats_salary\" : {\n            \"count\" : 1,\n            \"min\" : 35000.0,\n            \"max\" : 35000.0,\n            \"avg\" : 35000.0,\n            \"sum\" : 35000.0\n          }\n        },\n        {\n          \"key\" : \"DBA\",\n          \"doc_count\" : 2,\n          \"stats_salary\" : {\n            \"count\" : 2,\n            \"min\" : 20000.0,\n            \"max\" : 30000.0,\n            \"avg\" : 25000.0,\n            \"sum\" : 50000.0\n          }\n        },\n        {\n          \"key\" : \"QA\",\n          \"doc_count\" : 3,\n          \"stats_salary\" : {\n            \"count\" : 3,\n            \"min\" : 18000.0,\n            \"max\" : 25000.0,\n            \"avg\" : 21000.0,\n            \"sum\" : 63000.0\n          }\n        },\n        {\n          \"key\" : \"Web Designer\",\n          \"doc_count\" : 2,\n          \"stats_salary\" : {\n            \"count\" : 2,\n            \"min\" : 18000.0,\n            \"max\" : 22000.0,\n            \"avg\" : 20000.0,\n            \"sum\" : 40000.0\n          }\n        },\n        {\n          \"key\" : \"Javascript Programmer\",\n          \"doc_count\" : 4,\n          \"stats_salary\" : {\n            \"count\" : 4,\n            \"min\" : 16000.0,\n            \"max\" : 25000.0,\n            \"avg\" : 19250.0,\n            \"sum\" : 77000.0\n          }\n        },\n        {\n          \"key\" : \"Java Programmer\",\n          \"doc_count\" : 7,\n          \"stats_salary\" : {\n            \"count\" : 7,\n            \"min\" : 9000.0,\n            \"max\" : 38000.0,\n            \"avg\" : 25571.428571428572,\n            \"sum\" : 179000.0\n          }\n        }\n      ]\n    }\n  }\n</code></pre>"},{"location":"chap6/4chap6_accurate_aggragate/","title":"\u7b2c\u56db\u8282 \u805a\u5408\u7684\u7cbe\u51c6\u5ea6\u95ee\u9898","text":""},{"location":"chap6/4chap6_accurate_aggragate/#1","title":"1\u3001\u5206\u5e03\u5f0f\u7cfb\u7edf\u7684\u8fd1\u4f3c\u7edf\u8ba1\u7b97\u6cd5","text":""},{"location":"chap6/4chap6_accurate_aggragate/#2min","title":"2\u3001Min \u805a\u5408\u5206\u6790\u7684\u6267\u2f8f\u6d41\u7a0b","text":""},{"location":"chap6/4chap6_accurate_aggragate/#3terms-aggregation","title":"3\u3001Terms Aggregation \u7684\u8fd4\u56de\u503c","text":"<ul> <li>\u5728 Terms Aggregation \u7684\u8fd4\u56de\u4e2d\u6709\u4e24\u4e2a\u7279\u6b8a\u7684\u6570\u503c<ul> <li><code>doc_count_error_upper_bound</code> : \u88ab\u9057\u6f0f\u7684 <code>term</code> \u5206\u6876\uff0c\u5305\u542b\u7684\u2f42\u6863\uff0c\u6709\u53ef\u80fd\u7684\u6700\u2f24\u503c</li> <li><code>sum_other_doc_count</code>: \u9664\u4e86\u8fd4\u56de\u7ed3\u679c bucket \u7684 terms \u4ee5\u5916\uff0c\u5176\u4ed6 terms \u7684\u2f42\u6863\u603b\u6570(\u603b \u6570-\u8fd4\u56de\u7684\u603b\u6570)</li> </ul> </li> </ul>"},{"location":"chap6/4chap6_accurate_aggragate/#4terms","title":"4\u3001Terms \u805a\u5408\u5206\u6790\u7684\u6267\u2f8f\u6d41\u7a0b","text":""},{"location":"chap6/4chap6_accurate_aggragate/#5terms","title":"5\u3001Terms \u4e0d\u6b63\u786e\u7684\u6848\u4f8b","text":"<ul> <li><code>sum_other_doc_count</code> = 29 - (12+6+3) = 7</li> </ul>"},{"location":"chap6/4chap6_accurate_aggragate/#6-terms-shard_size","title":"6\u3001 \u5982\u4f55\u89e3\u51b3 Terms \u4e0d\u51c6\u7684\u95ee\u9898:\u63d0\u5347 <code>shard_size</code> \u7684\u53c2\u6570","text":"<ul> <li>Terms \u805a\u5408\u5206\u6790\u4e0d\u51c6\u7684\u539f\u56e0\uff0c\u6570\u636e\u5206\u6563\u5728\u591a\u4e2a\u5206\u7247\u4e0a\uff0c <code>Coordinating Node</code> \u2f46\u6cd5\u83b7\u53d6\u6570\u636e\u5168</li> <li>\u89e3\u51b3\u2f45\u6848 1:\u5f53\u6570\u636e\u91cf\u4e0d\u5927\u65f6\uff0c\u8bbe\u7f6e Primary Shard \u4e3a 1; \u5b9e\u73b0\u51c6\u786e\u6027</li> <li>\u65b9\u6848 2:\u5728\u5206\u5e03\u5f0f\u6570\u636e\u4e0a\uff0c\u8bbe\u7f6e <code>shard_size</code> \u53c2 \u6570\uff0c\u63d0\u2fbc\u7cbe\u786e\u5ea6<ul> <li>\u539f\u7406:\u6bcf\u6b21\u4ece Shard \u4e0a\u989d\u5916\u591a\u83b7\u53d6\u6570\u636e\uff0c\u63d0\u5347\u51c6\u786e\u7387</li> </ul> </li> </ul>"},{"location":"chap6/4chap6_accurate_aggragate/#7-show_term_doc_count_error","title":"7\u3001\u6253\u5f00 <code>show_term_doc_count_error</code>","text":""},{"location":"chap6/4chap6_accurate_aggragate/#8shard_size","title":"8\u3001<code>shard_size</code> \u8bbe\u5b9a","text":"<ul> <li>\u8c03\u6574 <code>shard size</code> \u2f24\u5c0f\uff0c\u964d\u4f4e <code>doc_count_error_upper_bound</code> \u6765\u63d0\u5347\u51c6\u786e\u5ea6 <ul> <li>\u589e\u52a0\u6574\u4f53\u8ba1\u7b97\u91cf\u91cf\uff0c\u63d0\u2fbc\u4e86\u51c6\u786e\u5ea6\uff0c\u4f46\u4f1a\u964d\u4f4e\u76f8\u5e94\u65f6\u95f4</li> </ul> </li> <li>Shard Size \u9ed8\u8ba4\u2f24\u5c0f\u8bbe\u5b9a<ul> <li><code>shard size = size *1.5 +10</code></li> <li>https://www.elastic.co/guide/en/elasticsearch/reference/7.1/search-aggregations-bucket-terms-aggregation.html#search-aggregations-bucket-terms-aggregation-approximate-counts</li> </ul> </li> </ul> <pre><code>DELETE my_flights\nPUT my_flights\n{\n  \"settings\": {\n    \"number_of_shards\": 20\n  },\n  \"mappings\" : {\n      \"properties\" : {\n        \"AvgTicketPrice\" : {\n          \"type\" : \"float\"\n        },\n        \"Cancelled\" : {\n          \"type\" : \"boolean\"\n        },\n        \"Carrier\" : {\n          \"type\" : \"keyword\"\n        },\n        \"Dest\" : {\n          \"type\" : \"keyword\"\n        },\n        \"DestAirportID\" : {\n          \"type\" : \"keyword\"\n        },\n        \"DestCityName\" : {\n          \"type\" : \"keyword\"\n        },\n        \"DestCountry\" : {\n          \"type\" : \"keyword\"\n        },\n        \"DestLocation\" : {\n          \"type\" : \"geo_point\"\n        },\n        \"DestRegion\" : {\n          \"type\" : \"keyword\"\n        },\n        \"DestWeather\" : {\n          \"type\" : \"keyword\"\n        },\n        \"DistanceKilometers\" : {\n          \"type\" : \"float\"\n        },\n        \"DistanceMiles\" : {\n          \"type\" : \"float\"\n        },\n        \"FlightDelay\" : {\n          \"type\" : \"boolean\"\n        },\n        \"FlightDelayMin\" : {\n          \"type\" : \"integer\"\n        },\n        \"FlightDelayType\" : {\n          \"type\" : \"keyword\"\n        },\n        \"FlightNum\" : {\n          \"type\" : \"keyword\"\n        },\n        \"FlightTimeHour\" : {\n          \"type\" : \"keyword\"\n        },\n        \"FlightTimeMin\" : {\n          \"type\" : \"float\"\n        },\n        \"Origin\" : {\n          \"type\" : \"keyword\"\n        },\n        \"OriginAirportID\" : {\n          \"type\" : \"keyword\"\n        },\n        \"OriginCityName\" : {\n          \"type\" : \"keyword\"\n        },\n        \"OriginCountry\" : {\n          \"type\" : \"keyword\"\n        },\n        \"OriginLocation\" : {\n          \"type\" : \"geo_point\"\n        },\n        \"OriginRegion\" : {\n          \"type\" : \"keyword\"\n        },\n        \"OriginWeather\" : {\n          \"type\" : \"keyword\"\n        },\n        \"dayOfWeek\" : {\n          \"type\" : \"integer\"\n        },\n        \"timestamp\" : {\n          \"type\" : \"date\"\n        }\n      }\n    }\n}\n</code></pre> <p>Output :</p> <pre><code>{\n  \"acknowledged\" : true,\n  \"shards_acknowledged\" : true,\n  \"index\" : \"my_flights\"\n}\n</code></pre>"},{"location":"chap6/4chap6_accurate_aggragate/#8-1-kibana_sample_data_flights-my_flights","title":"8-1 \u5c06<code>kibana_sample_data_flights</code> \u6570\u636e\u5bfc\u5165<code>my_flights</code>","text":"<pre><code>POST _reindex\n{\n  \"source\": {\n    \"index\": \"kibana_sample_data_flights\"\n  },\n  \"dest\": {\n    \"index\": \"my_flights\"\n  }\n}\n</code></pre> <pre><code>GET kibana_sample_data_flights/_count\n</code></pre> <p>Only one shard for <code>kibana_sample_data_flights</code></p> <pre><code>GET my_flights/_count\n</code></pre> <p></p> <p>20 shards for <code>my_flights</code></p> <pre><code>GET kibana_sample_data_flights/_search\n\nPOST kibana_sample_data_flights/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"weather\": {\n      \"terms\": {\n        \"field\":\"OriginWeather\",\n        \"size\":1,\n        \"shard_size\":1,\n        \"show_term_doc_count_error\":true\n      }\n    }\n  }\n}\n</code></pre> <p></p> <p><code>doc_count_error_upper_bound = 0</code></p> <p>\u56e0\u4e3a\u4eceES7\u5f00\u59cb\uff0c\u9ed8\u8ba4\u7684primary shard \u4e3a\u4e00\uff0c\u6240\u4ee5\u4e0d\u4f1a\u51fa\u73b0 Terms \u4e0d\u51c6\u7684\u95ee\u9898</p>"},{"location":"chap6/4chap6_accurate_aggragate/#8-2-shard-size","title":"8-2 \u8c03\u6574 shard size \u2f24\u5c0f","text":"<p>\u63d0\u9ad8 shard size \u2f24\u5c0f\uff0c\u964d\u4f4e <code>doc_count_error_upper_bound</code> \u6765\u63d0\u5347\u51c6\u786e\u5ea6</p> <p><code>\"shard_size\":1</code></p> <pre><code>GET my_flights/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"weather\": {\n      \"terms\": {\n        \"field\":\"OriginWeather\",\n        \"size\":1,\n        \"shard_size\":1,\n        \"show_term_doc_count_error\":true\n      }\n    }\n  }\n}\n</code></pre> <p></p> <p><code>\"shard_size\":10</code></p> <pre><code>GET my_flights/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"weather\": {\n      \"terms\": {\n        \"field\":\"OriginWeather\",\n        \"size\":1,\n        \"shard_size\":10,\n        \"show_term_doc_count_error\":true\n      }\n    }\n  }\n}\n</code></pre> <p></p> <p><code>doc_count_error_upper_bound = 0</code> \u5b8c\u5168\u6b63\u786e</p>"},{"location":"chap6/4chap6_accurate_aggragate/#9","title":"9\u3001\u672c\u8282\u603b\u7ed3","text":""},{"location":"chap6/4chap6_accurate_aggragate/#9-1-sizeshard_size","title":"9-1 size\u548c<code>shard_size</code>\u7684\u533a\u522b\uff1f","text":"<ul> <li>size\u662f\u6700\u7ec8\u8fd4\u56de\u591a\u5c11\u4e2abuckt\u7684\u6570\u91cf\u3002</li> <li><code>shard_size</code>\u662f\u6bcf\u4e2abucket\u5728\u4e00\u4e2a<code>shard</code>\u4e0a\u53d6\u56de\u7684<code>bucket</code>\u7684\u603b\u6570\u3002 \u7136\u540e\uff0c\u6bcf\u4e2a<code>shard</code>\u4e0a\u7684\u7ed3\u679c\uff0c\u4f1a\u5728<code>coordinate</code>\u8282\u70b9\u4e0a\u5728\u505a\u4e00\u6b21\u6c47\u603b\uff0c\u8fd4\u56de\u603b\u6570\u3002</li> </ul>"},{"location":"chap6/4chap6_accurate_aggragate/#9-2-doc_count_error_upper_bound","title":"9-2 <code>doc_count_error_upper_bound</code>","text":"<ul> <li>\u88ab\u9057\u6f0f\u7684term\u5206\u6876\u91cc\u9762\u5305\u542b\u7684\u6587\u6863\u6709\u53ef\u80fd\u7684\u6700\u5927\u503c\u2014\u2014\u5343\u4e07\u6ce8\u610f\u201c\u53ef\u80fd\u7684\u6700\u5927\u503c\u201d\uff01</li> <li>\u6587\u4e2d\u7684\u4f8b\u5b50 4+3 \u6ca1\u6bdb\u75c5\uff0c\u56e0\u4e3a\u53d6\u56de\u7684\u4e09\u4e2a\u7684\u6700\u5c0f\u7684\u6876\u91cc\u9762\u662f4\u4e2a\u3002\u6240\u4ee5\u9057\u6f0f\u7684\u6700\u5927\u7684\u53ef\u80fd\u6570\u503c\u662f4\u3002\u6ce8\u610f\u662f\u201c\u53ef\u80fd\u6700\u5927\u201d\u800c\u4e0d\u662f\u201c\u5b9e\u9645\u6700\u5927\u503c\u201d\u3002</li> </ul>"},{"location":"chap6/4chap6_accurate_aggragate/#9-3-coordinate","title":"9-3 \u5173\u4e8ecoordinate\u7684\u6ce8\u610f\u4e8b\u9879\uff1f","text":"<ul> <li>\u4efb\u4f55\u8282\u70b9\u90fd\u5177\u5907coordinate\u7684\u80fd\u529b\uff0c\u4e5f\u5c31\u662f\u8bf4\u4f60\u65e0\u6cd5\u914d\u7f6e\u4e00\u4e2a\u8282\u70b9\uff0c\u4e0d\u5177\u5907coordinate\u7684\u89d2\u8272\u3002</li> <li>\u4f46\u662f\u4f60\u53ef\u4ee5\u914d\u7f6e\u53ea\u8d1f\u8d23coordinate\u7684\u8282\u70b9\u3002\u6570\u636e\u5b58\u50a8\uff0c\u90fd\u4fdd\u5b58\u5728\u6570\u636e\u8282\u70b9\u4e0a\u3002\u4e00\u4e2a\u8282\u70b9\u5982\u679c\u662f\u6570\u636e\u8282\u70b9\uff0c\u5219\u5fc5\u7136\u5177\u5907\u5b58\u50a8\u6570\u636e\u7684\u80fd\u529b\uff0c\u800cES\u4e2d\u4efb\u4f55\u8282\u70b9\u90fd\u5929\u751f\u5177\u5907\u8def\u7531\u7684\u80fd\u529b\u3002</li> </ul>"},{"location":"chap7/1chap7_nested_obj/","title":"\u7b2c\u4e00\u8282 \u5bf9\u8c61\u53ca Nested \u5bf9\u8c61","text":""},{"location":"chap7/1chap7_nested_obj/#1","title":"1\u3001\u6570\u636e\u7684\u5173\u8054\u5173\u7cfb","text":"<ul> <li>\u771f\u5b9e\u4e16\u754c\u4e2d\u6709\u5f88\u591a\u91cd\u8981\u7684\u5173\u8054\u5173\u7cfb<ul> <li>\u535a\u5ba2/\u4f5c\u8005/\u8bc4\u8bba</li> <li>\u94f6\u884c\u8d26\u6237\u6709\u591a\u6b21\u4ea4\u6613\u8bb0\u5f55</li> <li>\u5ba2\u6237\u6709\u591a\u4e2a\u94f6\u2f8f\u8d26\u6237</li> <li>\u2f6c\u5f55\u6587\u4ef6\u6709\u591a\u4e2a\u2f42\u4ef6\u548c\u2f26\u76ee\u5f55</li> </ul> </li> </ul>"},{"location":"chap7/1chap7_nested_obj/#2","title":"2\u3001\u5173\u7cfb\u578b\u6570\u636e\u5e93\u7684\u8303\u5f0f\u5316\u8bbe\u8ba1","text":"<ul> <li>\u8303\u5f0f\u5316\u8bbe\u8ba1(Normalization)\u7684\u4e3b\u8981\u2f6c\u6807\u662f\u201c\u51cf\u5c11\u4e0d\u5fc5\u8981\u7684\u66f4\u65b0\u201d</li> <li>\u526f\u4f5c\u2f64: \u2f00\u4e2a\u5b8c\u5168\u8303\u5f0f\u5316\u8bbe\u8ba1\u7684\u6570\u636e\u5e93\u4f1a\u7ecf\u5e38\u9762\u4e34 \u201c\u67e5\u8be2\u7f13\u6162\u201d\u7684\u95ee\u9898<ul> <li>\u6570\u636e\u5e93\u8d8a\u8303\u5f0f\u5316\uff0c\u5c31\u9700\u8981 Join \u8d8a\u591a\u7684\u8868</li> </ul> </li> <li>\u8303\u5f0f\u5316\u8282\u7701\u4e86\u5b58\u50a8\u7a7a\u95f4\uff0c\u4f46\u662f\u5b58\u50a8\u7a7a\u95f4\u5374\u8d8a\u6765\u8d8a\u4fbf\u5b9c</li> <li>\u8303\u5f0f\u5316\u7b80\u5316\u4e86\u66f4\u65b0\uff0c\u4f46\u662f\u6570\u636e\u201c\u8bfb\u201d\u53d6\u64cd\u4f5c\u53ef\u80fd\u66f4\u591a</li> </ul>"},{"location":"chap7/1chap7_nested_obj/#3denormalization","title":"3\u3001Denormalization","text":"<ul> <li>\u53cd\u8303\u5f0f\u5316\u8bbe\u8ba1<ul> <li>\u6570\u636e \u201cFlattening\u201d\uff0c\u4e0d\u4f7f\u2f64\u5173\u8054\u5173\u7cfb\uff0c\u2f7d\u662f\u5728\u2f42\u6863\u4e2d\u4fdd\u5b58\u5197\u4f59\u7684\u6570\u636e\u62f7\u2ec9</li> </ul> </li> <li>\u4f18\u70b9: \u65e0\u9700\u5904\u7406 Joins \u64cd\u4f5c\uff0c\u6570\u636e\u8bfb\u53d6\u6027\u80fd\u597d<ul> <li>Elasticsearch \u901a\u8fc7\u538b\u7f29 <code>_source</code> \u5b57\u6bb5\uff0c\u51cf\u5c11\u78c1\u76d8\u7a7a\u95f4\u7684\u5f00\u9500</li> </ul> </li> <li>\u7f3a\u70b9:\u4e0d\u9002\u5408\u5728\u6570\u636e\u9891\u7e41\u4fee\u6539\u7684\u573a\u666f<ul> <li>\u4e00\u6761\u6570\u636e(\u2f64\u6237\u540d)\u7684\u6539\u52a8\uff0c\u53ef\u80fd\u4f1a\u5f15\u8d77\u5f88\u591a\u6570\u636e\u7684\u66f4\u65b0</li> </ul> </li> </ul>"},{"location":"chap7/1chap7_nested_obj/#4-elasticsearch","title":"4\u3001\u5728 Elasticsearch \u4e2d\u5904\u7406\u5173\u8054\u5173\u7cfb","text":"<ul> <li>\u5173\u7cfb\u578b\u6570\u636e\u5e93\uff0c\u2f00\u822c\u4f1a\u8003\u8651 Normalize \u6570\u636e; \u5728 Elasticsearch\uff0c\u5f80\u5f80\u8003\u8651 Denormalize \u6570\u636e<ul> <li>Denormalize \u7684\u597d\u5904:    \u8bfb\u7684\u901f\u5ea6\u53d8\u5feb / \u2f46\u9700\u8868\u8fde\u63a5 / \u2f46\u9700\u884c\u9501</li> </ul> </li> <li>Elasticsearch \u5e76\u4e0d\u64c5\u2ed3\u5904\u7406\u5173\u8054\u5173\u7cfb\u3002\u6211\u4eec\u2f00\u822c\u91c7\u7528\u4ee5\u4e0b\u56db\u79cd\u2f45\u6cd5\u5904\u7406\u5173\u8054<ul> <li>\u5bf9\u8c61\u7c7b\u578b</li> <li>\u5d4c\u5957\u5bf9\u8c61(Nested Object)</li> <li>\u2f57\u5b50\u5173\u8054\u5173\u7cfb(Parent / Child )</li> <li>\u5e94\u2f64\u7aef\u5173\u8054</li> </ul> </li> </ul>"},{"location":"chap7/1chap7_nested_obj/#4-1-1","title":"4-1 \u6848\u4f8b 1:\u535a\u5ba2\u548c\u5176\u4f5c\u8005\u4fe1\u606f","text":"<ul> <li>\u5bf9\u8c61\u7c7b\u578b<ul> <li>\u5728\u6bcf\u2f00\u535a\u5ba2\u7684\u2f42\u6863\u4e2d\u90fd\u4fdd\u7559\u4f5c\u8005\u7684\u4fe1\u606f</li> <li>\u5982\u679c\u4f5c\u8005\u4fe1\u606f\u53d1\u2f63\u53d8\u5316\uff0c\u9700\u8981\u4fee\u6539\u76f8\u5173\u7684\u535a\u5ba2\u6587\u6863</li> </ul> </li> </ul> <pre><code>DELETE blog\n# \u8bbe\u7f6eblog\u7684 Mapping\nPUT /blog\n{\n  \"mappings\": {\n    \"properties\": {\n      \"content\": {\n        \"type\": \"text\"\n      },\n      \"time\": {\n        \"type\": \"date\"\n      },\n      \"user\": {\n        \"properties\": {\n          \"city\": {\n            \"type\": \"text\"\n          },\n          \"userid\": {\n            \"type\": \"long\"\n          },\n          \"username\": {\n            \"type\": \"keyword\"\n          }\n        }\n      }\n    }\n  }\n}\n</code></pre> <pre><code># \u63d2\u5165\u4e00\u6761 Blog \u4fe1\u606f\nPUT blog/_doc/1\n{\n  \"content\":\"I like Elasticsearch\",\n  \"time\":\"2019-01-01T00:00:00\",\n  \"user\":{\n    \"userid\":1,\n    \"username\":\"Jack\",\n    \"city\":\"Shanghai\"\n  }\n}\n</code></pre> <pre><code># \u67e5\u8be2 Blog \u4fe1\u606f\nPOST blog/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\"match\": {\"content\": \"Elasticsearch\"}},\n        {\"match\": {\"user.username\": \"Jack\"}}\n      ]\n    }\n  }\n}\n</code></pre> <p>Output:</p> <pre><code>\"hits\" : {\n    \"total\" : {\n      \"value\" : 1,\n      \"relation\" : \"eq\"\n    },\n    \"max_score\" : 0.36464313,\n    \"hits\" : [\n      {\n        \"_index\" : \"blog\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"1\",\n        \"_score\" : 0.36464313,\n        \"_source\" : {\n          \"content\" : \"I like Elasticsearch\",\n          \"time\" : \"2019-01-01T00:00:00\",\n          \"user\" : {\n            \"userid\" : 1,\n            \"username\" : \"Jack\",\n            \"city\" : \"Shanghai\"\n          }\n        }\n      }\n    ]\n  }\n</code></pre> <ul> <li>\u901a\u8fc7\u2f00\u6761\u67e5\u8be2\u5373\u53ef\u83b7\u53d6\u5230\u535a\u5ba2\u548c\u4f5c\u8005\u4fe1\u606f</li> </ul> <p></p>"},{"location":"chap7/1chap7_nested_obj/#4-2-2","title":"4-2 \u6848\u4f8b 2:\u5305\u542b\u5bf9\u8c61\u6570\u7ec4\u7684\u2f42\u6863","text":"<pre><code>DELETE my_movies\n\n# \u7535\u5f71\u7684Mapping\u4fe1\u606f\nPUT my_movies\n{\n      \"mappings\" : {\n      \"properties\" : {\n        \"actors\" : {\n          \"properties\" : {\n            \"first_name\" : {\n              \"type\" : \"keyword\"\n            },\n            \"last_name\" : {\n              \"type\" : \"keyword\"\n            }\n          }\n        },\n        \"title\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n            }\n          }\n        }\n      }\n    }\n}\n</code></pre> <p>Output:</p> <pre><code>{\n  \"acknowledged\" : true,\n  \"shards_acknowledged\" : true,\n  \"index\" : \"my_movies\"\n}\n</code></pre> <pre><code># \u5199\u5165\u4e00\u6761\u7535\u5f71\u4fe1\u606f\nPOST my_movies/_doc/1\n{\n  \"title\":\"Speed\",\n  \"actors\":[\n    {\n      \"first_name\":\"Keanu\",\n      \"last_name\":\"Reeves\"\n    },\n\n    {\n      \"first_name\":\"Dennis\",\n      \"last_name\":\"Hopper\"\n    }\n\n  ]\n}\n</code></pre> <p></p> <pre><code># \u67e5\u8be2\u7535\u5f71\u4fe1\u606f\nPOST my_movies/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\"match\": {\"actors.first_name\": \"Keanu\"}},\n        {\"match\": {\"actors.last_name\": \"Hopper\"}}\n      ]\n    }\n  }\n\n}\n</code></pre> <p>Output:</p> <pre><code>\"max_score\" : 0.723315,\n    \"hits\" : [\n      {\n        \"_index\" : \"my_movies\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"1\",\n        \"_score\" : 0.723315,\n        \"_source\" : {\n          \"title\" : \"Speed\",\n          \"actors\" : [\n            {\n              \"first_name\" : \"Keanu\",\n              \"last_name\" : \"Reeves\"\n            },\n            {\n              \"first_name\" : \"Dennis\",\n              \"last_name\" : \"Hopper\"\n            }\n          ]\n        }\n      }\n    ]\n</code></pre>"},{"location":"chap7/1chap7_nested_obj/#5","title":"5\u3001\u4e3a\u4ec0\u4e48\u4f1a\u641c\u5230\u4e0d\u9700\u8981\u7684\u7ed3\u679c?","text":"<ul> <li>\u5b58\u50a8\u65f6\uff0c\u5185\u90e8\u5bf9\u8c61\u7684\u8fb9\u754c\u5e76\u6ca1\u6709\u8003\u8651\u5728\u5185\uff0cJSON \u683c\u5f0f\u88ab\u5904\u7406\u7406\u6210\u6241\u5e73\u5f0f\u952e\u503c\u5bf9\u7684\u7ed3\u6784 </li> <li>\u5f53\u5bf9\u591a\u4e2a\u5b57\u6bb5\u8fdb\u2f8f\u67e5\u8be2\u65f6\uff0c\u5bfc\u81f4\u4e86\u610f\u5916\u7684\u641c\u7d22\u7ed3\u679c</li> <li>\u53ef\u4ee5\u2f64 Nested Data Type \u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898</li> </ul>"},{"location":"chap7/1chap7_nested_obj/#6-nested-data-type","title":"6\u3001\u4ec0\u4e48\u662f Nested Data Type","text":"<ul> <li>Nested \u6570\u636e\u7c7b\u578b: \u5141\u8bb8\u5bf9\u8c61\u6570\u7ec4\u4e2d\u7684\u5bf9\u8c61\u88ab\u72ec\u7acb\u7d22\u5f15</li> <li>\u4f7f\u2f64 nested \u548c properties \u5173\u952e\u5b57\uff0c\u5c06\u6240\u6709 actors \u7d22\u5f15\u5230\u591a\u4e2a\u5206\u9694\u7684\u2f42\u6863</li> <li>\u5728\u5185\u90e8\uff0c Nested \u2f42\u6863\u4f1a\u88ab\u4fdd\u5b58\u5728\u4e24\u4e2a Lucene \u2f42\u6863\u4e2d\uff0c\u5728\u67e5\u8be2\u65f6\u505a Join \u5904\u7406</li> </ul> <pre><code>DELETE my_movies\n# \u521b\u5efa Nested \u5bf9\u8c61 Mapping\nPUT my_movies\n{\n      \"mappings\" : {\n      \"properties\" : {\n        \"actors\" : {\n          \"type\": \"nested\",\n          \"properties\" : {\n            \"first_name\" : {\"type\" : \"keyword\"},\n            \"last_name\" : {\"type\" : \"keyword\"}\n          }},\n        \"title\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\"keyword\":{\"type\":\"keyword\",\"ignore_above\":256}}\n        }\n      }\n    }\n}\n</code></pre> <pre><code>POST my_movies/_doc/1\n{\n  \"title\":\"Speed\",\n  \"actors\":[\n    {\n      \"first_name\":\"Keanu\",\n      \"last_name\":\"Reeves\"\n    },\n\n    {\n      \"first_name\":\"Dennis\",\n      \"last_name\":\"Hopper\"\n    }\n\n  ]\n}\n</code></pre> <p>Output:</p> <pre><code>{\n  \"_index\" : \"my_movies\",\n  \"_type\" : \"_doc\",\n  \"_id\" : \"1\",\n  \"_version\" : 1,\n  \"result\" : \"created\",\n  \"_shards\" : {\n    \"total\" : 2,\n    \"successful\" : 2,\n    \"failed\" : 0\n  },\n  \"_seq_no\" : 0,\n  \"_primary_term\" : 1\n}\n</code></pre>"},{"location":"chap7/1chap7_nested_obj/#7","title":"7\u3001\u5d4c\u5957\u67e5\u8be2","text":"<p>\u5728\u5185\u90e8\uff0c Nested \u2f42\u6863\u4f1a\u88ab\u4fdd\u5b58\u5728\u4e24\u4e2a Lucene \u2f42\u6587\u6863\u4e2d\uff0c\u4f1a\u5728\u67e5\u8be2\u65f6\u505a Join \u5904\u7406</p> <p></p> <pre><code># Nested \u67e5\u8be2\nPOST my_movies/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\"match\": {\"title\": \"Speed\"}},\n        {\n          \"nested\": {\n            \"path\": \"actors\",\n            \"query\": {\n              \"bool\": {\n                \"must\": [\n                  {\"match\": {\n                    \"actors.first_name\": \"Keanu\"\n                  }},\n\n                  {\"match\": {\n                    \"actors.last_name\": \"Hopper\"\n                  }}\n                ]\n              }\n            }\n          }\n        }\n      ]\n    }\n  }\n}\n</code></pre> <p>Output: The name does not exist</p> <pre><code>{\n  \"took\" : 261,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 1,\n    \"successful\" : 1,\n    \"skipped\" : 0,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : {\n      \"value\" : 0,\n      \"relation\" : \"eq\"\n    },\n    \"max_score\" : null,\n    \"hits\" : [ ]\n  }\n}\n</code></pre>"},{"location":"chap7/1chap7_nested_obj/#8nested-aggregation","title":"8\u3001\u5d4c\u5957\u805a\u5408Nested Aggregation","text":"<pre><code># Nested Aggregation\nPOST my_movies/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"actors\": {\n      \"nested\": {\n        \"path\": \"actors\"\n      },\n      \"aggs\": {\n        \"actor_name\": {\n          \"terms\": {\n            \"field\": \"actors.first_name\",\n            \"size\": 10\n          }\n        }\n      }\n    }\n  }\n}\n</code></pre> <p>Output</p> <pre><code> \"aggregations\" : {\n    \"actors\" : {\n      \"doc_count\" : 2,\n      \"actor_name\" : {\n        \"doc_count_error_upper_bound\" : 0,\n        \"sum_other_doc_count\" : 0,\n        \"buckets\" : [\n          {\n            \"key\" : \"Dennis\",\n            \"doc_count\" : 1\n          },\n          {\n            \"key\" : \"Keanu\",\n            \"doc_count\" : 1\n          }\n        ]\n      }\n    }\n  }\n</code></pre> <p>\u666e\u901a aggregation\u4e0d\u5de5\u4f5c</p> <pre><code># \u666e\u901a aggregation\u4e0d\u5de5\u4f5c\nPOST my_movies/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"NAME\": {\n      \"terms\": {\n        \"field\": \"actors.first_name\",\n        \"size\": 10\n      }\n    }\n  }\n}\n</code></pre> <p>Output</p> <pre><code>{\n  \"took\" : 1,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 1,\n    \"successful\" : 1,\n    \"skipped\" : 0,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : {\n      \"value\" : 1,\n      \"relation\" : \"eq\"\n    },\n    \"max_score\" : null,\n    \"hits\" : [ ]\n  },\n  \"aggregations\" : {\n    \"NAME\" : {\n      \"doc_count_error_upper_bound\" : 0,\n      \"sum_other_doc_count\" : 0,\n      \"buckets\" : [ ]\n    }\n  }\n}\n</code></pre>"},{"location":"chap7/1chap7_nested_obj/#9","title":"9\u3001\u672c\u8282\u77e5\u8bc6\u70b9","text":"<ul> <li>\u5728 Elasticsearch \u4e2d\uff0c\u5f80\u5f80\u4f1a Denormalize \u6570\u636e\u7684\u2f45\u5f0f\u5efa\u6a21(\u4f7f\u2f64\u7528\u5bf9\u8c61\u7684\u2f45\u65b9\u5f0f) <ul> <li>\u597d\u5904\u662f:\u8bfb\u5199\u7684\u901f\u5ea6\u53d8\u5feb / \u2f46\u65e0\u9700\u8868\u8fde\u63a5 / \u2f46\u65e0\u9700\u2f8f\u9501</li> </ul> </li> <li>\u5982\u679c\u2f42\u6863\u7684\u66f4\u65b0\u5e76\u4e0d\u9891\u7e41\uff0c\u53ef\u4ee5\u5728\u6587\u6863\u4e2d\u4f7f\u2f64\u5bf9\u8c61 </li> <li>\u5f53\u5bf9\u8c61\u5305\u542b\u4e86\u4e86\u591a\u503c\u5bf9\u8c61\u65f6<ul> <li>\u53ef\u4ee5\u4f7f\u2f64\u5d4c\u5957\u5bf9\u8c61(Nested Object)\u89e3\u51b3\u67e5\u8be2\u6b63\u786e\u6027\u7684\u95ee\u9898</li> </ul> </li> </ul>"},{"location":"chap7/1chap7_nested_obj/#9-1","title":"9-1 \u63d0\u95ee","text":"<ol> <li>\u53cd\u8303\u5f0f\u5316\u8bbe\u8ba1\u7684\u7f3a\u70b9\u662f\u4e0d\u9002\u5408\u5728\u6570\u636e\u9891\u7e41\u4fee\u6539\u7684\u573a\u666f\uff0c\u54a8\u8be2\u4e0b\uff0c\u4ec0\u4e48\u9891\u6b21\u7b97\u9891\u7e41\u4fee\u6539\uff1f</li> </ol> <p>\u4e3e\u4e2a\u4f8b\u5b50\uff0c\u53cd\u8303\u5f0f\u5316\u7684\u8bbe\u8ba1\uff0c\u4f1a\u5728\u7535\u5f71\u4e2d\u4fdd\u5b58\u8fd9\u4e2a\u6f14\u5458\u7684\u5168\u90e8\u4fe1\u606f\uff0c\u800c\u4e0d\u662f\u4e00\u4e2a\u6f14\u5458\u7684ID\u3002\u5f53\u4e00\u4e2a\u6f14\u5458\u6539\u4e86\u540d\u5b57\uff0c\u6211\u4eec\u5c31\u9700\u8981\u5c06\u5305\u542b\u4e86\u6240\u6709\u7535\u5f71\u7684\u4fe1\u606f\uff0c\u90fd\u505a\u4e00\u6b21update\u3002\u6240\u4ee5\uff0c\u4e00\u4e2a\u4e0e\u6f14\u5458\u4e0d\u4f1a\u5929\u5929\u6539\u540d\uff0c\u6240\u4ee5\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u4fee\u6539\u9891\u6b21\u4e0d\u9ad8\u3002\u4f46\u662f\u5982\u679c\u4f60\u4fdd\u5b58\u7684\u4e0d\u662f\u6f14\u5458\u7684\u51fa\u751f\u5e74\u6708\uff0c\u800c\u662f\u4fdd\u7559\u4e86\u4ed6\u7684\u5e74\u9f84\uff0c\u76f8\u5bf9\u59d3\u540d\uff0c\u8fd9\u4e2a\u4fee\u6539\u7684\u9891\u7387\u5c31\u8981\u9ad8\u4e00\u4e9b</p>"},{"location":"chap7/2chap7_parent_child/","title":"\u7b2c\u4e8c\u8282 \u6587\u6863\u7684\u7236\u5b50\u5173\u7cfb","text":""},{"location":"chap7/2chap7_parent_child/#1","title":"1\u3001\u6587\u6863\u7684\u7236\u5b50\u5173\u7cfb","text":"<ul> <li>\u5bf9\u8c61\u548c Nested \u5bf9\u8c61\u7684\u5c40\u9650\u6027<ul> <li>\u6bcf\u6b21\u66f4\u65b0\uff0c\u9700\u8981\u91cd\u65b0\u7d22\u5f15\u6574\u4e2a\u5bf9\u8c61(\u5305\u62ec\u6839\u5bf9\u8c61\u548c\u5d4c\u5957\u5bf9\u8c61)</li> </ul> </li> <li>ES \u63d0\u4f9b\u4e86\u7c7b\u4f3c\u5173\u7cfb\u578b\u6570\u636e\u5e93\u4e2d Join \u7684\u5b9e\u73b0\u3002\u4f7f\u7528 Join \u6570\u636e\u7c7b\u578b\u5b9e\u73b0\uff0c\u53ef\u4ee5\u901a\u8fc7\u7ef4\u62a4 Parent / Child \u7684\u5173\u7cfb\uff0c\u4ece\u2f7d\u5206\u79bb\u4e24\u4e2a\u5bf9\u8c61<ul> <li>\u2f57\u6587\u6863\u548c\u2f26\u6587\u6863\u662f\u4e24\u4e2a\u72ec\u2f74\u7684\u6587\u6863<ul> <li>\u66f4\u65b0\u2f57\u6587\u6863\u65e0\u9700\u91cd\u65b0\u7d22\u5f15\u5b50\u6587\u6863\u3002</li> <li>\u2f26\u6587\u6863\u88ab\u6dfb\u52a0\uff0c\u66f4\u65b0\u6216\u8005\u5220\u9664\u4e5f\u4e0d\u4f1a\u5f71\u54cd\u5230\u2f57\u6587\u6863\u548c\u5176\u4ed6\u7684\u2f26\u6587\u6863</li> </ul> </li> </ul> </li> </ul>"},{"location":"chap7/2chap7_parent_child/#2","title":"2\u3001\u2f57\u5b50\u5173\u7cfb","text":""},{"location":"chap7/2chap7_parent_child/#2-1","title":"2-1 \u5b9a\u4e49\u2f57\u5b50\u5173\u7cfb\u7684\u2f0f\u4e2a\u6b65\u9aa4","text":"<ol> <li>\u8bbe\u7f6e\u7d22\u5f15\u7684 Mapping </li> <li>\u7d22\u5f15\u2f57\u6587\u6863</li> <li>\u7d22\u5f15\u2f26\u6587\u6863</li> <li>\u6309\u9700\u67e5\u8be2\u2f42\u6863</li> </ol>"},{"location":"chap7/2chap7_parent_child/#2-2-mapping","title":"2-2 \u8bbe\u7f6e Mapping","text":""},{"location":"chap7/2chap7_parent_child/#2-3","title":"2-3 \u7d22\u5f15\u2f57\u2f42\u6863","text":""},{"location":"chap7/2chap7_parent_child/#2-4","title":"2-4 \u7d22\u5f15\u2f26\u6587\u6863","text":"<ul> <li>\u2f57\u6587\u6863\u548c\u2f26\u6587\u6863\u5fc5\u987b\u5b58\u5728\u76f8\u540c\u7684\u5206\u2f5a\u4e0a <ul> <li>\u786e\u4fdd\u67e5\u8be2 join \u7684\u6027\u80fd</li> </ul> </li> <li>\u5f53\u6307\u5b9a\u2f26\u6587\u6863\u65f6\u5019\uff0c\u5fc5\u987b\u6307\u5b9a\u5b83\u7684\u2f57\u6587\u6863 Id <ul> <li>\u4f7f\u2f64 route \u53c2\u6570\u6765\u4fdd\u8bc1\uff0c\u5206\u914d\u5230\u76f8\u540c\u7684\u5206\u2f5a</li> </ul> </li> </ul> <pre><code>DELETE my_blogs\n\n# \u8bbe\u5b9a Parent/Child Mapping\nPUT my_blogs\n{\n  \"settings\": {\n    \"number_of_shards\": 2\n  },\n  \"mappings\": {\n    \"properties\": {\n      \"blog_comments_relation\": {\n        \"type\": \"join\",\n        \"relations\": {\n          \"blog\": \"comment\"\n        }\n      },\n      \"content\": {\n        \"type\": \"text\"\n      },\n      \"title\": {\n        \"type\": \"keyword\"\n      }\n    }\n  }\n}\n</code></pre> <ul> <li>\u2f57\u6587\u6863: blog</li> <li>\u5b50\u6587\u6863\uff1acomment</li> </ul> <p>Output:</p> <pre><code>{\n  \"acknowledged\" : true,\n  \"shards_acknowledged\" : true,\n  \"index\" : \"my_blogs\"\n}\n</code></pre>"},{"location":"chap7/2chap7_parent_child/#2-5","title":"2-5 \u63d2\u5165\u7d22\u5f15\u7236\u6587\u6863","text":"<pre><code>#\u7d22\u5f15\u7236\u6587\u6863\nPUT my_blogs/_doc/blog1\n{\n  \"title\":\"Learning Elasticsearch\",\n  \"content\":\"learning ELK @ geektime\",\n  \"blog_comments_relation\":{\n    \"name\":\"blog\"\n  }\n}\n\n\n#\u7d22\u5f15\u7236\u6587\u6863\nPUT my_blogs/_doc/blog2\n{\n  \"title\":\"Learning Hadoop\",\n  \"content\":\"learning Hadoop\",\n    \"blog_comments_relation\":{\n    \"name\":\"blog\"\n  }\n}\n</code></pre>"},{"location":"chap7/2chap7_parent_child/#2-6","title":"2-6 \u63d2\u5165\u7d22\u5f15\u2f26\u6587\u6863","text":"<pre><code>#\u7d22\u5f15\u5b50\u6587\u6863\nPUT my_blogs/_doc/comment1?routing=blog1\n{\n  \"comment\":\"I am learning ELK\",\n  \"username\":\"Jack\",\n  \"blog_comments_relation\":{\n    \"name\":\"comment\",\n    \"parent\":\"blog1\"\n  }\n}\n</code></pre>"},{"location":"chap7/2chap7_parent_child/#2-7","title":"2-7 \u67e5\u8be2\u6240\u6709\u6587\u6863","text":"<pre><code># \u67e5\u8be2\u6240\u6709\u6587\u6863\nPOST my_blogs/_search\n{\n\n}\n</code></pre> <pre><code>\"hits\" : {\n    \"total\" : {\n      \"value\" : 5,\n      \"relation\" : \"eq\"\n    },\n    \"max_score\" : 1.0,\n    \"hits\" : [\n      {\n        \"_index\" : \"my_blogs\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"blog1\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"title\" : \"Learning Elasticsearch\",\n          \"content\" : \"learning ELK @ geektime\",\n          \"blog_comments_relation\" : {\n            \"name\" : \"blog\"\n          }\n        }\n      },\n      {\n        \"_index\" : \"my_blogs\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"blog2\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"title\" : \"Learning Hadoop\",\n          \"content\" : \"learning Hadoop\",\n          \"blog_comments_relation\" : {\n            \"name\" : \"blog\"\n          }\n        }\n      },\n      {\n        \"_index\" : \"my_blogs\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"comment1\",\n        \"_score\" : 1.0,\n        \"_routing\" : \"blog1\",\n        \"_source\" : {\n          \"comment\" : \"I am learning ELK\",\n          \"username\" : \"Jack\",\n          \"blog_comments_relation\" : {\n            \"name\" : \"comment\",\n            \"parent\" : \"blog1\"\n          }\n        }\n      },\n      {\n        \"_index\" : \"my_blogs\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"comment2\",\n        \"_score\" : 1.0,\n        \"_routing\" : \"blog2\",\n        \"_source\" : {\n          \"comment\" : \"I like Hadoop!!!!!\",\n          \"username\" : \"Jack\",\n          \"blog_comments_relation\" : {\n            \"name\" : \"comment\",\n            \"parent\" : \"blog2\"\n          }\n        }\n      },\n      {\n        \"_index\" : \"my_blogs\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"comment3\",\n        \"_score\" : 1.0,\n        \"_routing\" : \"blog2\",\n        \"_source\" : {\n          \"comment\" : \"Hello Hadoop\",\n          \"username\" : \"Bob\",\n          \"blog_comments_relation\" : {\n            \"name\" : \"comment\",\n            \"parent\" : \"blog2\"\n          }\n        }\n      }\n    ]\n  }\n</code></pre> <p>\u6839\u636e\u7236\u6587\u6863ID\u67e5\u770b</p> <pre><code>#\u6839\u636e\u7236\u6587\u6863ID\u67e5\u770b\nGET my_blogs/_doc/blog2\n</code></pre> <p>Output:</p> <pre><code>{\n  \"_index\" : \"my_blogs\",\n  \"_type\" : \"_doc\",\n  \"_id\" : \"blog2\",\n  \"_version\" : 1,\n  \"_seq_no\" : 1,\n  \"_primary_term\" : 1,\n  \"found\" : true,\n  \"_source\" : {\n    \"title\" : \"Learning Hadoop\",\n    \"content\" : \"learning Hadoop\",\n    \"blog_comments_relation\" : {\n      \"name\" : \"blog\"\n    }\n  }\n</code></pre>"},{"location":"chap7/2chap7_parent_child/#3parent-child","title":"3\u3001Parent / Child \u6240\u2f40\u6301\u7684\u67e5\u8be2","text":"<ul> <li>\u67e5\u8be2\u6240\u6709\u2f42\u6863</li> <li>Parent Id \u67e5\u8be2</li> <li>Has Child \u67e5\u8be2</li> <li>Has Parent \u67e5\u8be2</li> </ul>"},{"location":"chap7/2chap7_parent_child/#3-1-has_child","title":"3-1 \u4f7f\u2f64 <code>has_child</code> \u67e5\u8be2","text":"<ul> <li>\u8fd4\u56de\u2f57\u6587\u6863</li> <li>\u901a\u8fc7\u5bf9\u2f26\u6587\u6863\u8fdb\u2f8f\u67e5\u8be2<ul> <li>\u8fd4\u56de\u5177\u6709\u76f8\u5173\u2f26\u6587\u6863\u7684\u2f57\u6587\u6863</li> <li>\u2f57\u5b50\u2f42\u6863\u5728\u76f8\u540c\u7684\u5206\u7247\u4e0a\uff0c\u56e0\u6b64 Join \u6548\u7387\u2fbc</li> </ul> </li> </ul> <pre><code># Has Child \u67e5\u8be2,\u8fd4\u56de\u7236\u6587\u6863\nPOST my_blogs/_search\n{\n  \"query\": {\n    \"has_child\": {\n      \"type\": \"comment\",\n      \"query\" : {\n                \"match\": {\n                    \"username\" : \"Jack\"\n                }\n            }\n    }\n  }\n</code></pre> <p>Output:</p> <pre><code>\"hits\" : {\n    \"total\" : {\n      \"value\" : 2,\n      \"relation\" : \"eq\"\n    },\n    \"max_score\" : 1.0,\n    \"hits\" : [\n      {\n        \"_index\" : \"my_blogs\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"blog1\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"title\" : \"Learning Elasticsearch\",\n          \"content\" : \"learning ELK @ geektime\",\n          \"blog_comments_relation\" : {\n            \"name\" : \"blog\"\n          }\n        }\n      },\n      {\n        \"_index\" : \"my_blogs\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"blog2\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"title\" : \"Learning Hadoop\",\n          \"content\" : \"learning Hadoop\",\n          \"blog_comments_relation\" : {\n            \"name\" : \"blog\"\n          }\n        }\n      }\n    ]\n</code></pre>"},{"location":"chap7/2chap7_parent_child/#3-2-has_parent","title":"3-2 \u4f7f\u7528 <code>has_parent</code> \u67e5\u8be2","text":"<ul> <li>\u8fd4\u56de\u76f8\u5173\u7684\u2f26\u6587\u6863</li> <li>\u901a\u8fc7\u5bf9\u2f57\u6587\u6863\u8fdb\u2f8f\u67e5\u8be2<ul> <li>\u8fd4\u56de\u6240\u6709\u76f8\u5173\u2f26\u6587\u6863</li> </ul> </li> </ul> <pre><code># Has Parent \u67e5\u8be2\uff0c\u8fd4\u56de\u76f8\u5173\u7684\u5b50\u6587\u6863\nPOST my_blogs/_search\n{\n  \"query\": {\n    \"has_parent\": {\n      \"parent_type\": \"blog\",\n      \"query\" : {\n                \"match\": {\n                    \"title\" : \"Learning Hadoop\"\n                }\n            }\n    }\n  }\n}\n</code></pre> <p>Output:</p> <pre><code> \"hits\" : [\n      {\n        \"_index\" : \"my_blogs\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"comment2\",\n        \"_score\" : 1.0,\n        \"_routing\" : \"blog2\",\n        \"_source\" : {\n          \"comment\" : \"I like Hadoop!!!!!\",\n          \"username\" : \"Jack\",\n          \"blog_comments_relation\" : {\n            \"name\" : \"comment\",\n            \"parent\" : \"blog2\"\n          }\n        }\n      },\n      {\n        \"_index\" : \"my_blogs\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"comment3\",\n        \"_score\" : 1.0,\n        \"_routing\" : \"blog2\",\n        \"_source\" : {\n          \"comment\" : \"Hello Hadoop\",\n          \"username\" : \"Bob\",\n          \"blog_comments_relation\" : {\n            \"name\" : \"comment\",\n            \"parent\" : \"blog2\"\n          }\n        }\n      }\n    ]\n</code></pre>"},{"location":"chap7/2chap7_parent_child/#3-2-parent_id","title":"3-2 \u4f7f\u2f64 <code>parent_id</code> \u67e5\u8be2","text":"<ul> <li>\u8fd4\u56de\u6240\u6709\u76f8\u5173\u2f26\u6587\u6863</li> <li>\u901a\u8fc7\u5bf9\u2f57\u6587\u6863 Id \u8fdb\u2f8f\u67e5\u8be2<ul> <li>\u8fd4\u56de\u6240\u6709\u76f8\u5173\u2f26\u6587\u6863</li> </ul> </li> </ul> <p>Parent Id \u67e5\u8be2</p> <pre><code># Parent Id \u67e5\u8be2\nPOST my_blogs/_search\n{\n  \"query\": {\n    \"parent_id\": {\n      \"type\": \"comment\",\n      \"id\": \"blog2\"\n    }\n  }\n}\n</code></pre> <p>output</p> <pre><code>\"max_score\" : 0.44183272,\n    \"hits\" : [\n      {\n        \"_index\" : \"my_blogs\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"comment2\",\n        \"_score\" : 0.44183272,\n        \"_routing\" : \"blog2\",\n        \"_source\" : {\n          \"comment\" : \"I like Hadoop!!!!!\",\n          \"username\" : \"Jack\",\n          \"blog_comments_relation\" : {\n            \"name\" : \"comment\",\n            \"parent\" : \"blog2\"\n          }\n        }\n      },\n      {\n        \"_index\" : \"my_blogs\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"comment3\",\n        \"_score\" : 0.44183272,\n        \"_routing\" : \"blog2\",\n        \"_source\" : {\n          \"comment\" : \"Hello Hadoop\",\n          \"username\" : \"Bob\",\n          \"blog_comments_relation\" : {\n            \"name\" : \"comment\",\n            \"parent\" : \"blog2\"\n          }\n        }\n      }\n    ]\n</code></pre>"},{"location":"chap7/2chap7_parent_child/#3-3","title":"3-3 \u8bbf\u95ee\u2f26\u2f42\u6863","text":"<ul> <li>\u9700\u6307\u5b9a\u2f57\u6587\u6863 routing \u53c2\u6570</li> </ul> <pre><code>#\u901a\u8fc7ID \uff0c\u8bbf\u95ee\u5b50\u6587\u6863\nGET my_blogs/_doc/comment3\n#\u901a\u8fc7ID\u548crouting \uff0c\u8bbf\u95ee\u5b50\u6587\u6863\nGET my_blogs/_doc/comment3?routing=blog2\n</code></pre> <p>Output:</p> <pre><code>{\n  \"_index\" : \"my_blogs\",\n  \"_type\" : \"_doc\",\n  \"_id\" : \"comment3\",\n  \"_version\" : 1,\n  \"_seq_no\" : 5,\n  \"_primary_term\" : 1,\n  \"_routing\" : \"blog2\",\n  \"found\" : true,\n  \"_source\" : {\n    \"comment\" : \"Hello Hadoop\",\n    \"username\" : \"Bob\",\n    \"blog_comments_relation\" : {\n      \"name\" : \"comment\",\n      \"parent\" : \"blog2\"\n    }\n  }\n}\n</code></pre>"},{"location":"chap7/2chap7_parent_child/#3-4","title":"3-4 \u66f4\u65b0\u2f26\u6587\u6863","text":"<ul> <li>\u66f4\u65b0\u2f26\u2f42\u6863\u4e0d\u4f1a\u5f71\u54cd\u5230\u2f57\u2f42\u6863</li> </ul> <pre><code>#\u66f4\u65b0\u5b50\u6587\u6863\nPUT my_blogs/_doc/comment3?routing=blog2\n{\n    \"comment\": \"Hello Hadoop??\",\n    \"blog_comments_relation\": {\n      \"name\": \"comment\",\n      \"parent\": \"blog2\"\n    }\n}\n</code></pre>"},{"location":"chap7/2chap7_parent_child/#4-vs","title":"4\u3001\u5d4c\u5957\u5bf9\u8c61 v.s \u2f57\u2f26\u2f42\u6863","text":""},{"location":"chap7/2chap7_parent_child/#5","title":"5\u3001\u672c\u8282\u603b\u7ed3","text":"<ul> <li>\u5d4c\u5957\u5bf9\u8c61\u53cd\u8303\u5f0f\u6a21\u5f0f\u8bbe\u8ba1\uff0c\u901a\u8fc7\u5197\u4f59\u6570\u636e\u6765\u63d0\u9ad8\u67e5\u8be2\u6027\u80fd\uff0c\u9002\u7528\u4e8e\u8bfb\u591a\u5199\u5c11\u7684\u573a\u666f\u3002</li> <li>\u7236\u5b50\u6587\u6863\u7c7b\u4f3c\u5173\u7cfb\u578b\u6570\u636e\u5e93\u4e2d\u7684\u5173\u8054\u5173\u7cfb\uff0c\u9002\u7528\u4e8e\u5199\u591a\u7684\u573a\u666f\uff0c\u51cf\u5c11\u4e86\u6587\u6863\u4fee\u6539\u7684\u8303\u56f4\u3002</li> <li>\u611f\u89c9\u5c31\u662f\u65f6\u7a7a\u7684\u6b64\u6d88\u5f7c\u957f\uff0c\u8981\u63d0\u9ad8\u6027\u80fd\u5c31\u8d39\u70b9\u7a7a\u95f4\uff0c\u8981\u8282\u7701\u4fee\u6539\u7684\u7a7a\u95f4\u5c31\u8d39\u70b9\u6027\u80fd\u3002</li> <li>\u76f8\u5bf9\u6765\u8bf4\u65f6\u95f4\u66f4\u5b9d\u8d35\uff0c\u4e5f\u5c31\u662f\u600e\u4e48\u80fd\u63d0\u9ad8\u6027\u80fd\u600e\u4e48\u6765\u66f4\u5408\u9002\uff01</li> </ul> <p>blog\u7684\u6d4f\u89c8\u91cf\u548c\u8bc4\u8bba\u6570\u7b49\u9891\u7e41\u66f4\u65b0\u7684\u6570\u5b57\u5b57\u6bb5\u9002\u5408\u7528\u7236\u5b50\u7ed3\u6784\u5b58\u50a8\u5417\uff1f</p> <p>\u6d4f\u89c8\u91cf\u5982\u679c\u53d8\u5316\u975e\u5e38\u5feb\uff0c\u6570\u636e\u91cf\u975e\u5e38\u7684\u5927\uff0c\u5efa\u8bae\u4e0d\u8981\u505a\u5b9e\u65f6\u66f4\u65b0\uff0c\u4f1a\u6709\u6027\u80fd\u7684\u95ee\u9898\uff0c\u53ef\u4ee5\u6bcf\u5929\u5b9a\u671f\u505a\u589e\u91cfupdate\uff0c\u4e5f\u53ef\u4ee5\u8003\u8651\u6216\u8005\u53ea\u8bb0\u5f55\u6570\u636e\u5e93\u7684\u5b57\u6bb5\uff0c\u5230\u6570\u636e\u5e93\u53d6\u6d4f\u89c8\u91cf</p> <p>\u6d4f\u89c8\u91cf\u5982\u679c\u53d8\u5316\u975e\u5e38\u5feb\uff0c\u6570\u636e\u91cf\u975e\u5e38\u7684\u5927\uff0c\u5efa\u8bae\u4e0d\u8981\u505a\u5b9e\u65f6\u66f4\u65b0\uff0c\u4f1a\u6709\u6027\u80fd\u7684\u95ee\u9898\uff0c\u53ef\u4ee5\u6bcf\u5929\u5b9a\u671f\u505a\u589e\u91cfupdate\uff0c\u4e5f\u53ef\u4ee5\u8003\u8651\u6216\u8005\u53ea\u8bb0\u5f55\u6570\u636e\u5e93\u7684\u5b57\u6bb5\uff0c\u5230\u6570\u636e\u5e93\u53d6\u6d4f\u89c8\u91cf</p> <p>\u7236\u5b50\u6587\u6863\u5173\u7cfb\u9002\u5408\u5927\u91cf\u66f4\u65b0\u7684\u64cd\u4f5c\u3002\u6bd4\u5982blog\u91cc\u6709\u8bc4\u8bba\u4fe1\u606f\uff0c\u7ecf\u5e38\u6709\u5927\u91cf\u7684\u66f4\u65b0\u4fee\u6539\u3002\u5d4c\u5957\u5bf9\u8c61\u9002\u7528\u4e8e\u5b57\u6bb5\u4e2d\u6709\u591a\u503c\u5bf9\u8c61\uff0c\u540c\u65f6\u9700\u8981\u67e5\u8be2\u3002\u8fd9\u5728\u8bfe\u7a0b\u4e2d\u6709\u63d0\u5230\u7684</p>"},{"location":"chap7/3chap7_updateindex_reindex/","title":"\u7b2c\u4e09\u8282 Update By Query &amp; Reindex API","text":""},{"location":"chap7/3chap7_updateindex_reindex/#1","title":"1\u3001\u4f7f\u2f64\u573a\u666f","text":"<ul> <li>\u4e00\u822c\u5728\u4ee5\u4e0b\u2f0f\u79cd\u60c5\u51b5\u65f6\uff0c\u6211\u4eec\u9700\u8981\u91cd\u5efa\u7d22\u5f15<ul> <li>\u7d22\u5f15\u7684 Mappings \u53d1\u751f\u53d8\u66f4: \u5b57\u6bb5\u7c7b\u578b\u66f4\u6539\uff0c\u5206\u8bcd\u5668\u53ca\u5b57\u5178\u66f4\u65b0</li> <li>\u7d22\u5f15\u7684 Settings \u53d1\u751f\u53d8\u66f4:\u7d22\u5f15\u7684\u4e3b\u5206\u2f5a\u6570\u53d1\u2f63\u6539\u53d8</li> <li>\u96c6\u7fa4\u5185\uff0c\u96c6\u7fa4\u95f4\u9700\u8981\u505a\u6570\u636e\u8fc1\u79fb</li> </ul> </li> <li>Elasticsearch \u7684\u5185\u7f6e\u63d0\u4f9b\u7684 API<ul> <li>Update By Query:\u5728\u73b0\u6709\u7d22\u5f15\u4e0a\u91cd\u5efa </li> <li>Reindex:\u5728\u5176\u4ed6\u7d22\u5f15\u4e0a\u91cd\u5efa\u7d22\u5f15</li> </ul> </li> </ul>"},{"location":"chap7/3chap7_updateindex_reindex/#2-1","title":"2\u3001\u6848\u4f8b 1:\u4e3a\u7d22\u5f15\u589e\u52a0\u5b50\u5b57\u6bb5","text":"<ul> <li>\u53d8 Mapping\uff0c\u589e\u52a0\u2f26\u5b57\u6bb5\uff0c\u4f7f\u2f64\u82f1\u2f42\u5206\u8bcd\u5668\u5668 </li> <li>\u6b64\u65f6\u5c1d\u8bd5\u5bf9\u2f26\u5b57\u6bb5\u8fdb\u884c\u8be2</li> <li>\u867d\u7136\u6709\u6570\u636e\u5df2\u7ecf\u5b58\u5728\uff0c\u4f46\u662f\u6ca1\u6709\u8fd4\u56de\u7ed3\u679c</li> </ul> <pre><code>DELETE blogs/\n\n# \u5199\u5165\u6587\u6863\nPUT blogs/_doc/1\n{\n  \"content\":\"Hadoop is cool\",\n  \"keyword\":\"hadoop\"\n}\n\n# \u67e5\u770b Mapping\nGET blogs/_mapping\n</code></pre> <p>Output:</p> <pre><code>{\n  \"blogs\" : {\n    \"mappings\" : {\n      \"properties\" : {\n        \"content\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n            }\n          }\n        },\n        \"keyword\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n            }\n          }\n        }\n      }\n    }\n  }\n}\n\n</code></pre> <pre><code># \u4fee\u6539 Mapping\uff0c\u589e\u52a0\u5b50\u5b57\u6bb5\uff0c\u4f7f\u7528\u82f1\u6587\u5206\u8bcd\u5668\nPUT blogs/_mapping\n{\n      \"properties\" : {\n        \"content\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"english\" : {\n              \"type\" : \"text\",\n              \"analyzer\":\"english\"\n            }\n          }\n        }\n      }\n    }\n</code></pre> <pre><code># \u5199\u5165\u6587\u6863\nPUT blogs/_doc/2\n{\n  \"content\":\"Elasticsearch rocks\",\n    \"keyword\":\"elasticsearch\"\n}\n</code></pre> <pre><code># \u67e5\u8be2\u65b0\u5199\u5165\u6587\u6863\nPOST blogs/_search\n{\n  \"query\": {\n    \"match\": {\n      \"content.english\": \"Elasticsearch\"\n    }\n  }\n}\n</code></pre> <p>Output: correct</p> <pre><code> \"max_score\" : 0.2876821,\n    \"hits\" : [\n      {\n        \"_index\" : \"blogs\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"2\",\n        \"_score\" : 0.2876821,\n        \"_source\" : {\n          \"content\" : \"Elasticsearch rocks\",\n          \"keyword\" : \"elasticsearch\"\n        }\n      }\n    ]\n</code></pre> <pre><code>POST blogs/_search\n{\n  \"query\": {\n    \"match\": {\n      \"content.english\": \"Hadoop\"\n    }\n  }\n}\n</code></pre> <p>Output: null</p> <pre><code>\"hits\" : {\n    \"total\" : {\n      \"value\" : 0,\n      \"relation\" : \"eq\"\n    },\n    \"max_score\" : null,\n    \"hits\" : [ ]\n  }\n</code></pre>"},{"location":"chap7/3chap7_updateindex_reindex/#3update-by-query","title":"3\u3001Update By Query","text":"<ul> <li>\u6267\u2f8f Update By Query</li> <li>\u5c1d\u8bd5\u5bf9 Multi-Fields \u67e5\u8be2 </li> <li>\u8fd4\u56de\u7ed3\u679c</li> </ul>"},{"location":"chap7/3chap7_updateindex_reindex/#3-1-update-by-query","title":"3-1 \u6267\u2f8f Update By Query","text":"<pre><code># Update\u6240\u6709\u6587\u6863\nPOST blogs/_update_by_query\n{\n\n}\n</code></pre> <p>Output</p> <pre><code>{\n  \"took\" : 4376,\n  \"timed_out\" : false,\n  \"total\" : 2,\n  \"updated\" : 2,\n  \"deleted\" : 0,\n  \"batches\" : 1,\n  \"version_conflicts\" : 0,\n  \"noops\" : 0,\n  \"retries\" : {\n    \"bulk\" : 0,\n    \"search\" : 0\n  },\n  \"throttled_millis\" : 0,\n  \"requests_per_second\" : -1.0,\n  \"throttled_until_millis\" : 0,\n  \"failures\" : [ ]\n}\n</code></pre>"},{"location":"chap7/3chap7_updateindex_reindex/#3-2","title":"3-2 \u67e5\u8be2\u4e4b\u524d\u5199\u5165\u7684\u6587\u6863","text":"<pre><code>POST blogs/_search\n{\n  \"query\": {\n    \"match\": {\n      \"content.english\": \"Hadoop\"\n    }\n  }\n}\n</code></pre> <p>Output: <code>\"hits\" :1</code></p> <pre><code>\"hits\" : {\n    \"total\" : {\n      \"value\" : 1,\n      \"relation\" : \"eq\"\n    },\n    \"max_score\" : 0.6931471,\n    \"hits\" : [\n      {\n        \"_index\" : \"blogs\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"1\",\n        \"_score\" : 0.6931471,\n        \"_source\" : {\n          \"content\" : \"Hadoop is cool\",\n          \"keyword\" : \"hadoop\"\n        }\n      }\n    ]\n  }\n</code></pre>"},{"location":"chap7/3chap7_updateindex_reindex/#4-2-mappings","title":"4\u3001\u6848\u4f8b 2:\u66f4\u6539\u5df2\u6709\u5b57\u6bb5\u7c7b\u578b\u7684 Mappings","text":"<ul> <li>ES \u4e0d\u5141\u8bb8\u5728\u539f\u6709 Mapping \u4e0a\u5bf9\u5b57\u6bb5\u7c7b\u578b\u8fdb\u2f8f\u4fee\u6539 </li> <li>\u53ea\u80fd\u521b\u5efa\u65b0\u7684\u7d22\u5f15\uff0c\u5e76\u4e14\u8bbe\u5b9a\u6b63\u786e\u7684\u5b57\u6bb5\u7c7b\u578b\uff0c\u518d\u91cd\u65b0\u5bfc\u2f0a\u6570\u636e</li> </ul> <pre><code>GET blogs/_mapping\n</code></pre> <p>Output:</p> <pre><code>{\n  \"blogs\" : {\n    \"mappings\" : {\n      \"properties\" : {\n        \"content\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"english\" : {\n              \"type\" : \"text\",\n              \"analyzer\" : \"english\"\n            },\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n            }\n          }\n        },\n        \"keyword\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n            }\n          }\n        }\n      }\n    }\n  }\n}\n</code></pre> <pre><code>PUT blogs/_mapping\n{\n        \"properties\" : {\n        \"content\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"english\" : {\n              \"type\" : \"text\",\n              \"analyzer\" : \"english\"\n            }\n          }\n        },\n        \"keyword\" : {\n          \"type\" : \"keyword\"\n        }\n      }\n}\n</code></pre> <p><code>\"type\" : \"keyword\"</code> =&gt; <code>\"type\" : \"text\"</code></p> <p>Output:</p> <pre><code>{\n  \"error\" : {\n    \"root_cause\" : [\n      {\n        \"type\" : \"illegal_argument_exception\",\n        \"reason\" : \"mapper [keyword] cannot be changed from type [text] to [keyword]\"\n      }\n    ],\n    \"type\" : \"illegal_argument_exception\",\n    \"reason\" : \"mapper [keyword] cannot be changed from type [text] to [keyword]\"\n  },\n  \"status\" : 400\n}\n</code></pre> <p>\"mapper [keyword] cannot be changed from type [text] to [keyword]\"</p>"},{"location":"chap7/3chap7_updateindex_reindex/#5reindex-api","title":"5\u3001Reindex API","text":"<ul> <li>Reindex API \u2f40\u6301\u628a\u2f42\u6863\u4ece\u2f00\u4e2a\u7d22\u5f15\u62f7\u2ec9\u5230\u53e6\u5916\u2f00\u4e2a\u7d22\u5f15</li> <li>\u4f7f\u2f64 Reindex API \u7684\u2f00\u4e9b\u573a\u666f <ul> <li>\u4fee\u6539\u7d22\u5f15\u7684\u4e3b\u5206\u2f5a\u6570</li> <li>\u6539\u53d8\u5b57\u6bb5\u7684 Mapping \u4e2d\u7684\u5b57\u6bb5\u7c7b\u578b</li> <li>\u96c6\u7fa4\u5185\u6570\u636e\u8fc1\u79fb / \u8de8\u96c6\u7fa4\u7684\u6570\u636e\u8fc1\u79fb</li> </ul> </li> </ul> <pre><code>DELETE blogs_fix\n# 404 - Not Found\n</code></pre>"},{"location":"chap7/3chap7_updateindex_reindex/#5-1-mapping","title":"5-1 \u521b\u5efa\u65b0\u7684\u7d22\u5f15\u5e76\u4e14\u8bbe\u5b9a\u65b0\u7684Mapping","text":"<pre><code># \u521b\u5efa\u65b0\u7684\u7d22\u5f15\u5e76\u4e14\u8bbe\u5b9a\u65b0\u7684Mapping\nPUT blogs_fix/\n{\n  \"mappings\": {\n        \"properties\" : {\n        \"content\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"english\" : {\n              \"type\" : \"text\",\n              \"analyzer\" : \"english\"\n            }\n          }\n        },\n        \"keyword\" : {\n          \"type\" : \"keyword\"\n        }\n      }    \n  }\n}\n</code></pre> <p>Output</p> <pre><code>{\n  \"acknowledged\" : true,\n  \"shards_acknowledged\" : true,\n  \"index\" : \"blogs_fix\"\n}\n</code></pre> <pre><code># Reindx API\nPOST  _reindex\n{\n  \"source\": {\n    \"index\": \"blogs\"\n  },\n  \"dest\": {\n    \"index\": \"blogs_fix\"\n  }\n}\n</code></pre> <pre><code>GET  blogs_fix/_doc/1\n</code></pre> <p>Output:</p> <pre><code>{\n  \"_index\" : \"blogs_fix\",\n  \"_type\" : \"_doc\",\n  \"_id\" : \"1\",\n  \"_version\" : 1,\n  \"_seq_no\" : 0,\n  \"_primary_term\" : 1,\n  \"found\" : true,\n  \"_source\" : {\n    \"content\" : \"Hadoop is cool\",\n    \"keyword\" : \"hadoop\"\n  }\n}\n</code></pre>"},{"location":"chap7/3chap7_updateindex_reindex/#5-2-term-aggregation","title":"5-2 \u6d4b\u8bd5 Term Aggregation","text":"<pre><code># \u6d4b\u8bd5 Term Aggregation\nPOST blogs_fix/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"blog_keyword\": {\n      \"terms\": {\n        \"field\": \"keyword\",\n        \"size\": 10\n      }\n    }\n  }\n}\n</code></pre> <p>Output</p> <pre><code> \"hits\" : {\n    \"total\" : {\n      \"value\" : 2,\n      \"relation\" : \"eq\"\n    },\n    \"max_score\" : null,\n    \"hits\" : [ ]\n  },\n  \"aggregations\" : {\n    \"blog_keyword\" : {\n      \"doc_count_error_upper_bound\" : 0,\n      \"sum_other_doc_count\" : 0,\n      \"buckets\" : [\n        {\n          \"key\" : \"elasticsearch\",\n          \"doc_count\" : 1\n        },\n        {\n          \"key\" : \"hadoop\",\n          \"doc_count\" : 1\n        }\n      ]\n    }\n  }\n</code></pre>"},{"location":"chap7/3chap7_updateindex_reindex/#6","title":"6\u3001\u4e24\u4e2a\u6ce8\u610f\u70b9","text":""},{"location":"chap7/3chap7_updateindex_reindex/#7op-type","title":"7\u3001OP Type","text":"<ul> <li><code>_reindex</code> \u53ea\u4f1a\u521b\u5efa\u4e0d\u5b58\u5728\u7684\u2f42\u6863</li> <li>\u2f42\u6863\u5982\u679c\u5df2\u7ecf\u5b58\u5728\uff0c\u4f1a\u5bfc\u81f4\u7248\u672c\u51b2\u7a81</li> </ul> <pre><code># Reindx API\uff0cversion Type Internal\nPOST  _reindex\n{\n  \"source\": {\n    \"index\": \"blogs\"\n  },\n  \"dest\": {\n    \"index\": \"blogs_fix\",\n    \"op_type\": \"create\"\n  }\n}\n</code></pre> <p>Output: 409 - Conflict</p> <pre><code>\"failures\" : [\n    {\n      \"index\" : \"blogs_fix\",\n      \"type\" : \"_doc\",\n      \"id\" : \"1\",\n      \"cause\" : {\n        \"type\" : \"version_conflict_engine_exception\",\n        \"reason\" : \"[1]: version conflict, document already exists (current version [2])\",\n        \"index_uuid\" : \"jPf0gwF2T3qpBz64AHkRbg\",\n        \"shard\" : \"0\",\n        \"index\" : \"blogs_fix\"\n      },\n      \"status\" : 409\n    },\n    {\n      \"index\" : \"blogs_fix\",\n      \"type\" : \"_doc\",\n      \"id\" : \"2\",\n      \"cause\" : {\n        \"type\" : \"version_conflict_engine_exception\",\n        \"reason\" : \"[2]: version conflict, document already exists (current version [2])\",\n        \"index_uuid\" : \"jPf0gwF2T3qpBz64AHkRbg\",\n        \"shard\" : \"0\",\n        \"index\" : \"blogs_fix\"\n      },\n      \"status\" : 409\n    }\n  ]\n</code></pre>"},{"location":"chap7/3chap7_updateindex_reindex/#8-reindex","title":"8\u3001\u8de8\u96c6\u7fa4 ReIndex","text":"<p><code>reindex.remote.whitelist: \"otherhost:9200, another:9200\u201d</code></p> <ul> <li>\u9700\u8981\u4fee\u6539 <code>elasticsearch.yml</code>\uff0c\u5e76\u4e14\u91cd\u542f\u8282\u70b9</li> </ul> <p></p>"},{"location":"chap7/3chap7_updateindex_reindex/#9-task-api","title":"9\u3001\u67e5\u770b Task API","text":"<p><code>GET _tasks?detailed=true&amp;actions=*reindex</code></p> <ul> <li><code>Reindx API</code> \u2f40\u6301\u5f02\u6b65\u64cd\u4f5c\uff0c\u6267\u2f8f\u53ea\u8fd4\u56de<code>Task Id</code></li> <li><code>POST _reindex?wait_for_completion=false</code></li> </ul> <p></p> <pre><code># Reindx API\uff0cversion Type Internal\nPOST  _reindex\n{\n  \"source\": {\n    \"index\": \"blogs\"\n  },\n  \"dest\": {\n    \"index\": \"blogs_fix\",\n    \"version_type\": \"internal\"\n  }\n}\n</code></pre> <p>Output:</p> <pre><code>{\n  \"_index\" : \"blogs_fix\",\n  \"_type\" : \"_doc\",\n  \"_id\" : \"1\",\n  \"_version\" : 2,\n  \"_seq_no\" : 2,\n  \"_primary_term\" : 1,\n  \"found\" : true,\n  \"_source\" : {\n    \"content\" : \"Hadoop is cool\",\n    \"keyword\" : \"hadoop\"\n  }\n}\n</code></pre> <pre><code># Reindx API\uff0cversion Type external\nPOST  _reindex\n{\n  \"source\": {\n    \"index\": \"blogs\"\n  },\n  \"dest\": {\n    \"index\": \"blogs_fix\",\n    \"version_type\": \"external\"\n  }\n}\n</code></pre> <p>Output :409 - Conflict</p> <pre><code>\"failures\" : [\n    {\n      \"index\" : \"blogs_fix\",\n      \"type\" : \"_doc\",\n      \"id\" : \"1\",\n      \"cause\" : {\n        \"type\" : \"version_conflict_engine_exception\",\n        \"reason\" : \"[1]: version conflict, current version [2] is higher or equal to the one provided [2]\",\n        \"index_uuid\" : \"jPf0gwF2T3qpBz64AHkRbg\",\n        \"shard\" : \"0\",\n        \"index\" : \"blogs_fix\"\n      },\n      \"status\" : 409\n    },\n    {\n      \"index\" : \"blogs_fix\",\n      \"type\" : \"_doc\",\n      \"id\" : \"2\",\n      \"cause\" : {\n        \"type\" : \"version_conflict_engine_exception\",\n        \"reason\" : \"[2]: version conflict, current version [2] is higher or equal to the one provided [2]\",\n        \"index_uuid\" : \"jPf0gwF2T3qpBz64AHkRbg\",\n        \"shard\" : \"0\",\n        \"index\" : \"blogs_fix\"\n      },\n      \"status\" : 409\n</code></pre> <pre><code># Reindx API\uff0cversion Type external\nPOST  _reindex\n{\n  \"source\": {\n    \"index\": \"blogs\"\n  },\n  \"dest\": {\n    \"index\": \"blogs_fix\",\n    \"version_type\": \"external\"\n  },\n  \"conflicts\": \"proceed\"\n}\n</code></pre> <p><code>\"conflicts\": \"proceed\"</code></p> <p>Output: 200 - Conflict</p>"},{"location":"chap7/3chap7_updateindex_reindex/#10","title":"10\u3001\u672c\u8282\u56de\u987e","text":"<ul> <li>Update By Query \u7684\u4f7f\u2f64\u573a\u666f:\u4e3a\u5b57\u6bb5\u65b0\u589e\u2f26\u5b57\u6bb5;\u5b57\u6bb5\u66f4\u6362\u5206\u8bcd\u5668\uff0c\u6216\u66f4\u65b0\u5206\u8bcd\u5668\u8bcd\u5e93</li> <li>Reindex API \u7684\u4f7f\u2f64\u573a\u666f:    \u4fee\u6539\u5b57\u6bb5\u7c7b\u578b<ul> <li>\u9700\u8981\u5148\u5bf9\u65b0\u7d22\u5f15\u8bbe\u7f6e Mapping\uff0c\u7d22\u5f15\u7684\u8bbe\u7f6e\u548c\u6620\u5c04\u5173\u7cfb\u4e0d\u4f1a\u88ab\u590d\u5236</li> </ul> </li> <li>\u901a\u8fc7\u67e5\u770b Task API\uff0c\u4e86\u89e3 Reindex \u7684\u72b6\u51b5</li> <li>Remote ReIndex\uff0c\u9700\u8981\u4fee\u6539 elasticsearch.yml \u914d\u7f6e\u5e76\u4e14\u91cd\u542f</li> <li>\u4e00\u5b9a\u8981\u5c3d\u91cf\u4f7f\u2f64 Index Alias \u8bfb\u5199\u6570\u636e\u3002\u5373\u4fbf\u53d1\u2f63 Reindex\uff0c\u4e5f\u80fd\u591f\u5b9e\u73b0\u96f6\u505c\u673a\u7ef4\u62a4</li> </ul>"},{"location":"chap7/4chap7_ingest_painless/","title":"\u7b2c\u56db\u8282 Ingest Pipeline \u4e0e Painless Script","text":""},{"location":"chap7/4chap7_ingest_painless/#1","title":"1\u3001\u9700\u6c42:\u4fee\u590d\u4e0e\u589e\u5f3a\u5199\u2f0a\u7684\u6570\u636e","text":"<ul> <li>Tags \u5b57\u6bb5\u4e2d\uff0c\u9017\u53f7\u5206\u9694\u7684\u2f42\u672c\u5e94\u8be5\u662f\u6570\u7ec4\uff0c\u2f7d\u4e0d\u662f\u2f00\u4e2a\u5b57\u7b26\u4e32<ul> <li>\u9700\u6c42:\u540e\u671f\u9700\u8981\u5bf9 Tags \u8fdb\u2f8f Aggregation \u7edf\u8ba1</li> </ul> </li> </ul>"},{"location":"chap7/4chap7_ingest_painless/#2ingest-node","title":"2\u3001Ingest Node","text":"<ul> <li> <p>Elasticsearch 5.0 \u540e\uff0c\u5f15\u2f0a\u7684\u2f00\u79cd\u65b0\u7684\u8282\u70b9\u7c7b\u578b\u3002\u9ed8\u8ba4\u914d\u7f6e\u4e0b\uff0c\u6bcf\u4e2a\u8282\u70b9\u90fd\u662f Ingest Node</p> <ul> <li>\u5177\u6709\u9884\u5904\u7406\u6570\u636e\u7684\u80fd\u2f12\uff0c\u53ef\u62e6\u622a Index \u6216 Bulk API \u7684\u8bf7\u6c42</li> <li>\u5bf9\u6570\u636e\u8fdb\u2f8f\u8f6c\u6362\uff0c\u5e76\u91cd\u65b0\u8fd4\u56de\u7ed9 Index \u6216 Bulk API</li> </ul> </li> <li> <p>\u2f46\u9700 Logstash\uff0c\u5c31\u53ef\u4ee5\u8fdb\u2f8f\u6570\u636e\u7684\u9884\u5904\u7406\uff0c\u4f8b\u5982</p> <ul> <li>\u4e3a\u67d0\u4e2a\u5b57\u6bb5\u8bbe\u7f6e\u9ed8\u8ba4\u503c; </li> <li>\u91cd\u547d\u540d\u67d0\u4e2a\u5b57\u6bb5\u7684\u5b57\u6bb5\u540d;</li> <li>\u5bf9\u5b57\u6bb5\u503c\u8fdb\u2f8f Split \u64cd\u4f5c</li> <li>\u2f40\u6301\u8bbe\u7f6e Painless \u811a\u672c\uff0c\u5bf9\u6570\u636e\u8fdb\u2f8f\u66f4\u52a0\u590d\u6742\u7684\u52a0\u2f2f</li> </ul> </li> </ul>"},{"location":"chap7/4chap7_ingest_painless/#3pipeline-processor","title":"3\u3001Pipeline &amp; Processor","text":"<ul> <li>Pipeline - \u7ba1\u9053\u4f1a\u5bf9\u901a\u8fc7\u7684\u6570\u636e(\u2f42\u6863)\uff0c\u6309\u7167\u987a\u5e8f\u8fdb\u2f8f\u52a0\u2f2f</li> <li>Processor - Elasticsearch \u5bf9\u2f00\u4e9b\u52a0\u2f2f\u7684\u2f8f\u4e3a\u8fdb\u2f8f\u4e86\u62bd\u8c61\u5305\u88c5<ul> <li>Elasticsearch \u6709\u5f88\u591a\u5185\u7f6e\u7684 Processors\u3002\u4e5f\u2f40\u6301\u901a\u8fc7\u63d2\u4ef6\u7684\u2f45\u5f0f\uff0c\u5b9e\u73b0\u2f83\u5df1\u7684 Processor</li> </ul> </li> </ul>"},{"location":"chap7/4chap7_ingest_painless/#3-1-pipeline","title":"3-1 \u4f7f\u2f64 Pipeline \u5207\u5206\u5b57\u7b26\u4e32","text":"<pre><code>{\n  \"split\": {\n     \"field\": \"tags\",\n     \"separator\": \",\"\n    }\n}\n</code></pre> <pre><code>DELETE tech_blogs\n\n#Blog\u6570\u636e\uff0c\u5305\u542b3\u4e2a\u5b57\u6bb5\uff0ctags\u7528\u9017\u53f7\u95f4\u9694\nPUT tech_blogs/_doc/1\n{\n  \"title\":\"Introducing big data......\",\n  \"tags\":\"hadoop,elasticsearch,spark\",\n  \"content\":\"You konw, for big data\"\n}\n</code></pre> <pre><code># \u6d4b\u8bd5split tags\nPOST _ingest/pipeline/_simulate\n{\n  \"pipeline\": {\n    \"description\": \"to split blog tags\",\n    \"processors\": [\n      {\n        \"split\": {\n          \"field\": \"tags\",\n          \"separator\": \",\"\n        }\n      }\n    ]\n  },\n  \"docs\": [\n    {\n      \"_index\": \"index\",\n      \"_id\": \"id\",\n      \"_source\": {\n        \"title\": \"Introducing big data......\",\n        \"tags\": \"hadoop,elasticsearch,spark\",\n        \"content\": \"You konw, for big data\"\n      }\n    },\n    {\n      \"_index\": \"index\",\n      \"_id\": \"idxx\",\n      \"_source\": {\n        \"title\": \"Introducing cloud computering\",\n        \"tags\": \"openstack,k8s\",\n        \"content\": \"You konw, for cloud\"\n      }\n    }\n  ]\n}\n</code></pre> <p>Output:</p> <pre><code>{\n  \"docs\" : [\n    {\n      \"doc\" : {\n        \"_index\" : \"index\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"id\",\n        \"_source\" : {\n          \"title\" : \"Introducing big data......\",\n          \"content\" : \"You konw, for big data\",\n          \"tags\" : [\n            \"hadoop\",\n            \"elasticsearch\",\n            \"spark\"\n          ]\n        },\n        \"_ingest\" : {\n          \"timestamp\" : \"2020-11-02T11:54:24.335498Z\"\n        }\n      }\n    },\n    {\n      \"doc\" : {\n        \"_index\" : \"index\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"idxx\",\n        \"_source\" : {\n          \"title\" : \"Introducing cloud computering\",\n          \"content\" : \"You konw, for cloud\",\n          \"tags\" : [\n            \"openstack\",\n            \"k8s\"\n          ]\n        },\n        \"_ingest\" : {\n          \"timestamp\" : \"2020-11-02T11:54:24.335525Z\"\n        }\n      }\n    }\n  ]\n}\n</code></pre>"},{"location":"chap7/4chap7_ingest_painless/#3-2","title":"3-2 \u4e3a\u2f42\u6863\u589e\u52a0\u5b57\u6bb5","text":"<pre><code>{\n   \"set\":{\n     \"field\": \"views\",\n     \"value\": 0\n    }\n}\n</code></pre> <pre><code>#\u540c\u65f6\u4e3a\u6587\u6863\uff0c\u589e\u52a0\u4e00\u4e2a\u5b57\u6bb5\u3002blog\u67e5\u770b\u91cf\nPOST _ingest/pipeline/_simulate\n{\n  \"pipeline\": {\n    \"description\": \"to split blog tags\",\n    \"processors\": [\n      {\n        \"split\": {\n          \"field\": \"tags\",\n          \"separator\": \",\"\n        }\n      },\n\n      {\n        \"set\":{\n          \"field\": \"views\",\n          \"value\": 0\n        }\n      }\n    ]\n  },\n\n  \"docs\": [\n    {\n      \"_index\":\"index\",\n      \"_id\":\"id\",\n      \"_source\":{\n        \"title\":\"Introducing big data......\",\n  \"tags\":\"hadoop,elasticsearch,spark\",\n  \"content\":\"You konw, for big data\"\n      }\n    },\n\n\n    {\n      \"_index\":\"index\",\n      \"_id\":\"idxx\",\n      \"_source\":{\n        \"title\":\"Introducing cloud computering\",\n  \"tags\":\"openstack,k8s\",\n  \"content\":\"You konw, for cloud\"\n      }\n    }\n\n    ]\n}\n</code></pre> <p>Output</p> <pre><code>{\n  \"docs\" : [\n    {\n      \"doc\" : {\n        \"_index\" : \"index\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"id\",\n        \"_source\" : {\n          \"title\" : \"Introducing big data......\",\n          \"content\" : \"You konw, for big data\",\n          \"views\" : 0,\n          \"tags\" : [\n            \"hadoop\",\n            \"elasticsearch\",\n            \"spark\"\n          ]\n        },\n        \"_ingest\" : {\n          \"timestamp\" : \"2020-11-02T12:02:21.430235Z\"\n        }\n      }\n    },\n    {\n      \"doc\" : {\n        \"_index\" : \"index\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"idxx\",\n        \"_source\" : {\n          \"title\" : \"Introducing cloud computering\",\n          \"content\" : \"You konw, for cloud\",\n          \"views\" : 0,\n          \"tags\" : [\n            \"openstack\",\n            \"k8s\"\n          ]\n        },\n        \"_ingest\" : {\n          \"timestamp\" : \"2020-11-02T12:02:21.430244Z\"\n        }\n      }\n    }\n  ]\n}\n</code></pre>"},{"location":"chap7/4chap7_ingest_painless/#3-3-pipeline-api","title":"3-3 Pipeline API","text":""},{"location":"chap7/4chap7_ingest_painless/#3-4-pipeline","title":"3-4 \u6dfb\u52a0 Pipeline \u5e76\u6d4b\u8bd5","text":"<pre><code># \u4e3aES\u6dfb\u52a0\u4e00\u4e2a Pipeline\nPUT _ingest/pipeline/blog_pipeline\n{\n  \"description\": \"a blog pipeline\",\n  \"processors\": [\n      {\n        \"split\": {\n          \"field\": \"tags\",\n          \"separator\": \",\"\n        }\n      },\n\n      {\n        \"set\":{\n          \"field\": \"views\",\n          \"value\": 0\n        }\n      }\n    ]\n}\n</code></pre> <pre><code>#\u67e5\u770bPipleline\nGET _ingest/pipeline/blog_pipeline\n</code></pre> <p>Output</p> <pre><code>{\n  \"blog_pipeline\" : {\n    \"description\" : \"a blog pipeline\",\n    \"processors\" : [\n      {\n        \"split\" : {\n          \"field\" : \"tags\",\n          \"separator\" : \",\"\n        }\n      },\n      {\n        \"set\" : {\n          \"field\" : \"views\",\n          \"value\" : 0\n        }\n      }\n    ]\n  }\n}\n</code></pre> <p>\u6d4b\u8bd5pipeline</p> <pre><code>#\u6d4b\u8bd5pipeline\nPOST _ingest/pipeline/blog_pipeline/_simulate\n{\n  \"docs\": [\n    {\n      \"_source\": {\n        \"title\": \"Introducing cloud computering\",\n        \"tags\": \"openstack,k8s\",\n        \"content\": \"You konw, for cloud\"\n      }\n    }\n  ]\n}\n</code></pre> <p>Output:</p> <pre><code>{\n  \"docs\" : [\n    {\n      \"doc\" : {\n        \"_index\" : \"_index\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"_id\",\n        \"_source\" : {\n          \"title\" : \"Introducing cloud computering\",\n          \"content\" : \"You konw, for cloud\",\n          \"views\" : 0,\n          \"tags\" : [\n            \"openstack\",\n            \"k8s\"\n          ]\n        },\n        \"_ingest\" : {\n          \"timestamp\" : \"2020-11-02T12:06:53.905829Z\"\n        }\n      }\n    }\n  ]\n}\n</code></pre>"},{"location":"chap7/4chap7_ingest_painless/#3-5-index-update-by-query","title":"3-5 Index &amp; Update By Query","text":"<pre><code>#\u4e0d\u4f7f\u7528pipeline\u66f4\u65b0\u6570\u636e\nPUT tech_blogs/_doc/1\n{\n  \"title\":\"Introducing big data......\",\n  \"tags\":\"hadoop,elasticsearch,spark\",\n  \"content\":\"You konw, for big data\"\n}\n\n#\u4f7f\u7528pipeline\u66f4\u65b0\u6570\u636e\nPUT tech_blogs/_doc/2?pipeline=blog_pipeline\n{\n  \"title\": \"Introducing cloud computering\",\n  \"tags\": \"openstack,k8s\",\n  \"content\": \"You konw, for cloud\"\n}\n</code></pre> <pre><code>#\u67e5\u770b\u4e24\u6761\u6570\u636e\uff0c\u4e00\u6761\u88ab\u5904\u7406\uff0c\u4e00\u6761\u672a\u88ab\u5904\u7406\nPOST tech_blogs/_search\n{}\n</code></pre> <p>Ouput:</p> <pre><code>\"hits\" : [\n      {\n        \"_index\" : \"tech_blogs\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"1\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"title\" : \"Introducing big data......\",\n          \"tags\" : \"hadoop,elasticsearch,spark\",\n          \"content\" : \"You konw, for big data\"\n        }\n      },\n      {\n        \"_index\" : \"tech_blogs\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"2\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"title\" : \"Introducing cloud computering\",\n          \"content\" : \"You konw, for cloud\",\n          \"views\" : 0,\n          \"tags\" : [\n            \"openstack\",\n            \"k8s\"\n          ]\n        }\n      }\n    ]\n</code></pre> <p><code>update_by_query</code> \u4f1a\u5bfc\u81f4\u9519\u8bef</p> <pre><code>#update_by_query \u4f1a\u5bfc\u81f4\u9519\u8bef\nPOST tech_blogs/_update_by_query?pipeline=blog_pipeline\n{\n}\n</code></pre> <p>Output: 400 - Bad Request</p> <pre><code>\"failures\" : [\n    {\n      \"index\" : \"tech_blogs\",\n      \"type\" : \"_doc\",\n      \"id\" : \"2\",\n      \"cause\" : {\n        \"type\" : \"illegal_argument_exception\",\n        \"reason\" : \"field [tags] of type [java.util.ArrayList] cannot be cast to [java.lang.String]\"\n      },\n      \"status\" : 400\n    }\n  ]\n</code></pre> <p><code>\"reason\" : \"field [tags] of type [java.util.ArrayList] cannot be cast to [java.lang.String]\"</code></p> <p>\u589e\u52a0<code>update_by_query</code>\u7684\u6761\u4ef6</p> <pre><code>#\u589e\u52a0update_by_query\u7684\u6761\u4ef6\nPOST tech_blogs/_update_by_query?pipeline=blog_pipeline\n{\n    \"query\": {\n        \"bool\": {\n            \"must_not\": {\n                \"exists\": {\n                    \"field\": \"views\"\n                }\n            }\n        }\n    }\n}\n</code></pre> <p>Output: 200-ok</p> <pre><code>{\n  \"took\" : 726,\n  \"timed_out\" : false,\n  \"total\" : 0,\n  \"updated\" : 0,\n  \"deleted\" : 0,\n  \"batches\" : 0,\n  \"version_conflicts\" : 0,\n  \"noops\" : 0,\n  \"retries\" : {\n    \"bulk\" : 0,\n    \"search\" : 0\n  },\n  \"throttled_millis\" : 0,\n  \"requests_per_second\" : -1.0,\n  \"throttled_until_millis\" : 0,\n  \"failures\" : [ ]\n}\n</code></pre>"},{"location":"chap7/4chap7_ingest_painless/#4-processors","title":"4\u3001\u4e00\u4e9b\u5185\u7f6e Processors","text":"<ul> <li>https://www.elastic.co/guide/en/elasticsearch/reference/7.1/ingest-processors.html<ul> <li>Split Processor (\u4f8b:\u5c06\u7ed9\u5b9a\u5b57\u6bb5\u503c\u5206\u6210\u4e00\u4e2a\u6570\u7ec4)</li> <li>Remove / Rename Processor (\u4f8b\u4f8b:\u79fb\u9664\u4e00\u4e2a\u91cd\u547d\u540d\u5b57\u6bb5)</li> <li>Append (\u4f8b:\u4e3a\u5546\u54c1\u589e\u52a0\u4e00\u4e2a\u65b0\u7684\u6807\u7b7e)</li> <li>Convert(\u4f8b:\u5c06\u5546\u54c1\u4ef7\u683c\uff0c\u4ece\u5b57\u7b26\u4e32\u8f6c\u6362\u6210 float \u7c7b\u578b)</li> <li>Date / JSON(\u4f8b:\u2f47\u671f\u683c\u5f0f\u8f6c\u6362\uff0c\u5b57\u7b26\u4e32\u8f6c JSON \u5bf9\u8c61)</li> <li>Date Index Name Processor (\u4f8b:\u5c06\u901a\u8fc7\u8be5\u5904\u7406\u5668\u7684\u2f42\u6863\uff0c\u5206\u914d\u5230\u6307\u5b9a\u65f6\u95f4\u683c\u5f0f\u7684\u7d22\u5f15\u4e2d)</li> <li>Fail Processor (\u2f00\u65e6\u51fa\u73b0\u5f02\u5e38\uff0c\u8be5 Pipeline \u6307\u5b9a\u7684\u9519\u8bef\u4fe1\u606f\u80fd\u8fd4\u56de\u7ed9\u7528\u6237</li> <li>Foreach Process(\u6570\u7ec4\u5b57\u6bb5\uff0c\u6570\u7ec4\u7684\u6bcf\u4e2a\u5143\u7d20\u90fd\u4f1a\u4f7f\u2f64\u5230\u2f00\u4e2a\u76f8\u540c\u7684\u5904\u7406\u5668)</li> <li>Grok Processor(\u2f47\u5fd7\u7684\u2f47\u671f\u683c\u5f0f\u5207\u5272)</li> <li>Gsub / Join / Split(\u5b57\u7b26\u4e32\u66ff\u6362 / \u6570\u7ec4\u8f6c\u5b57\u7b26\u4e32/ \u5b57\u7b26\u4e32\u8f6c\u6570\u7ec4)</li> <li>Lowercase / Upcase(\u2f24\u5c0f\u5199\u8f6c\u6362)</li> </ul> </li> </ul>"},{"location":"chap7/4chap7_ingest_painless/#5ingest-node-vs-logstash","title":"5\u3001Ingest Node v.s Logstash","text":"<p>https://www.elastic.co/cn/blog/should-i-use-logstash-or-elasticsearch-ingest-nodes</p> <p></p>"},{"location":"chap7/4chap7_ingest_painless/#6painless","title":"6\u3001Painless \u7b80\u4ecb","text":"<ul> <li>\u81ea Elasticsearch 5.x \u540e\u5f15\u5165\uff0c\u4e13\u2ed4\u4e3a Elasticsearch \u8bbe\u8ba1\uff0c\u6269\u5c55\u4e86 Java \u7684\u8bed\u6cd5\u3002</li> <li>6.0 \u5f00\u59cb\uff0cES \u53ea\u2f40\u6301 Painless\u3002Groovy\uff0c JavaScript \u548c Python \u90fd\u4e0d\u518d\u2f40\u652f\u6301</li> <li>Painless \u2f40\u6301\u6240\u6709 Java \u7684\u6570\u636e\u7c7b\u578b\u53ca Java API \u5b50\u96c6</li> <li>Painless Script \u5177\u5907\u4ee5\u4e0b\u7279\u6027<ul> <li>\u9ad8\u6027\u80fd/\u5b89\u5168</li> <li>\u652f\u6301\u663e\u793a\u7c7b\u578b\u6216\u8005\u52a8\u6001\u5b9a\u4e49\u7c7b\u578b</li> </ul> </li> </ul>"},{"location":"chap7/4chap7_ingest_painless/#7painless","title":"7\u3001Painless \u7684\u7528\u9014","text":"<ul> <li>\u53ef\u4ee5\u5bf9\u6587\u6863\u5b57\u6bb5\u8fdb\u884c\u52a0\u2f2f\u5904\u7406<ul> <li>\u66f4\u65b0\u6216\u5220\u9664\u5b57\u6bb5\uff0c\u5904\u7406\u6570\u636e\u805a\u5408\u64cd\u4f5c</li> <li>Script Field:\u5bf9\u8fd4\u56de\u7684\u5b57\u6bb5\u63d0\u524d\u8fdb\u2f8f\u8ba1\u7b97</li> <li>Function Score:\u5bf9\u6587\u6863\u7684\u7b97\u5206\u8fdb\u2f8f\u5904\u7406</li> </ul> </li> <li>\u5728 Ingest Pipeline \u4e2d\u6267\u2f8f\u811a\u672c</li> <li>\u5728 Reindex API\uff0cUpdate By Query \u65f6\uff0c\u5bf9\u6570\u636e\u8fdb\u2f8f\u5904\u7406</li> </ul>"},{"location":"chap7/4chap7_ingest_painless/#8-painless","title":"8\u3001\u901a\u8fc7 Painless \u811a\u672c\u8bbf\u95ee\u5b57\u6bb5","text":""},{"location":"chap7/4chap7_ingest_painless/#8-1-1script-processor","title":"8-1 \u6848\u4f8b 1:Script Processor","text":"<pre><code># \u589e\u52a0\u4e00\u4e2a Script Prcessor\nPOST _ingest/pipeline/_simulate\n{\n  \"pipeline\": {\n    \"description\": \"to split blog tags\",\n    \"processors\": [\n      {\n        \"split\": {\n          \"field\": \"tags\",\n          \"separator\": \",\"\n        }\n      },\n      {\n        \"script\": {\n          \"source\": \"\"\"\n          if(ctx.containsKey(\"content\")){\n            ctx.content_length = ctx.content.length();\n          }else{\n            ctx.content_length=0;\n          }\n\n\n          \"\"\"\n        }\n      },\n\n      {\n        \"set\":{\n          \"field\": \"views\",\n          \"value\": 0\n        }\n      }\n    ]\n  },\n\n  \"docs\": [\n    {\n      \"_index\":\"index\",\n      \"_id\":\"id\",\n      \"_source\":{\n        \"title\":\"Introducing big data......\",\n  \"tags\":\"hadoop,elasticsearch,spark\",\n  \"content\":\"You konw, for big data\"\n      }\n    },\n\n\n    {\n      \"_index\":\"index\",\n      \"_id\":\"idxx\",\n      \"_source\":{\n        \"title\":\"Introducing cloud computering\",\n  \"tags\":\"openstack,k8s\",\n  \"content\":\"You konw, for cloud\"\n      }\n    }\n\n    ]\n}\n</code></pre> <p>Output</p> <pre><code>{\n  \"docs\" : [\n    {\n      \"doc\" : {\n        \"_index\" : \"index\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"id\",\n        \"_source\" : {\n          \"title\" : \"Introducing big data......\",\n          \"content\" : \"You konw, for big data\",\n          \"content_length\" : 22,\n          \"views\" : 0,\n          \"tags\" : [\n            \"hadoop\",\n            \"elasticsearch\",\n            \"spark\"\n          ]\n        },\n        \"_ingest\" : {\n          \"timestamp\" : \"2020-11-02T12:40:15.6128Z\"\n        }\n      }\n    },\n    {\n      \"doc\" : {\n        \"_index\" : \"index\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"idxx\",\n        \"_source\" : {\n          \"title\" : \"Introducing cloud computering\",\n          \"content\" : \"You konw, for cloud\",\n          \"content_length\" : 19,\n          \"views\" : 0,\n          \"tags\" : [\n            \"openstack\",\n            \"k8s\"\n          ]\n        },\n        \"_ingest\" : {\n          \"timestamp\" : \"2020-11-02T12:40:15.612807Z\"\n        }\n      }\n    }\n  ]\n}\n</code></pre> <ul> <li><code>\"content_length\" : 22</code></li> <li><code>\"content_length\" : 19</code></li> </ul>"},{"location":"chap7/4chap7_ingest_painless/#8-2-2","title":"8-2 \u6848\u4f8b 2:\u2f42\u6863\u66f4\u65b0\u8ba1\u6570","text":"<pre><code>DELETE tech_blogs\nPUT tech_blogs/_doc/1\n{\n  \"title\":\"Introducing big data......\",\n  \"tags\":\"hadoop,elasticsearch,spark\",\n  \"content\":\"You konw, for big data\",\n  \"views\":0\n}\n</code></pre> <pre><code>POST tech_blogs/_update/1\n{\n  \"script\": {\n    \"source\": \"ctx._source.views += params.new_views\",\n    \"params\": {\n      \"new_views\":100\n    }\n  }\n}\n</code></pre> <p>Output\uff1a200</p> <pre><code># \u67e5\u770bviews\u8ba1\u6570\nPOST tech_blogs/_search\n{\n\n}\n</code></pre> <p>Output\uff1a</p> <pre><code>\"max_score\" : 1.0,\n    \"hits\" : [\n      {\n        \"_index\" : \"tech_blogs\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"1\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"title\" : \"Introducing big data......\",\n          \"tags\" : \"hadoop,elasticsearch,spark\",\n          \"content\" : \"You konw, for big data\",\n          \"views\" : 100\n        }\n      }\n    ]\n</code></pre> <pre><code>#\u4fdd\u5b58\u811a\u672c\u5728 Cluster State\nPOST _scripts/update_views\n{\n  \"script\":{\n    \"lang\": \"painless\",\n    \"source\": \"ctx._source.views += params.new_views\"\n  }\n}\n</code></pre> <p>200</p> <pre><code>POST tech_blogs/_update/1\n{\n  \"script\": {\n    \"id\": \"update_views\",\n    \"params\": {\n      \"new_views\":1000\n    }\n  }\n}\n</code></pre> <pre><code>POST tech_blogs/_search\n{\n\n}\n</code></pre> <p>Output:</p> <pre><code>\"max_score\" : 1.0,\n    \"hits\" : [\n      {\n        \"_index\" : \"tech_blogs\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"1\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"title\" : \"Introducing big data......\",\n          \"tags\" : \"hadoop,elasticsearch,spark\",\n          \"content\" : \"You konw, for big data\",\n          \"views\" : 1100\n        }\n      }\n    ]\n</code></pre> <p><code>\"views\" : 1100</code></p>"},{"location":"chap7/4chap7_ingest_painless/#8-3-3-script","title":"8-3 \u6848\u4f8b 3:\u641c\u7d22\u65f6\u7684 Script \u5b57\u6bb5","text":"<pre><code>GET tech_blogs/_search\n{\n  \"script_fields\": {\n    \"rnd_views\": {\n      \"script\": {\n        \"lang\": \"painless\",\n        \"source\": \"\"\"\n          java.util.Random rnd = new Random();\n          doc['views'].value+rnd.nextInt(1000);\n        \"\"\"\n      }\n    }\n  },\n  \"query\": {\n    \"match_all\": {}\n  }\n}\n</code></pre> <p>Output</p> <pre><code>\"max_score\" : 1.0,\n    \"hits\" : [\n      {\n        \"_index\" : \"tech_blogs\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"1\",\n        \"_score\" : 1.0,\n        \"fields\" : {\n          \"rnd_views\" : [\n            2692\n          ]\n        }\n      }\n    ]\n</code></pre>"},{"location":"chap7/4chap7_ingest_painless/#8-4-script-inline-vs-stored","title":"8-4 Script: Inline v.s Stored","text":""},{"location":"chap7/4chap7_ingest_painless/#9","title":"9\u3001\u811a\u672c\u7f13\u5b58","text":"<ul> <li>\u7f16\u8bd1\u7684\u5f00\u9500\u76f8\u8f83\u5927</li> <li>Elasticsearch \u4f1a\u5c06\u811a\u672c\u7f16\u8bd1\u540e\u7f13\u5b58\u5728Cache \u4e2d<ul> <li>Inline scripts \u548c Stored Scripts \u90fd\u4f1a\u88ab\u7f13\u5b58</li> <li>\u9ed8\u8ba4\u7f13\u5b58 100 \u4e2a\u811a\u672c</li> </ul> </li> </ul>"},{"location":"chap7/4chap7_ingest_painless/#10","title":"10\u3001\u672c\u8282\u77e5\u8bc6\u70b9","text":"<ul> <li>\u6982\u5ff5\u8bb2\u89e3:Ingest Node\uff0cPipeline \u4e0e Processor</li> <li>Ingest Node \u4e0e Logstash \u7684\u2f50\u8f83</li> <li>Pipeline \u7684 \u76f8\u5173\u64cd\u4f5c / \u5185\u7f6e Processor \u8bb2\u89e3\u4e0e\u6f14\u793a</li> <li>Painless \u811a\u672c\u4e0e<ul> <li>Ingestion (Pipeline)</li> <li>Update</li> <li>Search &amp; Aggregation</li> </ul> </li> </ul>"},{"location":"chap7/5chap7_es_model/","title":"\u7b2c\u4e94\u8282 Elasticsearch \u6570\u636e\u5efa\u6a21\u5b9e\u4f8b","text":""},{"location":"chap7/5chap7_es_model/#1","title":"1\u3001\u4ec0\u4e48\u662f\u6570\u636e\u5efa\u6a21?","text":"<ul> <li>\u6570\u636e\u5efa\u6a21(Data modeling)\uff0c \u662f\u521b\u5efa\u6570\u636e\u6a21\u578b\u7684\u8fc7\u7a0b<ul> <li>\u6570\u636e\u6a21\u578b\u662f\u5bf9\u771f\u5b9e\u4e16\u754c\u8fdb\u2f8f\u62bd\u8c61\u63cf\u8ff0\u7684\u2f00\u79cd\u2f2f\u5177\u548c\u65b9\u6cd5\uff0c\u5b9e\u73b0\u5bf9\u73b0\u5b9e\u4e16\u754c\u7684\u6620\u5c04<ul> <li>\u535a\u5ba2/\u4f5c\u8005/\u2f64\u7528\u6237\u8bc4\u8bba</li> </ul> </li> <li>\u4e09\u4e2a\u8fc7\u7a0b:\u6982\u5ff5\u6a21\u578b =&gt; \u903b\u8f91\u6a21\u578b =&gt; \u6570\u636e\u6a21\u578b(\u7b2c\u4e09\u8303\u5f0f)<ul> <li>\u6570\u636e\u6a21\u578b:\u7ed3\u5408\u5177\u4f53\u7684\u6570\u636e\u5e93\uff0c\u5728\u6ee1\u2f9c\u8db3\u4e1a\u52a1\u8bfb\u5199\u6027\u80fd\u7b49\u9700\u6c42\u7684\u524d\u63d0\u4e0b\uff0c\u786e\u5b9a\u6700\u7ec8\u7684\u5b9a\u4e49</li> </ul> </li> </ul> </li> </ul>"},{"location":"chap7/5chap7_es_model/#2","title":"2\u3001\u6570\u636e\u5efa\u6a21:\u529f\u80fd\u9700\u6c42 + \u6027\u80fd\u9700\u6c42","text":""},{"location":"chap7/5chap7_es_model/#3","title":"3\u3001\u5982\u4f55\u5bf9\u5b57\u6bb5\u8fdb\u2f8f\u5efa\u6a21","text":""},{"location":"chap7/5chap7_es_model/#4text-vs-keyword","title":"4\u3001\u5b57\u6bb5\u7c7b\u578b:Text v.s Keyword","text":""},{"location":"chap7/5chap7_es_model/#4-1-text","title":"4-1 Text","text":"<ul> <li>\u2f64\u4e8e\u5168\u6587\u672c\u5b57\u6bb5\uff0c\u2f42\u672c\u4f1a\u88ab Analyzer \u5206\u8bcd</li> <li>\u9ed8\u8ba4\u4e0d\u2f40\u6301\u805a\u5408\u5206\u6790\u53ca\u6392\u5e8f\u3002\u9700\u8981\u8bbe\u7f6e fielddata \u4e3a true</li> </ul>"},{"location":"chap7/5chap7_es_model/#4-2-keyword","title":"4-2 Keyword","text":"<ul> <li>\u7528\u4e8e id\uff0c\u679a\u4e3e\u53ca\u4e0d\u9700\u8981\u5206\u8bcd\u7684\u2f42\u672c\u3002\u4f8b\u5982\u7535\u8bdd\u53f7\u7801\uff0cemail\u5730\u5740\uff0c\u2f3f\u673a\u53f7\u7801\uff0c\u90ae\u653f\u7f16\u7801\uff0c\u6027\u522b\u7b49</li> <li>\u9002\u7528\u4e8e Filter(\u7cbe\u786e\u5339\u914d)\uff0cSorting \u548c Aggregations</li> </ul>"},{"location":"chap7/5chap7_es_model/#4-3","title":"4-3 \u8bbe\u7f6e\u591a\u5b57\u6bb5\u7c7b\u578b","text":"<ul> <li>\u9ed8\u8ba4\u4f1a\u4e3a\u2f42\u672c\u7c7b\u578b\u8bbe\u7f6e\u6210 text\uff0c\u5e76\u4e14\u8bbe\u7f6e\u2f00\u4e2a keyword \u7684\u2f26\u5b57\u6bb5</li> <li>\u5728\u5904\u7406\u2f08\u7c7b\u8bed\u2f94\u65f6\uff0c\u901a\u8fc7\u589e\u52a0\u201c\u82f1\u2f42\u201d\uff0c\u201c\u62fc\u2fb3\u201d\u548c\u201c\u6807\u51c6\u201d\u5206\u8bcd\u5668\uff0c\u63d0\u2fbc\u641c\u7d22\u7ed3\u6784</li> </ul>"},{"location":"chap7/5chap7_es_model/#5","title":"5\u3001\u5b57\u6bb5\u7c7b\u578b :\u7ed3\u6784\u5316\u6570\u636e","text":"<ul> <li>\u6570\u503c\u7c7b\u578b<ul> <li>\u5c3d\u91cf\u9009\u62e9\u8d34\u8fd1\u7684\u7c7b\u578b\u3002\u4f8b\u5982\u53ef\u4ee5\u2f64 byte\uff0c\u5c31\u4e0d\u8981\u7528 long</li> </ul> </li> <li>\u679a\u4e3e\u7c7b\u578b<ul> <li>\u8bbe\u7f6e\u4e3a keyword\u3002\u5373\u4fbf\u662f\u6570\u5b57\uff0c\u4e5f\u5e94\u8be5\u8bbe\u7f6e\u6210 keyword\uff0c\u83b7\u53d6\u66f4\u52a0\u597d\u7684\u6027\u80fd</li> </ul> </li> <li>\u5176\u4ed6<ul> <li>\u2f47\u671f/\u5e03\u5c14/\u5730\u7406\u4fe1\u606f</li> </ul> </li> </ul>"},{"location":"chap7/5chap7_es_model/#6","title":"6\u3001\u68c0\u7d22","text":"<ul> <li>\u5982\u4e0d\u9700\u8981\u68c0\u7d22\uff0c\u6392\u5e8f\u548c\u805a\u5408\u5206\u6790<ul> <li>Enable \u8bbe\u7f6e\u6210 false</li> </ul> </li> <li>\u5982\u4e0d\u9700\u8981\u68c0\u7d22    <ul> <li>Index \u8bbe\u7f6e\u6210 false</li> </ul> </li> <li>\u5bf9\u9700\u8981\u68c0\u7d22\u7684\u5b57\u6bb5\uff0c\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u914d\u7f6e\uff0c\u8bbe\u5b9a\u5b58\u50a8\u7c92\u5ea6<ul> <li><code>Index_options</code> / Norms :\u4e0d\u9700\u8981\u5f52\u2f00\u5316\u6570\u636e\u65f6\uff0c\u53ef\u4ee5\u5173\u95ed</li> </ul> </li> </ul>"},{"location":"chap7/5chap7_es_model/#7","title":"7\u3001\u805a\u5408\u53ca\u6392\u5e8f","text":"<ul> <li>\u5982\u4e0d\u9700\u8981\u68c0\u7d22\uff0c\u6392\u5e8f\u548c\u805a\u5408\u5206\u6790<ul> <li>Enable \u8bbe\u7f6e\u6210 false</li> </ul> </li> <li>\u5982\u4e0d\u9700\u8981\u6392\u5e8f\u6216\u8005\u805a\u5408\u5206\u6790\u529f\u80fd<ul> <li><code>Doc_values</code> / fielddata \u8bbe\u7f6e\u6210 false</li> </ul> </li> <li>\u66f4\u65b0\u9891\u7e41\uff0c\u805a\u5408\u67e5\u8be2\u9891\u7e41\u7684 keyword \u7c7b\u578b\u7684\u5b57\u6bb5<ul> <li>\u63a8\u8350\u5c06 <code>eager_global_ordinals</code> \u8bbe\u7f6e\u4e3a true</li> </ul> </li> </ul>"},{"location":"chap7/5chap7_es_model/#8","title":"8\u3001\u989d\u5916\u7684\u5b58\u50a8","text":"<ul> <li>\u662f\u5426\u9700\u8981\u4e13\u2ed4\u5b58\u50a8\u5f53\u524d\u5b57\u6bb5\u6570\u636e<ul> <li>Store \u8bbe\u7f6e\u6210 true\uff0c\u53ef\u4ee5\u5b58\u50a8\u8be5\u5b57\u6bb5\u7684\u539f\u59cb\u5185\u5bb9</li> <li>\u4e00\u822c\u7ed3\u5408 <code>_source</code> \u7684 <code>enabled</code> \u4e3a <code>false</code> \u65f6\u5019\u4f7f\u2f64</li> </ul> </li> <li><code>Disable _source</code>:\u8282\u7ea6\u78c1\u76d8; \u9002\u2f64\u4e8e\u6307\u6807\u578b\u6570\u636e<ul> <li>\u4e00\u822c\u5efa\u8bae\u5148\u8003\u8651\u589e\u52a0\u538b\u7f29\u2f50</li> <li>\u2f46\u6cd5\u770b\u5230 <code>_source</code> \u5b57\u6bb5\uff0c\u2f46\u6cd5\u505a <code>ReIndex</code>\uff0c\u2f46\u6cd5\u505a <code>Update</code></li> <li>Kibana \u4e2d\u2f46\u65e0\u6cd5\u505a discovery</li> </ul> </li> </ul>"},{"location":"chap7/5chap7_es_model/#9","title":"9\u3001\u2f00\u4e2a\u6570\u636e\u5efa\u6a21\u7684\u5b9e\u4f8b","text":"<p>\u56fe\u4e66\u7684\u7d22\u5f15 </p> <ul> <li>\u4e66\u540d </li> <li>\u7b80\u4ecb </li> <li>\u4f5c\u8005</li> <li>\u53d1\u2f8f\u65e5\u671f </li> <li>\u56fe\u4e66\u5c01\u2faf</li> </ul> <pre><code># Index \u4e00\u672c\u4e66\u7684\u4fe1\u606f\nPUT books/_doc/1\n{\n  \"title\":\"Mastering ElasticSearch 5.0\",\n  \"description\":\"Master the searching, indexing, and aggregation features in ElasticSearch Improve users\u2019 search experience with Elasticsearch\u2019s functionalities and develop your own Elasticsearch plugins\",\n  \"author\":\"Bharvi Dixit\",\n  \"public_date\":\"2017\",\n  \"cover_url\":\"https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg\"\n}\n</code></pre> <pre><code>#\u67e5\u8be2\u81ea\u52a8\u521b\u5efa\u7684Mapping\nGET books/_mapping\n</code></pre> <p>Output:</p> <pre><code>{\n  \"books\" : {\n    \"mappings\" : {\n      \"properties\" : {\n        \"author\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n            }\n          }\n        },\n        \"cover_url\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n            }\n          }\n        },\n        \"description\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n            }\n          }\n        },\n        \"public_date\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n            }\n          }\n        },\n        \"title\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n...\n</code></pre> <p>All type is keyword</p>"},{"location":"chap7/5chap7_es_model/#9-1","title":"9-1 \u4f18\u5316\u5b57\u6bb5\u7c7b\u578b","text":"<ul> <li>\u56fe\u4e66\u7684\u7d22\u5f15<ul> <li>\u4e66\u540d:\u2f40\u6301\u5168\u2f42\u548c\u7cbe\u786e\u5339\u914d </li> <li>\u7b80\u4ecb:\u2f40\u6301\u5168\u2f42</li> <li>\u4f5c\u8005:\u7cbe\u786e\u503c</li> <li>\u53d1\u2f8f\u2f47\u671f:\u2f47\u671f\u7c7b\u578b</li> <li>\u56fe\u4e66\u5c01\u9762:\u7cbe\u786e\u503c</li> </ul> </li> </ul> <pre><code>DELETE books\n\nPUT books\n{\n      \"mappings\" : {\n      \"properties\" : {\n        \"author\" : {\"type\" : \"keyword\"},\n        \"cover_url\" : {\"type\" : \"keyword\",\"index\": false},\n        \"description\" : {\"type\" : \"text\"},\n        \"public_date\" : {\"type\" : \"date\"},\n        \"title\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 100\n            }\n          }\n        }\n      }\n    }\n}\n</code></pre> <ul> <li><code>\"cover_url\" : {\"type\" : \"keyword\",\"index\": false},</code>: \u5982\u4e0d\u9700\u8981\u68c0\u7d22</li> </ul> <p>Output:</p> <pre><code>{\n  \"acknowledged\" : true,\n  \"shards_acknowledged\" : true,\n  \"index\" : \"books\"\n}\n</code></pre> <p>Cover URL index \u8bbe\u7f6e\u6210false\uff0c\u65e0\u6cd5\u5bf9\u8be5\u5b57\u6bb5\u8fdb\u884c\u641c\u7d22</p> <pre><code>#Cover URL index \u8bbe\u7f6e\u6210false\uff0c\u65e0\u6cd5\u5bf9\u8be5\u5b57\u6bb5\u8fdb\u884c\u641c\u7d22\nPOST books/_search\n{\n  \"query\": {\n    \"term\": {\n      \"cover_url\": {\n        \"value\": \"https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg\"\n      }\n    }\n  }\n}\n</code></pre> <p>Output: 400 - Bad Request</p> <pre><code>failed_shards\" : [\n      {\n        \"shard\" : 0,\n        \"index\" : \"books\",\n        \"node\" : \"L7jf3HA8TqOEtNY8BrU82A\",\n        \"reason\" : {\n          \"type\" : \"query_shard_exception\",\n          \"reason\" : \"failed to create query: Cannot search on field [cover_url] since it is not indexed.\",\n          \"index_uuid\" : \"trWUWXSwSAiS-TvtsvDQSA\",\n          \"index\" : \"books\",\n          \"caused_by\" : {\n            \"type\" : \"illegal_argument_exception\",\n            \"reason\" : \"Cannot search on field [cover_url] since it is not indexed.\"\n          }\n        }\n      }\n    ]\n</code></pre> <ul> <li>\"reason\" : \"failed to create query: Cannot search on field [cover_url] since it is not indexed.\"</li> </ul> <p>Cover URL index \u8bbe\u7f6e\u6210false\uff0c\u4f9d\u7136\u652f\u6301\u805a\u5408\u5206\u6790</p> <pre><code>#Cover URL index \u8bbe\u7f6e\u6210false\uff0c\u4f9d\u7136\u652f\u6301\u805a\u5408\u5206\u6790\nPOST books/_search\n{\n  \"aggs\": {\n    \"cover\": {\n      \"terms\": {\n        \"field\": \"cover_url\",\n        \"size\": 10\n      }\n    }\n  }\n}\n</code></pre> <p>Output:</p> <pre><code>aggregations\" : {\n    \"cover\" : {\n      \"doc_count_error_upper_bound\" : 0,\n      \"sum_other_doc_count\" : 0,\n      \"buckets\" : [ ]\n</code></pre>"},{"location":"chap7/5chap7_es_model/#9-2","title":"9-2 \u9700\u6c42\u53d8\u66f4","text":"<ul> <li>\u65b0\u9700\u6c42:\u589e\u52a0\u56fe\u4e66\u5185\u5bb9\u7684\u5b57\u6bb5\u3002\u5e76\u8981\u6c42\u80fd\u88ab\u641c\u7d22\u540c\u65f6\u2f40\u6301\u2fbc\u4eae\u663e\u793a</li> <li> <p>\u65b0\u9700\u6c42\u4f1a\u5bfc\u81f4 <code>_source</code> \u7684\u5185\u5bb9\u8fc7\u2f24</p> <ul> <li>Source Filtering \u53ea\u662f\u4f20\u8f93\u7ed9\u5ba2\u6237\u7aef\u65f6\u8fdb\u2f8f\u8fc7\u6ee4\uff0cFetch \u6570\u636e\u65f6\uff0cES \u8282\u70b9\u8fd8\u662f\u4f1a\u4f20\u8f93 <code>_source</code> \u4e2d\u7684\u6570\u636e </li> </ul> </li> <li> <p>\u89e3\u51b3\u2f45\u6cd5</p> <ul> <li>\u5173\u95ed <code>_source</code></li> <li>\u7136\u540e\u5c06\u6bcf\u4e2a\u5b57\u6bb5\u7684 \u201cstore\u201d \u8bbe\u7f6e\u6210 true</li> </ul> </li> </ul> <pre><code>DELETE books\n</code></pre> <p>\u65b0\u589e Content\u5b57\u6bb5\u3002\u6570\u636e\u91cf\u5f88\u5927\u3002\u9009\u62e9\u5c06Source \u5173\u95ed</p> <pre><code>#\u65b0\u589e Content\u5b57\u6bb5\u3002\u6570\u636e\u91cf\u5f88\u5927\u3002\u9009\u62e9\u5c06Source \u5173\u95ed\nPUT books\n{\n      \"mappings\" : {\n      \"_source\": {\"enabled\": false},\n      \"properties\" : {\n        \"author\" : {\"type\" : \"keyword\",\"store\": true},\n        \"cover_url\" : {\"type\" : \"keyword\",\"index\": false,\"store\": true},\n        \"description\" : {\"type\" : \"text\",\"store\": true},\n         \"content\" : {\"type\" : \"text\",\"store\": true},\n        \"public_date\" : {\"type\" : \"date\",\"store\": true},\n        \"title\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 100\n            }\n          },\n          \"store\": true\n        }\n      }\n    }\n}\n</code></pre> <p><code>\"_source\": {\"enabled\": false},</code></p> <p>Output:</p> <pre><code>{\n  \"acknowledged\" : true,\n  \"shards_acknowledged\" : true,\n  \"index\" : \"books\"\n}\n</code></pre> <pre><code># Index \u4e00\u672c\u4e66\u7684\u4fe1\u606f,\u5305\u542bContent\nPUT books/_doc/1\n{\n  \"title\":\"Mastering ElasticSearch 5.0\",\n  \"description\":\"Master the searching, indexing, and aggregation features in ElasticSearch Improve users\u2019 search experience with Elasticsearch\u2019s functionalities and develop your own Elasticsearch plugins\",\n  \"content\":\"The content of the book......Indexing data, aggregation, searching.    something else. something in the way............\",\n  \"author\":\"Bharvi Dixit\",\n  \"public_date\":\"2017\",\n  \"cover_url\":\"https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg\"\n}\n</code></pre> <pre><code># Index \u4e00\u672c\u4e66\u7684\u4fe1\u606f,\u5305\u542bContent\nPUT books/_doc/1\n{\n  \"title\":\"Mastering ElasticSearch 5.0\",\n  \"description\":\"Master the searching, indexing, and aggregation features in ElasticSearch Improve users\u2019 search experience with Elasticsearch\u2019s functionalities and develop your own Elasticsearch plugins\",\n  \"content\":\"The content of the book......Indexing data, aggregation, searching.    something else. something in the way............\",\n  \"author\":\"Bharvi Dixit\",\n  \"public_date\":\"2017\",\n  \"cover_url\":\"https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg\"\n}\n</code></pre> <pre><code>#\u67e5\u8be2\u7ed3\u679c\u4e2d\uff0cSource\u4e0d\u5305\u542b\u6570\u636e\nPOST books/_search\n{}\n</code></pre> <p>\u641c\u7d22\uff0c\u901a\u8fc7store \u5b57\u6bb5\u663e\u793a\u6570\u636e\uff0c\u540c\u65f6\u9ad8\u4eae\u663e\u793a conent\u7684\u5185\u5bb9</p> <p>\u67e5\u8be2\u56fe\u4e66:\u89e3\u51b3\u5b57\u6bb5\u8fc7\u2f24\u5f15\u53d1\u7684\u6027\u80fd\u95ee\u9898</p> <ul> <li>\u8fd4\u56de\u7ed3\u679c\u4e0d\u5305\u542b <code>_source</code> \u5b57\u6bb5</li> <li>\u5bf9\u4e8e\u9700\u8981\u663e\u793a\u7684\u4fe1\u606f\uff0c\u53ef\u4ee5\u5728\u5728\u67e5\u8be2\u4e2d\u6307\u5b9a<code>\u201cstored_fields\"</code></li> <li>\u7981\u2f4c <code>_source</code>\u5b57\u6bb5\u540e\uff0c\u8fd8\u662f\u2f40\u6301\u4f7f\u2f64 <code>highlights API</code>\uff0c\u2fbc\u4eae\u663e\u793a <code>content</code> \u4e2d\u5339\u914d\u7684\u76f8\u5173\u4fe1\u606f</li> </ul> <pre><code>#\u641c\u7d22\uff0c\u901a\u8fc7store \u5b57\u6bb5\u663e\u793a\u6570\u636e\uff0c\u540c\u65f6\u9ad8\u4eae\u663e\u793a conent\u7684\u5185\u5bb9\nPOST books/_search\n{\n  \"stored_fields\": [\"title\",\"author\",\"public_date\"],\n  \"query\": {\n    \"match\": {\n      \"content\": \"searching\"\n    }\n  },\n\n  \"highlight\": {\n    \"fields\": {\n      \"content\":{}\n    }\n  }\n}\n</code></pre> <p>Output:</p> <pre><code>    \"max_score\" : 0.2876821,\n    \"hits\" : [\n      {\n        \"_index\" : \"books\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"1\",\n        \"_score\" : 0.2876821,\n        \"fields\" : {\n          \"author\" : [\n            \"Bharvi Dixit\"\n          ],\n          \"title\" : [\n            \"Mastering ElasticSearch 5.0\"\n          ],\n          \"public_date\" : [\n            \"2017-01-01T00:00:00.000Z\"\n          ]\n        },\n        \"highlight\" : {\n          \"content\" : [\n            \"The content of the book......Indexing data, aggregation, &lt;em&gt;searching&lt;/em&gt;.\"\n          ]\n        }\n      }\n    ]\n  }\n</code></pre>"},{"location":"chap7/5chap7_es_model/#10mapping","title":"10\u3001Mapping \u5b57\u6bb5\u7684\u76f8\u5173\u8bbe\u7f6e","text":"<ul> <li>https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-params.html<ul> <li><code>Enabled</code> \u2013 \u8bbe\u7f6e\u6210 false\uff0c\u4ec5\u505a\u5b58\u50a8\uff0c\u4e0d\u652f\u6301\u641c\u7d22\u548c\u805a\u5408\u5206\u6790 (\u6570\u636e\u4fdd\u5b58\u5728 <code>_source</code> \u4e2d)</li> <li>Index \u2013 \u662f\u5426\u6784\u5012\u6392\u7d22\u5f15\u3002\u8bbe\u7f6e\u6210 false\uff0c\u2f46\u6cd5\u88ab\u641c\u7d22\uff0c\u4f46\u8fd8\u662f\u2f40\u6301 aggregation\uff0c\u5e76\u51fa\u73b0\u5728 <code>_source</code>\u4e2d</li> <li><code>Norms</code> \u2013 \u5982\u679c\u5b57\u6bb5\u2f64\u6765\u8fc7\u6ee4\u548c\u805a\u5408\u5206\u6790\uff0c\u53ef\u4ee5\u5173\u95ed\uff0c\u8282\u7ea6\u5b58\u50a8</li> <li><code>Doc_values</code> \u2013 \u662f\u5426\u542f\u2f64 <code>doc_values</code>\uff0c\u2f64\u7528\u4e8e\u6392\u5e8f\u548c\u805a\u5408\u5206\u6790</li> <li><code>Field_data</code> \u2013 \u5982\u679c\u8981\u5bf9 text \u7c7b\u578b\u542f\u2f64\u6392\u5e8f\u548c\u805a\u5408\u5206\u6790\uff0c fielddata \u9700\u8981\u8bbe\u7f6e\u6210true</li> <li>Store \u2013 \u9ed8\u8ba4\u4e0d\u5b58\u50a8\uff0c\u6570\u636e\u9ed8\u8ba4\u5b58\u50a8\u5728 <code>_source</code>\u3002</li> <li>Coerce \u2013 \u9ed8\u8ba4\u5f00\u542f\uff0c\u662f\u5426\u5f00\u542f\u6570\u636e\u7c7b\u578b\u7684\u2f83\u52a8\u8f6c\u6362(\u4f8b\u5982\uff0c\u5b57\u7b26\u4e32\u8f6c\u6570\u5b57)</li> <li>Multifields \u591a\u5b57\u6bb5\u7279\u6027</li> <li>Dynamic \u2013 true / false / strict \u63a7\u5236 Mapping \u7684\u2f83\u52a8\u66f4\u65b0</li> </ul> </li> </ul>"},{"location":"chap7/5chap7_es_model/#1-1-api","title":"1-1 \u2f00\u4e9b\u76f8\u5173\u7684 API","text":"<ul> <li>Index Template &amp; Dynamic Template<ul> <li>\u6839\u636e\u7d22\u5f15\u7684\u540d\u5b57\u5339\u914d\u4e0d\u540c\u7684 Mappings \u548c Settings</li> <li>\u53ef\u4ee5\u5728\u2f00\u4e2a Mapping \u4e0a\u52a8\u6001\u7684\u8bbe\u5b9a\u5b57\u6bb5\u7c7b\u578b</li> </ul> </li> <li>Index Alias<ul> <li>\u2f46\u9700\u505c\u673a\uff0c\u2f46\u9700\u4fee\u6539\u7a0b\u5e8f\uff0c\u5373\u53ef\u8fdb\u2f8f\u4fee\u6539</li> </ul> </li> <li>Update By Query &amp; Reindex</li> </ul>"},{"location":"chap7/5chap7_es_model/#11","title":"11\u3001\u672c\u7ae0\u77e5\u8bc6\u70b9","text":"<ul> <li>\u6570\u636e\u5efa\u6a21\u5bf9\u529f\u80fd\u4e0e\u6027\u80fd\u2f84\u81f3\u5173\u91cd\u8981<ul> <li>Mapping. &amp; Setting</li> <li>\u5b57\u6bb5 Mapping \u53c2\u6570\u7684\u2f00\u4e9b\u56de\u987e\uff0c\u5206\u2f5a\u7684\u8bbe\u5b9a\uff0c\u4f1a\u5728\u540e\u7eed\u8bb2\u89e3</li> </ul> </li> <li>\u901a\u8fc7\u5177\u4f53\u7684\u5b9e\u4f8b\uff0c\u5b66\u4e60\u4e86\u6570\u636e\u5efa\u6a21\u65f6\u9700\u8981\u8003\u8651\u7684\u70b9<ul> <li>\u786e\u5b9a\u5b57\u6bb5\u7c7b\u578b</li> <li>\u662f\u5426\u9700\u8981\u641c\u7d22\u548c\u805a\u5408\u4ee5\u53ca\u6392\u5e8f</li> <li>\u662f\u5426\u9700\u8981\u7981\u2f4c <code>_source</code> \u4ee5\u53ca\u6253\u5f00 <code>store</code></li> </ul> </li> </ul>"},{"location":"chap7/6chap7_es_model_pra/","title":"\u7b2c\u516d\u8282 Elasticsearch \u6570\u636e\u5efa\u6a21\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"chap7/6chap7_es_model_pra/#1","title":"1\u3001\u5efa\u6a21\u5efa\u8bae(\u2f00):\u5982\u4f55\u5904\u7406\u5173\u8054\u5173\u7cfb","text":""},{"location":"chap7/6chap7_es_model_pra/#2kibana","title":"2\u3001Kibana......","text":"<ul> <li>Kibana \u2f6c\u524d\u6682\u4e0d\u2f40\u6301 nested \u7c7b\u578b\u548c parent/child \u7c7b\u578b \uff0c\u5728\u672a\u6765\u6709\u53ef\u80fd\u4f1a\u652f\u6301</li> <li>\u5982\u679c\u9700\u8981\u4f7f\u2f64 Kibana \u8fdb\u884c\u6570\u636e\u5206\u6790\uff0c\u5728\u6570\u636e\u5efa\u6a21\u65f6\u4ecd\u9700\u5bf9\u5d4c\u5957\u548c\u2f57\u5b50\u5173\u8054\u7c7b\u578b\u4f5c\u51fa\u53d6\u820d</li> </ul>"},{"location":"chap7/6chap7_es_model_pra/#3","title":"3\u3001\u5efa\u6a21\u5efa\u8bae(\u2f06): \u907f\u514d\u8fc7\u591a\u5b57\u6bb5","text":"<ul> <li>\u4e00\u4e2a\u2f42\u6863\u4e2d\uff0c\u6700\u597d\u907f\u514d\u2f24\u91cf\u7684\u5b57\u6bb5 <ul> <li>\u8fc7\u591a\u7684\u5b57\u6bb5\u6570\u4e0d\u5bb9\u6613\u7ef4\u62a4</li> <li>Mapping \u4fe1\u606f\u4fdd\u5b58\u5728 Cluster State \u4e2d\uff0c\u6570\u636e\u91cf\u91cf\u8fc7\u2f24\uff0c\u5bf9\u96c6\u7fa4\u6027\u80fd\u4f1a\u6709\u5f71\u54cd (Cluster State \u4fe1\u606f\u9700\u8981\u548c\u6240\u6709\u7684\u8282\u70b9\u540c\u6b65)</li> <li>\u5220\u9664\u6216\u8005\u4fee\u6539\u6570\u636e\u9700\u8981 reindex</li> </ul> </li> <li>\u9ed8\u8ba4\u6700\u2f24\u5b57\u6bb5\u6570\u662f 1000\uff0c\u53ef\u4ee5\u8bbe\u7f6e <code>index.mapping.total_fields.limt</code> \u9650\u5b9a\u6700\u2f24\u5b57\u6bb5\u6570\u3002 </li> <li>\u4ec0\u4e48\u539f\u56e0\u4f1a\u5bfc\u81f4\u6587\u6863\u4e2d\u6709\u6210\u767e\u4e0a\u5343\u7684\u5b57\u6bb5?</li> </ul>"},{"location":"chap7/6chap7_es_model_pra/#4dynamic-vs-strict","title":"4\u3001Dynamic v.s Strict","text":"<ul> <li> <p>Dynamic(\u2f63\u4ea7\u73af\u5883\u4e2d\uff0c\u5c3d\u91cf\u4e0d\u8981\u6253\u5f00 Dynamic)</p> <ul> <li>true - \u672a\u77e5\u5b57\u6bb5\u4f1a\u88ab\u2f83\u52a8\u52a0\u5165</li> <li>false - \u65b0\u5b57\u6bb5\u4e0d\u4f1a\u88ab\u7d22\u5f15\u3002\u4f46\u662f\u4f1a\u4fdd\u5b58\u5728 <code>_source</code></li> <li>strict - \u65b0\u589e\u5b57\u6bb5\u4e0d\u4f1a\u88ab\u7d22\u5f15\uff0c\u2f42\u6863\u5199\u2f0a\u5931\u8d25</li> </ul> </li> <li> <p>Strict</p> <ul> <li>\u53ef\u4ee5\u63a7\u5236\u5230\u5b57\u6bb5\u7ea7\u522b </li> </ul> </li> </ul>"},{"location":"chap7/6chap7_es_model_pra/#5cookie-service","title":"5\u3001\u2f00\u4e2a\u4f8b\u2f26:Cookie Service \u7684\u6570\u636e","text":"<ul> <li>\u6765\u81ea Cookie Service \u7684\u6570\u636e<ul> <li>Cookie \u7684\u952e\u503c\u5bf9\u5f88\u591a</li> <li>\u5f53 Dynamic \u8bbe\u7f6e\u4e3a True</li> <li>\u540c\u65f6\u91c7\u7528\u6241\u5e73\u5316\u7684\u8bbe\u8ba1\uff0c\u5fc5\u7136\u5bfc\u81f4\u5b57\u6bb5\u6570\u91cf\u7684\u81a8\u80c0</li> </ul> </li> </ul> <pre><code>##\u7d22\u5f15\u6570\u636e\uff0cdynamic mapping \u4f1a\u4e0d\u65ad\u52a0\u5165\u65b0\u589e\u5b57\u6bb5\nPUT cookie_service/_doc/1\n{\n \"url\":\"www.google.com\",\n \"cookies\":{\n   \"username\":\"tom\",\n   \"age\":32\n }\n}\n\nPUT cookie_service/_doc/2\n{\n \"url\":\"www.amazon.com\",\n \"cookies\":{\n   \"login\":\"2019-01-01\",\n   \"email\":\"xyz@abc.com\"\n }\n}\n</code></pre> <pre><code>GET cookie_service/_mapping\n</code></pre> <p>Output:</p> <pre><code>{\n  \"cookie_service\" : {\n    \"mappings\" : {\n      \"properties\" : {\n        \"cookies\" : {\n          \"properties\" : {\n            \"age\" : {\n              \"type\" : \"long\"\n            },\n            \"email\" : {\n              \"type\" : \"text\",\n              \"fields\" : {\n                \"keyword\" : {\n                  \"type\" : \"keyword\",\n                  \"ignore_above\" : 256\n                }\n              }\n            },\n            \"login\" : {\n              \"type\" : \"date\"\n            },\n            \"username\" : {\n              \"type\" : \"text\",\n              \"fields\" : {\n                \"keyword\" : {\n                  \"type\" : \"keyword\",\n                  \"ignore_above\" : 256\n                }\n              }\n            }\n          }\n        },\n        \"url\" : {\n          \"type\" : \"text\",\n          \"fields\" : {\n            \"keyword\" : {\n              \"type\" : \"keyword\",\n              \"ignore_above\" : 256\n            }\n          }\n        }\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"chap7/6chap7_es_model_pra/#6nested-object-key-value","title":"6\u3001\u89e3\u51b3\u2f45\u6848:Nested Object &amp; Key Value","text":"<p><code>\"type\": \"nested\",</code></p>"},{"location":"chap7/6chap7_es_model_pra/#6-1-nested-keyvalue","title":"6-1 \u4f7f\u7528 Nested \u5bf9\u8c61\uff0c\u589e\u52a0key/value","text":"<pre><code>DELETE cookie_service\n\nPUT cookie_service\n{\n  \"mappings\": {\n    \"properties\": {\n      \"cookies\": {\n        \"type\": \"nested\",\n        \"properties\": {\n          \"name\": {\n            \"type\": \"keyword\"\n          },\n          \"dateValue\": {\n            \"type\": \"date\"\n          },\n          \"keywordValue\": {\n            \"type\": \"keyword\"\n          },\n          \"IntValue\": {\n            \"type\": \"integer\"\n          }\n        }\n      },\n      \"url\": {\n        \"type\": \"text\",\n        \"fields\": {\n          \"keyword\": {\n            \"type\": \"keyword\",\n            \"ignore_above\": 256\n          }\n        }\n      }\n    }\n  }\n}\n</code></pre> <p>Output:</p> <pre><code>{\n  \"acknowledged\" : true,\n  \"shards_acknowledged\" : true,\n  \"index\" : \"cookie_service\"\n}\n</code></pre>"},{"location":"chap7/6chap7_es_model_pra/#6-2-keyvalue","title":"6-2 \u5199\u5165\u6570\u636e\uff0c\u4f7f\u7528key\u548c\u5408\u9002\u7c7b\u578b\u7684value\u5b57\u6bb5","text":"<pre><code>PUT cookie_service/_doc/1\n{\n \"url\":\"www.google.com\",\n \"cookies\":[\n    {\n      \"name\":\"username\",\n      \"keywordValue\":\"tom\"\n    },\n    {\n       \"name\":\"age\",\n      \"intValue\":32\n\n    }\n\n   ]\n }\n\n\nPUT cookie_service/_doc/2\n{\n \"url\":\"www.amazon.com\",\n \"cookies\":[\n    {\n      \"name\":\"login\",\n      \"dateValue\":\"2019-01-01\"\n    },\n    {\n       \"name\":\"email\",\n      \"IntValue\":32\n\n    }\n\n   ]\n }\n\n</code></pre>"},{"location":"chap7/6chap7_es_model_pra/#6-3","title":"6-3 \u5199\u2f0a &amp; \u67e5\u8be2","text":"<p>Nested \u67e5\u8be2\uff0c\u901a\u8fc7bool\u67e5\u8be2\u8fdb\u884c\u8fc7\u6ee4</p> <pre><code>POST cookie_service/_search\n{\n  \"query\": {\n    \"nested\": {\n      \"path\": \"cookies\",\n      \"query\": {\n        \"bool\": {\n          \"filter\": [\n            {\n            \"term\": {\n              \"cookies.name\": \"age\"\n            }},\n            {\n              \"range\":{\n                \"cookies.intValue\":{\n                  \"gte\":30\n                }\n              }\n            }\n          ]\n        }\n      }\n    }\n  }\n}\n</code></pre> <p>Output</p> <pre><code>\"hits\" : [\n      {\n        \"_index\" : \"cookie_service\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"1\",\n        \"_score\" : 0.0,\n        \"_source\" : {\n          \"url\" : \"www.google.com\",\n          \"cookies\" : [\n            {\n              \"name\" : \"username\",\n              \"keywordValue\" : \"tom\"\n            },\n            {\n              \"name\" : \"age\",\n              \"intValue\" : 32\n            }\n          ]\n        }\n      }\n    ]\n</code></pre>"},{"location":"chap7/6chap7_es_model_pra/#6-4-nested-keyvalue","title":"6-4 \u901a\u8fc7 Nested \u5bf9\u8c61\u4fdd\u5b58 Key/Value \u7684\u2f00\u4e9b\u4e0d\u8db3","text":"<ul> <li>\u53ef\u4ee5\u51cf\u5c11\u5b57\u6bb5\u6570\u91cf\uff0c\u89e3\u51b3 Cluster State \u4e2d\u4fdd\u5b58\u8fc7\u591a Meta \u4fe1\u606f\u7684\u95ee\u9898\uff0c\u4f46\u662f<ul> <li>\u5bfc\u81f4\u67e5\u8be2\u8bed\u53e5\u590d\u6742\u5ea6\u589e\u52a0</li> <li>Nested \u5bf9\u8c61\uff0c\u4e0d\u5229\u4e8e\u5728 Kibana \u4e2d\u5b9e\u73b0\u53ef\u89c6\u5316\u5206\u6790</li> </ul> </li> </ul>"},{"location":"chap7/6chap7_es_model_pra/#7","title":"7\u3001\u5efa\u6a21\u5efa\u8bae(\u4e09):\u907f\u514d\u6b63\u5219\u67e5\u8be2","text":"<p>\u95ee\u9898:</p> <ul> <li>\u6b63\u5219\uff0c\u901a\u914d\u7b26\u67e5\u8be2\uff0c\u524d\u7f00\u67e5\u8be2\u5c5e\u4e8e Term \u67e5\u8be2\uff0c\u4f46\u662f\u6027\u80fd\u4e0d\u591f\u597d </li> <li>\u7279\u522b\u662f\u5c06\u901a\u914d\u7b26\u653e\u5728\u5f00\u5934\uff0c\u4f1a\u5bfc\u81f4\u6027\u80fd\u7684\u707e\u96be</li> </ul> <p>\u6848\u4f8b:</p> <ul> <li>\u6587\u6863\u4e2d\u67d0\u4e2a\u5b57\u6bb5\u5305\u542b\u4e86 Elasticsearch \u7684\u7248\u672c\u4fe1\u606f\uff0c\u4f8b\u5982 version: \u201c7.1.0\u201d</li> <li>\u641c\u7d22\u6240\u6709\u662f bug fix \u7684\u7248\u672c?\u6bcf\u4e2a\u4e3b\u8981\u7248\u672c\u53f7\u6240\u5173\u8054\u7684\u2f42\u6587\u6863?</li> </ul> <pre><code># \u5728Mapping\u4e2d\u52a0\u5165\u5143\u4fe1\u606f\uff0c\u4fbf\u4e8e\u7ba1\u7406\nPUT softwares/\n{\n  \"mappings\": {\n    \"_meta\": {\n      \"software_version_mapping\": \"1.0\"\n    }\n  }\n}\n</code></pre> <pre><code>GET softwares/_mapping\n\nPUT softwares/_doc/1\n{\n  \"software_version\":\"7.1.0\"\n}\n</code></pre> <pre><code>POST softwares/_search\n{}\n</code></pre> <p>Output:</p> <pre><code>hits\" : [\n      {\n        \"_index\" : \"softwares\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"1\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"software_version\" : \"7.1.0\"\n        }\n      }\n    ]\n</code></pre>"},{"location":"chap7/6chap7_es_model_pra/#7-1","title":"7-1 \u89e3\u51b3\u2f45\u6848:\u5c06\u5b57\u7b26\u4e32\u8f6c\u6362\u4e3a\u5bf9\u8c61","text":"<pre><code>DELETE softwares\n\n# \u4f18\u5316,\u4f7f\u7528inner object\nPUT softwares/\n{\n  \"mappings\": {\n    \"_meta\": {\n      \"software_version_mapping\": \"1.1\"\n    },\n    \"properties\": {\n      \"version\": {\n        \"properties\": {\n          \"display_name\": {\n            \"type\": \"keyword\"\n          },\n          \"hot_fix\": {\n            \"type\": \"byte\"\n          },\n          \"marjor\": {\n            \"type\": \"byte\"\n          },\n          \"minor\": {\n            \"type\": \"byte\"\n          }\n        }\n      }\n    }\n  }\n}\n</code></pre> <p>\u901a\u8fc7 Inner Object \u5199\u5165\u591a\u4e2a\u6587\u6863</p> <pre><code>#\u901a\u8fc7 Inner Object \u5199\u5165\u591a\u4e2a\u6587\u6863\nPUT softwares/_doc/1\n{\n  \"version\":{\n  \"display_name\":\"7.1.0\",\n  \"marjor\":7,\n  \"minor\":1,\n  \"hot_fix\":0  \n  }\n\n}\n\nPUT softwares/_doc/2\n{\n  \"version\":{\n  \"display_name\":\"7.2.0\",\n  \"marjor\":7,\n  \"minor\":2,\n  \"hot_fix\":0  \n  }\n}\n\nPUT softwares/_doc/3\n{\n  \"version\":{\n  \"display_name\":\"7.2.1\",\n  \"marjor\":7,\n  \"minor\":2,\n  \"hot_fix\":1  \n  }\n}\n</code></pre>"},{"location":"chap7/6chap7_es_model_pra/#7-2","title":"7-2 \u641c\u7d22\u8fc7\u6ee4","text":"<pre><code># \u901a\u8fc7 bool \u67e5\u8be2\uff0c\nPOST softwares/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"filter\": [\n        {\n          \"match\":{\n            \"version.marjor\":7\n          }\n        },\n        {\n          \"match\":{\n            \"version.minor\":2\n          }\n        }\n\n      ]\n    }\n  }\n}\n</code></pre> <p>Output:</p> <pre><code>\"max_score\" : 0.0,\n    \"hits\" : [\n      {\n        \"_index\" : \"softwares\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"2\",\n        \"_score\" : 0.0,\n        \"_source\" : {\n          \"version\" : {\n            \"display_name\" : \"7.2.0\",\n            \"marjor\" : 7,\n            \"minor\" : 2,\n            \"hot_fix\" : 0\n          }\n        }\n      },\n      {\n        \"_index\" : \"softwares\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"3\",\n        \"_score\" : 0.0,\n        \"_source\" : {\n          \"version\" : {\n            \"display_name\" : \"7.2.1\",\n            \"marjor\" : 7,\n            \"minor\" : 2,\n            \"hot_fix\" : 1\n          }\n        }\n      }\n    ]\n</code></pre>"},{"location":"chap7/6chap7_es_model_pra/#8","title":"8\u3001\u5efa\u6a21\u5efa\u8bae(\u56db):\u907f\u514d\u7a7a\u503c\u5f15\u8d77\u7684\u805a\u5408\u4e0d\u51c6","text":"<pre><code>\nPUT ratings/_doc/1\n{\n \"rating\":5\n}\nPUT ratings/_doc/2\n{\n \"rating\":null\n}\n\nPOST ratings/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"avg\": {\n      \"avg\": {\n        \"field\": \"rating\"\n      }\n    }\n  }\n}\n</code></pre> <p>Output:</p> <pre><code>\"hits\" : {\n    \"total\" : {\n      \"value\" : 2,\n      \"relation\" : \"eq\"\n    },\n    \"max_score\" : null,\n    \"hits\" : [ ]\n  },\n\"aggregations\" : {\n    \"avg\" : {\n      \"value\" : 5.0\n    }\n  }\n</code></pre> <p>\"value\" : 5.0 \u662f\u4e0d\u5bf9\u7684</p>"},{"location":"chap7/6chap7_es_model_pra/#8-1-not-null","title":"8-1 Not Null \u89e3\u51b3\u805a\u5408\u7684\u95ee\u9898","text":"<pre><code>DELETE ratings\n\nPUT ratings\n{\n  \"mappings\": {\n      \"properties\": {\n        \"rating\": {\n          \"type\": \"float\",\n          \"null_value\": 1.0\n        }\n      }\n    }\n}\n\n\nPUT ratings/_doc/1\n{\n \"rating\":5\n}\nPUT ratings/_doc/2\n{\n \"rating\":null\n}\n</code></pre> <p>```  POST ratings/_search {   \"size\": 0,   \"aggs\": {     \"avg\": {       \"avg\": {         \"field\": \"rating\"       }     }   } }</p> <pre><code>\n***Output***\n\n</code></pre> <p>\"hits\" : {     \"total\" : {       \"value\" : 2,       \"relation\" : \"eq\"     },     \"max_score\" : null,     \"hits\" : [ ]   },   \"aggregations\" : {     \"avg\" : {       \"value\" : 3.0     }   } ```</p> <ul> <li><code>\"value\" : 3.0</code> \u5f97\u5230\u6b63\u786e\u7684\u8f93\u51fa</li> </ul>"},{"location":"chap7/6chap7_es_model_pra/#9-mapping-meta","title":"9\u3001\u5efa\u6a21\u5efa\u8bae(\u4e94): \u4e3a\u7d22\u5f15\u7684 Mapping \u52a0\u2f0a Meta \u4fe1\u606f","text":"<ul> <li>Mappings \u8bbe\u7f6e\u2fae\u5e38\u91cd\u8981\uff0c\u9700\u8981\u4ece\u4e24\u4e2a\u7ef4\u5ea6\u8fdb\u2f8f\u8003\u8651<ul> <li>\u529f\u80fd:\u641c\u7d22\uff0c\u805a\u5408\uff0c\u6392\u5e8f</li> <li>\u6027\u80fd:<ul> <li>\u5b58\u50a8\u7684\u5f00\u9500;</li> <li>\u5185\u5b58\u7684\u5f00\u9500;</li> <li>\u641c\u7d22\u7684\u6027\u80fd</li> </ul> </li> </ul> </li> <li>Mappings \u8bbe\u7f6e\u662f\u2f00\u4e2a\u8fed\u4ee3\u7684\u8fc7\u7a0b<ul> <li>\u52a0\u2f0a\u65b0\u7684\u5b57\u6bb5\u5f88\u5bb9\u6613(\u5fc5\u8981\u65f6\u9700\u8981 <code>update_by_query</code>)</li> <li>\u66f4\u65b0\u5220\u9664\u5b57\u6bb5\u4e0d\u5141\u8bb8(\u9700\u8981 Reindex \u91cd\u5efa\u6570\u636e)</li> <li>\u6700\u597d\u80fd\u5bf9 <code>Mappings</code> \u52a0\u2f0a <code>Meta</code> \u4fe1\u606f\uff0c\u66f4\u597d\u7684\u8fdb\u2f8f\u7248\u672c\u7ba1\u7406</li> <li>\u53ef\u4ee5\u8003\u8651\u5c06 Mapping \u2f42\u4ef6\u4e0a\u4f20 git \u8fdb\u2f8f\u7ba1\u7406</li> </ul> </li> </ul>"},{"location":"chap7/6chap7_es_model_pra/#10","title":"10\u3001\u672c\u7ae0\u77e5\u8bc6\u70b9","text":"<ul> <li>\u6570\u636e\u5efa\u6a21\u5bf9\u4e8e\u529f\u80fd\u4e0e\u6027\u80fd\u2f84\u5173\u91cd\u8981\u3002 Mapping \u2f42\u6587\u4ef6\u9700\u8981\u8003\u8651\u52a0\u2f0a\u5165\u7248\u672c\u7ba1\u7406\u7406</li> <li>\u901a\u8fc7 2 \u4e2a\u4f8b\u5b50\uff0c\u4e86\u89e3\u5982\u4f55\u901a\u8fc7\u5efa\u6a21\uff0c\u63d0\u2fbc\u7cfb\u7edf\u7684\u6027\u80fd<ul> <li>\u4f7f\u2f64\u7528 Inner Object \u907f\u514d\u4e86\u4e86\u4f4e\u6027\u80fd\u7684\u6b63\u5219\u5339\u914d * \u4f7f\u2f64 Nested Object \u548c\u5c06 Dynamic Mapping \u8bbe\u4e3a Strict \u907f\u514d\u5b57\u6bb5\u6570\u91cf\u8fc7\u591a\u5e26\u6765\u7684\u95ee\u9898</li> </ul> </li> <li>\u901a\u8fc7 1 \u4e2a\u4f8b\u2f26\uff0c\u4e86\u89e3\u5982\u4f55\u901a\u8fc7\u5efa\u6a21\uff0c\u63d0\u2fbc\u805a\u5408\u7ed3\u679c\u7684\u51c6\u786e\u5ea6<ul> <li>\u8bbe\u7f6e Null Value</li> </ul> </li> </ul> <p>\u4e0d\u8fc7\u539f\u5219\u90fd\u662f\u4e00\u6837\uff0c\u4e0d\u7ba1\u7528\u4ec0\u4e48\u6570\u636e\u5e93\uff1a</p> <ul> <li>1\uff1a\u8981\u6ee1\u8db3\u529f\u80fd\u9700\u6c42</li> <li>2\uff1a\u5b58\u50a8\u6700\u5c0f\u5316</li> <li>3\uff1a\u6027\u80fd\u6700\u5927\u5316</li> </ul>"},{"location":"chap7/7chap7_es_sum2/","title":"\u7b2c\u4e03\u8282 \u7b2c\u4e8c\u90e8\u5206\u603b\u7ed3\u56de\u987e","text":""},{"location":"chap7/7chap7_es_sum2/#1","title":"1\u3001\u56de\u987e\u603b\u7ed3:\u641c\u7d22\u4e0e\u7b97\u5206","text":""},{"location":"chap7/7chap7_es_sum2/#1-1","title":"1-1 \u7ed3\u6784\u5316\u641c\u7d22\u4e0e\u2fae\u7ed3\u6784\u5316\u641c\u7d22","text":"<ul> <li>Term \u67e5\u8be2\u548c\u57fa\u4e8e\u5168\u2f42\u672c Match \u641c\u7d22\u7684\u533a\u522b</li> <li>\u5bf9\u4e8e\u9700\u8981\u505a\u7cbe\u786e\u5339\u914d\u7684\u5b57\u6bb5\uff0c\u9700\u8981\u505a\u805a\u5408\u5206\u6790\u7684\u5b57\u6bb5\uff0c\u5b57\u6bb5\u7c7b\u578b\u8bbe\u7f6e\u4e3a Keyword</li> </ul>"},{"location":"chap7/7chap7_es_sum2/#1-2-query-context-vs-filter-context","title":"1-2 Query Context v.s Filter Context","text":"<ul> <li>Filter Context \u53ef\u4ee5\u907f\u514d\u7b97\u5206\uff0c\u5e76\u4e14\u5229\u7528\u7f13\u5b58</li> <li>Bool \u67e5\u8be2\u4e2d Filter \u548c Must Not \u90fd\u5c5e\u4e8e Filter Context</li> </ul>"},{"location":"chap7/7chap7_es_sum2/#1-3","title":"1-3 \u641c\u7d22\u7684\u7b97\u5206","text":"<ul> <li>TF-IDF / \u5b57\u6bb5 Boosting</li> </ul>"},{"location":"chap7/7chap7_es_sum2/#1-4-multi-match","title":"1-4 \u5355\u5b57\u7b26\u4e32\u591a\u5b57\u6bb5\u67e5\u8be2:<code>multi-match</code>","text":"<ul> <li><code>Best_Field</code> / <code>Most_Fields</code> / <code>Cross_Field</code></li> </ul>"},{"location":"chap7/7chap7_es_sum2/#1-5","title":"1-5 \u63d0\u2fbc\u641c\u7d22\u7684\u76f8\u5173\u6027","text":"<ul> <li>\u591a\u8bed\u2f94:\u8bbe\u7f6e\u2f26\u5b57\u6bb5\u548c\u4e0d\u540c\u7684\u5206\u8bcd\u5668\u63d0\u5347\u641c\u7d22\u7684\u6548\u679c</li> <li>Search Template \u5206\u79bb\u4ee3\u7801\u903b\u8f91\u548c\u641c\u7d22 DSL</li> <li>\u591a\u6d4b\u8bd5\uff0c\u76d1\u63a7\u53ca\u5206\u6790\u2f64\u6237\u7684\u641c\u7d22\u8bed\u53e5\u548c\u641c\u7d22\u6548\u679c</li> </ul>"},{"location":"chap7/7chap7_es_sum2/#2","title":"2\u3001\u805a\u5408 / \u5206\u2eda","text":""},{"location":"chap7/7chap7_es_sum2/#2-1","title":"2-1 \u805a\u5408","text":"<p>Bucket / Metric / Pipeline</p>"},{"location":"chap7/7chap7_es_sum2/#2-2","title":"2-2 \u5206\u2eda","text":"<ul> <li>From &amp; Size / Search After / Scroll API</li> <li>\u8981\u907f\u514d\u6df1\u5ea6\u5206\u2eda\uff0c\u5bf9\u4e8e\u6570\u636e\u5bfc\u51fa\u7b49\u64cd\u4f5c\uff0c\u53ef\u4ee5\u4f7f\u2f64 Scroll API</li> </ul>"},{"location":"chap7/7chap7_es_sum2/#3elasticsearch","title":"3\u3001Elasticsearch \u7684\u5206\u5e03\u5f0f\u6a21\u578b","text":""},{"location":"chap7/7chap7_es_sum2/#3-1","title":"3-1 \u2f42\u6863\u7684\u5206\u5e03\u5f0f\u5b58\u50a8","text":"<p>\u2f42\u6863\u901a\u8fc7 hash \u7b97\u6cd5\uff0c route \u5e76\u5b58\u50a8\u5230\u76f8\u5e94\u7684\u5206\u2f5a</p>"},{"location":"chap7/7chap7_es_sum2/#3-2","title":"3-2 \u5206\u2f5a\u53ca\u5176\u5185\u90e8\u7684\u2f2f\u4f5c\u673a\u5236","text":"<p>Segment / Transaction Log / Refresh / Merge</p>"},{"location":"chap7/7chap7_es_sum2/#3-3","title":"3-3 \u5206\u5e03\u5f0f\u67e5\u8be2\u548c\u805a\u5408\u5206\u6790\u7684\u5185\u90e8\u673a\u5236","text":"<ul> <li><code>Query Then Fetch</code>\uff1a IDF \u4e0d\u662f\u57fa\u4e8e\u5168\u5c40\uff0c\u2f7d\u662f\u57fa\u4e8e\u5206\u2f5a\u8ba1\u7b97\uff0c\u56e0\u6b64\uff0c\u6570\u636e\u91cf\u5c11\u7684\u65f6\u5019\uff0c\u7b97\u5206\u4e0d\u4e0d\u51c6</li> <li>\u589e\u52a0 <code>\u201cshard_size\u201d</code> \u53ef\u4ee5\u63d0\u2fbc Terms \u805a\u5408\u7684\u7cbe\u51c6\u5ea6</li> </ul>"},{"location":"chap7/7chap7_es_sum2/#4","title":"4\u3001 \u6570\u636e\u5efa\u6a21\u53ca\u91cd\u8981\u6027","text":""},{"location":"chap7/7chap7_es_sum2/#4-1","title":"4-1 \u6570\u636e\u5efa\u6a21","text":"<ul> <li>ES \u5982\u4f55\u5904\u7406\u7ba1\u7406\u5173\u7cfb / \u6570\u636e\u5efa\u6a21\u7684\u5e38\u2ec5\u6b65\u9aa4 / \u5efa\u6a21\u7684\u6700\u4f73\u5b9e\u8df5</li> </ul>"},{"location":"chap7/7chap7_es_sum2/#4-2","title":"4-2 \u5efa\u6a21\u76f8\u5173\u7684\u2f2f\u5177","text":"<ul> <li>Index Template / Dynamic Template / Ingest Node / Update By Query / Reindex / Index Alias</li> </ul>"},{"location":"chap7/7chap7_es_sum2/#4-3","title":"4-3 \u6700\u4f73\u5b9e\u8df5","text":"<ul> <li>\u907f\u514d\u8fc7\u591a\u7684\u5b57\u6bb5 / \u907f\u514d wildcard \u67e5\u8be2 / \u5728 Mapping \u4e2d\u8bbe\u7f6e\u5408\u9002\u7684\u5b57\u6bb5</li> </ul>"},{"location":"chap7/7chap7_es_sum2/#5","title":"5\u3001\u6d4b\u8bd5","text":""},{"location":"chap7/7chap7_es_sum2/#5-1-match-query","title":"5-1 match query","text":"<pre><code>POST test/_search\n{\n  \"profile\": \"true\",\n  \"query\": {\n    \"match\": {\n      \"content\": \"Hello World\"\n    }\n  }\n}\n\nPOST test/_search\n{\n  \"profile\": \"true\",\n  \"query\": {\n    \"match\": {\n      \"content\": \"hello world\"\n    }\n  }\n}\n</code></pre> <p>Output:</p> <pre><code> \"max_score\" : 0.5753642,\n    \"hits\" : [\n      {\n        \"_index\" : \"test\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"1\",\n        \"_score\" : 0.5753642,\n        \"_source\" : {\n          \"content\" : \"Hello World\"\n        }\n      }\n    ]\n  },\n  \"profile\" : {\n    \"shards\" : [\n      {\n        \"id\" : \"[lTFD6qBCQ460xdW8XFgaIg][test][0]\",\n        \"searches\" : [\n          {\n            \"query\" : [\n              {\n                \"type\" : \"BooleanQuery\",\n                \"description\" : \"content:hello content:world\",\n...\n</code></pre> <ul> <li><code>match query</code> \u5bf9context\u8fdb\u884c\u5206\u8bcd\uff0cstandard \u5206\u8bcd\u5668\uff0c\u5206\u6210<code>content:hello content:world</code> </li> </ul>"},{"location":"chap7/7chap7_es_sum2/#5-2-contentkeyword","title":"5-2 content.keyword","text":"<pre><code>POST test/_search\n{\n  \"profile\": \"true\",\n  \"query\": {\n    \"match\": {\n      \"content.keyword\": \"Hello World\"\n    }\n  }\n}\n</code></pre> <p>Output: 200</p> <pre><code>\"max_score\" : 0.2876821,\n    \"hits\" : [\n      {\n        \"_index\" : \"test\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"1\",\n        \"_score\" : 0.2876821,\n        \"_source\" : {\n          \"content\" : \"Hello World\"\n        }\n      }\n    ]\n  },\n  \"profile\" : {\n    \"shards\" : [\n      {\n        \"id\" : \"[lTFD6qBCQ460xdW8XFgaIg][test][0]\",\n        \"searches\" : [\n          {\n            \"query\" : [\n              {\n                \"type\" : \"TermQuery\",\n                \"description\" : \"content.keyword:Hello World\",\n</code></pre> <p>\u81ea\u52a8\u8f6c\u5316\u6210 <code>\"type\" : \"TermQuery\"</code></p> <pre><code>POST test/_search\n{\n  \"profile\": \"true\",\n  \"query\": {\n    \"match\": {\n      \"content.keyword\": \"hello world\"\n    }\n  }\n}\n</code></pre> <p>output:  <code>\"value\" : 0</code></p> <p>\u539f\u56e0\uff1aTermQuery \u4e0d\u4f1a\u505a\u5206\u8bcd\u5904\u7406</p> <pre><code>\"hits\" : {\n    \"total\" : {\n      \"value\" : 0,\n      \"relation\" : \"eq\"\n    },\n    \"max_score\" : null,\n    \"hits\" : [ ]\n  },\n  \"profile\" : {\n    \"shards\" : [\n      {\n        \"id\" : \"[lTFD6qBCQ460xdW8XFgaIg][test][0]\",\n        \"searches\" : [\n          {\n            \"query\" : [\n              {\n                \"type\" : \"TermQuery\",\n                \"description\" : \"content.keyword:hello world\",\n</code></pre>"},{"location":"chap7/7chap7_es_sum2/#5-3-termquery","title":"5-3  TermQuery","text":"<pre><code>POST test/_search\n{\n  \"profile\": \"true\",\n  \"query\": {\n    \"term\": {\n      \"content\": \"Hello World\"\n    }\n  }\n}\n</code></pre> <p>Output:</p> <pre><code> \"hits\" : {\n    \"total\" : {\n      \"value\" : 0,\n      \"relation\" : \"eq\"\n    },\n    \"max_score\" : null,\n    \"hits\" : [ ]\n  },\n  \"profile\" : {\n    \"shards\" : [\n      {\n        \"id\" : \"[lTFD6qBCQ460xdW8XFgaIg][test][0]\",\n        \"searches\" : [\n          {\n            \"query\" : [\n              {\n                \"type\" : \"TermQuery\",\n                \"description\" : \"content:Hello World\",\n</code></pre> <p>output:  <code>\"value\" : 0</code></p> <p>\u539f\u56e0\uff1a</p> <ul> <li>TermQuery \u4e0d\u4f1a\u505a\u5206\u8bcd\u5904\u7406</li> <li><code>\"description\" : \"content:Hello World\",</code></li> <li>Context \u91cc\u9762\u662f <code>\"content:hello content:world\"</code></li> </ul> <pre><code>POST test/_search\n{\n  \"profile\": \"true\",\n  \"query\": {\n    \"term\": {\n      \"content\": \"hello world\"\n    }\n  }\n}\n</code></pre> <p>Output:</p> <pre><code>  \"hits\" : [ ]\n  },\n  \"profile\" : {\n    \"shards\" : [\n      {\n        \"id\" : \"[lTFD6qBCQ460xdW8XFgaIg][test][0]\",\n        \"searches\" : [\n          {\n            \"query\" : [\n              {\n                \"type\" : \"TermQuery\",\n                \"description\" : \"content:hello world\",\n</code></pre> <p>output:  <code>\"value\" : 0</code></p> <p>\u539f\u56e0\uff1a</p> <ul> <li>TermQuery \u4e0d\u4f1a\u505a\u5206\u8bcd\u5904\u7406</li> <li><code>\"description\" : \"content:hello world\",</code></li> <li>Context \u91cc\u9762\u662f <code>\"content:hello content:world\"</code></li> </ul>"},{"location":"chap7/7chap7_es_sum2/#5-3-termquery-contentkeyword","title":"5-3 <code>TermQuery content.keyword</code>","text":"<pre><code>POST test/_search\n{\n  \"profile\": \"true\",\n  \"query\": {\n    \"term\": {\n      \"content.keyword\": \"Hello World\"\n    }\n  }\n}\n</code></pre> <p>Output</p> <pre><code>\"hits\" : [\n      {\n        \"_index\" : \"test\",\n        \"_type\" : \"_doc\",\n        \"_id\" : \"1\",\n        \"_score\" : 0.2876821,\n        \"_source\" : {\n          \"content\" : \"Hello World\"\n        }\n      }\n    ]\n  },\n  \"profile\" : {\n    \"shards\" : [\n      {\n        \"id\" : \"[lTFD6qBCQ460xdW8XFgaIg][test][0]\",\n        \"searches\" : [\n          {\n            \"query\" : [\n              {\n                \"type\" : \"TermQuery\",\n                \"description\" : \"content.keyword:Hello World\",\n</code></pre>"},{"location":"chap7/7chap7_es_sum2/#6","title":"6\u3001\u6d4b\u8bd5","text":"<ol> <li>\u5224\u65ad\u9898:\u2f63\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u5bf9\u7d22\u5f15\u4f7f\u2f64 Index Alias \u662f\u2f00\u4e2a\u597d\u7684\u5b9e\u8df5 (Yes)</li> <li>\u5728 Terms \u805a\u5408\u5206\u6790\u4e2d\uff0c\u6709\u54ea\u4e9b\u2f45\u6cd5\u53ef\u4ee5\u63d0\u2fbc\u67e5\u8be2\u7684\u7cbe\u51c6\u5ea6<ul> <li>\u6570\u636e\u91cf\u5c11\uff0c\u4e3b\u5206\u7247\u8bbe\u7f6e\u4e3a1</li> <li>\u6570\u636e\u91cf\u5927\uff0c\u67e5\u8be2\u8bbe\u7f6e<code>shard_size</code></li> </ul> </li> <li>\u5982\u4f55\u901a\u8fc7\u805a\u5408\u5206\u6790\u77e5\u9053\uff0c\u6bcf\u5929\u2f79\u7f51\u7ad9\u4e2d\u7684\u8bbf\u5ba2\u6765\u2f83\u591a\u5c11\u4e0d\u540c\u7684 IP<ul> <li>Cardinality: \u7c7b\u4f3c SQL \u4e2d\u7684 Distinct</li> </ul> </li> <li>\u8bf7\u63cf\u8ff0 <code>\u201cmulti_match</code>\u201d \u67e5\u8be2\u4e2d <code>\u201cbest_field\u201d</code>\u7684\u2f8f\u4e3a<ul> <li>\u8fd4\u56de\u5355\u5b57\u7b26\u4e32\u5728\u591a\u4e2a\u5b57\u6bb5\u7b97\u5206\u6700\u9ad8\u7684\u90a3\u4e2a\u5b57\u6bb5\u3002\u4f5c\u4e3a\u7b97\u5206\u7684\u7ed3\u679c\u8fd4\u56de</li> </ul> </li> <li>\u5bf9\u641c\u7d22\u7ed3\u679c\u5206\u2eda\u65f6\uff0c\u6240\u91c7\u2f64\u7684\u4e24\u4e2a\u53c2\u6570<ul> <li>From / Size </li> </ul> </li> <li>\u5224\u65ad\u9898:\u4f7f\u2f64  Scroll API \u5bfc\u51fa\u6570\u636e\u65f6\uff0c\u5373\u4f7f\u4e2d\u9014\u6709\u65b0\u7684\u6570\u636e\u5199\u2f0a\uff0c\u8fd9\u4e9b\u6570\u636e\u4e5f\u80fd\u88ab\u5bfc\u51fa (No)<ul> <li>Scroll API \u5bfc\u51fa\u6570\u636e\u5efa\u7acb\u5feb\u7167\uff0c\u65b0\u6570\u636e\u63d2\u5165\u4e0d\u4f1a\u5f71\u54cd\u5feb\u7167</li> </ul> </li> </ol>"},{"location":"chap8/1ES_cluster_IAM/","title":"\u7b2c\u4e00\u8282 \u96c6\u7fa4\u8eab\u4efd\u8ba4\u8bc1\u4e0e\u7528\u6237\u9274\u6743","text":"<ul> <li>\u5982\u4f55\u4e3a\u96c6\u7fa4\u542f\u7528X-Pack Security</li> <li>\u5982\u4f55\u4e3a\u5185\u7f6e\u7528\u6237\u8bbe\u7f6e\u5bc6\u7801</li> <li>\u8bbe\u7f6e Kibana\u4e0eElasticSearch\u901a\u4fe1\u9274\u6743</li> <li>\u4f7f\u7528\u5b89\u5168API\u521b\u5efa\u5bf9\u7279\u5b9a\u7d22\u5f15\u5177\u6709\u6709\u9650\u8bbf\u95ee\u6743\u9650\u7684\u7528\u6237</li> </ul> <p>This tutorial involves a single node cluster, but if you had multiple nodes, you would enable Elasticsearch security features on every node in the cluster and configure Transport Layer Security (TLS) for internode-communication, which is beyond the scope of this tutorial. By enabling single-node discovery, we are postponing the configuration of TLS. For example, add the following setting:</p> <p>discovery.type: single-node</p> <p>5700 \u4e07\u7528\u6237\u6570\u636e\u6cc4\u6f0f</p> <p></p> <p>1.08 \u4ebf\u6761\u6295\u6ce8\u4fe1\u606f\u6cc4\u6f0f</p> <p></p>"},{"location":"chap8/1ES_cluster_IAM/#1","title":"1\u3001\u539f\u56e0\u5206\u6790","text":"<ul> <li>Elasticsearch \u5728\u9ed8\u8ba4\u5b89\u88c5\u540e\uff0c\u4e0d\u63d0\u4f9b\u4efb\u4f55\u5f62\u5f0f\u7684\u5b89\u5168\u9632\u62a4</li> <li>\u9519\u8bef\u7684\u914d\u7f6e\u4fe1\u606f\u5bfc\u81f4\u516c\u7f51\u53ef\u4ee5\u8bbf\u95ee ES \u96c6\u7fa4</li> <li>\u5728 <code>elasticsearch.yml</code> \u6587\u4ef6\u4e2d\uff0c <code>server.host</code> \u88ab\u9519\u8bef\u7684\u914d\u7f6e\u4e3a <code>0.0.0.0</code></li> </ul>"},{"location":"chap8/1ES_cluster_IAM/#2","title":"2\u3001\u6570\u636e\u5b89\u5168\u6027\u7684\u57fa\u672c\u9700\u6c42","text":"<ul> <li>\u8eab\u4efd\u8ba4\u8bc1<ul> <li>\u9274\u5b9a\u7528\u6237\u662f\u5426\u5408\u6cd5</li> </ul> </li> <li>\u7528\u6237\u9274\u6743<ul> <li>\u6307\u5b9a\u90a3\u4e2a\u7528\u6237\u53ef\u4ee5\u8bbf\u95ee\u54ea\u4e2a\u7d22\u5f15</li> </ul> </li> <li>\u4f20\u8f93\u52a0\u5bc6 </li> <li>\u65e5\u5fd7\u5ba1\u8ba1</li> </ul>"},{"location":"chap8/1ES_cluster_IAM/#3","title":"3\u3001\u4e00\u4e9b\u514d\u8d39\u7684\u65b9\u6848","text":"<ul> <li>\u8bbe\u7f6e Nginx \u53cd\u5411\u4ee3\u7406</li> <li>\u5b89\u88c5\u514d\u8d39\u7684 Security \u63d2\u4ef6<ul> <li>Search Guard - https://search-guard.com/</li> <li>ReadOnly REST - https://github.com/sscarduzio/elasticsearch-readonlyrest-plugin</li> </ul> </li> <li>X-Pack \u7684 Basic \u7248<ul> <li>\u4ece ES 6.8 &amp; ES 7.0 \u5f00\u59cb\uff0cSecurity \u7eb3\u5165 x-pack \u7684 Basic \u7248\u672c\u4e2d\uff0c\u514d\u8d39\u4f7f\u7528\u4e00\u4e9b\u57fa\u672c\u7684\u529f\u80fd</li> <li>https://www.elastic.co/what-is/elastic-stack-security</li> </ul> </li> </ul>"},{"location":"chap8/1ES_cluster_IAM/#4authentication-","title":"4\u3001Authentication - \u8eab\u4efd\u8ba4\u8bc1","text":"<ul> <li> <p>\u8ba4\u8bc1\u4f53\u7cfb\u7684\u51e0\u79cd\u7c7b\u578b</p> <ul> <li>\u63d0\u4f9b\u7528\u6237\u540d\u548c\u5bc6\u7801</li> <li>\u63d0\u4f9b\u79d8\u94a5\u6216 Kerberos \u7968\u636e</li> </ul> </li> <li> <p>Realms:X-Pack \u4e2d\u7684\u8ba4\u8bc1\u670d\u52a1</p> <ul> <li>\u5185\u7f6e Realms (\u514d\u8d39)<ul> <li>File / Native(\u7528\u6237\u540d\u5bc6\u7801\u4fdd\u5b58\u5728 Elasticsearch)</li> </ul> </li> <li>\u5916\u90e8 Realms (\u6536\u8d39)</li> </ul> </li> </ul>"},{"location":"chap8/1ES_cluster_IAM/#5rbac-","title":"5\u3001RBAC - \u7528\u6237\u9274\u6743","text":"<ul> <li>\u4ec0\u4e48\u662f RBAC:Role Based Access Control\uff0c \u5b9a\u4e49\u4e00\u4e2a\u89d2\u8272\uff0c\u5e76\u5206\u914d\u4e00\u7ec4\u6743\u9650\u3002\u6743\u9650\u5305\u62ec\u7d22\u5f15 \u7ea7\uff0c\u5b57\u6bb5\u7ea7\uff0c\u96c6\u7fa4\u7ea7\u7684\u4e0d\u540c\u7684\u64cd\u4f5c\u3002\u7136\u540e\u901a\u8fc7\u5c06\u89d2\u8272\u5206\u914d\u7ed9\u7528\u6237\uff0c\u4f7f\u5f97\u7528\u6237\u62e5\u6709\u8fd9\u4e9b\u6743\u9650<ul> <li>User \u2014\u2014 The authenticated User</li> <li>Role \u2014\u2014 A named set of permission</li> <li>Permission \u2014\u2014 A set of one or more privileges against a secured resource</li> <li>Privilege \u2014\u2014 A named group of 1 or more actions that user may execute against a secured resource</li> </ul> </li> </ul>"},{"location":"chap8/1ES_cluster_IAM/#6privilege","title":"6\u3001Privilege","text":""},{"location":"chap8/1ES_cluster_IAM/#6-1-cluster-privileges","title":"6-1 Cluster Privileges","text":"<p>all / monitor / manager / <code>manage_index</code> / <code>manage_index_template</code> / <code>manage_rollup</code></p>"},{"location":"chap8/1ES_cluster_IAM/#6-2-indices-privileges","title":"6-2 Indices Privileges","text":"<p>all / create / <code>create_index</code> / delete / <code>delete_index</code> / index / manage / read /write /<code>view_index_metadata</code></p>"},{"location":"chap8/1ES_cluster_IAM/#7","title":"7\u3001\u521b\u5efa\u5185\u7f6e\u7684\u7528\u6237\u548c\u89d2\u8272","text":"<p>\u5185\u7f6e\u7684\u89d2\u8272\u4e0e\u7528\u6237</p> <p></p>"},{"location":"chap8/1ES_cluster_IAM/#8-security-api","title":"8\u3001\u4f7f\u7528 Security API \u521b\u5efa\u7528\u6237","text":""},{"location":"chap8/1ES_cluster_IAM/#9-x-pack","title":"9\u3001\u5f00\u542f\u5e76\u914d\u7f6e <code>X-Pack</code> \u7684\u8ba4\u8bc1\u4e0e\u9274\u6743","text":""},{"location":"chap8/1ES_cluster_IAM/#9-1","title":"9-1 \u4fee\u6539\u914d\u7f6e\u6587\u4ef6\uff0c\u6253\u5f00\u8ba4\u8bc1\u4e0e\u6388\u6743","text":"<pre><code>bin/elasticsearch -E node.name=node0 -E cluster.name=geektime -E path.data=node0_data -E http.port=9200 -E xpack.security.enabled=true\n</code></pre> <p>\u65b0\u7248\u672c\u9700\u8981\u6253\u5f00SSL\uff1a <code>xpack.security.transport.ssl.enabled=true</code></p> <pre><code>elasticsearch -E node.name=node0 -E cluster.name=jx -E path.data=node0_data -E http.port=9200 -E xpack.security.enabled=true -E xpack.security.transport.ssl.enabled=true \n</code></pre> <p>\u4f7f\u7528Curl\u8bbf\u95eeES\uff0c\u6216\u8005\u6d4f\u89c8\u5668\u8bbf\u95ee <code>\u201clocalhost:9200/_cat/nodes?pretty\u201d</code>\u3002\u8fd4\u56de401\u9519\u8bef</p> <p><code>curl 'localhost:9200/_cat/nodes?pretty'</code></p>"},{"location":"chap8/1ES_cluster_IAM/#9-2","title":"9-2 \u521b\u5efa\u9ed8\u8ba4\u7684\u7528\u6237\u548c\u5206\u7ec4","text":"<pre><code>cd /usr/share/elasticsearch/\nbin/elasticsearch-setup-passwords interactive\n</code></pre> <ul> <li>changeme</li> </ul> <pre><code>localhost:9200/_cat/nodes\n</code></pre> <ul> <li>elastic</li> <li>changeme</li> </ul>"},{"location":"chap8/1ES_cluster_IAM/#9-3-kibana","title":"9-3 \u5f53\u96c6\u7fa4\u5f00\u542f\u8eab\u4efd\u8ba4\u8bc1\u4e4b\u540e\uff0c\u914d\u7f6e Kibana","text":"<ul> <li>Demo<ul> <li>\u521b\u5efa\u4e00\u4e2a Role\uff0c\u914d\u7f6e\u4e3a\u5bf9\u67d0\u4e2a\u7d22\u5f15\u53ea\u8bfb\u6743\u9650 / \u521b\u5efa\u4e00\u4e2a\u7528\u6237\uff0c\u628a\u7528\u6237\u52a0\u5165 Role</li> </ul> </li> </ul>"},{"location":"chap8/1ES_cluster_IAM/#10-kibana","title":"10\u3001\u914d\u7f6e Kibana","text":"<p>\u4fee\u6539 kibana.yml</p> <pre><code># If your Elasticsearch is protected with basic authentication, these settings provide\n# the username and password that the Kibana server uses to perform maintenance on the Kibana\n# index at startup. Your Kibana users still need to authenticate with Elasticsearch, which\n# is proxied through the Kibana server.\n#elasticsearch.username: \"kibana_system\"\n#elasticsearch.password: \"pass\"\n</code></pre> <ul> <li><code>elasticsearch.username: \"kibana\"</code></li> <li><code>elasticsearch.password: \"changeme\"</code></li> </ul> <p><code>sudo vim /usr/share/kibana/config/kibana.yml</code></p> <p>\u540e\u53f0\u8fd0\u884c kibana</p> <pre><code>nohup kibana &amp;\n</code></pre> <pre><code>http://192.168.33.12:5601/\n#\u542f\u52a8\u3002\u4f7f\u7528\u7528\u6237\u540d\uff0celastic\uff0c\u5bc6\u7801elastic\uff0c\u7279\u6743\u8d26\u6237\n</code></pre> <pre><code>POST orders/_bulk\n{\"index\":{}}\n{\"product\" : \"1\",\"price\" : 18,\"payment\" : \"master\",\"card\" : \"9876543210123456\",\"name\" : \"jack\"}\n{\"index\":{}}\n{\"product\" : \"2\",\"price\" : 99,\"payment\" : \"visa\",\"card\" : \"1234567890123456\",\"name\" : \"bob\"}\n</code></pre> <p>\u4fe1\u606f\u4fe1\u606f\u4e2d\u5305\u542b\u654f\u611f\u4fe1\u606f\uff0c\u9700\u8981\u7ed9\u9650\u5236\u7279\u6b8a\u7528\u6237\u7684\u8bbf\u95ee\u6743\u9650</p>"},{"location":"chap8/1ES_cluster_IAM/#10-1-role","title":"10-1 \u521b\u5efa Role","text":"<ul> <li>create a new role named <code>read_only_orders</code>, that satisfies the following criteria:<ul> <li>The role has no cluster privileges</li> <li>The role only has access to indices that match the pattern <code>orders</code></li> <li>The index privileges are read, and <code>view_index_metadata</code></li> </ul> </li> </ul>"},{"location":"chap8/1ES_cluster_IAM/#10-2","title":"10-2 \u521b\u5efa\u7528\u6237","text":"<ul> <li>create <code>demo</code> user that satisfies the following criteria:<ul> <li>Use your own email address</li> <li>Assign the user to two roles: <code>read_only_orders</code> and <code>kibana_user</code></li> </ul> </li> </ul>"},{"location":"chap8/1ES_cluster_IAM/#10-3","title":"10-3 \u5220\u9664\u7d22\u5f15\u5931\u8d25","text":"<pre><code>#\u9a8c\u8bc1\u8bfb\u6743\u9650,\u53ef\u4ee5\u6267\u884c\nPOST orders/_search\n{}\n</code></pre> <pre><code>#\u9a8c\u8bc1\u5199\u6743\u9650,\u62a5\u9519\nPOST orders/_bulk\n{\"index\":{}}\n{\"product\" : \"1\",\"price\" : 18,\"payment\" : \"master\",\"card\" : \"9876543210123456\",\"name\" : \"jack\"}\n{\"index\":{}}\n{\"product\" : \"2\",\"price\" : 99,\"payment\" : \"visa\",\"card\" : \"1234567890123456\",\"name\" : \"bob\"}\n</code></pre>"},{"location":"chap8/1ES_cluster_IAM/#11","title":"11\u3001\u672c\u8282\u77e5\u8bc6\u70b9","text":"<ul> <li>\u4e3a\u4ec0\u4e48\u9700\u8981\u4fdd\u62a4 ES \u4e2d\u7684\u6570\u636e</li> <li>\u5982\u4f55\u4f7f\u7528 X-Pack Security \u4fdd\u62a4\u4f60\u7684\u6570\u636e</li> <li>Elasticsearch \u4e2d RBAC \u7684\u673a\u5236\u548c\u9ed8\u8ba4\u521b\u5efa\u7684\u7528\u6237\u548c\u89d2\u8272</li> <li>\u914d\u7f6e Elasticsearch \u548c Kibana \u5f00\u542f \u8eab\u4efd\u8ba4\u8bc1\u548c\u7528\u6237\u9274\u6743</li> <li>\u4f7f\u7528 Native Realm\uff0c\u901a\u8fc7 API \u548c Kibana \u7ba1\u7406\u7528\u6237\u5206\u7ec4\u548c\u6743\u9650</li> </ul> <p>https://www.elastic.co/guide/en/elasticsearch/reference/7.1/configuring-security.html</p>"},{"location":"chap8/2ES_cluster_enc_transit/","title":"\u7b2c\u4e8c\u8282 \u96c6\u7fa4\u5185\u90e8\u95f4\u7684\u5b89\u5168\u901a\u4fe1","text":""},{"location":"chap8/2ES_cluster_enc_transit/#1","title":"1\u3001\u4e3a\u4ec0\u4e48\u8981\u52a0\u5bc6\u901a\u8baf","text":"<ul> <li>\u52a0\u5bc6\u6570\u636e \u2013 \u907f\u514d\u6570\u636e\u6293\u5305\uff0c\u654f\u611f\u4fe1\u606f\u6cc4\u6f0f</li> <li>\u9a8c\u8bc1\u8eab\u4efd \u2013 \u907f\u514d Impostor Node<ul> <li>Data / Cluster State</li> </ul> </li> </ul>"},{"location":"chap8/2ES_cluster_enc_transit/#2","title":"2\u3001\u4e3a\u8282\u70b9\u521b\u5efa\u8bc1\u4e66","text":""},{"location":"chap8/2ES_cluster_enc_transit/#2-1-tls","title":"2-1 TLS","text":"<p>TLS \u534f\u8bae\u8981\u6c42 Trusted Certificate Authority(CA)\u7b7e\u53d1\u7684 X.509\u7684\u8bc1\u4e66</p>"},{"location":"chap8/2ES_cluster_enc_transit/#2-2","title":"2-2 \u8bc1\u4e66\u8ba4\u8bc1\u7684\u4e0d\u540c\u7ea7\u522b","text":"<ul> <li>Certificate \u2013 \u8282\u70b9\u52a0\u5165\u9700\u8981\u4f7f\u7528\u76f8\u540c CA \u7b7e\u53d1\u7684\u8bc1\u4e66</li> <li>Full Verification \u2013 \u8282\u70b9\u52a0\u5165\u96c6\u7fa4\u9700\u8981\u76f8\u540c CA \u7b7e\u53d1\u7684\u8bc1\u4e66\uff0c\u8fd8\u9700\u8981\u9a8c\u8bc1 Host name \u6216 IP \u5730\u5740</li> <li>No Verification \u2013 \u4efb\u4f55\u8282\u70b9\u90fd\u53ef\u4ee5\u52a0\u5165\uff0c\u5f00\u53d1\u73af\u5883\u4e2d\u7528\u4e8e\u8bca\u65ad\u76ee\u7684</li> </ul>"},{"location":"chap8/2ES_cluster_enc_transit/#3","title":"3\u3001\u751f\u6210\u8282\u70b9\u8bc1\u4e66","text":"<ul> <li><code>bin/elasticsearch-certutil ca</code></li> <li><code>bin/elasticsearch-certutil cert --ca elastic-stack-ca.p12</code></li> <li>https://www.elastic.co/guide/en/elasticsearch/reference/7.1/configuring-tls.html</li> </ul>"},{"location":"chap8/2ES_cluster_enc_transit/#4","title":"4\u3001\u914d\u7f6e\u8282\u70b9\u95f4\u901a\u8baf","text":"<ul> <li>\u751f\u6210\u8bc1\u4e66</li> <li>\u4e3a\u60a8\u7684Elasticearch\u96c6\u7fa4\u521b\u5efa\u4e00\u4e2a\u8bc1\u4e66\u9881\u53d1\u673a\u6784\u3002\u4f8b\u5982\uff0c\u4f7f\u7528elasticsearch-certutil ca\u547d\u4ee4\uff1a</li> </ul> <pre><code>$ bin/elasticsearch-certutil ca\nThis tool assists you in the generation of X.509 certificates and certificate\nsigning requests for use with SSL/TLS in the Elastic stack.\n\nThe 'ca' mode generates a new 'certificate authority'\nThis will create a new X.509 certificate and private key that can be used\nto sign certificate when running in 'cert' mode.\n\nUse the 'ca-dn' option if you wish to configure the 'distinguished name'\nof the certificate authority\n\nBy default the 'ca' mode produces a single PKCS#12 output file which holds:\n    * The CA certificate\n    * The CA's private key\n\nIf you elect to generate PEM format certificates (the -pem option), then the output will\nbe a zip file containing individual files for the CA certificate and private key\n\nPlease enter the desired output file [elastic-stack-ca.p12]: \nEnter password for elastic-stack-ca.p12 :\n</code></pre> <pre><code>$ ls | grep elastic-stack-ca\nelastic-stack-ca.p12\n</code></pre> <p>\u4e3a\u7fa4\u96c6\u4e2d\u7684\u6bcf\u4e2a\u8282\u70b9\u751f\u6210\u8bc1\u4e66\u548c\u79c1\u94a5\u3002\u4f8b\u5982\uff0c\u4f7f\u7528elasticsearch-certutil cert \u547d\u4ee4\uff1a</p> <pre><code>$ bin/elasticsearch-certutil cert --ca elastic-stack-ca.p12\n\n\n bin/elasticsearch-certutil cert --ca elastic-stack-ca.p12\nThis tool assists you in the generation of X.509 certificates and certificate\nsigning requests for use with SSL/TLS in the Elastic stack.\n\nThe 'cert' mode generates X.509 certificate and private keys.\n    * By default, this generates a single certificate and key for use\n       on a single instance.\n    * The '-multiple' option will prompt you to enter details for multiple\n       instances and will generate a certificate and key for each one\n    * The '-in' option allows for the certificate generation to be automated by describing\n       the details of each instance in a YAML file\n\n    * An instance is any piece of the Elastic Stack that requires an SSL certificate.\n      Depending on your configuration, Elasticsearch, Logstash, Kibana, and Beats\n      may all require a certificate and private key.\n    * The minimum required value for each instance is a name. This can simply be the\n      hostname, which will be used as the Common Name of the certificate. A full\n      distinguished name may also be used.\n    * A filename value may be required for each instance. This is necessary when the\n      name would result in an invalid file or directory name. The name provided here\n      is used as the directory name (within the zip) and the prefix for the key and\n      certificate files. The filename is required if you are prompted and the name\n      is not displayed in the prompt.\n    * IP addresses and DNS names are optional. Multiple values can be specified as a\n      comma separated string. If no IP addresses or DNS names are provided, you may\n      disable hostname verification in your SSL configuration.\n\n    * All certificates generated by this tool will be signed by a certificate authority (CA).\n    * The tool can automatically generate a new CA for you, or you can provide your own with the\n         -ca or -ca-cert command line options.\n\nBy default the 'cert' mode produces a single PKCS#12 output file which holds:\n    * The instance certificate\n    * The private key for the instance certificate\n    * The CA certificate\n\nIf you specify any of the following options:\n    * -pem (PEM formatted output)\n    * -keep-ca-key (retain generated CA key)\n    * -multiple (generate multiple certificates)\n    * -in (generate certificates from an input file)\nthen the output will be be a zip file containing individual certificate/key files\n\nEnter password for CA (elastic-stack-ca.p12) : \nPlease enter the desired output file [elastic-certificates.p12]: \nEnter password for elastic-certificates.p12 : \n\nCertificates written to /usr/share/elasticsearch/elastic-certificates.p12\n\nThis file should be properly secured as it contains the private key for \nyour instance.\n\nThis file is a self contained file and can be copied and used 'as is'\nFor each Elastic product that you wish to configure, you should copy\nthis '.p12' file to the relevant configuration directory\nand then follow the SSL configuration instructions in the product guide.\n\nFor client applications, you may only need to copy the CA certificate and\nconfigure the client to trust this certificate.\n</code></pre> <p>\u5c06\u8bc1\u4e66\u62f7\u8d1d\u5230 <code>/etc/elasticsearch/certs/</code> \u76ee\u5f55\u4e0b</p> <pre><code>cd /usr/share/elasticsearch\nmkdir /etc/elasticsearch/certs/\ncp elastic-stack-ca.p12 elastic-certificates.p12 /etc/elasticsearch/certs/\n</code></pre> <p><code>elasticsearch.yml</code> \u914d\u7f6e</p> <pre><code>xpack.security.transport.ssl.enabled: true\nxpack.security.transport.ssl.verification_mode: certificate\n\nxpack.security.transport.ssl.keystore.path: certs/elastic-certificates.p12\nxpack.security.transport.ssl.truststore.path: certs/elastic-certificates.p12\n</code></pre> <pre><code># ES \u542f\u7528 https\nelasticsearch -E node.name=node0 -E cluster.name=jx -E path.data=node0_data -E http.port=9200 -E xpack.security.enabled=true -E xpack.security.transport.ssl.enabled=true -E xpack.security.transport.ssl.verification_mode=certificate -E xpack.security.transport.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.http.ssl.enabled=true -E xpack.security.http.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.http.ssl.truststore.path=certs/elastic-certificates.p12\n\n\nelasticsearch -E node.name=node1 -E cluster.name=jx -E path.data=node0_data -E http.port=9201 -E xpack.security.enabled=true -E xpack.security.transport.ssl.enabled=true -E xpack.security.transport.ssl.verification_mode=certificate -E xpack.security.transport.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.http.ssl.enabled=true -E xpack.security.http.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.http.ssl.truststore.path=certs/elastic-certificates.p12\n\n</code></pre> <p>\u4e0d\u63d0\u4f9b\u8bc1\u4e66\u7684\u8282\u70b9\uff0c\u65e0\u6cd5\u52a0\u5165</p> <pre><code>bin/elasticsearch -E node.name=node2 -E cluster.name=geektime -E path.data=node2_data -E http.port=9202 -E xpack.security.enabled=true -E xpack.security.transport.ssl.enabled=true -E xpack.security.transport.ssl.verification_mode=certificate\n</code></pre>"},{"location":"chap8/2ES_cluster_enc_transit/#5","title":"5\u3001\u672c\u8282\u77e5\u8bc6\u70b9","text":"<ul> <li>\u4e3a\u4ec0\u4e48\u5185\u90e8\u901a\u4fe1\u9700\u8981\u52a0\u5bc6</li> <li>\u521b\u5efa Certificate Authority (CA)\u548c\u8282\u70b9\u7684 Certificates</li> <li>\u914d\u7f6e Elasticsearch\u8282\u70b9\u95f4\u901a\u4fe1\u52a0\u5bc6</li> </ul> <p>https://www.elastic.co/guide/en/elasticsearch/reference/current/configuring-tls.html</p>"},{"location":"chap8/3ES_cluster_out_sec/","title":"\u7b2c\u4e09\u8282 \u96c6\u7fa4\u4e0e\u5916\u90e8\u95f4\u7684\u5b89\u5168\u901a\u4fe1","text":""},{"location":"chap8/3ES_cluster_out_sec/#_2","title":"\u672c\u8282\u77e5\u8bc6\u70b9","text":"<ul> <li>\u4f7f\u7528 HTTPS \u7684\u91cd\u8981\u6027</li> <li>\u914d\u7f6e Elasticsearch</li> <li>\u914d\u7f6e Kibana<ul> <li>Kibana to Elasticsearch </li> <li>Browser to Kibana</li> </ul> </li> </ul>"},{"location":"chap8/3ES_cluster_out_sec/#1-https","title":"1\u3001\u4e3a\u4ec0\u4e48\u9700\u8981 HTTPS","text":""},{"location":"chap8/3ES_cluster_out_sec/#1-1-elasticsearch-for-https","title":"1-1\u3001\u914d\u7f6e Elasticsearch for HTTPS","text":"<pre><code>elasticsearch -E node.name=node0 -E cluster.name=jx -E path.data=node0_data -E http.port=9200 -E xpack.security.enabled=true -E xpack.security.transport.ssl.enabled=true -E xpack.security.transport.ssl.verification_mode=certificate -E xpack.security.transport.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.http.ssl.enabled=true -E xpack.security.http.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.http.ssl.truststore.path=certs/elastic-certificates.p12 -E xpack.security.authc.anonymous.username=true\n</code></pre> <p><code>https://192.168.33.12:9200/_cat/health?v</code></p>"},{"location":"chap8/3ES_cluster_out_sec/#2-kibana-es-https","title":"2\u3001\u914d\u7f6e Kibana \u8fde\u63a5 ES HTTPS","text":"<pre><code>sudo mkdir /usr/share/kibana/config/certs/ &amp;&amp; cd /usr/share/kibana/config/certs/\n\n# \u4e3akibana\u751f\u6210pem\nopenssl pkcs12 -in elastic-certificates.p12 -cacerts -nokeys -out elastic-ca.pem\n\n</code></pre> <pre><code>sudo vim /usr/share/kibana/config/kibana.yml\n\n\nelasticsearch.hosts: [\"https://localhost:9200\"]\nelasticsearch.ssl.certificateAuthorities: [ \"/usr/share/kibana/config/certs/elastic-ca.pem\" ]\nelasticsearch.ssl.verificationMode: certificate\n</code></pre> <p>\u540e\u53f0\u8fd0\u884c kibana</p> <pre><code>nohup kibana &amp;\n</code></pre> <pre><code>http://192.168.33.12:5601/\n</code></pre>"},{"location":"chap8/3ES_cluster_out_sec/#3-https-kibana","title":"3\u3001\u914d\u7f6e\u4f7f\u7528 HTTPS \u8bbf\u95ee Kibana","text":"<pre><code># \u4e3a Kibna \u914d\u7f6e HTTPS\n# \u751f\u6210\u540e\u89e3\u538b\uff0c\u5305\u542b\u4e86instance.crt \u548c instance.key\nbin/elasticsearch-certutil ca --pem\nsudo cp instance.crt instance.key /usr/share/kibana/config/certs/\n</code></pre> <pre><code>sudo vim /usr/share/kibana/config/kibana.yml\n\n\nserver.ssl.enabled: true\nserver.ssl.certificate: config/certs/instance.crt\nserver.ssl.key: config/certs/instance.key\n</code></pre> <p>\u540e\u53f0\u8fd0\u884c kibana</p> <pre><code>nohup kibana &amp;\n</code></pre> <pre><code>https://192.168.33.12:5601/\n</code></pre> <p>https://www.elastic.co/guide/en/elasticsearch/reference/current/configuring-tls.html#tls-http</p>"},{"location":"chap9/1ES_cluster_deploy/","title":"\u7b2c\u4e00\u8282 \u5e38\u89c1\u7684\u96c6\u7fa4\u90e8\u7f72\u65b9\u5f0f","text":""},{"location":"chap9/1ES_cluster_deploy/#1","title":"1\u3001\u8282\u70b9\u7c7b\u578b","text":"<ul> <li>\u4e0d\u540c\u89d2\u8272\u7684\u8282\u70b9<ul> <li>Master eligible / Data / Ingest / Coordinating / Machine Learning</li> </ul> </li> <li>\u5728\u5f00\u53d1\u73af\u5883\u4e2d\uff0c\u4e00\u4e2a\u8282\u70b9\u53ef\u627f\u62c5\u591a\u79cd\u89d2\u8272</li> <li>\u5728\u751f\u4ea7\u73af\u5883\u4e2d\uff0c<ul> <li>\u6839\u636e\u6570\u636e\u91cf\uff0c\u5199\u5165\u548c\u67e5\u8be2\u7684\u541e\u5410\u91cf\uff0c\u9009\u62e9\u5408\u9002\u7684\u90e8\u7f72\u65b9\u5f0f</li> <li>\u5efa\u8bae\u8bbe\u7f6e\u5355\u4e00\u89d2\u8272\u7684\u8282\u70b9(dedicated node)</li> </ul> </li> </ul>"},{"location":"chap9/1ES_cluster_deploy/#2","title":"2\u3001\u8282\u70b9\u53c2\u6570\u914d\u7f6e","text":"<p>\u4e00\u4e2a\u8282\u70b9\u5728\u9ed8\u8ba4\u60c5\u51b5\u4f1a\u4e0b\u540c\u65f6\u626e\u6f14: master eligible\uff0cdata node \u548c ingest node</p> <p></p>"},{"location":"chap9/1ES_cluster_deploy/#2-1","title":"2-1 \u5355\u4e00\u804c\u8d23\u7684\u8282\u70b9","text":"<p>\u4e00\u4e2a\u8282\u70b9\u53ea\u627f\u62c5\u4e00\u4e2a\u89d2\u8272</p> <p></p>"},{"location":"chap9/1ES_cluster_deploy/#2-2","title":"2-2 \u5355\u4e00\u89d2\u8272:\u804c\u8d23\u5206\u79bb\u7684\u597d\u5904","text":"<ul> <li>Dedicated master eligible nodes:\u8d1f\u8d23\u96c6\u7fa4\u72b6\u6001(cluster state)\u7684\u7ba1\u7406<ul> <li>\u4f7f\u7528\u4f4e\u914d\u7f6e\u7684 CPU\uff0cRAM \u548c\u78c1\u76d8</li> </ul> </li> <li>Dedicated data nodes: \u8d1f\u8d23\u6570\u636e\u5b58\u50a8\u53ca\u5904\u7406\u5ba2\u6237\u7aef\u8bf7\u6c42<ul> <li>\u4f7f\u7528\u9ad8\u914d\u7f6e\u7684 CPU, RAM \u548c\u78c1\u76d8</li> </ul> </li> <li>Dedicated ingest nodes:\u8d1f\u8d23\u6570\u636e\u5904\u7406<ul> <li>\u4f7f\u7528\u9ad8\u914d\u7f6e CPU;\u4e2d\u7b49\u914d\u7f6e\u7684RAM; \u4f4e\u914d\u7f6e\u7684\u78c1\u76d8</li> </ul> </li> </ul>"},{"location":"chap9/1ES_cluster_deploy/#2-3-dedicate-coordinating-only-node-client-node","title":"2-3 Dedicate Coordinating Only Node (Client Node)","text":"<ul> <li>\u914d\u7f6e:\u5c06 Master\uff0cData\uff0cIngest \u90fd\u914d\u7f6e\u6210 False<ul> <li>Medium/High CUP;</li> <li>Medium/High RAM;</li> <li>Low Disk</li> </ul> </li> <li>\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u5efa\u8bae\u4e3a\u4e00\u4e9b\u5927\u7684\u96c6\u7fa4\u914d\u7f6e Coordinating Only Nodes<ul> <li>\u626e\u6f14 Load Balancers\u3002\u964d\u4f4e Master \u548c Data Nodes \u7684\u8d1f\u8f7d</li> <li>\u8d1f\u8d23\u641c\u7d22\u7ed3\u679c\u7684 Gather/Reduce</li> <li>\u6709\u65f6\u5019\u65e0\u6cd5\u9884\u77e5\u5ba2\u6237\u7aef\u4f1a\u53d1\u9001\u600e\u4e48\u6837\u7684\u8bf7\u6c42<ul> <li>\u5927\u91cf\u5360\u7528\u5185\u5b58\u7684\u7ed3\u5408\u64cd\u4f5c\uff0c\u4e00\u4e2a\u6df1\u5ea6\u805a\u5408\u53ef\u80fd\u4f1a\u5f15\u53d1 OOM</li> </ul> </li> </ul> </li> </ul>"},{"location":"chap9/1ES_cluster_deploy/#2-4-dedicate-master-node","title":"2-4 Dedicate Master Node","text":"<p>\u4ece\u9ad8\u53ef\u7528 &amp; \u907f\u514d\u8111\u88c2\u7684\u89d2\u5ea6\u51fa\u53d1</p> <ul> <li>\u4e00\u822c\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u914d\u7f6e 3 \u53f0</li> <li>\u4e00\u4e2a\u96c6\u7fa4\u53ea\u6709 1 \u53f0\u6d3b\u8dc3\u7684\u4e3b\u8282\u70b9<ul> <li>\u8d1f\u8d23\u5206\u7247\u7ba1\u7406\uff0c\u7d22\u5f15\u521b\u5efa\uff0c\u96c6\u7fa4\u7ba1\u7406\u7b49\u64cd\u4f5c</li> </ul> </li> </ul> <p>\u5982\u679c\u548c\u6570\u636e\u8282\u70b9\u6216\u8005 Coordinate \u8282\u70b9\u6df7\u5408\u90e8\u7f72</p> <ul> <li>\u6570\u636e\u8282\u70b9\u76f8\u5bf9\u6709\u6bd4\u8f83\u5927\u7684\u5185\u5b58\u5360\u7528</li> <li>Coordinate \u8282\u70b9\u6709\u65f6\u5019\u53ef\u80fd\u4f1a\u6709\u5f00\u9500\u5f88\u9ad8\u7684\u67e5\u8be2\uff0c\u5bfc\u81f4 OOM</li> <li>\u8fd9\u4e9b\u90fd\u6709\u53ef\u80fd\u5f71\u54cd Master \u8282\u70b9\uff0c\u5bfc\u81f4\u96c6\u7fa4\u7684\u4e0d\u7a33\u5b9a</li> </ul>"},{"location":"chap9/1ES_cluster_deploy/#2-5","title":"2-5 \u57fa\u672c\u90e8\u7f72:\u589e\u52a0\u8282\u70b9\uff0c\u6c34\u5e73\u6269\u5c55","text":"<ul> <li>\u5f53\u78c1\u76d8\u5bb9\u91cf\u65e0\u6cd5\u6ee1\u8db3\u9700\u6c42\u65f6\uff0c\u53ef\u4ee5\u589e\u52a0\u6570\u636e\u8282\u70b9; </li> <li>\u78c1\u76d8\u8bfb\u5199\u538b\u529b\u5927\u65f6\uff0c\u589e\u52a0\u6570\u636e\u8282\u70b9</li> </ul>"},{"location":"chap9/1ES_cluster_deploy/#2-6-coordinating-only-node","title":"2-6 \u6c34\u5e73\u6269\u5c55:Coordinating Only Node","text":"<p>\u5f53\u7cfb\u7edf\u4e2d\u6709\u5927\u91cf\u7684\u590d\u6742\u67e5\u8be2\u53ca\u805a\u5408\u65f6\u5019\uff0c\u589e\u52a0 Coordinating \u8282\u70b9\uff0c\u589e\u52a0\u67e5\u8be2\u7684\u6027\u80fd</p> <p></p>"},{"location":"chap9/1ES_cluster_deploy/#2-7","title":"2-7 \u8bfb\u5199\u5206\u79bb","text":""},{"location":"chap9/1ES_cluster_deploy/#2-8-kibana","title":"2-8 \u5728\u96c6\u7fa4\u4e2d\u90e8\u7f72 Kibana","text":""},{"location":"chap9/1ES_cluster_deploy/#2-9","title":"2-9 \u5f02\u5730\u591a\u6d3b\u7684\u90e8\u7f72","text":"<p>\u96c6\u7fa4\u5904\u5728\u4e09\u4e2a\u6570\u636e\u4e2d\u5fc3;\u6570\u636e\u4e09\u5199;GTM \u5206\u53d1\u8bfb\u8bf7\u6c42</p> <p></p> <p>GTM Global Traffic Manager\uff0c\u4e00\u79cd\u8d1f\u8f7d\u5747\u8861</p>"},{"location":"chap9/1ES_cluster_deploy/#2-10-qa","title":"2-10 Q&amp;A","text":"<ul> <li>\u5982\u679c\u6709\u521b\u5efa\u7d22\u5f15\u7684\u8bf7\u6c42\u53d1\u9001\u5230\u4e86coordinating\u8282\u70b9\u4e0a\uff0c\u4f1a\u88abcoordinating\u8282\u70b9\u8f6c\u53d1\u5230master\u8282\u70b9\u4e0a\u4e48\uff1f</li> </ul> <p>\u7d22\u5f15\u7684\u521b\u5efa\uff0c\u90fd\u9700\u8981\u901a\u8fc7master\u8282\u70b9\u6267\u884c\u7684</p> <ul> <li>\u8bf7\u95eeES\u96c6\u7fa4\uff0c\u64cd\u4f5c\u7cfb\u7edf\u78c1\u76d8\u4f7f\u7528RAID5\u8fd8\u662fRAID0\uff0c\u6216\u8005\u88f8\u76d8\uff0c\u54ea\u4e2a\u6027\u80fd\u6700\u597d\uff1f</li> </ul> <p>\u7406\u8bba\u4e0a\u4e0d\u9700\u8981\u505araid\u3002 \u5b58\u50a8\u63a8\u8350\u4f7f\u7528ssd\uff0c\u5728warm\u8282\u70b9\u673a\u68b0\u76d8\u53ef\u4ee5\u8003\u8651\u3002\u7f51\u7edc\u5b58\u50a8\u4e0d\u63a8\u8350\u3002</p> <ul> <li>es\u8282\u70b9\u6309\u804c\u8d23\u5212\u5206\u540e\uff0ces\u5ba2\u6237\u7aef\u8fde\u63a5\u7684es\u8282\u70b9\u5217\u8868\u5e94\u8be5\u5982\u4f55\u914d\u7f6e\u5462\uff1f</li> </ul> <p>\u6211\u4eec\u662f\u901a\u8fc7\u5728\u8fd9\u4e9b\u8282\u70b9\u7684\u524d\u7aef\u8bbe\u7f6e\u4e00\u4e2a\u7528\u6765\u5199\u6570\u636e\u7684\u8d1f\u8f7d\u5747\u8861\uff0c\u4e00\u4e2a\u8bfb\u6570\u636e\u7684\u8d1f\u8f7d\u5747\u8861\u3002\u7136\u540e\u5c06\u6570\u636e\u7684\u8bfb\u5199\u903b\u8f91\u5206\u522b\u914d\u7f6e\u5230\u8fd9\u4e24\u4e2aloadbalancer\u4e0a</p> <ul> <li>elasticsearch\u8fd8\u6709GTM\u6765\u652f\u6301\u591a\u5199\u5417</li> </ul> <p>GTM\u4e3b\u8981\u7528\u6765\u505a\u6570\u636e\u7684\u8bfb\u53d6\u3002\u5728\u591a\u4e2adata center\u7684\u90e8\u7f72\u573a\u666f\u3002</p> <p>gtm\u80cc\u540e\u662f\u51e0\u4e2a\u76f8\u540c\u7684\u96c6\u7fa4\u3002\u8fd9\u51e0\u4e2a\u96c6\u7fa4\u9700\u8981\u786e\u4fdd\u6709\u76f8\u4f3c\u7684\u6570\u636e\u3002</p> <p>\u6240\u4ee5\uff0c\u4f60\u9700\u8981\u7a0b\u5e8f\u5206\u522b\u5199\u5165\u8fd9\u51e0\u4e2a\u96c6\u7fa4\uff0c\u4fdd\u6301\u6570\u636e\u4e00\u81f4\u3002\u6216\u8005\u5c31\u5199\u5165\u4e00\u4e2a\u96c6\u7fa4\uff0c\u4f7f\u7528es\u7684\u8de8\u96c6\u7fa4\u590d\u5236\u786e\u4fdd\u6570\u636e\u4e00\u81f4\u3002</p>"},{"location":"chap9/2ES_hot_warm/","title":"\u7b2c\u4e8c\u8282 Hot &amp; Warm \u67b6\u6784\u4e0e Shard Filtering","text":""},{"location":"chap9/2ES_hot_warm/#_1","title":"\u65e5\u5fd7\u7c7b\u5e94\u7528\u7684\u90e8\u7f72\u67b6\u6784","text":""},{"location":"chap9/2ES_hot_warm/#1-hot-warm-architecture","title":"1\u3001\u4ec0\u4e48\u662f Hot &amp; Warm Architecture","text":"<ul> <li>Hot &amp; Warm Architecture<ul> <li>\u6570\u636e\u901a\u5e38\u4e0d\u4f1a\u6709 Update \u64cd\u4f5c;</li> <li>\u9002\u7528\u4e8e Time based \u7d22\u5f15\u6570\u636e(\u751f\u547d\u5468\u671f\u7ba1\u7406)\uff0c\u540c\u65f6\u6570\u636e\u91cf\u6bd4\u8f83\u5927\u7684\u573a\u666f\u3002</li> <li>\u5f15\u5165 Warm \u8282\u70b9\uff0c\u4f4e\u914d\u7f6e\u5927\u5bb9\u91cf\u7684\u673a\u5668\u5b58\u653e\u8001\u6570\u636e\uff0c\u4ee5\u964d\u4f4e\u90e8\u7f72\u6210\u672c</li> </ul> </li> <li>\u4e24\u7c7b\u6570\u636e\u8282\u70b9, \u4e0d\u540c\u7684\u786c\u4ef6\u914d\u7f6e<ul> <li>Hot \u8282\u70b9(\u901a\u5e38\u4f7f\u7528 SSD):\u7d22\u5f15\u6709\u4e0d\u65ad\u6709\u65b0\u6587\u6863\u5199\u5165\u3002\u901a\u5e38\u4f7f\u7528 SSD</li> <li>Warm \u8282\u70b9(\u901a\u5e38\u4f7f\u7528 HDD):\u7d22\u5f15\u4e0d\u5b58\u5728\u65b0\u6570\u636e\u7684\u5199\u5165;\u540c\u65f6\u4e5f\u4e0d\u5b58\u5728\u5927\u91cf\u7684\u6570\u636e\u67e5\u8be2</li> </ul> </li> </ul>"},{"location":"chap9/2ES_hot_warm/#1-1-hot-nodes","title":"1-1 Hot Nodes","text":"<p>\u7528\u4e8e\u6570\u636e\u7684\u5199\u5165</p> <ul> <li>Indexing \u5bf9 CPU \u548c IO \u90fd\u6709\u5f88\u9ad8\u7684\u8981\u6c42\u3002\u6240\u4ee5\u9700\u8981\u4f7f\u7528\u9ad8\u914d\u7f6e\u7684\u673a\u5668</li> <li>\u5b58\u50a8\u7684\u6027\u80fd\u8981\u597d\u3002\u5efa\u8bae\u4f7f\u7528 SSD</li> </ul> <p></p>"},{"location":"chap9/2ES_hot_warm/#1-2-warm-nodes","title":"1-2 Warm Nodes","text":"<p>\u7528\u4e8e\u4fdd\u5b58\u53ea\u8bfb\u7684\u7d22\u5f15\uff0c\u6bd4\u8f83\u65e7\u7684\u6570\u636e</p> <ul> <li>\u901a\u5e38\u4f7f\u7528\u5927\u5bb9\u91cf\u7684\u78c1\u76d8(\u901a\u5e38\u662f Spinning Disks)</li> </ul> <p></p>"},{"location":"chap9/2ES_hot_warm/#1-3-hot-warm-architecture","title":"1-3 \u914d\u7f6e Hot &amp; Warm Architecture","text":"<p>\u4f7f\u7528 Shard Filtering\uff0c\u6b65\u9aa4\u5206\u4e3a\u4ee5\u4e0b\u51e0\u6b65</p> <ul> <li>\u6807\u8bb0\u8282\u70b9 (Tagging)</li> <li>\u914d\u7f6e\u7d22\u5f15\u5230 Hot Node</li> <li>\u914d\u7f6e\u7d22\u5f15\u5230 Warm \u8282\u70b9</li> </ul>"},{"location":"chap9/2ES_hot_warm/#1-4","title":"1-4 \u6807\u8bb0\u8282\u70b9","text":"<p>\u9700\u8981\u901a\u8fc7 \u201cnode.attr\u201d \u6765\u6807\u8bb0\u4e00\u4e2a\u8282\u70b9</p> <ul> <li>\u8282\u70b9\u7684 attribute\u53ef\u4ee5\u662f\u4efb\u4f55\u7684 key/value</li> <li>\u53ef\u4ee5\u901a\u8fc7 <code>elasticsearch.yml</code> \u6216\u8005\u901a\u8fc7 <code>\u2013E</code> \u547d\u4ee4\u6307\u5b9a</li> </ul> <p></p> <p></p> <p></p>"},{"location":"chap9/2ES_hot_warm/#1-5-hot","title":"1-5 \u914d\u7f6e Hot \u6570\u636e","text":"<p>\u521b\u5efa\u7d22\u5f15\u65f6\u5019\uff0c\u6307\u5b9a\u5c06\u5176\u521b\u5efa\u5728 hot \u8282\u70b9\u4e0a</p> <p></p> <p></p>"},{"location":"chap9/2ES_hot_warm/#1-6-warm","title":"1-6 \u65e7\u6570\u636e\u79fb\u52a8\u5230 Warm \u8282\u70b9","text":"<p><code>Index.routing.allocation</code> \u662f\u4e00\u4e2a\u7d22\u5f15\u7ea7\u7684 <code>dynamic setting</code>\uff0c\u53ef\u4ee5\u901a\u8fc7 <code>API</code> \u5728\u540e\u671f\u8fdb\u884c\u8bbe\u5b9a</p> <ul> <li>Curator / Index Life Cycle Management Tool</li> </ul> <p></p> <p></p> <pre><code>elasticsearch  -E node.name=hotnode -E cluster.name=jx -E path.data=node0_data -E node.attr.my_node_type=hot\n\nelasticsearch  -E node.name=warmnode -E cluster.name=jx -E path.data=node1_data -E node.attr.my_node_type=warm\n</code></pre> <p>\u4e3a\u5565\u4e0d\u662f<code>path.data=hot_data</code> &amp; <code>path.data=warm_data</code>\uff0c\u672c\u673a\u6ca1\u6709\u8fd9\u4e2a\u6587\u4ef6\u76ee\u5f55\uff0c\u4f1a\u5bfc\u81f4\u96c6\u7fa4\u542f\u52a8\u5931\u8d25</p> <pre><code> [hotnode] master not discovered yet, this node has not previously joined a bootstrapped (v7+) cluster, and this node must discover master-eligible nodes [127.0.0.1:9300] to bootstrap a cluster: have discovered [{hotnode}{nwTLh_enQW-VRDHbGWG_iw}{zdk5R2yATLSrZoYUNEWovQ}{172.16.72.169}{172.16.72.169:9300}{dilmrt}{ml.machine_memory=3973804032, xpack.installed=true, transform.node=true, ml.max_open_jobs=20, type=hot}, {warmnode}{pZBoP-5oQUSb8pWxfWXhlQ}{x5jk1e5CSAmg1C89iVMOMA}{172.16.72.169}{172.16.72.169:9301}{dilmrt}{ml.machine_memory=3973804032, ml.max_open_jobs=20, xpack.installed=true, type=warm, transform.node=true}]; discovery will continue using [127.0.0.1:9300, [::1]:9300, 192.168.33.12:9300] from hosts providers and [{hotnode}{nwTLh_enQW-VRDHbGWG_iw}{zdk5R2yATLSrZoYUNEWovQ}{172.16.72.169}{172.16.72.169:9300}{dilmrt}{ml.machine_memory=3973804032, xpack.installed=true, transform.node=true, ml.max_open_jobs=20, type=hot}] from last-known cluster state; node term 0, last-accepted version 0 in term 0\n</code></pre> <pre><code>http://192.168.33.12:9200/_cat/nodes?v\nip            heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name\n172.16.72.169           63          67   4    0.11    0.23     0.23 dilmrt    *      warmnode\n172.16.72.169           35          67   6    0.11    0.23     0.23 dilmrt    -      hotnode\n\n\nhttp://192.168.33.12:9200/_cat/health?v\nepoch      timestamp cluster status node.total node.data shards pri relo init unassign pending_tasks max_task_wait_time active_shards_percent\n1606191637 04:20:37  jx      green           2         2     24  12    0    0        0             0                  -                100.0%\n\nhttp://192.168.33.12:9200/_cat/nodeattrs?v\nnode     host          ip            attr              value\nwarmnode 172.16.72.169 172.16.72.169 ml.machine_memory 3973804032\nwarmnode 172.16.72.169 172.16.72.169 ml.max_open_jobs  20\nwarmnode 172.16.72.169 172.16.72.169 xpack.installed   true\nwarmnode 172.16.72.169 172.16.72.169 my_node_type      warm\nwarmnode 172.16.72.169 172.16.72.169 transform.node    true\nhotnode  172.16.72.169 172.16.72.169 ml.machine_memory 3973804032\nhotnode  172.16.72.169 172.16.72.169 ml.max_open_jobs  20\nhotnode  172.16.72.169 172.16.72.169 xpack.installed   true\nhotnode  172.16.72.169 172.16.72.169 my_node_type      hot\nhotnode  172.16.72.169 172.16.72.169 transform.node    true\n</code></pre> <pre><code># \u67e5\u770b\u8282\u70b9\nGET /_cat/nodeattrs?v\n\nwarmnode 172.16.72.169 172.16.72.169 my_node_type      warm\nhotnode  172.16.72.169 172.16.72.169 my_node_type      hot\n</code></pre> <pre><code># \u914d\u7f6e\u5230 Hot\u8282\u70b9\nPUT log-2020-11-02\n{\n  \"settings\":{\n    \"number_of_shards\":2,\n    \"number_of_replicas\":0,\n    \"index.routing.allocation.require.my_node_type\":\"hot\"\n  }\n}\n\n\nPUT my_index1/_doc/1\n{\n  \"key\":\"value\"\n}\n\nGET _cat/shards?v\n\nlog-2020-11-02                 1     p      STARTED     0    208b 172.16.72.169 hotnode\nlog-2020-11-02                 0     p      STARTED     0    208b 172.16.72.169 hotnode\n</code></pre> <pre><code># \u914d\u7f6e\u5230 warm \u8282\u70b9\nPUT log-2020-11-02/_settings\n{  \n  \"index.routing.allocation.require.my_node_type\":\"warm\"\n}\n\n\nGET _cat/shards?v\n\nlog-2020-11-02                 1     p      STARTED     0    208b 172.16.72.169 warmnode\nlog-2020-11-02                 0     p      STARTED     0    208b 172.16.72.169 warmnode\n</code></pre>"},{"location":"chap9/2ES_hot_warm/#2rack-awareness","title":"2\u3001Rack Awareness","text":""},{"location":"chap9/2ES_hot_warm/#2-1-rack","title":"2-1 Rack","text":"<p>ES \u7684\u8282\u70b9\u53ef\u80fd\u5206\u5e03\u5728\u4e0d\u540c\u7684\u673a\u67b6</p> <ul> <li>\u5f53\u4e00\u4e2a\u673a\u67b6\u65ad\u7535\uff0c\u53ef\u80fd\u4f1a\u540c\u65f6\u4e22\u5931\u51e0\u4e2a\u8282\u70b9</li> <li>\u5982\u679c\u4e00\u4e2a\u7d22\u5f15\u76f8\u540c\u7684\u4e3b\u5206\u7247\u548c\u526f\u672c\u5206\u7247\uff0c\u540c\u65f6\u5728\u8fd9\u4e2a\u673a\u67b6\u4e0a\uff0c\u5c31\u6709\u53ef\u80fd\u5bfc\u81f4\u6570\u636e\u7684\u4e22\u5931</li> <li>\u901a\u8fc7 Rack Awareness \u7684\u673a\u5236\uff0c \u5c31\u53ef\u4ee5\u5c3d\u53ef\u80fd\u907f\u514d\u5c06\u540c\u4e00\u4e2a\u7d22\u5f15\u7684\u4e3b\u526f\u5206\u7247\u540c\u65f6\u5206\u914d\u5728\u4e00\u4e2a\u673a\u67b6\u7684\u8282\u70b9\u4e0a</li> </ul> <p></p>"},{"location":"chap9/2ES_hot_warm/#2-2-rack","title":"2-2 \u6807\u8bb0 Rack \u8282\u70b9 + \u914d\u7f6e\u96c6\u7fa4","text":"<p>\u6807\u8bb0\u4e00\u4e2a rack 1, rack2</p> <pre><code>elasticsearch  -E node.name=node1 -E cluster.name=jx -E path.data=node1_data -E node.attr.my_rack_id=rack1\n\nelasticsearch  -E node.name=node2 -E cluster.name=jx -E path.data=node2_data -E node.attr.my_rack_id=rack2\n\nPUT _cluster/settings\n{\n  \"persistent\": {\n    \"cluster.routing.allocation.awareness.attributes\": \"my_rack_id\"\n  }\n}\n</code></pre> <p>Output</p> <pre><code>{\n  \"acknowledged\" : true,\n  \"persistent\" : {\n    \"cluster\" : {\n      \"routing\" : {\n        \"allocation\" : {\n          \"awareness\" : {\n            \"attributes\" : \"my_rack_id\"\n          }\n        }\n      }\n    }\n  },\n  \"transient\" : { }\n}\n</code></pre> <pre><code>DELETE my_index1\n\nPUT my_index1\n{\n  \"settings\":{\n    \"number_of_shards\":2,\n    \"number_of_replicas\":1\n  }\n}\n\nPUT my_index1/_doc/1\n{\n  \"key\":\"value\"\n}\n</code></pre> <p>\u5206\u7247\u5206\u5230node1, node2</p> <pre><code>GET _cat/shards?v\n\nmy_index1                      1     r      STARTED     0    208b 172.16.72.169 node2\nmy_index1                      1     p      STARTED     0    208b 172.16.72.169 node1\nmy_index1                      0     p      STARTED     0    208b 172.16.72.169 node2\nmy_index1                      0     r      STARTED     0    208b 172.16.72.169 node1\n</code></pre>"},{"location":"chap9/2ES_hot_warm/#2-3-rack-awareness","title":"2-3 Rack Awareness","text":"<ul> <li>ES \u7684\u8282\u70b9\u53ef\u80fd\u5206\u5e03\u5728\u4e0d\u540c\u7684\u673a\u67b6 <ul> <li>\u4e00\u4e2a\u673a\u67b6\u65ad\u7535\uff0c\u6570\u636e\u53ef\u4ee5\u6062\u590d</li> </ul> </li> </ul> <pre><code># Force awareness\n# \u6807\u8bb0\u4e00\u4e2a rack 1\nelasticsearch  -E node.name=node1 -E cluster.name=jx -E path.data=node1_data -E node.attr.my_rack_id=rack1\n\n# \u6807\u8bb0\u4e00\u4e2a rack 1\nelasticsearch  -E node.name=node2 -E cluster.name=jx -E path.data=node2_data -E node.attr.my_rack_id=rack1\n</code></pre> <pre><code>PUT _cluster/settings\n{\n  \"persistent\": {\n    \"cluster.routing.allocation.awareness.attributes\": \"my_rack_id\",\n    \"cluster.routing.allocation.awareness.force.my_rack_id.values\": \"rack1,rack2\"\n  }\n}\n</code></pre> <pre><code>GET _cluster/settings\n</code></pre> <p>Output</p> <pre><code>{\n  \"acknowledged\" : true,\n  \"persistent\" : {\n    \"cluster\" : {\n      \"routing\" : {\n        \"allocation\" : {\n          \"awareness\" : {\n            \"attributes\" : \"my_rack_id\",\n            \"force\" : {\n              \"my_rack_id\" : {\n                \"values\" : \"rack1,rack2\"\n              }\n            }\n          }\n        }\n      }\n    }\n  },\n  \"transient\" : { }\n}\n</code></pre> <pre><code>PUT my_index1\n{\n  \"settings\":{\n    \"number_of_shards\":2,\n    \"number_of_replicas\":1\n  }\n}\n\nPUT my_index1/_doc/1\n{\n  \"key\":\"value\"\n}\n</code></pre> <pre><code># \u96c6\u7fa4\u9ec4\u8272\nGET _cluster/health\n</code></pre> <p>Output</p> <pre><code>  \"cluster_name\" : \"jx\",\n  \"status\" : \"yellow\",\n  \"timed_out\" : false,\n  \"number_of_nodes\" : 2,\n  \"number_of_data_nodes\" : 2,\n  \"active_primary_shards\" : 16,\n  \"active_shards\" : 28,\n  \"relocating_shards\" : 0,\n  \"initializing_shards\" : 0,\n  \"unassigned_shards\" : 2,\n  \"delayed_unassigned_shards\" : 0,\n  \"number_of_pending_tasks\" : 0,\n  \"number_of_in_flight_fetch\" : 0,\n  \"task_max_waiting_in_queue_millis\" : 0,\n  \"active_shards_percent_as_number\" : 93.33333333333333\n}\n</code></pre> <pre><code># \u526f\u672c\u65e0\u6cd5\u5206\u914d\nGET _cat/shards?v\n\n\nmy_index1                      1     p      STARTED        0    208b 172.16.72.169 node1\nmy_index1                      1     r      UNASSIGNED                             \nmy_index1                      0     p      STARTED        1   3.6kb 172.16.72.169 node2\nmy_index1                      0     r      UNASSIGNED   \n</code></pre> <pre><code>GET _cluster/allocation/explain?pretty\n</code></pre> <p>Output:</p> <pre><code>\"deciders\" : [\n        {\n          \"decider\" : \"awareness\",\n          \"decision\" : \"NO\",\n          \"explanation\" : \"there are too many copies of the shard allocated to nodes with attribute [my_rack_id], there are [2] total configured shard copies for this shard id and [2] total attribute values, expected the allocated shard count per attribute [2] to be less than or equal to the upper bound of the required number of shards per attribute [1]\"\n        }\n      ]\n</code></pre>"},{"location":"chap9/2ES_hot_warm/#3shard-filtering","title":"3\u3001Shard Filtering","text":"<p>Shard Filtering</p> <ul> <li><code>\u201cnode.attr\u201d</code> - \u6807\u8bb0\u8282\u70b9</li> <li><code>\u201cindex.routing.allocation\u201d</code> \u2013 \u5206\u914d\u7d22\u5f15\u5230\u8282\u70b9</li> </ul> <p></p>"},{"location":"chap9/2ES_hot_warm/#4qa","title":"4\u3001Q&amp;A","text":"<ul> <li>\u5728\u521b\u5efa\u6240\u4ee5\u65f6\uff0c\u5c06routing \u914d\u7f6e\u5230hot\u4e0a\u3002</li> <li>\u5728\u7d22\u5f15\u4e0d\u518d\u6709\u6570\u636e\u5199\u5165\u65f6\uff0c\u901a\u8fc7\u4fee\u6539 <code>routing.allocation</code>\u5230<code>warm</code>\uff0c\u5373\u53ef\u5206\u914d\u5230warm\u3002</li> <li>\u4ece\u5b9e\u9645\u751f\u4ea7\u73af\u5883\u4e0a\uff0c\u53ef\u4ee5\u8003\u8651\u521b\u5efa<code>index template</code> \u81ea\u52a8\u4e3a\u65b0\u7684\u7d22\u5f15\u6267\u884c<code>routing.allocation</code>\u3002\u53ef\u4ee5\u4f7f\u7528<code>ILM</code>\uff0c\u4e3awarm\u9636\u6bb5\u8bbe\u7f6e<code>routimg allocation</code>\uff0c\u5e76\u5c06<code>index</code>\u914d\u7f6e\u6210\u53ea\u8bfb\uff0c\u540c\u65f6\u505aforce merge\u7b49\u64cd\u4f5c\u3002</li> </ul>"},{"location":"chap9/3ES_shard_settings/","title":"\u7b2c\u4e09\u8282 \u5206\u7247\u8bbe\u5b9a\u53ca\u7ba1\u7406","text":""},{"location":"chap9/3ES_shard_settings/#1","title":"1\u3001\u5355\u4e2a\u5206\u7247","text":"<ul> <li>7.0 \u5f00\u59cb\uff0c\u65b0\u521b\u5efa\u4e00\u4e2a\u7d22\u5f15\u65f6\uff0c\u9ed8\u8ba4\u53ea\u6709\u4e00\u4e2a\u4e3b\u5206\u7247<ul> <li>\u5355\u4e2a\u5206\u7247\uff0c\u67e5\u8be2\u7b97\u5206\uff0c\u805a\u5408\u4e0d\u51c6\u7684\u95ee\u9898\u90fd\u53ef\u4ee5\u5f97\u4ee5\u907f\u514d</li> </ul> </li> <li>\u5355\u4e2a\u7d22\u5f15\uff0c\u5355\u4e2a\u5206\u7247\u65f6\u5019\uff0c\u96c6\u7fa4\u65e0\u6cd5\u5b9e\u73b0\u6c34\u5e73\u6269\u5c55<ul> <li>\u5373\u4f7f\u589e\u52a0\u65b0\u7684\u8282\u70b9\uff0c\u65e0\u6cd5\u5b9e\u73b0\u6c34\u5e73\u6269\u5c55</li> </ul> </li> </ul>"},{"location":"chap9/3ES_shard_settings/#2","title":"2\u3001\u4e24\u4e2a\u5206\u7247","text":"<p>\u96c6\u7fa4\u589e\u52a0\u4e00\u4e2a\u8282\u70b9\u540e\uff0cElasticsearch \u4f1a\u81ea\u52a8\u8fdb\u884c\u5206\u7247\u7684\u79fb\u52a8\uff0c\u4e5f\u53eb Shard Rebalancing</p> <p></p>"},{"location":"chap9/3ES_shard_settings/#3","title":"3\u3001\u5982\u4f55\u8bbe\u8ba1\u5206\u7247\u6570","text":"<ul> <li>\u5f53\u5206\u7247\u6570 &gt; \u8282\u70b9\u6570\u65f6<ul> <li>\u4e00\u65e6\u96c6\u7fa4\u4e2d\u6709\u65b0\u7684\u6570\u636e\u8282\u70b9\u52a0\u5165\uff0c\u5206\u7247\u5c31\u53ef\u4ee5\u81ea\u52a8\u8fdb\u884c\u5206\u914d</li> <li>\u5206\u7247\u5728\u91cd\u65b0\u5206\u914d\u65f6\uff0c\u7cfb\u7edf\u4e0d\u4f1a\u6709 downtime</li> </ul> </li> <li>\u591a\u5206\u7247\u7684\u597d\u5904:\u4e00\u4e2a\u7d22\u5f15\u5982\u679c\u5206\u5e03\u5728\u4e0d\u540c\u7684\u8282\u70b9\uff0c\u591a\u4e2a\u8282\u70b9\u53ef\u4ee5\u5e76\u884c\u6267\u884c<ul> <li>\u67e5\u8be2\u53ef\u4ee5\u5e76\u884c\u6267\u884c</li> <li>\u6570\u636e\u5199\u5165\u53ef\u4ee5\u5206\u6563\u5230\u591a\u4e2a\u673a\u5668</li> </ul> </li> </ul>"},{"location":"chap9/3ES_shard_settings/#3-1","title":"3-1 \u4e00\u4e9b\u4f8b\u5b50","text":"<p>\u6848\u4f8b1</p> <ul> <li>\u6bcf\u5929 1 GB \u7684\u6570\u636e\uff0c\u4e00\u4e2a\u7d22\u5f15\u4e00\u4e2a\u4e3b\u5206\u7247\uff0c\u4e00\u4e2a\u526f\u672c\u5206\u7247</li> <li>\u9700\u4fdd\u7559\u534a\u5e74\u7684\u6570\u636e\uff0c\u63a5\u8fd1 360 GB \u7684\u6570\u636e\u91cf \uff0c</li> </ul> <p>\u6848\u4f8b2</p> <ul> <li>5 \u4e2a\u4e0d\u540c\u7684\u65e5\u5fd7\uff0c\u6bcf\u5929\u521b\u5efa\u4e00\u4e2a\u65e5\u5fd7\u7d22\u5f15\u3002\u6bcf\u4e2a\u65e5\u5fd7\u7d22\u5f15\u521b\u5efa 10 \u4e2a\u4e3b\u5206\u7247</li> <li>\u4fdd\u7559\u534a\u5e74\u7684\u6570\u636e</li> <li><code>5*10*30*6=9000\u4e2a\u5206\u7247</code></li> </ul>"},{"location":"chap9/3ES_shard_settings/#4","title":"4\u3001\u5206\u7247\u8fc7\u591a\u6240\u5e26\u6765\u7684\u526f\u4f5c\u7528","text":"<ul> <li>Shard \u662f Elasticsearch \u5b9e\u73b0\u96c6\u7fa4\u6c34\u5e73\u6269\u5c55\u7684\u6700\u5c0f\u5355\u4f4d</li> <li>\u8fc7\u591a\u8bbe\u7f6e\u5206\u7247\u6570\u4f1a\u5e26\u6765\u4e00\u4e9b\u6f5c\u5728\u7684\u95ee\u9898<ul> <li>\u6bcf\u4e2a\u5206\u7247\u662f\u4e00\u4e2a Lucene \u7684 \u7d22\u5f15\uff0c\u4f1a\u4f7f\u7528\u673a\u5668\u7684\u8d44\u6e90\u3002\u8fc7\u591a\u7684\u5206\u7247\u4f1a\u5bfc\u81f4\u989d\u5916\u7684\u6027\u80fd\u5f00\u9500</li> <li>Lucene Indices / File descriptors / RAM / CPU</li> <li>\u6bcf\u6b21\u641c\u7d22\u7684\u8bf7\u6c42\uff0c\u9700\u8981\u4ece\u6bcf\u4e2a\u5206\u7247\u4e0a\u83b7\u53d6\u6570\u636e</li> <li>\u5206\u7247\u7684 Meta \u4fe1\u606f\u7531 Master \u8282\u70b9\u7ef4\u62a4\u3002\u8fc7\u591a\uff0c\u4f1a\u589e\u52a0\u7ba1\u7406\u7684\u8d1f\u62c5\u3002\u7ecf\u9a8c\u503c\uff0c\u63a7\u5236\u5206\u7247\u603b\u6570\u5728 10 W \u4ee5\u5185</li> </ul> </li> </ul>"},{"location":"chap9/3ES_shard_settings/#5","title":"5\u3001\u5982\u4f55\u786e\u5b9a\u4e3b\u5206\u7247\u6570","text":""},{"location":"chap9/3ES_shard_settings/#5-1","title":"5-1 \u4ece\u5b58\u50a8\u7684\u7269\u7406\u89d2\u5ea6\u770b","text":"<ul> <li>\u65e5\u5fd7\u7c7b\u5e94\u7528\uff0c\u5355\u4e2a\u5206\u7247\u4e0d\u8981\u5927\u4e8e 50 GB</li> <li>\u641c\u7d22\u7c7b\u5e94\u7528\uff0c\u5355\u4e2a\u5206\u7247\u4e0d\u8981\u8d85\u8fc720 GB</li> </ul>"},{"location":"chap9/3ES_shard_settings/#5-2","title":"5-2 \u4e3a\u4ec0\u4e48\u8981\u63a7\u5236\u5206\u7247\u5b58\u50a8\u5927\u5c0f","text":"<ul> <li>\u63d0\u9ad8 Update \u7684\u6027\u80fd</li> <li>Merge \u65f6\uff0c\u51cf\u5c11\u6240\u9700\u7684\u8d44\u6e90</li> <li>\u4e22\u5931\u8282\u70b9\u540e\uff0c\u5177\u5907\u66f4\u5feb\u7684\u6062\u590d\u901f\u5ea6 / \u4fbf\u4e8e\u5206\u7247\u5728\u96c6\u7fa4\u5185 Rebalancing</li> </ul>"},{"location":"chap9/3ES_shard_settings/#6","title":"6\u3001\u5982\u4f55\u786e\u5b9a\u526f\u672c\u5206\u7247\u6570","text":"<p>6-1 \u526f\u672c\u662f\u4e3b\u5206\u7247\u7684\u62f7\u8d1d</p> <ul> <li>\u63d0\u9ad8\u7cfb\u7edf\u53ef\u7528\u6027:\u76f8\u5e94\u67e5\u8be2\u8bf7\u6c42\uff0c\u9632\u6b62\u6570\u636e\u4e22\u5931</li> <li>\u9700\u8981\u5360\u7528\u548c\u4e3b\u5206\u7247\u4e00\u6837\u7684\u8d44\u6e90</li> </ul> <p>6-2 \u5bf9\u6027\u80fd\u7684\u5f71\u54cd</p> <ul> <li>\u526f\u672c\u4f1a\u964d\u4f4e\u6570\u636e\u7684\u7d22\u5f15\u901f\u5ea6:\u6709\u51e0\u4efd\u526f\u672c\u5c31\u4f1a\u6709\u51e0\u500d\u7684 CPU \u8d44\u6e90\u6d88\u8017\u5728\u7d22\u5f15\u4e0a</li> <li>\u4f1a\u51cf\u7f13\u5bf9\u4e3b\u5206\u7247\u7684\u67e5\u8be2\u538b\u529b\uff0c\u4f46\u662f\u4f1a\u6d88\u8017\u540c\u6837\u7684\u5185\u5b58\u8d44\u6e90<ul> <li>\u5982\u679c\u673a\u5668\u8d44\u6e90\u5145\u5206\uff0c\u63d0\u9ad8\u526f\u672c\u6570\uff0c\u53ef\u4ee5\u63d0\u9ad8\u6574\u4f53\u7684\u67e5\u8be2 QPS</li> </ul> </li> </ul>"},{"location":"chap9/3ES_shard_settings/#7","title":"7\u3001\u8c03\u6574\u5206\u7247\u603b\u6570\u8bbe\u5b9a\uff0c\u907f\u514d\u5206\u914d\u4e0d\u5747\u8861","text":"<p>ES \u7684\u5206\u7247\u7b56\u7565\u4f1a\u5c3d\u91cf\u4fdd\u8bc1\u8282\u70b9\u4e0a\u7684\u5206\u7247\u6570\u5927\u81f4\u76f8\u540c</p> <ul> <li>\u6269\u5bb9\u7684\u65b0\u8282\u70b9\u6ca1\u6709\u6570\u636e\uff0c\u5bfc\u81f4\u65b0\u7d22\u5f15\u96c6\u4e2d\u5728\u65b0\u7684\u8282\u70b9</li> <li>\u70ed\u70b9\u6570\u636e\u8fc7\u4e8e\u96c6\u4e2d\uff0c\u53ef\u80fd\u4f1a\u4ea7\u751f\u65b0\u80fd\u95ee\u9898</li> </ul> <p></p>"},{"location":"chap9/3ES_shard_settings/#8conclusion","title":"8\u3001Conclusion","text":"<ul> <li>\u5206\u7247\u7684\u8bbe\u8ba1\u4e0e\u7ba1\u7406\u2014\u2014\u5206\u7247\u662fES\u5b58\u50a8\u6570\u636e\u7684\u5730\u65b9\uff0c\u672c\u8d28\u662f\u4e00\u4e2alucene\u7684\u7d22\u5f15\uff0c\u5206\u7247\u662fES\u673a\u5668\u5b9e\u73b0\u6c34\u5e73\u6269\u5c55\u7684\u6700\u5c0f\u5355\u4f4d\uff0c\u7528\u5979\u6765\u5b58\u50a8\u6570\u636e\u5fc5\u7136\u4f1a\u6d88\u8017\u7cfb\u7edf\u7684\u6027\u80fd\uff0c\u5982\u679c\u5b58\u50a8\u7684\u6570\u636e\u8fc7\u5927\uff0c\u5219\u6027\u80fd\u5fc5\u7136\u4e0d\u4f73\u3002ES\u5b98\u65b9\u5efa\u8bae\u65e5\u5fd7\u5e94\u7528\u6700\u597d\u5c0f\u4e8e50G\uff0c\u641c\u7d22\u5e94\u7528\u6700\u597d\u5c0f\u4e8e20G\u3002</li> <li>\u5982\u679c\u53ea\u6709\u4e00\u4e2a\u5206\u7247\uff0c\u90a3ES\u5c31\u5931\u53bb\u4e86\u81ea\u52a8\u6c34\u5e73\u6269\u5c55\u7684\u80fd\u529b\uff0c\u5177\u4f53\u5e94\u8be5\u8bbe\u7f6e\u591a\u5c11\u5206\u7247\u6570\uff0c\u9700\u8981\u6839\u636e\u5b9e\u9645\u573a\u666f\u6765\u5b9a\uff0c\u4e00\u822c\u800c\u5df2\u5206\u7247\u6570\u5e94\u5927\u4e8e\u8282\u70b9\u6570\u3002</li> <li>\u53e6\u5916\uff0c\u5206\u7247\u53c8\u5206\u4e3a\u4e3b\u5206\u7247\u548c\u526f\u672c\uff0c\u4e3b\u5206\u7247\u63d0\u4f9b\u8bfb\u5199\u7684\u80fd\u529b\uff0c\u526f\u672c\u53ea\u63d0\u4f9b\u8bfb\u7684\u80fd\u529b\uff0c\u526f\u672c\u662fES\u96c6\u7fa4\u6570\u636e\u9ad8\u53ef\u9760\u6027\u7684\u57fa\u77f3\uff0c\u53e6\u5916\uff0c\u589e\u52a0\u526f\u672c\u4e5f\u80fd\u63d0\u9ad8\u96c6\u7fa4\u7684\u8bfb\u6027\u80fd\u3002</li> <li>\u5177\u4f53\u8bbe\u7f6e\u51e0\u4e2a\u4e3b\u5206\u7247\u9700\u8981\u505a\u5bb9\u91cf\u89c4\u5212\uff0c\u4e3b\u5206\u7247\u4e00\u65e6\u8bbe\u5b9a\uff0c\u5219\u4e0d\u80fd\u968f\u610f\u4fee\u6539\uff0c\u9664\u975e\u505areindex\uff0c\u4e3b\u5206\u7247\u6570\u662f\u6587\u6863\u8def\u7531\u7684\u5173\u952e\u53c2\u6570\uff0c\u6240\u4ee5\uff0c\u4e00\u65e6\u53d8\u5316\u5fc5\u7136\u9700\u8981reindex\u3002</li> </ul>"},{"location":"chap9/4ES_cluster_plan/","title":"\u7b2c\u56db\u8282 \u5982\u4f55\u5bf9\u96c6\u7fa4\u8fdb\u884c\u5bb9\u91cf\u89c4\u5212","text":""},{"location":"chap9/4ES_cluster_plan/#1","title":"1\u3001\u5bb9\u91cf\u89c4\u5212","text":"<p>\u4e00\u4e2a\u96c6\u7fa4\u603b\u5171\u9700\u8981\u591a\u5c11\u4e2a\u8282\u70b9? \u4e00\u4e2a\u7d22\u5f15\u9700\u8981\u8bbe\u7f6e\u51e0\u4e2a\u5206\u7247?</p> <ul> <li>\u89c4\u5212\u4e0a\u9700\u8981\u4fdd\u6301\u4e00\u5b9a\u7684\u4f59\u91cf\uff0c\u5f53\u8d1f\u8f7d\u51fa\u73b0\u6ce2\u52a8\uff0c\u8282\u70b9\u51fa\u73b0\u4e22\u5931\u65f6\uff0c\u8fd8\u80fd\u6b63\u5e38\u8fd0\u884c</li> </ul> <p>\u505a\u5bb9\u91cf\u89c4\u5212\u65f6\uff0c\u4e00\u4e9b\u9700\u8981\u8003\u8651\u7684\u56e0\u7d20</p> <ul> <li>\u673a\u5668\u7684\u8f6f\u786c\u4ef6\u914d\u7f6e</li> <li>\u5355\u6761\u6587\u6863\u7684\u5c3a\u5bf8 / \u6587\u6863\u7684\u603b\u6570\u636e\u91cf / \u7d22\u5f15\u7684\u603b\u6570\u636e\u91cf(Time base \u6570\u636e\u4fdd\u7559\u7684\u65f6\u95f4)/ \u526f\u672c\u5206\u7247\u6570</li> <li>\u6587\u6863\u662f\u5982\u4f55\u5199\u5165\u7684(Bulk\u7684\u5c3a\u5bf8)</li> <li>\u6587\u6863\u7684\u590d\u6742\u5ea6\uff0c\u6587\u6863\u662f\u5982\u4f55\u8fdb\u884c\u8bfb\u53d6\u7684(\u600e\u4e48\u6837\u7684\u67e5\u8be2\u548c\u805a\u5408)</li> </ul>"},{"location":"chap9/4ES_cluster_plan/#2","title":"2\u3001\u8bc4\u4f30\u4e1a\u52a1\u7684\u6027\u80fd\u9700\u6c42","text":""},{"location":"chap9/4ES_cluster_plan/#2-1","title":"2-1 \u6570\u636e\u541e\u5410\u53ca\u6027\u80fd\u9700\u6c42","text":"<ul> <li>\u6570\u636e\u5199\u5165\u7684\u541e\u5410\u91cf\uff0c\u6bcf\u79d2\u8981\u6c42\u5199\u5165\u591a\u5c11\u6570\u636e?</li> <li>\u67e5\u8be2\u7684\u541e\u5410\u91cf?</li> <li>\u5355\u6761\u67e5\u8be2\u53ef\u63a5\u53d7\u7684\u6700\u5927\u8fd4\u56de\u65f6\u95f4?</li> </ul>"},{"location":"chap9/4ES_cluster_plan/#2-2","title":"2-2  \u4e86\u89e3\u4f60\u7684\u6570\u636e","text":"<ul> <li>\u6570\u636e\u7684\u683c\u5f0f\u548c\u6570\u636e\u7684 Mapping</li> <li>\u5b9e\u9645\u7684\u67e5\u8be2\u548c\u805a\u5408\u957f\u7684\u662f\u4ec0\u4e48\u6837\u7684</li> </ul>"},{"location":"chap9/4ES_cluster_plan/#3","title":"3\u3001\u5e38\u89c1\u7528\u4f8b","text":"<p>\u641c\u7d22:\u56fa\u5b9a\u5927\u5c0f\u7684\u6570\u636e\u96c6</p> <p>\u641c\u7d22\u7684\u6570\u636e\u96c6\u589e\u957f\u76f8\u5bf9\u6bd4\u8f83\u7f13\u6162</p> <p>\u65e5\u5fd7:\u57fa\u4e8e\u65f6\u95f4\u5e8f\u5217\u7684\u6570\u636e</p> <ul> <li>\u4f7f\u7528 ES \u5b58\u653e\u65e5\u5fd7\u4e0e\u6027\u80fd\u6307\u6807\u3002\u6570\u636e\u6bcf\u5929\u4e0d\u65ad\u5199\u5165\uff0c\u589e\u957f\u901f\u5ea6\u8f83\u5feb</li> <li>\u7ed3\u5408 Warm Node \u505a\u6570\u636e\u7684\u8001\u5316\u5904\u7406</li> </ul>"},{"location":"chap9/4ES_cluster_plan/#4","title":"4\u3001\u786c\u4ef6\u914d\u7f6e","text":"<ul> <li>\u9009\u62e9\u5408\u7406\u7684\u786c\u4ef6\uff0c\u6570\u636e\u8282\u70b9\u5c3d\u53ef\u80fd\u4f7f\u7528 SSD</li> <li>\u641c\u7d22\u7b49\u6027\u80fd\u8981\u6c42\u9ad8\u7684\u573a\u666f\uff0c\u5efa\u8bae SSD<ul> <li>\u6309\u7167 1 :10 \u7684\u6bd4\u4f8b\u914d\u7f6e\u5185\u5b58\u548c\u786c\u76d8</li> </ul> </li> <li>\u65e5\u5fd7\u7c7b\u548c\u67e5\u8be2\u5e76\u53d1\u4f4e\u7684\u573a\u666f\uff0c\u53ef\u4ee5\u8003\u8651\u4f7f\u7528\u673a\u68b0\u786c\u76d8\u5b58\u50a8<ul> <li>\u6309\u7167 1:50 \u7684\u6bd4\u4f8b\u914d\u7f6e\u5185\u5b58\u548c\u786c\u76d8</li> </ul> </li> <li>\u5355\u8282\u70b9\u6570\u636e\u5efa\u8bae\u63a7\u5236\u5728 2 TB \u4ee5\u5185\uff0c\u6700\u5927\u4e0d\u5efa\u8bae\u8d85\u8fc7 5 TB</li> <li>JVM \u914d\u7f6e\u673a\u5668\u5185\u5b58\u7684\u4e00\u534a\uff0cJVM \u5185\u5b58\u914d\u7f6e\u4e0d\u5efa\u8bae\u8d85\u8fc7 32 G</li> </ul>"},{"location":"chap9/4ES_cluster_plan/#5","title":"5\u3001\u90e8\u7f72\u65b9\u5f0f","text":"<ul> <li>\u6309\u9700\u9009\u62e9\u5408\u7406\u7684\u90e8\u7f72\u65b9\u5f0f</li> <li>\u5982\u679c\u9700\u8981\u8003\u8651\u53ef\u9760\u6027\u9ad8\u53ef\u7528\uff0c\u5efa\u8bae\u90e8\u7f72 3 \u53f0 dedicated \u7684 Master \u8282\u70b9</li> <li>\u5982\u679c\u6709\u590d\u6742\u7684\u67e5\u8be2\u548c\u805a\u5408\uff0c\u5efa\u8bae\u8bbe\u7f6e Coordinating \u8282\u70b9</li> </ul>"},{"location":"chap9/4ES_cluster_plan/#6-1","title":"6\u3001\u5bb9\u91cf\u89c4\u5212\u6848\u4f8b 1: \u56fa\u5b9a\u5927\u5c0f\u7684\u6570\u636e\u96c6","text":"<ul> <li>\u4e00\u4e9b\u6848\u4f8b:\u5531\u7247\u4fe1\u606f\u5e93 / \u4ea7\u54c1\u4fe1\u606f</li> <li>\u4e00\u4e9b\u7279\u6027<ul> <li>\u88ab\u641c\u7d22\u7684\u6570\u636e\u96c6\u5f88\u5927\uff0c\u4f46\u662f\u589e\u957f\u76f8\u5bf9\u6bd4\u8f83\u6162(\u4e0d\u4f1a\u6709\u5927\u91cf\u7684\u5199\u5165)\u3002\u66f4\u5173\u5fc3\u641c\u7d22\u548c\u805a\u5408\u7684\u8bfb\u53d6\u6027\u80fd </li> <li>\u6570\u636e\u7684\u91cd\u8981\u6027\u4e0e\u65f6\u95f4\u8303\u56f4\u65e0\u5173\u3002\u5173\u6ce8\u7684\u662f\u641c\u7d22\u7684\u76f8\u5173\u5ea6</li> </ul> </li> <li>\u4f30\u7b97\u7d22\u5f15\u7684\u7684\u6570\u636e\u91cf\uff0c\u7136\u540e\u786e\u5b9a\u5206\u7247\u7684\u5927\u5c0f<ul> <li>\u5355\u4e2a\u5206\u7247\u7684\u6570\u636e\u4e0d\u8981\u8d85\u8fc7 20 GB</li> <li>\u53ef\u4ee5\u901a\u8fc7\u589e\u52a0\u526f\u672c\u5206\u7247\uff0c\u63d0\u9ad8\u67e5\u8be2\u7684\u541e\u5410\u91cf</li> </ul> </li> </ul>"},{"location":"chap9/4ES_cluster_plan/#7","title":"7\u3001\u62c6\u5206\u7d22\u5f15","text":"<ul> <li>\u5982\u679c\u4e1a\u52a1\u4e0a\u6709\u5927\u91cf\u7684\u67e5\u8be2\u662f\u57fa\u4e8e\u4e00\u4e2a\u5b57\u6bb5\u8fdb\u884c Filter\uff0c\u8be5\u5b57\u6bb5\u53c8\u662f\u4e00\u4e2a\u6570\u91cf\u6709\u9650\u7684\u679a\u4e3e\u503c<ul> <li>\u4f8b\u5982\u8ba2\u5355\u6240\u5728\u7684\u5730\u533a</li> </ul> </li> <li>\u5982\u679c\u5728\u5355\u4e2a\u7d22\u5f15\u6709\u5927\u91cf\u7684\u6570\u636e\uff0c\u53ef\u4ee5\u8003\u8651\u5c06\u7d22\u5f15\u62c6\u5206\u6210\u591a\u4e2a\u7d22\u5f15<ul> <li>\u67e5\u8be2\u6027\u80fd\u53ef\u4ee5\u5f97\u5230\u63d0\u9ad8</li> <li>\u5982\u679c\u8981\u5bf9\u591a\u4e2a\u7d22\u5f15\u8fdb\u884c\u67e5\u8be2\uff0c\u8fd8\u662f\u53ef\u4ee5\u5728\u67e5\u8be2\u4e2d\u6307\u5b9a\u591a\u4e2a\u7d22\u5f15\u5f97\u4ee5\u5b9e\u73b0</li> </ul> </li> <li>\u5982\u679c\u4e1a\u52a1\u4e0a\u6709\u5927\u91cf\u7684\u67e5\u8be2\u662f\u57fa\u4e8e\u4e00\u4e2a\u5b57\u6bb5\u8fdb\u884c Filter\uff0c\u8be5\u5b57\u6bb5\u6570\u503c\u5e76\u4e0d\u56fa\u5b9a<ul> <li>\u53ef\u4ee5\u542f\u7528 Routing \u529f\u80fd\uff0c\u6309\u7167 filter \u5b57\u6bb5\u7684\u503c\u5206\u5e03\u5230\u96c6\u7fa4\u4e2d\u4e0d\u540c\u7684 shard\uff0c</li> <li>\u964d\u4f4e\u67e5\u8be2\u65f6\u76f8\u5173\u7684 shard\uff0c \u63d0\u9ad8 CPU \u5229\u7528\u7387</li> </ul> </li> </ul>"},{"location":"chap9/4ES_cluster_plan/#8-2","title":"8\u3001\u5bb9\u91cf\u89c4\u5212\u6848\u4f8b 2: \u57fa\u4e8e\u65f6\u95f4\u5e8f\u5217\u7684\u6570\u636e","text":""},{"location":"chap9/4ES_cluster_plan/#8-1","title":"8-1 \u76f8\u5173\u7684\u7528\u6848","text":"<ul> <li>\u65e5\u5fd7/\u6307\u6807/\u5b89\u5168\u76f8\u5173\u7684Events</li> <li>\u8206\u60c5\u5206\u6790</li> </ul>"},{"location":"chap9/4ES_cluster_plan/#8-2_1","title":"8-2 \u4e00\u4e9b\u7279\u6027","text":"<ul> <li>\u6bcf\u6761\u6570\u636e\u90fd\u6709\u65f6\u95f4\u6233;\u6587\u6863\u57fa\u672c\u4e0d\u4f1a\u88ab\u66f4\u65b0(\u65e5\u5fd7\u548c\u6307\u6807\u6570\u636e)</li> <li>\u7528\u6237\u66f4\u591a\u7684\u4f1a\u67e5\u8be2\u8fd1\u671f\u7684\u6570\u636e;</li> <li>\u5bf9\u65e7\u7684\u6570\u636e\u67e5\u8be2\u76f8\u5bf9\u8f83\u5c11</li> <li>\u5bf9\u6570\u636e\u7684\u5199\u5165\u6027\u80fd\u8981\u6c42\u6bd4\u8f83\u9ad8</li> </ul>"},{"location":"chap9/4ES_cluster_plan/#9","title":"9\u3001\u521b\u5efa\u57fa\u4e8e\u65f6\u95f4\u5e8f\u5217\u7684\u7d22\u5f15","text":""},{"location":"chap9/4ES_cluster_plan/#9-1-time-based","title":"9-1 \u521b\u5efa time-based \u7d22\u5f15","text":"<ul> <li>\u5728\u7d22\u5f15\u7684\u540d\u5b57\u4e2d\u589e\u52a0\u65f6\u95f4\u4fe1\u606f</li> <li>\u7167\u6bcf\u5929/\u6bcf\u5468/\u6bcf\u6708\u7684\u65b9\u5f0f\u8fdb\u884c\u5212\u5206</li> </ul>"},{"location":"chap9/4ES_cluster_plan/#9-2","title":"9-2 \u5e26\u6765\u7684\u597d\u5904","text":"<ul> <li>\u66f4\u52a0\u5408\u7406\u7684\u7ec4\u7ec7\u7d22\u5f15\uff0c\u4f8b\u5982\u968f\u7740\u65f6\u95f4\u63a8\u79fb\uff0c\u4fbf\u4e8e\u5bf9\u7d22\u5f15\u505a\u7684\u8001\u5316\u5904\u7406<ul> <li>\u5229\u7528 Hot &amp; Warm Architecture</li> <li>\u5907\u4efd\u548c\u5220\u9664\u4ee5\u53ca\u5220\u9664\u7684\u6548\u7387\u9ad8\u3002( Delete By Query \u6267\u884c\u901f\u5ea6\u6162\uff0c\u5e95\u5c42\u4e0d\u4e5f\u4e0d\u4f1a\u7acb\u523b\u91ca\u653e\u7a7a\u95f4\uff0c\u800c Merge \u65f6\u53c8\u5f88\u6d88 \u8017\u8d44\u6e90)</li> </ul> </li> </ul>"},{"location":"chap9/4ES_cluster_plan/#10-date-math","title":"10\u3001\u5199\u5165\u65f6\u95f4\u5e8f\u5217\u7684\u6570\u636e:\u57fa\u4e8e Date Math \u7684\u65b9\u5f0f","text":"<ul> <li>\u5bb9\u6613\u4f7f\u7528</li> <li>\u5982\u679c\u65f6\u95f4\u53d1\u751f\u53d8\u5316\uff0c\u9700\u8981\u91cd\u65b0\u90e8\u7f72\u4ee3\u7801</li> </ul> <p>2019-08-01T00:00:00</p> <p></p> <pre><code># POST /&lt;logs-{now/d}/_search\nPOST /%3Clogs-%7Bnow%2Fd%7D%3E/_search\n</code></pre>"},{"location":"chap9/4ES_cluster_plan/#11-index-alias","title":"11\u3001\u5199\u5165\u65f6\u95f4\u5e8f\u5217\u7684\u6570\u636e \u2013 \u57fa\u4e8e Index Alias","text":"<p>Time-based \u7d22\u5f15</p> <ul> <li>\u521b\u5efa\u7d22\u5f15\uff0c\u6bcf\u5929/\u6bcf\u5468/\u6bcf\u6708</li> <li>\u5728\u7d22\u5f15\u7684\u540d\u5b57\u4e2d\u589e\u52a0\u65f6\u95f4\u4fe1\u606f</li> </ul> <p></p> <pre><code>PUT log-2020.11.24\nPUT log-2020.11.23\n\n\nPOST _aliases\n{\n  \"actions\": [\n    {\n      \"add\": {\n        \"index\": \"log-2020.11.24\",\n        \"alias\": \"logs_write\"\n      }\n    },\n    {\n      \"remove\": {\n        \"index\": \"log-2020.11.23\",\n        \"alias\": \"logs_write\"\n      }\n    }\n  ]\n}\n</code></pre> <pre><code># POST /&lt;logs-{now/d}/_search\nPOST /%3Clogs-%7Bnow%2Fd%7D%3E/_search\n\n# POST /&lt;logs-{now/w}/_search\nPOST /%3Clogs-%7Bnow%2Fw%7D%3E/_search\n</code></pre> <p>Output</p> <pre><code>{\n  \"took\" : 1,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 1,\n    \"successful\" : 1,\n    \"skipped\" : 0,\n    \"failed\" : 0\n  },\n</code></pre>"},{"location":"chap9/4ES_cluster_plan/#12","title":"12\u3001\u96c6\u7fa4\u6269\u5bb9","text":"<ul> <li>\u589e\u52a0 Coordinating / Ingest Node<ul> <li>\u89e3\u51b3 CPU \u548c \u5185\u5b58\u5f00\u9500\u7684\u95ee\u9898</li> </ul> </li> <li>\u589e\u52a0\u6570\u636e\u8282\u70b9<ul> <li>\u89e3\u51b3\u5b58\u50a8\u7684\u5bb9\u91cf\u7684\u95ee\u9898</li> <li>\u4e3a\u907f\u514d\u5206\u7247\u5206\u5e03\u4e0d\u5747\u7684\u95ee\u9898\uff0c\u8981\u63d0\u524d\u76d1\u63a7\u78c1\u76d8\u7a7a\u95f4\uff0c\u63d0\u524d\u6e05\u7406\u6570\u636e\u6216\u589e\u52a0\u8282\u70b9(70%)</li> </ul> </li> </ul>"},{"location":"chap9/4ES_cluster_plan/#13","title":"13\u3001\u672c\u8282\u77e5\u8bc6\u70b9","text":"<ul> <li>\u6839\u636e ES \u7684\u4f7f\u7528\u573a\u666f\uff0c\u5efa\u8bae\u5c06\u641c\u7d22\u7c7b\u548c\u65e5\u5fd7\u7c7b\u7684\u5e94\u7528\u90e8\u7f72\u5728\u4e0d\u540c\u7684 ES \u7fa4\u4e0a <ul> <li>\u53ef\u4ee5\u9488\u5bf9\u5199\u5165\u548c\u8bfb\u53d6\u505a\u4f18\u5316</li> </ul> </li> <li>\u6839\u636e\u573a\u666f\u9009\u62e9\u5408\u9002\u7684\u90e8\u7f72\u65b9\u5f0f</li> <li>\u786c\u4ef6\u914d\u7f6e\uff0c\u6570\u636e\u8282\u70b9\u63a8\u8350\u4f7f\u7528 SSD<ul> <li>\u5bf9\u4e8e\u65e5\u5fd7\u7c7b\u7684\u5e94\u7528\uff0c\u53ef\u4ee5\u9009\u62e9\u4f7f\u7528\u51b7\u70ed\u67b6\u6784</li> </ul> </li> <li> <p>\u7d22\u5f15\u7684\u8bbe\u8ba1\uff0c\u5206\u7247\u7684\u8bbe\u8ba1\u4e5f\u81f3\u5173\u91cd\u8981</p> <ul> <li>\u65f6\u95f4\u5e8f\u5217\u7684\u7d22\u5f15 / \u5355\u4e2a\u5206\u7247\u7684\u5c3a\u5bf8\uff0c\u641c\u7d22\u7c7b\u4fdd\u6301\u5728 20G \u4ee5\u5185\uff0c\u65e5\u5fd7\u7c7b\u4fdd\u6301\u5728 50 G\u4ee5\u5185</li> </ul> </li> <li> <p>\u57fa\u4e8etime-based index\u8bbe\u8ba1\u65e5\u5fd7\u7c7b\u5b58\u50a8\uff0c\u5047\u8bbe\u6309\u6708\u62c6\u5206index, \u5982<code>log_2020-01</code>\u3001<code>log_2020-02</code>, ES\u670d\u52a1\u7aef\uff08\u6216\u8005\u63d0\u4f9bAPI\uff09\u53ef\u4ee5\u914d\u7f6e\u81ea\u52a8\u5220\u9664\u7684\u5386\u53f2\u7684index\u5417\uff1f\u8fd8\u662f\u8bf4\u5e94\u7528\u5c42\u9700\u8981\u6309\u4fdd\u7559\u7684\u903b\u8f91\uff0c\u5b9a\u65f6\u53bb\u5220\u9664\u3002</p> </li> </ul> <p>\u53ef\u4ee5\u901a\u8fc7\u914d\u7f6eILM \u5b9a\u671f\u5220\u9664</p>"},{"location":"chap9/5ES_Cloud/","title":"\u7b2c\u4e94\u8282 \u4e91\u4e0a\u7ba1\u7406 Elasticsearch \u7684\u4e00\u4e9b\u65b9\u6cd5","text":""},{"location":"chap9/5ES_Cloud/#1-elasticsearch","title":"1\u3001\u5728\u79c1\u6709\u4e91\u4e0a\u7ba1\u7406 Elasticsearch \u7684\u4e00\u4e9b\u65b9\u6cd5","text":""},{"location":"chap9/5ES_Cloud/#1-1","title":"1-1 \u7ba1\u7406\u5355\u4e2a\u96c6\u7fa4","text":"<ul> <li>\u96c6\u7fa4\u5bb9\u91cf\u4e0d\u591f\u65f6\uff0c\u9700\u624b\u5de5\u589e\u52a0\u8282\u70b9</li> <li>\u6709\u8282\u70b9\u4e22\u5931\u65f6\uff0c\u624b\u5de5\u4fee\u590d\u6216\u66f4\u6362\u8282\u70b9<ul> <li>\u786e\u4fdd Rack Awareness</li> </ul> </li> <li>\u96c6\u7fa4\u7248\u672c\u5347\u7ea7;\u6570\u636e\u5907\u4efd;\u6eda\u52a8\u5347\u7ea7<ul> <li>\u5b8c\u5168\u624b\u52a8\uff0c\u7ba1\u7406\u6210\u672c\u9ad8</li> </ul> </li> </ul>"},{"location":"chap9/5ES_Cloud/#1-2-ece-elasticsearch","title":"1-2 ECE\uff0c\u5e2e\u52a9\u4f60\u7ba1\u7406\u591a\u4e2a Elasticsearch \u96c6\u7fa4","text":"<ul> <li>ECE \u2013 Elastic Cloud Enterprise<ul> <li>https://www.elastic.co/cn/products/ece</li> </ul> </li> <li>\u901a\u8fc7\u5355\u4e2a\u63a7\u5236\u53f0\uff0c\u7ba1\u7406\u591a\u4e2a\u96c6\u7fa4<ul> <li>\u652f\u6301\u4e0d\u540c\u65b9\u5f0f\u7684\u96c6\u7fa4\u90e8\u7f72(\u652f\u6301\u5404\u7c7b\u90e8\u7f72) / \u8de8\u6570\u636e\u4e2d\u5fc3 / \u90e8\u7f72 Anti Affinity</li> <li>\u7edf\u4e00\u76d1\u63a7\u6240\u6709\u96c6\u7fa4\u7684\u72b6\u6001</li> <li>\u56fe\u5f62\u5316\u64cd\u4f5c<ul> <li>\u589e\u52a0\u5220\u9664\u8282\u70b9</li> <li>\u5347\u7ea7\u96c6\u7fa4 / \u6eda\u52a8\u66f4\u65b0 / \u81ea\u52a8\u6570\u636e\u5907\u4efd</li> </ul> </li> </ul> </li> </ul>"},{"location":"chap9/5ES_Cloud/#1-3-kubernetes","title":"1-3 \u57fa\u4e8e Kubernetes \u7684\u65b9\u6848","text":"<ul> <li>\u57fa\u4e8e\u5bb9\u5668\u6280\u672f\uff0c\u4f7f\u7528 Operator \u6a21\u5f0f\u8fdb\u884c\u7f16\u6392\u7ba1\u7406</li> <li>\u914d\u7f6e\uff0c\u7ba1\u7406\u76d1\u63a7\u591a\u4e2a\u96c6\u7fa4</li> <li>\u652f\u6301Hot&amp;Warm</li> <li>\u6570\u636e\u5feb\u7167\u548c\u6062\u590d</li> </ul>"},{"location":"chap9/5ES_Cloud/#1-4-kubernetes-crd","title":"1-4 Kubernetes CRD","text":""},{"location":"chap9/5ES_Cloud/#1-5","title":"1-5 \u6784\u5efa\u81ea\u5df1\u7684\u7ba1\u7406\u7cfb\u7edf","text":"<p>\u57fa\u4e8e\u865a\u62df\u673a\u7684\u7f16\u6392\u7ba1\u7406\u65b9\u5f0f</p> <ul> <li>Puppet Infrastructure (Puppet / Elasticsearch Puppet Module / Foreman)</li> <li>Workflow based Provision &amp; Management</li> </ul> <p>\u57fa\u4e8e Kubernetes \u7684\u5bb9\u5668\u5316\u7f16\u6392\u7ba1\u7406\u65b9\u5f0f</p> <ul> <li>\u57fa\u4e8e Operator \u6a21\u5f0f</li> <li>Kubernetes - Customer Resource Definition</li> </ul>"},{"location":"chap9/5ES_Cloud/#1-6-elasticsearch-kubernetes","title":"1-6 \u5c06 Elasticsearch \u90e8\u7f72\u5728 Kubernetes","text":""},{"location":"chap9/5ES_Cloud/#1-7-kubernetes-operator","title":"1-7 \u4ec0\u4e48\u662f Kubernetes Operator \u6a21\u5f0f","text":""},{"location":"chap9/5ES_Cloud/#1-8-operator-sdk","title":"1-8 Operator SDK","text":"<p>https://github.com/operator-framework/operator-sdk</p> <p></p>"},{"location":"chap9/5ES_Cloud/#2-elasticsearch","title":"2\u3001\u5728\u516c\u6709\u4e91\u4e0a\u7ba1\u7406\u4e0e\u90e8\u7f72 Elasticsearch","text":""},{"location":"chap9/5ES_Cloud/#2-1-elastic-cloud","title":"2-1 Elastic Cloud","text":"<p>https://www.elastic.co/cloud/</p> <p></p> <p></p>"},{"location":"chap9/5ES_Cloud/#2-2-chrome-lang-english","title":"2-2 Chrome Lang: English","text":"<p>AWS + GCP</p> <p></p>"},{"location":"chap9/5ES_Cloud/#2-3-chrome-lang-chinese","title":"2-3 Chrome Lang: Chinese","text":"<p>Elastic Cloud\u2014\u2014\u6ce8\u518c\u8d26\u53f7\u53ef\u4ee5\u514d\u8d39\u8bd5\u752814\u5929\u54df\ud83d\ude04 \u4fee\u6539\u6d4f\u89c8\u5668\u7684\u8bed\u8a00\uff0c\u53ef\u4ee5\u73a9\u4e00\u4e0b\u963f\u91cc\u6216\u817e\u8baf\u7684\u4ea7\u54c1</p> <p>Aliyun + Tencent</p> <p>https://data.aliyun.com/product/elasticsearch</p> <p></p>"},{"location":"chap9/5ES_Cloud/#2-3","title":"2-3 \u7406\u89e3\u96c6\u7fa4\u7684\u914d\u7f6e","text":"<p>\u57fa\u4e8e\u865a\u62df\u673a\u7684\u7f16\u6392\u7ba1\u7406\u65b9\u5f0f</p> <ul> <li>Puppet Infrastructure (Puppet / Elasticsearch Puppet Module / Foreman)</li> <li>Workflow based Provision &amp; Management</li> </ul> <p>\u57fa\u4e8e Kubernetes \u7684\u5bb9\u5668\u5316\u7f16\u6392\u7ba1\u7406\u65b9\u5f0f</p> <ul> <li>\u57fa\u4e8e Operator \u6a21\u5f0f</li> <li>Kubernetes - Customer Resource Definition</li> </ul>"},{"location":"spl1/1spl_role_ad/","title":"1 Splunk Administration: Managing Users and Authentication","text":""},{"location":"spl1/1spl_role_ad/#working-with-roles-and-users","title":"Working with Roles and Users","text":""},{"location":"spl1/1spl_role_ad/#understanding-splunk-enterprise-security-framework","title":"Understanding Splunk Enterprise Security Framework","text":"<p>How Is Splunk Platform Secured?</p> <ul> <li>Role based acces</li> </ul> <p>Valid user account with one more roles is required to access Splunk</p> <ul> <li>Single sign-on</li> </ul> <p>Integrate with enterprise single sign on solutions</p> <ul> <li>Auditability</li> </ul> <p>Audited evens such as searches and configuration file  changes are indexed in <code>_audit</code> index</p>"},{"location":"spl1/1spl_role_ad/#additional-security-measures","title":"Additional Security Measures","text":"<ul> <li>Encrypted data flow</li> </ul> <p>Data travelling from Forwarders to Indexers are secured using SSL/TLS (can be disabled)</p> <ul> <li>Assurance of data integrity</li> </ul> <p>Data in Splunk indexes can be checked for tampering</p> <ul> <li>Authenticated cluster communication</li> </ul> <p>Data travelling between Splunk instances are secured through pass4symmkey</p>"},{"location":"spl1/1spl_role_ad/#how-the-data-flows-in-a-secure-environment","title":"How the data flows in a secure environment.","text":"<p>FIPS mode (Federal Information Processing Standard - FIPS 140-2) can be enabled</p> <p>That stands for federal information processing standard, FIPS 140\u20112. If you enable FIPS mode, Splunk automatically configures all security to comply with US Federal Government's security standards. Note that if you want to enable FIPS mode, you have to do it before you start Splunk Enterprise for the first time.</p>"},{"location":"spl1/1spl_role_ad/#understanding-splunk-roles","title":"Understanding Splunk Roles","text":"<ul> <li>A collection of permissions and capabilities that defines a user function</li> <li>Users can be assigned to one or more roles</li> <li>Permissions grant read or write access to Splunk knowledge objects</li> <li>Capabilities are actions that can be performed in Splunk</li> <li>Role ultimately determines what a user can do and cannot do (privileges)</li> </ul> <p>Examples of Capabilities</p> <ul> <li>Capability: Description<ul> <li>search: Lets a user perform searches</li> <li><code>schedule_search</code>: Lets a user schedule saved searches, create alerts</li> <li><code>edit_sourcetypes</code>: Lets a user edit sourcetypes</li> <li>rtsearch: Lets a user perform real-time searches</li> <li><code>license_edit</code>: Lets a user edit licenses</li> <li><code>admin_all_objects</code>: Lets a user modify any object in the system </li> </ul> </li> </ul> <p>Where Do the Roles Come From?</p> <p>Built-in roles</p> <p>Splunk ships with built-in roles with pre-defined capabilities. Examples: admin, power user </p> <p>Custom roles</p> <p>You can create one or more custom roles by selectively choosing capabilities</p> <p>Creating and Editing Roles</p> <ul> <li>Splunk Web</li> </ul> <p>Use Splunk Web interface to add and edit roles</p> <ul> <li>Configuration File</li> </ul>"},{"location":"spl1/1spl_role_ad/#splunk-built-in-roles","title":"Splunk Built-in Roles","text":"<ul> <li>admin</li> </ul> <p>Modify all Splunk objects</p> <ul> <li>power</li> </ul> <p>Create and edit shared knowledge objects</p> <ul> <li>user</li> </ul> <p>Create and edit own knowledge objects</p> <ul> <li><code>can_delete</code></li> </ul> <p>Delete events by keyword</p> <ul> <li><code>splunk-system-role</code></li> </ul> <p>Special role for system processes</p> <p>Viewing Default Capabilities Using Splunk Web</p> <p></p> <p>Viewing Default Capabilities Using Btool</p> <pre><code>/opt/splunk/bin$ ./splunk btool authorize list role_power\n\n[role_power]\n\ncumulativeRTSrchJobsQuota = 200\ncumulativeSrchJobsQuota = 100\nedit_sourcetypes = enabled\nedit_statsd_transforms = enabled\n</code></pre> <p>You can also view <code>$SPLUNK_HOME/etc/system/default/authorize.conf</code> to identify capabilities for the built-in roles</p> <p>Do not edit the capabilities of the built-in roles.</p>"},{"location":"spl1/1spl_role_ad/#create-a-user-with-built-in-roles","title":"Create a User with Built-in Roles","text":"<p>Creating a Local Splunk User</p> <ul> <li>Easiest way to create a user is to use Splunk Web</li> <li>The user must be assigned one or more roles (built-in or custom)</li> <li>By default the user will be created locally</li> <li>It is recommended to have a strong password</li> <li>In production environments, users typically are created in Enterprise Directories</li> </ul> <p>Creating Users Using Splunk Web</p> <p></p>"},{"location":"spl1/1spl_role_ad/#demo","title":"Demo","text":"<ul> <li>View built-in roles and capabilities</li> <li>Demo</li> <li>View built-in users</li> <li>Check native and inherited capabilities of a role</li> <li>Create a local Splunk user</li> <li>Search <code>_audit</code> index</li> </ul> <p>login with new created user</p> <p></p>"},{"location":"spl1/1spl_role_ad/#_audit-index","title":"<code>_audit</code> index","text":"<ul> <li><code>index = _audit</code></li> </ul> <p><code>_audit</code> is a special internal Spunk index that stores auditable events, such as users logging in, logging out, and making changes to configuration files.</p> <ul> <li> <p><code>index=_audit user=kjones</code></p> </li> <li> <p><code>index=_audit user=kjones action = \"login attempt\"</code></p> </li> </ul> <p></p> <p><code>duration</code></p> <ul> <li><code>index=_audit user=kjones | transaction startswith=\"login attempt\" endswith=\"logout\"</code></li> </ul> <p></p>"},{"location":"spl1/1spl_role_ad/#2-creating-a-custom-role","title":"2 Creating a Custom Role","text":""},{"location":"spl1/1spl_role_ad/#2-1-why-create-a-custom-role","title":"2-1 Why Create a Custom Role?","text":"<p>Four Reasons to Create a Custom Role</p> <ul> <li>Tweak default parameters</li> <li>Flexibility</li> <li>Index security</li> <li>Knowledge objects security</li> </ul> <p>You are able to restrict access to certain objects, such as search head apps, reports, dashboards, alerts, etc.</p> <p>Four Reasons to Create a Custom Role</p> <ul> <li>Configure granular capabilities without having to update default roles</li> </ul> <p>Splunk comes with default roles such as admin, power, user, <code>can_delete</code>, and system\u2011role. Stay away from <code>can_delete</code> and splunk\u2011system\u2011role.</p> <p>The factory roles: admin,power,user,can delete,splunk-system-role</p> <ul> <li>Tuning done in default roles will get overwritten upon Splunk upgrade</li> </ul> <p>You can view the default capabilities in <code>$SPLUNK_HOME/etc/system/default/authorize.conf</code></p> <p><code>accelerate_datamodel = enabled</code></p> <ul> <li>You can secure indexes by configuring srchIndexesAllowed</li> <li>You can secure knowledge objects such as reports and apps</li> </ul>"},{"location":"spl1/1spl_role_ad/#2-2-creating-a-custom-role-using-splunk-web","title":"2-2 Creating a Custom Role Using Splunk Web","text":"<p>Things You Need to Know before Creating a Custom Role</p> <ul> <li>Inheritance<ul> <li>Mean which role that this role that you're creating will inherit from. When you create a custom role, it is not uncommon to inherit from the default Splunk roles, such as user our power. When you inherit from a role, all capabilities of the role that you are inheriting from will be automatically available for this role that you're creating</li> </ul> </li> <li>Capabilities<ul> <li>Capabilities. In addition to inheriting the capabilities, you can add additional capabilities to the role. For example, in the earlier instance where I mentioned you can create an advanced power role and add <code>accelerate_datamodel</code> capability to it. This is the most important parameter for this custom role</li> </ul> </li> <li>Indexes that can be accessed<ul> <li>This parameter determines which indexes can be accessed by a user who belongs to this role</li> </ul> </li> <li>Default index<ul> <li>This is the index that will be searched</li> </ul> </li> <li>Search restrictions<ul> <li>You can add special search filters. For example, you can exclude certain indexes using search restrictions.</li> </ul> </li> <li>Resource configuration<ul> <li>You can configure resources such as disk space that can be used by a user in this role or the number of searches that are user in this role can run in parallel.</li> </ul> </li> </ul> <p>Creating a Custom Splunk Role</p> <p>Avoid inheriting <code>can_delete</code> role</p> <p></p> <p></p> <p>Important Resources Configuration</p> <ul> <li>Default App: The default workspace for users with  this role</li> <li>User search job limit: Number of searches a user with this role can run at the same time (default 3)</li> <li>Role search job limit: Total number of searches across all members of this role at the same time (default is unlimited)</li> <li>Disk space limit: Maximum disk space in mega bytes  used by the search jobs of a user with this role (default 100MB)</li> </ul>"},{"location":"spl1/1spl_role_ad/#2-3-creating-a-custom-role-using-configuration-files","title":"2-3 Creating a Custom Role Using Configuration Files","text":"<ul> <li><code>authentication.conf</code></li> </ul> <p>Define authentication system parameters such as LDAP settings. Map roles to LDAP groups</p> <ul> <li><code>authorize.conf</code></li> </ul> <p>Create new roles and edit capabilities of roles</p> <ul> <li><code>user-prefs.conf</code></li> </ul> <p>Specify the default app for a role, along with other UI specific parameters</p> <p>Adding a Role in authorize.conf</p> <p><code>$SPLUNK_HOME/etc/system/local/authorize.conf</code></p> <pre><code># Add new role for sales users\n\n[role_sales_user]\nimportRoles = user\nsrchIndexesAllowed = main,sales_trans,web_logs\nsrchIndexesDefault = sales_trans\nsrchJobsQuota = 5\n</code></pre> <p>Adding a Role in authorize.conf</p> <ul> <li><code>$SPLUNK_HOME/etc/system/local/authorize.conf</code></li> <li><code>$SPLUNK_HOME/etc/apps/auth_app/local/authorize.conf</code></li> </ul> <p>In a search-head cluster, the configuration files are deployed in 'default' directory</p> <ul> <li>In distributed env, place <code>authorize.conf</code> in Splunk search head</li> <li>Simply add a stanza for the role</li> <li>Restart Splunk to have the changes take effect</li> </ul> <p>Never edit <code>$SPLUNK_HOME/etc/system/default/authorize.conf</code>.  Instead use  <code>$SPLUNK_HOME/etc/system/local/authorize.conf</code></p> <p>Three Configuration Files</p>"},{"location":"spl1/1spl_role_ad/#2-4-understanding-inheritance","title":"2-4 Understanding Inheritance","text":"<p>Role Inheritance</p> <ul> <li>Inheritance</li> </ul> <p>A role can be based on other existing role(s)</p> <ul> <li>Capabilities</li> </ul> <p>A role automatically receives all capabilities and index access of the inherited role</p> <ul> <li>Restriction</li> </ul> <p>Inherited capabilities and index access cannot be removed</p> <p>Capabilities are always additive in nature. Users  who belong to multiple roles receive all capabilities from all their roles.</p> <p>Role Inheritance Example</p> <p>Inherited Capabilities Cannot Be Removed</p> <p><code>advanced_user</code> inherits from <code>support_user</code></p> <pre><code>[role_support_user]\nsrchIndexesAllowed = web_logs,app_logs\n\n[role_advanced_user]\nimportRoles = support_user\nsrchIndexesAllowed = db_logs\n</code></pre> <p>Effective capabilities of <code>advanced_user</code></p> <pre><code>[role_advanced_user]\nsrchIndexesAllowed = web_logs,app_logs,db_logs\n</code></pre>"},{"location":"spl1/1spl_role_ad/#2-5-adding-a-user-with-custom-role","title":"2-5 Adding a User with Custom Role","text":"<p>Navigate to Settings -&gt; Users to add a user</p> <p>Adding a LDAP User with Custom Role</p> <ul> <li>Map LDAP group to a Splunk role in authentication.conf</li> <li>Any user who belongs to a LDAP group gets all capabilities of the mapped Splunk role</li> <li>This is the typical setup in production environments</li> </ul> <p>LDAP Group Mapping</p> <p>LDAP Groups Are Mapped Using authentication.conf</p> <p><code>authentication.conf</code></p> <pre><code>[authentication]\nauthType = LDAP\n\nauthSettings = myLDAP\n\n[roleMap_myLDAP]\n\nsales_user = sales\n</code></pre> <pre><code>[role_sales_user]\nimportRoles = user\nsrchIndexesAllowed = main,sales_trans,web_logs\n\nsrchIndexesDefault = sales_trans\nsrchJobsQuota = 5\n</code></pre> <p>power and admin have 10 and 50 srchJobsQuota respectively</p>"},{"location":"spl1/1spl_role_ad/#2-6-demo","title":"2-6 Demo","text":"<ul> <li>Create a custom role using Splunk Web</li> <li>Create a custom role using authorize.conf</li> <li>Create a user with a custom role</li> <li>Troubleshoot user access issues</li> </ul> <p>take a look at the existing roles that are already there</p> <p></p> <p></p> <p>Inheritance</p> <ul> <li>Inheritance from user</li> </ul> <p></p> <ul> <li>Capabilities</li> </ul> <p></p> <p>Indexes, Restrictions, Resources set as default</p> <p></p> <p>The <code>sales_user</code> custom role has been created. Very simple and straightforward. Now let's see how we can create a custom role using configuration files</p> <pre><code>cd /Applications/Splunk/etc/system/local\n\nvi authorize.conf\n</code></pre> <pre><code>[role_finance_user]\ncumulativeRTSrchJobsQuota=0\ncumulativeSrchjobsQuota=0\nimportRoles = user\nsrchDiskQuota = 300\nsrchIndexesAllowed = summary\nschMaxfime = 8640000\n\n[role_sales_user]\ncumulativeRTSrchJobsQuota=0\ncumulativeSrchJobsQuota=0\nimportRoles = user\nschIndexesAllowed = sales_trans\nschIndexesDefault = sales_trans\nsrchMaxTime = 8640000\n\n# Role for web developers\n[role_web_user]\ncumulativeRTSrchJobsQuota= 0\ncumulativeSrchJobsQuota= 0\nimportRoles = user\nschIndexesAllowed = web_logs\nschIndexesDefault = web_logs\nsrchMaxTime = 8640000\n</code></pre> <p><code>srchMaxTime = 8640000</code></p> <p>This is the maximum amount of time a search can run for a user in this role.</p> <pre><code>$ cd /Applications/Splunk/bin\n$ ./splunk restart\n</code></pre> <p>You have the <code>web_user</code> role available. here Now as you can see, the default app is not showing up for <code>web_user</code>. That's because we did not update the <code>user\u2011prefs.conf</code>.</p> <pre><code>cd /etc/apps/user-prefs/local\n\n$ pwd\n\n/Applications/Splunk/etc/apps/user-prefs/local\n\n$ vi user-prefs.conf\n</code></pre> <pre><code>[role_finance_user]\ndefault_namespace = splunk_metrics_workspace\n\n[role_sales_user]\ndefault_namespace = search\n\n[role_web_user]\ndefault_namespace = search\n</code></pre> <pre><code>cd /Applications/Splunk/bin\n\n./splunk restart\n</code></pre> <p></p> <p></p> <p></p> <p>Sometimes the user reaches his disk quota and the searches won't even run. </p> <p>The searchers get queued until the old search jobs expire. To quickly determine this, you can use the rest command to call a particular REST API to list the current disk usage.</p> <pre><code>| rest services/admin/quota-usage\n</code></pre> <p></p> <pre><code>| rest services/admin/quota-usage | search title=jordanp\n</code></pre> <p></p>"},{"location":"spl1/1spl_role_ad/#3-configuring-splunk-authentication","title":"3 Configuring Splunk Authentication","text":""},{"location":"spl1/1spl_role_ad/#3-1-authentication-mechanisms","title":"3-1 Authentication Mechanisms","text":"<p>Authentication mechanisms are techniques by which Splunk authenticates a user. When a user logs in, Splunk needs to know if the user can be allowed to log in are not.</p> <ul> <li>Native (always on)</li> </ul> <p>That means it cannot be disabled, and this is for a good reason. If Splunk loses connectivity with the external LDAP server, how can you log in? Since native mechanism is always on, admin user will be able to log into Splunk.</p> <ul> <li>External LDAP </li> </ul> <p>Can integrate your Active Directory with Splunk for authentication purposes. </p> <ul> <li>SAML </li> </ul> <p>SAML stands for Security Assertion Markup Language. This is a very popular open standard that is used to assert security information via XML</p> <ul> <li>Scripted Authentication</li> </ul> <p>Can have your own authentication system authenticate users for you in Splunk.</p> <p>Splunk Native Authentication</p> <ul> <li>The default factory authentication mechanism (cannot be disabled)</li> <li>Users can be added, edited and deleted from Splunk Web</li> <li>Users are maintained in <code>$SPLUNK_HOME/etc/passwd</code> file</li> </ul> <p>If you come from UNIX administration background, this file should look a lot familiar to you. This is the file that's used to keep usernames and passwords in UNIX operating system. </p> <p>Users in Native Authentication System</p> <p></p>"},{"location":"spl1/1spl_role_ad/#3-2-creating-a-ldap-strategy","title":"3-2 Creating a LDAP Strategy","text":"<ul> <li>LDAP host and port number</li> <li>Bind credentials</li> <li>User base DN and group base DN</li> </ul> <p>User base DN basically means the area are the subtree within LDAP where the users are located. Group base DN is the same thing, but for groups.</p> <ul> <li>User-name and real-user-name attributes</li> <li>Group-name and static-member attributes</li> </ul> <p>How LDAP Authentication Works</p> <p></p> <p>Once you configure this and get it working, this configuration seldom changes.</p> <p>The user initiates login typically using username and password. The user generally connects to Splunk search head, which hosts the Splunk Web application. S</p> <p>plunk search head talks to the external LDAP server. It could be OpenLDAP or Active Directory. </p> <p>Note that the authentication happens on the Active Directory or LDAP server.</p> <p>Creating a LDAP Strategy</p> <p></p> <p></p> <ul> <li> <p>User base DN specifies the location of your LDAP users, specified by the DN of your user subtree. In this example, I have dc=example, dc=com. </p> </li> <li> <p>User base filter can be left blank if you do not have one.</p> </li> <li> <p>User name attribute is the attribute with which usernames are identified. Typically, it is UID. </p> </li> <li> <p>If you are using Active Directory, this could be sAMAccountName.</p> </li> <li> <p>The real name attribute is also important. In this case, it is cn</p> </li> </ul> <p></p> <p>Setting static group search filtering greatly improves LDAP performance</p>"},{"location":"spl1/1spl_role_ad/#3-3-mapping-ldap-groups-to-splunk-roles","title":"3-3 Mapping LDAP Groups to Splunk Roles","text":"<ul> <li>Splunk Web</li> </ul> <p>Map LDAP groups to Splunk roles using Splunk Web</p> <ul> <li>authentication.conf</li> </ul> <p>Map LDAP groups to Splunk roles using authentication.conf (placed in Splunk search heads)</p> <p></p> <p>Mapping LDAP Groups Using Conf File</p> <ul> <li><code>authentication.conf</code></li> </ul> <pre><code>[authentication]\nauthType = LDAP\nauthSettings = myLDAP\n\n\n[roleMap_myLDAP]\n# Map sales LDAP group to sales_user Splunk role\nsales_user = sales\n</code></pre> <p>For mapping LDAP groups into Splunk roles, the stanza is named <code>roleMap_authSettings</code>. There's one line that maps the LDAP group into Splunk role. </p> <ul> <li><code>authorization.conf</code></li> </ul> <pre><code># Creat sales_user Splunk role\n\n[role_sales_user]\nimportRoles = user\nsrchIndexesAllowed = main,sales_trans,web_logs\n\nsrchIndexesDefault = sales_trans\nsrchJobsQuota = 5\n</code></pre>"},{"location":"spl1/1spl_role_ad/#3-4-configuring-single-sign-on","title":"3-4 Configuring Single Sign On","text":"<p>Why Single Sign On ?</p> <ul> <li>No need to type in username/password</li> <li>No need to remember/renew passwords</li> <li>Faster login time means better user experience</li> <li>Avoids weak passwords</li> </ul> <p>How Single Sign On Works ?</p> <p></p> <p>Splunk search head connects to the identity provider such as Ping Identity or Azure AD for the authentication. The identity provider asserts the authentication by sending an XML document back to Splunk search head</p> <p>Enabling SAML</p> <p></p> <p>Things You Need to Know before Configuring Single Sign On</p> <ul> <li>A supported identity provider (Example: Ping identity, Azure AD, Okta)</li> <li>Role, realname and mail attributes</li> <li>Identity provider metadata file</li> <li>SSL certificate info</li> <li>Map SAML groups to Splunk roles</li> </ul>"},{"location":"spl1/1spl_role_ad/#3-5-implementing-multi-factor-authentication","title":"3-5 Implementing Multi-factor Authentication","text":"<p>Why Multi-factor Authentication ?</p> <ul> <li>Additional source of validation for improved security</li> <li>Meet compliance/audit requirements such as NIST and GDPR</li> <li>Prevention of security attacks such as denial of service attack</li> <li>Reduce the risk of compromising passwords</li> </ul> <p>Supported Multi-factor Integrations</p> <p></p> <p>Duo Security</p> <p>Backed by a zero trust philosophy, Duo provides easily configurable multi-factor authentication</p> <p>RSA Security</p> <p>Provides multi-factor authentication with RSA Authentication Manager</p> <p>Enabling Multi-factor Authentication</p> <p></p> <p>Configuring Duo</p> <p></p>"},{"location":"spl1/1spl_role_ad/#3-6-demo","title":"3-6 Demo","text":"<ul> <li>Create a new LDAP strategy</li> <li>Map LDAP groups to Splunk roles</li> <li>Use authentication.conf to map roles</li> <li>Grant granular capabilities for a role</li> </ul> <p>Create a new LDAP strategy</p> <p>We will use Splunk Web to configure an LDAP strategy that connects to an external LDAP server.</p> <p></p> <p></p> <p></p> <p><code>ldap.forumsys.com</code></p> <p>https://www.forumsys.com/tutorials/integration-how-to/ldap/online-ldap-test-server/</p> <p></p> <p></p> <p>Let's say chemists, and then assign power role for them.</p> <p></p> <p></p> <p>Mapped the chemists group into power role. Now by default, power role cannot edit Splunk licenses. You can go into Settings, and you can see that the Splunk licensing menu itself is not shown here</p> <p></p> <p>I don't want them to be full\u2011blown admins. All I want them to do is simply manage licenses.</p> <pre><code>cd ./etc/system/local\n$ pwd\n/Applications/Splunk/etc/system/local\n\nvi authorize.conf\n</code></pre> <pre><code>...\n# Role for advanced power user\n[role_advanced_power]\nimportRoles = power\nlicense_edit = enabled\n</code></pre> <pre><code>cd /Applications/Splunk/bin\n./splunk restart\n</code></pre> <p>You can see that the <code>advanced_power</code> role that I just created is showing up under Available Roles. </p> <p></p> <p></p> <p></p>"},{"location":"spl1/1spl_role_ad/#chapter-summary","title":"Chapter Summary","text":"<ul> <li>Splunk role based access control</li> <li>Splunk built in roles</li> <li>Create a custom Splunk role</li> <li>Configure external LDAP and map groups</li> <li>to Splunk roles</li> <li>Understand single sign-on and multi-factor authentication</li> <li>Troubleshoot user access issues</li> </ul>"},{"location":"spl1/2config_indexes/","title":"2 Working with Configuration Files and Indexes","text":""},{"location":"spl1/2config_indexes/#1-understanding-splunk-admin-basics-and-license-management","title":"1 Understanding Splunk Admin Basics and License Management","text":""},{"location":"spl1/2config_indexes/#1-1-a-day-in-splunk-enterprise-administrators-life","title":"1-1 A Day in Splunk Enterprise Administrator\u2019s Life","text":"<p>Splunk Enterprise Systems Administrators and Data Administrators have different responsibilities</p> <p>Splunk Enterprise Systems Administrator Tasks</p> <ul> <li>Install Splunk Software</li> <li>Create and Manage Indexes</li> <li>Manage Splunk Licenses</li> <li>Configure Security</li> <li>Monitor Splunk and respond to Monitoring Console Alerts</li> </ul> <p>Splunk Enterprise Data Administrator Tasks</p> <ul> <li>Create and manage inputs</li> <li>Manage parsing of data including line-breaking and timestamp extraction</li> <li>Design and establish new ingestion pipelines</li> <li>Manage Splunk configuration files</li> <li>Collaborate with users on data on-boarding</li> </ul>"},{"location":"spl1/2config_indexes/#1-2-splunk-enterprise-components","title":"1-2 Splunk Enterprise Components","text":"<ul> <li>On the left side, you have machine data sources. These are servers, containers or even network devices. They generate mission data. </li> <li>The mission data from those systems are collected and indexed in Splunk platform. </li> <li>The users interact with Splunk platform to search, report, and analyze. </li> </ul> <p>Three Core Components</p> <ul> <li>Indexer<ul> <li>Receive, parse and store machine data in files. Serve search requests</li> <li>it is important to know that the same splunkd daemon does both writing and reading the files from the disk</li> </ul> </li> <li> <p>Search Head </p> <ul> <li>Web interface for the users. Dispatch searches to Indexers</li> </ul> </li> <li> <p>Universal Forwarder</p> <ul> <li>Collects data from the clients and forwards for Indexing</li> </ul> </li> </ul> <p>how Splunk works</p> <p></p> <p>Client System:</p> <p>Left side, you have the client system. The applications write logs to log files. </p> <p>Splunk universal forwarder, which is a Splunk process, reads those log files and sends them to the indexer via TCP. </p> <p>Indexers:</p> <p>The indexers receive the data, parses them, organizes them in index files. </p> <p>Search head process</p> <p>The search head process, which is again another splunkd process, is used as a web interface for the user. The search head is responsible for dispatching searches to the indexers, collect the data, and make it available for the user.</p> <p>Other Splunk Components</p> <ul> <li>License Master</li> <li>Deployment Server</li> <li>Cluster Master</li> <li>Search Head Deployer</li> <li>Monitoring Console</li> <li>Heavy Forwarder</li> </ul> <p>License master</p> <ul> <li>The License Master manages Splunk licenses</li> <li>Other Splunk Components(such as indexer and searches) are License Slaves </li> <li>Can be a co-located with other components such as Monitoring Console</li> <li>Licenses can be managed through Splunk Web</li> </ul> <p>deployment server</p> <ul> <li>Manages the Configuration files on the Deployment Clients</li> <li>Maintains configuration in <code>serverclass.conf</code><ul> <li>Deployment clients typically mean the servers on which universal forwarders are installed.</li> </ul> </li> <li>Alternative solutions such as ansible/puppet can be used</li> <li>Configuration files are packaged as apps<ul> <li>An app is a Splunk terminology. App simply means a set of configuration files organized in order.</li> </ul> </li> <li>Deployment clients periodically poll Deployment Server<ul> <li>Deployment clients periodically poll deployment server and then download files that are designated for them, so it is rather a pull mechanism and not a push mechanism.</li> </ul> </li> </ul> <p>Cluster Master</p> <ul> <li>Cluster Master manages the Indexer Cluster</li> <li>There is only one Cluster Master<ul> <li>There is no high availability for the cluster master.</li> <li>You can have a passive standby, but it cannot be active.</li> </ul> </li> <li>Maintains data bucket status and handles replication</li> <li>Distributes configuration files and apps to Cluster members</li> </ul> <p>Search Head</p> <ul> <li>Search Head Deployer distributes apps and configuration files to Search Head Cluster Members</li> <li>Keeps the files in <code>$SPLUNK_HOME/etc/shd-apps</code></li> <li>Cannot run on the same instance as a cluster member</li> </ul> <p>Monitoring Console</p> <ul> <li>Monitoring Console is a Web App that helps to monitor the system health</li> <li>Rich set of charts and statistics</li> <li>One-stop-shop to monitor everything </li> <li>Only Administrators have access</li> </ul> <p>Heavy forwarders</p> <ul> <li>Heavy forwarders can parse data before forwarding to indexer</li> <li>Full Splunk Enterprise binary with distributed search disabled</li> <li>Can also index data locally</li> <li>Smaller footprint compared to indexer</li> </ul>"},{"location":"spl1/2config_indexes/#1-3-splunk-licensing-options","title":"1-3 Splunk Licensing Options","text":"<p>Splunk is not free. Splunk Licensing is based on the amount of data indexed</p> <p>A critical thing to note because it does not depend on the number of clients, as some of the licensing model works.</p> <p>It does not depend on how many processes connect to Splunk indexers. </p> <p>It is the amount of data that is received and indexed into Splunk platform.</p> <p>Types of Splunk Licenses</p> <ul> <li>Enterprise License</li> <li>Industrial IoT License</li> <li>Free License</li> <li>Forwarder License</li> <li>Trial License</li> <li>Dev/Test License</li> </ul> <p>Enterprise License</p> <ul> <li>The Enterprise License can be bought for any indexing volume</li> <li>Enables all Splunk features including clustering and distributed search</li> <li>No-enforcement. Users can still search after a License violation</li> <li>Licenses can be stacked</li> </ul> <p>You can purchase a license for any indexing volume from Splunk.</p> <p>Free License</p> <ul> <li>The Free license includes 500MB/day indexing, for life</li> <li>Disabled features<ul> <li>Clustering</li> <li>Authentication</li> <li>Distributed Search</li> <li>Alerting</li> <li>Deployment management</li> </ul> </li> </ul> <p>Trial License</p> <ul> <li>The Trial License provides full Splunk features for 60 days</li> <li>After 60 days, it automatically becomes Free License</li> <li>Maximum 500 MB daily volume</li> <li>Sales Trial license can provided for customized limits</li> </ul> <p>Industrial IoT License</p> <ul> <li>Splunk for Industrial IoT License</li> <li>Not stackable</li> <li>Access to Splunk Enterprise and a select premium Splunk Apps</li> </ul> <p>Forwarder License</p> <ul> <li>Forwarder License allows forwarding of unlimited data</li> <li>Cannot be used for indexing</li> <li>No need to purchase them separately</li> <li>Universal Forwarders automatically apply Forwarder License</li> <li>Heavy Forwarders must be converted to Forwarder License group</li> </ul> <p>Dev/Test License</p> <ul> <li>Dev/Test license for running Splunk in Non Prod environments</li> <li>Cannot be used in distributed environment</li> <li>Not stackable</li> <li>Can be used for Splunk App development</li> </ul> <p>What counts towards daily License quota?</p> <ul> <li> <p>Full size of data flowing through the parsing pipeline</p> <ul> <li>Whatever gets into the parsing queue is what gets charged.</li> </ul> </li> <li> <p>Not the disk storage</p> <ul> <li>It is not the ultimate final disk storage because the data gets compressed and also added with the metadata and other indexing data in the disk.</li> </ul> </li> <li>Does not include<ul> <li>What is being charged is the data that flows through the parsing pipeline before it gets written to the disk</li> </ul> </li> <li>Replicated Data<ul> <li>The data does not include replicated data.</li> </ul> </li> <li>Summary indexes</li> <li>Internal Logs<ul> <li>Splunk Splunks itself. There's tons of logs that Splunk generates, and they all are indexed in <code>_internal</code> index. </li> </ul> </li> <li>Metadata</li> </ul> <p>Licensing in Distributed Environment</p> <p></p> <p>The license master is the only server that has the enterprise license stack installed. </p> <p>All other components in your environment act as license slaves, and they simply connect to the license master. </p> <p>It is configured in <code>server.conf</code> on the licensed slaves.</p>"},{"location":"spl1/2config_indexes/#1-4-managing-license-violations","title":"1-4 Managing License Violations","text":"<p>License Warnings and Violations</p> <ul> <li>Exceeding daily volume quota results in a Warning</li> <li>5 or more warnings in a 30 day rolling period is a Violation</li> <li>Searching is NOT disabled in violation period</li> <li>Alert logged in Messages on any Splunk Web pages</li> </ul> <p>Monitoring License Warnings</p> <ul> <li>Monitoring Console: Enable the license monitoring alerts</li> <li>Licensing Page in Splunk Web: Current and permanent violations</li> <li>Usage Report in Splunk Web: Current and previous  30 days usage</li> </ul> <p>Handling License Violations</p> <ul> <li>Review heavy hitters (Usage Report) and adjust intake</li> <li>The daily limit resets at midnight</li> <li>Buy more license</li> </ul>"},{"location":"spl1/2config_indexes/#demo","title":"Demo","text":"<ul> <li>Licensing page in Splunk Web</li> <li>Review Warnings and Violations</li> <li>Usage Report<ul> <li>Current</li> <li>Past 30 days</li> </ul> </li> <li>Enable Monitoring Console License Alerts</li> </ul>"},{"location":"spl1/2config_indexes/#2-working-with-splunk-configuration-files","title":"2 Working with Splunk Configuration Files","text":"<ul> <li>Understanding Splunk configuration files</li> <li>Structure of Splunk configuration files</li> <li>Layering the configuration files<ul> <li>Index-time</li> <li>Search-time</li> </ul> </li> <li>Precedence of configuration files</li> <li>Using btool to troubleshoot</li> </ul>"},{"location":"spl1/2config_indexes/#2-1-understanding-splunk-configuration-files","title":"2-1 Understanding Splunk Configuration Files","text":"<p>Splunk platform is configured using set of text-based configuration files</p> <p>Splunk Configuration Files</p> <ul> <li>Text files located in <code>SPLUNK_HOME/etc/\u2026</code></li> <li><code>.conf</code> extension (Examples: <code>server.conf</code>, <code>deploymentclient.conf</code>)</li> </ul> <p>Typically, it's /opt/splunk in UNIX\u2011based systems. </p> <ul> <li>Changes made via Splunk Web update configuration files</li> <li>Contain stanzas and key value pairs</li> <li>Govern a Splunk functionality</li> </ul> <p>For example, props.conf governs how data is parsed.</p> <p>Server.conf governs the system\u2011level parameter of the splunkd process.</p> <p>There are only two Splunk software packages: Splunk  Enterprise and Splunk Universal Forwarder</p> <p>Splunk Software Packages</p> <p>Splunk Enterprise</p> <ul> <li>Indexer</li> <li>Search Head</li> <li>License Master</li> <li>Deployment Server</li> <li>Cluster Master</li> <li>Search Head Deployer</li> <li>Monitoring Console</li> <li>Heavy Forwarder</li> </ul> <p>Splunk Universal Forwarder</p> <ul> <li>Deployment Client</li> </ul> <p>Splunk Platform Directory Structure</p> <p></p> <ul> <li>On top, we have <code>SPLUNK_HOME</code>. In general, it is <code>/opt/splunk</code> in Linux\u2011based systems, but it is any directory that you chose to install Splunk. </li> <li> <p>bin directory under <code>SPLUNK_HOME</code>that contains Splunk commands, for example, the <code>./splunk</code> command that we typically use to restart a Splunk process is located under <code>SPLUNK_HOME</code> bin. </p> </li> <li> <p>etc. It has three major directories. </p> <ul> <li>The first is apps. Under apps, we have configuration files packaged as apps. We will see that apps is one of the core ways Splunk manages configuration files. </li> <li>users directory, under which we have user\u2011specific configuration files. <ul> <li>For example, if a user logs onto Splunk Web and then creates an alert, the alert configuration goes inside the users directory. </li> </ul> </li> <li>System. Here is where system\u2011wide configuration files are stored. </li> </ul> </li> </ul> <p>If the user shares the alert, the configuration is moved to the apps directory</p> <ul> <li>var directory under <code>SPLUNK_HOME</code> that contains two major directories.<ul> <li>log in which we have Splunk platform's log files. <ul> <li>The index in which the logs are stored is <code>_internal</code>. </li> </ul> </li> <li>Then we have lib directory, under which the indexes live. Index is where the mission data is stored. </li> </ul> </li> </ul> <p>Structure of Splunk Configuration File</p> <p>Configuration Files Are Made of Stanzas and Key-value Pairs </p> <p><code>indexes.conf</code></p> <pre><code>[default]\nmaxTotalDataSizeMB = 650000\nmaxGlobalRawDataSizeMB = 0\n\n# idx1 index settings\n[idx1]\nhomePath = volume:hot1/idx1\ncoldPath = volume:cold2/idx1\n</code></pre> <p><code>inputs.conf</code> </p> <pre><code>[monitor:///var/log/httpd]\nsourcetype = access_common\nignoreOlderThan = 7d\nindex = web\n</code></pre> <p>Two Ways to Learn Splunk Configuration Files</p> <ul> <li>README files</li> </ul> <p><code>$SPLUNK_HOME/etc/system/README</code> directory contains  example and spec files</p> <ul> <li>Spec files at docs.splunk.com  https://docs.splunk.com/Documentation/Splunk</li> </ul> <p></p> <p><code>PLUNK HOME/etc/system/README</code></p>"},{"location":"spl1/2config_indexes/#2-2-layering-splunk-configuration-files","title":"2-2 Layering Splunk Configuration Files","text":"<p>Splunk App</p> <ul> <li>Splunk's way of organizing configuration files</li> <li>A directory under <code>SPLUNK_HOME/etc/apps</code></li> <li>Contains Splunk configuration files</li> <li>Can also contain scripts and other necessary artifacts</li> <li>An add-on is an app that usually does not contain GUI</li> </ul> <p>Search &amp; Reporting app</p> <ul> <li>Splunk ships with Search &amp; Reporting app which is a prebuilt general-purpose app.</li> <li>The configuration is stored under SPLUNK_HOME/etc/apps/search</li> </ul> <p>Splunk App Directory Structure</p> <p></p> <p>We have another special folder called metadata that contains default.meta and/or local.meta that defines the permissions for this app</p> <p>Default vs. Local Directories</p> <ul> <li> <p>Default</p> <ul> <li>Shipped with Splunk</li> <li>Will be overwritten upon Splunk upgrade</li> <li>Files should not be updated</li> <li>Contains default settings</li> <li>Does not override local</li> </ul> </li> <li> <p>Local</p> <ul> <li>User created</li> <li>Will be preserved upon Splunk upgrade</li> <li>Recommended place to modify files</li> <li>User-specific configuration changes</li> <li>Always overrides default</li> </ul> </li> </ul> <p>All the Configuration File Locations</p> <ul> <li><code>etc/system/default</code></li> <li><code>etc/system/local</code></li> <li><code>etc/apps/search/default</code></li> <li><code>etc/apps/search/local</code></li> <li><code>etc/apps/&lt;app&gt;/default</code></li> <li><code>etc/apps/&lt;app&gt;/local</code></li> <li><code>etc/users/&lt;user&gt;/&lt;app&gt;/local</code> Do not update files in etc/system/default</li> </ul> <p>Never update files in <code>etc/system/default</code>. It is the default system where the configuration, and it is bound to be updated or overwritten whenever you upgrade Splunk platform. </p>"},{"location":"spl1/2config_indexes/#2-3-mastering-splunk-configuration-files-precedence","title":"2-3 Mastering Splunk Configuration Files Precedence","text":"<p>Index-time and Search-time</p> <ul> <li>Index-time: Global context, such as input/parsing configuration</li> </ul> <p>configuration with a global context such as inputs.conf</p> <ul> <li>Search-time: App/User scoped, such as a user\u2019s knowledge objects</li> </ul> <p>would be saved to searches.conf in which a user can have scheduled reports and even alerts</p> <p></p> <p>Index-time Precedence</p> <p></p> <ol> <li><code>etc/system/local</code>. Any configuration here will override configuration in any other location. This is the gold standard, the mother of all configuration files, etc/system/local.</li> <li><code>etc/apps/search/local</code>. Search is a special pre\u2011built app that comes with Splunk. </li> <li><code>etc/apps</code>, any custom app, in this case, app1/local.</li> <li><code>etc/apps/search/default</code>. </li> <li><code>etc/apps</code>, any app, in this case, app1, default.</li> <li><code>etc/system/default</code>. That gets the lowest precedence in any case, etc/system/default. </li> </ol> <p>if there are two or more apps that have conflicting settings, app directory name with the highest ASCII order wins. </p> <p>Search-time Precedence</p> <p></p> <ol> <li><code>etc/users</code>, username, and then the particular app he is working on, /local. You can see that <code>etc/system/local</code> does not get the top precedence. </li> <li><code>etc/apps</code>, the app in which the user is working on right now, /local. </li> <li><code>etc/apps</code>, app name, default. </li> <li><code>etc/apps/search/local</code>. </li> <li><code>etc/apps/search/default</code>. </li> <li><code>etc/system/local</code>. You can see that during index time, <code>etc/system/local</code> is the most important directory, whereas during search time, it is almost the last.</li> <li><code>etc/system/default</code>. </li> </ol> <p>How Splunk merges configuration files. </p> <ul> <li>Upon startup, Splunk merges configuration files for each type, very important point. </li> </ul> <p>For example, if there are multiple <code>limits.conf</code> spread across various applications, or apps rather, upon startup, Splunk will merge all the configurations into one single <code>limits.conf</code>. </p> <ul> <li> <p>The resulting file combines settings from various directory locations. </p> <ul> <li>It is a union of all settings for the same configuration file that is available across different directories. </li> </ul> </li> <li> <p>Only one file per file type will be used at runtime. </p> </li> </ul> <p>It does not matter how many <code>inputs.conf</code> are out there or how many <code>props.conf</code> are out there.</p> <p>For a given type, there is only one configuration file at runtime. If there is a conflict, precedence is applied. </p> <ul> <li>If there is a conflict, precedence is applied</li> <li>Local takes precedence over default</li> </ul> <p>How layering and precedence works.</p> <p>consider props.conf. And in this section of <code>props.conf</code>, it happens to be processed during index time. </p> <p>Configuration File Merging Example 1</p> <p><code>etc/apps/karun_app_props/local/props.conf</code></p> <pre><code>[web:log]\nSHOULD_LINEMERGE = false\nLINE_BREAKER = ([\\r\\n]+)\\d{4}-\n</code></pre> <p><code>etc/apps/joe_app_props/local/props.conf</code></p> <pre><code>[app:log]\nTIME_FORMAT = %Y-%m-%d %H:%M:%S%Z\nTIME_PREFIX = ^\n</code></pre> <p><code>etc/apps/jack_app_props/local/props.conf</code></p> <pre><code>[db:log]\nBREAK_ONLY_BEFORE_DATE = true\nSHOULD_LINEMERGE=true\n\n[web:log]\ncategory = web\n</code></pre> <p>Effective props.conf at runtime</p> <pre><code>[web:log]\nSHOULD_LINEMERGE = false\nLINE_BREAKER = ([\\r\\n]+)\\d{4}-\ncategory = web\n\n[app:log]\nTIME_FORMAT = %Y-%m-%d %H:%M:%S%Z\nTIME_PREFIX = ^\n\n[db:log]\nBREAK_ONLY_BEFORE_DATE = true\nSHOULD_LINEMERGE=true\n</code></pre> <p>Configuration File Merging Example 2</p> <pre><code>etc/system/default/limits.conf\n[inputproc]\nfile_tracking_db_threshold_mb = 500\nlearned_sourcetypes_limit = 1000\n\n\netc/apps/karun_limits_app/local/limits.conf\n[inputproc]\nmax_fd = 500\n\netc/system/local/limits.conf\n[inputproc]\nmax_fd = 300\n</code></pre> <p>Effective limits.conf at runtime</p> <pre><code>[inputproc]\nfile_tracking_db_threshold_mb = 500\nlearned_sourcetypes_limit = 1000\nmax_fd = 300\n</code></pre> <ul> <li><code>file_tracking_db_threshold_mb</code>\uff1a The first parameter defines the maximum size of fishbucket database\uff0cafter which a new database file will be created. Fishbucket database is used to keep track of monitoring the input files and its progress. </li> <li><code>Learned_sourcetypes_limit</code> limits the maximum number of automatically created source types. </li> </ul> <p>When overriding configuration with a local file, do not copy the entire file from default. Just add the overriding configuration.</p> <p>Overriding the Default Configurations</p> <p>Correct Way to Override Defaults</p> <p><code>etc/system/default/props.conf</code></p> <pre><code>[default]\nCHARSET = UTF-8\nLINE_BREAKER_LOOKBEHIND = 100\nTRUNCATE = 10000\nDATETIME_CONFIG = /etc/datetime.xml\nADD_EXTRA_TIME_FIELDS = True\nANNOTATE_PUNCT = True\n</code></pre> <p>TRUNCATE: defines the maximum number of lines after which an event will be truncated. So by default, it is 10000. </p> <p>Now in order to override this, all you need to do is to simply redefine TRUNCATE with the value that you want in <code>etc/system/local/props.conf</code>. </p> <p>Again, do not copy the entire props.conf from default. Simply override it with etc/system/local/props.conf.</p> <p><code>etc/system/local/props.conf</code></p> <pre><code>[default]\nTRUNCATE = 50000\n</code></pre> <p>Note that <code>etc/system/local/props.conf</code> is the mother of all configuration files. </p> <p>As an added tip, the two locations where default configurations are stored out of the box is etc/system/default and etc/apps/search/default.</p>"},{"location":"spl1/2config_indexes/#2-4-using-btool-to-work-with-splunk-configuration-files","title":"2-4 Using btool to Work with Splunk Configuration Files","text":"<ul> <li>A Splunk command</li> <li>Located in <code>SPLUNK_HOME/bin</code></li> <li>Retrieves the on-disk configuration of a Splunk configuration file</li> <li>Syntax: <code>splunk btool &lt;conf file name&gt; list [options]</code></li> <li><code>--debug</code> option shows the exact <code>.conf</code> file location</li> </ul> <p>Btool Example</p> <pre><code>/opt/splunk/bin# ./splunk btool inputs list monitor:///var/log\n\n[monitor:///var/log]\n_rcvbuf = 1572864\ndisabled = false\nhost = Karun-Mac-Container\nindex = main\n\n\n/opt/splunk/bin# ./splunk btool inputs list monitor:///var/log --debug\n/opt/splunk/etc/apps/search/local/inputs.conf [monitor:///var/log]\n/opt/splunk/etc/system/default/inputs.conf _rcvbuf = 1572864\n/opt/splunk/etc/apps/search/local/inputs.conf disabled = false\n/opt/splunk/etc/apps/search/local/inputs.conf host = Karun-Mac-Container\n/opt/splunk/etc/apps/search/local/inputs.conf index = main\n</code></pre> <p>retrieving the contents of inputs</p> <p>As you can see, there are two inputs.conf in play here. One comes from <code>etc/apps/search/local</code>, and the other one comes from <code>etc/system/default.inputs.conf</code>. </p> <pre><code>/opt/splunk/bin$ ./splunk status\n\n/opt/splunk/bin$ ps -ef | grep splunk\n\nsplunk -p 8089 start\n\ncd system/default\n/opt/splunk/etc/system/default$ ls\nalert_actions.conf ....\napp.conf\n\n$ vi props. conf\n# This file specifies how to parse a given log file\n</code></pre> <p>Add new data inputs</p> <p></p> <p></p> <p>Start searching</p> <p></p> <p><code>source=\"/var/log/*\" host=\"Karun-Mac\"</code></p> <p></p> <p>New input file created</p> <pre><code>/opt/splunk/etc/apps/search/local: 1s -lrt\n\ninputs.conf\n\n[splunktep://9997]\nconnection_host = ip\n\n[monitor:///var/log]\ndisabled = false\nhost = Karun-Mac\nindex = main\n</code></pre> <p></p> <pre><code>/opt/splunk/bin$ ./splunk btool inputs list\n\n\n/opt/splunk/bin$ ./splunk tool inputs lis monitor\n\n[monitor:///opt/splunk/etc/splunk.version]\n...\n[monitor:///opt/splunk/var/loq/introspection]\n</code></pre> <pre><code>./splunk btool inputs list monitor --debug\n...\n/opt/splunk/etc/apps/search/local/inputs.conf   [monitor:///var/log]  \n/opt/splunk/etc/system/default/inputs.conf      _revbuf = 1572864\n/opt/splunk/etc/apps/search/local/inputs.conf   disabled = false\n/opt/splunk/etc/apps/search/local/inputs.conf   host = Karun-Mac\n/opt/splunk/etc/apps/search/local/inputs.conf   index = main\n</code></pre> <pre><code>/opt/splunk/bin$./splunk btool inputs list monitor:///var/log\n\n[monitor:///var/log]\n_revbuf = 1572864\ndisabled = false\nhost = Karun-Mac\nindex = main\n</code></pre>"},{"location":"spl1/2config_indexes/#2-5-more-examples-of-using-btool","title":"2-5 More Examples of Using Btool","text":"<ul> <li>Review a Splunk configuration file</li> <li>Locate the btool command</li> <li>Use btool to retrieve configuration</li> <li>Use btool to analyze conflicts</li> <li>Using REST API to retrieve configuration</li> </ul> <p>dpkg source type</p> <p>Now I know that I did not manually create this sourcetype. Splunk uses sourcetype to parse the data, so I need to find out where the source type dpkg is defined.</p> <p></p> <pre><code>./splunk btool props list dpkg\n\n/opt/splunk/etc/apps/learned/local/props.conf [dpkg]\n</code></pre> <p>install Splunk <code>*NIX TA</code>, the Splunk UNIX TA</p> <p>The *NIX TA can be obtained from <code>splunkbase.solunk.com</code></p> <p></p> <p></p> <pre><code>/opt/splunk/etc/apps$ ls-lrt\n...\nSplunk_TA_nix\n\n\ncd opt/splunk/etc/apps/Splunk_TA_nix/local$ ls -lrt\n\nvi inputs.conf\n</code></pre> <p>Default is disable, enable all the input</p> <p></p> <p></p> <pre><code>./splunk btool inputs list script://./bin/top.sh --debug\n</code></pre> <p>How we can access Splunk configuration via rest API</p> <pre><code>| rest services/properties\n</code></pre> <p></p> <pre><code>| rest services/properties/props \n</code></pre> <pre><code>| rest services/properties/props/dpkg/MAX_EVENTS\n</code></pre> <p></p>"},{"location":"spl1/2config_indexes/#3-understanding-splunk-index","title":"3 Understanding Splunk Index","text":"<p>Overview</p> <ul> <li>How Splunk organizes data</li> <li>Index buckets<ul> <li>Hot</li> <li>Warm</li> <li>Cold</li> <li>Frozen</li> <li>Thawed</li> </ul> </li> <li> <p>Creating an index</p> <ul> <li>Using Splunk Web</li> <li>Using configuration files</li> <li>One index vs multiple indexes</li> </ul> </li> <li> <p>Index data integrity</p> </li> </ul>"},{"location":"spl1/2config_indexes/#3-1-how-splunk-organizes-data","title":"3-1 How Splunk Organizes Data","text":"<p>Splunk stores data in indexes, which are organized in directories and files in disk</p> <p>Splunk Indexes</p> <ul> <li>Indexes are stored in <code>SPLUNK_HOME/var/lib/splunk</code></li> <li>The directory location is customizable for each index</li> <li>Indexes contain raw data and index files</li> <li>Indexes can be created by an Administrator</li> <li>Many prebuilt indexes<ul> <li><code>_internal</code></li> <li><code>_audit</code></li> <li>main</li> </ul> </li> </ul> <p></p> <p>Another useful internal index is <code>_introspection</code>which stores Spunk platform's performance metrics</p> <p>Inside a Splunk Index</p> <ul> <li>Raw data: Raw data is stored in compressed format</li> <li>Tsidx files: Time series index files that point to the raw data</li> <li>metadata: Metadata files such as Sources.data, SourceTypes.data and Hosts.data</li> </ul>"},{"location":"spl1/2config_indexes/#3-2-splunk-data-buckets","title":"3-2 Splunk Data Buckets","text":"<p>Buckets</p> <ul> <li>Indexes store data in buckets</li> <li>Buckets are set of directories organized by age</li> <li>Contain raw data, tsidx files and metadata</li> <li>As the index grows, number of buckets grows as well</li> </ul> <p>Types of Buckets</p> <ul> <li>Hot</li> <li>Warm</li> <li>Cold</li> <li>Frozen</li> <li>Thawed</li> </ul> <p>Hot</p> <ul> <li>Hot buckets contain the newest data</li> <li>They are open for both read and write</li> <li>There can be more then one hot bucket in an index</li> <li>Searchable</li> <li>Roll to warm bucket when buckets reach certain size, or upon Splunk restart</li> </ul> <p><code>maxHotBuckets</code> in <code>indexes.conf</code> can beconfigured (default 3)</p> <p>Warm</p> <ul> <li>Warm buckets are created when hot buckets roll</li> <li>Not open for writing, but searchable</li> <li>They reside in the same directory as hot buckets but renamed</li> <li>Roll to cold buckets when exceeding maximum warm buckets setting</li> </ul> <p>maxWarmDBCount in indexes.conf can be configured (default 300)</p> <p>Cold</p> <ul> <li>Starting from oldest bucket (based on time), warm buckets roll to cold</li> <li>Reside in different directory from hot and warm</li> <li>Searchable</li> <li>The directory location can be configured</li> <li>Possible to save cost by using cheaper storage</li> </ul> <p>Frozen</p> <ul> <li>After cold buckets age out based on retention policy, they roll to frozen</li> <li>The default action is to delete; can be configured to archive</li> <li>coldToFrozenDir or coldToFrozenScript in <code>indexes.conf</code> configures archiving</li> <li>Archived frozen buckets are not searchable</li> </ul> <p>All events in a cold bucket must be eligible to be frozen</p> <p>Thawed</p> <ul> <li>Frozen buckets can be thawed</li> <li>Thawed buckets are rebuilt into the index and searchable</li> <li>Location of thawed buckets can be configured in indexes.conf</li> <li>No age restriction for thawed buckets</li> <li>Use <code>splunk rebuild</code> command to rebuild</li> </ul> <p>Bucket Locations</p> <ul> <li><code>SPLUNK_HOME/var/lib/splunk/myfirstindex/db/</code></li> <li><code>SPLUNK_HOME/var/lib/splunk/myfirstindex/db/</code></li> <li><code>SPLUNK_HOME/var/lib/splunk/myfirstindex/colddb/</code></li> <li>Frozen buckets are deleted by default. Can be optionally archived.</li> <li><code>SPLUNK_HOME/var/lib/splunk/myfirstindex/thaweddb/</code></li> </ul> <p>Bucket Naming</p> <p>Hot</p> <ul> <li><code>hot_v1_&lt;local id&gt;</code></li> <li><code>hot_v1_5</code></li> </ul> <p>Warm</p> <ul> <li><code>db_&lt;newest time&gt;_&lt;oldest_time&gt;_&lt;local id&gt;</code></li> <li> <p><code>db_1559676230_1559676181_0</code></p> </li> <li> <p>Local id is the ID of the bucket</p> </li> <li>Newest and oldest time are in UTC epoch time in seconds</li> <li>During a search, Splunk uses the time range in the bucket name before opening it</li> </ul> <p>Index Directory Structure</p> <p></p>"},{"location":"spl1/2config_indexes/#3-3-creating-splunk-indexes","title":"3-3 Creating Splunk Indexes","text":"<p>Why Create Multiple Indexes?</p> <ul> <li>Security\uff1a Restrict access to index by Splunk role</li> <li>Retention\uff1a Retention policies are applied at index level</li> </ul> <p><code>authorize.conf</code></p> <p>Security is defined in authorize.conf</p> <pre><code>[role_myrole]      # Definition for myrole\nimportRoles = user   # Inherit user role\u2019s capabilities\nsrchIndexesAllowed = os,idx1   #Allowed indexes are os and idx1\nsrchIndexesDefault = idx1  # Default index is idx1\n\n[role_mysuperuserrole]\nimportRoles = user\nsrchIndexesAllowed = os,idx1,idx2  # Allowed indexes are os,idx1,idx2\nsrchIndexesDefault = idx2   # Default index is idx2\n</code></pre> <p><code>indexes.conf</code></p> <p>Indexes are configured in indexes.conf</p> <pre><code>[myfirstindex]   # Definition for myfirstindex\ncoldPath =  $SPLUNK_DB/myfirstindex/colddb   # Location for cold buckets\nenableDataIntegrityControl = 0  # Disable Data Integrity Control\nenableTsidxReduction = 0        # Disable TSIDX reduction\n\nhomePath = $SPLUNK_DB/myfirstindex/db   # Location for hot and warm buckets\n\nmaxTotalDataSizeMB = 512000   # Maximum size of the index\nfrozenTimePeriodInSecs = 1209600  # Number of seconds after which bucket roles to frozen (every event in a bucket must be older than this limit)\n\nthawedPath = $SPLUNK_DB/myfirstindex/thaweddb # Location for thawed buckets\n</code></pre> <p>Creating Splunk Index</p> <ul> <li> <p>Using Splunk Web</p> <ul> <li>Settings -&gt; Indexes -&gt; New Index</li> </ul> </li> <li> <p>Using configuration files</p> <ul> <li>Copy existing stanza in <code>indexes.conf</code> and update. </li> <li>Restart of Splunk required</li> </ul> </li> </ul> <p>Creating Index Using Splunk Web</p> <p></p> <p>Index Data Integrity</p> <ul> <li><code>enableDataIntegrityControl=true</code> in <code>indexes.conf</code>.<ul> <li>Check integrity:</li> </ul> </li> </ul> <p><code>./splunk check-integrity -index [ index name ]</code></p> <ul> <li>Allows to ensure indexed data has not been tampered with.<ul> <li>Regenerate hash: </li> </ul> </li> </ul> <p><code>./splunk generate-hash-files -index [ index name ]</code></p> <ul> <li>Creates hash files (using SHA 256) as the data is indexed.<ul> <li>Hash files are stored in rawdata directory within the index.</li> </ul> </li> </ul> <p>One Index vs. Multiple Indexes</p> <ul> <li>Security: Create separate indexes if you want to allow access selectively</li> <li>Retention: Create separate indexes if you want varying data retention periods</li> <li>Management: Easier management for chargeback processes</li> </ul>"},{"location":"spl1/2config_indexes/#3-4-demo","title":"3-4 Demo","text":"<ul> <li>Create a Splunk index using Splunk Web</li> </ul> <ul> <li>Upload data</li> </ul> <ul> <li>Review the indexes.conf</li> </ul> <pre><code>cd var/lib/splunk/\ncd oslogs\n\n/opt/splunk/var/lib/splunk/oslogs$ ls -lrt\nthaweddb\ndatamodel_summary\n\n/opt/splunk/var/lib/splunk/oslogs/db$ ls -lrt\nCreationTime\nhot_v1_1\nhot_v1_0\n\ncd hot_v1_0\n1577042620-1577042619-577230494255484\n$ ls -lrt\nbucket_info.csv\nStrings.data\nSources.data\nSourceTypes.data\nHosts. data\n1559676212-1559676181-5772278361002267635.tsidx\nsplunk-autogen-params.dat\n1559676230-1559676212-5772318639205556589.tsidx\nrawdata\n\n/opt/splunk/var/lib/splunk/oslos/db/db_1559676230_1559676181_1/rawdata$ ls\njournal.az\n12Hash_1_2013DDA2-630D-4FFE-BD9E-7EC7E2D8C74B.dat\nslicesv2.dat\n</code></pre> <ul> <li> <p>Review the index directory structure</p> <ul> <li>buckets</li> <li>tsidx files</li> <li>raw data</li> </ul> </li> <li> <p>Check data integrity</p> </li> </ul> <pre><code>./slunk btool indexes list oslogs --debug\n\n/opt/splunk/bin$./splunkcheck-integrity\n\nWatchdogActionsManager reload started\nStarting WatchdogThread for process pid=11068. Threads monitoring is enabled with response timeout set to 8000 ms\nOperating on: id=oslogs bucket='/opt/splunk/var/lib/splunk/oslogs/db/db_1577042620_1577042619_0\nOperating on: id=oslogs bucket='/opt/splunk/var/lib/splunk/oslogs/db/db_1559676230_1559676181_1'\nTotal buckets checked=2, succeeded=2, failed=0\n</code></pre>"},{"location":"spl1/2config_indexes/#4-configuring-indexes","title":"4 Configuring Indexes","text":"<ul> <li>Learning to tune indexes.conf</li> <li>Understanding fishbucket</li> <li>Applying a data retention policy</li> <li>Managing Splunk index<ul> <li>Backup</li> <li>Backup</li> <li>Cleaning out</li> </ul> </li> <li>Using monitoring-console to understand index configuration</li> </ul>"},{"location":"spl1/2config_indexes/#4-1-splunk-index-configuration-file","title":"4-1 Splunk Index Configuration File","text":"<p>Indexes.conf file is used to configure Splunk indexes and their properties</p> <p><code>Location of indexes.conf</code></p> <ul> <li>There is a default <code>indexes.conf</code> in <code>SPLUNK_HOME/etc/system/default</code> directory.</li> <li>DO NOT edit this file.</li> <li>Create a new indexes.conf in <code>SPLUNK_HOME/etc/system/local</code> directory and add specific customization there.</li> </ul> <p>You can also place <code>indexes.conf</code> as part of an app under <code>SPLUNK_HOME/etc/apps/&lt;app name&gt;/local</code>.</p> <p>Restart of splunkd required for any configuration changes</p> <p>Structure of <code>indexes.conf</code></p> <p>The file can have a 'default' stanza for defining global properties</p> <p>If a property is defined outside of any stanza, at the top of the file, it is considered a global property.</p> <p>If a property is defined at both global level and in a specific stanza, value in the stanza takes precedence.</p> <p>If there are multiple definitions of the same settings in a stanza, last setting wins.</p> <ul> <li><code>Indexes.conf</code></li> </ul> <pre><code># A basic index definition\u000b\n\n[weblogs]\n\nhomePath = $SPLUNK_DB/weblogs/db\ncoldPath = $SPLUNK_DB/weblogs/colddb\nthawedPath = $SPLUNK_DB/weblogs/thaweddb\n\ntstatsHomePath = $SPLUNK_DB/weblogs/datamodel_summary\n\nfrozenTimePeriodInSecs = 5184000\n</code></pre> <pre><code>homePath = $SPLUNK_DB/weblogs/db  # Directory for hot and warm buckets\n\ncoldPath = $SPLUNK_DB/weblogs/colddb # Directory for cold buckets\nthawedPath = $SPLUNK_DB/weblogs/thaweddb  # Directory for thawed buckets\ntstatsHomePath = $SPLUNK_DB/weblogs/datamodel_summary  # Directory for accelerated data model summary tsidx files\n\nfrozenTimePeriodInSecs = 5184000 # Freeze data older than this many seconds\n\nmaxHotBuckets = 3  # Maximum number of hot buckets\n\nmaxDataSize = auto  # Maximum size of hot buckets (default 750MB)\n\nmaxTotalDataSizeMB = 400000  # Maximum size of an index\n\nmaxWarmDBCount = 300   # Maximum number of warm buckets\n</code></pre>"},{"location":"spl1/2config_indexes/#4-2-understanding-fishbucket","title":"4-2 Understanding Fishbucket","text":"<p>Splunk Fishbucket</p> <p>fishbucket is a special Splunk internal index that is automatically created.</p> <p>Checkpoint</p> <p>Fishbucket keeps track of the ingestion progress of monitored files and directories</p> <p>Location</p> <p>It is located in <code>SPLUNK_HOME/var/lib/splunk/fishbucket</code>.</p> <p>Use</p> <p>Upon restart, using fishbucket, Splunk can start ingesting from where it left off</p> <p>Using Fishbucket</p> <p>To re-index a particular file</p> <pre><code># Use btprobe command\n./splunk cmd btprobe -d SPLUNK_HOME/var/lib/splunk/fishbucket/splunk_private_db --file &lt;file name&gt; --reset\n</code></pre> <p>To re-index all monitored file</p> <pre><code># Remove the entire fishbucket directory\n\nrm -rf /opt/splunk/var/lib/splunk/fishbucket\n\nYou must restart Splunk Forwarder\n</code></pre>"},{"location":"spl1/2config_indexes/#4-3-applying-a-data-retention-policy","title":"4-3 Applying a Data Retention Policy","text":"<p>Data Retention in Splunk</p> <ul> <li>you must define a retention policy for the data indexed</li> <li>Retention policy is applied at index level</li> <li>Set maxTotalDataSizeMB and/or frozenTimePeriodInSecs</li> <li>maxTotalDataSizeMB overrides frozenTimePeriodInSecs</li> <li>indexes.conf is used to configure retention ploicy</li> </ul> <p>Configuring Data Retention</p> <ul> <li> <p>maxTotalDataSizeMB</p> <ul> <li>Maximum size of the index in Mega Bytes. Oldest data is frozen after this limit. Default is 500GB</li> </ul> </li> <li> <p>frozenTimePeriodInSecs</p> <ul> <li>Time period in seconds after which the data rolls to frozen. Default is 6 years</li> </ul> </li> </ul> <p>What Happens to the Expired Data</p> <ul> <li>When the bucket rolls from cold to frozen, by default the data is deleted</li> <li>If coldToFrozenScript is configured, the script is executed </li> <li>If coldToFrozenDir is configured, Splunk moves the expired buckets to this directory</li> <li>To restore expired data, copy the archived buckets to thaweddb location and rebuild<ul> <li><code>./splunk rebuild SPLUNK_HOME/var/lib/splunk/&lt;index name&gt;/thaweddb/&lt;bucket name&gt;</code></li> </ul> </li> </ul>"},{"location":"spl1/2config_indexes/#4-4-managing-splunk-indexes","title":"4-4 Managing Splunk Indexes","text":"<p>Backing up Splunk</p> <ul> <li>You must regularly backup Splunk. Daily incremental backups recommended.</li> <li>Objects to backup: Warm and cold buckets; Entire etc directory.</li> <li>Hot buckets can't be backed up without stopping Splunk.</li> </ul> <p>In a clustered environment, you may not need to backup data buckets as data is replicated.</p> <p>In distributed environments, ensure you backup search heads and heavy forwarders.</p> <p>Deleting Events in a Splunk Index</p> <p>Best way is to let the data expire instead of deleting</p> <p>You can only do a virtual delete (i.e data is not removed from disk)</p> <p>Even admins can't delete data by default</p> <ul> <li>Create a user with <code>can_delete</code> capability.</li> <li>Run a search to list the desired events to be deleted.</li> <li>Pipe the delete command.</li> </ul> <p>Cleaning out a Splunk Index</p> <ul> <li>Extremely dangerous command in production</li> <li>Destroys index data from disk</li> <li>syntax:<ul> <li><code>splunk clean all -index &lt;index name&gt;</code></li> </ul> </li> </ul>"},{"location":"spl1/2config_indexes/#4-5-demo","title":"4-5 Demo","text":"<ul> <li>Review indexes.conf<ul> <li>Data retention policy</li> </ul> </li> </ul> <pre><code>cd ../etc/system/default/\nvi indexes.conf\n</code></pre> <pre><code>cd /opt/splunk/etc/apps/search/locals\nvi indexes.conf\n\n[myfirstindex]\ncoldPath= $SPLUNK_DB/myfirstindex/colddb\nenableDataIntegrityControl=1\nenableTsidxReduction=0\nhomePath=$SPLUNK_DB/myfirstindex/db\nmaxTotalDataSizeMB=512000\nthawedPath=$SPLUNK_DB/myfirstindex/thaweddb\narchiver.enableDataArchive=0\nbucketRebuildMemoryHint=0\ncompressRawdata = 1\nenable0nlineBucketRepair = 1\nminHotIdleSecsBeforeForceRoll=0\nrtRouterQueueSize =\nrtRouterThreads =\nselfStorageThreads =\nsuspendHotRollByDeleteQuery=0\nsyncMeta = 1\ntsidxWritingLevel =\n\n\n[oslogs]\ncoldPath=$SPLUNK_DB/oslogs/colddb\nenableDataIntegrityControl=1\nenableTsidxReduction=0\nhomePath=$SPLUNK_DB/oslogs/db\nmaxTotalDataSizeMB=512000\nthawedPath=$SPLUNK_DB/oslogs/thaweddb\n</code></pre> <pre><code>cd /opt/splunk/bin\n./splunk btool indexes list oslogs --debug | grep frozen\n\n/opt/splunk/etc/system/default/indexes.conf  frozenTimePeriodInSecs = 188697600\n</code></pre> <ul> <li>Review location and contents of fishbucket</li> </ul> <pre><code>cd fishbucket/\n/opt/splunk/var/lib/splunk/fishbucket/splunk_private_db/\n\n$ ls -lrt\nsnapshot\nbtree_index.dat\nbtree_records.dat\n</code></pre> <ul> <li>Reset fishbucket to re-index data</li> </ul> <pre><code>index=oslogs source=\"/var/log/apt/history.log\" \"Commandline: apt-get install -y --no-install-recommends python-pip\"\n</code></pre> <pre><code>index=slogs source=\"/var/log/apt/history.log\" \"Commandline: apt-get install -y --no-install-recommends python-pip\" | convert ctime\n(_indextime) AS Indextime | table Indextime,_time,_raw\n</code></pre> <pre><code>index=oslogs source=\"/var/log/apt/history.log\" \"Commandline: apt-get install -y --no-install-recommends python-pip\" | convert ctime\n(_indextime) AS Indextime | search Indextime = \"12/31/2019 12:21:57\"\n</code></pre> <pre><code>$rm -rf fishbucket/\ncd /opt/splunk/bin\n\nopt/splunk/bins./splunk restart\n</code></pre> <ul> <li>Deleting events from an Index</li> </ul> <p>The user must have can_delete capability to execute the delete command</p> <pre><code>index=oslogs source=\"/var/log/apt/history.log\" \"Commandline: apt-get install -y --no-install-recommends python-pip\" | convert ctime\n(_indextime) AS Indextime | search Indextime = \"12/31/2019 12:21:57\"  | delete\n</code></pre> <p></p> <ul> <li>Use monitoring console to monitor indexes</li> </ul> <p></p>"},{"location":"spl1/2config_indexes/#course-summary","title":"Course Summary","text":"<ul> <li>Licensing options and handling license violations</li> <li>Configuration files layering and precedence</li> <li>Using btool to troubleshoot</li> <li>Creating and tuning Splunk indexes</li> <li>Various Splunk data buckets</li> <li>Configuring a data retention policy</li> <li>Managing Splunk indexes</li> </ul>"},{"location":"spl1/3datamgt_forwarder/","title":"3 Managing Data and Forwarders","text":""},{"location":"spl1/3datamgt_forwarder/#1-getting-data-into-splunk","title":"1 Getting Data into Splunk","text":"<ul> <li>Understanding Splunk inputs</li> <li>Uploading data into Splunk</li> <li>Working with sourcetypes</li> <li>Understanding the phases of indexing</li> <li>Index-time vs. search-time precedence</li> </ul>"},{"location":"spl1/3datamgt_forwarder/#1-1-understanding-splunk-inputs","title":"1-1 Understanding Splunk Inputs","text":"<p>Splunk Enterprise Data Administrator Tasks</p> <ul> <li>Create and manage inputs for universal/heavy forwarders</li> <li>Manage parsing of data including line-breaking and timestamp extraction</li> <li>Design and establish new ingestion pipelines</li> <li>Manage Splunk configuration files deployment</li> <li>Collaborate with users on data on-boarding</li> </ul> <p>Splunk Enterprise Systems Administrator Tasks</p> <ul> <li>Install Splunk Software</li> <li>Create and Manage Indexes</li> <li>Manage Splunk Licenses</li> <li>Configure Security</li> <li>Monitor Splunk and respond to Monitoring Console Alerts</li> </ul> <p></p> <p>On the left side, we have the client systems. </p> <ul> <li>This could be applications, network devices or operating systems. They generate logs and other metrics.</li> <li>The Splunk universal forwarder, being the most common way of collecting data in Splunk, reads data from the log files and then sends them to the indexers using TCP. </li> <li>The data can be encrypted optionally. </li> </ul> <p>The indexer receives data, parses them, and stores them in index files. </p> <p>The search head is the entry point for the user. He uses a search head to log onto Splunk via a web interface and then uses a specialized query language, Search Processing Language, to query the data. </p> <p>Ingest Any Text Data from Anywhere</p> <ul> <li>Authentication</li> <li>Audit</li> <li>Middleware</li> <li>OS </li> <li>OS Performance</li> <li>Network device</li> <li>Network packets</li> <li>Web Server</li> </ul> <ul> <li>Sensors</li> <li>IoT Devices</li> <li>Database</li> <li>Messaging Systems</li> <li>CI/CD</li> <li>Automation </li> <li>programs</li> <li>Mail Server</li> <li>LDAP Server</li> </ul> <ul> <li>Active Directory</li> <li>Containers</li> <li>Kubernetes/Contain</li> <li>er Orchestration</li> <li>Applications</li> <li>API</li> <li>Event viewer</li> <li>Mobile devices</li> <li>Call Detail record</li> </ul> <p>Data Inputs</p> <ul> <li>A data source configured to send data to Splunk</li> <li>Data inputs send data to Splunk Indexers where the data is parsed and indexed</li> <li>During indexing, stream of data from the input is transformed to searchable events</li> </ul> <p>Indexing Flow</p> <p></p> <ul> <li> <p>The universal forwarder is the data input. </p> <ul> <li>It uses <code>inputs.conf</code> as the primary configuration file to determine the behavior of the inputs. </li> <li>Data is collected from the source. </li> <li>In most cases, these are the log files on the client systems. </li> </ul> </li> <li> <p>The data is then sent to the indexer. </p> <ul> <li>That's where the parsing happens. </li> <li>During parsing and indexing, props.conf and transforms.conf, two important configuration files, are utilized by Splunk. </li> </ul> </li> <li> <p>Finally, the data is written to the disk. </p> <ul> <li>The data streams that originate at the input are simply transformed into searchable events and written to disk on the indexers. </li> </ul> </li> </ul> <p>Types of Data Inputs</p> <ul> <li>Files and folders\uff1a Monitor text files</li> <li>TCP/UDP\uff1a Receive data on a TCP/UDP port Files and folders</li> <li>HTTP\uff1a Receive data on a HTTP listener</li> <li>Scripted input\uff1a Ingest output of a script</li> <li>Windows input\uff1a Windows event logs and perfmon data</li> <li>Add-ons\uff1a Custom apps from Splunkbase</li> <li>Splunk Web\uff1a Upload data directly from browser</li> <li>CLI\uff1a Command line interface</li> <li>Modular inputs\uff1a Custom input by extending Splunk</li> <li>FIFO\uff1a First in First out Queues</li> </ul> <p>Input Phase</p> <p>Data is read from the source</p> <ul> <li>Data is handled as streams</li> <li>Configuration settings are applied to entire stream</li> <li>Similar to unix tail</li> </ul> <p>Universal Forwarder is the most common input process</p> <ul> <li>Universal Forwarder keeps track of the read process</li> <li>Metadata such as source, host and sourcetypes are added</li> <li>Additional configuration such as compression and encryption are applied</li> </ul> <p>Let's say if the universal forwarder restarts for some reason, either because a server is rebooted or because a server crashed, you don't want the universal forwarder to reread all the data that it had already ingested.</p> <p>So universal forwarder has a very neat mechanism called fishbucket, using which it's going to keep track of the data that it ingests. </p>"},{"location":"spl1/3datamgt_forwarder/#1-2-working-with-sourcetypes","title":"1-2 Working with Sourcetypes","text":"<p>Why Upload Data into Splunk?</p> <ul> <li>Test the data for any parsing errors before onboarding</li> <li>Ability to try various regular expressions for line-breaking and timestamp extractions</li> </ul> <p>Splunk provides a great data upload wizard, using which you can catch parsing issues before you actually ingest them into the platform.</p> <ul> <li>Explore various input options such as sourcetype and host</li> </ul> <p>Uploading Data: Workflow</p> <p>Here is the workflow of how you will get data into Splunk. </p> <p></p> <p>Types of Data You Can Upload</p> <ul> <li>Any kind of text files (Example: Logs, CSV files)</li> <li>Splunk automatically recognizes many standard log files such as apache web access logs and mysqld log</li> <li>You can even upload zip files. Splunk will unzip and upload</li> <li>Make sure the data in the files have valid timestamps</li> </ul> <p>Parsing Options</p> <p></p> <p>Input Options</p> <p></p>"},{"location":"spl1/3datamgt_forwarder/#1-3-working-with-sourcetypes","title":"1-3 Working with Sourcetypes","text":"<p>Sourcetypes</p> <ul> <li>Splunk uses sourcetypes to categorize data</li> <li>Splunk comes with may pretrained sourcetypes</li> <li>Can be used while searching to filter data</li> <li>Defined in <code>props.conf</code> on the indexer or heavy-forwarder</li> <li>Automatically assigned by Splunk, or explicitly assigned by data administrator</li> </ul> <p>Using Sourcetype in Search</p> <p></p> <p><code>index=main sourcetvoe=vendor_sales</code></p> <p><code>LINE_BREAKER</code> and <code>TIME_FORMAT</code> are the two most important parameters in <code>props.conf</code></p> <p></p> <p>Assigning Sourcetype in SplunkWeb</p> <p></p> <p>Pretrained Sourcetypes</p> <ul> <li>Splunk automatically recognizes many log files</li> <li>Splunkbase apps can add new sourcetypes</li> <li>Examples<ul> <li><code>linux_messages_syslog</code></li> <li><code>access_combined</code></li> </ul> </li> <li>List of pretrained sourcetypes at https://docs.splunk.com</li> </ul> <p>https://docs.splunk.com/Documentation/Splunk/8.0.3/Data/Listofpretrainedsourcetypes</p> <p>Do not configure excessive number of sourcetypes</p> <p>Splunk environments, do not exceed 200 sourcetypes, but for larger Splunk environments, when I say larger I mean at least 50 plus indexers</p>"},{"location":"spl1/3datamgt_forwarder/#1-4-understanding-the-phases-of-indexing","title":"1-4 Understanding the Phases of Indexing","text":"<p>Three Phases of Indexing</p> <p></p> <p>Input phase: forwarders</p> <ul> <li>Data is read from data sources such as files and network</li> <li>Metadata such as host,source and sourcetype are app</li> <li>Most configuration in inputs.conf (some in props.conf)</li> <li>Operates on the entire data stream</li> </ul> <p>Parsing phase</p> <ul> <li>Data is broken into events</li> <li>Timestamp extracted</li> <li>Most configuration in props.conf (some in transforms.conf)</li> <li>Operates on individual events</li> <li>Event level transformations</li> </ul> <p>Indexing phase</p> <ul> <li>Segment events that then can be searched</li> <li>Build index</li> <li>License meter runs before the data is written to disk</li> <li>Raw data and index files are written to disk (data buckets)</li> </ul> <p>Data Pipelines</p> <p>Screenshot from Splunk monitoring console</p> <p></p> <p>Roles of Data Pipelines</p> <ul> <li>Parsing pipeline  / Character encoding / Line breaking</li> <li>Merging pipeline / Timestamp extraction / Merge multi-line events</li> <li>Indexing pipeline / Indexing</li> </ul>"},{"location":"spl1/3datamgt_forwarder/#1-5-index-time-vs-search-time-precedence","title":"1-5 Index-time vs. Search-time Precedence","text":"<p>Index-time and Search-time</p> <ul> <li>Index-time\uff1a Global context, such as input/parsing configuration</li> <li>Search-time\uff1a App/User scoped, such as a user\u2019s knowledge objects</li> </ul> <p>Why Learn About Precedence?</p> <ul> <li>Splunk's behavior is primarily determined by configuration files</li> <li> <p>Multiple copies of the same configuration file can be in different directories</p> </li> <li> <p>Configuration files are managed using a location-based priority scheme</p> </li> <li>During runtime Splunk merges the contents of all copies of a configuration file</li> <li>Conflicts are resolved by the precedence of the configuration file</li> </ul> <p>Btool is an excellent tool to retrieve the configuration file contents.</p> <p>Index-time Precedence</p> <p></p> <ul> <li><code>etc/system/local</code>is given the highest priority. </li> <li><code>etc/apps/search/local</code> followed by <code>etc/apps/app1/local</code>. (This can be any app)</li> <li><code>etc/apps/search/default</code> and then <code>etc/apps/app1/default</code>. </li> </ul> <p>If two are more apps have conflicting settings, app  directory name with highest  ASCII order wins</p> <p>What about search time?</p> <p></p> <p>Search-time Precedence</p> <p></p>"},{"location":"spl1/3datamgt_forwarder/#1-6-demo","title":"1-6 Demo","text":"<ul> <li>Examine existing data inputs</li> <li>Upload data into Splunk</li> <li>Configure input options</li> <li>Create a new sourcetype while uploading data</li> <li>Review phases of indexing in monitoring console</li> </ul> <p>Available data inputs in Splunk. You go to Settings, Data inputs</p> <p></p> <p><code>var/log/splunk</code> directory contains the platform\u2011level logs</p> <p><code>$SPLUNK_HOME/var/log/splunk</code></p> <p></p> <p></p>"},{"location":"spl1/3datamgt_forwarder/#add-data","title":"Add data","text":"<p>Select Source</p> <p>https://docs.splunk.com/Documentation/Splunk/8.0.3/SearchTutorial/Systemrequirements#Download_the_tutorial_data_files</p>"},{"location":"spl1/3datamgt_forwarder/#create-index","title":"Create index","text":"<p><code>index=main sourcetype=vendor_sales</code></p> <p></p> <p>Source</p> <p></p> <p>Create source type</p> <p></p> <p></p> <p>how the data ingestion pipeline works.</p> <p>Click <code>Indexing</code>, <code>Performance</code>, <code>Indexing Performance: Instance</code></p> <p></p> <p></p> <p></p>"},{"location":"spl1/3datamgt_forwarder/#summary","title":"Summary","text":"<ul> <li>Inputs read data from the source and stream them to Indexers</li> <li>Data flows through input, parsing and indexing phases</li> <li>Inputs.conf, props.conf and transforms.conf govern the ingestion behavior</li> <li>Event level transformations can be done during indexing</li> <li>Create custom sourcetypes if Splunk\u2019s pre-trained sourcetypes don\u2019t meet your needs</li> </ul>"},{"location":"spl1/3datamgt_forwarder/#2-configure-splunk-forwarders","title":"2 Configure Splunk Forwarders","text":"<ul> <li>Determining appropriate forwarder type to use</li> <li>Installing and running universal forwarder</li> <li>Setting up forwarding</li> <li>Adding input to universal forwarder</li> <li>Implementing forwarder options</li> <li>Troubleshooting universal forwarders</li> </ul> <pre><code>Creating a Splunk universal forwarder using docker\n--------------------------------------------------\n\n$ docker pull splunk/universalforwarder\n\n$ docker run -d --name uf1 -h uf1 -e \"SPLUNK_START_ARGS=--accept-license\" -e \"SPLUNK_PASSWORD=splunkRocks\" splunk/universalforwarder\n\n9ec532c2ab1e0e3082bd0f84bc12a5fef9dc26b8c8e416ceeb4cb6ee713f2db7\n\n[splunk@a1f4e45f7102 bin]$ ./splunk status\nsplunkd is running (PID: 730).\nsplunk helpers are running (PIDs: 731).\n</code></pre>"},{"location":"spl1/3datamgt_forwarder/#2-1-splunk-forwarders","title":"2-1 Splunk Forwarders","text":"<p>Splunk forwarder is an instance of Splunk that collects and forwards data to another Splunk instance, most commonly to an indexer</p> <p>Data Flow</p> <p></p> <ul> <li>Data is read from the source</li> <li>Data streams are transformed into searchable events and written to disk</li> </ul> <p>Two Types of Forwarders</p> <ul> <li> <p>Universal Forwarder</p> <ul> <li>Installed on the source hosts to collect and send data to Splunk indexers or heavy forwarders</li> </ul> </li> <li> <p>Heavy Forwarder</p> <ul> <li>Sits between universal forwarders and indexers. Parses data before sending to indexers</li> </ul> </li> </ul> <p>Universal Forwarder</p> <ul> <li>Stripped down version of Splunk enterprise binary</li> <li>High performance, low footprint and production-ready</li> <li>Does not parse data (Exception: Structured files such as CSV files)</li> </ul> <p>When parsing is done by the forwarder side, props.conf resides on the forwarder</p> <ul> <li>By default 256 KBps output bandwidth (can be increased in <code>limits.conf</code>)</li> </ul> <p>On the indexer side, maxKBps is set to 0 by default, which is unlimited</p> <ul> <li>Built in, no-limit license</li> </ul> <p>Heavy Forwarder</p> <ul> <li>Splunk enterprise binary with indexing turned off</li> <li>Indexing can be optionally turned on</li> <li>Parses data before forwarding to indexer or other third-party  receivers</li> </ul> <p>Indexer will ignore props.conf entries for a sourcetype/source/host when data flows through heavy forwarder</p> <ul> <li>Requires forwarder license</li> <li>Generally used as intermediary between universal forwarder and indexers</li> </ul> <p>Universal Forwarder vs. Heavy Forwarder</p> <ul> <li> <p>Universal Forwarder</p> <ul> <li>Reads data from source and forwards to indexers or heavy forwarders</li> <li>Splunk universal forwarder binary</li> <li>Does not parse data except for structured data such as CSV</li> <li>Does not index data</li> <li>Built-in license</li> </ul> </li> <li> <p>Heavy Forwarder</p> <ul> <li>Receives data from universal forwarders and forwards to indexers</li> <li>Splunk enterprise binary</li> <li>Parses data before sending to indexers</li> <li>Can optionally index data</li> <li>Splunk forwarder license required</li> </ul> </li> </ul> <p>Three Use Cases of Heavy Forwarders</p> <ul> <li>Parse and Route</li> </ul> <p>Parse data before sending to indexers</p> <ul> <li>Firewall rule simplification</li> </ul> <p>When indexers are behind firewall, a rule is required to allow just the heavy forwarder</p> <ul> <li>Hosting Splunk Add-ons Add-ons like</li> </ul> <p>DBConnect and HTTP Event collectors can be hosted in heavy forwarders</p> <p>A Note About Light Forwarder</p> <ul> <li>Light forwarders have been deprecated since Splunk version 6.0</li> <li>Light forwarders were configured on Splunk Enterprise instances</li> <li>Universal forwarders are the recommended replacements for light forwarders</li> </ul>"},{"location":"spl1/3datamgt_forwarder/#2-2-installing-and-running-universal-forwarders-installing-and-running-universal-forwarders","title":"2-2 Installing and Running Universal Forwarders Installing and Running Universal Forwarders","text":"<p>Supported Platforms</p> <p>Linux / Windows / Mac OS / Solaris / AIX / Free BSD</p> <p>You can add universal forwarder install steps in Dockerfile using entrypoint.sh</p> <p>Installing Universal Forwarder in Unix</p> <ul> <li>Download the tar ball and unzip at the desired location</li> <li>Install universal forwarder in a separate file system (example: /opt/splunkforwarder)</li> <li>The command splunk is located in <code>SPLUNK_HOME/bin</code> that can be </li> <li>used to start/stop universal forwarder</li> <li>The default admin password is changeme,and should be changed</li> <li>Employ configuration management tools such as ansible or puppet</li> </ul> <p>Installing Universal Forwarder in Windows</p> <ul> <li>You can use MSI install wizard or msiexec.exe command line</li> <li>Can be installed as a domain user (administrator privilege not required)</li> <li>Use msiexec.exe with <code>/quite</code> and <code>AGREETOLICENSE=yes</code> for complete silent install </li> <li>Can enable windows event logs and perfmon ingestion </li> <li>(recommended)</li> <li>Runs as a Windows service</li> </ul> <p>Avoid installing more than one instance of forwarder in a host.</p>"},{"location":"spl1/3datamgt_forwarder/#2-3-setting-up-forwarding","title":"2-3 Setting up Forwarding","text":"<ul> <li>Step 1</li> </ul> <p>Setup receiving on the indexer(s). Primary configuration  file is inputs.conf</p> <ul> <li>Step 2</li> </ul> <p>Setup forwarding on the universal forwarders. Primary  configuration file is outputs.conf</p> <p>Setting up Receiving</p> <ul> <li>Setup on the indexer(s) using Splunk Web gui, command line or <code>inputs.conf</code></li> <li>Must be done before forwarders can send data</li> <li>Using GUI: <code>Settings -&gt; Forwarding</code> and <code>Receiving -&gt; Configure receiving</code></li> <li>Command line: <code>splunk enable listen &lt;port&gt;</code><ul> <li>Default port is 9997. You can pick any available port</li> </ul> </li> </ul> <p>Using Splunk Web to Setup Receiving</p> <p></p> <p>Using Command Line to Setup Receiving On the Indexer</p> <p>Commands</p> <pre><code>$ cd $SPLUNK_HOME/bin\n$ ./splunk enable listen 9997\nListening for Splunk data on TCP \nport 9997.\n\n$ netstat \u2013an | grep 9997\ntcp4 0 0 *.9997 \n*.* LISTEN\n</code></pre> <p>Resulting <code>inputs.conf</code></p> <pre><code>[splunktcp://9997]\nconnection_host = dns\n# The connection_host parameter is used if the forwarder does not \nset the hostname. The default is dns where receiver will do a reverse dns lookup to find the host name of the forwarder.\n</code></pre> <p>Setting up Forwarding</p> <ul> <li>On the forwarders, use command line or <code>outputs.conf</code> to set up forwarding</li> <li>Command line: <code>./splunk add forward-server &lt;Receiver ip host:port&gt;</code> <ul> <li><code>./splunk add forward-server 192.168.0.11:9997</code></li> </ul> </li> <li>You can edit <code>outputs.conf</code> directly to add forwarding</li> </ul> <p>Using Command Line to Setup Forwarding (On the Forwarder)</p> <ul> <li>Commands</li> </ul> <pre><code>$ cd $SPLUNK_HOME/bin\n\n$ ./splunk add forward-server 192.168.0.11:9997\n\nAdded forwarding to: 192.168.0.11:9997.\n\n$ ./splunk list forward-server\n\nActive forwards: 192.168.0.11:9997\n\nConfigured but inactive forwards:None\n</code></pre> <ul> <li>Resulting outputs.conf</li> </ul> <pre><code>[tcpout]\ndefaultGroup = default-autolbgroup\n\n[tcpout:default-autolb-group]\nserver = 192.168.0.11:9997\n\n[tcpoutserver://192.168.0.11:9997]\n</code></pre>"},{"location":"spl1/3datamgt_forwarder/#2-4-adding-inputs-to-the-universal-forwarder","title":"2-4 Adding Inputs to the Universal Forwarder","text":"<p>Four Ways to Add Inputs</p> <ul> <li>Using deployment server to distribute inputs.conf</li> <li>Using Splunk command line</li> <li>Editing inputs.conf manually</li> <li>Using Splunk add-ons</li> </ul> <p>Using Command Line to Add Input \uff08On the Forwarder\uff09</p> <p>Commands</p> <pre><code>$ SPLUNK_HOME/bin/splunk add monitor /.../Logs/fsck_hfs.log\n\nAdded monitor of '/Users/karun/Library/Logs/fsck_hfs.log\u2019\n\n# inputs.conf\n[monitor:///Users/karun/Library/Logs/fsck_hfs.log]\n\ndisabled = false\n</code></pre> <p><code>inputs.conf</code> has been created in 'search' app at<code>$PLUNK_HOME/etc/apps/search/local/inputs.conf</code>.</p> <p>Verifying with btool</p> <pre><code>./splunk btool inputs list monitor:///Users/karun/Library/Logs/fsck_hfs.log\n\n[monitor:///Users/karun/Library/Logs/fsck_hfs.log] \n\n_rcvbuf = 1572864\ndisabled = false\nhost = Mac.local\nindex = default\n</code></pre> <pre><code>[monitor:///Users/karun/Library/Logs/fsck_hfs.log] \n\nhost = Mac.local\nindex = default\nsourcetype = mac:system:fsck_log\n_TCP_ROUTING = default-autolbgroup\nblacklist = *trace.log\n</code></pre> <ul> <li>File or directory to be monitored. For directory inputs, all files in all subdirectories included (recursive)<ul> <li>Use <code>recursive = false</code> in <code>inputs.conf</code> to disable recursion.</li> </ul> </li> <li>Host name to use for events from this input</li> <li>Index name. The index must exist</li> <li>Sourcetype to use for events from this input</li> <li>Tcpout group to send data to, as specified in <code>outputs.conf</code></li> <li>Files to exclude from monitoring</li> </ul> <p>Location of inputs.conf</p> <ul> <li>Splunk uses a framework of layered configuration files.</li> <li>Precedence of configuration is determined by the directory location.</li> <li>In practice, <code>inputs.conf</code> is bundled in an app and distributed using deployment server.</li> </ul> <p>Configuration file precedence under <code>$SPLUNK_HOME</code></p> <ul> <li><code>etc/system/local</code> </li> <li><code>etc/apps/search/local</code></li> <li><code>etc/apps/&lt;appname&gt;/local</code></li> <li><code>etc/apps/search/default</code></li> <li><code>etc/apps/&lt;appname&gt;/default</code></li> <li><code>etc/system/default</code></li> </ul> <pre><code>./splunk btool inputs list monitor: ///Users/karun/Library/Logs/fsck_hfs.log --debug\n</code></pre>"},{"location":"spl1/3datamgt_forwarder/#2-5-additional-forwarder-configuration-options","title":"2-5 Additional Forwarder Configuration Options","text":"<p>Fine Tuning Forwarders</p> <ul> <li>Forward data selectively to multiple indexers</li> <li>Load balance forwarding across indexers</li> <li>Configure compression</li> <li>Configure SSL</li> <li>Buffering (Queueing)</li> <li>Indexer acknowledgement</li> </ul> <p>Forward Data Selectively to Multiple Indexers</p> <ul> <li>Define two tcpout destinations in outputs.conf</li> <li>Use <code>_TCP_ROUTING</code> in inputs.conf to selectively send data</li> </ul> <p>outputs.conf</p> <pre><code>[tcpout:security]\nserver = sec_indexer:9997\n\n[tcpout:sre]\nserver = sre_indexer:9997\n</code></pre> <p>inputs.conf</p> <pre><code>[monitor:///logs/audit.log]\n_TCP_ROUTING = security\n\n[monitor:///logs/error.log]\n_TCP_ROUTING = sre\n</code></pre> <p>Automatic Load Balancing</p> <ul> <li>Specify a list of indexers in the server list in <code>outputs.conf</code></li> <li>Every 30 seconds, forwarder will randomly select an available indexer from the list</li> <li>Frequency can be updated using autoLBFrequency setting (not recommended)</li> </ul> <p>outputs.conf</p> <pre><code>[tcpout:indexers]\nserver = idx1:9997,idx2:9997,idx3:9997\n</code></pre> <p>Automatic Load balancing is required for distributed search to be effective</p> <p>autoLBFrequency is set in outputs.conf</p> <p>Enabling Compression</p> <ul> <li>Enable compression on both indexer and forwarder</li> <li>Reduces network traffic, but slightly increases CPU usage</li> </ul> <p><code>outputs.conf</code> on the forwarder</p> <pre><code>[tcpout:indexer]\nserver = my_indexer:9997\ncompressed = true\n</code></pre> <p><code>nputs.conf</code> on the my_indexer</p> <pre><code>[splunktcp:9997]\ncompressed = true\n</code></pre> <p>Configuring SSL</p> <ul> <li>Enabling SSL automatically enables compression</li> <li>Can increase CPU usage</li> </ul> <p>outputs.conf on the forwarder</p> <pre><code>[tcpout:indexer]\n\nserver = my_indexer:9997\nclientCert = clientcert.pem\nsslRootCAPath = cacert.pem\nsslPassword = &lt;password&gt;\n</code></pre> <p>inputs.conf on the <code>my_indexer</code></p> <p>Solunk's default SSL certificates password \"password'</p> <pre><code>[splunktcp-ssl:9997]\n\nserverCert = mycert.pem\nsslPassword = &lt;password&gt;\nrootCA = cacert.pem\n</code></pre> <p>Splunk's default SSL certificates password is \"Password\"</p> <p>Configuring Queueing</p> <ul> <li>Configure maxQueueSize in <code>outputs.conf</code> to enable queueing</li> <li>Default is 500kb when useACK is false. 7MB when useACK is true</li> <li>When load balancing is enabled, queueing occurs only when all  indexers are not available</li> </ul> <p>Configuring Indexer Acknowledgement</p> <ul> <li>Ensures data is received by indexers</li> <li>Protects against data loss</li> <li>Forwarder resends data not acknowledged by indexer</li> <li>A wait queue is created with 3X size of maxQueueSize</li> <li>Enabaled by using <code>useACK = true</code> in <code>outputs.conf</code></li> </ul>"},{"location":"spl1/3datamgt_forwarder/#2-6-demo","title":"2-6 Demo","text":"<p>Download Splunk Universal Forwarder 9.0.4</p> <p>https://www.splunk.com/en_us/download/universal-</p> <pre><code>ls splunkforwarder-8.0.4-767223ac207f-darwin-64.tgz\nsplunkforwarder-8.0.4-767223ac207f-darwin-64.tgz\n\ncd /opt\n/opt $ tar xvzf ~/Downloads/splunkforwarder-8.0.4-767223ac207f-darwin-64.tgz\n\n/opt/splunkforwarder $ cd bin\n/opt/splunkforwarder/bin $ ./splunk start --accept-license\n\nPlease enter an administrator username: admin\nPassword must contain at least:\n* 8 total printable ASCII character(s).\nPlease enter a new password:\n\n/opt/splunkforwarder/bin $ ./splunk status\n\nsplunkd is running (PID: 16282).\nsplunk helpers are running (PIDs: 16285)\n</code></pre> <ul> <li>Configuire Indexer</li> </ul> <pre><code>~/platform/splunk/bin \n\n./splunk display listen\nReceiving is disabled\n</code></pre> <p>Add Forward and Receiving Data via commmand line</p> <p></p> <p></p> <p></p> <pre><code>~/platform/splunk/bin $ ./splunk enable listen 9997\nListening for Splunk data on TCP port 9997.\n\n~/platform/splunk/bin $ netstat -an | grep 9997\ntcp4 0. 0.  *.9997.  *. * LISTEN\n\n~/platform/splunk/bin $ ./splunk btool inputs list\n...\n[splunktcp://99977\nrevbuf = 1572864\nconnection_host = ip\nhost = Mac.local\nindex = default\n...\n\n./splunk btool inputs list splunktcp://9997 --debug\n\n/Users/karun/platform/splunk/etc/apps/search/local/inputs.conf [splunktcp://9997]\n/Users/karun/platform/splunk/etc/system/default/inputs.conf revbuf = 1572864\n/Users/karun/platform/splunk/etc/apps/search/local/inputs.conf connection_host = ip\n/Users/karun/platform/splunk/etc/system/local/inputs.conf host = Mac.local\n/Users/karun/platform/splunk/etc/system/default/inputs.conf index= default\n</code></pre> <ul> <li>Universal Forwarder</li> </ul> <pre><code>docker pull splunk/universalforwarder\n\ndocker exec -u splunk -it uf1 /bin/bash\n\n[splunk@uf1 splunkforwarder]$ cd bin\n[splunk@uf1 bin]$ ./splunk list forward-server\n\n[splunk@uf1 bin]$ ./splunk list forward-server\nActive forwards:\nNone\nConfigured but inactive forwards:\nNone\n\n[splunk@uf1 bin]$ ./splunk add forward-server 192.168.0.11:9997\nAdded forwarding to: 192.168.0.11:9997.\n\n[splunk@uf1 bin]$ ./splunk btool outputs list\n...\n[tcpout-server://192.168.0.11:9997]\n[tpout: default-autolb-group]\nserver = 192.168.0.11:9997\n...\n\n</code></pre> <p><code>index=_internal host=uf1</code></p> <p></p> <p>Source type</p> <p></p> <pre><code>$ docker exec -u splunk -it uf1 /bin/bash\n[splunk@uf1 splunkforwarder]$ cd bin\n[splunk@uf1 bin]$ ./splunk add monitor /opt/container_artifact/ansible.log\n\nYour session is invalid.\nSplunk username: admin\nAdded monitor of '*/opt/container_artifact/ansible.log'\n</code></pre> <p>Do not use <code>index=*</code> in your production environment as it might consume excessive resources</p> <p><code>index=* host=uf1 source=*ansible*</code></p> <p></p> <pre><code>[splunk@uf1 splunkforwarder]$ cd bin\n[splunk@uf1 bin]$ ./splunk btool inputs\n\n...\n[monitor:///opt/container_artifact/ansible.log]\nf_revbuf = 1572864\ndisabled = false\nhost = $decideOnStartup\nindex = default\n...\n\n\n[splunk@uf1 bin]$ ./splunk btool inputs list monitor: ///opt/container_artifact/ansible.log --debug\n\n/opt/splunkforwarder/etc/apps/search/local/inputs.conf [monitor:///opt/container_artifact/ansible.log]\n/opt/splunkforwarder/etc/system/default/inputs.conf _rcvbuf = 1572864\n/opt/splunkforwarder/etc/apps/search/local/inputs.conf disabled = false\n/opt/splunkforwarder/etc/system/default/inputs.conf host = $decideOnStartup\n/opt/splunkforwarder/etc/system/default/inputs.conf i\nndex = default\n\n\n[splunk@uf1 bin]$ vi /opt/splunkforwarder/etc/apps/search/local/inputs.conf\n\n[monitor:///opt/container_artifact/ansible.log]\ndisabled = false\n\n# Adding inputs for watchdog.log\n[monitor:///opt/container_artifact/ansible.log]\ndisabled = false\nindex = main\nsourcetype = splunk:watchdog_log\n\n[splunk@uf1 bin]$ ./splunk restart\n</code></pre> <p><code>index=* source=*watchdog.log*</code></p> <p></p> <p></p> <p><code>Update $PLUNK HOME/etc/system/local/outputs.conf</code></p> <pre><code>[splunk@uf1 splunkforwarder]$ cd etc/system/local\n\n[indexAndForward]\nindex = false\n[tcpout]\ndefaultGroup = default-autolb-group\n\n[tcpout:default-autolb-group]\nserver = 192.168.0.11:9997\nuseACK = true\n\n[tcpout server: //192.168.0.11:9997]\n</code></pre> <p><code>index=_internal host=uf1 ack</code></p> <p></p> <pre><code>[splunk@uf1 splunkforwarder]$ cd bin\n[splunk@uf1 bin]$ ./splunk status\nsplunkd is running (PID: 54057).\nsplunk helpers are running (PIDs: 54058)\n\n[splunk@uf1 bin]$ ps -ef | grep splunk\n\nsplunk 54057 0 0 13:44 ? 00:00:01 splunkd -p 8089 restart\n\n/splunk btool outputs list\n</code></pre> <p>Summary</p> <ul> <li> <p>Most common way to send data to Splunk is using universal forwarders</p> </li> <li> <p>Use heavy forwarders as intermediary between forwarders and indexers</p> </li> <li> <p>Heavy forwarders parse and optionally index data</p> </li> <li> <p>Major configuration files are inputs.conf and outputs.conf</p> </li> <li> <p>Forwarder configuration options include  SSL, queueing, load balancing and compression</p> </li> </ul>"},{"location":"spl1/3datamgt_forwarder/#3-manage-splunk-forwarders","title":"3 Manage Splunk Forwarders","text":"<ul> <li>Use of forwarder management</li> <li>Describe Splunk deployment server</li> <li>Use deployment apps</li> <li>Configure deployment clients</li> <li>Configure client groups using </li> <li>serverclasses</li> <li>Monitor forwarders</li> </ul>"},{"location":"spl1/3datamgt_forwarder/#3-1-use-of-forwarder-management","title":"3-1 Use of Forwarder Management","text":"<p>Why Forwarder Management?</p> <ul> <li>Centralized<ul> <li>Handle thousands of forwarders from one system</li> </ul> </li> <li>Distribute configuration files<ul> <li>Configuration files can be packaged as apps and distributed from a central place</li> </ul> </li> <li>Monitor forwarders<ul> <li>Monitor the availability of forwarders and restart them remotely</li> </ul> </li> </ul> <p>Forwarder Management in Practice</p> <ul> <li>For indexer infrastructure changes, forwarder's <code>outputs.conf</code> needs to be updated</li> <li>For changes in data sources, <code>inputs.conf</code> needs to be updated</li> <li>If a forwarder is down, we need to be alerted in a reasonable time</li> <li>We can take advantage of Splunk's configuration files layering to create custom apps and distribute</li> <li>Installing forwarders is generally done by configuration management tools such as ansible or puppet</li> </ul> <p>Forwarder management is implemented using Splunk deployment server, a tool to manage Splunk configuration files</p>"},{"location":"spl1/3datamgt_forwarder/#3-2-splunk-deployment-server","title":"3-2 Splunk Deployment Server","text":"<p>Splunk Deployment Server</p> <ul> <li>A tool to manage Splunk configuration files</li> <li>Splunk Enterprise License is required</li> <li>Can be accessed via Splunk Web</li> <li>Keep a dedicated server for deployment server</li> <li>Cannot be used for installing/upgrading forwarders</li> </ul> <p>Deployment Server Architecture</p> <p>Deployment Server   (1 - many)  Hosts with universal forwarders </p> <p>Deployment Server Architecture</p> <p></p>"},{"location":"spl1/3datamgt_forwarder/#3-3-deployment-app","title":"3-3 Deployment App","text":"<ul> <li>Mechanism to distribute configuration files to forwarders</li> <li>App must adhere to the standard Splunk app directory structure</li> <li>It can contain configuration files, scripts, views and other resources</li> <li>On the deployment server, apps are stored in <code>$SPLUNK_HOME/etc/deployment-apps</code></li> <li>On the forwarders, apps will be deployed in <code>$SPLUNK_HOME/etc/apps</code></li> </ul> <p>Sample App</p> <p></p> <p>Setting up Deployment Server</p> <ul> <li>Create at least one app in <code>$SPLUNK_HOME/deploymentapps/</code></li> <li>Forwarder management UI is not activated until a  deployment app is found</li> </ul> <p>Forwarder Management</p> <p>The forwarder management UI distributes deployment apps to Splunk clients. </p> <p>No clients or apps are currently available on this deployment server.</p> <p>Setting up Deployment Server</p> <p></p>"},{"location":"spl1/3datamgt_forwarder/#3-4-deployment-clients","title":"3-4 Deployment Clients","text":"<p>Setting up Deployment Clients</p> <ul> <li>Forwarders must be setup as deployment clients</li> <li>Primary configuration file is <code>deploymentclient.conf</code></li> </ul> <pre><code>Command\n\n$./splunk set deploy-poll 192.168.0.11:8089\nConfiguration updated.\n</code></pre> <p><code>deploymentclient.conf</code></p> <pre><code>[targetbroker:deploymentServer]\n\ntargetUri = 192.168.0.11:8089\n</code></pre> <p>Forwarder Management</p> <p></p> <p><code>Deploymentclient.conf</code> Customization</p> <p>Configuration</p> <ul> <li><code>targetUri = 192.168.0.11:8089</code> :  Must be under [targetbroker:deploymentServer] stanza. <ul> <li>Specifies deployment Server</li> </ul> </li> <li><code>clientName = myWebServer</code> : A custom name that can be used by deploymentServer in serverclass</li> <li><code>phoneHomeIntervalInSecs = 120</code> : How frequently the deployment server is checked for new content (default=60)</li> </ul>"},{"location":"spl1/3datamgt_forwarder/#3-5-setting-up-serverclasses","title":"3-5 Setting up Serverclasses","text":"<p>Serverclass</p> <ul> <li>Mechanism to group hosts (deployment clients) and designate the deployment apps to be deployed</li> <li>You can group hosts based on <code>dns/ip/client</code> name</li> <li>You can also group hosts based on the machine type</li> <li>Serverclasses are defined in serverclass.conf</li> <li>Wild cards allowed when specifying the host names</li> </ul> <p>Creating a Serverclass</p> <p></p>"},{"location":"spl1/3datamgt_forwarder/#3-6-monitoring-forwarders","title":"3-6 Monitoring Forwarders","text":"<p>Monitoring Forwarders</p> <ul> <li>Forwarder monitoring can be enabled from monitoring console (recommended)</li> <li>Periodically (15 minutes by default), using  internal logs from the forwarders, a forwarder asset table (lookup) is built</li> </ul> <p>The lookup table name is <code>dmc_forwarder_assets</code></p> <ul> <li> <p>We can monitor</p> </li> <li> <p>Forwarder state (active/missing)</p> </li> <li>Data throughput (kb/s)</li> <li>Events throughput (events/s)</li> </ul> <p>Monitoring Console</p> <p></p> <p>Rebuilding Forwarder Assets</p> <ul> <li>Monitoring console will mark a forwarder as missing if it has not reported in the past 15 minutes.</li> <li>To avoid decommissioned servers from being reported, you can rebuild the forwarder assets table</li> <li>This is a resource intensive process, so run it during off-peak hours</li> <li>Monitoring console &gt; Settings &gt; Forwarder Monitoring Setup &gt; Rebuild forwarder assets</li> </ul>"},{"location":"spl1/3datamgt_forwarder/#demo","title":"Demo","text":"<ul> <li>Configure deployment server<ul> <li>Create a deployment app</li> </ul> </li> <li>Configure deployment client</li> <li>Create a serverclass<ul> <li>Add apps</li> <li>Add clients</li> </ul> </li> <li>Deploy an app</li> <li>Monitor forwarders using monitoring console</li> </ul>"},{"location":"spl1/3datamgt_forwarder/#indexer","title":"Indexer","text":"<p>Create a deployment app</p> <pre><code>cd etc/deployment-apps\n\n/etc/deployment-apps &gt; cd /tmp\n\ncd /tmp &gt; tree acme-forwarder-limits\n\nacme-forwarder-limits\n|\n| _ default\n        \\_app. conf\n\\_local\n    \\_limits.conf\n\\_metadata\n    \\_default.meta\n\n3 directories, 3 files\n</code></pre> <pre><code>$ cat acme-forwarder-limits/default/app.conf\n[default]\n\n[install]\nstate = enabled\n\n$ cat acme-forwarder-limits/metadata/default.meta\n[]\naccess = read : [ * ], write:[ power, admin ]\n\n$ cat acme-forwarder-limits/local/limits.conf\n[thruput]\nmaxKBps = 2048\n</code></pre> <p>On the indexers, maxKBps is set to 0 (unlimited) by default</p> <pre><code>/etc/deployment-apps &gt;  cp -r /tmp/acme-forwarder-limits .\n\n/etc/deployment-apps &gt; ls\n\nREADME\nacme-forwarder-limits\n</code></pre> <p></p>"},{"location":"spl1/3datamgt_forwarder/#configure-deployment-client","title":"Configure deployment client","text":"<pre><code>docker exec -u splunk -it uf1 /bin/bash\n\n[splunk@uf1 splunkforwarder]$ cd bin\n[splunk@uf1 bin]$ pwd\n/opt/splunkforwarder/bin\n\n[splunk@uf1 bin]$ ./splunk set deploy-poll 192.168.0.11:8089\n\nYour session is invalid. Please login.\nSplunk username: admin\n\n[splunk@uf1 local]$ cat deploymentclient.conf\n[target-broker: deploymentServer]\ntargetUri=192.168.0.11:8089\n</code></pre> <p>deploymentclient.conf is created in <code>$SPLUNK_HOME/etc/system/local</code></p>"},{"location":"spl1/3datamgt_forwarder/#create-a-serverclass","title":"Create a serverclass","text":"<pre><code>$ cd ../../apps\n$ ll\n\nacme-forwarder-limits\n</code></pre> <p>Monitor forwarders using monitoring console</p> <p></p> <p></p> <p></p>"},{"location":"spl1/3datamgt_forwarder/#summary_1","title":"Summary","text":"<ul> <li>Deployment server manages the distribution of configuration files</li> <li>Forwarders are deployment clients (deploymentclient.conf)</li> <li>Configuration files are packaged as deployment apps</li> <li>Serverclass groups forwarders and assigns apps to be deployed (serverclass.conf)</li> <li>Monitoring console can monitor the availability and throughput of forwarders</li> </ul> <p>--</p> <ul> <li>Data goes through input, parsing and indexing phases</li> <li>Master inputs.conf, outputs.conf, props.conf, and serverclass.conf</li> <li>Heavy forwarders parse data and can be used to host add-ons</li> <li>Use deployment server to manage forwarders</li> </ul>"},{"location":"spl1/4config_ds/","title":"4 Splunk Administration: Configuring Distributed Search","text":""},{"location":"spl1/4config_ds/#1-understanding-distributed-search","title":"1 Understanding distributed search","text":"<ul> <li>Anatomy of a search</li> <li>Distributed search overview</li> <li>Search peers</li> <li>Knowledge bundle</li> <li>Knowledge bundle replication</li> </ul>"},{"location":"spl1/4config_ds/#1-1-anatomy-of-a-search","title":"1-1 Anatomy of a Search","text":"<p>The Splunk Platform</p> <p></p> <p>Standalone Splunk</p> <p></p> <p>Technically, this is known as inverted index</p> <p>Search Overview</p> <ul> <li>During indexing, Splunk indexers convert the machine data stream into searchable events which are stored in indexes</li> <li>Indexes contain compressed raw data (journal.gz) and time-series index files (TSIDX)</li> <li>Indexes store data in time-oriented buckets (hot, warm, cold and frozen)</li> <li>Indexers perform the search and return the results</li> <li>Search results and meta data are stored as search artifacts until the search job expires</li> </ul> <p>How Splunk Retrieves Data</p> <p></p> <ul> <li>Timeframe\uff1a Identify data buckets based on the time range</li> <li>Bloom Filter\uff1a Calculate bloom filter on base search and compare against  bucket\u2019s bloom filter</li> </ul> <p>Bloom Filter</p> <ul> <li>Bloom filter is a bit array created by running search terms through set of hashing algorithm</li> <li>Splunk creates a bloom filter for each bucket</li> <li>When a search is run, Splunk calculates the bloom filter for the base search, and compares with the bucket bloom filter</li> <li>Only the matching buckets are opened</li> <li>Having as many filtering terms as possible in the base search improves search performance</li> </ul> <p>Search Artifact</p> <ul> <li>Contains results and metadata</li> <li>Stored on <code>$SPLUNK_HOME/var/run/dispatch</code></li> <li>Deleted when the search job expires</li> <li>Each job has its own directory</li> <li>Too many search artifacts can cause performance degradation</li> </ul> <p>Contents of Dispatch Directory</p> <p></p> <p>Dispatch Directory Naming Convention</p> <p>Type of search</p> <ul> <li>Ad-hoc: Unix Time of the search. (1596904237.80)</li> <li>Saved search: <ul> <li><code>&lt;run by user&gt;__&lt;context_user&gt;__&lt;app&gt;__search (admin__admin__search__mysearch_ 1596904237.80)</code></li> </ul> </li> <li>Scheduled search<ul> <li><code>scheduler_nobody__web__mysearch__  1596904237.80</code></li> </ul> </li> <li>Remote search<ul> <li><code>remote_&lt;peer&gt;_&lt;search&gt;</code></li> </ul> </li> </ul> <p>Default Time To Live of Search Artifacts</p> <ul> <li>Ad-hoc : 10 minutes</li> <li>Manually invoked saved search: 10 minutes</li> <li>Scheduled search without alert action: Twice the scheduled period</li> <li>Scheduled search with email action: 24 hours</li> <li>Scheduled search with script action: 10 minutes</li> <li>Scheduled search with summary indexing action   2 minutes</li> </ul> <p>Changing the TTL</p> <ul> <li>Global search behavior can be updated in limits.conf using ttl or <code>remote_ttl</code> parameters under search stanza</li> <li>Individual sched searches can override TTL using <code>savedsearches.conf</code> or using Splunk Web</li> <li>Alert actions can override TTL using <code>alert_actions.conf</code> or using Splunk Web</li> </ul> <p>Overriding Alert Actions TTL</p> <p></p>"},{"location":"spl1/4config_ds/#1-2-distributed-search-overview","title":"1-2 Distributed Search Overview","text":"<p>Distributed search separates search management &amp; presentation layer from indexing &amp; search retrieval layer</p> <p>Distributed Environment</p> <p></p> <p>Scaling</p> <p></p> <p>How Distributed Search Works?</p> <ul> <li>Search head receives user\u2019s search request</li> <li>Search head dispatches searches to the search peers (indexers)</li> <li>Search peers run the search on behalf of search heads and return the results to the search head</li> <li>Search head merges the results from all the search peers</li> <li>Search head runs additional filtering and transformation commands (if applicable) and returns the results to the user</li> </ul> <p>Search Peers</p> <ul> <li>The indexers that participate in distributed search are called search peers</li> <li>Search peers must be added in search heads</li> <li>If the search head participates in indexer cluster, search peers are automatically added</li> <li>When a peer goes down, search head removes it from the peers list (default timeout 10 seconds)</li> </ul>"},{"location":"spl1/4config_ds/#1-3-splunk-knowledge-bundle","title":"1-3 Splunk Knowledge Bundle","text":"<p>Knowledge Bundle</p> <ul> <li>Archive of knowledge objects that search head sends to all search peers</li> <li>Includes knowledge objects such as event types, saved searches.</li> <li>Search peers need these knowledge objects to execute searches on behalf of search heads</li> <li>Contains a subset of <code>$SPLUNK_HOME/etc/system</code>, <code>$SPLUNK_HOME/etc/apps</code> &amp; <code>$SPLUNK_HOME/etc/users</code></li> </ul> <p>Location of Knowledge Bundle</p> <ul> <li>Search Head   <code>$SPLUNK_HOME/var/run</code> (<code>.bundle</code> or <code>.delta</code> extension)</li> <li>Search Peers: <code>$SPLUNK_HOME/var/run/</code> searchpeers</li> </ul> <p>Content of Knowledge Bundle</p> <p>On the search peers:</p> <p><code>$SPLUNK_HOME/var/run/searchpeers/&lt;bundleid&gt;</code></p> <ul> <li>system</li> <li>users</li> <li>apps</li> <li>bundle.info</li> </ul>"},{"location":"spl1/4config_ds/#1-4-knowledge-bundle-replication","title":"1-4 Knowledge Bundle Replication","text":"<p>As part of distributed search, search head periodically  distributes its knowledge bundle to its search peers</p> <p>What is Replicated?</p> <p>Search head periodically replicates knowledge bundle in the background or when initiating a search</p> <p>Full bundle</p> <p>The entire knowledge bundle</p> <p>Delta</p> <p>Changes since the last full bundle push</p> <p>Four Replication Policies</p> <ul> <li>Classic\uff1a  Search head directly replicates to all search peers</li> <li>Cascading\uff1a Replicates to a subset of search peers which replicates to other search peers &amp; so on</li> <li>Mounted: Search head places the knowledge bundle in shared storage (NOT recommended)</li> <li>RFS: Search head uploads knowledge bundle to a remote file system</li> </ul> <p>Configuring Replication Policy</p> <p>The configuration file must reside on the search head</p> <p><code>distsearch.conf</code></p> <pre><code>[replicationSettings]\nreplicationPolicy = [classic | cascading | rfs | mounted]\nconnectionTimeout = 60\nmaxBundleSize = 2048\n</code></pre> <p>Managing Knowledge Bundle</p> <ul> <li>You can customize what gets replicated</li> <li>Use <code>distsearch.conf</code> to blacklist large files you don\u2019t need replicated</li> </ul> <pre><code>[replicationBlacklist]\nexcludeLookups = apps/myapp/lookups/mybiglookup*\n</code></pre> <p>Monitoring Knowledge Bundle Replication</p> <ul> <li>Splunk Web <code>Settings -&gt; Distributed Search</code></li> <li>Monitoring Console <code>Search -&gt; Distributed Search</code></li> <li>Command line  <code>$SPLUNK_HOME/bin/splunk show bundle-replication-status</code></li> <li>REST API <code>/services/search/distributed/bun dle/replication/config</code></li> </ul>"},{"location":"spl1/4config_ds/#demo","title":"Demo","text":"<ul> <li>Review search in standalone environment</li> <li>Run an ad-hoc search and check the dispatch directory</li> <li>Review job inspector and search.log</li> <li>Change the default TTL of ad-hoc search</li> <li>Change the default TTL of a scheduled search</li> </ul> <p><code>index=main sourcetype=secure Failed</code></p> <p></p> <p></p> <p></p> <p></p> <p></p> <p><code>arg.txt</code></p> <p></p> <p></p>"},{"location":"spl1/4config_ds/#2-configuring-distributed-search","title":"2 Configuring Distributed Search","text":"<p>Overview</p> <ul> <li>Preparing indexers to participate in distributed search</li> <li>Adding search peers</li> <li>Configuring distributed search groups</li> <li>Monitoring search peers</li> <li>Quarantining search peers</li> </ul>"},{"location":"spl1/4config_ds/#2-1-configuration-at-a-glance","title":"2-1 Configuration at a Glance","text":"<p>Setting up Distributed Search</p> <ul> <li>Install the same version of Splunk Enterprise in search head and search peers</li> <li>Search head and search peers must use a license master</li> <li>Setup the same indexes in all search peers</li> <li>Create a user with <code>edit_user</code> capability on all search peers</li> <li>Add search peers in search head via Splunk Web</li> </ul> <p>Preparing the Indexer</p> <ul> <li>Access: Create a user with <code>edit_user</code> capability</li> <li>Index: Ensure indexes have data coming in from  forwarders</li> <li>Connectivity\uff1a Ensure search head can connect to management port (8089) of the indexer</li> </ul>"},{"location":"spl1/4config_ds/#2-2-adding-search-peer-using-splunk-web","title":"2-2 Adding Search Peer Using Splunk Web","text":"<p>Adding Search Peer Using Splunk Web</p> <p></p> <p>Verifying Distributed Search</p> <ul> <li>Examine the search peer in distributed search page in Splunk Web. Look for Replication Status</li> <li>Run a search to retrieve events from an index</li> <li>Check the internal logs on the indexer</li> </ul> <p>Verifying Search Peers</p> <p></p>"},{"location":"spl1/4config_ds/#2-3-distributed-search-groups","title":"2-3 Distributed Search Groups","text":"<p>Distributed Search Groups</p> <ul> <li>Search peers configured into specific groups using <code>distsearch.conf</code></li> <li>Enables to run searches on targeted indexers</li> <li>Use <code>splunk_server_group</code> option in SPL to specify the group</li> </ul> <p>Distributed search groups should be avoided in indexer clusters</p> <ul> <li>The primary copy of a data bucket can be in any indexer</li> <li>Enables to run searches on targeted indexers</li> <li>Can be employed in multiple indexer cluster scenarios</li> </ul> <p>Configuring  Distributed  Search Groups</p> <p><code>distsearch.conf</code></p> <pre><code>[distributedSearch]\nservers = https://172.31.22.35:8089,https://172.31.27.11:8089,https://172.31.22.115:8089\n\n[distributedSearch:sec]\nservers = https://172.31.22.35:8089,https://172.31.27.11:8089\n\ndefault = false\n\n[distributedSearch:sre]\nservers = https://172.31.22.115:8089\ndefault = false\n</code></pre> <p>Using Distributed Search Groups</p> <ul> <li>Specify the distributed search group as part of SPL</li> </ul> <p><code>index=infra splunk_search_group = sre</code></p> <p>Verify by examining <code>splunk_server</code> field</p> <p></p>"},{"location":"spl1/4config_ds/#2-4-quarantining-a-search-peer","title":"2-4 Quarantining a Search Peer","text":"<ul> <li>You can quarantine search peers from participating in searches</li> <li>Enables to perform maintenance on the search peer without affecting searches</li> <li>You can use Splunk Web\u2019s to quarantine search peers</li> </ul>"},{"location":"spl1/4config_ds/#2-5-demo","title":"2-5 Demo","text":"<ul> <li>Prepare an indexer for distributed search</li> <li>Add search peers (indexer) in search head</li> <li>Verify distributed search</li> </ul> <p>Distributed Search Environment</p> <p></p> <p>Add new search peer</p> <p></p> <p></p> <p>Add new search peer user</p> <p></p> <p>Add search peers</p> <p></p> <p></p> <pre><code>[splunk@ip-172-31-19-217 sh1 splunk]$ cd /opt/splunk\n[spunk@ip-172-31-19-217 sh1 splunk]$ pwd\n/opt/splunk\n[plunk@ip-172-31-19-217 sh1 splunk]$ cd etc/system/local\n[splunk@ip-172-31-19-217 sh1 local]$ ls\nREADME\ninputs.conf\nmigration. conf\nserver.conf\n</code></pre> <p><code>\"distsearch. conf\"</code></p> <pre><code>[distributedSearch]\nservers = https://172.31.22.115:8089.https://172.31.22.35:8089.https://172.31.27.11:8089\n</code></pre> <p><code>index=infra</code></p> <p></p> <p><code>idx1           idx2             idx3</code></p> <p></p> <p>You can also <code>Inspect job</code></p> <p></p> <p></p> <p></p> <pre><code>[plunk@ip-172-31-19-175 fw1 splunk]$ cd /opt/splunkforwarder/\n[spunk@ip-172-31-19-175 fw1 splunkforwarder]$ cd etc/system/local\n[plunk@ip-172-31-19-175 fw1 local]$\n\n# outputs configuration to send data to indexers in aws\n[tcpout: idxGroup]\nserver = 172.31.27.11:9997,172.31.22.35:9997,172.31.22.115:9997\n</code></pre> <p><code>inputs.conf</code></p> <pre><code># Inputs to capture system logs and send it to aws indexers\n[default]\nhost = fw1\n\n[monitor:///var/log/messages]\nTCP ROUTING = idxGroup\nindex = infra\nsourcetype = syslog\nignore0lderThan = 7d\n</code></pre> <p>The tepgroup idxGroup is defined in <code>outputs.conf</code></p> <p><code>index=_internal host=fwl</code></p> <p></p> <p></p>"},{"location":"spl1/4config_ds/#demo_1","title":"Demo","text":"<ul> <li>Configure distributed search group</li> <li>Invoke a search using distributed search group</li> <li>Quarantine a search peer</li> </ul> <pre><code>[Splunk@ip-172-31-19-217 sh1 local]$ pwd\n/opt/splunk/etc/system/local\n\n[Splunk@ip-172-31-19-217 sh1 local]$ ls\n...\ndistsearch. conf\n\n[Splunk@ip-172-31-19-217 sh1 local]$ vi distsearch. conf\n[distributedSearch]\nservers = https://172.31.22.115:8089.https://172.31.22.35:8089.httos://172.31.27.11:8089\n</code></pre> <p>Add sec search group and sre searcg group</p> <pre><code>[distributedSearch]\nservers = https://172.31.22.115:8089.https://172.31.22.35:8089.httos://172.31.27.11:8089\n\n[distributedSearch:sec]\nservers = https://172.31.22.115:8089.https://172.31.22.35:8089.httos://172.31.27.11:8089\ndefault = false\n\n[distributedSearch:sre]\nservers = https://172.31.22.115:8089\ndefault = false\n</code></pre> <pre><code>[plunk@ip-172-31-19-217 sh1 local]$ cd /opt/splunk/bin\nsudo  ./splunk restart\n</code></pre> <p>New Search</p> <pre><code>index=infra splunk_server_group=\"sec\"\n</code></pre> <p></p> <pre><code>index=infra splunk_server group = \"sre\"\n</code></pre> <p></p> <pre><code>index=infra\n</code></pre> <p></p> <p><code>splunk_server_group</code></p> <p></p> <p><code>Quarantine splunk_server</code></p> <p></p> <ul> <li>Quarantined 172.31.2711:8089</li> </ul> <p></p> <p></p> <p></p> <p></p>"},{"location":"spl1/4config_ds/#3-scaling-distributed-search","title":"3 Scaling Distributed Search","text":"<p>Overview</p> <ul> <li>Scaling options available</li> <li>Search head cluster architecture</li> <li>Search head cluster operation<ul> <li>Configuration replication</li> <li>Artifact replication</li> <li>Deployer</li> </ul> </li> <li>Creating a search head cluster</li> </ul>"},{"location":"spl1/4config_ds/#3-1-search-head-scaling-options","title":"3-1 Search Head Scaling Options","text":"<p>Why Scale?</p> <ul> <li>Prevention of single point of failure</li> <li>Prevention of performance issue due to resource constraints</li> <li>Distribute load across many servers geographically</li> <li>Efficiently perform server maintenance without causing outages</li> </ul> <p>Scaling Options</p> <ul> <li>Independent search heads: Dedicated search heads  with no communication between them</li> <li>Search head clusters: A group of search heads (minimum 3) in a cluster communicating with each other</li> <li>Indexer clusters:  Search heads that join indexer cluster can be independent or search head cluster</li> </ul> <p>Independent Search Heads</p> <p></p> <p>Search Head Cluster</p> <p></p>"},{"location":"spl1/4config_ds/#3-2-search-head-cluster-architecture","title":"3-2 Search Head Cluster Architecture","text":"<p>Search Head Cluster Considerations</p> <ul> <li>Minimum 3 members required</li> <li>Always use new Splunk instances to create the cluster</li> <li>Cluster members must have the same hardware capacity</li> <li>Synchronize the clocks of all members including search peers</li> </ul> <p>Key Benefits of Search Head Clustering</p> <ul> <li>High availability and load balancing</li> <li>Captain manages and distributes the scheduled jobs</li> <li>Configuration and search artifacts replication</li> <li>Seamless user experience</li> </ul> <p>Search Head Cluster Architecture</p> <p></p>"},{"location":"spl1/4config_ds/#3-3-how-does-the-search-head-cluster-work","title":"3-3 How Does the Search Head Cluster Work?","text":"<p>Search Head Captain</p> <ul> <li>Captain centrally coordinates all cluster-wide activities. Captain is also a member of the cluster</li> <li>Captaincy can be configured to be dynamic (default) or static<ul> <li>With dynamic captaincy, the cluster automatically elects a new captain using RAFT consensus algorithm</li> <li>Captain consumes more CPU and memory</li> </ul> </li> </ul> <p>Scheduled Jobs and Artifacts</p> <ul> <li>Captain is the only scheduler</li> <li>Captain chooses the search head cluster member to run search jobs based on load</li> <li>Search artifacts are replicated by captain to other members. <ul> <li>Ad-hoc and real-time artifacts are not replicated</li> </ul> </li> </ul> <p>Configuration Management</p> <ul> <li>Automatic Replication<ul> <li>Changes done via Splunk Web, CLI and REST API are automatically replicated</li> </ul> </li> <li>Deployer<ul> <li>Changes done to the <code>.conf</code> files must be distributed through Search head deployer </li> </ul> </li> </ul> <p>Deployer</p> <ul> <li>A Splunk instance outside of SHC (search head cluster). Associated with SHC by using pass4SymmKey in <code>server.conf</code></li> <li>Apps to be deployed are stored in <code>/etc/shcluster/apps</code></li> <li>Merges default and local directory files and deploys to default directory on the SHC members (never to local)</li> <li>Automatically triggers a rolling restart if necessary</li> </ul>"},{"location":"spl1/4config_ds/#demo_2","title":"Demo","text":"<ul> <li>Initialize a 3-member search head cluster</li> <li>Add search peers</li> <li>Verify configuration replication</li> </ul> <p>Search Head Cluster Environment</p> <p></p> <p>Search heads are going to be configured in a search head cluster</p> <p></p> <p></p> <p></p> <p></p> <p>sh1</p> <pre><code>[Splunk@ip-172-31-25-141 sh1 ~]$ cd /opt/splunk/bin\n\n$ ./splunk init shcluster-config -mgmt_uri https://172.31.25.141:8089 replication_port 9200 -secrect  shcluster\n\ncd /opt/splunk/bin\n\n$ sudo ./splunk restart\n</code></pre> <p>sh2</p> <pre><code>[splunk@ip-172-31-19-166 sh2 ~]$ cd /opt/splunk/bin\n[splunk@ip-172-31-19-166 sh2 bin]$  ./splunk init shcluster-config -mgmt_uri https: //172.31.19.166:8089 -replication_port 9200 -secret shcluster\n\n[splunk@ip-172-31-19-166 sh2 bin]$ sudo ./splunk restart\n</code></pre> <p>sh3</p> <pre><code>[splunk@ip-172-31-21-109 sh3 bin]$ ./splunk init shcluster-config -mgmt_uri https://172.31.21.109:8089 -replication_port 9200 -secret shcluster\n\n[splunk@ip-172-31-19-166 sh2 bin]$ sudo ./splunk restart\n</code></pre> <p>sh1</p> <pre><code>[splunk@ip-172-31-25-141 sh1 bin]$ ./splunk bootstrap shcluster-captain -servers_list https://172.31.25.141:8089,https://172.31.19.166:8089.https://172.31.21.109:8089\n\n[splunk@ip-172-31-25-141 sh1 bin]$ cd ../etc/system/local\n[splunk@ip-172-31-25-141 sh1 local]$ vi server.conf\n[splunk@ip-172-31-25-141 sh1 local]$ cd /opt/splunk/bin\n[splunk@ip-172-31-25-141 sh1 bin]$ ./splunk show shcluster-status\n</code></pre> <p></p> <p></p> <p></p> <p><code>Begin Rolling Restart</code></p> <p>sh1</p> <pre><code>cd ../etc/system/local\nvi server.conf\n\n[raft_statemachine]\ndisabled = false\nreplicate_search_peers = true\n</code></pre> <p>sh2</p> <pre><code>[splunk@ip-172-31-19-166 sh2 bin]$ cd ../etc/system/local\n[splunk@ip-172-31-19-166 sh2 local]$ vi server.conf\n\n[raft_statemachine]\ndisabled = false\nreplicate_search_peers = true\n\n[splunk@ip-172-31-19-166 sh2 bin]$ sudo ./splunk restart\n</code></pre> <p>sh3</p> <pre><code>[splunk@ip-172-31-21-109 sh3 bin]$ cd ../etc/system/local\n[splunk@ip-172-31-21-109 sh3 loca]$ vi server.conf\n[raft_statemachine]\ndisabled = false\nreplicate_search_peers = true\n\n[splunk@ip-172-31-21-109 sh3 loca]$ sudo ./splunk restart\n</code></pre> <pre><code>[splunk@ip-172-31-25-141 sh1 bin$ ./splunk add search-server https: //172.31.27.192:8089 -remoteUsername shuser -remotePassword\n\nPeer added\n</code></pre>"},{"location":"spl1/5Mon_create_inputs/","title":"5 Splunk Administration: Monitoring and Creating Inputs","text":"<p>Overview</p> <ul> <li>Introduction to input methods in Splunk</li> <li>Data pipeline in Splunk</li> <li>Demo: Setting up the test environment</li> </ul>"},{"location":"spl1/5Mon_create_inputs/#1-data-input-methods","title":"1 Data Input Methods","text":"<ul> <li>File/Dir Monitoring: Continuous monitoring or one-time upload</li> <li>Network Inputs: Listen on TCP/UDP port</li> <li>Windows Inputs: Monitor Windows logs locally/remotely</li> <li>Scripted Input: Local/Remote script output sent to Splunk</li> <li>HTTP Event Collector: Endpoints to send data to Splunk over http(s)</li> </ul> <p>Data Pipeline in Splunk Enterprise</p> <p></p>"},{"location":"spl1/5Mon_create_inputs/#demo","title":"Demo","text":"<ul> <li>Understand topology of test environment</li> <li>Setup test environment<ul> <li>Configure forwarding and receiving</li> <li>Install demo app</li> </ul> </li> </ul> <ul> <li> <p>The Windows machine is named <code>Splunk_Server</code> with a static IP 172.17.11.17. </p> <ul> <li>Installed full Splunk instance on this host. </li> <li>This host is also my indexer, as well as the search head. </li> <li>All Windows related inputs will be set up on this host. </li> <li>It will receive data from Ubuntu host <code>Splunk_HF</code>. </li> </ul> </li> <li> <p>Installed full Splunk instance on <code>Splunk_HF</code> as well and will configure it as a heavy forwarder. </p> <ul> <li>The static IP given to this host is 172.17.11.27.</li> <li>It will receive data from <code>Splunk_UF</code> and forward it to <code>Splunk_Server</code>. </li> </ul> </li> <li> <p><code>Splunk_UF</code> on 172.17.11.29 is also an Ubuntu host where I've installed Splunk universal forwarder. </p> <ul> <li>It will be configured to forward data to the heavy forwarder, <code>Splunk_HF</code>. </li> <li>Lightweight tasks will be performed on this host. </li> </ul> </li> </ul> <p></p> <p></p> <p></p> <p></p> <pre><code>172.17.11.27:8000/en-GB/app/launcher/home\n</code></pre> <p></p> <p></p> <pre><code>root@splunkuf:~# cd /opt/splunkforwarder/bin/\nroot@splunkuf:/opt/splunkforwarder/bin#./splunk install app /home/splunk/packages/psdemo01.spl\nApp '/home/splunk/packages/psdemo01.spl\n\nYou need to restart the Splunk Server (splunkd) for your changes to take effect.\nroot@splunk_uf:/opt/splunkforwarder/bin#\n</code></pre> <pre><code>root@splunk_uf:/opt/splunkforwarder/bin# vi/opt/splunkforwarder/etc/system/local/outputs.conf\n\n[tcpout:psdemo_indexers]\nserver=172.17.11.27:9997\n\nroot@splunk_uf:/opt/splunkforwarder/bin# ./splunk list forward-server\n\nActive forward\n    172.17.11.27:9997\n</code></pre>"},{"location":"spl1/5Mon_create_inputs/#summary","title":"Summary","text":"<ul> <li>Input methods in Splunk</li> <li> <p>Demo: Setting up the test environment</p> <ul> <li>Topology</li> <li>Configuring forwarding and receiving</li> <li>Installing the demo app</li> </ul> </li> </ul>"},{"location":"spl1/5Mon_create_inputs/#2-monitoring-files-and-directories","title":"2 Monitoring Files and Directories","text":"<ul> <li>Monitoring files and directories in Splunk</li> <li>Uploading a file for one shot indexing</li> <li>Monitoring a log file through Splunk Web</li> <li>Monitoring files through inputs.conf</li> <li>Ignoring old files</li> <li>Using wildcards in monitoring stanza</li> <li>Blacklisting files</li> <li>Editing existing monitoring stanza</li> </ul> <p>Monitoring Files and Directories</p> <ul> <li>One-shot indexing used for uploading a file once</li> <li>While continuously monitoring Splunk remembers the files and follows tail </li> <li>MonitorNoHandle is Windows only input on files that get locked open for writing</li> <li> <p>Files and directories can be monitored using Splunk Web, <code>inputs.conf</code> or CLI methods</p> </li> <li> <p>Monitor stanza for file/directory path</p> </li> </ul> <pre><code>[monitor://&lt;path/to/file/or/directory&gt;]\n</code></pre> <ul> <li>Use of regex and wildcards</li> <li>Monitor mounted or shared directories</li> <li>Can monitor compressed files<ul> <li><code>.tar, .gz, .bz2, .tgz, .tbz,.zip, .z</code></li> </ul> </li> <li>Restart Splunk after changes</li> </ul> <p>Monitoring Input Stanza</p> <ul> <li> <p><code>queue = parsingQueue | indexQueue</code></p> <ul> <li>Which queue to send events to</li> <li>parsingQueue</li> </ul> </li> <li> <p><code>host_regex = &lt;regex&gt;</code></p> <ul> <li>Regex that extracts host from file name</li> <li>Setting in \u201chost=\u201d</li> </ul> </li> <li> <p><code>host_segment = &lt;int&gt;</code></p> <ul> <li>Segment of monitored path for example a value 4 for <code>/data/logs/mail/server01.log</code> will set host to <code>server01.log</code></li> <li>Setting in \u201chost=\u201d</li> </ul> </li> <li> <p><code>crcSalt = &lt;int&gt;|&lt;SOURCE&gt;</code></p> <ul> <li>Splunk eads first few lines for CRC check to prevent indexing same files.  causes Splunk to add full source path to CRC. Use with caution for rotating files.</li> </ul> </li> <li> <p><code>ignoreOlderThan= &lt;time_window&gt;</code></p> <ul> <li>Doesn\u2019t monitor file if update time is greater than number and unit d, h, m or s</li> <li><code>0 (disabled)</code></li> </ul> </li> <li> <p><code>followTail = 0|1</code></p> <ul> <li>Equivalent to *nix <code>tail \u2013f</code>. Starts from tail</li> <li>0 (disabled)</li> </ul> </li> <li> <p><code>recursive = true|false</code></p> <ul> <li>If set to false Splunk ignore subdirectories while monitoring a directory</li> <li>true</li> </ul> </li> <li> <p><code>/var/log/web/.../access.log</code></p> <ul> <li><code>/var/log/web/www1/prod/access.log</code></li> <li><code>/var/log/web/www3/access.log</code></li> </ul> </li> <li> <p><code>/var/log/web/www1/access.*</code></p> <ul> <li><code>/var/log/web/www1/access.txt</code></li> <li><code>/var/log/web/www1/access.log</code></li> </ul> </li> <li> <p><code>/var/log/web(1|2).log</code></p> <ul> <li>Only web(1|2).log</li> </ul> </li> <li> <p><code>/var/log/web(1|2)*.log</code></p> <ul> <li>web1.log, web2test.log, web1server.log</li> </ul> </li> <li> <p><code>/apache/.../web[A-Z0-9]*.log</code></p> <ul> <li><code>/apache/www1/webCprod.log</code></li> <li><code>/apache/www1/test/web5test.log</code></li> <li><code>/apache/www/uat/webJ.log</code></li> </ul> </li> </ul>"},{"location":"spl1/5Mon_create_inputs/#2-1-monitoring-files-and-directories","title":"2-1 Monitoring Files and Directories","text":"<p>Win event logs</p> <p>Collect locally or remotely using WMI</p> <p>Performance monitoring</p> <p>Performance counters in Performance Monitor</p> <p>Remote monitoring</p> <p>WMI queries</p> <p>Registry monitoring</p> <p>Changes to local Windows Registry</p> <p>Active Directory monitoring</p> <p>Changes to Active Directory</p>"},{"location":"spl1/5Mon_create_inputs/#2-2-demo-monitoring-files-and-directories-in-splunk-web","title":"2-2 Demo: Monitoring Files and Directories in Splunk Web","text":"<p>By default, Splunk accepts a date 2,000 days ago that is roughly around 5 and a half years. I</p> <p>n this case, our timestamp is way older than this, so we need to give a much larger number. Largest we can go is 10,951 days.</p> <p></p> <p></p> <p></p> <p><code>props.conf</code></p> <p></p> <p></p> <p></p> <p><code>inputs.conf</code></p> <p></p> <p></p> <pre><code>[monitor: //C: \\Program Files\\Splunkletclapps\\psdemo@1\\data\\email_logs]\ndisabled = false\nsourcetype = email: logs\n</code></pre>"},{"location":"spl1/5Mon_create_inputs/#2-3-demo-monitoring-files-and-directories-using-inputsconf-file","title":"2-3 Demo: Monitoring Files and Directories Using inputs.conf File","text":"<ul> <li>Setup file monitoring in <code>inputs.conf</code></li> <li>Reload monitor inputs</li> <li>Verify the monitor input</li> <li>Check results in Spunk Enterprise</li> <li>Demonstrate real-time ingestion</li> </ul> <pre><code>root@splunk_hf:~# cd /var/log\nroot@splunk_hf:/var/log# 11 auth*\nauth.log\nauth.log.1\nauth.log.2.gz\nauth.log.3.gz\nauth.log.4.gz\n\nroot@splunk_hf:/var/log# tail auth.log\nsplunk_hf sshd[24784]: pam_unix(sshd:session): session opened for user splunk by (uid=0)\npunk_hf systemd-logind[939]: New session 357 of user splunk.\n...\n\n\nroot@splunk_hf:/opt/splunk/etc/apps/psdemo01/local# ll\n\napp.conf\ninputs.conf\n\nroot@splunk_hf:/opt/splunk/etc/apps/psdemo01/local# vi inputs.conf\n\n[default]\nhost = splunk_uf\n\n[monitor:///var/log/auth.log]\ndisabled = O\nindex = main\nsourcetype = linux:auth\n\nroot@splunk_hf:/opt/splunk/etc/apps/psdemo01/local# /opt/splunk/bin/./splunk _internal call /services/data/inputs/monitor/_reload \n...\n\n&lt;link href-\"/services/data/inputs/monitor/_new\" rel=\"create\"/&gt;\n&lt;link href-\"/services/data/inputs/monitor/_reload\" rel=\"\n_reload\"/&gt;\n&lt;link href-\"/services/data/inputs/monitor/_acl\" rel=\n\u2039opensearch:totalResults&gt;0&lt;/opensearch:totalResults&gt;\n\u2039opensearch:itemsPerPage&gt;30&lt;/opensearch:itemsPerPage&gt;\n...\n\nroot@splunk_hf:/opt/splunk/etc/apps/psdemo01/local# /opt/splunk/bin/./splunk list monitor\n...\n$SPLUNK_HOME/etc/splunk.version\n/var/log/auth.log\n</code></pre> <p>Search:  <code>index=main sourcetype=linux:auth</code></p> <p></p>"},{"location":"spl1/5Mon_create_inputs/#2-4-demo-monitoring-files-and-directories-with-special-parameters","title":"2-4 Demo: Monitoring Files and Directories with Special Parameters","text":"<ul> <li>Monitor multiple files</li> <li>Ignore older files</li> <li>Overriding host name</li> <li>Editing and modifying a monitor input</li> </ul> <pre><code>root@splunk_hf:~# cd /var/log\nroot@splunk_hf:/var/log# ll syslo*\n\nsyslog\nsyslog.1\nsyslog.2.gz\nsyslog.3.gz\nsyslog.4.gz\nsyslog.5.gz\n</code></pre> <pre><code>root@splunk_hf:/var/log# cat syslog\n\nroot@splunk_hf:/var/log# cd /opt/splunk/etc/apps/psdemo01/local/\n\n$ ll\n$ app.conf\n$ inputs.conf\n\n$ vi inputs.conf\n\n[default]\nhost = splunk uf\n\n[monitor:///var/log/auth.1og]\ndisabled = 0\nindex = main\nsourcetype = linux:auth\n\n[monitor:///var/log/syslog*]\ndisabled = 0\nindex = main\nsourcetype = linux:syslog\nignoreOlderThan = 10d\nhost_segment = 3\n</code></pre> <pre><code>/opt/splunk/bin/./splunk _internal call/services/data/inputs/monitor/_reload\n\nroot@splunk_hf:/opt/splunk/etc/apps/psdemo01/local# /opt/splunk/bin/./splunk/list\n\n....\n/var/log/syslog*\n    /var/log/syslog\n    /var/log/syslog.1\n    /var/log/syslog.2.gz\n    /var/log/syslog.3.gz\n    /var/log/syslog.4.gz\n    /var/log/syslog.5.gz\n\nMonitored Files:\n    $SPLUNK_HOME/etc/splunk.version\n    /var/log/auth.log\n</code></pre> <p><code>index=main sourcetype=linux:syslog</code></p> <p></p> <pre><code>root@splunk_hf:/opt/splunk/etc/apps/psdemo01/local# ll /var/log/syslo*\n\n/var/log/syslog\n/var/log/syslog.1\n/var/log/syslog.2.gz\n/var/log/syslog.3.gz\n/var/log/syslog.4.gz\n/var/log/syslog.5.gz\n</code></pre> <pre><code>$ vi inputs.conf\n\n[default]\nhost = splunk uf\n\n[monitor:///var/log/auth.1og]\ndisabled = 0\nindex = main\nsourcetype = linux:auth\n\n[monitor:///var/log/syslog*]\ndisabled = 0\nindex = main\nsourcetype = linux:syslog\nignoreOlderThan = 30d\nhost_segment = 3\n</code></pre> <pre><code>/opt/splunk/bin/./splunk _internal call/services/data/inputs/monitor/_reload\n</code></pre> <p></p>"},{"location":"spl1/5Mon_create_inputs/#2-5-demo-blacklisting-monitored-files","title":"2-5 Demo: Blacklisting Monitored Files","text":"<ul> <li>Monitor multiple directories</li> <li>Blacklisting files</li> <li>Editing a monitor input stanza</li> </ul> <pre><code>root@splunk_hf:~# cd /opt/splunk/etc/apps/psdemo01/data/\nroot@splunk_hf:/opt/splunk/etc/apps/psdemo01/data# ll\n\napacheweb/\nusers.csv\n\nroot@splunk_hf:/opt/splunk/etc/apps/psdemo01/data#\nroot@splunk_hf:/opt/splunk/etc/apps/psdemo01/data# cd apacheweb/\nroot@splunk_hf:/opt/splunk/etc/apps/psdemo01/data/apacheweb# ll\n\nwww1/\nwww2/\nwww3/\n\nroot@splunk_hf:/opt/splunk/etc/apps/psdemo01/data/apacheweb#\n\nroot@splunk_hf:/opt/splunk/etc/apps/psdemo01/data/apacheweb#  find | sed 's|[^/]*/|\\|-|g'\n\n. \n|- www2\n|-|-access_prod2.log\n|-|-access_uat2.log\n|-www1\n|-|-access_prod1.log\n|-|-access_uat1.log\n| -www3\n|-|-access_prod3.1og\n|-|-access_uat3.log\n</code></pre> <pre><code>root@splunk_hf:/opt/splunk/etc/apps/psdemo01/data/apacheweb# cd ../../local\n\nroot@splunk_hf:/opt/splunk/etc/apps/psdemo01/local# ll\n\napp.conf\ninputs.conf\n\nroot@splunk_hf:/opt/splunk/etc/apps/psdemo01/local# vi inputs.conf\n\n</code></pre> <pre><code>...\n\n[monitor:///opt/splunk/etc/apps/psdemo01/data/apacheweb/.../*.log]\ndisabled = false\nsourcetype = access_combined\nblacklist = access_uat\\d\\.log$\n</code></pre> <pre><code>/opt/splunk/bin/./splunk _internal call/services/data/inputs/monitor/_reload\n\nroot@splunk_hf:/opt/splunk/etc/apps/psdemo01/local#/opt/splunk/bin/./splunk list monitor\n\nopt/splunk/etc/apps/psdemo01/data/apacheweb/..\n/opt/splunk/etc/apps/psdemo01/data/apacheweb/www1\n/opt/splunk/etc/apps/psdemo01/data/apacheweb/www1/access_prod1.log\n/opt/splunk/etc/apps/psdemo01/data/apacheweb/www2\n/opt/splunk/etc/apps/psdemo01/data/apacheweb/www2/access_prod2.log\n/opt/splunk/etc/apps/psdemo01/data/apacheweb/www?\n/opt/splunk/etc/apps/psdemo01/data/apacheweb/www3/access_prod3.log\n</code></pre> <p><code>index=main sourcetype=access_combined</code></p> <p></p> <pre><code>...\n\n[monitor:///opt/splunk/etc/apps/psdemo01/data/apacheweb/.../*.log]\ndisabled = false\nsourcetype = access_combined\n# blacklist = access_uat\\d\\.log$\n</code></pre> <pre><code>/opt/splunk/bin/./splunk _internal call/services/data/inputs/monitor/_reload\n\nroot@splunk_hf:/opt/splunk/etc/apps/psdemo01/local#/opt/splunk/bin/./splunk list monitor\n\n/opt/splunk/etc/apps/psdemo01/data/apacheweb/.../*.log\n/opt/splunk/etc/apps/psdemo01/data/apacheweb/www1/access_prod1.log\n/opt/splunk/etc/apps/psdemo01/data/apacheweb/www1/access_uat1.log\n/opt/splunk/etc/apps/psdemo01/data/apacheweb/www1/access_uat1.log\n/opt/splunk/etc/apps/psdemo01/data/apacheweb/www2\n/opt/splunk/etc/apps/psdemo01/data/apacheweb/www2/access_prod2.log\n/opt/splunk/etc/apps/psdemo01/data/apacheweb/www2/access_uat2.log\n\n/var/log/syslog*\n\n/var/log/syslog\n/var/log/syslog.1\n/var/log/syslog.2.gz\n/var/log/syslog.3.gz\n/var/log/syslog.4.gz\n/var/log/syslog.5.gz\n\n$SPLUNK_HOME/etc/splunk.version\n</code></pre> <pre><code>index=main sourcetype=access_combined\n</code></pre> <p></p> <p>Summary</p> <ul> <li>How Splunk monitors files and directories</li> <li>One time uploading in Splunk Web</li> <li>Monitoring a directory in Splunk Web</li> <li>Monitoring files using inputs.conf</li> <li>Excluding older files from monitoring</li> <li>Use of wildcards</li> <li>Ignoring files through blacklisting</li> <li>Reloading monitor inputs</li> </ul>"},{"location":"spl1/5Mon_create_inputs/#3-getting-data-from-network-sources","title":"3 Getting Data from Network Sources","text":""},{"location":"spl1/5Mon_create_inputs/#3-1-introduction-to-network-inputs-in-splunk-enterprise","title":"3-1 Introduction to Network Inputs in Splunk Enterprise","text":"<p>Network Inputs</p> <ul> <li>TCP/UDP - Accept input on any port</li> <li>Network Services - Capture data from syslog or netcat</li> <li>Secure - Accepted from hosts with correct SSL certs</li> <li>Agentless - No need for UF on the source</li> <li>Configurations - Splunk web, conf files and CLI commands</li> </ul> <p>Network Inputs</p> <ul> <li> <p>TCP</p> <ul> <li>Connection oriented</li> <li>Reliable</li> <li>Flow-control</li> <li>Packet ordering</li> <li>Slow</li> </ul> </li> <li> <p>UDP</p> <ul> <li>Connectionless</li> <li>Unreliable</li> <li>No flow-control mechanism</li> <li>No packet ordering ensured</li> </ul> </li> </ul> <p>Network Inputs</p> <ul> <li><code>[protocol://&lt;remote server&gt;:&lt;port&gt;]</code></li> <li><code>host=&lt;string&gt;</code></li> <li><code>source=&lt;string&gt;</code></li> <li><code>queue = parsinqQueue | indexQueue</code></li> <li><code>connection_host = ip | dns | none</code></li> <li><code>_revbuf = &lt;integer&gt; bytes</code>(UDP only)</li> <li><code>no_priority_stripping = true | false</code></li> <li><code>no_appending_timestamp = true | false</code></li> <li>UP packets and line merging</li> <li>Universal forwarder as a middle tier for better performance</li> </ul>"},{"location":"spl1/5Mon_create_inputs/#3-2-demo-configuring-tcp-input-through-splunk-web","title":"3-2 Demo: Configuring TCP Input through Splunk Web","text":"<p>I'm going to create a TCP input using Splunk web.</p> <p></p> <p></p> <p></p> <p>I'll leave it blank means any host is allowed to send the data.</p> <p></p> <ul> <li><code>top:test</code></li> <li><code>TCP Network Input</code></li> </ul> <p></p> <p></p> <p></p> <p></p> <pre><code>root@splunkuf:~# echo \"TCP test message from splunkuf\"\n| nc -v 172.17.11.27 -t 11601 -wO\nConnection to 172.17.11.27 11601 port [tcp/*]\nsucceeded!\n</code></pre> <p><code>index=main sourcetype=tcp:test</code></p> <p></p> <p></p>"},{"location":"spl1/5Mon_create_inputs/#demo-configuring-udp-input-using-inputsconf-file","title":"Demo: Configuring UDP Input Using inputs.conf File","text":"<ul> <li>Create a UP input using conf files</li> <li>Test the created input</li> </ul> <pre><code>root@splunk_uf:/# cd /opt/splunkforwarder/etc/apps/psdemo01/local/\nroot@splunk_uf:/opt/splunkforwarder/etc/apps/psdemo01/local# vi inputs.conf\n\n[udp://115147\nconnection_host = ip\nindex = main\nsourcetype = udp:test\n\n\nroot@splunk_uf:/opt/splunkforwarder/etc/apps/psdemo01/local# /opt/splunkforwarder/bin/./splunk restart\n\n$ echo \"Test data from Splunk UF over UDp\" &gt; /dev/udp/1\n27.0.0.1/11514\n</code></pre> <p><code>index=main sourcetype=udp:test</code></p> <p></p>"},{"location":"spl1/5Mon_create_inputs/#4-getting-windows-data-in","title":"4 Getting Windows Data In","text":"<ul> <li>Windows event log data</li> <li>Local and remote data collection</li> <li>Collecting Windows data on local system</li> <li>Collecting Windows data remotely</li> <li>Collecting host data</li> </ul>"},{"location":"spl1/5Mon_create_inputs/#4-1-monitoring-windows-data-in-splunk-enterprise","title":"4-1 Monitoring Windows Data in Splunk Enterprise","text":"<ul> <li>Win event logs: Collect locally or remotely using WMI</li> <li>Performance monitoring: Performance counters in Performance Monitor</li> <li>Remote monitoring: WMI queries</li> <li>Registry monitoring: Changes to local Windows Registry</li> <li>Active Directory monitoring: Changes to Active Directory</li> </ul> <p>Windows Event Logs</p> <ul> <li>Windows Event Log service handles the logging</li> <li>Microsoft Event Viewer is used to view events </li> <li>Splunk can monitor local and remote log channels</li> <li>Splunk must run on Windows as Local System/Domain Admin</li> <li>Splunk uses WMI to read remote logs</li> </ul> <p>Monitoring Windows System</p> <ul> <li>perfmon: <ul> <li>perfmon type input provides performance metrics from the host for components like CPU, memory, disk, etc.</li> </ul> </li> <li>WinHostMon<ul> <li>WinHostMon stanza helps gathering inventory from a host like specifications of the CPU, disks, running processes, services, etc. </li> </ul> </li> <li>WinRegMon<ul> <li>WinRegMon stanza is created to monitor registry changes on the host. This input is very useful to troubleshoot, as well as auditing purposes. </li> </ul> </li> <li>admon<ul> <li>Admon stanza provides us insight into Active Directory domain or forest\u2011level changes to the users, computers, and other Active Directory objects.</li> </ul> </li> <li>WinNetMon<ul> <li>WinNetMon stanza provides insight to network activity and help monitoring all transactions on the network like network connections and helps detect anomalies and risks like denial\u2011of\u2011service attacks by pinpointing the hosts involved.</li> </ul> </li> <li>WinPrintMon<ul> <li>WinPrintMon stanza gives all statistics about printers and print jobs, helps in auditing the printer subsystem, as well as troubleshooting purposes. </li> </ul> </li> </ul>"},{"location":"spl1/5Mon_create_inputs/#4-2-demo-setting-up-a-local-event-log-collection","title":"4-2 Demo: Setting-up a Local Event Log Collection","text":"<ul> <li>Setup local event log collection </li> <li>Edit the input</li> <li>Verify results</li> </ul> <p><code>index=main sourcetype=WinEventLog:Security</code></p> <p></p> <p>Remote event log collections</p> <p></p> <p><code>&gt; This PC \u203a PSDemo (C:) &gt; Program Files &gt; Splunk &gt; etc \u203a apps \u203a launcher &gt; local</code></p> <p><code>inputs.conf</code></p> <p></p>"},{"location":"spl1/5Mon_create_inputs/#4-3-demo-white-listing-and-black-listing-windows-events","title":"4-3 Demo: White-listing and Black-listing Windows Events","text":"<ul> <li>Blacklisting and whitelisting events</li> <li>Apply whitelist to security log</li> </ul> <p>Filtering Win Event Logs</p> <ul> <li>Blacklisting</li> <li>Whitelisting<ul> <li><code>whitelist, whitelist1\u2026 whitelist9</code></li> </ul> </li> <li> <p>Multiple events</p> <ul> <li>blacklist = 0-2000, 6008</li> <li>whitelist = 4624,4625</li> <li><code>whitelist1 = EventCode=%^462.$% User=%awan%</code></li> </ul> </li> <li> <p>Blacklisting means to ignore certain set of events and allow all the rest. </p> </li> <li>Whitelists work in the same way, but allow certain events while blocking everything else. </li> </ul> <p></p> <p><code>inputs.conf</code></p> <pre><code>[WinEventLog://Security]\ncheckpointInterval = 5\nwhitelist = 4624, 4625\ncurrent only = 0\ndisabled = 0\nstart_from = oldest\n\n[WinEventLog://Application]\ncheckpointInterval = 5\ncurrent_only = 0\ndisabled = 0\nstart_from = oldest\n</code></pre> <p></p> <p><code>index=main sourcetype=WinEventLog:Security</code></p> <p></p> <p>we have learned how to strip off the unnecessary event codes to reduce the noise and amount of data ingested into Splunk</p>"},{"location":"spl1/5Mon_create_inputs/#4-4-demo-create-a-remote-windows-event-log-collection","title":"4-4 Demo: Create a Remote Windows Event Log Collection","text":"<ul> <li>Creating remote win event log collection</li> <li>Test the created input</li> </ul> <p>Monitoring WinEventLogs Remotely</p> <p>Splunk monitors Windows event logs on remote hosts using WMI</p> <ul> <li>Setup <code>wmi.conf</code><ul> <li>WMI stanza in <code>wmi.conf</code></li> </ul> </li> <li>Member of AD Domain<ul> <li>The source machine should be member of same AD domain</li> </ul> </li> <li>Run as Domain Admin<ul> <li>The account Splunk is running as should have domain admin privilege.</li> </ul> </li> </ul> <p></p> <p></p> <p>Remote event logs input has been created successfully.</p> <p></p> <p><code>This PC \u203a PSDemo (C:) &gt; Program Files &gt; Splunk &gt; etc \u203a apps &gt; search \u203a local</code></p> <p><code>wmi.conf</code></p> <pre><code>[WMI:WinRemoteLogs]\ndisabled = 0\nevent_log_file = Security\nindex = default\ninterval = 5\nserver = WinRemote\n</code></pre> <p><code>index=main sourcetype=\"WinEventLog:Security\"</code></p> <p></p> <p></p> <p></p> <p></p> <p></p> <p></p> <p><code>Program Files \u203a Splunk \u203a etc \u203a apps \u203a search \u203a local</code></p> <p><code>wmi.conf</code></p> <pre><code>[WinHostMon://LocalHostMon]\ninterval = 3600\ntype = Processor; Disk\n</code></pre> <p></p> <p></p> <p><code>index=main source=LocalHostMon</code></p> <p></p> <ul> <li>Monitoring Windows data</li> <li>Demo: Collecting Windows data locally</li> <li>Demo: Filtering Windows event log data</li> <li>Demo: Gathering Windows data remotely</li> <li>Demo: Monitoring local host data</li> </ul>"},{"location":"spl1/5Mon_create_inputs/#6-scripted-inputs","title":"6 Scripted Inputs","text":""},{"location":"spl1/5Mon_create_inputs/#overview","title":"Overview","text":"<ul> <li>Scripted inputs in Splunk</li> <li>Creating input through Splunk web</li> <li>Creating scripted inputs using inputs.conf</li> <li> <p>PowerShell Modular inputs</p> <ul> <li>Using Splunk web </li> <li>Using inputs.conf</li> </ul> </li> <li> <p>Using wrapper scripts</p> </li> </ul> <p>Where to use scripted inputs?</p> <ul> <li>Data is dynamic in nature</li> <li>Data is on external/remote systems</li> <li>Need to apply transformations on data before ingesting</li> <li>Need to authenticate before accessing the data</li> <li>Scheduled or continuous monitoring of a system</li> </ul>"},{"location":"spl1/5Mon_create_inputs/#6-1-scripted-input-use-case-scenario","title":"6-1 Scripted Input: Use-Case Scenario","text":"<p>We can use shell scripts, Python scripts, Windows batch files, PowerShell, or any other utility that can format and stream the data that we want to index into Splunk. </p> <p>It is so powerful that we can virtually do any data acquisition task in Splunk using this feature. </p> <p>Scripted inputs in Splunk are set up in <code>inputs.conf</code> files using specific stanza</p> <p>For all those scenarios where we are not able to use simple scripts where we need to send parameters to script or the program running the script is outside of Splunk environment, we can use wrapper scripts. </p> <ul> <li>We can schedule it using standard cron expression or just provide a number of seconds. </li> <li>If we provide value 0 for the interval, this means that the script will run continuously. </li> <li>For a value \u20111, it will only run once on startup. </li> </ul> <p>After setting up scripted input stanza in inputs.conf, we can reload scripted inputs explicitly without restarting Splunk, and we can enable or disable our scripts through the stanza attribute disabled, which is set to false or true accordingly. </p> <p>Scripted inputs are used when the data we are looking at is dynamic in nature, for instance, performance counters like CPU, memory, or disk usage where the data is on external or remote systems, for instance, databases that you send SQL queries through your script and then pass the output and send to Splunk or using the APIs. </p> <p>Another use case might be where you need to apply transformations before sending data to Splunk. For instance, you have data in CSV format, and for some reason, you need to convert it to JSON format before sending to Splunk. </p> <p>Also, sometimes we need to authenticate against a system before getting access to data. For instance, your files are in an AWS S3 bucket. </p> <p>We also use scripts where we want to schedule our inputs, for example, polling a remote logger for current sensor values after 15 minutes for continuously monitoring something for change and sending to Splunk as soon as the condition becomes true. </p>"},{"location":"spl1/5Mon_create_inputs/#demo-creating-scripted-inputs-in-splunk-web","title":"Demo: Creating Scripted Inputs in Splunk Web","text":"<ul> <li>Scripted inputs using Splunk Web</li> <li>Deploy a Python Script</li> <li>Send data to Splunk for ingestion<ul> <li>Read data</li> <li>Convert to JSON</li> <li>Forward to the indexer</li> </ul> </li> <li>Scripted inputs deployment wizard</li> <li>Changes in <code>inputs.conf</code><ul> <li>Verify successful execution and data ingestion</li> </ul> </li> </ul> <pre><code>root@splunk_hf:~# cd /opt/splunk/etc/apps/psdemo01/bin/\nroot@splunk_hf:/opt/splunk/etc/apps/psdemo01/bin# ll\n\ngetServices.ps1\ngetUsersFromFile.py\n.idea/\nREADME\nsimpleScriptedInput.py\n\nroot@splunk_hf:/opt/splunk/etc/apps/psdemo01/bin#\n</code></pre> <p><code>getUsersFromFile.py</code></p> <pre><code>import cv, json\n\nfrom os.path import dirname, realpath, join\n\nfilePath = join(dirname(dirname(realpath(__file__))), 'data', 'users.csv')\n\nwith open (filePath) as usersFile:\n    CSvReader = cv.DictReader(usersFile)\n    for row in csvReader:\n        print(json.dumps(row))\n</code></pre> <p></p> <p></p> <p></p> <p></p> <p></p> <p><code>index=main</code></p> <p></p> <pre><code>root@splunk_hf:/opt/splunk/etc/apps/psdemo01/local# ll\napp.conf\ninputs.conf\n\n\nvi inputs.conf\n\n[default]\nhost = splunk_uf\n\n[script://SSPLUNK_HOME/etc/apps/psdemo01/bin/getUsersFromFile.py]\ndisabled = false\ninterval = 10 19 * * *\nsourcetype = json_no_timestamp\n</code></pre>"},{"location":"spl1/5Mon_create_inputs/#demo-creating-scripted-inputs-using-configuration-files","title":"Demo: Creating Scripted Inputs Using Configuration Files","text":"<ul> <li>Setup a scripted input through conf files</li> <li>Deploy a bash script on the UF</li> <li>Run scripted input manually</li> <li>Changes to inputs.conf</li> <li>Reload scripted inputs without a restart</li> <li>Verify scripted input</li> <li>Troubleshooting</li> </ul> <pre><code>root@splunkuf:~# cd /opt/splunkforwarder/etc/apps/psdemo01/bin/\nroot@splunk_uf:/opt/splunkforwarder/etc/apps/psdemo01/bin# ll\n\ngetServices.ps1\ngetUsersFromFile.py\n.idea/\nperfmon.sh*\nREADME\nsimpleScriptedInput.py\n</code></pre> <p><code>perfmon.sh</code></p> <pre><code>#! /bin/bash\n\ntimestamp() {\n    date +\"%T\"\n}\n\nMEMORY=$(free -m | awk 'NR==2{printf \"%.2f%%\", $3*100/$2}')\nDISK=$(df -h | awk '$NF==\"/\"{printf \"%s\", $5}')\nCPU=$(top -bn1 | grep load | awk '{printf \"%.2f%%\", $(NF-2)}')\necho \"$(timestamp) Memory=\\\"$MEMORY\\\", Disk=\\\"$DISK\\\", CPU=\\\"$CPU\\\"\"\n</code></pre> <pre><code>root@splunk_uf:/opt/splunkforwarder/etc/apps/psdemo01/bin# /opt/splunkforwarder/bin/./splunk cmd /opt/splunkforwarder/etc/apps/psdemo01/bin/perfmon.sh\n\n12:55:14 Memory=\"5.48%\", Disk=\"6%\", CPU=\"0.00%\"\n</code></pre> <p><code>inputs.conf</code></p> <pre><code>[script://$SPLUNK_HOME/etc/apps/psdemo01/bin/perfmon.sh]\ndisabled = false\nindex = main\ninterval = 20\nsourcetype = server:performance\n</code></pre> <pre><code>root@splunk_uf:/opt/splunkforwarder/etc/apps/psdemo01/local#/opt/splunkforwarder/bin/./splunk _internal call /services/data/inputs/script/_reload\n\nQUERYING: 'https: //127.0.0.1:8089/services/data/inputs/script/_reload\n</code></pre> <p><code>index=main sourcetype=server:performance</code></p> <p></p> <p>Error script: perfmon.sh</p> <pre><code>...\necho1 \"$(timestamp) Memory=\\\"$MEMORY\\\", Disk=\\\"$DISK\\\", CPU=\\\"$CPU\\\"\"\n</code></pre> <pre><code>root@splunk_uf:/opt/splunkforwarder/etc/apps/psdemo01/bin# /opt/splunkforwarder/bin/./splunk cmd /opt/splunkforwarder/etc/apps/psdemo01/bin/perfmon.sh\n\n/opt/splunkforwarder/etc/apps/psdemo01/bin/perfmon.sh: line 11: echo1: command not found\n</code></pre> <pre><code>root@splunk_uf:/opt/splunkforwarder/etc/apps/psdemo01/bin# cd /opt/splunkforwarder/var/log/splunk/\nroot@splunk_uf:/opt/splunkforwarder/var/log/splunk# tail -f splunkd.log\n</code></pre> <p></p> <p><code>index=_internal host=splunk_uf error perfmon.sh</code></p> <p></p>"},{"location":"spl1/5Mon_create_inputs/#demo-creating-powershell-modular-input-in-splunk-web","title":"Demo: Creating PowerShell Modular Input in Splunk Web","text":"<ul> <li>PowerShell scripted/modular inputs</li> <li>PowerShell scripted input using Splunk Web</li> <li>View stanza in inputs.conf</li> <li>Verify scripted input</li> </ul> <p>PowerShell Script Inputs</p> <ul> <li>Easy to interact with Windows platform</li> <li>Specific stanza:<ul> <li><code>[powershell://MyPowerShellScript]</code></li> </ul> </li> <li>script &amp; schedule attributes</li> <li>System requirements<ul> <li>Splunk instance on Windows</li> <li>Splunk must run as Local System user</li> <li>PowerShell v3.0 or later</li> <li>Microsoft <code>.NET v4.5</code> or later</li> </ul> </li> </ul> <p>The Use-case</p> <ul> <li>Get all services on Windows</li> <li>Convert them to key-value format</li> <li>Send data to Splunk</li> </ul> <p></p> <p><code>getServices.ps1</code></p> <pre><code>$timeStamp = = Get-date -Format\n$services = Get-Service\n\nforeach($Service in $services){\n    Write-Output \"$timeStamp Name=`\"$($service.Name)`\", Status=`\"$($service.Status)`\", DisplayName=`\"$($service.DisplayName)`\"\"\n}\n</code></pre> <p></p> <p></p> <p></p> <p><code>index=main sourcetype=windows:services</code></p> <p></p> <p></p>"},{"location":"spl1/5Mon_create_inputs/#demo-creating-powershell-modular-input-using-configuration-files","title":"Demo: Creating PowerShell Modular Input Using Configuration Files","text":"<ul> <li>PowerShell scripted input using conf files</li> <li>Single command</li> <li>Create stanza in inputs.conf</li> <li>Verify scripted input</li> </ul> <p><code>getProcess.ps1</code></p> <pre><code>Get-Process | select ProcessName, id, CPU | foreach { Write-Output \"$((Get-Date).ToString('dd-MM-yyyy HH: mm\")) ProcessName=`\"($_.ProcessName)`\", Id=`\"$($_.id)`\", CPU=`\"$($_.CPU)`\"\"}\n</code></pre> <p><code>inputs.conf</code></p> <pre><code>[powershell://WindowsServices]\nschedule = 1800\nscript = . \"$SplunkHome\\etc\\apps\\psdemo01\\bin\\getServices.ps1\"\nsourcetype = windows:services \n\n[powershell://WindowsProcesses]\nschedule = 60\nscript = Get-Process | select ProcessName, id, CPU | foreach { Write-Output \"$((Get-Date).ToString('dd-MM-yyyy HH:mm\")) ProcessName=`\"($_.ProcessName)`\", Id=`\"$($_.id)`\", CPU=`\"$($_.CPU)`\"\"}\n</code></pre> <pre><code>C:\\Program Files\\Splunk\\bin&gt; splunk _internal call /services/data/inputs/powershell/reload\n</code></pre> <p><code>index=main sourcetype=windows:processes</code></p> <p></p> <p></p>"},{"location":"spl1/5Mon_create_inputs/#demo-creating-scripted-inputs-using-wrapper-script","title":"Demo: Creating Scripted Inputs Using Wrapper Script","text":"<ul> <li>Wrapper scripts</li> <li>Scripted input using wrapper script</li> <li>Verify scripted input</li> </ul> <p>Wrapper Script Use-cases</p> <ul> <li>Deploy scripted inputs on Universal Forwarders</li> <li>Runs scripts types that Splunk cannot run out-of-the-box</li> <li>Version conflicts or passing arguments</li> </ul> <p>Deploying a Wrapper Script</p> <ul> <li>CLI command wrapped in a file<ul> <li><code>.sh for linux OS</code></li> <li><code>.bat for Windows OS</code></li> </ul> </li> <li>Deployed as normal scripted input</li> </ul> <pre><code>root@splunk_uf:/opt/splunkforwarder/etc/apps/psdemo01/bin# ll\n\n...\npythonWrapper.sh*\n...\n</code></pre> <pre><code>root@splunk_uf:/opt/splunkforwarder/etc/apps/psdemo01/bin# cd  ../data\nroot@splunk_uf:/opt/splunkforwarder/etc/apps/psdemo01/data# ll\nusers.csv\n</code></pre> <p><code>pythonWrapper.sh</code></p> <pre><code>python3 /opt/splunkforwarder/etc/apps/psdemo01/bin/getUsersFromFile.py\n</code></pre> <p><code>inputs.conf</code></p> <pre><code>[script://$SPLUNK_HOME/etc/apps/psdemo01/bin/perfmon.sh]\ndisabled = false\nindex = main\ninterval = 20\nsourcetype = server:performance\n\n[script://$SPLUNK_HOME/etc/apps/psdemo01/bin/pythonwrapper.sh]\ndisabled = false\nindex = main\ninterval = 60\nsourcetype = json_no_timestamp\nsource = wrapper\n</code></pre> <pre><code>root@splunk_uf:/opt/splunkforwarder/etc/apps/psdemo01/local# cd /opt/splunkforwarder/bin/\nroot@splunk_uf:/opt/splunkforwarder/bin# ./splunk _internal call /services/data/inputs/script/_reload\n</code></pre> <p><code>index=main source=wrapper</code></p> <p></p> <p>Summary</p> <ul> <li>Scripted inputs</li> <li>Bash, Python and PowerShell scripts</li> <li>Scripted inputs on all types of Splunk instances</li> <li>Windows and Linux</li> <li>Different types of scripted inputs<ul> <li>Scripted inputs</li> <li>Powershell modular inputs</li> <li>Wrapper scripts</li> </ul> </li> </ul>"},{"location":"spl1/5Mon_create_inputs/#8-configuring-inputs","title":"8 Configuring Inputs","text":"<ul> <li>Default fields in Splunk Enterprise</li> <li>Process of overriding default fields</li> <li>Demo: Overriding source field</li> <li>Demo: Timestamp extraction</li> </ul>"},{"location":"spl1/5Mon_create_inputs/#3-1-indexed-field-extractions","title":"3-1 Indexed Field Extractions","text":"<p>Parsing phase</p> <ul> <li>Event boundaries</li> <li>Add index-time fields<ul> <li>Default fields</li> <li>Custom fields</li> </ul> </li> </ul> <p>Search time field extractions are performed after the data is indexed</p> <p>Default field extractions</p> <ul> <li>Tagged with each event Three types<ul> <li>Internal fields</li> <li>Default datetime fields</li> <li>Basic default fields</li> </ul> </li> </ul> <p>Most commonly used are host, source, sourcetype, index Default-field overriding</p> <p>Applied to a set of events Transforms applied</p> <ul> <li>props.conf</li> <li>transforms.conf<ul> <li>REGEX</li> <li>FORMAT</li> <li><code>DEST_KEY</code></li> </ul> </li> </ul> <p>Capturing group regex from the event data or static string can be provided</p>"},{"location":"spl1/5Mon_create_inputs/#4-the-http-event-collector-hec","title":"4 The HTTP Event Collector (HEC)","text":"<ul> <li>Introducing HTTP Event Collector</li> <li>Creating HEC token using Splunk Web</li> <li>Sending data to HEC through a script</li> <li>Turning indexer acknowledgement on</li> </ul>"},{"location":"spl1/5Mon_create_inputs/#4-1-introduction-to-splunk-http-event-collector-hec","title":"4-1 Introduction to Splunk HTTP Event Collector (HEC)","text":"<ul> <li>Fast &amp; efficient\uff1a Sends data over HTTP(S)</li> <li>Agentless monitoring: Directly sends data to Splunk</li> <li>Application developers Baked into the code</li> <li>Token based\uff1a No need for credentials hard-coding</li> <li>No Configuration Overheads\uff1a Proxies allow for HTTP  communication</li> </ul> <p>Configuring HTTP Event Collector</p> <ul> <li><code>[http://TokenName]</code> stanza in inputs.conf</li> <li>Enable globally</li> <li>Unique GUID</li> <li>Default port 8088</li> <li>Indexer acknowledgement</li> </ul> <p>Global Settings</p> <ul> <li>[http] stanza contains global settings</li> <li><code>disabled=true/false</code></li> <li><code>maxSockets=&lt;integer&gt;</code></li> <li><code>maxThreads=&lt;integer&gt;</code></li> <li><code>outputGroup=&lt;indexer_group&gt;</code></li> </ul> <p>Per-token Settings</p> <ul> <li><code>queueSize=&lt;integer&gt;KB|MB|GB</code></li> <li><code>persistentqueueSize=&lt;integer&gt;KB|MB|GB</code></li> <li><code>connection_host</code></li> <li>Index and indexes</li> <li>token (a94a5897-2666-485c-a62f-0dc070463ef1)</li> </ul> <pre><code>curl -k -u \"x:12345678-1234-1234-1234-1234567890AB\" https://mysplunkserver.example.com:8088/services/collector/event -d '{\"sourcetype\": \"my_sourcetype\",\n\n    \"host\": \"my_host\", \n    \"index\": \"my_preferred_index\", \n    \"source\": \"my_source\", \n    \"event\": \"My sample event!\"\n}\n</code></pre> <p>Sending Data to HEC (Local Server)</p> <p>Using cURL command with basic authentication</p> <pre><code>curl -k -H \"Authorization: Splunk 12345678-1234-1234-1234-1234567890AB\" https://mysplunkserver.example.com:8088/services/collector/event -d '{\"sourcetype\":  \"my_sourcetype\",\n\n\"host\": \"my_host\", \n\"index\": \"my_preferred_index\", \n\"source\": \"my_source\", \n\"event\": \"My sample event!\"}\n</code></pre> <p>Sending Data to HEC (Local Server)</p> <p>Using cURL command with HTTP Authentication</p> <pre><code>curl -k -H \"Authorization: Splunk 12345678-1234-1234-1234-1234567890AB\" https:// http-inputs- &lt;cust&gt;.splunkcloud.com/services/collector/event -d '{\"sourcetype\": \"my_sourcetype\",\n\n\"host\": \"my_host\", \n\"index\": \"my_preferred_index\", \n\"source\": \"my_source\", \n\"event\": \u201cMy sample event!\"}\n</code></pre> <p>Sending Data to HEC (Splunk Cloud)</p> <p>Using cURL command</p>"},{"location":"spl1/5Mon_create_inputs/#4-2-demo-creating-hec-token-in-splunk-web","title":"4-2 Demo: Creating HEC Token in Splunk Web","text":"<ul> <li>Create a HEC Token in Splunk Web</li> <li>Test the token</li> <li>Check the input stanza</li> <li>Send data to HEC using a script</li> </ul> <p>Status: disabled</p> <p><code>Global Settings</code></p> <p></p> <p></p> <p></p> <p><code>index=main source=hec_manual_test</code></p> <p></p> <pre><code>root@splunk_hf:~# cd /opt/splunk/etc/apps/psdemo01/local/\nroot@splunk_hf:/opt/splunk/etc/apps/psdemo01/local# ll\n\napp.conf\ninputs.conf\n\nvi inputs.conf\n\n[default]\nhost = splunk_uf\n\n[http://PSDemo Users Test]\ndisabled = 0\nhost = splunk_hf\nindex = main\nindexes = history,main\nsource = hec_test_users\nsourcetype = json_no_timestamp\ntoken = a94a5897-2666-485c-a62f-Odc070463ef1\nuseACK = 0\n</code></pre>"},{"location":"spl1/5Mon_create_inputs/#4-3-demo-sending-events-through-hec-using-a-script","title":"4-3 Demo: Sending Events through HEC Using a Script","text":"<ul> <li>Send users data to Splunk using HEC token</li> <li>Setup and run the Python Script</li> <li>Verify results</li> </ul> <p>Scripted Input: Use-Case Scenario</p> <p></p> <pre><code>cd /opt/splunkforwarder/etc/apps/psdemo01/bin/# ll\n\n...\nsendUsersUsingHEC.pV\n...\n</code></pre> <pre><code>import cv, json, requests, urllib3\nfrom os.path import dirname, realpath, join\n\n#Disable certs warning\nurllib3.disable_warnings(urllib3.exceptions. InsecureRequestwarning)\n\nFilePath = join(dirname (dirname(realpath(__file__))), 'data', 'users.csv')\n\n#Add the HEC token that you want to send the data through\n\nauthToken=\"a94a5897-2666-485c-a62f-0dc070463ef1\"\n\n#IP or name of the host HEC token is set on\nsplunkHost= \"172.17.11.27\"\n\n#Port set for HEC communication. Defaults to 8088\nhecPort = \"8080\"\n\n#Prepart the URL the URL\nurl = \"https://\"+splunkHost+\":\"+hecPort+\"/services/collector/event\"\n\n#Prepare the header with the HEC token\nauthHeader = {'Authorization' : 'Splunk '+authToken}\n\n#Read the users from file and loop through each record\nwith open (filePath) as usersfile:\n    csvReader = cv.DictReader(usersFile)\n    for row in csvReader: \n    # Initialise and update current record to send through HEC\n        record = {}\n        record.update({'source': 'hec_test'})\n        record.update({'sourcetype': 'json_no_timestamp'})\n        record.update({event': (json.dumps(row))})\n\n    # Send the record\n        r = requests.post(url, headers=authHeader, json-record, verify=False)\n</code></pre> <pre><code>python3 sendUsersUsingHEC.py\n</code></pre> <p>New search: <code>index=main source=\"hec_test\"</code></p> <p></p>"},{"location":"spl1/5Mon_create_inputs/#demo-enabling-indexer-acknowledgement-for-reliable-data-ingestion","title":"Demo: Enabling Indexer Acknowledgement for Reliable Data Ingestion","text":"<p>Indexer acknowledgements</p> <ul> <li><code>useAck=true</code></li> <li>Per-token basis</li> <li>X-Splunk-Request-Channel</li> <li>Package tracking<ul> <li>services/collector/event<ul> <li>Acknowledgement ID</li> </ul> </li> <li>services/collector/ack<ul> <li>Status</li> </ul> </li> </ul> </li> </ul> <pre><code>curl -k -u \"x:a94a5897-2666-485c-a62f-0dc070463ef1\" https://hostname_or_ip:8088/services/collector/event -H \"X-Splunk-Request-Channel: FE0ECFAD-13D5-401B-847D-77833BD77131\u201c -d '{\"source\": \u201cmysource\", \"event\": \u201cmyevent\"}\u2019\n</code></pre> <p><code>{\"text\":\"Success\",\"code\":0,\"ackId\":7}</code></p> <p>Sending Data with Indexer Acknowledgement</p> <p>Using cURL command</p> <pre><code>curl -k -u \"x:a94a5897-2666-485c-a62f-0dc070463ef1\" \"https://hostname_or_ip:8088/services/collector/ack\" -H \"X-Splunk-Request-Channel: E0ECFAD-13D5-401B-847D-77833BD77131\" -d '{\"acks\":[7]}'\n</code></pre> <p><code>{\"acks\":{\u201c7\":true}}</code></p> <pre><code>root@splunk_hf:~# cd /opt/splunk/etc/apps/psdemo01/local/\n\nvi inputs.conf\n\n[default]\nhost = splunk_uf\n\n[http://PSDemo Users Test]\ndisabled = 0\nhost = splunk_hf\nindex = main\nindexes = history,main\nsource = hec_test_users\nsourcetype = json_no_timestamp\ntoken = a94a5897-2666-485c-a62f-Odc070463ef1\nuseACK = 1\n</code></pre> <pre><code>root@splunk_hf:/opt/splunk/etc/apps/psdemo01/local# /opt/splunk/bin/./splunk restart\n</code></pre> <p></p> <p></p> <ul> <li>HTTP Event Collector</li> <li>Demo: HEC token using Splunk Web</li> <li>Demo: Sending data to HEC using script</li> <li>Demo: Indexer acknowledgement</li> </ul>"},{"location":"spl1/5Mon_create_inputs/#5-configuring-inputs","title":"5 Configuring Inputs","text":"<p>Overview</p> <ul> <li>Default fields in Splunk Enterprise</li> <li>Process of overriding default fields</li> <li>Demo: Overriding source field</li> <li>Demo: Timestamp extraction</li> </ul>"},{"location":"spl1/5Mon_create_inputs/#5-1-event-parsing-and-default-field-extraction-in-splunk-enterprise","title":"5-1 Event Parsing and Default Field Extraction in Splunk Enterprise","text":"<p>Parsing phase Event</p> <ul> <li>Event boundaries</li> <li>Add index-time fields<ul> <li>Default fields</li> <li>Custom fields</li> </ul> </li> </ul> <p>Search time field extractions are performed after the data is indexed</p> <p>For example, we want to assign a field a certain value based on other field value and make it part of the event. </p> <p>We can also perform search time field extractions, but the difference is that the search time field extractions don't become permanently part of the event.</p> <p>Default field extractions</p> <p>The default fields extracted are tagged to each event before it is indexed and written to the disk. </p> <p>Tagged with each event Three types</p> <ul> <li>Internal fields<ul> <li>The internal fields contain information that Splunk software uses for internal purposes. These fields start with an underscore. Most common ones are <code>_raw</code>, <code>_time</code>, and <code>_index</code> time, and the default datetime fields are basically different granular representation of the timestamp like <code>date_hour</code>, <code>date_minute</code>, or <code>date_month</code>, etc.</li> </ul> </li> <li>Default datetime fields</li> <li>Basic default fields</li> </ul> <p>The basic default fields provide basic information about an event such as where it originated, what type of data it contains, what index it is located in, etc.</p> <p>Common basic fields are host, source, sourcetype, index, line count, and timestamp.</p> <p>Default-field overriding</p> <p>Applied to a set of events Transforms applied</p> <ul> <li>props.conf</li> <li>transforms.conf<ul> <li>REGEX</li> <li>FORMAT</li> <li><code>DEST_KEY</code></li> </ul> </li> </ul> <p>Capturing group regex from the event data or static string can be provided</p>"},{"location":"spl1/5Mon_create_inputs/#5-2-demo-overriding-a-default-field","title":"5-2 Demo: Overriding a Default Field","text":"<p>Override source value in a monitor input</p> <ul> <li>props.conf</li> <li>transforms.conf</li> </ul> <p>Test the results</p> <pre><code>root@splunk_hf:/opt/splunk/etc/apps/psdemo01/local# ll\n\napp.conf\ninputs.conf\n\n# vi inputs.conf\n</code></pre> <pre><code>[default]\nhost = splunk_hf\n\n[monitor:///opt/splunk/etc/apps/psdemo01/data/web_source_override.log]\ndisabled = false\nsourcetype = web:sourceoverride\nindex-main\n</code></pre> <pre><code>root@splunk_hf:/opt/splunk/etc/apps/psdemo01/local# vi props.conf\n\n[web:sourceoverride]\nTRANSFORMS-changesource = web_src_override\n</code></pre> <pre><code>transforms.conf\n\n[web_src_override]\nREGEX = (\\d+\\.\\d+\\.\\d+\\.\\d+)\nFORMAT = source::$1\nDEST_KEY = MetaData:Source\n</code></pre> <pre><code>root@splunk_hf:/opt/splunk/etc/apps/psdemo01/local# /opt/splunk/bin/./splunk restart\n</code></pre> <p><code>index=main sourcetype=web:sourceoverride</code></p> <p></p>"},{"location":"spl1/5Mon_create_inputs/#5-3-demo-assigning-custom-timestamp-to-events","title":"5-3 Demo: Assigning Custom Timestamp to Events","text":"<ul> <li>Override timestamp</li> <li>Test the results</li> </ul> <pre><code>root@splunk_hf:/opt/splunk/etc/apps/psdemo01/local# vi inputs.conf\n\n[default]\nhost = splunk_hf\n[monitor:///opt/splunk/etc/apps/psdemo01/data/server_perfmon.log]\ndisabled = false\nindex = main\nsourcetype = server:perfmon\n</code></pre> <p><code>vi props.conf</code></p> <pre><code>[server:perfmon]\nTIME_PREFIX = TimeAdded\\=\\\"\nTIME_FORMAT = %Y-%m-%d %H:%M:%S\n</code></pre> <pre><code>root@splunk_hf:/opt/splunk/etc/apps/psdemo01/local# /opt/splunk/bin/./splunk restart\n</code></pre> <p><code>index=main sourcetype=server:perfmon</code></p> <p></p> <p></p>"},{"location":"spl1/6par_man/","title":"6 Splunk Administration: Parsing and Manipulating Data","text":""},{"location":"spl1/6par_man/#1-splunk-enterprise-administration-parsing-and-manipulating-data","title":"1 Splunk Enterprise Administration: Parsing and Manipulating Data","text":"<p>Overview</p> <ul> <li>Event processing in Splunk Enterprise</li> <li>Role of configuration files<ul> <li><code>props.conf</code></li> <li><code>transforms.conf</code></li> </ul> </li> <li>Introduction to the course</li> <li>Demo: Setting up the test environment</li> </ul>"},{"location":"spl1/6par_man/#1-1-event-processing-in-splunk-enterprise","title":"1-1 Event Processing in Splunk Enterprise","text":"<p>Data Pipeline in Splunk Enterprise</p> <p></p> <p><code>props.conf</code></p> <ul> <li>Configuring pre-processing properties</li> <li>Attribute/value pairs</li> <li>Observe order of precedence<ul> <li>System local directory \u2013 highest</li> <li>App local directory</li> <li>App default directory</li> <li>System default directory \u2013 lowest</li> </ul> </li> </ul> <p>Restart required</p> <p><code>Transforms.conf</code></p> <ul> <li>Settings to configure data transformations</li> <li>Covers the \u201chow\u201d part of things</li> <li>Requires corresponding setting in <code>props.conf</code></li> <li>Unique stanza name<ul> <li>REGEX</li> <li><code>WRITE_META</code></li> <li><code>DEST_KEY</code></li> <li>FORMAT</li> </ul> </li> </ul> <p>Data Input Methods</p> <ul> <li> <p>Event Line-breaking</p> <ul> <li>Identifying and configuring line-breaks</li> </ul> </li> <li> <p>Parsing Timestamps</p> <ul> <li>Recognizing and parsing timestamps</li> </ul> </li> <li> <p>Field Extractions</p> <ul> <li>Custom and default field extractions and overriding</li> </ul> </li> <li> <p>Routing and Filtering</p> <ul> <li>Filtering and sending events to selective and multiple indexers</li> </ul> </li> </ul>"},{"location":"spl1/6par_man/#1-2-demo-setting-up-the-test-environment","title":"1-2 Demo: Setting up the Test Environment","text":"<ul> <li>Understand topology of test environment</li> <li>Setup test environment<ul> <li>Configure forwarding and receiving</li> <li>Install EventGen and the demo app</li> </ul> </li> </ul> <p>add <code>New Receiving Port</code></p> <p></p> <p><code>Forward data</code></p> <p></p> <p><code>172.17.11.29:9997</code></p> <p></p> <pre><code>root@splunk_hf:/opt/splunk/etc/system/local# vi outputs.conf\n\n[tcpout]\ndefaultGroup = default-autolb-group\n\n[tcpout: default-autolb-group]\nserver = 172.17.11.29:9997\n\n[tcpout-server://172.17.11.29:99971\n</code></pre> <pre><code>root@splunk_hf:/opt/splunk/etc/system/local# /opt/splunk/bin/./splunk list forward-server\n\nroot@splunk_hf:/opt/splunk/etc/apps/psdemo/default# vi inputs.conf\n</code></pre> <pre><code>sourcetype = customers\n[\nscript://./bin/lineBreaking.py]\ndisabled = 0\ninterval = 60\nindex = main\nsource = linebreaking_script\nsourcetype = linebreaking\n\n[script://./bin/lineMerging.py]\ndisabled = 0\ninterval = 60\nindex = main\nsource = linemerging_script\nsourcetype = linemerging\n\n[script://./bin/configureLineBreaker.py]\ndisabled = 0\ninterval = 60\nindex = main\nsource = configurelinebreaker_script\nsourcetype = configlinebreaker\n\n[script://./bin/timestampoverride.py]\ndisabled = 0\ninterval = 60\nindex = main\nsource = timestamp_override_script\nsourcetype = timestamp_override\n</code></pre> <p><code>index=main | stats count by sourcetype</code></p>"},{"location":"spl1/6par_man/#2-configuring-event-line-breaking","title":"2 Configuring Event Line-breaking","text":"<ul> <li>Event line-breaking</li> <li>Demo: Breaking simple events</li> <li>Demo: Breaking multiline events</li> <li>Demo: Breaking events using line breaker</li> </ul>"},{"location":"spl1/6par_man/#2-1-configuring-line-breaks-in-splunk-enterprise","title":"2-1 Configuring Line-breaks in Splunk Enterprise","text":"<p>Line breaking</p> <ul> <li><code>SHOULD_LINEMERGE=false</code></li> <li>Uses LINE_BREAKER regex that by default is: <code>([\\r\\n]+)</code></li> </ul> <p>Line merging</p> <ul> <li>Explicitly provide line break setting using attributes like <code>BREAK_ONLY_BEFORE</code> or <code>MUST_BREAK_AFTER</code> etc</li> <li><code>SHOULD_LINEMERGE=true</code></li> </ul> <p>Configuring Multi-line Event Boundaries</p> <ul> <li>Break and re-assemble data stream </li> <li>Add a stanza in <code>props.conf</code></li> <li>Set <code>SHOULD_LINEMERGE = true</code></li> <li>Set the line merging attributes<ul> <li><code>BREAK_ONLY_BEFORE</code></li> <li><code>BREAK_ONLY_BEFORE_DATE</code></li> <li><code>MUST_BREAK_AFTER</code></li> <li><code>MAX_EVENTS</code></li> </ul> </li> </ul> <p>Breaking Data Stream into Real Events</p> <ul> <li>More efficient but hard to work with</li> <li>Add a stanza in <code>props.conf</code></li> <li>Set <code>SHOULD_LINEMERGE = false</code></li> <li>Set <code>LINE_BREAKER</code> attribute<ul> <li>Default is <code>([\\r\\n]+)</code></li> <li>Set to regex matching event boundary</li> <li>Restart Splunk</li> </ul> </li> </ul>"},{"location":"spl1/6par_man/#2-2-demo-configuring-line-breaking-using-a-regex","title":"2-2 Demo: Configuring Line-breaking Using a Regex","text":"<ul> <li>Configuring simple line breaking</li> <li>Based on regex pattern</li> <li>Configurations in props.conf<ul> <li><code>SHOULD_LINEMERGE = true</code></li> <li><code>MUST_BREAK_AFTER = &lt;regex&gt;</code></li> </ul> </li> <li>Restart Splunk</li> </ul> <pre><code>root@splunk_hf:/opt/splunk/etc/apps/psdemo# vi default/inputs.conf\n\n[script://./bin/getPerformance.py]\ndisabled= 0\nindex = main\nsource = perfmon_script\nsourcetype = performance\n\n[script://./bin/custGen.py]\ndisabled = 0\ninterval = 300\nindex = main\nsource = custgen_script\nsourcetype = customers\n\n\n[script://./bin/lineBreaking.py]\ndisabled = 0\ninterval = 60\nindex = main\nsource = linebreaking_script\nsourcetype = linebreaking\n</code></pre> <pre><code>root@splunk_hf:/opt/splunk/etc/apps/psdemo# vi bin/lineBreaking.py\n\nimport random as r\n\nfor i in range(1,10) :\n    print (\"This is an event with id\" + str(r.randrange(111,999)))+ \"\\n\"\n</code></pre> <p><code>index=main sourcetype=linebreaking</code></p> <p></p> <p></p> <pre><code>vi bin/lineBreaking.py\n\nvi local/props.conf\n\nSHOULD_LINEMERGE = true\nMUST_BREAK_AFTER = \\d{3}\n</code></pre> <pre><code>root@splunk_hf:/opt/splunk/etc/apps/psdemo#/opt/splunk/bin/splunk restart\n</code></pre> <p></p>"},{"location":"spl1/6par_man/#2-3-demo-breaking-multi-line-events-and-line-merging","title":"2-3 Demo: Breaking Multi-line Events and Line-merging","text":"<ul> <li>Line breaking in multiline events<ul> <li><code>BREAK_ONLY_BEFORE_DATE</code></li> </ul> </li> <li>Based on regex pattern</li> <li>Configurations in props.conf<ul> <li><code>SHOULD_LINEMERGE = true</code></li> <li><code>BREAK_ONLY_BEFORE= &lt;regex&gt;</code></li> </ul> </li> <li>Restart Splunk</li> </ul> <pre><code>root@splunk_hf:/opt/splunk/etc/apps/psdemo# vi default/inputs.conf\n\n[script://./bin/getPerformance.py]\ndisabled = 0\nindex = main\nsource = perfmon_script\nsourcetype = performance\n\n\n[script://./bin/custGen.py]\ndisabled = 0\ninterval = 300\nindex = main\nsource = custgen_script\nsourcetype = customers\n\n[script://./bin/lineBreaking.py]\ndisabled = 0\ninterval = 60\nindex = main\nsource = linebreaking_script\nsourcetype = linebreaking\n\n[script://./bin/lineMerging.py]\ndisabled = 0\ninterval = 60\nindex = main\nsource = linemerging_script\nsourcetype = linemerging\n</code></pre> <p><code>\"bin/lineMerging.py\"</code></p> <pre><code>from datetime import datetime as dt\n\ndef getTimestamp():\n    return dt.now().strftime(\"%Y-%m-%d %H:%M\")\n\nfor i in range(1,10):\n    print (\"&lt;soe&gt; The temperature received from the sensors was NORMAL. Temperature recorded at: \")\n    print (getTimestamp()+\" was 38 degrees celcius. This is the end of event\")\n</code></pre> <pre><code>root@splunk_hf:/opt/splunk/etc/apps/psdemo# /opt/splunk/bin/pythonbin/lineMerging.py\n\n&lt;soe&gt; The temperature received from the sensors was NORMAL. Temperature recorded at:\n2020-09-05 13:07 was 38 degrees celcius. This is the end of event\n&lt;soe&gt; The temperature received from the sensors was NORMAL. Temperature\n&lt;soe&gt; The temperature received from the sensors was NORMAL. Temperature recorded at\n2020-09-05 13:07 was 38 degrees celcius. This is the end of event\n</code></pre> <p><code>index=main sourcetype=linemerging</code></p> <p></p> <p><code>\"local/props.conf\"</code></p> <pre><code>[linebreaking]\nSHOULD_LINEMERGE = true\nMUST_BREAK_AFTER = \\{3}\n\n[linemerging]\nSHOULD_LINEMERGE = true\nBRFAK_ONLY_BEFORE = \\&lt;soe&gt;\\\n</code></pre> <p><code>/opt/splunk/bin/splunk restart</code></p> <p><code>index=main sourcetype=linemerging</code></p> <p></p>"},{"location":"spl1/6par_man/#2-4-demo-configuring-line-breaking-with-line-breaker-attribute","title":"2-4 Demo: Configuring Line-breaking with Line Breaker Attribute","text":"<ul> <li>Configuring simple line breaking</li> <li>More efficient method</li> <li>Configurations in props.conf<ul> <li><code>SHOULD_LINEMERGE = false</code></li> <li><code>LINE_BREAKER = &lt;regex&gt;</code></li> </ul> </li> <li>Restart Splunk</li> </ul> <pre><code>root@splunk_hf:/opt/splunk/etc/apps/psdemo# vi default/inputs.conf\n\nsourcetype = performance\n\n[script://./bin/custGen.py]\ndisabled = 0\ninterval = 300\nindex = main\nsource = custgen_script\nsourcetype = customers\n\n[script://./bin/lineBreaking.py]\ndisabled = 0\ninterval = 60\nindex = main\nsource = linebreaking_script\nsourcetype = linebreaking\n\n[script://./bin/lineMerging.py]\ndisabled = 0\ninterval = 60\nindex = main\nsource = linemerging_script\nsourcetype = linemerging\n\n[script://./bin/configureLineBreaker.py]\ndisabled = 0\ninterval = 60\nindex = main\nsource = configurelinebreaker_script\nsourcetype = configlinebreaker\n</code></pre> <pre><code>root@splunk_hf:/opt/splunk/etc/apps/psdemo# vi default/inputs.conf\n\n\"bin/configureLineBreaker.py\"\n\nfor i in range(1,10) :\n    print('&lt;This is line number: \"+str(i)+\" of event&gt;\")\n</code></pre> <p><code>index=main sourcetype = configlinebreaker</code></p> <p></p> <pre><code>root@splunk_hf:/opt/splunk/etc/apps/psdemo#/opt/splunk/bin/python bin/configureLineBreaker.py\n\n&lt;This is line number: 1 of event&gt;\n&lt;This is line number: 2 of event&gt;\n&lt;This is line number: 3 of event&gt;\n&lt;This is line number: 4 of event&gt;\n&lt;This is line number: 5 of event&gt;\n&lt;This is line number: 6 of event&gt;\n&lt;This is line number: 7 of event&gt;\n&lt;This is line number: 8 of event&gt;\n&lt;This is line number: 9 of event&gt;\n</code></pre> <pre><code>vi local/props.conf\n\n/opt/splunk/bin/splunk restart\n</code></pre> <p><code>index=main sourcetype = configlinebreaker</code></p> <p></p> <pre><code>[linebreaking]\nSHOULD_LINEMERGE = true\nMUST_BREAK_AFTER = \\d{3}\n\n[linemerging]\nSHOULD_LINEMERGE = true\nBREAK_ONLY_BEFORE = \\&lt;soe\\&gt;\n\n[configlinebreaker]\nSHOULD_LINEMERGE = false\nLINE_BREAKER = (\\&gt;)\n</code></pre> <pre><code>/opt/splunk/bin/splunk restart\n</code></pre> <p><code>index=main sourcetype=\"confielinebreaker\"</code></p> <p></p>"},{"location":"spl1/6par_man/#3-identifying-and-parsing-timestamps","title":"3 Identifying and Parsing Timestamps","text":"<ul> <li>Timestamp properties in Splunk </li> <li>Timestamp attributes</li> <li>Timestamp formats</li> <li>Demo: Time-zone recognition</li> <li>Demo: Timestamp attributes in Splunk Web</li> <li>Demo: Timestamp overriding</li> </ul>"},{"location":"spl1/6par_man/#3-1-configuring-timestamp-recognition-in-splunk-enterprise","title":"3-1 Configuring Timestamp Recognition in Splunk Enterprise","text":"<ul> <li> <p>Nothing without a timestamp</p> <ul> <li>All events must have a timestamp. If not, Splunk assigns one</li> </ul> </li> <li> <p>Edit <code>props.conf</code></p> <ul> <li>To configure or modify timestamps we edit <code>props.conf</code></li> </ul> </li> <li> <p>Timestamp recognition</p> <ul> <li>Splunk recognizes most of the timestamp formats out-of-the box</li> </ul> </li> <li> <p>Enhanced strptime() support</p> <ul> <li>Keep the text to three lines or fewer</li> </ul> </li> <li> <p>Timestamp validity attributes</p> <ul> <li>For accepting or rejecting the timestamp in the events</li> </ul> </li> </ul> <p>Editing Timestamp Properties</p> <ul> <li>Timestamp configurations are done on heavy forwarders or indexers</li> <li>Configuration applied to <code>&lt;sourcetype&gt;, source::&lt;source&gt;</code> or <code>host::&lt;host&gt;</code></li> <li>Identifying correct format of the timestamp is the key</li> <li>Select the correct timestamp if multiple timestamps are present</li> <li>Account for correct time-zones</li> </ul> <p>Timestamp Attributes</p> <ul> <li> <p><code>DATETIME_CONFIG</code></p> <ul> <li>Provide a file that contains timestamp formats.  NONE to disable &amp; CURRENT for current ts</li> <li><code>$SPLUNK_HOME/etc/datetime.xml</code></li> </ul> </li> <li> <p><code>TIME_PREFIX</code></p> <ul> <li>Regex pattern found before each timestamp</li> <li>Empty string</li> </ul> </li> <li> <p><code>MAX_TIMESTAMP_LOOKAHEAD</code></p> <ul> <li>Number of characters from start of event</li> <li>128 characters</li> </ul> </li> <li> <p><code>TIME_FORMAT</code></p> <ul> <li>Unix <code>strptime()</code> format string</li> <li>Empty string</li> </ul> </li> <li> <p>TZ</p> <ul> <li>Time-zone like UTC or +10:00 for Australia/Brisbane etc</li> <li>Empty string</li> </ul> </li> <li> <p><code>MAX_DAYS_AGO</code></p> <ul> <li>Ignore events older than this value. <code>MAX_DAYS_AGO=10</code> will ignore events over 10  days old</li> <li>2000 days</li> </ul> </li> <li> <p><code>MAX_DAYS_HENCE</code></p> <ul> <li>Ignore events more than this values in future.  <code>MAX_DAYS_HENCE=3</code> will ignore events over 3  days in future</li> <li>2 days</li> </ul> </li> </ul> <p>Timestamp Format</p> <ul> <li><code>%d, %m, %Y</code> Number of day, month and year (four digit). <code>%y</code> for two digits</li> <li><code>%b, %B</code>: Abbreviated month (Jan, Jun), Full name (January, June)</li> <li><code>%H, %I, %p, %M, %S</code>:  Hour (24 hours) %I (12 hours) with <code>%p</code> as locale\u2019s equivalent of AM or PM. %M minutes and <code>%S</code> seconds</li> <li><code>%Z</code> Time zone abbreviations like GMT</li> <li><code>%z, %:z, %::z</code>:  Time zone offset +1000, +10:00 and +10:00:00</li> <li><code>%s</code> Epoch time (10 digits)</li> <li><code>%N</code> For GNU date-time nanoseconds. Sub-seconds %3N, %6N</li> <li><code>%+</code> For standard Unix date format timestamps</li> </ul>"},{"location":"spl1/6par_man/#3-2-demo-translating-time-zones","title":"3-2 Demo: Translating Time Zones","text":"<p>Configuring Time-zone</p> <ul> <li>Sample events in UTC time</li> <li>Adding configuration to props.conf</li> <li>Converting to local time before indexing</li> </ul> <pre><code>root@splunk_hf:~# cd /opt/splunk/etc/apps/psdemo/ \nroot@splunk_hf:/opt/splunk/etc/apps/psdemo# ll bin\n...\nutcTimestamp.py\n...\n\nvi bin/utcTimestamp.py\n\nfrom time import strftime, gmtime\nfor i in range(0,5) :\n    print(strftime(\"%Y-%m-%d %H:%M\" ,gmtime())+\" This event is originally in UTC time with id: \" + str(i))\n\n\nroot@splunk_hf:/opt/splunk/etc/apps/psdemo# /opt/splunk/bin/splunk cmd python bin/utcTimestamp.py\n\n2020-09-19 01:50 This event is originally in UTC time with id: 0\n2020-09-19 01:50 This event is originally in UTC time with id: 1\n2020-09-19 01:50 This event is originally in UTC time with id: 2\n2020-09-19 01:50 This event is originally in UTC time with id: 3\n2020-09-19 01:50 This event is originally in UTC time with id: 4\n</code></pre> <pre><code>root@splunk_hf:/opt/splunk/etc/apps/psdemo# date\nSat Sep 19 11:50:16 AEST 2020\n</code></pre> <pre><code>[script://./bin/utcTimestamp.py]\ndisabled = 0\nindex = main\nsource = utcts_script\nsourcetype = utc_timestamp\n\n[script://./bin/getPerformance.py]\ndisabled = 0\nindex = main\nsource = perfmon_script\nsourcetype = performance\n\n[script://./bin/custGen.py]\ndisabled = O\ninterval = 300\nindex = main\nsource = custgen_script\nsourcetype= customers\n\n[script://./bin/lineBreaking.py]\ndisabled = 0\ninterval = 60\nindex = main\nsource = linebreaking_script\nsourcetype = linebreaking\n\n[script://./bin/lineMerging.py]\ndisabled =0\ninterval = 60\nindex = main\nsourcetype = linemerging\n</code></pre> <p><code>index=main sourcetype=utc_timestamp</code></p> <p></p> <p></p> <ul> <li> <p>Timestamp format: <code>%d%b-%Y:%H:%M:%S</code></p> </li> <li> <p>Timestamp prefix <code>\\</code></p> </li> </ul> <p></p> <p><code>\"local/props.conf\"</code></p> <pre><code>[utc_timestamp]\nTZ = UTC\n</code></pre> <pre><code>root@splunk_hf:/opt/splunk/etc/apps/psdemo# vi local/props.conf\nroot@splunk_hf:/opt/splunk/etc/apps/psdemo# /opt/splunk/bin/splunk restart\n</code></pre> <p><code>index=main sourcetype=utc_timestamp</code></p> <p></p>"},{"location":"spl1/6par_man/#3-3-demo-using-splunk-web-for-timestamp-recognition-and-extraction","title":"3-3 Demo: Using Splunk Web for Timestamp Recognition and Extraction","text":"<p>Configure timestamp through Splunk Web</p> <ul> <li>Events with non-standard timestamp</li> <li>Very old events</li> <li>Timestamp prefix value</li> <li>Timestamp recognition &amp; line breaking</li> <li>Stanza in props.conf</li> </ul> <pre><code>root@splunk_hf:~# cd /opt/splunk/etc/apps/psdemo/\nroot@splunk_hf:/opt/splunk/etc/apps/psdemo# vi data/web_old.log\n\n61.130.186.27 -- [30Mar-1998:14:03:13] \"GET /cart.do?action=addtocart&amp;itemId-HYD-29&amp;JSESSIONID-CA9MO3AZIUSANA34656 HTTP 1.1\" 503 694 \"http://www.salesonline.com/category.screen?categoryId-BLUE_GIZMOS\" \"Mozilla/5.0 (Windows; U;\nWindows NT 5.1; en-GB; rv:1.8.1.6) Gecko/20070725 Firefox/2.0.0.6\" 444\n</code></pre> <p></p> <p><code>%d%b-%Y:%H:%M:%S</code></p> <p></p> <p></p> <p><code>index=main sourcetype=old_weblogs</code></p> <p></p> <pre><code>[utc_timestamp]\nTZ = UTC\n\n[old_weblogs]\nDATETIME_CONFIG =\nLINE_BREAKER = ([\\r\\n]+)\nMAX_DAYS_AGO = 9000\nNO_BINARY_CHECK = true\nTIME_FORMAT = %d%b-%Y:%H:%M:%S\nTIME_PREFIX = \\[\ncategory = Custom\ndescription = Very old web server logs with weird date format\npulldown_type = true\n</code></pre>"},{"location":"spl1/6par_man/#3-4-demo-overriding-timestamps","title":"3-4 Demo: Overriding Timestamps","text":"<p>Overriding event timestamp</p> <ul> <li>Events with multiple timestamps</li> <li>Custom timestamp</li> <li>Configuration in <code>props.conf</code></li> </ul> <pre><code>root@splunk_hf:/opt/splunk/etc/apps/psdemo# vi bin/timestampoverride.py\n\nimport datetime, time\nfor i in range(0,5):\n    print (datetime.datetime.now().strftime(\"%d/%m/%Y %H:%M:%S\") + \". is the timestamp on this event number: \" \nstr(i) + \". But I want timestamp=\" + (datetime.datetime.now()- datetime.timedelta(minutes=90)).strftime(\"%Y, %B %d at %H:%M:%S\"))\n    time.sleep(5)\n</code></pre> <pre><code>root@splunk_hf:/opt/splunk/etc/apps/psdemo# /opt/splunk/bin/splunk cmd pythonbin/timestampOverride.py\n\n20/09/2020 17:38:45 is the timestamp on this event number: O. But I want timestamp=2020. September 20 at 16:08:45\n20/09/2020 17:38:50 is the timestamp on this event number: 1. But I want timestamp=2020. September 20 at 16:08:50\n</code></pre> <p><code>index=main sourcetype=timestamp_override</code></p> <p></p> <p><code>\"local/props.conf\"</code></p> <pre><code>[utc_timestamp]\nTZ = UTC\n\n[old _weblogs]\nDATETIME_CONFIG= \nLINE_BREAKER = ([\\r\\n]+)\nMAX_DAYS_AGO = 9000\nNO_BINARY_CHECK = true\nTIME FORMAT = %d%b-%Y:%H:%M:%S\nTIME_PREFIX = \\[\ncategory = Custom\ndescription = Very old web server logs with weird date format\npulldown_type = true\n\n[timestamp_override]\nTIME_PREFIX = timestamp=\nTIME_FORMAT = %Y, %B %d at %H:%M:%S\nMAX_TIMESTAMP_LOOKAHEAD = 200\nDATETIME_CONFIG=\n</code></pre> <pre><code>root@splunk_hf:/opt/splunk/etc/apps/psdemo#/opt/splunk/bin/splunk restart\n</code></pre> <p><code>index=main sourcetype=timestamp_override</code></p> <p></p> <ul> <li>Timestamp recognition in Splunk</li> <li>Timestamp attributes</li> <li>Translating time-zones</li> <li>Using Splunk web for timestamp handling</li> <li>Overriding timestamp</li> </ul>"},{"location":"spl1/6par_man/#4-overriding-default-fields-and-custom-fields-extraction","title":"4 Overriding Default Fields and Custom Fields Extraction","text":"<ul> <li>Defaults fields in Splunk Enterprise</li> <li>Process of overriding default fields</li> <li>Demo: Overriding default fields</li> <li>Index-time field extraction</li> <li>Demo: Custom fields extraction</li> </ul>"},{"location":"spl1/6par_man/#4-1-overriding-default-fields","title":"4-1 Overriding Default Fields","text":"<p>Default Fields</p> <ul> <li>Tagged and added automatically to event data at index time</li> <li>Each default field holds information about the data it is tagged to</li> <li>Three types of default fields: Internal, basic and datetime</li> <li>Overridden when default behavior needs to be changed</li> <li> <p>Change does not apply to previously indexed events</p> </li> <li> <p>Internal</p> <ul> <li><code>_raw</code>, <code>_time</code>, <code>_indextime</code>, <code>_cd</code></li> </ul> </li> </ul> <p>Default Field Override \u2013 Scenarios</p> <p>Default fields that we often need to override</p> <ul> <li>host</li> <li>source</li> <li>sourcetype</li> </ul> <p>Some examples:</p> <ul> <li>Host is replaced when events originate from log server and host value exists in the event</li> <li>Source is overridden when file name is replaced with more suitable text</li> <li>Sourcetype is changed based on existence of some text or specific pattern in the event</li> </ul> <p>Overriding Default Fields at Input Creation Time</p> <ul> <li>Through Splunk Web</li> <li>In configuration files</li> <li>Provide values for relevant attribute<ul> <li>host</li> <li>source</li> <li>sourcetype</li> <li>index</li> </ul> </li> </ul> <p>datetime</p> <ul> <li><code>date_hour</code>, <code>date_minute</code>,</li> <li><code>date_year</code>, <code>date_zone</code>,</li> <li><code>date_mday</code>, <code>date_month</code>,</li> <li><code>date_second</code>, <code>date_wday</code></li> </ul> <p>Splunk Enterprise Administration: Monitoring and Creating Inputs</p> <p>Overriding Default Fields in Existing Inputs</p> <ul> <li>Define suitable value to assign<ul> <li>Static value</li> <li>Regular expression</li> </ul> </li> <li>Identify events to apply change<ul> <li>Regex based</li> </ul> </li> <li>Write stanzas in configuration files<ul> <li>transforms.conf</li> <li>props.conf</li> </ul> </li> <li>Restart Splunk</li> </ul> <p>Overriding \u201chost\u201d Field</p> <p>Configuration to override the host field</p> <p><code>transforms.conf</code></p> <pre><code>[my_field_override_stanza_name]\n\nREGEX = \\w+\\s\\d+\\s\\d+:\\d+:\\d+\\s(router\\d+)\\s\nFORMAT = host::$1\nDEST_KEY = MetaData:Host\n</code></pre> <pre><code>Apr 11 10:32:22 router1 mgd[3606]: UI_DBASE_LOGOUT_EVENT: User \u2018smith' exiting configuration mode\n\nApr 11 11:36:15 switch2 mgd[3606]: UI_COMMIT: User 'root' performed commit: no comment\n\nApr 11 11:46:37 router5 mib2d[2905]: SNMP_TRAP_LINK_DOWN: ifIndex 82, ifAdminStatus up(1), ifOperStatus\ndown(2), ifName at-1/0/0\n</code></pre> <p>Overriding \u201chost\u201d Field</p> <p>Configuration to override the host field</p> <p><code>props.conf</code></p> <pre><code>[mysourcetype|source::my_source|host::my_host]\n\nTRANSFORMS-override_host = my_field_override_stanza_name\n</code></pre> <pre><code>Apr 11 10:32:22 router1 mgd[3606]: UI_DBASE_LOGOUT_EVENT: User \u2018smith' exiting configuration mode\n\nApr 11 11:36:15 switch2 mgd[3606]: UI_COMMIT: User 'root' performed commit: no comment\n\nApr 11 11:46:37 router5 mib2d[2905]: SNMP_TRAP_LINK_DOWN: ifIndex 82, ifAdminStatus up(1), ifOperStatus\ndown(2), ifName at-1/0/0\n</code></pre> <ul> <li><code>host = router1</code></li> <li><code>host = old_value</code></li> <li><code>host = router5</code></li> </ul>"},{"location":"spl1/6par_man/#4-2-overriding-sourcetype","title":"4-2 Overriding Sourcetype","text":"<ul> <li>Use-case scenario</li> <li>Creating regular expression</li> <li>Setting up configuration files</li> <li>Testing Results</li> </ul> <p>Overriding Sourcetype: Use-Case Scenario</p> <p></p> <pre><code>root@splunk_hf:/opt/splunk/etc/apps/psdemo/default# /opt/splunk/bin/python ../bin/getPerformance.py\n\n2020-07-08 11:57:33 src=srv_pssepm01, cpu=59, ram=81, disk=37\n2020-07-08 11:57:33 src=srv_psmai101, cpu=56, ram=85, disk=32\n2020-07-08 11:57:33 sr=srv_psmailo2, cpu=58, ram=82, disk=35\n2020-07-08 11:57:33 src=srv_psdc01, cpu=80, ram=82, disk=37\n2020-07-08 11:57:33 sc=srv_psdhcp01, cpu=79, ram=93, disk=32\n</code></pre> <p><code>index=main source=perfmon_script</code></p> <p></p> <p></p> <ul> <li><code>sourcetype=performance:srv</code></li> <li><code>sourcetype=performance:ws</code></li> </ul> <pre><code>root@splunk_hf:/opt/splunk/etc/apps/psdemo/default# cd ../local\n</code></pre> <p><code>transforms.conf</code></p> <pre><code>[source::perfmon_script]\nTRANSFORMS-changesourcetype = performance_sourcetype_override\n</code></pre> <p><code>props.conf</code></p> <pre><code>[performance_sourcetype_override]\nREGEX = src\\=(ws|srv)\\_\nFORMAT = sourcetype::performance:$1\nDEST_KEY = MetaData:Sourcetype\n</code></pre> <pre><code>root@splunk_hf:/opt/splunk/etc/apps/psdemo/local#/opt/splunk/bin/./splunk restart\n</code></pre> <p><code>index=main source=perfmon_script</code></p> <p></p> <p></p>"},{"location":"spl1/6par_man/#4-3-creating-custom-fields-at-index-time","title":"4-3 Creating Custom Fields at Index-time","text":"<p>Index-time Field Extractions</p> <ul> <li>Fields extracted and written to metadata</li> <li>Similar to default fields overriding process<ul> <li>transforms.conf</li> <li>props.conf</li> <li>fields.conf</li> </ul> </li> <li>Restart Splunk after changes</li> </ul> <p><code>transforms.conf</code></p> <pre><code>REGEX = &lt;suitable regular exp&gt;\n\nFORMAT = &lt;key&gt;::&lt;val&gt;\n\nWRITE_META = true\n</code></pre> <ul> <li>Changes to transforms.conf</li> <li>Regular expression that identifies events to apply changes as well as captures groups to assign values to extracted fields</li> <li><code>key1::$1</code> <code>key2::\u201csome string\u201d</code> <code>$2::$3</code> <ul> <li>Default value is <code>&lt;stanza_name&gt;::$1</code> </li> <li>Not required if you are using namecapturing groups for example: </li> <li><code>(?&lt;_KEY_1&gt;[^\\=]*)\\=(?&lt;_VAL_1&gt;[^\\,]*)\\,  _KEY_&lt;string&gt; &amp; _VAL_&lt;string&gt;</code> is special  capturing group</li> <li>Only valid for index time extractions. It  writes REGEX to metadata  automatically. Default value is false</li> </ul> </li> </ul> <pre><code>DEFAULT_VALUE = &lt;value&gt;\nSOURCE_KEY = &lt;key&gt;\n\nREPEAT_MATCH = true|false\nLOOKAHEAD = &lt;integer&gt;\n</code></pre> <ul> <li>What would be the default value if regex fails?</li> <li>The key to which the value of the regex would apply to. It should be present at the time of this extraction.  Default is <code>_raw</code>.</li> <li>Regex is applied multiple times to <code>SOURCE_KEY</code> after finding first match</li> <li>How far to look ahead in an event for the regex match. Default 4096</li> </ul> <p><code>props.conf</code></p> <pre><code>TRANSFORMS-&lt;name&gt; = &lt;stanza_name&gt;\n</code></pre> <p>Reference the transform created previously from <code>props.conf</code> using TRANSFORMS- keyword for index  time extractions. </p> <p>You\u2019ll use <code>EXTRACT-</code> in the case of search time extractions</p> <p><code>fields.conf</code></p> <pre><code>[field_name]\n\nINDEXED = true\n</code></pre> <ul> <li>Reference the transform created previously from props.conf</li> <li>Tells Splunk to extract and store the field in metadata at index time. <ul> <li>If not set to true, the field will not be extracted at index time. </li> <li>Default is false. Check for index &amp; search time extraction conflicts</li> </ul> </li> </ul>"},{"location":"spl1/6par_man/#4-4-demo-creating-custom-fields-at-index-time","title":"4-4 Demo: Creating Custom Fields at Index-time","text":"<ul> <li>Identifying custom fields</li> <li>Changes in configuration files</li> <li>Check results in Spunk Enterprise</li> </ul> <p><code>index=main sourcetype=netflow</code></p> <p></p> <p></p> <pre><code>root@spunk_hf:~# cd /opt/splunk/etc/apps/psdemo/local/\n\nroot@splunk_hf:/opt/splunk/etc/apps/psdemo/local# vi transforms.conf \n\n[performance_sourcetype_override]\nREGEX = src\\=(ws|srv)\\\nFORMAT = sourcetype::performance:$1\nDEST_KEY = MetaData:Sourcetype\n\n[netflow_custom_fields]\nREGEX = (tcpludp|icmp)\\.(.*?)\\s\nFORMAT = protocol::$1 protocol_detail::$2\nWRITE_META = true\n</code></pre> <p><code>props.conf</code></p> <pre><code>[source: :perfmon_script]\nTRANSFORMS-changesourcetype = performance_sourcetype_override\n\n[netflow]\nTRANSFORMS-netflow = netflow_custom_fields\n</code></pre> <p><code>fields.conf</code></p> <pre><code>[protocoll\nINDEXED=true\n\n[protocol_detail]\n</code></pre> <pre><code>root@splunk_hf:/opt/splunk/etc/apps/psdemo/local# /opt/splunk/bin/./splunk restart\n</code></pre> <p><code>index=main sourcetype=netflow</code></p> <p></p> <ul> <li>Default fields in Splunk Enterprise</li> <li>Overriding default fields \u2013 why and how</li> <li>Demo: Overriding default fields</li> <li>Index time extractions \u2013 why and how</li> <li>Demo: Extracting custom fields</li> </ul>"},{"location":"spl1/6par_man/#5-routing-and-filtering-events","title":"5 Routing and Filtering Events","text":"<ul> <li>Routing event data<ul> <li>Route all or specific events</li> <li>Indexer groups</li> <li>Default routing</li> </ul> </li> <li>Filtering events<ul> <li>Filtering queues</li> <li>Filtering in/out events</li> </ul> </li> <li>Demo: Routing and filtering events</li> </ul>"},{"location":"spl1/6par_man/#5-1-routing-event-data","title":"5-1 Routing Event Data","text":"<ul> <li>Based on host, source, source type or a pattern in events</li> <li>Pattern based routing can only be done on a full Splunk instance</li> <li>Universal Forwarders route data based on host, source or sourcetype</li> <li>Can forward to multiple target indexer groups</li> <li>Can be routed to third party systems</li> </ul> <p>Routing Event Data</p> <p></p> <p><code>index=main source=WinEventLog:Security</code></p> <p></p> <p>Configuring Event Routing</p> <p>A sample stanza that routes events to target groups.</p> <p><code>transforms.conf</code></p> <pre><code>[myRoutingStanza]\nREGEX = action=\\\"blocked\\\" OR .\nDEST_KEY = _TCP_ROUTING|_SYSLOG_ROUTING\nFORMAT = indexerGroup1,indexerGroup2\n</code></pre> <ul> <li>A regular expression that captures all the events to be routed. (.) or just a '.' refers to all events.By default all events routed to default indexer</li> <li><code>DEST_KEY</code>attribute tells Splunk what we need to do with the event captured in the previous step</li> <li>FORMAT attribute will hold the values of indexer group or groups where these events will be routed</li> </ul> <p><code>props.conf</code></p> <pre><code>[sourcetype|source|host]\nTRANSFORMS-routing = stanza1, stanza2\n</code></pre> <ul> <li>Reference thestanza created in transfroms.conf from props.conf</li> </ul> <p><code>outputs.conf</code></p> <pre><code>[tcpout:myFirstIndexerGroup]\nserver = 172.1.1.10:9997,172.1.1.11:9997\n\n[tcpout:mySecondIndexerGroup]\nserver = indexer3:9997,indexer4:9997\n\n[tcpout]\ndefaultGroup = myFirstIndexerGroup\n</code></pre> <ul> <li>Groups are defined with suitable names and list of  server ip/dns name:port</li> <li>Default group is selected</li> </ul>"},{"location":"spl1/6par_man/#5-2-demo-routing-event-data","title":"5-2 Demo: Routing Event Data","text":"<ul> <li>Part I<ul> <li>Identify subset of event to rout</li> <li>Understanding current topology</li> <li>Route the subset of events</li> </ul> </li> <li>Part II<ul> <li>Route same events to multiple indexers</li> <li>Overriding default indexer group</li> </ul> </li> </ul> <p>Overriding Sourcetype: Use-Case Scenario</p> <p></p> <p>Routing Events</p> <p></p> <p></p> <p></p> <pre><code>index=main source=WinEventLog:Security EventCode=4625\n</code></pre> <p></p> <p></p> <pre><code>root@splunk_hf:/# cd /opt/splunk/bin/\nroot@splunk_hf:/opt/splunk/bin# ./splunk list forward-server\n\nActive forwards:\n172.17.11.29:9997\nConfigured but inactive forwards:\nNone\n\nroot@splunk_hf:/opt/splunk/bin# cd ../etc/system/local/\nroot@splunkhf:/opt/splunk/etc/system/local# vi outputs.conf\n\n[tcpout]\ndefaultGroup=psdemo_indexers\n\n[tcpout:psdemo_indexers]\nserver=172.17.11.29:9997\n\n[tcpout:filtered_indexers]\nserver=172.17.11.17:9997\n\n\nroot@splunk_hf:/opt/splunk/etc/system/local# /opt/splunk/bin/./splunk restart\n\nroot@splunk_hf:/opt/splunk/etc/system/local# /opt/splunk/bin/./splunk list forward-server\n\nActive forwards:\n    172.17.11.17:9997\n    172.17.11.29:9997\nConfigured but inactive forwards:\n    None\n\nroot@splunk_hf:/opt/splunk/etc/apps/psdemo/local#\n\nvi transforms.conf\n\n[loginFailedRouting]\nREGEX = EventCode= 4625\nDEST_KEY = _TCP_ROUTING\nFORMAT = filtered_indexer\n\nvi props.conf\n\n[source::WinEventLog:Security]\nTRANSFORMS-routing=loginFailedRouting\n\nroot@splunk_hf:/opt/splunk/etc/apps/psdemo/local# /opt/splunk/bin/./splunk restart\n</code></pre> <p><code>index=main source=WinEventLog:Security EventCode=4625</code></p> <p></p> <p></p> <p><code>vi transforms.conf</code></p> <pre><code>[loginFailedRouting]\nREGEX = EventCode=4625\nDEST_KEY = _TCP_ROUTING\nFORMAT = filtered_indexers, psdemo_indexers\n</code></pre> <pre><code>root@splunk_hf:/opt/splunk/etc/apps/psdemo/local# /opt/splunk/bin/./splunk restart\n</code></pre> <p></p> <p></p> <pre><code>root@splunk_hf:/opt/splunk/etc/apps/psdemo/local# vi transforms.conf\n\n[allWinSecurityEventsRouting]\nREGEX = (.)\nDEST_KEY = _TCP_ROUTING\nFORMAT = psdemo_indexers\n\n\n[loginFailedRouting]\nREGEX = EventCode=4625\nDEST_KEY = _TCP_ROUTING\nFORMAT = filtered_indexers, psdemo_indexers\n</code></pre> <p><code>props.conf</code></p> <pre><code>[source::WinEventLog:Security]\nTRANSFORMS-routing=allWinSecurityEventsRouting,loginFailedRouting\n</code></pre> <pre><code>root@splunk_hf:/opt/splunk/etc/apps/psdemo/local#/opt/splunk/bin/./splunk restart\n</code></pre> <p></p>"},{"location":"spl1/6par_man/#6-manipulating-raw-data","title":"6 Manipulating Raw Data","text":"<ul> <li>Anonymize, mask or modify event data</li> <li>SEDCMD<ul> <li>Configuration and working</li> <li>Demo</li> </ul> </li> <li>Regex transform<ul> <li>Configuration and working</li> <li>Demo</li> </ul> </li> </ul>"},{"location":"spl1/6par_man/#6-1-manipulating-raw-data-in-splunk-enterprise","title":"6-1 Manipulating Raw Data in Splunk Enterprise","text":"<p>Manipulating Raw Data in Splunk</p> <ul> <li>Anonymize, mask or delete sensitive or unwanted information</li> <li>Configure heavy forwarders or indexers to manipulate arriving data</li> <li>Splunk cloud customers use a heavy forwarder</li> <li>Two methods: SEDCMD like sed script or regex transform</li> <li>Use stanza based on host, source, sourcetype to select events</li> </ul>"},{"location":"spl1/6par_man/#6-2-manipulating-events-using-sedcmd","title":"6-2 Manipulating Events Using SEDCMD","text":"<p>SEDCMD</p> <ul> <li>Configured through props.conf</li> <li> <p>Anonymize with sed script</p> <ul> <li><code>SEDCMD-&lt;class&gt;</code></li> <li><code>s/&lt;regex&gt;/&lt;replace&gt;/flags</code></li> <li><code>flags: g \u2013 global or a number</code></li> <li><code>Applied to _raw only</code></li> </ul> </li> <li> <p>Replace characters with sed script</p> <ul> <li><code>SEDCMD-&lt;class&gt; = y/&lt;string1&gt;/string2/</code></li> <li><code>y/abc/ABC/</code></li> </ul> </li> </ul>"},{"location":"spl1/6par_man/#6-3-demo-manipulating-events-using-sedcmd","title":"6-3 Demo: Manipulating Events Using SEDCMD","text":"<ul> <li>Part I<ul> <li>Masking data using SEDCMD script</li> <li>1234-4567-7890-0123</li> <li>XXXX-XXXX-XXXX-0123</li> </ul> </li> <li>Part II<ul> <li>Replacing data with SEDCMD script</li> <li>+61 412 234 456</li> <li>(+61) (412 234 456)</li> </ul> </li> </ul> <p><code>index=main source=WineventLog:Security</code></p> <p></p> <p></p> <p></p> <pre><code>root@splunk_hf:~# cd /opt/splunk/etc/apps/psdemo/local/\nroot@splunk_hf:/opt/splunk/etc/apps/psdemo/local# ll\n\nfields.conf\nprops.conf\ntransforms.conf\n</code></pre> <p><code>transforms.conf</code></p> <pre><code>[allwinSecurityEventsRouting]\nREGEX = (.)\nDEST_KEY = _TCP_ROUTING\nFORMAT = psdemo_indexers\n\n[loginFailedRouting]\nREGEX = EventCode=4625\nDEST_KEY = _TCP_ROUTING\nFORMAT = filtered_indexers, psdemo_indexers\n\n[setNul1]\nREGEX = EventCode=(4624|4634)\nDEST_KEY = queue\nFORMAT = nullQueue\n</code></pre> <p><code>props.conf</code></p> <pre><code>[source::WinEventLog:Security]\nTRANSFORMS-routing = allwinSecurityEventsRouting, loginFailedRouting\nTRANSFORMS-null = setNull\n</code></pre> <pre><code>root@splunk_hf:/opt/splunk/etc/apps/psdemo/local# /opt/splunk/bin/./splunk restart\n</code></pre> <p><code>index=main source=WineventLog:Security</code></p> <p></p> <p>Filtering and Routing Events</p> <p></p> <p><code>transforms.conf</code></p> <pre><code>[allwinSecurityEventsRouting]\nREGEX = (.)\nDEST_KEY = _TCP_ROUTING\nFORMAT = psdemo_indexers\n\n[loginFailedRouting]\nREGEX = EventCode=4625\nDEST_KEY = _TCP_ROUTING\nFORMAT = filtered_indexers, psdemo_indexers\n\n[setNul1]\nREGEX = .\nDEST_KEY = queue\nFORMAT = nul1Queue\n\n[setParsing]\nREGEX = EventCode=(4624|4625)\nDEST_KEY = queue\nFORMAT = indexOueue\n</code></pre> <p><code>props.conf</code></p> <pre><code>[source::WinEventLog:Security]\nTRANSFORMS-routing =allwinSecurityEventsRouting,loginFailedRouting\nTRANSFORMS-null = setNu1l,setParsing\n</code></pre> <pre><code>/opt/splunk/bin/./splunk restart\n</code></pre> <p></p> <p><code>index=main source=WineventLog:Security</code></p> <pre><code>root@splunk_hf:~# cd /opt/splunk/etc/apps/psdemo/\nroot@splunk_hf:/opt/splunk/etc/apps/psdemo# vi default/inputs.conf\n</code></pre> <pre><code>\"bin/custGen.py\"\n\n\nimport random\nfrom datetime import datetime\n\ndef getCreditCardNum():\n    creditCardNum=str(random.randint(2222,9999))\n    for _ in range(3):\n        creditCardNum += \"-\" + str(random. randint(2222,9999))\n    return creditCardNum\n\ndef getMobileNum():\n    mobileNum = \"+61 42\"+str(random.randint(0,9))\n    for _ in range(2):\n    mobileNum += \" \"+ str (random.randint(111.999))\n    return mobileNum\n\ndef getTimeStamp() :\n    return datetime.now().strftime(\"%Y-%m-%d%H:%M:%S\")\n\nfirstNames = [\"\"]   \nlastNames = [\"\"]    \n\nfor firstName in firstNames:\n    record = getTimeStamp() + ' CustomerName=\" ' + firstName + ' ' +random.choice(lastNames)+'\", ' + 'CreditCard=\" '+getCreditCardNum()+\" \uff0c MobileNumber=\"'+getMobileNum() + '\"'\nprint (record)  \n</code></pre> <p><code>index=main sourcetype=customers</code></p> <p></p> <p></p> <pre><code>root@splunk_hf:/opt/splunk/etc/apps/psdemo# vi local/props.conf\n\n\n[customers]\nSEDCMD-cc = S/(1d{4})\\-){33}/XXXX-XXXX-XXXX-/g\n\nroot@splunk_hf:/opt/splunk/etc/apps/psdemo# /opt/splunk/bin/./splunk restart\n</code></pre> <p><code>index=main sourcetype=customers</code></p> <p></p> <p></p> <pre><code>root@splunk_hf:/opt/splunk/etc/apps/psdemo# vi local/props.conf\n\n[customers]\nSEDCMD-CC = S/(\\d{4}\\-) {3}/XXXX-XXXX-XXXX-/g\nSEDCMD-mn = s/MobileNumber\\=\\\"(\\+61)\\s([^\\\"]*)/MobileNumber=\"0\\2/g\n</code></pre> <p><code>vi local/props.conf</code></p> <pre><code>root@splunk_hf:/opt/splunk/etc/apps/psdemo# /opt/splunk/bin/./splunk restart\n</code></pre> <p><code>index=main sourcetype=customers</code></p> <p></p> <p></p> <pre><code>[customers]\nSEDCMD-cust = S/(\\d{4}\\-) {3}/XXXX-XXXX-XXXX-/g s/MobileNumber\\=\\\"(\\+61)\\s([^\\\"]*)/MobileNumber=\"0\\2/g\n</code></pre> <p></p>"},{"location":"spl1/6par_man/#6-4-manipulating-events-using-regex-transform","title":"6-4 Manipulating Events Using Regex Transform","text":"<p>REGEX Transform</p> <ul> <li>Configured through props and transforms</li> <li> <p>transforms.conf </p> <ul> <li>REGEX \u2013 a PERC regex</li> <li>FORMAT \u2013 arrange event post change</li> <li><code>DEST_KEY</code> \u2013 applied to field e. g raw</li> </ul> </li> <li> <p>props.conf</p> <ul> <li><code>TRANSFORM-&lt;class&gt;</code></li> <li>Comma separated list of transforms</li> </ul> </li> </ul>"},{"location":"spl1/6par_man/#6-5-demo-manipulating-events-using-regex-transform","title":"6-5 Demo: Manipulating Events Using Regex Transform","text":"<p>Anonymizing data with regex transform</p> <ul> <li>Masking credit card number</li> <li>1234-4567-7890-0123</li> <li>XXXX-XXXX-XXXX-0123</li> <li>Creating a suitable regex</li> <li>Configuring transforms and props.conf</li> <li>Verifying results</li> </ul> <p><code>props. conf</code></p> <pre><code>[customers]\nSEDCMD-cust = S/(\\d{4}\\-) {3}/XXXX-XXXX-XXXX-/g s/MobileNumber\\=\\\"(\\+61)\\s([^\\\"]*)/MobileNumber=\"0\\2/g\n</code></pre> <p><code>index=main sourcetype=customers</code></p> <p></p> <p><code>regex101.com</code></p> <pre><code>root@splunk_hf:~# cd /opt/splunk/etc/apps/psdemo/local/\nroot@splunk_hf:/opt/splunk/etc/apps/psdemo/local# vi transforms.conf\n\n[maskcc]\nREGEX = ^(.*)CreditCard\\=\\\"(\\d+\\-){3}(.*)$\nFORMAT = $1CreditCard- \"XXXX-XXXX-XXXX-$3\"\n_DEST_KEY = _raw\n\nprops.conf\n\n[customers]\nTRANSFORMS-maskcreditcard = maskCC\n</code></pre> <p><code>index=main sourcetype=customers</code></p> <p></p> <p></p>"},{"location":"spl1/7splunk_search/","title":"7 Performing Basic Splunk Searches","text":""},{"location":"spl1/7splunk_search/#1-introduction-to-search-in-splunk","title":"1 Introduction to Search in Splunk","text":"<ul> <li>Performing Basic Searches</li> <li>Field Searches Basics</li> <li>Splunk Processing Language</li> <li>Transformative Searches in Splunk</li> <li>Beyond Search Splunk Search</li> </ul>"},{"location":"spl1/7splunk_search/#1-1-searching-machine-data","title":"1-1 Searching Machine Data","text":"<ul> <li>Index</li> <li>Search Head</li> <li> <p>Forwarder</p> </li> <li> <p>Indexer, right, our indexer is going to bring in our data, it's going to index it so it can be searched. </p> </li> <li>The next component is our search head. So our search head is where we're actually querying our data, writing in our data queries, being able to pull our reports from the data that we've pulled, </li> <li>Last component is that forwarder, So multiple, multiple machines that are sending data to be indexed and then we're using our search head which we'll interact with a ton in this course, but the forwarder could be these edge devices where the data and the log files are being pushed from the host machines to our indexer and then being able to search it with our search head. </li> </ul>"},{"location":"spl1/7splunk_search/#demo-basics-of-splunk-search","title":"Demo: Basics of Splunk Search","text":"<p><code>index=main| top limit=20 EventCode</code></p> <p>Splunk Search Interface</p> <p></p>"},{"location":"spl1/7splunk_search/#splunk-data-sets","title":"Splunk Data Sets","text":"<p>Splunk Data Options</p> <ul> <li>Semi-structured</li> <li>Machine generated</li> <li> <p>Often overlooked</p> </li> <li> <p>Something like the csv files or log generated files from your Windows machine, or Mac, or Linux machine. </p> </li> <li>Machine generated, even machine generated from an export of a database, but the data is coming in in some kind of fashion from a machine generated. Remember, 90% of the world's data that's being generated is coming machine generated. </li> <li> <p>dark data, but a lot of times, this data is overlooked. </p> </li> <li> <p>Servers can have forwarders on that's going to send information whether it be our servers, can be your NAZ device, it can be your networking devices. </p> </li> <li>Clouds are what are applications, what are you running in the cloud, there's a lot of ways to get data out of the cloud or get data into the cloud for your Splunk instance so that you can have a wholistic picture of what's going on in your environment. </li> <li>Workstations, being able to find data and log files that are on your workstations and be able to pull those into your main Splunk instance so that you can actually comb through and look at your data. </li> <li>regular expression on it, which is what Splunk is doing and helping can feed that data into our Splunk environment and start searching it. </li> </ul>"},{"location":"spl1/7splunk_search/#demo-uploaded-splunk-course-data","title":"Demo: Uploaded Splunk Course Data","text":"<pre><code>source=\"titanic passenger list.csv\" host=\"thenson-desktop\" index=\"titanic\" sourcetype=\"csv\"\n</code></pre>"},{"location":"spl1/7splunk_search/#2-understanding-the-basics-of-splunk-search","title":"2 Understanding the Basics of Splunk Search","text":"<ul> <li>Understanding Spunk roles</li> <li>Learning how data is stored in Splunk</li> <li>Explaining Spunk data lifecycle</li> </ul>"},{"location":"spl1/7splunk_search/#2-1-splunk-roles-in-search","title":"2-1 Splunk Roles in Search","text":"<p>Every Splunk user falls into a role which gives the user different functionalities in Splunk.</p> <ul> <li>User can create and edit searches owned by user</li> <li>Power can edit shared object and alerts</li> <li>Admin can perform most Splunk search functions</li> </ul>"},{"location":"spl1/7splunk_search/#2-2-data-storage-in-splunk","title":"2-2 Data Storage in Splunk","text":"<p>Index</p> <p>Splunk stores data in an index. </p> <p>So Splunk is actually going to store this data in an index which helps us feed it with searches, so we can view our data</p> <p>Ingested data goes through the process of indexing which converts data to searchable events.</p> <ul> <li>Creates metadata<ul> <li>It creates metadata off that data element so that it's searchable and it also gives it some parameters for Splunk to be able to do some administrative on the back-end.</li> </ul> </li> <li>Compresses data</li> <li>Index for data</li> </ul> <p></p> <p>Indexing</p> <p><code>Neighborhood=Brooklyn + timestamp</code></p> <p></p> <p><code>timestamp</code></p> <p>Now there are multiple buckets and each one of those are stored by age of data. </p> <p>What is a Bucket?</p> <ul> <li>Splunk file system</li> <li>Stored by age of data</li> </ul> <p>timestamp</p> <p></p> <p>So we're timestamping our data and we're going to put it in the first bucket, but as that bucket starts to reach a certain size, it's going to need to tier off to another bucket. </p> <p>So you might have bucket 1 through 9 for all of your events, bucket 10 through 19 for the other ones, or 20 through 29. So these are just some arbitrary numbers. It could be a lot larger, it could be a lot smaller. </p>"},{"location":"spl1/7splunk_search/#2-3-bucket-management-in-splunk","title":"2-3 Bucket Management in Splunk","text":"<p>What is a Bucket?</p> <ul> <li>Splunk file system</li> <li> <p>Stored by age of data</p> </li> <li> <p>Creating Indexes</p> <ul> <li>Bucket Allocation</li> </ul> </li> <li>Performance Requirements</li> <li>Storage Requirements</li> <li>Size Splunk Cluster</li> </ul> <p>Bucket Lifecyle</p> <ul> <li>Hot Bucket\uff1a 24 hours</li> <li>Warm Bucket\uff1a 3 Months</li> <li>Cold Bucket\uff1a 3 + Months</li> <li>Frozen Bucket\uff1a 1 Year</li> </ul> <p>Index Data Options</p> <ul> <li>Hot</li> <li>Warm</li> <li>Cold</li> </ul>"},{"location":"spl1/7splunk_search/#demo-splunk-bucket-management","title":"Demo: Splunk Bucket Management","text":""},{"location":"spl1/7splunk_search/#2-performing-basic-spunk-searches","title":"2 Performing Basic Spunk Searches","text":"<p>USING FIELD SEARCHES FOR SPLUNK SEARCHES</p> <p><code>index=main</code></p> <p>v * Explore search bar and timelines * Define field operators in plunk search * Navigate the plunk search sidebar * Analyze the search results field * Discuss best practices for searches</p>"},{"location":"spl1/7splunk_search/#2-1-search-bar-timeline","title":"2-1 Search Bar &amp; Timeline","text":"<p>Navigating the Search Bar</p> <ul> <li>Search Bar</li> <li>Time Range</li> <li>Job</li> <li>Timeline</li> <li>Saved Searches<ul> <li>This gives us the option to be able to go in and save specific searches so that we can either share it out with other users or bring it into our own dashboard.</li> </ul> </li> <li>Modes</li> </ul> <p>Splunk Search Modes</p> <ul> <li>Field discovery turned off for event searches. No event or field data for stats searches.</li> <li>Field discovery turned on for event searches. No event or field data for stats searches.</li> <li>All events and field data.</li> </ul> <p>Fast mode, and in this one the field discovery is turned off for event searches, and then statistics for events and fields are also not turned on as well.</p> <p>The second one strikes a middle balance between that. So it's called the smart mode, and it's a default value in Splunk.  Field discovery is turned on for these events searches, but just like in fast mode, the stats, searches, there are no field or no event data as well in those. </p> <p>Last one is on the other end of the spectrum, so all event and field data is just evident in there. So this is called your verbose mode. So this is going to be the most costly whenever we talk about search, compute, and capacity here from this perspective.</p>"},{"location":"spl1/7splunk_search/#2-2-search-field-operators","title":"2-2 Search Field Operators","text":"<p>Field Operators</p> <p>Characters used in Splunk queries for analyze search results. Common functions are wildcards, Booleans and comparison operators.</p> <p>Spunk Field Operators</p> <ul> <li> <p>Field Expressions</p> <ul> <li><code>field=value</code>  Field and value match</li> <li><code>field!=value</code> Field and value don't match</li> <li><code>field&lt;value</code>  Field less than value</li> <li><code>field&gt;value</code>  Field greater than value</li> <li><code>field&lt;=value</code> Field less than or greater than value</li> <li><code>field&gt;=value</code> Field greater than or greater than value</li> </ul> </li> <li> <p>Boolean Operators</p> <ul> <li>Field NOT value<ul> <li>Not Boolean</li> <li>Field does not contain value</li> </ul> </li> <li><code>field=value1 OR field=value2</code><ul> <li>OR Boolean</li> <li>Field has at least one value or both values in expression</li> </ul> </li> <li><code>field=value1 AND field=value2</code><ul> <li>AND Boolean</li> <li>Field has both values in expression</li> </ul> </li> </ul> </li> <li> <p>Wildcards     </p> </li> </ul> <pre><code>Host=\"thenson-desktop\"\n\nResults only where\nHost = \"thenson-desktop\"\nHost = \"thenson-server\"\nHost = \"thenson-mobile\"\n</code></pre>"},{"location":"spl1/7splunk_search/#2-2-splunk-field-sidebar","title":"2-2 Splunk Field Sidebar","text":"<p>fields are case sensitve</p> <pre><code>index=airbnb beds=4\n</code></pre> <p>Field Sidebar</p> <p>Located on left portion of Splunk search. Pulls selected fields and interesting field for quick search results. Also offers quick reports such as top values and rare values.</p> <p></p> <p><code>index=airbnb Beds!=4</code></p> <p></p> <p></p> <p><code>index=airbnb Beds&lt;4</code></p> <p></p> <p><code>index=airbnb Beds=4 OR Beds=3</code></p> <p></p> <p><code>values are not case sensitve</code></p> <p><code>index=airbnb Neighbourhood=bro*</code></p> <p></p>"},{"location":"spl1/7splunk_search/#2-3-splunk-field-sidebar","title":"2-3 Splunk Field Sidebar","text":"<ul> <li>Fields assigned<ul> <li>Selected fields</li> <li>Interesting fields</li> </ul> </li> <li>Quick field numbers</li> <li>Text fields a</li> <li>Numeric fields #</li> </ul> <p><code>index=airbnb Neighbourhood=\"bro*\"</code></p> <p></p> <p></p> <p></p> <ul> <li><code>a String</code></li> <li><code># Numeric</code></li> </ul> <p></p> <ul> <li>Rare values</li> </ul> <p><code>index=airbnb Neighbourhood=\"bro*\" | rare limit=20 Beds</code></p> <p></p> <ul> <li>Top values by time</li> </ul> <p><code>host=\"thenson-desktop\" | timechart count by EventCode limit=10</code></p> <p></p>"},{"location":"spl1/7splunk_search/#2-4-splunk-results-field","title":"2-4 Splunk Results Field","text":"<p>Splunk Search Results</p> <p>Main portion of Splunk Search where events are displayed from search results.</p> <ul> <li>Field Sidebar</li> <li>Include Fields</li> <li>Top Field Values</li> </ul> <p>Events displayed</p> <ul> <li>Formatting</li> <li>Per event</li> </ul> <p>Displayed fields clickable</p> <ul> <li>Add</li> <li>Exclude</li> <li>New</li> </ul> <p>More Results Display Options</p> <p>Raw Events / Patterns / Statistics / Visualizations</p> <ul> <li>Examine Raw Results</li> <li>Display Options</li> </ul> <p><code>index=airbnb</code></p> <p></p> <p></p> <p></p> <p><code>index=airbnb Price!=80</code></p> <p></p> <p><code>index=airbnb Price!=80 AND Beds=4</code></p> <p></p> <p></p> <p>Top Vaules</p> <p><code>index=airbnb Price!=80 AND Beds=4| top limit=20 Neighbourhood</code></p> <p></p> <p><code>index=airbnb Price!=80 AND Beds=4| top limit=20 Neighbourhood</code></p> <p></p>"},{"location":"spl1/7splunk_search/#2-5-infrastructure-will-define-spunk-search-performance","title":"2-5 Infrastructure will define Spunk Search performance","text":"<ul> <li>Build searches based on narrowest criteria</li> <li>Timeline impacts most searches</li> <li>Index data sets and plan for scale</li> </ul> <p>Overview</p> <ul> <li>Explored search bar and timelines</li> <li>Defined field operators in Splunk search</li> <li>Navigated the Splunk search sidebar</li> <li>Analyzed the search results field</li> <li>Discussed best practices for searches</li> </ul>"},{"location":"spl1/7splunk_search/#3-building-spl-queries-in-splunk","title":"3 Building SPL Queries in Splunk","text":"<ul> <li>Learning the Search Processing Language</li> <li>Understanding SPL Keywords and commands</li> <li>Building SPL Queries with Splunk commands</li> </ul> <p>Search Processing Language is Spunk's syntax for writing queries in the Spunk platform.</p> <p>Example SQL</p> <pre><code>SELECT Neighbourhood, Property_Type\nFROM Airbnb\nWHERE Neighbourhood=Queens, Property_Type=Apartment\n</code></pre> <pre><code>index=\"Airbnb\" Neighbourhood=Queens \"Property Type\" = Apartment\n</code></pre> <p>Search Processing Language (Settings for SPL)</p>"},{"location":"spl1/7splunk_search/#building-spl-queries","title":"Building SPL Queries","text":"<p>Chaining Commands</p> <p>Search Processing Commands use the pipe <code>|</code> commands to chain search commands together.</p> <pre><code>index=\"Airbnb\" Neighbourhood=Queens \"Property Type\" = Apartment | command 1 argument\n</code></pre> <p>SPL Keywords</p> <ul> <li>AS</li> <li>BY</li> <li>OVER</li> <li>WHERE</li> </ul> <pre><code>index=\"Airbnb\" where Price &gt; 40\n</code></pre> <pre><code>index=\"Airbnb\" | where Price &gt; 40\n</code></pre> <p>Where: Splunk command use to return results in which \"where\" command is true</p> <p>Search Processing Language</p> <ul> <li>Chaining Command</li> <li>Key Commands</li> </ul> <pre><code>index=\"Airbnb\" Neighbourhood=Queens \"Property Type\" = Apartment | fields - Beds\n</code></pre> <p></p> <p></p> <p></p> <p></p> <p></p> <pre><code>index=\"Airbnb\" Neighbourhood=Queens \"Property Type\"=Apartment | where Price &gt; 40\n</code></pre> <p></p> <pre><code>index=\"Airbnb\" Neighbourhood=Queens \"Property Type\"=Apartment | where Price=70 or Price=65\n</code></pre> <p></p>"},{"location":"spl1/7splunk_search/#3-3-spl-filtering-modifying-search-results","title":"3-3 SPL Filtering &amp; Modifying Search Results","text":"<p>Chaining Commands</p> <p>Search Processing Commands use the pipe | commands to chain search commands together.</p> <pre><code>Host=*\n| fields [fieldname1], [fieldname2]\n</code></pre> <p>Fields: Splunk fields command add or remove field listed.</p> <pre><code>Host=*\n| search [keyword]\n</code></pre> <p>Search: Splunk search allows to searching raw text while using chaining command.</p> <pre><code>Host=*\n| dedup [fieldname]\n</code></pre> <p>Dedup: Splunk dedup removes duplicate fields from search results.</p> <pre><code>Host= *\n| Renames [fieldname]\n</code></pre> <p>Rename: Splunk rename allows for field names to be changed in search results.</p> <p>Search Processing Language</p> <ul> <li>Field</li> <li>Dedup</li> <li>Rename</li> </ul> <p>Hide fields</p> <pre><code>index=\"Airbnb\" Neighbourhood=Queens \"Property Type\"=Apartment | fields - Beds\n</code></pre> <p></p> <p>see certain fields</p> <pre><code>index=\"Airbnb\" Neighbourhood=Queens \"Property Type\"=Apartment | fields + Beds\n\nindex=\"Airbnb\" Neighbourhood=Queens \"Property Type\"=Apartment | fields + Beds, price\n</code></pre> <p></p> <pre><code>index=\"Airbnb\" Neighbourhood=Queens \"Property Type\"=Apartment | search Pretty\n</code></pre> <p></p> <pre><code>index=\"Airbnb\" Neighbourhood=Queens \"Property Type\"=Apartment | search large\n</code></pre> <p></p> <pre><code>index=\"Airbnb\" Neighbourhood=Queens \"Property Type\"=Apartment | search large | rename Price as Cost\n</code></pre> <p></p>"},{"location":"spl1/7splunk_search/#spl-ordering-search-results","title":"SPL Ordering Search Results","text":"<pre><code>Host=*\n| head number\n</code></pre> <p>Splunk head returns the first 10 events unless specified by another number.</p> <pre><code>Host=*\n| tail [num]\n</code></pre> <p>Splunk tail returns the last 10 events unless specified by another number.</p> <pre><code>Host=*\n| sort [fieldname]\n</code></pre> <p>Splunk sort will order field by ascending order.</p> <pre><code>Host=*\n| reserve\n</code></pre> <p>Splunk reverse will put search results in reverse order.</p> <pre><code>Host=*\n| tables [fieldname]\n</code></pre> <p>SPL command for creating a table with specific fields</p> <p>Search Processing Language</p> <ul> <li>Sort</li> <li>Tail</li> <li>Head</li> </ul> <pre><code>index=\"Airbnb\" Neighbourhood=Queens \"Property Type\"=Apartment | tail\n\nindex=\"Airbnb\" Neighbourhood=Queens \"Property Type\"=Apartment | tail 30\n\nindex=\"Airbnb\" Neighbourhood=Queens \"Property Type\"=Apartment | head 30\n\nindex=\"Airbnb\" Neighbourhood=Queens \"Property Type\"=Apartment | sort Price\n\nindex=\"Airbnb\" Neighbourhood=Queens \"Property Type\"=Apartment | sort Price desc\n</code></pre> <p></p> <ul> <li>Understood how SPL compares to SQL</li> <li>Implemented multiple SPL queries</li> <li>Walked through ordering, modifying, and filtering SPL commands</li> </ul>"},{"location":"spl1/7splunk_search/#4-performing-transformative-searches","title":"4 PERFORMING TRANSFORMATIVE SEARCHES","text":"<ul> <li>Utilizing Transforming Commands</li> <li>Understanding the Stats commands</li> <li>Charting in Splunk with transforming commands</li> </ul>"},{"location":"spl1/7splunk_search/#4-1-what-are-transformative-commands","title":"4-1 What Are Transformative Commands?","text":"<p>Transforming Commands</p> <p>Allow for search commands to create data structure from field values. Frequently used for Splunk Enterprise visualizations.</p> <pre><code>Host=*\n| top [fieldname]\n</code></pre> <p>Returns frequent value for the defaulted top 10 results</p> <pre><code>Host=*\n| rare [fieldname]\n</code></pre> <p>Returns least frequent value for the defaulted top 10 results</p> <pre><code>Host=*\n| highlight [fieldname1] [fieldname2]\n</code></pre> <p>Shows results in raw events mode with fields highlighted</p> <pre><code>Host=*\ncontingency [fieldname1] [fieldname]\n</code></pre> <p>Shows associations between fields in table</p> <p>Basic Transforming Commands</p> <ul> <li>Top</li> <li>Rare</li> <li>Contingency</li> </ul> <p>SELECTED FIELDS</p> <p></p> <p><code>top limit=3 Beds</code></p> <pre><code>index=airbnb\n| top limit=3 Beds\n</code></pre> <p></p> <p><code>rare limit=3 Beds</code></p> <pre><code>index=airbnb\n| rare limit=3 Beds\n</code></pre> <p></p> <pre><code>index=airbnb\n| contingency Neighbourhood \"Property Type\"\n</code></pre> <p></p>"},{"location":"spl1/7splunk_search/#4-2-splunk-stats-commands","title":"4-2 Splunk Stats Commands","text":"<p>Stats Commands</p> <p>Special type of transforming Splunk commands used primarily for calculations to for table results.</p> <pre><code>Host=*\n| stats avg([fieldname])\n</code></pre> <p>Calculate results based on average function</p> <pre><code>Host=*\n| stats count (eval[fieldname]) as newname\n</code></pre> <p>Returns time series chart over the data element following command</p> <pre><code>Host=*\n| stats max(fieldname)\n</code></pre> <p>Returns maximum value from a specific field</p> <pre><code>Host=*\n| stats min(fieldname)\n</code></pre> <p>Returns minimum value from a specific field</p> <pre><code>Host=*\n| stats sum(fieldname)\n</code></pre> <p>Returns sum of fields in specific value</p> <p>Stats Commands</p> <ul> <li>Min</li> <li>Max</li> <li>Average</li> <li>Count</li> </ul> <pre><code>index=airbnb\n| stats min(price)\n</code></pre> <p></p> <pre><code>index=airbnb\n| stats min(Price) by Neighbourhood\n</code></pre> <p></p> <pre><code>index=airbnb\n| stats max(Price) by Neighbourhood\n</code></pre> <p></p> <pre><code>index=airbnb\n| stats avg(price)\n</code></pre> <p></p> <pre><code>index=airbnb\n| stats avg(price) by Neighbourhood\n</code></pre> <p></p>"},{"location":"spl1/7splunk_search/#4-3-spunk-chart-commands","title":"4-3 Spunk Chart Commands","text":"<p>Chart Commands</p> <p>Type of Splunk transforming command for presenting data in tables or visualization. Typically includes stats commands.</p> <pre><code>Host=*\n| chart somefunction([fieldname])\n</code></pre> <p>Returns chart of the data element following command. Commonly used with stat command</p> <pre><code>Host=*\n| timechart somefunction([fieldname])\n</code></pre> <p>Returns time series chart over the data element following command. Commonly used with stat command.</p> <p>Demo: Charting Transforming Commands</p> <ul> <li>Chart</li> <li>TimeChart</li> </ul> <p></p> <pre><code>index=airbnb\n| chart count as types by \"Property Type\"\n</code></pre> <p></p> <p></p> <p></p> <pre><code>host=\"thenson-desktop\"\n| timechart count as messages by Keywords\n</code></pre> <p></p> <pre><code>host=\"thenson-desktop\"\n| timechart count as messages by Keywords\n</code></pre> <p></p>"},{"location":"spl1/7splunk_search/#5-beyond-the-basic-search","title":"5 Beyond the Basic Search","text":""},{"location":"spl1/7splunk_search/#lookup","title":"Lookup","text":"<p>Search Processing Language is Spunk's syntax for writing queries in the Splunk platform.</p> <p></p> <p>Building Lookup in Splunk</p> <ul> <li>Add Lookup for Titanic</li> <li>Construct Lookup query</li> </ul> <p></p> <p><code>lookup.csv</code></p> <pre><code>survived, status\nO, perished\n1, survived\n</code></pre> <p></p> <p></p> <p></p> <pre><code>index=\"titanic\" survived=* | lookup lookup.csv survived OUTPUT status | table survived status\n</code></pre> <p></p>"},{"location":"spl1/7splunk_search/#day-in-the-life-of-splunk-admin","title":"Day in the Life of Splunk Admin","text":"<ul> <li>Ensuring Splunk and architecture are built</li> <li>Building Splunk searches and support Splunk search users</li> <li>Creating and aiding in the visualization of data</li> </ul>"},{"location":"spl1/8spl_exam/","title":"Splunk ADMIN Exam","text":"<ol> <li>When using the REST API to access Splunk Cloud, what port is used?<ul> <li>8089</li> </ul> </li> <li>Which node is the cluster label configured on?<ul> <li>Manager Node</li> </ul> </li> <li>Your log events contain user IDs. An external comma-separated values (CSV) file contains user IDs and full names. How would you enhance your search results to include full names?<ul> <li>Define a lookup table using the CSV file and use the lookup command</li> </ul> </li> <li>While planning to scale up to a larger deployment from a single-instance of Splunk Enterprise, what are the main functions you need to deliver distributed data collection, indexing, and search?<ul> <li>Index clustering, search head clustering, and a forwarding layer</li> </ul> </li> <li>A log file denotes the start of a process with the string \"starting process\". It denotes the end of the process with \"completed process\". You must create a report of transactions that started but never finished. How can you do this?<ul> <li>Use the <code>keepevicted</code> option with the command <code>transaction</code> For example:  <code>\"| transaction startswith endswith = 'starting process' endswith= 'completed process' keepevicted=true\"</code></li> </ul> </li> <li>You recently ingested a custom application log file into Splunk. When searching the contents in Splunk web, multiple lines of the log files are incorrectly merged together in a single event. What is the most likely cause of this issue?<ul> <li>The <code>LINE_BREAKER</code> attribute is incorrectly set in props.conf.</li> </ul> </li> <li>How would you add color in a tabular output based on the values of the cells?<ul> <li>Format the table visualization using the data overlay option with Heat map selected</li> </ul> </li> <li>You have a list of raw logs from Splunk. Which regex command would you use to add IP addresses in the selected fields?<ul> <li><code>index =* | rex \"^Id{1,3}\\.\\d{1,3}\\.\\d{1,3}\\. \\d(1,3}\\s\\</code></li> </ul> </li> <li>Which tool enables you to create interactive dashboards that provide more information when data points are clicked?<ul> <li>Drilldown</li> </ul> </li> <li>You are normalizing data that is examining login events between two different sources. You see some discrepancies between the names of fields in your data and the names expected by the data models. What should you do to normalize these field names?<ul> <li>Create field aliases.</li> </ul> </li> <li>What is the difference between the eventCount property and the scanCount property?<ul> <li>The eventCount property represents the number of events that search returns, whereas the scanCount property represents the total number of events scanned</li> </ul> </li> <li>What is the difference between an events index and a metrics index?<ul> <li>An events index can hold any type of data, whereas a metrics index can hold only metrics data. </li> </ul> </li> <li>You tagged a few IP addresses based on purpose, patch status, and location as follows: 12.24.18.15: main,patch, south 12.24.18.15: backup,new,west 12.24.18.15: main,new, east Which command gives you all the events that are patched or located in the east?</li> <li><code>index=main tag=patch OR tag=east</code></li> <li>Which configuration will create a token for a drop-down list for form input?</li> </ol> <pre><code>&lt;input type=\"dropdown\" token=\"event_dropdown\"&gt;\n    &lt;label&gt;Select an event type&lt;/label&gt;\n    &lt;default\u203aevent1&lt;/default\u203a\n    &lt;choice value=\"event1\"&gt;event1&lt;/choice&gt;\n    &lt;choice value=\"event2\"&gt;event2&lt;/choice&gt;\n&lt;/input&gt;\n</code></pre> <p>15.Which Search Processing Language (SPL) command orders the results into a data structure that you need to generate visualizations such as charts?</p> <ul> <li>stats</li> </ul> <p>16.An analyst is running the following search command in Splunk, but it's taking a long time to load. How can the search be modified in order to make it more efficient? <code>index=* sourcetype=WinEventLog EventCode=* sc ip=192.168.10.2</code></p> <pre><code>index=Windows sourcetype=WinEventLogEventCode=*b src_ip=192.168.10.2\n</code></pre> <p>17.You log out of Splunk after running an ad-hoc search. After five minutes, you must export the results of the search. How would you achieve this?</p> <ul> <li>Log in to Splunk. Because ad-hoc jobs are kept for 10 minutes, locate the job in the Jobs manager and download the results</li> </ul> <p>18.Log in to Splunk. Because ad-hoc jobs are kept for 10 minutes, locate the job in the Jobs manager and download the results</p> <ul> <li><code>| eval KBYTES= (bytes/1000)</code></li> </ul> <p>19.You must analyze the trend of the 95th percentile response time split by the unique API endpoints your application serves. What is one way to achieve this?</p> <ul> <li>Retrieve all relevant events and pipe them to <code>timechart p95(response_time) by api_endpoint</code></li> </ul> <p>20 How can you improve your search query performance?</p> <ul> <li>Narrow the timeframe as much as possible.</li> </ul> <p>21 An Engineer creating a dri11 down for a table of values in Splunk. Upon clicking the data in the table, a separate URL should be opened and the data is searched for using the following format: <code>https://searchenginercom/?q=&lt;value&gt;</code> Which configuration is correct to enable this drilldown?</p> <pre><code>&lt;drilldown&gt;\n    &lt;link&gt;\n        https://searchengine.com/?q=$click.values\n    &lt;/link&gt;\n&lt;/drilldown&gt;\n</code></pre> <p>22 You have a field in a root dataset named <code>primary_building</code> and it's set to required. You create two more datasets that inherit from your root dataset, but you do not see primary building when setting filters to view only required fields. What must you do to make this field appear?</p> <ul> <li>Change the primary_building field to required in the child datasets</li> </ul> <p>23 You start ingesting data from access.log and error.log from your web server. You configure a common source type web:log for the logs coming from the web server. When searching for the events in Splunk, access.log events are formatted correctly, but error.log events are not broken into proper events. For example, multiple log entries are grouped into one event. Why might that be?</p> <ul> <li>The access.log and error.log might have different formats and need to use different source types</li> </ul> <p>24 How can self-describing data be used with the Splunk field extractor to ensure all relevant fields are extracted and used?</p> <ul> <li>Use the delimiter option to separate the fields from the data.</li> </ul> <p>25 7. What does the following search command do? <code>eventtype=\"windows _login\" makemv delim=\";\"</code> users</p> <p>The command separates multi-value fields.</p> <p>26 An application sends alerting-based data to Splunk. When an event is processed, Splunk hasn't enriched the dataset with relevant fields for this type of information. What Common Information Model (CIM) data model would improve this?</p> <ul> <li>The alerts dataset</li> </ul> <p>27 When an analyst is using a transaction to correlate events, they're not able to see the information grouped by the time span that they need. How can the following search be modified in order to accomplish this?</p> <p>U se the maxspan* argument in the transaction command</p> <p>28 You must generate a report of top users logging in to your application. The field \"user\" in your events represent a unique user. How would generate this report using the fields sidebar?</p> <ul> <li>Use the prebuilt report \"top values\" from the fields.</li> </ul> <p>29 11. Which Splunk Search Processing Language (SPL) command can you use to group conceptually-related events together within a 25 second window?</p> <ul> <li>transaction</li> </ul> <p>30 You configured your Splunk application to extract HTTP status codes from a web service log as a field called http status. You are now creating aworkflow that will only appear when http status is between 400-500. This workflow action will send the information to an external data manager that will generate bug reports. What kind of workflow would you create to do this?</p> <ul> <li>POST</li> </ul> <p>31 In a distributed Splunk Enterprise environment, where is the Splunk Common Information Model (CIM) add-on installed?</p> <ul> <li>Search head</li> </ul> <p>32 An organization has two Splunk deployments, Cloud and Enterprise. An Engineer is attempting to run searches from the cloud Search Head to view data from both the Enterprise and Splunk Cloud instances, but it's not working. Why?</p> <ul> <li>A Hybrid Search Head is needed for this task, and must be on-premise.</li> </ul> <p>33 An Architect is designing a Splunk Enterprise deployment and is working on a design that includes an indexer cluster. What must the Architect consider when deciding how to include redundancy for the peer nodes in case of failure?</p> <ul> <li>The manager will coordinate the process of reproducing the failed peers buckets on the remaining nodes.</li> </ul> <p>34 You are working with an application with a lot of duplicate and obsolete tags. You all the unnecessary tags. Later, you see that a field in one report is no longer functioning. What should you do next?</p> <ul> <li>Check if one of the deleted tags was previously referenced to an existing key-value pair.</li> </ul> <p>35 You are trying to plot both the average response time and the median response time against time in the same graph using the following Search Processing Language (SPL) query:</p> <pre><code>index=main sourcetype=access combined wcookie\ntimechart avg (response time) as AvgReponseTime span=30m\nstats median (AvgResponseTime)\n</code></pre> <ul> <li>You must use the SPL command <code>eventstats</code> instead of stats to retain the <code>AvgResponseTime</code>.</li> </ul> <p>36 An organization is attempting to reduce the impact should a manager node fail in a clustered environment. They want to add another manager node into the cluster for redundancy. How can they implement this?</p> <ul> <li>The second manager can be a standby manager node in case of the primary node's failure</li> </ul> <p>37 You are using a search macro and you run into this error: Error in 'SearchParser': The search specifies a macro that cannot be found Your spelling is correct and you have the necessary permissions. What could be the reason for this error?</p> <ul> <li>The definition of the search macro is wrong and you did not supply the required arguments when using the search macro.</li> </ul>"}]}