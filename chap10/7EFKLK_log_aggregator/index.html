
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Jacob's Elasticsearch7 技术与实战教程">
      
      
        <meta name="author" content="Jacob Xi">
      
      
      
        <link rel="prev" href="../3ECK_operator/">
      
      
        <link rel="next" href="../19Fluentd/">
      
      <link rel="icon" href="../../images/logo.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.15">
    
    
      
        <title>第七节 使用 EFKLK 搭建 Kubernetes 日志收集工具栈 (Kafka/Logstash) - Jacob ElasticSearch7 Book</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.26e3688c.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ecc896b0.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="blue">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#efklk-kubernetes-kafkalogstash" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="Jacob ElasticSearch7 Book" class="md-header__button md-logo" aria-label="Jacob ElasticSearch7 Book" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Jacob ElasticSearch7 Book
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              第七节 使用 EFKLK 搭建 Kubernetes 日志收集工具栈 (Kafka/Logstash)
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/Chao-Xi/jxes7book.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jxes7book
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Jacob ElasticSearch7 Book" class="md-nav__button md-logo" aria-label="Jacob ElasticSearch7 Book" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    Jacob ElasticSearch7 Book
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Chao-Xi/jxes7book.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jxes7book
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Welcome
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          一、Elasticsearch 概述
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          一、Elasticsearch 概述
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/1Es_intro/" class="md-nav__link">
        第一节 ElasticSearch 概述
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          二、Elasticsearch 安装手册
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          二、Elasticsearch 安装手册
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/1ES_vm_install/" class="md-nav__link">
        第一节 Elasticsearch的安装与简单配置
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/2KB_vm_install/" class="md-nav__link">
        第二节 Kibana的安装与界面快速预览
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/3ES_KB_docker/" class="md-nav__link">
        第三节 在Docker容器中运行Elasticsearch Kibana和Cerebro
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/4LogStash_vm_install/" class="md-nav__link">
        第四节 Logstash安装与导入数据
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          三、Elasticsearch 入门查询
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          三、Elasticsearch 入门查询
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/1ES_intro/" class="md-nav__link">
        第一节 ElasticSearch 基本概念
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/2ES_CRUD/" class="md-nav__link">
        第二节 文档的基本CRUD与批量操作 & 读取＆Bulk API
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/3ES_ReverseIndex/" class="md-nav__link">
        第三节 倒排索引
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/4ES_Analyzer/" class="md-nav__link">
        第四节 使用分析器进行分词
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/5ES_Search/" class="md-nav__link">
        第五节 ElasticSearch Search语句
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/6ES_Mapping/" class="md-nav__link">
        第六节 ElasticSearch Mapping 介绍
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/7ES_Index/" class="md-nav__link">
        第七节 Index Template和Dynamic Template
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/8ES_Aggr/" class="md-nav__link">
        第八节 Elasticsearch Aggregations聚合分析简介
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/9ES_SUM/" class="md-nav__link">
        第九节 Elasticsearch 入门总结 & 测试
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          四、Elasticsearch 深入搜索
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          四、Elasticsearch 深入搜索
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/1ES_search/" class="md-nav__link">
        第一节 基于词项和基于全文的搜索
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/2ES_search_str_score/" class="md-nav__link">
        第二节 结构化搜索以及搜索的相关性算分
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/3ES_query_filter/" class="md-nav__link">
        第三节 Query & Filtering与多字符串多字段查询
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/4ES_sin_mul_search/" class="md-nav__link">
        第四节 单字符串多字段查询
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/5ES_multi_lag_ana/" class="md-nav__link">
        第五节 多语言及中文分词与检索
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/6ES_pra_tmdb/" class="md-nav__link">
        第六节 Space Jam，一次全文搜索的实例
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/7ES_ST_IA/" class="md-nav__link">
        第七节 使⽤ Search Template 和 Index Alias
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/8ES_FUNC_SCORE/" class="md-nav__link">
        第八节 综合排序:Function Score Query 优化算分
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/9ES_suggester/" class="md-nav__link">
        第九节 Term & Phrase Suggester
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/10ES_Autocomplete/" class="md-nav__link">
        第十节 ⾃动补全与基于上下文的提示
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/11ES_CrossSearch/" class="md-nav__link">
        第十一节 跨集群搜索
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
      
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          五、分布式特性及分布式搜索的机制
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          五、分布式特性及分布式搜索的机制
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/1ES_cluster/" class="md-nav__link">
        第一节 集群分布式模型及选主与脑裂问题
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/2ES_shard/" class="md-nav__link">
        第二节 分⽚与集群的故障转移
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/3ES_doc_shard/" class="md-nav__link">
        第三节 ⽂档分布式存储
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/4ES_shared_lifecycle/" class="md-nav__link">
        第四节 分⽚及其生命周期
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/5ES_SE_Score/" class="md-nav__link">
        第五节 剖析分布式查询及相关性算分
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/6ES_Sort_query/" class="md-nav__link">
        第六节 排序及Doc Values&Fielddata
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/7ES_Pages_Traverse/" class="md-nav__link">
        第七节 分页与遍历 – From，Size，Search After & Scroll API
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/8ES_Concurrent_process/" class="md-nav__link">
        第八节 处理并发读写操作
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
      
      
      
        <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
          六、深入聚合分析
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          六、深入聚合分析
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6/1chap6_bucket_metrics/" class="md-nav__link">
        第一节 Bucket & Metric 聚合分析及嵌套聚合
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6/2chap6_pipeline_metrics/" class="md-nav__link">
        第二节 Pipeline 聚合分析
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6/3chap6_aggragate_scope_order/" class="md-nav__link">
        第三节 聚合的作⽤范围及排序
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6/4chap6_accurate_aggragate/" class="md-nav__link">
        第四节 聚合的精准度问题
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
      
      
      
        <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
          七、数据建模
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          七、数据建模
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap7/1chap7_nested_obj/" class="md-nav__link">
        第一节 对象及 Nested 对象
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap7/2chap7_parent_child/" class="md-nav__link">
        第二节 文档的父子关系
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap7/3chap7_updateindex_reindex/" class="md-nav__link">
        第三节 Update By Query & Reindex API
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap7/4chap7_ingest_painless/" class="md-nav__link">
        第四节 Ingest Pipeline 与 Painless Script
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap7/5chap7_es_model/" class="md-nav__link">
        第五节 Elasticsearch 数据建模实例
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap7/6chap7_es_model_pra/" class="md-nav__link">
        第六节 Elasticsearch 数据建模最佳实践
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap7/7chap7_es_sum2/" class="md-nav__link">
        第七节 第二部分总结回顾
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
      
      
      
        <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
          八、数据保护
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          八、数据保护
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/1ES_cluster_IAM/" class="md-nav__link">
        第一节 集群身份认证与用户鉴权
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/2ES_cluster_enc_transit/" class="md-nav__link">
        第二节 集群内部间的安全通信
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/3ES_cluster_out_sec/" class="md-nav__link">
        第三节 集群与外部间的安全通信
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
      
      
      
        <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
          九、水平扩展Elasticsearch集群
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_10">
          <span class="md-nav__icon md-icon"></span>
          九、水平扩展Elasticsearch集群
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/1ES_cluster_deploy/" class="md-nav__link">
        第一节 常见的集群部署方式
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/2ES_hot_warm/" class="md-nav__link">
        第二节 Hot & Warm 架构与 Shard Filtering
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/3ES_shard_settings/" class="md-nav__link">
        第三节 分片设定及管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/4ES_cluster_plan/" class="md-nav__link">
        第四节 如何对集群进行容量规划
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/5ES_Cloud/" class="md-nav__link">
        第五节 云上管理 Elasticsearch 的一些方法
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" checked>
      
      
      
        <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
          十、使用 Kubernets 安装 EFK 集群
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_11">
          <span class="md-nav__icon md-icon"></span>
          十、使用 Kubernets 安装 EFK 集群
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../1log_architecture/" class="md-nav__link">
        第一节 kubernetes 日志架构
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2EFK_log/" class="md-nav__link">
        第二节 在 K8S 上搭建 EFK 日志收集系统
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../16EFK_log_adv/" class="md-nav__link">
        第三节 在 Kubernetes 安装 EFK 日志收集系统[更新]
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../17EFK_log_Ana/" class="md-nav__link">
        第四节 EFK kibana 日志分析
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../18EFK_log_alert/" class="md-nav__link">
        第五节 基于EKF日志的报警
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../3ECK_operator/" class="md-nav__link">
        第六节 使用Operator快速部署Elasticsearch集群
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          第七节 使用 EFKLK 搭建 Kubernetes 日志收集工具栈 (Kafka/Logstash)
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        第七节 使用 EFKLK 搭建 Kubernetes 日志收集工具栈 (Kafka/Logstash)
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-elasticsearch" class="md-nav__link">
    1、安装 Elasticsearch 集群
  </a>
  
    <nav class="md-nav" aria-label="1、安装 Elasticsearch 集群">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-1" class="md-nav__link">
    1-1 环境准备
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-2-helm-es" class="md-nav__link">
    1-2 Helm 安装 ES 集群
  </a>
  
    <nav class="md-nav" aria-label="1-2 Helm 安装 ES 集群">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-2-1-master" class="md-nav__link">
    1-2-1 Master 节点安装配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-2-2-data" class="md-nav__link">
    1-2-2 Data 节点
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-2-3-client" class="md-nav__link">
    1-2-3 Client 节点
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-3-kibana" class="md-nav__link">
    1-3 安装 Kibana
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-fluentd" class="md-nav__link">
    2、部署 Fluentd
  </a>
  
    <nav class="md-nav" aria-label="2、部署 Fluentd">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#2-1" class="md-nav__link">
    2-1 工作原理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-2" class="md-nav__link">
    2-2 配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-2-1" class="md-nav__link">
    2-2-1 日志源配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-2-2" class="md-nav__link">
    2-2-2 路由配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-2-3" class="md-nav__link">
    2-2-3 过滤
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-4" class="md-nav__link">
    2-4 安装
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-kafka" class="md-nav__link">
    3、安装 Kafka
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4fluentd-kafka" class="md-nav__link">
    4、Fluentd 配置 Kafka
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-logstash" class="md-nav__link">
    5、安装 Logstash
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../19Fluentd/" class="md-nav__link">
        第八节 日志收集工具 Fluentd 使用教程
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12" >
      
      
      
        <label class="md-nav__link" for="__nav_12" id="__nav_12_label" tabindex="0">
          十一、使用 Elastic Stack 构建 Kubernetes 全栈监控
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_12">
          <span class="md-nav__icon md-icon"></span>
          十一、使用 Elastic Stack 构建 Kubernetes 全栈监控
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap11/20Elastic_Stack_Monitoring1/" class="md-nav__link">
        第一节 ElasticSearch 的集群安装
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap11/21Elastic_Stack_Monitoring2/" class="md-nav__link">
        第二节 使用 Elastic Stack — Metricbeat 监控安装
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap11/22Elastic_Stack_Monitoring3/" class="md-nav__link">
        第三节 使用 Elastic Stack - Filebeat 日志数据收集安装
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap11/23Elastic_Stack_Monitoring4/" class="md-nav__link">
        第四节 使用 Elastic Stack — Elastic APM 应用性能监控的工具安装
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13" >
      
      
      
        <label class="md-nav__link" for="__nav_13" id="__nav_13_label" tabindex="0">
          十二、生产环境中的集群运维
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_13">
          <span class="md-nav__icon md-icon"></span>
          十二、生产环境中的集群运维
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap12/1chap12_ES_prod/" class="md-nav__link">
        第一节 生产环境常用配置和上线清单
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap12/2chap12_mon_es/" class="md-nav__link">
        第二节 监控Elasticsearch集群
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap12/3chap12_es_diag/" class="md-nav__link">
        第三节 诊断集群的潜在问题
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap12/4chap12_es_red_yellow/" class="md-nav__link">
        第四节 解决集群 Yellow 与 Red 的问题
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap12/5chap12_es_cluster_perf/" class="md-nav__link">
        第五节 集群写性能优化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap12/6chap12_es_pre_test/" class="md-nav__link">
        第六节 集群压力测试
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap12/7chap12_es_segment_merge/" class="md-nav__link">
        第七节 段合并优化及注意事项
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap12/8chap12_Circuit_Breaker/" class="md-nav__link">
        第八节 缓存及使用 Circuit Breaker 限制内存使用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap12/9chap12_es_ops/" class="md-nav__link">
        第九节 一些运维相关的建议
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_14" >
      
      
      
        <label class="md-nav__link" for="__nav_14" id="__nav_14_label" tabindex="0">
          十三、索引生命周期管理
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_14_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_14">
          <span class="md-nav__icon md-icon"></span>
          十三、索引生命周期管理
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap13/1chap13_es_shrink_rolloverapi/" class="md-nav__link">
        第一节 使用 Shrink 与 Rollover API 管理索引
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap13/2chap13_index_lms/" class="md-nav__link">
        第二节 索引全生命周期管理及工具介绍
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_15" >
      
      
      
        <label class="md-nav__link" for="__nav_15" id="__nav_15_label" tabindex="0">
          十四、用Logstash和Beats构建数据管道
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_15_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_15">
          <span class="md-nav__icon md-icon"></span>
          十四、用Logstash和Beats构建数据管道
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap14/1logstash_introduce/" class="md-nav__link">
        第一节 Logstash 入门及架构介绍
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap14/2JDBC_logstash_ES/" class="md-nav__link">
        第二节 利用 JDBC 插件导入数据到 Elasticsearch
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap14/3Beats/" class="md-nav__link">
        第三节 Beats 介绍
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_16" >
      
      
      
        <label class="md-nav__link" for="__nav_16" id="__nav_16_label" tabindex="0">
          十五、用Kibana进行数据可视化分析
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_16_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_16">
          <span class="md-nav__icon md-icon"></span>
          十五、用Kibana进行数据可视化分析
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap15/1chap15_index_pattern/" class="md-nav__link">
        第一节 使用 Index Pattern 配置数据
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap15/2chap15_kibana/" class="md-nav__link">
        第二节 Kibana 使用的技巧
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_17" >
      
      
      
        <label class="md-nav__link" for="__nav_17" id="__nav_17_label" tabindex="0">
          十六、探索X-Pack套件
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_17_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_17">
          <span class="md-nav__icon md-icon"></span>
          十六、探索X-Pack套件
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap16/1ES_monitor_alert_xpack/" class="md-nav__link">
        第一节 用Monitoring和Alerting监控Elasticsearch集群
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap16/2Xpack_APM/" class="md-nav__link">
        第二节 用 APM 进行程序性能监控
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap16/3Xpack_ML/" class="md-nav__link">
        第三节 用机器学习实现异常检测
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap16/4ELK_Filebeat/" class="md-nav__link">
        第四节 用 Elastic Stack 进行日志管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap16/5xpack_canvas/" class="md-nav__link">
        第五节 用 Canvas 进行数据的实时展示
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_18" >
      
      
      
        <label class="md-nav__link" for="__nav_18" id="__nav_18_label" tabindex="0">
          十七、ELK 实战 Workshop
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_18_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_18">
          <span class="md-nav__icon md-icon"></span>
          十七、ELK 实战 Workshop
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap17/1ES_WS_movie/" class="md-nav__link">
        第一节 电影搜索服务
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap17/2ES_WS_stackoverflow/" class="md-nav__link">
        第二节 Stackoverflow用户调查问卷分析
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap17/3EFK_jfrog/" class="md-nav__link">
        第三节 通过EFK对Artifactory进行日志分析
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_19" >
      
      
      
        <label class="md-nav__link" for="__nav_19" id="__nav_19_label" tabindex="0">
          十八、Elastic认证, 开发与备份
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_19_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_19">
          <span class="md-nav__icon md-icon"></span>
          十八、Elastic认证, 开发与备份
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap18/1ES_Certified_test/" class="md-nav__link">
        第一节 Elastic 认证考试
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap18/2ES_backup_restore/" class="md-nav__link">
        第二节 集群 Backup & Restore
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap18/3ES_Java/" class="md-nav__link">
        第三节 基于 Java 和 Elasticsearch 开发应用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap18/4ES_migration/" class="md-nav__link">
        第四节 3种 Elasticsearch 数据离线迁移方案
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_20" >
      
      
      
        <label class="md-nav__link" for="__nav_20" id="__nav_20_label" tabindex="0">
          十九、Elastic 操作总结篇
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_20_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_20">
          <span class="md-nav__icon md-icon"></span>
          十九、Elastic 操作总结篇
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap19/sum1_search_api/" class="md-nav__link">
        ElasticSearch URI 常用语句总结篇
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap19/sum2_search_dep/" class="md-nav__link">
        Elasticsearch 深入搜索总结
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap19/sum3_cross_search/" class="md-nav__link">
        ElasticSearch 分布式搜索
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap19/sum4_agg_search/" class="md-nav__link">
        ElasticSearch 深入聚合分析
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap19/sum5_datamodel/" class="md-nav__link">
        ElasticSearch 数据建模
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap19/sum6_Opt_Mgt/" class="md-nav__link">
        ElasticSearch Operation and Management
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap19/sum7_test/" class="md-nav__link">
        期末考试
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap19/sum8_int/" class="md-nav__link">
        ElasticSearch 面试
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_21" >
      
      
      
        <label class="md-nav__link" for="__nav_21" id="__nav_21_label" tabindex="0">
          Splunk8 Admin Mgt
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_21_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_21">
          <span class="md-nav__icon md-icon"></span>
          Splunk8 Admin Mgt
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../spl1/1spl_role_ad/" class="md-nav__link">
        1 Splunk Managing Users and Authentication
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../spl1/2config_indexes/" class="md-nav__link">
        2 Working with Configuration Files and Indexes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../spl1/3datamgt_forwarder/" class="md-nav__link">
        3 Managing Data and Forwarders
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../spl1/4config_ds/" class="md-nav__link">
        4 Splunk Configuring Distributed Search
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../spl1/5Mon_create_inputs/" class="md-nav__link">
        5 Splunk Monitoring and Creating Inputs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../spl1/6par_man/" class="md-nav__link">
        6 Splunk Parsing and Manipulating Data
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../spl1/7splunk_search/" class="md-nav__link">
        7 Performing Basic Splunk Searches
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../spl1/8spl_exam/" class="md-nav__link">
        8 Splunk ADMIN Exam
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-elasticsearch" class="md-nav__link">
    1、安装 Elasticsearch 集群
  </a>
  
    <nav class="md-nav" aria-label="1、安装 Elasticsearch 集群">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-1" class="md-nav__link">
    1-1 环境准备
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-2-helm-es" class="md-nav__link">
    1-2 Helm 安装 ES 集群
  </a>
  
    <nav class="md-nav" aria-label="1-2 Helm 安装 ES 集群">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-2-1-master" class="md-nav__link">
    1-2-1 Master 节点安装配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-2-2-data" class="md-nav__link">
    1-2-2 Data 节点
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-2-3-client" class="md-nav__link">
    1-2-3 Client 节点
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-3-kibana" class="md-nav__link">
    1-3 安装 Kibana
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-fluentd" class="md-nav__link">
    2、部署 Fluentd
  </a>
  
    <nav class="md-nav" aria-label="2、部署 Fluentd">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#2-1" class="md-nav__link">
    2-1 工作原理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-2" class="md-nav__link">
    2-2 配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-2-1" class="md-nav__link">
    2-2-1 日志源配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-2-2" class="md-nav__link">
    2-2-2 路由配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-2-3" class="md-nav__link">
    2-2-3 过滤
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-4" class="md-nav__link">
    2-4 安装
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-kafka" class="md-nav__link">
    3、安装 Kafka
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4fluentd-kafka" class="md-nav__link">
    4、Fluentd 配置 Kafka
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-logstash" class="md-nav__link">
    5、安装 Logstash
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="efklk-kubernetes-kafkalogstash"><strong>第七节 使用 EFKLK 搭建 Kubernetes 日志收集工具栈 (Kafka/Logstash)</strong></h1>
<p>Elasticsearch 是一个实时的、分布式的可扩展的搜索引擎，允许进行全文、结构化搜索，它通常用于索引和搜索大量日志数据，也可用于搜索许多不同类型的文档。</p>
<p>Elasticsearch 通常与 Kibana 一起部署，Kibana 是 Elasticsearch 的一个功能强大的数据可视化 Dashboard，Kibana 允许你通过 web 界面来浏览 Elasticsearch 日志数据。</p>
<p>Fluentd是一个流行的开源数据收集器，我们将在 Kubernetes 集群节点上安装 Fluentd，通过获取容器日志文件、过滤和转换日志数据，然后将数据传递到 Elasticsearch 集群，在该集群中对其进行索引和存储。</p>
<p>我们先来配置启动一个可扩展的 Elasticsearch 集群，然后在 Kubernetes 集群中创建一个 Kibana 应用，最后通过 DaemonSet 来运行 Fluentd，以便它在每个 Kubernetes 工作节点上都可以运行一个 Pod。</p>
<blockquote>
<p>如果你了解 EFK 的基本原理，只是为了测试可以直接使用 Kubernetes 官方提供的 addon 插件的资源清单，地址：<a href="https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/fluentd-elasticsearch/">https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/fluentd-elasticsearch/</a>，直接安装即可。</p>
</blockquote>
<h2 id="1-elasticsearch"><strong>1、安装 Elasticsearch 集群</strong></h2>
<p>在创建 Elasticsearch 集群之前，我们先创建一个命名空间，我们将在其中安装所有日志相关的资源对象。</p>
<pre><code>kubectl create ns logging
</code></pre>
<h3 id="1-1"><strong>1-1 环境准备</strong></h3>
<p>ElasticSearch 安装有最低安装要求，如果安装后 Pod 无法正常启动，请检查是否符合最低要求的配置，要求如下：</p>
<p><img alt="Alt Image Text" src="../../images/chap10_7_1.png" title="Body image" /></p>
<p>这里我们要安装的 ES 集群环境信息如下所示：</p>
<p><img alt="Alt Image Text" src="../../images/chap10_7_2.png" title="Body image" /></p>
<p>这里我们使用一个 NFS 类型的 StorageClass 来做持久化存储，当然如果你是线上环境建议使用 Local PV 或者 Ceph RBD 之类的存储来持久化 Elasticsearch 的数据。</p>
<p><strong>此外由于 ElasticSearch 7.x 版本默认安装了 X-Pack 插件，并且部分功能免费，需要我们配置一些安全证书文件</strong>。</p>
<p><strong>1、生成证书文件</strong></p>
<pre><code># 运行容器生成证书
$ docker run --name elastic-certs -i -w /app elasticsearch:7.12.0 /bin/sh -c  \
  &quot;elasticsearch-certutil ca --out /app/elastic-stack-ca.p12 --pass '' &amp;&amp; \
    elasticsearch-certutil cert --name security-master --dns \
    security-master --ca /app/elastic-stack-ca.p12 --pass '' --ca-pass '' --out /app/elastic-certificates.p12&quot;


# 从容器中将生成的证书拷贝出来
$ docker cp elastic-certs:/app/elastic-certificates.p12 .


# 删除容器
$ docker rm -f elastic-certs


# 将 pcks12 中的信息分离出来，写入文件
$ openssl pkcs12 -nodes -passin pass:'' -in elastic-certificates.p12 -out elastic-certificate.pem
</code></pre>
<p><strong>2、添加证书到 Kubernetes</strong></p>
<pre><code># 添加证书
$ kubectl create secret -n logging generic elastic-certs --from-file=elastic-certificates.p12


# 设置集群用户名密码
$ kubectl create secret -n logging generic elastic-auth --from-literal=username=elastic --from-literal=password=jxi321
</code></pre>
<h3 id="1-2-helm-es"><strong>1-2 Helm 安装 ES 集群</strong></h3>
<p>首先添加 ELastic 的 Helm 仓库：</p>
<pre><code>helm repo add elastic https://helm.elastic.co
helm repo update
</code></pre>
<p>ElaticSearch 安装需要安装三次，分别安装 Master、Data、Client 节点，</p>
<ul>
<li><strong>Master 节点负责集群间的管理工作</strong>；</li>
<li><strong>Data 节点负责存储数据；</strong></li>
<li><strong>Client 节点负责代理 ElasticSearch Cluster 集群，负载均衡</strong>。</li>
</ul>
<p><strong>首先使用 <code>helm pull</code>拉取 Chart 并解压：</strong></p>
<pre><code>helm pull elastic/elasticsearch --untar --version 7.12.0
cd elasticsearch
</code></pre>
<h4 id="1-2-1-master"><strong>1-2-1 Master 节点安装配置</strong></h4>
<p>在 Chart 目录下面创建用于 Master 节点安装配置的 values 文件：</p>
<p><strong><code>values-master.yaml</code></strong></p>
<pre><code># values-master.yaml
## 设置集群名称
clusterName: &quot;elasticsearch&quot;
## 设置节点名称
nodeGroup: &quot;master&quot;

## 设置角色
roles:
  master: &quot;true&quot;
  ingest: &quot;false&quot;
  data: &quot;false&quot;

# ============镜像配置============
## 指定镜像与镜像版本
image: &quot;elasticsearch&quot;
imageTag: &quot;7.12.0&quot;
## 副本数
replicas: 3

# ============资源配置============
## JVM 配置参数
esJavaOpts: &quot;-Xmx1g -Xms1g&quot;
## 部署资源配置(生成环境一定要设置大些)
resources:
  requests:
    cpu: &quot;2000m&quot;
    memory: &quot;2Gi&quot;
  limits:
    cpu: &quot;2000m&quot;
    memory: &quot;2Gi&quot;
## 数据持久卷配置
persistence:
  enabled: true
## 存储数据大小配置
volumeClaimTemplate:
  storageClassName: nfs-storage
  accessModes: [&quot;ReadWriteOnce&quot;]
  resources:
    requests:
      storage: 5Gi

# ============安全配置============
## 设置协议，可配置为 http、https
protocol: http
## 证书挂载配置，这里我们挂入上面创建的证书
secretMounts:
  - name: elastic-certs
    secretName: elastic-certs
    path: /usr/share/elasticsearch/config/certs

## 允许您在/usr/share/elasticsearch/config/中添加任何自定义配置文件,例如 elasticsearch.yml
## ElasticSearch 7.x 默认安装了 x-pack 插件，部分功能免费，这里我们配置下
## 下面注掉的部分为配置 https 证书，配置此部分还需要配置 helm 参数 protocol 值改为 https
esConfig:
  elasticsearch.yml: |
    xpack.security.enabled: true
    xpack.security.transport.ssl.enabled: true
    xpack.security.transport.ssl.verification_mode: certificate
    xpack.security.transport.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
    xpack.security.transport.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
    # xpack.security.http.ssl.enabled: true
    # xpack.security.http.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
    # xpack.security.http.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
## 环境变量配置，这里引入上面设置的用户名、密码 secret 文件
extraEnvs:
  - name: ELASTIC_USERNAME
    valueFrom:
      secretKeyRef:
        name: elastic-auth
        key: username
  - name: ELASTIC_PASSWORD
    valueFrom:
      secretKeyRef:
        name: elastic-auth
        key: password

# ============调度配置============
## 设置调度策略
## - hard：只有当有足够的节点时 Pod 才会被调度，并且它们永远不会出现在同一个节点上
## - soft：尽最大努力调度
antiAffinity: &quot;soft&quot;
tolerations:
  - operator: &quot;Exists&quot; ##容忍全部污点
</code></pre>
<h4 id="1-2-2-data"><strong>1-2-2 Data 节点</strong></h4>
<p>然后创建用于 Data 节点安装的 values 文件：</p>
<pre><code># values-data.yaml
# ============设置集群名称============
## 设置集群名称
clusterName: &quot;elasticsearch&quot;
## 设置节点名称
nodeGroup: &quot;data&quot;
## 设置角色
roles:
  master: &quot;false&quot;
  ingest: &quot;true&quot;
  data: &quot;true&quot;

# ============镜像配置============
## 指定镜像与镜像版本
image: &quot;elasticsearch&quot;
imageTag: &quot;7.12.0&quot;
## 副本数(建议设置为3，我这里资源不足只用了1个副本)
replicas: 1

# ============资源配置============
## JVM 配置参数
esJavaOpts: &quot;-Xmx1g -Xms1g&quot;
## 部署资源配置(生成环境一定要设置大些)
resources:
  requests:
    cpu: &quot;1000m&quot;
    memory: &quot;2Gi&quot;
  limits:
    cpu: &quot;1000m&quot;
    memory: &quot;2Gi&quot;
## 数据持久卷配置
persistence:
  enabled: true
## 存储数据大小配置
volumeClaimTemplate:
  storageClassName: nfs-storage
  accessModes: [&quot;ReadWriteOnce&quot;]
  resources:
    requests:
      storage: 10Gi

# ============安全配置============
## 设置协议，可配置为 http、https
protocol: http
## 证书挂载配置，这里我们挂入上面创建的证书
secretMounts:
  - name: elastic-certs
    secretName: elastic-certs
    path: /usr/share/elasticsearch/config/certs
## 允许您在/usr/share/elasticsearch/config/中添加任何自定义配置文件,例如 elasticsearch.yml
## ElasticSearch 7.x 默认安装了 x-pack 插件，部分功能免费，这里我们配置下
## 下面注掉的部分为配置 https 证书，配置此部分还需要配置 helm 参数 protocol 值改为 https
esConfig:
  elasticsearch.yml: |
    xpack.security.enabled: true
    xpack.security.transport.ssl.enabled: true
    xpack.security.transport.ssl.verification_mode: certificate
    xpack.security.transport.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
    xpack.security.transport.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
    # xpack.security.http.ssl.enabled: true
    # xpack.security.http.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
    # xpack.security.http.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
## 环境变量配置，这里引入上面设置的用户名、密码 secret 文件
extraEnvs:
  - name: ELASTIC_USERNAME
    valueFrom:
      secretKeyRef:
        name: elastic-auth
        key: username
  - name: ELASTIC_PASSWORD
    valueFrom:
      secretKeyRef:
        name: elastic-auth
        key: password

# ============调度配置============
## 设置调度策略
## - hard：只有当有足够的节点时 Pod 才会被调度，并且它们永远不会出现在同一个节点上
## - soft：尽最大努力调度
antiAffinity: &quot;soft&quot;
## 容忍配置
tolerations:
  - operator: &quot;Exists&quot; ##容忍全部污点 
</code></pre>
<h4 id="1-2-3-client"><strong>1-2-3 Client 节点</strong></h4>
<p>最后一个是用于创建 Client 节点的 values 文件：</p>
<pre><code># values-client.yaml
# ============设置集群名称============
## 设置集群名称
clusterName: &quot;elasticsearch&quot;
## 设置节点名称
nodeGroup: &quot;client&quot;
## 设置角色
roles:
  master: &quot;false&quot;
  ingest: &quot;false&quot;
  data: &quot;false&quot;

# ============镜像配置============
## 指定镜像与镜像版本
image: &quot;elasticsearch&quot;
imageTag: &quot;7.12.0&quot;
## 副本数
replicas: 1

# ============资源配置============
## JVM 配置参数
esJavaOpts: &quot;-Xmx1g -Xms1g&quot;
## 部署资源配置(生成环境一定要设置大些)
resources:
  requests:
    cpu: &quot;1000m&quot;
    memory: &quot;2Gi&quot;
  limits:
    cpu: &quot;1000m&quot;
    memory: &quot;2Gi&quot;
## 数据持久卷配置
persistence:
  enabled: false

# ============安全配置============
## 设置协议，可配置为 http、https
protocol: http
## 证书挂载配置，这里我们挂入上面创建的证书
secretMounts:
  - name: elastic-certs
    secretName: elastic-certs
    path: /usr/share/elasticsearch/config/certs
## 允许您在/usr/share/elasticsearch/config/中添加任何自定义配置文件,例如 elasticsearch.yml
## ElasticSearch 7.x 默认安装了 x-pack 插件，部分功能免费，这里我们配置下
## 下面注掉的部分为配置 https 证书，配置此部分还需要配置 helm 参数 protocol 值改为 https
esConfig:
  elasticsearch.yml: |
    xpack.security.enabled: true
    xpack.security.transport.ssl.enabled: true
    xpack.security.transport.ssl.verification_mode: certificate
    xpack.security.transport.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
    xpack.security.transport.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
    # xpack.security.http.ssl.enabled: true
    # xpack.security.http.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
    # xpack.security.http.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
## 环境变量配置，这里引入上面设置的用户名、密码 secret 文件
extraEnvs:
  - name: ELASTIC_USERNAME
    valueFrom:
      secretKeyRef:
        name: elastic-auth
        key: username
  - name: ELASTIC_PASSWORD
    valueFrom:
      secretKeyRef:
        name: elastic-auth
        key: password

# ============Service 配置============
service:
  type: NodePort
  nodePort: &quot;30200&quot;
</code></pre>
<p>现在用上面的 values 文件来安装：</p>
<pre><code># 安装 master 节点

helm install es-master -f values-master.yaml --namespace logging .
# 安装 data 节点

helm install es-data -f values-data.yaml --namespace logging .

# 安装 client 节点
helm install es-client -f values-client.yaml --namespace logging .
</code></pre>
<h3 id="1-3-kibana"><strong>1-3 安装 Kibana</strong></h3>
<p>Elasticsearch 集群安装完成后接下来配置安装 Kibana</p>
<p>使用 <code>helm pull</code> 命令拉取 Kibana Chart 包并解压：</p>
<pre><code>helm pull elastic/kibana --untar --version 7.12.0
cd kibana
</code></pre>
<p>创建用于安装 Kibana 的 values 文件：</p>
<p><strong><code>values-prod.yaml</code></strong></p>
<pre><code># values-prod.yaml
## 指定镜像与镜像版本
image: &quot;kibana&quot;
imageTag: &quot;7.12.0&quot;

## 配置 ElasticSearch 地址
elasticsearchHosts: &quot;http://elasticsearch-client:9200&quot;

# ============环境变量配置============
## 环境变量配置，这里引入上面设置的用户名、密码 secret 文件
extraEnvs:
  - name: &quot;ELASTICSEARCH_USERNAME&quot;
    valueFrom:
      secretKeyRef:
        name: elastic-auth
        key: username
  - name: &quot;ELASTICSEARCH_PASSWORD&quot;
    valueFrom:
      secretKeyRef:
        name: elastic-auth
        key: password

# ============资源配置============
resources:
  requests:
    cpu: &quot;500m&quot;
    memory: &quot;1Gi&quot;
  limits:
    cpu: &quot;500m&quot;
    memory: &quot;1Gi&quot;

# ============配置 Kibana 参数============
## kibana 配置中添加语言配置，设置 kibana 为中文
kibanaConfig:
  kibana.yml: |
    i18n.locale: &quot;zh-CN&quot;

# ============Service 配置============
service:
  type: NodePort
  nodePort: &quot;30601&quot;
</code></pre>
<p>使用上面的配置直接安装即可：</p>
<pre><code>helm install kibana -f values-prod.yaml --namespace logging .
</code></pre>
<p>下面是安装完成后的 ES 集群和 Kibana 资源：</p>
<pre><code>[root@node2 ~]# kubectl get pods -n logging
NAME                            READY   STATUS              RESTARTS   AGE
elasticsearch-client-0          1/1     Running             0          13m
elasticsearch-data-0            1/1     Running             0          17m
elasticsearch-master-0          1/1     Running             0          14m
elasticsearch-master-1          1/1     Running             0          16m
elasticsearch-master-2          1/1     Running             0          18m
kibana-kibana-66f97964b-pmqlq   1/1     Running             0          31s
[root@node2 ~]# kubectl get svc -n logging
NAME                            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                         AGE
elasticsearch-client            NodePort    10.102.35.207   &lt;none&gt;        9200:30200/TCP,9300:30078/TCP   33m
elasticsearch-client-headless   ClusterIP   None            &lt;none&gt;        9200/TCP,9300/TCP               33m
elasticsearch-data              ClusterIP   10.97.179.233   &lt;none&gt;        9200/TCP,9300/TCP               37m
elasticsearch-data-headless     ClusterIP   None            &lt;none&gt;        9200/TCP,9300/TCP               37m
elasticsearch-master            ClusterIP   10.97.35.120    &lt;none&gt;        9200/TCP,9300/TCP               46m
elasticsearch-master-headless   ClusterIP   None            &lt;none&gt;        9200/TCP,9300/TCP               46m
kibana-kibana                   NodePort    10.106.97.8     &lt;none&gt;        5601:30601/TCP                  35s
</code></pre>
<p>上面我们安装 Kibana 的时候指定了 30601 的 NodePort 端口，所以我们可以从任意节点 <a href="http://IP:30601">http://IP:30601</a> 来访问 Kibana。</p>
<p><img alt="Alt Image Text" src="../../images/chap10_7_3.png" title="Body image" /></p>
<p>我们可以看到会跳转到登录页面，让我们输出用户名、密码，这里我们输入上面配置的用户名 elastic、密码 jx321 进行登录。登录成功后进入如下所示的 Kibana 主页：</p>
<p><img alt="Alt Image Text" src="../../images/chap10_7_4.png" title="Body image" /></p>
<h2 id="2-fluentd"><strong>2、部署 Fluentd</strong></h2>
<p>Fluentd 是一个高效的日志聚合器，是用 Ruby 编写的，并且可以很好地扩展。对于大部分企业来说，Fluentd 足够高效并且消耗的资源相对较少，另外一个工具Fluent-bit更轻量级，占用资源更少，但是插件相对 Fluentd 来说不够丰富，所以整体来说，Fluentd 更加成熟，使用更加广泛，所以我们这里也同样使用 Fluentd 来作为日志收集工具。</p>
<h3 id="2-1"><strong>2-1 工作原理</strong></h3>
<p>Fluentd 通过一组给定的数据源抓取日志数据，处理后（转换成结构化的数据格式）将它们转发给其他服务，比如 Elasticsearch、对象存储等等。Fluentd 支持超过 300 个日志存储和分析服务，所以在这方面是非常灵活的。主要运行步骤如下：</p>
<ul>
<li>首先 Fluentd 从多个日志源获取数据</li>
<li>结构化并且标记这些数据</li>
<li>然后根据匹配的标签将数据发送到多个目标服务去</li>
</ul>
<p><img alt="Alt Image Text" src="../../images/chap10_7_5.png" title="Body image" /></p>
<h3 id="2-2"><strong>2-2 配置</strong></h3>
<p>一般来说我们是通过一个配置文件来告诉 Fluentd 如何采集、处理数据的，下面简单和大家介绍下 Fluentd 的配置方法。</p>
<h3 id="2-2-1"><strong>2-2-1 日志源配置</strong></h3>
<pre><code>
&lt;source&gt;
  @id fluentd-containers.log
  @type tail                             # Fluentd 内置的输入方式，其原理是不停地从源文件中获取新的日志。
  path /var/log/containers/*.log         # 挂载的服务器Docker容器日志地址
  pos_file /var/log/es-containers.log.pos
  tag raw.kubernetes.*                   # 设置日志标签
  read_from_head true
  &lt;parse&gt;                                # 多行格式化成JSON
    @type multi_format                   # 使用 multi-format-parser 解析器插件
    &lt;pattern&gt;
      format json                        # JSON 解析器
      time_key time                      # 指定事件时间的时间字段
      time_format %Y-%m-%dT%H:%M:%S.%NZ  # 时间格式
    &lt;/pattern&gt;
    &lt;pattern&gt;
      format /^(?&lt;time&gt;.+) (?&lt;stream&gt;stdout|stderr) [^ ]* (?&lt;log&gt;.*)$/
      time_format %Y-%m-%dT%H:%M:%S.%N%:z
    &lt;/pattern&gt;
  &lt;/parse&gt;
&lt;/source&gt;
</code></pre>
<p>上面配置部分参数说明如下：</p>
<ul>
<li><strong><code>id</code>：表示引用该日志源的唯一标识符，该标识可用于进一步过滤和路由结构化日志数据</strong></li>
<li><code>**type</code>：Fluentd 内置的指令，tail 表示 Fluentd 从上次读取的位置通过 tail 不断获取数据，另外一个是 http 表示通过一个 GET 请求来收集数据**。</li>
<li><strong><code>path</code>：tail 类型下的特定参数，告诉 Fluentd 采集 <code>/var/log/containers</code> 目录下的所有日志，这是 docker 在 Kubernetes 节点上用来存储运行容器 stdout 输出日志数据的目录。</strong></li>
<li><strong><code>pos_file</code>：检查点，如果 Fluentd 程序重新启动了，它将使用此文件中的位置来恢复日志数据收集。</strong></li>
<li><strong><code>tag</code>：用来将日志源与目标或者过滤器匹配的自定义字符串，Fluentd 匹配源/目标标签来路由日志数据。</strong></li>
</ul>
<h3 id="2-2-2"><strong>2-2-2 路由配置</strong></h3>
<p>上面是日志源的配置，接下来看看如何将日志数据发送到 Elasticsearch：</p>
<pre><code>&lt;match **&gt;
  @id elasticsearch
  @type elasticsearch
  @log_level info
  include_tag_key true
  type_name fluentd
  host &quot;#{ENV['OUTPUT_HOST']}&quot;
  port &quot;#{ENV['OUTPUT_PORT']}&quot;
  logstash_format true
  &lt;buffer&gt;
    @type file
    path /var/log/fluentd-buffers/kubernetes.system.buffer
    flush_mode interval
    retry_type exponential_backoff
    flush_thread_count 2
    flush_interval 5s
    retry_forever
    retry_max_interval 30
    chunk_limit_size &quot;#{ENV['OUTPUT_BUFFER_CHUNK_LIMIT']}&quot;
    queue_limit_length &quot;#{ENV['OUTPUT_BUFFER_QUEUE_LIMIT']}&quot;
    overflow_action block
  &lt;/buffer&gt;
&lt;/match&gt;
</code></pre>
<ul>
<li>match：标识一个目标标签，后面是一个匹配日志源的正则表达式，我们这里想要捕获所有的日志并将它们发送给 Elasticsearch，所以需要配置成<code>**</code>。</li>
<li>id：目标的一个唯一标识符。</li>
<li>type：支持的输出插件标识符，我们这里要输出到 Elasticsearch，所以配置成 elasticsearch，这是 Fluentd 的一个内置插件。</li>
<li><code>log_level</code>：指定要捕获的日志级别，<strong>我们这里配置成 info，表示任何该级别或者该级别以上（INFO、WARNING、ERROR）的日志都将被路由到 Elsasticsearch</strong>。</li>
<li><code>host/port</code>：定义 Elasticsearch 的地址，也可以配置认证信息，我们的 Elasticsearch 不需要认证，所以这里直接指定 host 和 port 即可。</li>
<li><code>logstash_format</code>：Elasticsearch 服务对日志数据构建反向索引进行搜索，将 <code>logstash_format</code> 设置为 true，Fluentd 将会以 logstash 格式来转发结构化的日志数据。</li>
<li><strong>Buffer：Fluentd 允许在目标不可用时进行缓存，比如，如果网络出现故障或者 Elasticsearch 不可用的时候。缓冲区配置也有助于降低磁盘的 IO。</strong></li>
</ul>
<h3 id="2-2-3"><strong>2-2-3 过滤</strong></h3>
<p>由于 Kubernetes 集群中应用太多，也还有很多历史数据，所以我们可以只将某些应用的日志进行收集，比如我们只采集具有 <code>logging=true</code> 这个 Label 标签的 Pod 日志，这个时候就需要使用 filter，如下所示：</p>
<pre><code># 删除无用的属性
&lt;filter kubernetes.**&gt;
  @type record_transformer
  remove_keys $.docker.container_id,$.kubernetes.container_image_id,$.kubernetes.pod_id,$.kubernetes.namespace_id,$.kubernetes.master_url,$.kubernetes.labels.pod-template-hash
&lt;/filter&gt;

# 只保留具有logging=true标签的Pod日志
&lt;filter kubernetes.**&gt;
  @id filter_log
  @type grep
  &lt;regexp&gt;
    key $.kubernetes.labels.logging
    pattern ^true$
  &lt;/regexp&gt;
&lt;/filter&gt;
</code></pre>
<h3 id="2-4"><strong>2-4 安装</strong></h3>
<p>要收集 Kubernetes 集群的日志，直接用 DasemonSet 控制器来部署 Fluentd 应用，这样，它就可以从 Kubernetes 节点上采集日志，确保在集群中的每个节点上始终运行一个 Fluentd 容器。</p>
<p><strong>当然可以直接使用 Helm 来进行一键安装，为了能够了解更多实现细节，我们这里还是采用手动方法来进行安装。</strong></p>
<p>首先，我们通过 ConfigMap 对象来指定 Fluentd 配置文件，新建 <code>fluentd-configmap.yaml</code> 文件，文件内容如下：</p>
<pre><code>kind: ConfigMap
apiVersion: v1
metadata:
  name: fluentd-conf
  namespace: logging
data:
  # 容器日志
  containers.input.conf: |-
    &lt;source&gt;
      @id fluentd-containers.log
      @type tail                              # Fluentd 内置的输入方式，其原理是不停地从源文件中获取新的日志
      path /var/log/containers/*.log          # Docker 容器日志路径
      pos_file /var/log/es-containers.log.pos  # 记录读取的位置
      tag raw.kubernetes.*                    # 设置日志标签
      read_from_head true                     # 从头读取
      &lt;parse&gt;                                 # 多行格式化成JSON
        # 可以使用我们介绍过的 multiline 插件实现多行日志
        @type multi_format                    # 使用 multi-format-parser 解析器插件
        &lt;pattern&gt;
          format json                         # JSON解析器
          time_key time                       # 指定事件时间的时间字段
          time_format %Y-%m-%dT%H:%M:%S.%NZ   # 时间格式
        &lt;/pattern&gt;
        &lt;pattern&gt;
          format /^(?&lt;time&gt;.+) (?&lt;stream&gt;stdout|stderr) [^ ]* (?&lt;log&gt;.*)$/
          time_format %Y-%m-%dT%H:%M:%S.%N%:z
        &lt;/pattern&gt;
      &lt;/parse&gt;
    &lt;/source&gt;

    # 在日志输出中检测异常(多行日志)，并将其作为一条日志转发
    # https://github.com/GoogleCloudPlatform/fluent-plugin-detect-exceptions
    &lt;match raw.kubernetes.**&gt;           # 匹配tag为raw.kubernetes.**日志信息
      @id raw.kubernetes
      @type detect_exceptions           # 使用detect-exceptions插件处理异常栈信息
      remove_tag_prefix raw             # 移除 raw 前缀
      message log
      multiline_flush_interval 5
    &lt;/match&gt;

    &lt;filter **&gt;  # 拼接日志
      @id filter_concat
      @type concat                # Fluentd Filter 插件，用于连接多个日志中分隔的多行日志
      key message
      multiline_end_regexp /\n$/  # 以换行符“\n”拼接
      separator &quot;&quot;
    &lt;/filter&gt;

    # 添加 Kubernetes metadata 数据
    &lt;filter kubernetes.**&gt;
      @id filter_kubernetes_metadata
      @type kubernetes_metadata
    &lt;/filter&gt;

    # 修复 ES 中的 JSON 字段
    # 插件地址：https://github.com/repeatedly/fluent-plugin-multi-format-parser
    &lt;filter kubernetes.**&gt;
      @id filter_parser
      @type parser                # multi-format-parser多格式解析器插件
      key_name log                # 在要解析的日志中指定字段名称
      reserve_data true           # 在解析结果中保留原始键值对
      remove_key_name_field true  # key_name 解析成功后删除字段
      &lt;parse&gt;
        @type multi_format
        &lt;pattern&gt;
          format json
        &lt;/pattern&gt;
        &lt;pattern&gt;
          format none
        &lt;/pattern&gt;
      &lt;/parse&gt;
    &lt;/filter&gt;

    # 删除一些多余的属性
    &lt;filter kubernetes.**&gt;
      @type record_transformer
      remove_keys $.docker.container_id,$.kubernetes.container_image_id,$.kubernetes.pod_id,$.kubernetes.namespace_id,$.kubernetes.master_url,$.kubernetes.labels.pod-template-hash
    &lt;/filter&gt;

    # 只保留具有logging=true标签的Pod日志
    &lt;filter kubernetes.**&gt;
      @id filter_log
      @type grep
      &lt;regexp&gt;
        key $.kubernetes.labels.logging
        pattern ^true$
      &lt;/regexp&gt;
    &lt;/filter&gt;

  ###### 监听配置，一般用于日志聚合用 ######
  forward.input.conf: |-
    # 监听通过TCP发送的消息
    &lt;source&gt;
      @id forward
      @type forward
    &lt;/source&gt;

  output.conf: |-
    &lt;match **&gt;
      @id elasticsearch
      @type elasticsearch
      @log_level info
      include_tag_key true
      host elasticsearch-client
      port 9200
      user elastic # FLUENT_ELASTICSEARCH_USER | FLUENT_ELASTICSEARCH_PASSWORD
      password ydzsio321
      logstash_format true
      logstash_prefix k8s
      request_timeout 30s
      &lt;buffer&gt;
        @type file
        path /var/log/fluentd-buffers/kubernetes.system.buffer
        flush_mode interval
        retry_type exponential_backoff
        flush_thread_count 2
        flush_interval 5s
        retry_forever
        retry_max_interval 30
        chunk_limit_size 2M
        queue_limit_length 8
        overflow_action block
      &lt;/buffer&gt;
    &lt;/match&gt;
</code></pre>
<p>上面配置文件中我们<strong>只配置了 docker 容器日志目录</strong>，收集到数据经过处理后发送到 <code>elasticsearch-client:9200</code> 服务。</p>
<ul>
<li>容器日志</li>
<li>在日志输出中检测异常(多行日志)，并将其作为一条日志转发 <a href="https://github.com/GoogleCloudPlatform/fluent-plugin-detect-exceptions">https://github.com/GoogleCloudPlatform/fluent-plugin-detect-exceptions</a><ul>
<li>匹配tag为<code>raw.kubernetes.**</code>日志信息</li>
<li>使用detect-exceptions插件处理异常栈信息</li>
<li>移除 raw 前缀</li>
</ul>
</li>
<li>拼接日志<ul>
<li>Fluentd Filter 插件，用于连接多个日志中分隔的多行日志</li>
<li>以换行符<code>“\n”</code>拼接</li>
</ul>
</li>
<li>添加 Kubernetes metadata 数据</li>
<li>修复 ES 中的 JSON 字段 插件地址：<a href="https://github.com/repeatedly/fluent-plugin-multi-format-parser">https://github.com/repeatedly/fluent-plugin-multi-format-parser</a><ul>
<li><code>multi-format-parser</code>多格式解析器插件</li>
<li>在要解析的日志中指定字段名称</li>
<li>在解析结果中保留原始键值对</li>
<li><code>key_name·</code>解析成功后删除字段</li>
</ul>
</li>
<li>删除一些多余的属性</li>
<li>只保留具有<code>logging=true</code>标签的Pod日志</li>
<li>监听配置，一般用于日志聚合用</li>
</ul>
<p>然后新建一个 <code>fluentd-daemonset.yaml</code> 的文件，文件内容如下：</p>
<pre><code>apiVersion: v1
kind: ServiceAccount
metadata:
  name: fluentd-es
  namespace: logging
  labels:
    k8s-app: fluentd-es
    kubernetes.io/cluster-service: &quot;true&quot;
    addonmanager.kubernetes.io/mode: Reconcile
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: fluentd-es
  labels:
    k8s-app: fluentd-es
    kubernetes.io/cluster-service: &quot;true&quot;
    addonmanager.kubernetes.io/mode: Reconcile
rules:
  - apiGroups:
      - &quot;&quot;
    resources:
      - &quot;namespaces&quot;
      - &quot;pods&quot;
    verbs:
      - &quot;get&quot;
      - &quot;watch&quot;
      - &quot;list&quot;
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: fluentd-es
  labels:
    k8s-app: fluentd-es
    kubernetes.io/cluster-service: &quot;true&quot;
    addonmanager.kubernetes.io/mode: Reconcile
subjects:
  - kind: ServiceAccount
    name: fluentd-es
    namespace: logging
    apiGroup: &quot;&quot;
roleRef:
  kind: ClusterRole
  name: fluentd-es
  apiGroup: &quot;&quot;
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: fluentd
  namespace: logging
  labels:
    app: fluentd
    kubernetes.io/cluster-service: &quot;true&quot;
spec:
  selector:
    matchLabels:
      app: fluentd
  template:
    metadata:
      labels:
        app: fluentd
        kubernetes.io/cluster-service: &quot;true&quot;
    spec:
      tolerations:
        - key: node-role.kubernetes.io/master
          effect: NoSchedule
      serviceAccountName: fluentd-es
      containers:
        - name: fluentd
          image: quay.io/fluentd_elasticsearch/fluentd:v3.2.0
          volumeMounts:
            - name: fluentconfig
              mountPath: /etc/fluent/config.d
            - name: varlog
              mountPath: /var/log
            - name: varlibdockercontainers
              mountPath: /var/lib/docker/containers
              readOnly: true
      terminationGracePeriodSeconds: 30
      volumes:
        - name: fluentconfig
          configMap:
            name: fluentd-conf
        - name: varlog
          hostPath:
            path: /var/log
        - name: varlibdockercontainers
          hostPath:
            path: /var/lib/docker/containers
</code></pre>
<p>我们将上面创建的 <code>fluentd-config</code> 这个 <code>ConfigMap</code> 对象通过 <code>volumes</code> 挂载到了 <code>Fluentd</code> 容器中，另外为了能够灵活控制哪些节点的日志可以被收集，所以我们这里还添加了一个 <code>nodSelector</code> 属性：</p>
<pre><code>nodeSelector:
  beta.kubernetes.io/fluentd-ds-ready: &quot;true&quot;
</code></pre>
<p>意思就是要想采集节点的日志，那么我们就需要给节点打上上面的标签。</p>
<blockquote>
<p>!!! info "提示" 如果你需要在其他节点上采集日志，则需要给对应节点打上标签，使用如下命令：</p>
<p><code>kubectl label nodes node名 beta.kubernetes.io/fluentd-ds-ready=true</code>。</p>
</blockquote>
<p>另外由于我们的集群使用的是 kubeadm 搭建的，默认情况下 master 节点有污点，所以如果要想也收集 master 节点的日志，则需要添加上容忍：</p>
<pre><code>tolerations:
  - operator: Exists
</code></pre>
<blockquote>
<p>另外需要注意的地方是，如果更改了 docker 的根目录，则在 volumes 和 volumeMount 里面都需要更改，保持一致。</p>
</blockquote>
<p>分别创建上面的 ConfigMap 对象和 DaemonSet：</p>
<pre><code>$ kubectl create -f fluentd-configmap.yaml
configmap &quot;fluentd-conf&quot; created
$ kubectl create -f fluentd-daemonset.yaml
serviceaccount &quot;fluentd-es&quot; created
clusterrole.rbac.authorization.k8s.io &quot;fluentd-es&quot; created
clusterrolebinding.rbac.authorization.k8s.io &quot;fluentd-es&quot; created
daemonset.apps &quot;fluentd&quot; created
</code></pre>
<p>创建完成后，查看对应的 Pods 列表，检查是否部署成功：</p>
<pre><code>$ kubectl get pods -n logging
NAME                            READY   STATUS    RESTARTS   AGE
elasticsearch-client-0          1/1     Running   0          64m
elasticsearch-data-0            1/1     Running   0          65m
elasticsearch-master-0          1/1     Running   0          73m
fluentd-5rqbq                   1/1     Running   0          60m
fluentd-l6mgf                   1/1     Running   0          60m
fluentd-xmfpg                   1/1     Running   0          60m
kibana-kibana-66f97964b-mdspc   1/1     Running   0          63m
</code></pre>
<p>Fluentd 启动成功后，这个时候就可以发送日志到 ES 了，但是我们这里是过滤了只采集具有 <code>logging=true</code> 标签的 Pod 日志，所以现在还没有任何数据会被采集。</p>
<p>下面我们部署一个简单的测试应用， 新建 counter.yaml 文件，文件内容如下：</p>
<pre><code>
apiVersion: v1
kind: Pod
metadata:
  name: counter
  labels:
    logging: &quot;true&quot; # 一定要具有该标签才会被采集
spec:
  containers:
    - name: count
      image: busybox
      args:
        [
          /bin/sh,
          -c,
          'i=0; while true; do echo &quot;$i: $(date)&quot;; i=$((i+1)); sleep 1; done',
        ]
</code></pre>
<p>该 Pod 只是简单将日志信息打印到 stdout，所以正常来说 Fluentd 会收集到这个日志数据，在 Kibana 中也就可以找到对应的日志数据了，使用 kubectl 工具创建该 Pod：</p>
<pre><code>$ kubectl create -f counter.yaml
$ kubectl get pods
NAME                             READY   STATUS    RESTARTS   AGE
counter                          1/1     Running   0          9h
</code></pre>
<p>Pod 创建并运行后，回到 Kibana Dashboard 页面，点击左侧最下面的 <code>Management -&gt; Stack Management</code>，进入管理页面，点击左侧 Kibana 下面的 索引模式，点击 创建索引模式 开始导入索引数据：</p>
<p><img alt="Alt Image Text" src="../../images/chap10_7_6.png" title="Body image" /></p>
<p>在这里可以配置我们需要的 Elasticsearch 索引，前面 Fluentd 配置文件中我们采集的日志使用的是 logstash 格式，定义了一个 k8s 的前缀，<strong>所以这里只需要在文本框中输入 <code>k8s-*</code> 即可匹配到 Elasticsearch 集群中采集的 Kubernetes 集群日志数据</strong>，然后点击下一步，进入以下页面：</p>
<p><img alt="Alt Image Text" src="../../images/chap10_7_7.png" title="Body image" /></p>
<p>在该页面中配置使用哪个字段按时间过滤日志数据，在下拉列表中，选择<code>@timestamp</code>字段，然后点击 <strong>创建索引模式</strong>，创建完成后，点击左侧导航菜单中的 <strong>Discover</strong>，然后就可以看到一些直方图和最近采集到的日志数据了：</p>
<p><img alt="Alt Image Text" src="../../images/chap10_7_8.png" title="Body image" /></p>
<p>现在的数据就是上面 Counter 应用的日志，如果还有其他的应用，我们也可以筛选过滤：</p>
<p><img alt="Alt Image Text" src="../../images/chap10_7_9.png" title="Body image" /></p>
<p>我们也可以通过其他元数据来过滤日志数据，比如您可以单击任何日志条目以查看其他元数据，如容器名称，Kubernetes 节点，命名空间等。</p>
<h2 id="3-kafka"><strong>3、安装 Kafka</strong></h2>
<p>对于大规模集群来说，日志数据量是非常巨大的，如果直接通过 Fluentd 将日志打入 Elasticsearch，对 ES 来说压力是非常巨大的，我们可以在中间加一层消息中间件来缓解 ES 的压力</p>
<ul>
<li><strong>一般情况下我们会使用 Kafka，然后可以直接使用 <code>kafka-connect-elasticsearch</code> 这样的工具将数据直接打入 ES，也可以在加一层 Logstash 去消费 Kafka 的数据</strong></li>
<li>然后通过 Logstash 把数据存入 ES，这里我们来使用 Logstash 这种模式来对日志收集进行优化。</li>
</ul>
<p>首先在 Kubernetes 集群中安装 Kafka，同样这里使用 Helm 进行安装：</p>
<pre><code>helm repo add bitnami https://charts.bitnami.com/bitnami
helm repo update
</code></pre>
<p>首先使用 helm pull 拉取 Chart 并解压：</p>
<pre><code>helm pull bitnami/kafka --untar --version 12.17.5
cd kafka
</code></pre>
<p>这里面我们指定使用一个 <code>StorageClass</code> 来提供持久化存储，在 Chart 目录下面创建用于安装的 values 文件：</p>
<p><strong><code>values-prod.yaml</code></strong></p>
<pre><code># values-prod.yaml
## Persistence parameters
##
persistence:
  enabled: true
  storageClass: &quot;nfs-storage&quot;
  accessModes:
    - ReadWriteOnce
  size: 5Gi
  ## Mount point for persistence
  mountPath: /bitnami/kafka

# 配置zk volumes
zookeeper:
  enabled: true
  persistence:
    enabled: true
    storageClass: &quot;nfs-storage&quot;
    accessModes:
      - ReadWriteOnce
    size: 8Gi
</code></pre>
<p>直接使用上面的 values 文件安装 kafka：</p>
<pre><code>$ helm install kafka -f values-prod.yaml --namespace logging .
Release &quot;kafka&quot; does not exist. Installing it now.
NAME: kafka
LAST DEPLOYED: Tue Apr 27 18:46:01 2021
NAMESPACE: logging
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
** Please be patient while the chart is being deployed **

Kafka can be accessed by consumers via port 9092 on the following DNS name from within your cluster:

    kafka.logging.svc.cluster.local

Each Kafka broker can be accessed by producers via port 9092 on the following DNS name(s) from within your cluster:

    kafka-0.kafka-headless.logging.svc.cluster.local:9092

To create a pod that you can use as a Kafka client run the following commands:

    kubectl run kafka-client --restart='Never' --image docker.io/bitnami/kafka:2.8.0-debian-10-r0 --namespace logging --command -- sleep infinity
    kubectl exec --tty -i kafka-client --namespace logging -- bash

    PRODUCER:
        kafka-console-producer.sh \

            --broker-list kafka-0.kafka-headless.logging.svc.cluster.local:9092 \
            --topic test

    CONSUMER:
        kafka-console-consumer.sh \

            --bootstrap-server kafka.logging.svc.cluster.local:9092 \
            --topic test \
            --from-beginning
</code></pre>
<p>安装完成后我们可以使用上面的提示来检查 Kafka 是否正常运行：</p>
<pre><code>$ kubectl get pods -n logging -l app.kubernetes.io/instance=kafka
kafka-0             1/1     Running   0          7m58s
kafka-zookeeper-0   1/1     Running   0          7m58s
</code></pre>
<p>用下面的命令创建一个 Kafka 的测试客户端 Pod：</p>
<pre><code>$ kubectl run kafka-client --restart='Never' --image docker.io/bitnami/kafka:2.8.0-debian-10-r0 --namespace logging --command -- sleep infinity
pod/kafka-client created
</code></pre>
<p>然后启动一个终端进入容器内部生产消息：</p>
<pre><code># 生产者
$ kubectl exec --tty -i kafka-client --namespace logging -- bash
I have no name!@kafka-client:/$ kafka-console-producer.sh --broker-list kafka-0.kafka-headless.logging.svc.cluster.local:9092 --topic test
&gt;hello kafka on k8s
&gt;
</code></pre>
<p>启动另外一个终端进入容器内部消费消息：</p>
<pre><code># 消费者
$ kubectl exec --tty -i kafka-client --namespace logging -- bash
I have no name!@kafka-client:/$ kafka-console-consumer.sh --bootstrap-server kafka.logging.svc.cluster.local:9092 --topic test --from-beginning
hello kafka on k8s
</code></pre>
<p>如果在消费端看到了生产的消息数据证明我们的 Kafka 已经运行成功了。</p>
<h2 id="4fluentd-kafka"><strong>4、Fluentd 配置 Kafka</strong></h2>
<p>现在有了 Kafka，<strong>我们就可以将 Fluentd 的日志数据输出到 Kafka 了，只需要将 Fluentd 配置中的 <code>&lt;match&gt;</code>更改为使用 Kafka 插件即可，但是在 Fluentd 中输出到 Kafka，需要使用到 <code>fluent-plugin-kafka</code> 插件</strong></p>
<p>所以需要我们自定义下 Docker 镜像，最简单的做法就是在上面 Fluentd 镜像的基础上新增 kafka 插件即可，Dockerfile 文件如下所示：</p>
<pre><code>FROM quay.io/fluentd_elasticsearch/fluentd:v3.2.0
RUN echo &quot;source 'https://mirrors.tuna.tsinghua.edu.cn/rubygems/'&quot; &gt; Gemfile &amp;&amp; gem install bundler
RUN gem install fluent-plugin-kafka -v 0.16.1 --no-document
</code></pre>
<p>使用上面的 <code>Dockerfile</code> 文件构建一个 Docker 镜像即可，我这里构建过后的镜像名为 <code>cnych/fluentd-kafka:v0.16.1</code>。</p>
<p>接下来替换 Fluentd 的 Configmap 对象中的 <code>&lt;match&gt;</code> 部分，如下所示：</p>
<p><strong><code>fluentd-configmap.yaml</code></strong></p>
<pre><code># fluentd-configmap.yaml
kind: ConfigMap
apiVersion: v1
metadata:
  name: fluentd-conf
  namespace: logging
data:
  ......
  output.conf: |-
    &lt;match **&gt;
      @id kafka
      @type kafka2
      @log_level info
      # list of seed brokers
      brokers kafka-0.kafka-headless.logging.svc.cluster.local:9092
      use_event_time true
      # topic settings
      topic_key k8slog
      default_topic messages  # 注意，kafka中消费使用的是这个topic
      # buffer settings
      &lt;buffer k8slog&gt;
        @type file
        path /var/log/td-agent/buffer/td
        flush_interval 3s
      &lt;/buffer&gt;
      # data type settings
      &lt;format&gt;
        @type json
      &lt;/format&gt;
      # producer settings
      required_acks -1
      compression_codec gzip
    &lt;/match&gt;
</code></pre>
<p>然后替换运行的 Fluentd 镜像：</p>
<pre><code># fluentd-daemonset.yaml
image: cnych/fluentd-kafka:v0.16.1
</code></pre>
<p>直接更新 Fluentd 的 Configmap 与 DaemonSet 资源对象即可：</p>
<pre><code>kubectl apply -f fluentd-configmap.yaml
kubectl apply -f fluentd-daemonset.yaml
</code></pre>
<p>更新成功后我们可以使用上面的测试 Kafka 客户端来验证是否有日志数据：</p>
<pre><code>$ kubectl exec --tty -i kafka-client --namespace logging -- bash
I have no name!@kafka-client:/$ kafka-console-consumer.sh --bootstrap-server kafka.logging.svc.cluster.local:9092 --topic messages --from-beginning
{&quot;stream&quot;:&quot;stdout&quot;,&quot;docker&quot;:{},&quot;kubernetes&quot;:{&quot;container_name&quot;:&quot;count&quot;,&quot;namespace_name&quot;:&quot;default&quot;,&quot;pod_name&quot;:&quot;counter&quot;,&quot;container_image&quot;:&quot;busybox:latest&quot;,&quot;host&quot;:&quot;node1&quot;,&quot;labels&quot;:{&quot;logging&quot;:&quot;true&quot;}},&quot;message&quot;:&quot;43883: Tue Apr 27 12:16:30 UTC 2021\n&quot;}
......
</code></pre>
<h2 id="5-logstash"><strong>5、安装 Logstash</strong></h2>
<p>虽然数据从 Kafka 到 Elasticsearch 的方式多种多样，我们这里还是采用更加流行的 Logstash 方案，上面我们已经将日志从 Fluentd 采集输出到 Kafka 中去了，接下来我们使用 Logstash 来连接 Kafka 与 Elasticsearch 间的日志数据。</p>
<p>首先使用 <code>helm pull</code> 拉取 Chart 并解压：</p>
<pre><code>helm pull elastic/logstash --untar --version 7.12.0
cd logstash
</code></pre>
<p>同样在 Chart 根目录下面创建用于安装的 Values 文件，如下所示：</p>
<p><strong><code>values-prod.yaml</code></strong></p>
<pre><code># values-prod.yaml
fullnameOverride: logstash

persistence:
  enabled: true

logstashConfig:
  logstash.yml: |
    http.host: 0.0.0.0
    # 如果启用了xpack，需要做如下配置
    xpack.monitoring.enabled: true
    xpack.monitoring.elasticsearch.hosts: [&quot;http://elasticsearch-client:9200&quot;]
    xpack.monitoring.elasticsearch.username: &quot;elastic&quot;
    xpack.monitoring.elasticsearch.password: &quot;jxi321&quot;

# 要注意下格式
logstashPipeline:
  logstash.conf: |
    input { kafka { bootstrap_servers =&gt; &quot;kafka-0.kafka-headless.logging.svc.cluster.local:9092&quot; codec =&gt; json consumer_threads =&gt; 3 topics =&gt; [&quot;messages&quot;] } }
    filter {}  # 过滤配置（比如可以删除key、添加geoip等等）
    output { elasticsearch { hosts =&gt; [ &quot;elasticsearch-client:9200&quot; ] user =&gt; &quot;elastic&quot; password =&gt; &quot;ydzsio321&quot; index =&gt; &quot;logstash-k8s-%{+YYYY.MM.dd}&quot; } stdout { codec =&gt; rubydebug } }

volumeClaimTemplate:
  accessModes: [&quot;ReadWriteOnce&quot;]
  storageClassName: nfs-storage
  resources:
    requests:
      storage: 1Gi
</code></pre>
<p>其中最重要的就是通过 <code>logstashPipeline</code> 配置 <code>logstash</code> 数据流的处理配置，通过 <code>inpu</code>t 指定日志源 kafka 的配置，通过 <code>output</code> 输出到 <code>Elasticsearch</code>，同样直接使用上面的 <code>Values</code> 文件安装 logstash 即可：</p>
<pre><code>$ helm upgrade --install logstash -f values-prod.yaml --namespace logging .
Release &quot;logstash&quot; does not exist. Installing it now.
NAME: logstash
LAST DEPLOYED: Tue Apr 27 20:22:45 2021
NAMESPACE: logging
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
1. Watch all cluster members come up.
  $ kubectl get pods --namespace=logging -l app=logstash -w
</code></pre>
<p>安装启动完成后可以查看 logstash 的日志：</p>
<pre><code>$ logstash kubectl get pods --namespace=logging -l app=logstash
NAME         READY   STATUS    RESTARTS   AGE
logstash-0   1/1     Running   0          2m8s
$ kubectl logs -f logstash-0 -n logging
......
{
&quot;docker&quot; =&gt; {},
&quot;stream&quot; =&gt; &quot;stdout&quot;,
&quot;message&quot; =&gt; &quot;46921: Tue Apr 27 13:07:15 UTC 2021\n&quot;,
&quot;kubernetes&quot; =&gt; {
            &quot;host&quot; =&gt; &quot;node1&quot;,
          &quot;labels&quot; =&gt; {
    &quot;logging&quot; =&gt; &quot;true&quot;
},
        &quot;pod_name&quot; =&gt; &quot;counter&quot;,
&quot;container_image&quot; =&gt; &quot;busybox:latest&quot;,
  &quot;container_name&quot; =&gt; &quot;count&quot;,
  &quot;namespace_name&quot; =&gt; &quot;default&quot;
},
&quot;@timestamp&quot; =&gt; 2021-04-27T13:07:15.761Z,
&quot;@version&quot; =&gt; &quot;1&quot;
}
</code></pre>
<p>由于我们启用了 debug 日志调试，所以我们可以在 logstash 的日志中看到我们采集的日志消息，到这里证明我们的日志数据就获取成功了。</p>
<p>现在我们可以登录到 Kibana 可以看到有如下所示的索引数据了：</p>
<p><img alt="Alt Image Text" src="../../images/chap10_7_10.png" title="Body image" /></p>
<p>然后同样创建索引模式，匹配上面的索引即可：</p>
<p><img alt="Alt Image Text" src="../../images/chap10_7_11.png" title="Body image" /></p>
<p>创建完成后就可以前往发现页面过滤日志数据了：</p>
<p><img alt="Alt Image Text" src="../../images/chap10_7_12.png" title="Body image" /></p>
<p>到这里我们就实现了一个使用 <code>Fluentd+Kafka+Logstash+Elasticsearch+Kibana</code> 的 Kubernetes 日志收集工具栈，这里我们完整的 Pod 信息如下所示：</p>
<pre><code>$ kubectl get pods -n logging
NAME                            READY   STATUS    RESTARTS   AGE
elasticsearch-client-0          1/1     Running   0          128m
elasticsearch-data-0            1/1     Running   0          128m
elasticsearch-master-0          1/1     Running   0          128m
fluentd-6k52h                   1/1     Running   0          61m
fluentd-cw72c                   1/1     Running   0          61m
fluentd-dn4hs                   1/1     Running   0          61m
kafka-0                         1/1     Running   3          134m
kafka-client                    1/1     Running   0          125m
kafka-zookeeper-0               1/1     Running   0          134m
kibana-kibana-66f97964b-qqjgg   1/1     Running   0          128m
logstash-0                      1/1     Running   0          13m
</code></pre>
<p>当然在实际的工作项目中还需要我们根据实际的业务场景来进行参数性能调优以及高可用等设置，以达到系统的最优性能。</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2020-9999 Jacob Xi
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.b4d07000.min.js"></script>
      
    
  </body>
</html>